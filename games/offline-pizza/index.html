<html><body></body><script>const g={},dp=console.log,$=document.querySelector.bind(document),rnd=function(t,e){return Math.round(Math.random()*(e-t)+t)},rnda=function(t){return t[rnd(0,t.length-1)]},btw=(t,e,i)=>t>=e&&i>=t;function Sprite(t){return this.x=t.x||0,this.y=t.y||0,this.w=t.w||g.ui.bz,this.h=t.h||g.ui.bz,this.offX=t.offX||0,this.offY=t.offY||0,this.scale=t.scale||1,this.center=t.center||!1,this.img=g.ImageLoader.get[t.sprite||"sprites"],this}g.ui={},g.ui.win={width:window.innerWidth||document.documentElement.clientWidth||document.body.offsetWidth,height:window.innerHeight||document.documentElement.clientHeight||document.body.offsetHeight},document.body.style.padding=document.body.style.margin="0px",document.body.style.width=window.innerWidth+"px",document.body.style.height=window.innerHeight+"px",g.ui.canvas=document.createElement("canvas"),document.body.appendChild(g.ui.canvas),g.ctx=g.ui.canvas.getContext("2d"),g.ImageLoader={get:{},loaded:0,imageCount:0,onloadCallBack:null,checkLoaded:function(){this.loaded++,this.loaded==this.imageCount&&"function"==typeof this.onloadCallBack&&this.onloadCallBack()},add:function(t,e){let i=new Image;i.src=e;i.onload=this.checkLoaded.bind(this),this.get[t]=i,this.imageCount++},onload:function(t){this.onloadCallBack=t,0==this.imageCount&&t()}},Ticker=function(t,e,i){this.state="stop",this._fps=t,this.ticks=0,this._frameMillis=1e3/t,this._updateCallBack=e,this._renderCallback=i},Ticker.prototype.start=function(){this.state="go",this.lastUpdate=this.lastDraw=window.performance.now(),this.loop()},Ticker.prototype.loop=function(){if("stop"==this.state)return;window.requestAnimationFrame(this.loop.bind(this)),this.ticks++;let t=window.performance.now(),e=t-this.lastDraw;this.actualFPS=1e3/e;let i=t-this.lastUpdate||0;e>2e4&&g.Pause(),this._updateCallBack(i/this._frameMillis),this.lastUpdate=t,e>this._frameMillis&&(this.lastDraw=t-e%this._frameMillis,this._renderCallback())},Ticker.prototype.stop=function(){this.state="stop"},Sprite.prototype.renderer=function(t,e,i,s){t.save(),this.x=e||this.x,this.y=i||this.y,this.scale=s||this.scale,this.offW=this.w*this.scale,this.offH=this.h*this.scale,this.center&&g.ctx.translate(-this.offW/2,-this.offH/2),t.drawImage(this.img,this.offX,this.offY,this.w,this.h,this.x,this.y,this.offW,this.offH),t.restore()},g.Keyboard=function(t){var e={};return e.codes=Array.isArray(t)?t:[t],e.isDown=!1,e.isUp=!0,e.downHandler=function(t){e.codes.includes(t.code)&&(e.down?e.down():e.isUp&&e.press&&e.press(),e.isDown=!0,e.isUp=!1,t.preventDefault())},e.upHandler=function(t){e.codes.includes(t.code)&&(e.isDown&&e.release&&e.release(),e.isDown=!1,e.isUp=!0,t.preventDefault())},e.clickHandler=function(t){e.press(t)},"click"!==t?(window.addEventListener("keydown",e.downHandler.bind(e),!1),window.addEventListener("keyup",e.upHandler.bind(e),!1)):document.addEventListener("touchstart",e.clickHandler.bind(e),!1),e};const Vector={norm:t=>{let e=Vector.mag(t);return 0==e?{x:0,y:0}:{x:t.x/e,y:t.y/e}},mag:t=>Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2)),subtract:(t,e)=>({x:t.x-e.x,y:t.y-e.y}),right:()=>({x:1,y:0}),left:()=>({x:-1,y:0}),up:()=>({x:0,y:-1}),down:()=>({x:0,y:1})};function Collider(t){t=t||{},this.checks=t.checks||[]}function Player(t){return this.x=t.x||0,this.y=t.y||0,this.w=t.w||g.ui.bz,this.h=t.h||g.ui.bz,this.pizzas=[],this.sprite=new Sprite({w:this.w,h:this.h,offX:128,offY:96,scale:1}),this.collider=0,this.tag="player",this.acc={x:0,y:0},this.speed={x:0,y:0},this.velocity=t.velocity||5,this.frame=0,this.fuel=100,g.collider.check(this,["house","block"],(t,e)=>{g.player.stop()}),this}function House(t){return this.x=t.x,this.y=t.y,this.w=t.w||g.ui.bz,this.h=t.h||g.ui.bz,this.tag="house",this.lastFlash=0,this.flashing=!1,this.state=0,this.customer=!1,this.waittime=-1,this.satisfaction=-1,this}function arc(t,e,i,s,a,r){t.beginPath(),t.fillStyle=r,t.moveTo(e,i),t.arc(e,i,s,-Math.PI/2,2*a*Math.PI-Math.PI/2),t.closePath(),t.fill()}function MiniMap(){return this}function GameManager(t){return this.static=!0,this.flash=!1,this.level=1,this.houses=g.scene.get("house"),this.prospects=[],this.orders=[],this.carrying=[],this.lost=[],this.customers=[],this.deliveries=0,this.money=0,g.sprites={cloud:new Sprite({w:32,h:32,offX:128,offY:32}),pizza:new Sprite({w:14,h:14,offX:160,offY:32}),minipizza:new Sprite({w:14,h:14,offX:160,offY:32,scale:.5}),sat:[new Sprite({w:32,h:32,offX:160,offY:64}),new Sprite({w:32,h:32,offX:192,offY:64}),new Sprite({w:32,h:32,offX:128,offY:64})]},this}function ArrayShuffle(t){for(var e=t.length-1;e>0;e--){var i=Math.floor(Math.random()*(e+1)),s=t[e];t[e]=t[i],t[i]=s}}function ArrayRemove(t,e){for(let i=0;i<t.length;i++)if(t[i]===e)return t.splice(i,1)}function GameTitle(){this.texts=["The Internet DIED!","Everyone is OFFLINE!!","But they need their PIZZA!!!","As the only PSYCHIC in town...","...only YOU can save them!","1) Travel to the needy","2) <SPACEBAR> takes the order","3) Return to the pizzeria","4) <SPACEBAR> to deliver pizza","Keep the hungry happy","Try not to lose customers","GOOD LUCK!",""],this.frame=0,this.lasttick=g.ticker.ticks}g.Scene=function(t){return t=t||{},this.entities=t.entities||[],this},g.Scene.prototype.add=function(t){return this.entities.push(t),t},g.Scene.prototype.insert=function(t){return this.entities.splice(0,0,t),t},g.Scene.prototype.remove=function(t){"number"==typeof t.length?ents=t:ents=[t];for(let t=0;t<ents.length;t++)for(let e=0;e<this.entities.length;e++)this.entities[e]==ents[t]&&this.entities.splice(e,1)},g.Scene.prototype.get=function(t){return result=[],this.entities.forEach(function(e){(!t||e.tag===t||Array.isArray(t)&&t.includes(e.tag))&&result.push(e)},this),result},g.Scene.prototype.count=function(t){return this.get(t).length},g.Start=function(t){t=t||60,this.ticker=new Ticker(t,function(t){g.GameUpdate(t)},function(){g.GameRender()}),g.ticker.start()},g.Pause=function(){"gameOver"==g.state?g.restart():"stop"==g.ticker.state?(g.state="play",g.ticker.start()):(g.ticker.stop(),g.state="pause")},g.Halt=function(t){g.ticker&&(g.ticker.stop(),g.state=t||"halt")},g.Step=function(){g.GameUpdate(1),g.GameRender()},g.GameUpdate=function(t){"function"==typeof g.preGameUpdate&&g.preGameUpdate(t),g.scene.entities.forEach(function(e){"function"==typeof e.update&&e.update(t)},this),"function"==typeof g.postGameUpdate&&g.postGameUpdate()},g.GameRender=function(){g.ctx.clearRect(0,0,g.ui.canvas.width,g.ui.canvas.height),g.ctx.save(),"function"==typeof g.preGameRender&&(g.ctx.save(),g.preGameRender(g.ctx),g.ctx.restore()),g.camera&&g.ctx.translate(-g.camera.x,-g.camera.y),g.scene.entities.forEach(function(t){"function"==typeof t.renderer&&(t.noRender||g.camera&&!g.camera.canSee(t)||(g.ctx.save(),t.static&&g.camera&&g.ctx.translate(g.camera.x,g.camera.y),t.renderer(g.ctx),g.ctx.restore()))},this),"function"==typeof g.postGameRender&&(g.ctx.save(),g.postGameRender(g.ctx),g.ctx.restore()),g.ctx.restore()},g.init=function(t){dp("No game defined in g.init(). Start coding!")},g.restart=function(t){dp("No game defined in g.restart(). Start coding!")},window.addEventListener("load",function(){let t=g.init();g.ImageLoader.onload(t)}),Collider.prototype.update=function(t){if("play"==g.state)for(let t=0;t<this.checks.length;t++){let e=Collider.collides(this.checks[t].tag1,this.checks[t].tag2);e.length>0&&this.checks[t].callback(e[0],e[1])}},Collider.prototype.renderer=function(t){Collider.debug&&this.update(1)},Collider.prototype.check=function(t,e,i){this.checks.push({tag1:t,tag2:e,callback:i})},Collider.collide=function(t,e,i){return Collider.collides(t,e,i).length>0},Collider.collides=function(t,e,i){let s="string"==typeof t?g.scene.get(t):[t],a=g.scene.get(e);for(let t=0;t<s.length;t++)for(let e=0;e<a.length;e++)if(s[t]!=a[e]&&Collider.collision(s[t],a[e],i))return[s[t],a[e]];return[]},Collider.collision=function(t,e,i){let s=t.speed?t.speed.x:0,a=t.speed?t.speed.y:0,r=i||t.collider||0,o=i||e.collider||0,n=t.x+s+r,h=t.x+s+t.w-1-r,l=t.y+a+r,c=t.y+a+t.h-1-r,u=e.x+o,d=e.x+e.w-1-o,p=e.y+o,f=e.y+e.h-1-o,y=btw(u,n,h)||btw(d,n,h)||btw(n,u,d)||btw(h,u,d),m=btw(p,l,c)||btw(f,l,c)||btw(l,p,f)||btw(c,p,f),x=y&&m;return Collider.debug&&t.tag==Collider.debug[0]&&e.tag==Collider.debug[1]&&(g.ctx.lineWidth=x?5:1,t.tag==Collider.debug[0]&&(g.ctx.strokeStyle="#0FF",g.ctx.strokeRect(n,l,h-n,c-l)),e.tag==Collider.debug[1]&&(g.ctx.strokeStyle="#F00",g.ctx.strokeRect(u,p,d-u,f-p))),x},Camera=function(t){this.x=t.x||0,this.y=t.y||0,this.w=t.w||500,this.h=t.h||500,this.tag=t.tag||"camera",this.box={x:0,y:0,w:t.box||300,h:t.box||300}},Camera.prototype.update=function(){g.player.x<this.box.x&&(this.box.x=g.player.x),g.player.x+g.player.w>this.box.x+this.box.w&&(this.box.x=g.player.x+g.player.w-this.box.w),g.player.y<this.box.y&&(this.box.y=g.player.y),g.player.y+g.player.h>this.box.y+this.box.h&&(this.box.y=g.player.y+g.player.h-this.box.h);let t=this.box.x+this.box.w/2,e=this.box.y+this.box.h/2,i=this.x+this.w/2,s=this.y+this.h/2;t==i&&e==s||(this.x+=t-i,this.y+=e-s)},Camera.prototype.canSee=function(t){if(t.static||void 0===t.w||void 0===t.h)return!0;let e=this.x,i=this.x+this.w,s=this.y,a=this.y+this.h,r=t.x,o=t.x+t.w,n=t.y,h=t.y+t.h,g=btw(r,e,i)||btw(o,e,i)||btw(e,r,o)||btw(i,r,o),l=btw(n,s,a)||btw(h,s,a)||btw(s,n,h)||btw(a,n,h);return g&&l},Camera.prototype.renderer=function(t){Camera.debug&&(g.ctx.strokeStyle="#00F",g.ctx.strokeRect(this.box.x,this.box.y,this.box.w,this.box.h),g.ctx.fillStyle="#F00",g.ctx.fillRect(this.x+this.w/2-2,this.y+this.h/2-5,4,10),g.ctx.fillStyle="#00F",g.ctx.strokeRect(this.box.x+this.box.w/2-5,this.box.y+this.box.h/2-5,10,10))},Player.prototype.update=function(t){"play"==g.state&&(0==Math.round(this.distanceFrom(g.pizzeria))&&g.manager.atPizzeria(),this.nextMove&&this.move(this.nextMove),this.speed.x+=this.acc.x*t,this.speed.y+=this.acc.y*t,this.x+=this.speed.x,this.y+=this.speed.y,0==this.speed.x&&0==this.speed.y||(this.fuel-=.03),this.speed.x>0?this.frame=0:this.speed.x<0?this.frame=1:this.speed.y<0?this.frame=2:this.speed.y>0&&(this.frame=3))},Player.prototype.renderer=function(t){this.sprite.x=this.x,this.sprite.y=this.y,this.sprite.offX=4*g.ui.bz+this.frame*g.ui.bz,this.sprite.renderer(t),g.manager.carrying.forEach((e,i)=>{let s={x:14,y:7,xi:-3,yi:0};1==this.frame?s={x:10,y:-2,xi:3,yi:0}:2==this.frame?s={x:19,y:7,xi:0,yi:3}:3==this.frame&&(s={x:6,y:7,xi:0,yi:-3}),g.sprites.minipizza.renderer(t,this.x+s.x+i*s.xi,this.y+s.y+i*s.yi,.5)})},Player.prototype.move=function(t){if(this.nextMove=null,t.x*this.velocity==this.speed.x&&t.y*this.velocity==this.speed.y)return this.stop();this.speed.x,this.speed.y;let e={tag:"ghost",x:this.x,y:this.y,w:this.w,h:this.h,speed:{x:t.x*this.velocity,y:t.y*this.velocity}},i=Collider.collide(e,["house","block"],0),s=Collider.collide(this,["house","block"],1),a=this.speed.x+this.speed.y==0,r=0!==t.y&&this.x%g.ui.bz==0||0!==t.x&&this.y%g.ui.bz==0;s&&i||(a&&!i?this.speed=e.speed:i||!r?this.nextMove=t:this.speed=e.speed)},Player.prototype.stop=function(){this.speed={x:0,y:0}},Player.prototype.distanceFrom=function(t){return Math.sqrt(Math.pow(t.x-this.x,2)+Math.pow(t.y-this.y,2))/g.ui.bz},House.colors=["","white","blue","red"],House.prototype.update=function(t){g.ticker.ticks%60==0&&(1==this.state&&(this.waittime+=.5),2==this.state&&this.waittime++,this.debug,this.waittime>=0&&this.state<3&&(this.waittime/this.patience<.5?this.satisfaction=2:this.waittime<this.patience?this.satisfaction=1:this.waittime/this.patience>3&&g.manager.loseCustomer(this)))},House.prototype.renderer=function(t){this.flashing&&g.manager.flash&&(1==this.state?(t.globalAlpha=.5,g.sprites.cloud.renderer(t,this.x,this.y),t.globalAlpha=1,g.sprites.pizza.renderer(t,this.x+6,this.y+4)):2==this.state&&(t.globalAlpha=.5,g.sprites.cloud.renderer(t,this.x,this.y),t.globalAlpha=1,g.sprites.pizza.renderer(t,this.x+6,this.y+4),arc(t,this.x+13,this.y+11,5,this.waittime/this.patience,"#4B1716"))),3==this.state&&(t.strokeStyle=House.colors[this.state],t.lineWidth="2",t.strokeRect(this.x,this.y,this.w,this.h)),this.satisfaction>=0&&g.sprites.sat[this.satisfaction].renderer(t,this.x+16,this.y+16)},House.prototype.readyToOrder=function(){return this.patience=5*Math.round(this.distanceFrom(g.pizzeria)),this.state=1,this.waittime=0,this.flashing=!0,this},House.prototype.placeOrder=function(){return this.state=2,this.flashing=!0,this.waittime=0,g.sound.play("order"),this},House.prototype.deliverOrder=function(){this.state=0,this.waittime=-1,this.customer=!0,this.flashing=!1},House.prototype.distanceFrom=function(t){return Math.sqrt(Math.pow(t.x-this.x,2)+Math.pow(t.y-this.y,2))/g.ui.bz},MiniMap.prototype.draw=function(t){t.translate(g.camera.x,g.camera.y),g.rect(0,0,g.ui.width,20,"rgba(100,100,100,0.75)"),t.font="8pt Consolas",t.fillStyle="white",t.fillText("$"+g.manager.money,g.ui.width-100,13),t.fillText(g.manager.prospects.length+" waiting...",10,13),t.fillText(g.manager.orders.length+" orders",110,13),t.translate(-g.ui.hudWidth,0),g.rect(0,0,g.ui.hudWidth,g.ui.height,"gray"),g.rect(1,1,g.player.fuel*(g.ui.hudWidth-2)/100,12,"blue"),t.font="8pt Consolas",t.fillStyle="white",t.fillText("Fuel "+Math.round(g.player.fuel),2,11),t.translate(0,10);for(let e=0;e<g.manager.customers.length;e++){let i=g.manager.customers[e];i.mX||(i.mX=rnd(0,g.ui.hudWidth-g.ui.bz)),i.mY||(i.mY=rnd(0,g.ui.height-110-g.ui.bz)),g.sprites.sat[i.satisfaction].renderer(t,1+i.mX,1+i.mY)}for(let e=0;e<g.manager.lost.length;e++){let i=g.manager.lost[e];i.mX||(i.mX=rnd(0,g.ui.hudWidth-g.ui.bz)),i.mY||(i.mY=rnd(0,g.ui.height-110-g.ui.bz)),g.sprites.sat[i.satisfaction].renderer(t,1+i.mX,1+i.mY)}t.translate(0,200),t.translate(4,2),g.rect(0,0,40,100,"rgba(0,0,0,0.8)"),g.scene.get(["player","pizzeria","house"]).forEach(e=>{let i=e.x/g.ui.bz,s=e.y/g.ui.bz,a=1;"player"==e.tag?(t.fillStyle="yellow",a=g.manager.flash?3:1):"pizzeria"==e.tag?(t.fillStyle="magenta",a=g.manager.flash?3:1):e.flashing&&g.manager.flash?(t.fillStyle=House.colors[e.state],a=2):e.state?(t.fillStyle=House.colors[e.state],a=1):t.fillStyle="rgba(100,100,100,0.75)",0==e.satisfaction?(t.fillStyle="red",a=2):1==e.satisfaction?t.fillStyle="orange":2==e.satisfaction&&e.customer&&(t.fillStyle="green",a=3),t.fillRect(i-a/2,s-a/2,a,a)})},GameManager.prototype.update=function(t){if("play"==g.state)return g.ticker.ticks%30==0&&(this.flash=!this.flash),this.prospects.length+this.orders.length!=0&&g.ticker.ticks%300!=0||this.prospects.length<4*this.level&&this.getNewHungryHouse(),g.player.fuel<=0?g.GameOver("You ran out of fuel!"):this.lost.length>5&&this.lost.length>this.customers.length?g.GameOver("Too many unhappy customers!"):void(this.level=Math.floor(this.deliveries/6)+1)},GameManager.prototype.vanStops=function(){this.prospects.forEach(t=>{Math.round(t.distanceFrom(g.player))<=1&&1==t.state&&(t.placeOrder(),g.manager.orders.push(t),ArrayRemove(g.manager.prospects,t))}),g.manager.carrying.forEach(t=>{Math.round(t.distanceFrom(g.player))<=1&&(t.deliverOrder(),this.customers.includes(t)||this.customers.push(t),this.money+=20,this.deliveries++,g.sound.play("delivery"),ArrayRemove(this.orders,t),ArrayRemove(g.manager.carrying,t))})},GameManager.prototype.atPizzeria=function(){if(g.ticker.ticks%60==0&&this.orders.length>0){let t=this.orders[0];g.manager.carrying.push(t),ArrayRemove(this.orders,t)}g.ticker.ticks%10==0&&this.money>0&&g.player.fuel<100&&(this.money--,g.player.fuel++)},GameManager.prototype.getNewHungryHouse=function(){let t=[];for(i=0;i<this.houses.length;i++){let e=this.houses[i];0!=!e.state&&(0!=e.satisfaction&&e.distanceFrom(g.pizzeria)<6*this.level&&t.push(e))}if(0==t.length)return;let e=rnda(t);return g.sound.play("prospect"),this.prospects.push(e.readyToOrder())},GameManager.prototype.loseCustomer=function(t){1==t.state?ArrayRemove(this.prospects,t):2==t.state&&(ArrayRemove(this.orders,t),ArrayRemove(this.carrying,t)),ArrayRemove(this.customers,t),this.lost.push(t),t.satisfaction=0,t.waittime=0,t.flashing=!1,t.state=3,g.sound.play("lost")},GameTitle.prototype.renderer=function(t){if(t.fillStyle="#333",g.rect(0,0,g.ui.width,g.ui.height),t.fillStyle="#EEE",t.font="20pt Consolas",t.fillText("OFFLINE PIZZA",20,40),g.ticker.ticks-this.lasttick>90&&this.nextFrame(),this.frame==this.texts.length)return g.restart(!1);t.font="12pt Consolas";for(let e=0;e<this.frame;e++)t.fillText(this.texts[e],20,80+20*e)},GameTitle.prototype.nextFrame=function(){this.frame++,this.lasttick=g.ticker.ticks},g.init=function(){return g.ui.bz=32,g.ui.blocksInView=10,g.ui.hudWidth=50,g.ui.scale={x:2,y:2},g.ui.width=g.ui.hudWidth+g.ui.blocksInView*g.ui.bz,g.ui.canvas.width=g.ui.width*g.ui.scale.x,g.ui.height=g.ui.blocksInView*g.ui.bz,g.ui.canvas.height=g.ui.height*g.ui.scale.y,g.ui.canvas.style.position="absolute",g.ui.win.width>g.ui.width*g.ui.scale.x&&(g.ui.canvas.style.left=g.ui.win.width/2-.5*g.ui.width*g.ui.scale.x+"px"),g.ui.win.height>g.ui.height*g.ui.scale.y&&(g.ui.canvas.style.top=g.ui.win.height/2-.5*g.ui.height*g.ui.scale.y+"px"),g.ctx.scale(g.ui.scale.x,g.ui.scale.y),g.ctx.translate(g.ui.hudWidth,0),g.ctx.imageSmoothingEnabled=!1,g.ImageLoader.add("tilemap","./tilemap.png"),g.ImageLoader.add("sprites","./spritemap.png"),()=>{g.ready()}},g.ready=function(){g.restart(1)},g.restart=function(t){g.Halt(),g.scene=new g.Scene,g.loadMap(),g.drawMap(),g.level=0,g.Start(),t?(g.state="title",g.title=g.scene.add(new GameTitle)):(g.camera=g.scene.add(new Camera({x:24*g.ui.bz,w:g.ui.blocksInView*g.ui.bz,h:g.ui.blocksInView*g.ui.bz,box:200})),g.collider=g.scene.add(new Collider),g.manager=g.scene.add(new GameManager),g.minimap=g.scene.add(new MiniMap),g.player=g.scene.add(new Player({x:28*g.ui.bz,y:37*g.ui.bz,velocity:2})),g.state="play")},g.GameOver=function(t){g.scene.entities.length=0,this.state="gameover",g.msg=t},g.preGameRender=function(t){"play"==g.state&&g.camera&&g.ctx.drawImage(g.c0,g.camera.x,g.camera.y,320,320,0,0,320,320)},g.postGameRender=function(t){if("gameover"==this.state)return delete g.camera,g.rect(0,0,g.ui.width,g.ui.height,"#333"),g.ctx.fillStyle="#EEE",g.ctx.font="20pt Consolas",g.ctx.fillText("GAME OVER",40,g.ui.height/2-10),g.ctx.font="12pt Consolas",g.ctx.fillText(g.msg,20,g.ui.height/2+20),void g.ctx.fillText("Press <SPACEBAR> to play again...",20,g.ui.height/2+40);g.minimap&&g.minimap.draw(t)},g.loadMap=function(){let t=document.createElement("canvas").getContext("2d"),e=g.ImageLoader.get.tilemap;t.drawImage(e,0,0);let i=t.getImageData(0,0,e.width,e.height).data,s=[];g.map=[];for(let t=0;t<e.height;t++){let a=[];a.length=e.width;for(let r=0;r<e.width;r++){let o=4*(t*e.width+r),n=[i[o],i[o+1],i[o+2],i[o+3]];if(0==t&&r<e.width)s.push(n);else for(let t=0;t<s.length;t++)if(n[0]===s[t][0]&&n[1]===s[t][1]&&n[2]===s[t][2]){a[r]=t;break}}t>0&&g.map.push(a)}},g.rect=function(t,e,i,s,a){g.ctx.fillStyle=a,g.ctx.fillRect(t,e,i,s)},g.drawMap=function(){let t=g.ui.bz,e=g.map[0].length,i=g.map.length,s=document.createElement("canvas");g.c0=s;let a=s.getContext("2d");s.width=e*t,s.height=i*t,g.rect(0,0,s.width,s.height,"#DDD");let r=g.ImageLoader.get.sprites;for(let s=0;s<i;s++)for(let i=0;i<e;i++)3==g.map[s][i]?a.drawImage(r,2*t,3*t,t,t,i*t,s*t,t,t):g.map[s][i]>=2&&a.drawImage(r,2*t,0*t,t,t,i*t,s*t,t,t);for(let s=0;s<i;s++)for(let i=0;i<e;i++){a.globalAlpha=1;let e=0,o=1;if(i>0&&15==g.map[s][i-1]){g.scene.add({tag:"block",x:i*g.ui.bz,y:s*g.ui.bz,w:g.ui.bz,h:g.ui.bz});continue}let n=Math.random();if(0==g.map[s][i]&&(a.globalAlpha=.9+.1*n),1==g.map[s][i]&&(a.globalAlpha=.7+.2*n),3==g.map[s][i]){if(n<.25)e=1;else if(n<.5)e=2;else{if(!(n<.75)){a.drawImage(r,2*t,0*t,t,t,i*t,s*t,t,t),g.scene.add({tag:"block",x:i*g.ui.bz,y:s*g.ui.bz,w:g.ui.bz,h:g.ui.bz}),g.map[s][i]=-1;continue}e=3}a.fillStyle="rgba(70,70,70,0.8)",a.fillRect((i+.8)*t,(s+.6)*t,.4*t,.4*t),g.scene.add(new House({x:i*g.ui.bz,y:s*g.ui.bz}))}else if(2==g.map[s][i])n<.3?e=1:n<.5&&(e=2);else if(g.map[s][i]>=4&&g.map[s][i]<=14);else{if(15==g.map[s][i]){g.pizzeria=g.scene.add({tag:"pizzeria",x:i*g.ui.bz,y:s*g.ui.bz,w:g.ui.bz,h:g.ui.bz}),a.drawImage(r,0,2*t,2*t,2*t,i*t,(s-1)*t,2*t,2*t);continue}if(17==g.map[s][i]){g.scene.add({tag:"block",x:i*g.ui.bz,y:s*g.ui.bz,w:g.ui.bz,h:g.ui.bz});continue}}a.drawImage(r,g.map[s][i]*t,e*t*o,t,o*t,i*t,s*t,t,t*o)}},g.ui.keys={left:g.Keyboard(["KeyA","ArrowLeft"]),right:g.Keyboard(["KeyD","ArrowRight"]),up:g.Keyboard(["KeyW","ArrowUp"]),down:g.Keyboard(["KeyS","ArrowDown"]),fire:g.Keyboard("Space")},g.ui.keys.left.down=function(){if("pause"==g.state)return g.Pause();"play"==g.state&&g.player.move(Vector.left())},g.ui.keys.right.down=function(){if("pause"==g.state)return g.Pause();"play"==g.state&&g.player.move(Vector.right())},g.ui.keys.up.down=function(){if("pause"==g.state)return g.Pause();"play"==g.state&&g.player.move(Vector.up())},g.ui.keys.down.down=function(){if("pause"==g.state)return g.Pause();"play"==g.state&&g.player.move(Vector.down())},g.ui.keys.fire.press=function(t){if("message"!=g.state)return"title"==g.state?g.title.nextFrame():"play"!=g.state?g.restart():void g.manager.vanStops()},g.sound={prospect:[11,11,11,11,11],order:[4,6,5],delivery:[11,6,5],lost:[17,19,22]},g.sound.play=function(snd,tempo,tone){with(tempo=tempo/1e3||.09,tone|=660,snd=g.sound[snd]||snd,new AudioContext)with(G=createGain())for(i in D=snd)with(createOscillator())D[i]&&(connect(G),G.connect(destination),start(i*tempo),frequency.setValueAtTime(tone*1.06**(13-D[i]),i*tempo),gain.setValueAtTime(1,i*tempo),gain.setTargetAtTime(1e-4,i*tempo+.08,.005),stop(i*tempo+.09))};</script></html>
