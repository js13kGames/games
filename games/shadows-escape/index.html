<!doctype html><title>Shadow's Escape - js13kGames 2025</title><style>*{margin:0;padding:0}body{background:#111;overflow:hidden;font-family:Arial}#game{position:relative;width:800px;height:400px;margin:50px auto;background:#222}.cell{position:absolute;width:20px;height:20px}.wall{background:#8b4513}.floor{background:#444}.player{background:#000;clip-path:polygon(20% 0%,30% 25%,70% 25%,80% 0%,90% 10%,100% 50%,100% 100%,0% 100%,0% 50%,10% 10%);z-index:10;transition:all .1s}.enemy{background:#666;border-radius:15%;z-index:5;border:2px solid #999}.mouse{background:#888;border-radius:70% 30% 70% 30%;z-index:5;width:15px;height:15px;position:relative}.mouse::after{content:"";position:absolute;width:8px;height:2px;background:#888;right:-6px;top:6px;border-radius:50%}.boss{background:#654321;clip-path:polygon(15% 0%,25% 30%,75% 30%,85% 0%,95% 15%,100% 50%,100% 100%,0% 100%,0% 50%,5% 15%);z-index:5;width:40px;height:40px;box-shadow:0 0 15px #654321}.fish{background:orange;border-radius:40% 60% 40% 60%;z-index:3}.yarn{background:#ff69b4;border-radius:50%;z-index:3}.milk{background:#fff;border-radius:50%;z-index:3;border:1px solid #ddd}.potion{background:#00f;border-radius:50%;z-index:3}.exit{background:#0ff;border-radius:50%;z-index:3;width:30px;height:30px;box-shadow:0 0 15px #0ff;animation:pulse 2s infinite}.shop{background:#ff69b4;z-index:3;animation:shimmer 1.5s infinite;box-shadow:0 0 10px #ff69b4}@keyframes pulse{0%,100%{box-shadow:0 0 15px #0ff;transform:scale(1)}50%{box-shadow:0 0 30px #0ff,0 0 45px #0ff;transform:scale(1.2)}}@keyframes shimmer{0%{box-shadow:0 0 10px #ff69b4}50%{box-shadow:0 0 20px #ff1493,0 0 30px #ff69b4}100%{box-shadow:0 0 10px #ff69b4}}#ui{position:fixed;top:10px;left:10px;color:#fff;font-size:12px;background:rgba(0,0,0,.8);padding:8px;border-radius:5px}#combat,#shop{position:fixed;top:15%;left:15%;width:70%;height:70%;background:rgba(0,0,0,.95);color:#fff;padding:15px;border-radius:8px;display:none;overflow-y:auto;z-index:2000}#combatLog{max-height:150px;overflow-y:auto;background:#222;padding:10px;margin:10px 0;border-radius:5px;font-size:11px}.btn{background:#444;color:#fff;border:none;padding:8px 15px;margin:3px;border-radius:3px;cursor:pointer}.btn:hover{background:#666}.heal-btn{background:#0a5c0a}.heal-btn:hover{background:#0e7e0e}.buy-btn{background:#1e5799}.buy-btn:hover{background:#2989d8}.expensive{background:#8b0000}.expensive:hover{background:brown}#defeatScreen,#startScreen,#victoryScreen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);color:#fff;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;z-index:1000}.screen h1{font-size:36px;margin:10px}.screen p{font-size:14px;margin:5px;max-width:500px}.survival-guide{background:linear-gradient(135deg,#1a1a1a 0,#2d2d2d 100%);border:2px solid #555;border-radius:10px;padding:15px;margin:10px auto;max-width:480px;box-shadow:0 0 20px rgba(0,255,255,.3)}.guide-item{display:flex;align-items:center;margin:8px 0;padding:5px;border-radius:5px;background:rgba(255,255,255,.1)}.guide-icon{width:20px;height:20px;margin-right:10px;border-radius:3px;display:inline-block}.player-icon{background:#000;clip-path:polygon(20% 0%,30% 25%,70% 25%,80% 0%,90% 10%,100% 50%,100% 100%,0% 100%,0% 50%,10% 10%)}.furniture-icon{background:#666;border:1px solid #999}.mouse-icon{background:#888;border-radius:70% 30% 70% 30%}.fish-icon{background:orange;border-radius:40% 60% 40% 60%}.milk-icon{background:#fff;border-radius:50%;border:1px solid #ddd}.door-icon{background:#0ff;border-radius:50%;box-shadow:0 0 10px #0ff}.boss-icon{background:#654321;clip-path:polygon(15% 0%,25% 30%,75% 30%,85% 0%,95% 15%,100% 50%,100% 100%,0% 100%,0% 50%,5% 15%)}.shop-icon{background:#ff69b4;box-shadow:0 0 5px #ff69b4}.ending-story{background:linear-gradient(135deg,#0a0a0a 0,#1a1a1a 100%);border:1px solid #333;border-radius:8px;padding:12px;margin:10px auto;max-width:480px;font-style:italic;box-shadow:inset 0 0 20px rgba(0,0,0,.8)}.bigBtn{background:#4caf50;color:#fff;border:none;padding:12px 24px;margin:8px;border-radius:8px;cursor:pointer;font-size:16px}.bigBtn:hover{background:#45a049}.restartBtn{background:#f44336;color:#fff;border:none;padding:12px 24px;margin:8px;border-radius:8px;cursor:pointer;font-size:16px}.restartBtn:hover{background:#da190b}#info{text-align:center;color:#fff;margin-top:10px;font-size:12px}.dmg-player{color:#0f0}.dmg-enemy{color:red}.heal{color:#00f}.gold-text{color:#ff0}.shop-item{margin:10px 0;padding:10px;background:#333;border-radius:5px}#bonusMessage{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(45deg,gold,orange);color:#000;padding:15px 25px;border-radius:10px;font-weight:700;font-size:16px;z-index:3000;box-shadow:0 0 20px rgba(255,215,0,.8);border:2px solid gold;animation:bonusPulse 2s ease-in-out}@keyframes bonusPulse{0%{transform:translate(-50%,-50%) scale(0);opacity:0}50%{transform:translate(-50%,-50%) scale(1.1);opacity:1}100%{transform:translate(-50%,-50%) scale(1);opacity:0}}</style><div id=game></div><div id=ui><div>Room:<span id=level>1</span></div><div>HP:<span id=hp>100</span></div><div>ATK:<span id=atk>10</span></div><div>DEF:<span id=armor>0</span></div><div>FISH:<span id=gold>0</span></div><div>MILK:<span id=potions>0</span></div><div>Dog Repellent:<span id=poison>0</span></div></div><div id=combat><div id=combatText></div><div id=combatLog></div><div id=combatButtons></div></div><div id=shop><div id=shopContent></div></div><div id=info>WASD or Arrows to move ‚Ä¢ Collect fish and treats to escape the house!</div><div id=startScreen class=screen><h1>SHADOW'S ESCAPE</h1><p><strong>In the darkness of night, you are Shadow - a cunning black cat trapped within the walls of a mysterious manor.</strong><p><strong>Five treacherous rooms stand between you and freedom. Navigate through furniture, outsmart scurrying mice, and face the ultimate guardian - a massive hound that prowls these halls.</strong><p><strong>Your survival depends on wit, agility, and the treasures you discover along the way.</strong><div class=survival-guide><p><strong>SURVIVAL GUIDE:</strong><div class=guide-item><div class="guide-icon player-icon"></div>You, the shadow cat</div><div class=guide-item><div class="guide-icon furniture-icon"></div>Furniture obstacles blocking your path</div><div class=guide-item><div class="guide-icon mouse-icon"></div>Mice that dart unpredictably</div><div class=guide-item><div class="guide-icon fish-icon"></div>Fish for sustenance and strength</div><div class=guide-item><div class="guide-icon milk-icon"></div>Precious milk for healing</div><div class=guide-item><div class="guide-icon door-icon"></div>Your gateway to freedom</div><div class=guide-item><div class="guide-icon boss-icon"></div>The guardian hound that hunts you</div><div class=guide-item><div class="guide-icon shop-icon"></div>Underground pet store for supplies</div></div><p><strong>Remember: Only by collecting enough fish can you gain the strength needed to face what lies ahead.</strong></p><button class=bigBtn onclick=startGame()>BEGIN THE ESCAPE</button></div><div id=victoryScreen class=screen style=display:none><h1>SHADOW'S TRIUMPH</h1><h2>Against all odds, you have escaped the cursed manor!</h2><div class=ending-story><p><strong>The cyan glow of freedom beckons as you slip through the cat door...</strong><p><strong>Behind you, the dark halls fall silent. The guardian hound's howls fade into the night.</strong><p><strong>You are Shadow no more - you are free.</strong></div><div class=survival-guide><p><strong>FINAL STATISTICS:</strong><div id=victoryStats></div></div><p><strong>The manor's secrets remain, but your legend lives on...</strong></p><button class=bigBtn onclick=location.reload()>Escape Again</button></div><div id=defeatScreen class=screen style=display:none><h1>SHADOW'S END</h1><h2 id=defeatMessage>Your escape attempt has failed...</h2><div class=ending-story><p><strong>The darkness of the manor consumes you...</strong><p><strong>Your tale ends here, but perhaps another shadow will attempt what you could not.</strong><p><strong>The manor awaits its next challenger.</strong></div><div class=survival-guide><p><strong>YOUR JOURNEY:</strong><div id=defeatStats></div></div><p><strong>Every shadow learns from defeat. Will you try again?</strong></p><button class=restartBtn onclick=location.reload()>Rise Again</button></div><script>const W=40,H=20;let px=5,py=5,map=[],enemies=[],treasures=[],shops=[],exits=[],rooms=[],playerHP=100,playerATK=10,playerGold=0,playerPotions=0,playerArmor=0,playerPoison=0,inCombat=!1,currentEnemy=null,gameStarted=!1,damageBoost=0,currentLevel=1,combatLog=[],levelComplete=!1,totalMiceInLevel=0,miceKilled=0;function initMap(){enemies=[],treasures=[],shops=[],exits=[],rooms=[],levelComplete=!1,totalMiceInLevel=0,miceKilled=0;for(let e=0;e<H;e++){map[e]=[];for(let t=0;t<W;t++)map[e][t]="#"}rooms=[];for(let e=0;e<6;e++){let e=4+Math.floor(4*Math.random()),t=3+Math.floor(3*Math.random()),o=2+Math.floor(Math.random()*(W-e-4)),n=2+Math.floor(Math.random()*(H-t-4));rooms.push({x:o,y:n,w:e,h:t});for(let a=n;a<n+t;a++)for(let t=o;t<o+e;t++)map[a][t]="."}for(let e=0;e<rooms.length-1;e++){let t=rooms[e],o=rooms[e+1],n=t.x+Math.floor(t.w/2),a=t.y+Math.floor(t.h/2),r=o.x+Math.floor(o.w/2),s=o.y+Math.floor(o.h/2),l=Math.min(n,r),m=Math.max(n,r);for(let e=l;e<=m;e++)map[a][e]=".";let i=Math.min(a,s),p=Math.max(a,s);for(let e=i;e<=p;e++)map[e][r]="."}for(let e=0;e<rooms.length;e++)for(let t=e+1;t<rooms.length;t++){let o=rooms[e],n=rooms[t],a=o.x+Math.floor(o.w/2),r=o.y+Math.floor(o.h/2),s=n.x+Math.floor(n.w/2),l=n.y+Math.floor(n.h/2);if(Math.random()<.3){for(let e=Math.min(a,s);e<=Math.max(a,s);e++)map[r][e]=".";for(let e=Math.min(r,l);e<=Math.max(r,l);e++)map[e][s]="."}}let e=rooms[0];if(px=e.x+1,py=e.y+1,map[py][px]=".",5===currentLevel){let e=rooms[rooms.length-1],t=e.x+Math.floor(e.w/2),o=e.y+Math.floor(e.h/2);if(Math.abs(t-px)<=3&&Math.abs(o-py)<=3)for(let e of rooms)if(Math.abs(e.x-px)>5||Math.abs(e.y-py)>5){t=e.x+Math.floor(e.w/2),o=e.y+Math.floor(e.h/2);break}enemies.push({x:t,y:o,hp:250+Math.floor(80*Math.random()),atk:30+Math.floor(20*Math.random()),isBoss:!0})}else{let e=Math.min(1+currentLevel,4),t=Math.min(1+currentLevel,6);console.log(`Level ${currentLevel}: Planning to spawn ${t} mice and ${e} furniture`);for(let t=0;t<e;t++){let e,t,o=rooms[Math.floor(Math.random()*rooms.length)];do{e=o.x+Math.floor(Math.random()*o.w),t=o.y+Math.floor(Math.random()*o.h)}while("."!==map[t][e]||e===px&&t===py||enemies.some(o=>o.x===e&&o.y===t));let n=20+8*currentLevel,a=3+2*currentLevel;enemies.push({x:e,y:t,hp:n+Math.floor(15*Math.random()),atk:a+Math.floor(5*Math.random()),isFurniture:!0})}for(let e=0;e<t;e++){let e,t,o=0,n=!1;do{let a=rooms[Math.floor(Math.random()*rooms.length)];if(e=a.x+2+Math.floor(Math.random()*Math.max(1,a.w-4)),t=a.y+2+Math.floor(Math.random()*Math.max(1,a.h-4)),o++,e>=3&&e<37&&t>=3&&t<17&&map[t]&&"."===map[t][e]&&(e!==px||t!==py)&&!enemies.some(o=>o.x===e&&o.y===t)){n=!0;for(let o=-1;o<=1;o++){for(let a=-1;a<=1;a++)if(map[t+o]&&"#"===map[t+o][e+a]){n=!1;break}if(!n)break}}}while(!n&&o<100);if(n){let o=15+6*currentLevel,n=2+2*currentLevel;enemies.push({x:e,y:t,hp:o+Math.floor(20*Math.random()),atk:n+Math.floor(6*Math.random()),isMouse:!0}),totalMiceInLevel++,console.log(`Spawned mouse ${totalMiceInLevel} at (${e},${t}) in level ${currentLevel}`)}}}if(currentLevel<5){let e=[];for(let t=0;t<3;t++){let t=rooms.filter(t=>!e.includes(t));0===t.length&&(t=rooms);let o,n,a=t[Math.floor(Math.random()*t.length)];e.push(a);let r=0;do{o=a.x+1+Math.floor(Math.random()*(a.w-2)),n=a.y+1+Math.floor(Math.random()*(a.h-2)),r++}while(r<50&&("."!==map[n][o]||o===px&&n===py||enemies.some(e=>e.x===o&&e.y===n)||treasures.some(e=>e.x===o&&e.y===n)||treasures.some(e=>Math.abs(e.x-o)+Math.abs(e.y-n)<3)));if(r<50){let e=["gold","weapon","armor"];treasures.push({x:o,y:n,type:e[Math.floor(Math.random()*e.length)]})}}}if(currentLevel<5&&Math.random()<.3){let e,t,o=rooms[Math.floor(Math.random()*rooms.length)];do{e=o.x+Math.floor(Math.random()*o.w),t=o.y+Math.floor(Math.random()*o.h)}while("."!==map[t][e]||e===px&&t===py||enemies.some(o=>o.x===e&&o.y===t)||treasures.some(o=>o.x===e&&o.y===t));treasures.push({x:e,y:t,type:"health"})}let t=enemies.filter(e=>e.isMouse).length,o=enemies.filter(e=>e.isFurniture).length,n=enemies.filter(e=>e.isBoss).length;console.log(`Level ${currentLevel} FINAL: ${t} mice spawned (totalMiceInLevel=${totalMiceInLevel}), ${o} furniture, ${n} boss`)}function spawnExit(){if(0===rooms.length)return;let e=0;for(;e<50;){let t=rooms[Math.floor(Math.random()*rooms.length)],o=t.x+Math.floor(Math.random()*t.w),n=t.y+Math.floor(Math.random()*t.h);if(!("."!==map[n][o]||o===px&&n===py||enemies.some(e=>e.x===o&&e.y===n)||shops.some(e=>e.x===o&&e.y===n)||treasures.some(e=>e.x===o&&e.y===n)))return void exits.push({x:o,y:n});e++}}function spawnShop(){if(0===rooms.length)return;let e=0;for(;e<50;){let t=rooms[Math.floor(Math.random()*rooms.length)],o=t.x+Math.floor(Math.random()*t.w),n=t.y+Math.floor(Math.random()*t.h);if("."===map[n][o]&&(o!==px||n!==py)&&!enemies.some(e=>e.x===o&&e.y===n)&&!exits.some(e=>e.x===o&&e.y===n)&&!treasures.some(e=>e.x===o&&e.y===n)&&Math.abs(o-px)>2||Math.abs(n-py)>2)return void shops.push({x:o,y:n});e++}}function render(){const e=document.getElementById("game");e.innerHTML="";for(let t=0;t<H;t++)for(let o=0;o<W;o++){const n=document.createElement("div");n.className="cell "+("#"===map[t][o]?"wall":"floor"),n.style.left=20*o+"px",n.style.top=20*t+"px",e.appendChild(n)}treasures.forEach(t=>{const o=document.createElement("div");let n="fish";"health"===t.type?n="milk":"weapon"===t.type?n="yarn":"armor"===t.type&&(n="fish"),o.className="cell "+n,o.style.left=20*t.x+"px",o.style.top=20*t.y+"px",e.appendChild(o)}),exits.forEach(t=>{const o=document.createElement("div");o.className="cell exit",o.style.left=20*t.x+"px",o.style.top=20*t.y+"px",e.appendChild(o)}),shops.forEach(t=>{const o=document.createElement("div");o.className="cell shop",o.style.left=20*t.x+"px",o.style.top=20*t.y+"px",e.appendChild(o)}),enemies.forEach(t=>{const o=document.createElement("div");let n="enemy";t.isBoss?n="boss":t.isMouse&&(n="mouse"),o.className="cell "+n,o.style.left=20*t.x+"px",o.style.top=20*t.y+"px",e.appendChild(o)});const t=document.createElement("div");t.className="cell player",t.style.left=20*px+"px",t.style.top=20*py+"px",e.appendChild(t)}function move(e,t){if(inCombat)return;const o=px+e,n=py+t;if(o>=0&&o<W&&n>=0&&n<H&&"."===map[n][o]){if(px=o,py=n,treasures=treasures.filter(e=>e.x!==px||e.y!==py||(collectTreasure(e),!1)),exits.find(e=>e.x===px&&e.y===py))return void(currentLevel<5?(currentLevel++,initMap(),render(),updateUI(),addToCombatLog(`<span class="gold-text">Entered Room ${currentLevel}!</span>`)):showVictoryScreen());if(shops.find(e=>e.x===px&&e.y===py))return void openShop();let e=enemies.find(e=>e.isBoss?px>=e.x&&px<=e.x+1&&py>=e.y&&py<=e.y+1:e.x===px&&e.y===py);if(e)return void startCombat(e);currentLevel<5&&0===treasures.length&&!levelComplete&&(levelComplete=!0,spawnShop(),spawnExit(),render(),addToCombatLog('<span class="gold-text">Room cleared! Find the cat door or visit the pet store!</span>')),moveEnemies(),cleanupGlitchedEnemies(),checkEnemyCollision(),render(),updateUI()}}function openShop(){document.getElementById("shop").style.display="block";let e=`<h2>üêæ PET STORE - Room ${currentLevel}</h2>`;e+=`<div class="shop-item">\n        <strong>Fresh Milk</strong> - Heals 30-50 HP<br>\n        Cost: 50 fish<br>\n        <button class="btn buy-btn" onclick="buyItem('potion',50)" ${playerGold<50?"disabled":""}>Buy</button>\n    </div>`,e+=`<div class="shop-item">\n        <strong>Catnip Power</strong> - +5 Attack<br>\n        Cost: 80 fish<br>\n        <button class="btn buy-btn" onclick="buyItem('weapon',80)" ${playerGold<80?"disabled":""}>Buy</button>\n    </div>`,e+=`<div class="shop-item">\n        <strong>Thick Fur</strong> - +3 Defense<br>\n        Cost: 100 fish<br>\n        <button class="btn buy-btn" onclick="buyItem('armor',100)" ${playerGold<100?"disabled":""}>Buy</button>\n    </div>`,currentLevel>=3&&(e+=`<div class="shop-item">\n            <strong>DOG REPELLENT</strong><br>\n            Scares away 50% of dog's aggression!<br>\n            Cost: 300 fish<br>\n            <button class="btn expensive" onclick="buyItem('poison',300)" ${playerGold<300?"disabled":""}>Buy</button>\n        </div>`),e+='<button class="btn" onclick="closeShop()">Leave Shop</button>',document.getElementById("shopContent").innerHTML=e}function buyItem(e,t){if(playerGold>=t){switch(playerGold-=t,e){case"potion":playerPotions++;break;case"weapon":playerATK+=5;break;case"armor":playerArmor+=3;break;case"poison":playerPoison++}updateUI(),openShop()}}function closeShop(){document.getElementById("shop").style.display="none"}function cleanupGlitchedEnemies(){let e=enemies.length;enemies=enemies.filter(e=>{if(e.x<1||e.x>=39||e.y<1||e.y>=19)return!1;if(map[e.y]&&"#"===map[e.y][e.x])return!1;if(e.isBoss){if(e.x+1>=39||e.y+1>=19)return!1;if(map[e.y]&&"#"===map[e.y][e.x])return!1;if(map[e.y+1]&&"#"===map[e.y+1][e.x])return!1;if(map[e.y]&&"#"===map[e.y][e.x+1])return!1;if(map[e.y+1]&&"#"===map[e.y+1][e.x+1])return!1}return!0});let t=e-enemies.length;t>0&&console.log(`Cleaned up ${t} glitched enemies`)}function checkEnemyCollision(){let e=enemies.find(e=>e.isBoss?px>=e.x&&px<=e.x+1&&py>=e.y&&py<=e.y+1:e.x===px&&e.y===py);e&&!inCombat&&startCombat(e)}function collectTreasure(e){switch(e.type){case"gold":let e=30+Math.floor(40*Math.random());playerGold+=e,addToCombatLog(`<span class="gold-text">Found ${e} shiny fish!</span>`);break;case"health":playerPotions++,addToCombatLog('<span class="heal">Found fresh milk!</span>');break;case"weapon":let t=3+Math.floor(4*Math.random());playerATK+=t,addToCombatLog(`<span style="color:#ff69b4">Played with yarn! +${t} agility!</span>`);break;case"armor":let o=2+Math.floor(3*Math.random());playerArmor+=o,addToCombatLog(`<span style="color:#0f0">Ate nutritious fish! +${o} defense!</span>`)}}function moveEnemies(){enemies.forEach(e=>{if(e.isMouse&&Math.random()<.6){let t=[[0,1],[0,-1],[1,0],[-1,0]],o=[];for(let n of t){let t=e.x+n[0],a=e.y+n[1];t>=2&&t<38&&a>=2&&a<18&&map[a]&&"."===map[a][t]&&"#"!==map[a-1][t]&&"#"!==map[a+1][t]&&"#"!==map[a][t-1]&&"#"!==map[a][t+1]&&!enemies.some(o=>o!==e&&o.x===t&&o.y===a)&&o.push([t,a])}if(o.length>0){let[t,n]=o[Math.floor(Math.random()*o.length)];e.x=t,e.y=n}}else if(e.isBoss){let t=Math.abs(px-e.x)+Math.abs(py-e.y)<=6?.8:.4;if(Math.random()<t){let t=0,o=0;px>e.x?t=1:px<e.x&&(t=-1),py>e.y?o=1:py<e.y&&(o=-1);let n=[];0!==t&&n.push([t,0]),0!==o&&n.push([0,o]),(0===n.length||Math.random()<.2)&&(n=[[0,1],[0,-1],[1,0],[-1,0]]);for(let t of n){let o=e.x+t[0],n=e.y+t[1];if(o>0&&o<38&&n>0&&n<18&&"."===map[n][o]&&"."===map[n+1][o]&&"."===map[n][o+1]&&"."===map[n+1][o+1]){e.x=o,e.y=n;break}}}}})}function startCombat(e){if(inCombat=!0,currentEnemy=e,combatLog=[],document.getElementById("combat").style.display="block",e.isBoss&&playerPoison>0){let e=Math.floor(currentEnemy.hp/2);currentEnemy.hp-=e,playerPoison--,addToCombatLog(`<span style="color:#ff0">DOG REPELLENT used! ${e} damage dealt!</span>`),updateUI()}addToCombatLog(`<span style="color:#ff0">${e.isBoss?"CONFRONTING THE GIANT DOG!":e.isMouse?"A MOUSE IS ATTACKING!":"Furniture is blocking your path!"}</span>`),updateCombatUI()}function updateCombatUI(){currentEnemy&&(document.getElementById("combatText").innerHTML=`\n        <h3>${currentEnemy.isBoss?"DOG FIGHT":currentEnemy.isMouse?"MOUSE BATTLE":"Navigating Furniture"}</h3>\n        <p>${currentEnemy.isBoss?"Dog":currentEnemy.isMouse?"Mouse":"Furniture"} HP:${currentEnemy.hp} ATK:${currentEnemy.atk}</p>\n        <p>Your HP:${playerHP} ATK:${playerATK+damageBoost}</p>\n    `,document.getElementById("combatButtons").innerHTML=`\n        <button class="btn" onclick="attack()">${currentEnemy.isBoss?"üêæ Hiss & Scratch":currentEnemy.isMouse?"üêæ Pounce":"üêæ Push Through"}</button>\n        <button class="btn heal-btn" onclick="usePotion()" ${playerPotions<=0?"disabled":""}>Drink Milk (${playerPotions})</button>\n        <button class="btn" onclick="flee()" ${currentEnemy.isBoss?"disabled":""}>Sneak Away</button>\n    `)}function addToCombatLog(e){combatLog.push(e),combatLog.length>10&&combatLog.shift(),document.getElementById("combatLog").innerHTML=combatLog.join("<br>"),document.getElementById("combatLog").scrollTop=document.getElementById("combatLog").scrollHeight}function attack(){if(!currentEnemy)return;let e=Math.floor(20*Math.random())+1,t=Math.floor(20*Math.random())+1,o=Math.floor((playerATK+damageBoost)*(e/20)),n=Math.max(1,Math.floor(currentEnemy.atk*(t/20))-playerArmor),a=currentEnemy.isBoss?"dog":currentEnemy.isMouse?"mouse":"furniture",r="",s="";if(20===e?(o*=2,r=" CRITICAL HIT!"):1===e&&(o=0,r=" FUMBLE!"),20===t?(n*=2,s=" CRITICAL HIT!"):1===t&&(n=0,s=" FUMBLE!"),currentEnemy.hp-=o,playerHP-=n,damageBoost=Math.max(0,damageBoost-1),addToCombatLog(`Dice: You rolled ${e}, ${a} rolled ${t}`),addToCombatLog(`<span class="dmg-player">Claw attack: ${o} damage${r}</span>`),addToCombatLog(`<span class="dmg-enemy">Counter: ${n} damage${s}</span>`),playerHP<=0)return addToCombatLog('<span class="dmg-enemy">You got caught!</span>'),void setTimeout(()=>showDefeatScreen(currentEnemy),1e3);if(currentEnemy.hp<=0){let e=15+Math.floor(20*Math.random());currentEnemy.isBoss&&(e*=4),playerGold+=e,addToCombatLog(`<span style="color:#ff0">${currentEnemy.isBoss?"DOG DEFEATED!":currentEnemy.isMouse?"Mouse caught!":"Obstacle cleared!"} +${e} shiny things</span>`);let t=currentEnemy.isMouse;if(t&&miceKilled++,enemies=enemies.filter(e=>e!==currentEnemy),endCombat(),t&&currentLevel<5){let e=enemies.filter(e=>e.isMouse).length;console.log(`Level ${currentLevel}: Killed mouse. Remaining mice: ${e}, Total spawned: ${totalMiceInLevel}`),0===e&&totalMiceInLevel>0&&setTimeout(()=>{let e=25*currentLevel;playerGold+=e,showBonusMessage(`ALL MICE DEFEATED! +${e} FISH BONUS!`),updateUI()},500)}5===currentLevel&&0===enemies.length&&(levelComplete=!0,setTimeout(()=>{spawnExit(),render(),addToCombatLog('<span class="gold-text">GIANT DOG DEFEATED! Cat door opened - You\'re free!</span>')},1e3))}updateCombatUI()}function usePotion(){if(playerPotions>0){let e=30+Math.floor(20*Math.random());playerHP=Math.min(100,playerHP+e),playerPotions--,addToCombatLog(`<span class="heal">Drank milk! Restored ${e} HP!</span>`),updateCombatUI()}}function flee(){if(!currentEnemy.isBoss)if(Math.random()<.7)addToCombatLog('<span style="color:#0f0">Sneaked away successfully!</span>'),endCombat();else{let e=Math.floor(.3*currentEnemy.atk);if(playerHP-=e,addToCombatLog(`<span class="dmg-enemy">Couldn't sneak away! Took ${e} damage</span>`),playerHP<=0)return void showDefeatScreen(currentEnemy);updateCombatUI()}}function endCombat(){inCombat=!1,currentEnemy=null,document.getElementById("combat").style.display="none",render(),updateUI()}function updateUI(){document.getElementById("level").textContent=currentLevel,document.getElementById("hp").textContent=playerHP,document.getElementById("atk").textContent=playerATK+(damageBoost?`+${damageBoost}`:""),document.getElementById("armor").textContent=playerArmor,document.getElementById("gold").textContent=playerGold,document.getElementById("potions").textContent=playerPotions,document.getElementById("poison").textContent=playerPoison}function showBonusMessage(e){let t=document.getElementById("bonusMessage");t&&t.remove();let o=document.createElement("div");o.id="bonusMessage",o.textContent=e,document.getElementById("game").appendChild(o),setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},2e3)}function startGame(){gameStarted=!0,document.getElementById("startScreen").style.display="none",initMap(),render(),updateUI()}function showVictoryScreen(){document.getElementById("combat").style.display="none",document.getElementById("shop").style.display="none",document.getElementById("victoryStats").innerHTML=`\n        Final Room: ${currentLevel}<br>\n        HP: ${playerHP}/100<br>\n        Agility: ${playerATK}<br>\n        Defense: ${playerArmor}<br>\n        Fish Collected: ${playerGold}\n    `,document.getElementById("victoryScreen").style.display="flex"}function showDefeatScreen(e){document.getElementById("combat").style.display="none",document.getElementById("shop").style.display="none";let t="Your escape attempt has failed...";e&&(e.isBoss?t="The mighty hound has cornered you in the shadows...":e.isMouse?t="Overwhelmed by the tiny but fierce creatures...":e.isFurniture&&(t="The treacherous furniture has trapped you...")),document.getElementById("defeatMessage").textContent=t,document.getElementById("defeatStats").innerHTML=`\n        Room Reached: ${currentLevel}/5<br>\n        Fish Collected: ${playerGold}\n    `,document.getElementById("defeatScreen").style.display="flex"}document.addEventListener("keydown",e=>{if(gameStarted)switch(e.key.toLowerCase()){case"w":case"arrowup":move(0,-1);break;case"s":case"arrowdown":move(0,1);break;case"a":case"arrowleft":move(-1,0);break;case"d":case"arrowright":move(1,0)}})</script>