<!doctype html><title>Tower Defense 13 - js13kGames 2012</title><style>*{margin:0;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;-ms-box-sizing:border-box;box-sizing:border-box;-webkit-transition:all .2s linear;-moz-transition:all .2s linear;-o-transition:all .2s linear;-ms-transition:all .2s linear;transition:all .2s linear}body{overflow:scroll}#main{z-index:2;position:fixed;bottom:0;top:0;width:250px;background-color:#111;-webkit-box-shadow:3px 0 3px #111;box-shadow:3px 0 3px #111;overflow:scroll}canvas{position:absolute;left:250px;z-index:1}#loading{z-index:3;position:fixed;top:0;left:0;right:0;bottom:0;width:100%;height:100%;color:rgba(0,183,229,.9);background:#000;padding:15px}#loadingText{text-transform:uppercase;text-align:center}#loading.hidden{top:50%;bottom:50%;height:0;color:#fff;overflow:hidden;padding:0}#loading .hidden{color:#000;opacity:0}#main>*{color:gray;padding:10px}#main>:hover{color:#fff}ul{list-style:none;margin:0}.container{padding:7px;display:inline-block;height:61px;color:gray;font-weight:700;cursor:default;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-transition-duration:.1s;-moz-transition-duration:.1s;-o-transition-duration:.1s;-ms-transition-duration:.1s;transition-duration:.1s}.container:not(.expensive):not(.building):hover{background-color:rgba(255,255,255,.25);color:#fff;cursor:pointer}.container span{display:block;text-shadow:1px 1px 1px #000}.container img{margin:0;float:left;padding:5px}.container.expensive{color:red;text-decoration:line-through}.container.building,.container.expensive.building{color:#fff;text-decoration:line-through}.screen.show{top:0;bottom:0;color:rgba(0,183,229,.9);padding:15px;width:100%;height:100%}.screen{z-index:3;position:fixed;left:0;right:0;background:#000;top:50%;bottom:50%;height:0;color:#fff;overflow:hidden;padding:0}.boldText{text-transform:uppercase;text-align:center}.tryAgain{cursor:pointer}.tile{background:green;border:0}.tile:disabled{background:red;color:#fff}</style><div id=gameOver class=screen><h1 class=boldText>Game Over! Failure.</h1><ul><li><span>You lasted <span class=timeLasted></span> seconds. Try harder next time!</span><li><span>Here are your stats for this game:</span><li><span>You passed <span class=wavesCompleted></span> waves.</span><li><span>You spent $<span class=moneySpent></span>.</span><li><span>You built <span class=towersBuilt></span> tower(s).</span><li><span>You upgraded <span class=towersUpgraded></span> tower(s).</span><li><span>You sold <span class=towersSold></span> tower(s)!</span><li><span>You repaired your base <span class=baseRepaired></span> times.</span></ul><a class=tryAgain>Try Again?</a></div><div id=gameWon class=screen><h1 class=boldText>Game Complete! Victory!</h1><ul><li><span>You beat them down in <span class=timeLasted></span> seconds!</span><li><span>Here are your stats for this game:</span><li><span>You passed <span class=wavesCompleted></span> waves.</span><li><span>You spent $<span class=moneySpent></span>.</span><li><span>You built <span class=towersBuilt></span> tower(s).</span><li><span>You upgraded <span class=towersUpgraded></span> tower(s).</span><li><span>You sold <span class=towersSold></span> tower(s)!</span><li><span>You repaired your base <span class=baseRepaired></span> times.</span></ul><a class=tryAgain>Try Again?</a></div><div id=loading><span id=loadingText>loading...</span><ul class=hidden id=message><li><span>Instructions:</span><li>When building:<ul><li>Middle click to return building for full value.<li>Left click to place on desired tile. Cannot place on structures or rough terrain.</ul><li>Otherwise:<ul><li>Left click a structure to select it.<li>Left click the map to clear selection.<li>Structures sell for a 100% return of their initial cost, and 25% return of upgrade cost.<li>Upgrades enhance tower range, speed, damage and some other stats.<li>Money from enemies decreases with each wave. Spend wisely!</ul><li>Shortcuts:<ul><li>Use the number keys 1-5 to purchase a building, or select it in the build menu.<li>Repair with Q, Upgrade with W, and Sell with E.<li>Change tile to: normal with A, slow with S, fast with D, and wall with F.</ul><li><input id=startGame type=button value="Okay, bring it!"></ul></div><div id=main><div id=data></div><div id=towers></div><div id=selection></div><div id=features><ul><li>Convert Tiles<li><input id=normalTile type=button value="normal (a)" disabled=disabled class=tile><input id=slowTile type=button value="slow (s)" disabled=disabled class=tile><input id=fastTile type=button value="fast (d)" disabled=disabled class=tile><input id=wallTile type=button value="wall (f)" disabled=disabled class=tile><li><span>Middle click to cancel building, or sell a structure.</span><li><input id=repair type=button value="Repair Tower" disabled=disabled><input id=upgrade type=button value="Upgrade Tower" disabled=disabled><input id=sell type=button value="Sell Tower" disabled=disabled><input id=nextWave type=button value="Advance Wave"></ul></div><div id=tower></div></div><canvas id=canvas></canvas><div id=stats></div><script>!function(e,t){function n(e,t){return Math.floor(Math.random()*(t-e+1))+e}function r(e,t){var n;if(Array.isArray(e))for(n=0;n<e.length;n++)t.call(e[n],n);else for(n in e)e.hasOwnProperty(n)&&t.call(e[n],n)}function i(e,t,n,r){return"rgba("+e+","+t+","+n+","+(r||1)+")"}function a(e,t){Se[ct]=e,Se[ft]=t,Fe.clearRect(0,0,e,t)}function o(e,t,n,r){var i,a=Object.create(null);for(var o in e)t&&n?(i=t.indexOf(o),a[o]=i>-1?n[i](e,o,r):e[o]):a[o]=e[o];return a}function l(e){return e-50<0?0:e-50}function u(e){if(e)return e[Me.x][Me.y]}function s(e,t){e.health-=t}function c(e){return It[wt].round(e)}function f(e){return It[wt][bt](e)}function h(e,t){return c(e*ze+zt-t/2)}function d(){for(var e=0,t=0;t<rt[mt];t++)e+=rt[t].priority;var r=n(0,e-1);for(t=0;t<rt[mt];t++){if(r<rt[t].priority)return t;r-=rt[t].priority}return!1}function p(e,t,n){var r=[];for(var i in e)e[i][t]===n&&r[kt](e[i]);return!!r.length&&r}function g(e,t){return(e-e%t)/t}function y(e,t){return Math.random()*(t-e)+e}function v(e,t,n){return{red:e,green:t,blue:n}}function x(){(Se=Xe[vt]("canvas"))[ct]=Pe*ze,Se[ft]=Ie*ze,Fe=Se.getContext("2d"),Je.push((function(e,t){Fe.drawImage(e.image,h(e.x,ze),h(e.y,ze))})),Ve.push((function(e,t){if(0!==t&&"string"!=typeof t.weapon){Fe.beginPath();var n=h(t.x,1),r=h(t.y,1);Fe.arc(n,r,32*t.weapon.range,0,2*Math.PI,!1),Fe.fillStyle="rgba(255,255,255,0.2)",Fe.fill();var i=32*t.weapon.range-1,a=4*Math.PI,o=2*Math.PI;Fe.beginPath(),Fe.arc(n,r,i,a,o,!1),Fe.lineWidth=2,Fe.strokeStyle="rgba(0,0,0,0.2)",Fe.stroke()}})),Ke.push((function(e,t){0!==t&&(Fe.drawImage(t.image,h(t.x,t.width),function(e,t){return c(e*ze+zt-t)}(t.y,t.height)),t.weapon.name&&function(e){if(e.weapon.timer>=e.weapon.delay){var t=[],n=h(e.x,1),i=h(e.y,1,e.size)-e.height,a=e.weapon.range*ze;if(r(at,(function(e){var r=this;we(n,i,a,r.pixelX,r.pixelY,r.size/2)&&t.push(r)})),e.weapon.timer>=e.weapon.delay){var l=be(t);if(l){e.weapon.timer=0;var u=n-l.pixelX,s=i-l.pixelY,c=Math.atan(u/s),f=e.weapon.speed/60*Math.sin(c),d=e.weapon.speed/60*Math.cos(c),p=Math.sqrt(f*f+d*d)/(e.weapon.speed/2),g=l.speed*p;l.targetX>l.x?f+=g:l.targetX<l.x&&(f-=g),l.targetY>l.y?d+=g:l.targetY<l.y&&(d-=g),function(e,t,n,r,i,a,l){for(var u=0;u<e.weapon.amount;u++){var s=o(e.weapon);lt.push(Ce(s,{x:t,y:n,dx:e.weapon.directionFunction(r),dy:e.weapon.directionFunction(i),targetX:a,targetY:l}))}}(e,n,i,f,d,u,s)}}}e.weapon.timer++}(t))})),Qe.push((function(){if(function(){var e=W().health||0,t="<li>",n="</li>",r="<code>",i="</code>",a=[];a[kt]("Base Health: "+r+e+i),a[kt]("Wave: "+r+Le+i),a[kt]("Enemies: "+r+qe+i),a[kt]("Enemies Remaining: "+r+(nt[0].length+at.length)+i),a[kt]("money: "+r+Mt+i),Xe[vt]("data")[yt]="<ul>"+t+a.join(n+t)+n+"</ul>";a=[];if(a[kt]("Mouse Position: "+r+Me.x+", "+Me.y+i),a[kt]("Tile: "+r+u(Ze).name+i),a[kt]("Can Build: "+r+Q()+i),Xe[vt]("selection")[yt]="<ul>"+t+a.join(n+t)+n+"</ul>",null!==He){(a=[]).push("Name: "+r+He.name+i),a.push("Level: "+r+He.level+i),a.push("Health: "+r+He.health/He.fullHealth*100+"%"+i),a.push("Weapon Stats:"),a.push("Name: "+r+He.weapon.name+i),a.push("Range: "+r+He.weapon.range+i),a.push("Bullets Per Shot: "+r+He.weapon.amount+i),a.push("Delay: "+r+He.weapon.delay+i),a.push("Damage: "+r+He.weapon.damage+i),Xe[vt]("tower")[yt]="<ul>"+t+a.join(n+t)+n+"</ul>",ye(),"Base"!==He.name&&(Xe[vt]("sell").removeAttribute("disabled"),ce(Xe[vt]("sell"),"click",ae),Xe[vt]("upgrade").value="Upgrade Tower ($"+$(He)+")",G()&&(Xe[vt]("upgrade").removeAttribute("disabled"),ce(Xe[vt]("upgrade"),"click",oe))),He.health<He.fullHealth&&(Xe[vt]("repair").value="Repair Tower ($"+J(He)+")",Xe[vt]("repair").removeAttribute("disabled"),ce(Xe[vt]("repair"),"click",le))}else ye();0===et[Me.x][Me.y]&&("wall"!==u(Ze).type&&Mt>=250&&(Xe[vt]("wallTile").removeAttribute("disabled"),ce(Xe[vt]("wallTile"),"click",P)),"normal"!==u(Ze).type&&Mt>=100&&(Xe[vt]("normalTile").removeAttribute("disabled"),ce(Xe[vt]("normalTile"),"click",X)),"slow"!==u(Ze).type&&Mt>=100&&(Xe[vt]("slowTile").removeAttribute("disabled"),ce(Xe[vt]("slowTile"),"click",T)),"fast"!==u(Ze).type&&Mt>=100&&(Xe[vt]("fastTile").removeAttribute("disabled"),ce(Xe[vt]("fastTile"),"click",Y)))}(),strokeColor="black",Q()&&V()?strokeColor="green":Q()===St?strokeColor="blue":Q()||(strokeColor="red"),function(){var e=32*Me.x,t=32*Me.y;if(Fe.strokeStyle=strokeColor,Fe.lineWidth=2,Fe.strokeRect(e,t,32,32),Fe.strokeStyle="#FFF",Fe.strokeRect(e-2,t-2,36,36),null!==He){e=32*He.x,t=32*He.y;if(Fe.strokeStyle="#FFF",Fe.lineWidth=2,Fe.strokeRect(e,t,32,32),"string"!=typeof He.weapon){Fe.beginPath(),Fe.arc(h(He.x,1),h(He.y,1),32*He.weapon.range,0,2*Math.PI,!1),Fe.fillStyle="rgba(255,255,255,0.3)",Fe.fill();var n=32*He.weapon.range-1,r=4*Math.PI,i=2*Math.PI;Fe.beginPath(),Fe.arc(h(He.x,1),h(He.y,1),n,r,i,!1),Fe.lineWidth=2,Fe.strokeStyle="rgba(0,0,0,0.3)",Fe.stroke()}}}(),r(at,(function(e){var t=this;if(t.health<1)E(t,e);else{Fe.beginPath(),Fe.strokeStyle="white",Fe.lineWidth=2,Fe.strokeRect(t.pixelX,t.pixelY,t.size,t.size),Fe.fillStyle=t.color,Fe.fillRect(t.pixelX,t.pixelY,t.size,t.size),Fe.fill(),Fe.closePath();var n=15,r=100*t.fullHealth,i=100*t.health,a=(r-i)/(r/2)+1;i<r/2&&(a=(r/2-i)/(r/2));var o=a*Math.PI,l=1*Math.PI;Fe.beginPath(),Fe.arc(t.pixelX+t.size/2,t.pixelY+t.size/2,n,o,l,!1),Fe.lineWidth=2,Fe.strokeStyle="rgba(255,0,0,0.4)",Fe.stroke()}})),function(){for(var e=0;e<lt.length;e++){var t=lt[e];if(t.x+t.radius>Se.width||t.y+t.radius>Se.height||t.x<0||t.y<0)lt.splice(e,1);else{var n=ke(t);if(n){lt.splice(e,1),s(n,t.damage);var r=n.pixelX,a=n.pixelY,o=n.size/2;xe(f(t.damage/n.fullHealth*n.size)+1,60,[2,7],[-2,2,-2,2],[r,a-o,r+o,a+o],[i(n.red,n.green,n.blue),i(l(n.red),l(n.green),l(n.blue))])}else Fe.beginPath(),Fe.fillStyle="rgba("+t.red+","+t.green+","+t.blue+","+t.life/t.maxLife+")",Fe.arc(t.x,t.y,t.radius,0,2*Math.PI,!1),Fe.fill(),Fe.closePath(),(t.life>0||t.life<0)&&(t.targetX>0&&t.targetY>0||t.targetX<0&&t.targetY>0?(t.x-=t.speed*t.dx,t.y-=t.speed*t.dy):(t.x+=t.speed*t.dx,t.y+=t.speed*t.dy),t.life--),0===t.life&&lt.splice(e,1)}}}(),r(at,(function(e){var t=this;if(Ye&&t.pathIndex<t[Xt][mt]){var n=t[Xt][t.pathIndex];t.x=g(t.pixelX+t.size/2,ze),t.y=g(t.pixelY+t.size/2,ze),t.targetX=n.x,t.targetY=n.y;var r=Ze[t.x][t.y],i=t[Pt]/r[Pt],a=h(t.targetX,t.size),o=h(t.targetY,t.size);c(t.pixelX)<a?t.pixelX+i>a?t.pixelX=a:t.pixelX+=i:c(t.pixelY)<o?t.pixelY+i>o?t.pixelY=o:t.pixelY+=i:c(t.pixelX)>a?t.pixelX-i<a?t.pixelX=a:t.pixelX-=i:c(t.pixelY)>o&&(t.pixelY-i<o?t.pixelY=o:t.pixelY-=i),c(t.pixelX)===h(t.targetX,t.size)&&c(t.pixelY)===h(t.targetY,t.size)&&t.pathIndex++}Ye&&t.x===Ye.x&&t.y===Ye.y&&(function(e){s(Ye,e.health),Ye.health<1&&(D(Ye.x,Ye.y),Ye=null,W()||m())}(t),E(t,e,!0))})),function(){for(var e=0;e<ot.length;e++){var t=ot[e];Fe.beginPath(),Fe.fillStyle=t.color,Fe.fillRect(t.x,t.y,t.w,t.h),Fe.fill(),Fe.closePath(),t.life=t.life-1,t.life>0?(t.x=t.x+t.dx,t.y=t.y+t.dy):ot.splice(e,1)}}(),Te++,We++,nt[1]?Xe[vt]("nextWave").removeAttribute("disabled"):nt[1]||Xe[vt]("nextWave").setAttribute("disabled",!0),nt[0].length||nt[1]||at.length)if(nt[0].length&&120===Te){Te=0;for(var e=0;e<c(Le/2);e++)z()}else(600===Te||Be)&&nt[1]&&(Be&&(Ge++,Be=!1),Le++,nt.splice(0,1),qe=nt[0].length,Te=0);else b(),Xe.getElementById("gameWon").classList.add("show")})),Ae("cannon",1,15,1,10,4,50,3,v(n(200,255),n(0,100),n(0,100)),(function(e){return e})),Ae("spread",5,20,1,50,3,25,3,v(n(0,100),n(0,100),n(100,255)),(function(e){return y(e-e/2,e+e/2)})),Ae("gatling",1,15,1,3,4,50,3,v(n(0,100),n(100,255),n(0,100)),(function(e){return y(e-e/2,e+e/2)})),Ae("explode",25,120,5,50,5.5,35,3,v(n(0,100),n(100,255),n(100,255)),(function(e){return y(-2,2)/60})),Ae("spike",1,10,1,15,1,15,2,v(n(100,255),n(0,100),n(100,255)),(function(e){return y(e-e/2,e+e/2)})),tt[kt](q("Base","none","special",1e6,1e3,[[10,15],[20,30],[10,15]],[v(225,0,0),v(l(225),0,0)])),tt[kt](q("Cannon","cannon","basic",50,10,[[10,15],[10,15],[5,10]],[v(200,0,0),v(l(200),0,0)])),tt[kt](q("Shotgun","spread","basic",250,10,[[15,20],[15,20],[10,15]],[v(125,0,0),v(l(125),l(125),0)])),tt[kt](q("Explode","explode","basic",500,10,[[20,25],[20,25],[15,20]],[v(125,0,0),v(0,l(125),l(125))])),tt[kt](q("Gatling","gatling","basic",1e3,10,[[25,30],[25,30],[20,25]],[v(125,0,0),v(0,0,125)])),tt[kt](q("Spike","spike","trap",100,10,[[5,10],[5,10],[5,10]],[v(125,0,0),v(0,0,125)])),rt.push(w("grass",Xt,7,1,A([[1024,175,230,1.3,1,2],[50,200,245,1,1.3,1.5],[100,125,175,2,1,2]]))),rt.push(w("darkGrass",Xt,7,1,A([[1024,150,205,1.3,1,2],[50,175,220,1,1.3,1.5],[100,100,150,2,1,2]]))),rt.push(w("road","fast",4,.5,A([[1024,245,179,1.1,1.1,.8],[600,100,200,1,1,1.3]]))),rt.push(w("water","slow",3,1.5,A([[1024,100,200,1.5,1.5,1],[600,100,200,1.5,1.5,1]]))),rt.push(w("wall","wall",0,0,A([[1024,50,75,1.5,1.5,1],[600,0,50,1.5,1.5,1]]))),function(e){for(var t=1;t<e+1;t++){var n=t/2,r=7;2*n>r&&(r=2*n),it.push({level:t,size:r,speed:.5*n,health:5*n,fullHealth:5*n,targetX:null,targetY:null,path:null,x:null,y:null,pixelX:null,pixelY:null,pathIndex:0,color:"rgb(0,0,0)",red:0,green:0,blue:0})}}(14),function(e){for(var t=1;t<e+1;t++){for(var n=[],r=t;r>0;r--)for(var i=0;i<2*r+15;i++){var a=o(it[t]);n.push(a)}nt.push(n)}}(13),qe=nt[0].length}function m(){b(),Xe.getElementById("gameOver").classList.add("show")}function b(){selectedStructure=null,Mt=0,ge(),Mt=0,r(Xe.querySelectorAll(".timeLasted"),(function(){this.textContent=c(We/60)})),r(Xe.querySelectorAll(".towersBuilt"),(function(){this.textContent=De})),r(Xe.querySelectorAll(".towersUpgraded"),(function(){this.textContent=Ne})),r(Xe.querySelectorAll(".towersSold"),(function(){this.textContent=je})),r(Xe.querySelectorAll(".baseRepaired"),(function(){this.textContent=Ue})),r(Xe.querySelectorAll(".wavesCompleted"),(function(){this.textContent=Le-Ge})),r(Xe.querySelectorAll(".moneySpent"),(function(){this.textContent=$e})),r(Xe.querySelectorAll(".tryAgain"),(function(){this.onclick=function(){e.location.reload()}}))}function w(e,t,r,o,l){var u=[];a(32,32);for(var s=0;s<3;s++){var f=n(l[0].fromColor,l[0].toColor);Fe.fillStyle=i(c(f/l[0].redFactor),c(f/l[0].greenFactor),c(f/l[0].blueFactor)),Fe.fillRect(0,0,ze,ze);for(var h=0;h<l[mt];h++)k(l[h]);var d=new Image;d[Yt]=Se[Ct](),u[kt](d),a(Pe*ze,Ie*ze)}var p=Ee;return Ee++,Se[ct]=Pe*ze,Se[ft]=Ie*ze,{name:e,is:"terrain",type:t,x:0,y:0,image:u,images:u[mt],priority:r,id:p,speed:o}}function k(e){var t,r,a=0,o=0;for(t=0;t<e.pixels;t++)a=n(0,ze-1),o=n(0,ze-1),r=n(e.fromColor,e.toColor),Fe.fillStyle=i(c(r/e.redFactor),c(r/e.greenFactor),c(r/e.blueFactor)),Fe.fillRect(a,o,1,1)}function A(e){for(var t=[],n=0;n<e.length;n++)t.push({pixels:e[n][0],fromColor:e[n][1],toColor:e[n][2],redFactor:e[n][3],greenFactor:e[n][4],blueFactor:e[n][5]});return t}function C(e,t,r){return e[t][n(0,e.images-1)]}function S(e,t,n){return n[0]}function F(e,t,n){return n[1]}function X(e){re(e);d();var t=o(rt[n(0,1)],["image","x","y"],[C,S,F],[Me.x,Me.y]);Ze[Me.x][Me.y]=t,at.length&&M(at)}function Y(e){re(e);d();var t=o(rt[2],["image","x","y"],[C,S,F],[Me.x,Me.y]);Ze[Me.x][Me.y]=t,at.length&&M(at)}function T(e){re(e);d();var t=o(rt[3],["image","x","y"],[C,S,F],[Me.x,Me.y]);Ze[Me.x][Me.y]=t,at.length&&M(at)}function P(e){re(e);d();var t=o(rt[4],["image","x","y"],[C,S,F],[Me.x,Me.y]);Ze[Me.x][Me.y]=t,at.length&&M(at)}function I(e,n){for(var r=[],i=0;i<Pe;i++){r[i]=r[i]||[];for(var a=0;a<Ie;a++){var l=o(rt[Ze[i][a].id],["image","x","y"],[C,S,F],[i,a]);et[i][a]&&"base"!==et[i][a][st].toLowerCase()&&(l.speed=0,"trap"===et[i][a].type&&(l.speed=.5)),r[i][a]=l}}return e!==t&&n!==t&&(r[e][n]=o(rt[r[e][n].id],["image","x","y"],[C,S,F],[e,n]),r[e][n].speed=0),r}function z(){if(nt[0]&&Ye){var e=nt[0].splice(0,1)[0];if(e){var t;do{do{var r=n(0,3),i=0,a=0;0===r||2===r?(i=n(0,Pe-1),2===r&&(a=Pe-1)):1!==r&&3!==r||(a=n(0,Ie-1),1===r&&(i=Ie-1));var o=I()}while(0===o[i][a].speed);e.x=i,e.y=a,e.pixelX=h(i,e.size),e.pixelY=h(a,e.size),t=R([e],o)}while(!t.length);e.path=t,e.targetX=t[0].x,e.targetY=t[0].y,e.pathIndex=0,at.push(e)}}}function E(e,t,n){var r=e.pixelX,a=e.pixelY,o=e.size/2;xe(f(e.health/e.fullHealth*e.size)+1,60,[2,7],[-2,2,-2,2],[r,a-o,r+o,a+o],[i(e.red,e.green,e.blue),i(l(e.red),l(e.green),l(e.blue))]),n||de(10*e.fullHealth/Le),at.splice(t,1)}function R(e,t){if(Ye){var n,i,a,o=[];return r(e,(function(e){i=this,a=t||I(),n=Rt.search(a,a[i.x][i.y],a[Ye.x][Ye.y]),o[kt](!!n.length)})),!(o.indexOf(!1)>-1)&&n}}function M(e){r(e,(function(e){var t=this,n=R([t]);t.path=n,t.pathIndex=0,t.targetX=n[0].x,t.targetY=n[0].y}))}function L(){for(var e=0;e<nt[0].length;e++)nt[1].push(nt[0][e]);Be=!0}function q(e,t,n,r,i,a,o){var l=H(t,a,o);return{is:"tower",name:e,weapon:t,width:l.width,height:l.height,depth:l.depth,path:l.path,colors:l.colors,image:B(l),x:l.x,y:l.y,level:1,type:n,cost:r,health:i,fullHealth:i}}function H(e,t,r){var i="rectangle";return"none"!==e&&(i="triangle"),{x:0,y:0,width:n(t[0][0],t[0][1]),height:n(t[1][0],t[1][1]),depth:n(t[2][0],t[2][1]),colors:r,path:i}}function B(e){var t=Se[ct],n=Se[ft];a(e.width,e.height+e.depth),Et[e.path](e);var r=new Image;return r[Yt]=Se[Ct](),a(t,n),r}function _(e,t,n,r,i,a){Fe.beginPath(),Fe.rect(e,t,n,r),Fe.fillStyle=i,Fe.fill(),Fe.closePath()}function O(e,t,n,r,i,a,o){Fe.beginPath(),Fe.moveTo(e,t),Fe.lineTo(i,a),Fe.lineTo(n,r),Fe.closePath(),Fe.fillStyle=o,Fe.fill(),Fe.closePath()}function W(){if(null!==Ye)return Ye;if(null===Ye){var e=function(){for(var e=0;e<et[mt];e++)for(var t=0;t<et[e][mt];t++)if("base"===et[e][t][st])return{x:e,y:t};return!1}();if(e)return Ye=et[e.x][e.y]}return!1}function D(e,t){for(var n=et[e][t],r=h(t,ze),a=r-n.height/2,o=r+n.height,l=h(e,ze),u=l+zt-n.width/2,s=l+n.width,c=[],f=0;f<n.colors.length;f++){var d=n.colors[f];c.push(i(d.red,d.green,d.blue))}xe(20,50,[2,7],[-2,2,-2,2],[u,a,s,o],c),et[e][t]=0}function N(e,t){je++;var n=et[e][t];de(n.cost+n.cost*(n.level-1)*2*.25),D(e,t)}function j(e,t,n){return o(ut[e.weapon])}function U(e,t){if(G()){Ne++;var n=et[e][t];pe($(n)),n.level++,function(e){if(e.level!==e.weapon.level){if("spread"===e.weapon.name||"gatling"===e.weapon.name||"explode"===e.weapon.name)var t=function(t){return t+e.level};else t=function(e){return e};var n=function(e){return e};e.weapon=Ce(e.weapon,{amount:t,range:function(t){return t+.5*e.level},life:function(t){return t+10*e.level},maxLife:function(t){return t+10*e.level},damage:function(t){return t+e.level},delay:function(t){return t-e.level>-1?t-e.level:0},speed:n})}}(n)}}function G(){return!!(He&&Mt>=$(He))}function $(e){return e.cost*e.level*2}function J(e){return 5*(e.fullHealth-e.health)}function V(){return!!K()}function K(){return Re!==St&&p(tt,st,Re)[0]}function Q(e){if(JSON.stringify(Me)!==_e||e){if(_e=JSON.stringify(Me),Xe.body.style.cursor="default",0!==u(et))return Xe.body.style.cursor="pointer",Oe=null,St;if(!V())return Oe=!0,!0;if(-1===function(e){for(var t=[],n=0;n<e.length;n++)for(var r=0;r<e[n].length;r++)0!==n&&n!==e.length-1&&0!==r&&r!==e[n].length-1||(0!==e[n][r].speed&&Ye?Rt.search(e,e[n][r],e[Ye.x][Ye.y]).length&&t.push(!0):t.push(!1));return t}(t=I(Me.x,Me.y)).indexOf(!0))return Oe=!1,!1;if(at[mt]){var t=I(Me.x,Me.y);if(!R(at,t))return Oe=!1,!1}return"terrain"===K().is?(Oe=!0,!0):"trap"===K().type?"fast"===u(Ze).type||"slow"===u(Ze).type?(Oe=!0,!0):(Oe=!1,!1):u(Ze).type===Xt?(Oe=!0,!0):(Oe=!1,!1)}return Oe}function Z(){Xe[vt](Ft).children[mt]>0&&(Xe[vt](Ft)[yt]="");for(var e=[],t=1;t<tt[mt];t++){var n=tt[t],r=ht+">"+n[st]+gt,i=ht+" class='cost'>$"+n.cost+gt,a="<img src='"+n.image.src+"'>",o=dt+" data-name='"+n.name+"' class='container' title='"+n.type+": "+n[st]+" ($"+n.cost+")'>"+a+r+i+pt;e.push(""+o)}Xe[vt](Ft)[yt]=e.join(""),function(){for(var e=Xe[xt](".container"),t=0;t<e[mt];t++)ce(e[t],"click",ie)}()}function ee(e){this.content=[],this.scoreFunction=e}function te(){a(Pe*ze,Ie*ze),function(){var e,t,n,r;for(e=0;e<Ze[mt];e++)for(t=0;t<Ze[e][mt];t++)for(n=0;n<Je[mt];n++)Je[n](Ze[e][t],et[e][t]);for(e=0;e<Ze[mt];e++)for(t=0;t<Ze[e][mt];t++)for(n=0;n<Ve[mt];n++)Ve[n](Ze[e][t],et[e][t]);for(e=0;e<Ze[mt];e++)for(t=0;t<Ze[e][mt];t++)for(n=0;n<Ke[mt];n++)Ke[n](Ze[e][t],et[e][t]);for(r=0;r<Qe[mt];r++)Qe[r]()}(),requestAnimationFrame(te)}function ne(){Xe[vt]("loading")[At].add("hidden"),te()}function re(e){e.preventDefault()}function ie(e){re(e);!this[At].contains("expensive")&&!V()&&(He=null,Re=this.getAttribute("data-name"),pe(p(tt,st,Re)[0].cost))}function ae(e){re(e),(Ye.x!==Me.x||Ye.y!==Me.y)&&N(He.x,He.y),He=null}function oe(e){re(e),(Ye.x!==Me.x||Ye.y!==Me.y)&&U(He.x,He.y)}function le(e){re(e),(Ye.x!==Me.x||Ye.y!==Me.y)&&function(e,t){var n=et[e][t];Mt<J(n)?(n.health+=Mt/10,pe(Mt)):Mt>=J(n)&&(pe(J(n)),n.health=n.fullHealth),Ue++}(He.x,He.y)}function ue(e){if(re(e),He=null,V()&&Q())if(2===e.which)!function(){var e=K().cost;Re=null,de(e)}();else{De++;var t=o(K(),["x","y","weapon"],[S,F,j],[Me.x,Me.y]);et[Me.x][Me.y]=t,He=et[Me.x][Me.y],Re=null,ge(),at.length&&M(at)}null===Q()&&(2===e.which?(Ye.x!==Me.x||Ye.y!==Me.y)&&N(Me.x,Me.y):He=0===et[Me.x][Me.y]?null:et[Me.x][Me.y])}function se(e){Me.x=e.pageX-Se.offsetLeft,Me.y=e.pageY-Se.offsetTop,Me.x=g(Me.x,ze),Me.y=g(Me.y,ze)}function ce(e,t,n){fe(e,t,n),e.addEventListener(t,n,!0)}function fe(e,t,n){e.removeEventListener(t,n)}function he(e){var t=0;((65===e.keyCode||83===e.keyCode||68===e.keyCode||70===e.keyCode)&&0===et[Me.x][Me.y]&&(65===e.keyCode&&Mt>=100&&(pe(100),X(e)),83===e.keyCode&&Mt>=100&&(pe(100),T(e)),68===e.keyCode&&Mt>=100&&(pe(100),Y(e)),70===e.keyCode&&Mt>=250&&(pe(250),P(e))),e.keyCode-48>=1&&e.keyCode-48<=5?t=e.keyCode-48:e.keyCode-96>=1&&e.keyCode-96<=5&&(t=e.keyCode-96),He&&(81===e.keyCode&&le(e),87===e.keyCode&&oe(e),69===e.keyCode&&ae(e)),t>0)&&(re(e),!Xe[xt](".container")[t-1][At].contains("expensive")&&!V()&&(He=null,Re=tt[t].name,pe(p(tt,st,Re)[0].cost)))}function de(e){Mt+=c(e),ge()}function pe(e){Mt-=c(e),$e+=e,ge()}function ge(){for(var e=Xe[xt](".container"),t=0;t<e[mt];t++){var n=e[t],r=tt[t+1];n[At].remove("expensive"),n[At].remove("building"),r.cost>Mt&&n[At].add("expensive"),K()&&n[At].add("building")}G()?Xe.getElementById("upgrade").setAttribute("disabled",!0):Xe.getElementById("upgrade").removeAttribute("disabled")}function ye(){Xe[vt]("upgrade").value="Upgrade Tower",Xe[vt]("repair").value="Repair Tower",Xe[vt]("upgrade").setAttribute("disabled",!0),Xe[vt]("sell").setAttribute("disabled",!0),Xe[vt]("repair").setAttribute("disabled",!0),fe(Xe[vt]("sell"),"click",ae),fe(Xe[vt]("upgrade"),"click",oe),fe(Xe[vt]("repair"),"click",le),Xe[vt]("normalTile").setAttribute("disabled",!0),Xe[vt]("slowTile").setAttribute("disabled",!0),Xe[vt]("fastTile").setAttribute("disabled",!0),Xe[vt]("wallTile").setAttribute("disabled",!0),fe(Xe[vt]("normalTile"),"click",X),fe(Xe[vt]("slowTile"),"click",T),fe(Xe[vt]("fastTile"),"click",Y),fe(Xe[vt]("wallTile"),"click",P)}function ve(e,t,r,i,a,o,l,u,s,c,f,h){var d=a/3,p=ze/60*n(a+d,a-d),g=n(0,h.length-1);return{x:n(e,r),y:n(t,i),w:n(o,l),h:n(o,l),dx:y(u,s),dy:y(c,f),life:p,lifespan:p,color:h[g]}}function xe(e,t,n,r,i,a){for(var o=0;o<e;o++)ot.push(ve(i[0],i[1],i[2],i[3],t,n[0],n[1],r[0],r[1],r[2],r[3],a))}function me(e,t){return e.x-t.x+(e.y-t.y)}function be(e){if(e[0]){for(var t=e[0],n=me(Ye,e[0]),r=1;r<e.length;r++)e[r]&&me(Ye,e[r])<n&&(t=e[r],n=me(Ye,e[r]));return t}return!1}function we(e,t,n,r,i,a){var o=e-r,l=t-i,u=n+a;return o*o+l*l<=u*u}function ke(e){for(var t=0;t<at.length;t++){var n=at[t];if(we(n.pixelX,n.pixelY,n.size/2,e.x,e.y,e.radius))return n}return!1}function Ae(e,t,n,r,i,a,o,l,u,s){ut[e]={name:e,radius:l,amount:t,directionFunction:s,x:null,y:null,dx:null,dy:null,level:1,red:u.red,green:u.green,blue:u.blue,alpha:1,life:o,maxLife:o,speed:n,targetX:null,targetY:null,range:a,delay:i,timer:0,damage:r||1}}function Ce(e,n){for(var r in n)e[r]!==t&&("function"==typeof n[r]?e[r]=n[r](ut[e.name][r]):e[r]=n[r]);return e}var Se,Fe,Xe=e.document,Ye=null,Te=0,Pe=26,Ie=26,ze=32,Ee=0,Re=null,Me={x:0,y:0},Le=1,qe=0,He=null,Be=!1,_e="",Oe=!0,We=0,De=0,Ne=0,je=0,Ue=0,Ge=0,$e=0,Je=[],Ve=[],Ke=[],Qe=[],Ze=[],et=[],tt=[],nt=[],rt=[],it=(tt=[],[]),at=[],ot=[],lt=[],ut={},st="name",ct="width",ft="height",ht="<span",dt="<div",pt="</div>",gt="</span>",yt="innerHTML",vt="getElementById",xt="querySelectorAll",mt="length",bt="floor",wt="Math",kt="push",At="classList",Ct="toDataURL",St=null,Ft="towers",Xt="path",Yt="src",Tt="cost",Pt="speed",It=e,zt=ze/2;It.addEventListener("DOMContentLoaded",(function(){x(),Z(),function(e,t){for(var r=0;r<e;r++){Ze[r]=Ze[r]||[],et[r]=et[r]||[];for(var i=0;i<t;i++){var a=d(),l=o(rt[a],["image","x","y"],[C,S,F],[r,i]);Ze[r][i]=l,et[r][i]=0}}(Ye=o(tt[0])).x=f(n(e/2-1,t/2+1)),Ye.y=f(n(e/2-1,t/2+1)),et[Ye.x][Ye.y]=Ye}(Pe,Ie),de(500),ce(Se,"mousemove",se),ce(Se,"mousedown",ue),ce(Se,"contextmenu",re),ce(Xe.getElementById("startGame"),"click",ne),ce(Xe.getElementById("nextWave"),"click",L),ce(Xe.getElementById("nextWave"),"click",L),Xe[vt]("loadingText")[At].add("hidden"),Xe[vt]("message")[At].remove("hidden"),ce(Xe,"keydown",he)}));var Et={triangle:function(e){var t=e.x,n=e.y,r=e.depth,a=e.width,o=e.height,l=a/2,u=e.colors;O(l+t,n,t,n+o,t+l,n+o+r,i(u[0].red,u[0].green,u[0].blue)),O(l+t-1,n,l+t-1,n+o+r,t+a,n+o,i(u[1].red,u[1].green,u[1].blue))},rectangle:function(e){var t=e.colors;_(e.x,e.y+e.depth/2,e.width,e.height,i(t[0].red,t[0].green,t[0].blue)),_(e.x,e.y,e.width,e.depth,i(t[1].red,t[1].green,t[1].blue))}},Rt={init:function(e){for(var t=0,n=e[mt];t<n;t++)for(var r=0,i=e[t][mt];r<i;r++){var a=e[t][r];a.f=0,a.g=0,a.h=0,a[Tt]=a[Pt],a.visited=!1,a.closed=!1,a.parent=St}},heap:function(){return new ee((function(e){return e.f}))},search:function(e,t,n){Rt.init(e),heuristic=Rt.manhattan;var r=Rt.heap();for(r[kt](t);r.size()>0;){var i=r.pop();if(i===n){for(var a=i,o=[];a.parent;)o[kt](a),a=a.parent;return o.reverse()}i.closed=!0;for(var l=Rt.neighbors(e,i),u=0,s=l[mt];u<s;u++){var c=l[u];if(!c.closed&&0!==c[Pt]){var f=i.g+c[Tt],h=c.visited;(!h||f<c.g)&&(c.visited=!0,c.parent=i,c.h=c.h||heuristic(c.x,c.y,n.x,n.y),c.g=f,c.f=c.g+c.h,h?r.rescoreElement(c):r[kt](c))}}}return[]},manhattan:function(e,t,n,r){return It[wt].abs(n-e)+It[wt].abs(r-t)},neighbors:function(e,t){var n=[],r=t.x,i=t.y;return e[r-1]&&e[r-1][i]&&n[kt](e[r-1][i]),e[r+1]&&e[r+1][i]&&n[kt](e[r+1][i]),e[r]&&e[r][i-1]&&n[kt](e[r][i-1]),e[r]&&e[r][i+1]&&n[kt](e[r][i+1]),n}};ee.prototype={push:function(e){this.content[kt](e),this.sinkDown(this.content[mt]-1)},pop:function(){var e=this.content[0],t=this.content.pop();return this.content[mt]>0&&(this.content[0]=t,this.bubbleUp(0)),e},size:function(){return this.content[mt]},rescoreElement:function(e){this.sinkDown(this.content.indexOf(e))},sinkDown:function(e){for(var t=this.content[e];e>0;){var n=(e+1>>1)-1,r=this.content[n];if(!(this.scoreFunction(t)<this.scoreFunction(r)))break;this.content[n]=t,this.content[e]=r,e=n}},bubbleUp:function(e){for(var t=this.content[mt],n=this.content[e],r=this.scoreFunction(n);;){var i=e+1<<1,a=i-1,o=St;if(a<t){var l=this.content[a],u=this.scoreFunction(l);u<r&&(o=a)}if(i<t){var s=this.content[i];this.scoreFunction(s)<(o===St?r:u)&&(o=i)}if(o===St)break;this.content[e]=this.content[o],this.content[o]=n,e=o}}};var Mt=0;(function(){for(var e=0,t=["ms","moz","webkit","o"],n=0;n<t[mt]&&!It.requestAnimationFrame;++n)It.requestAnimationFrame=It[t[n]+"RequestAnimationFrame"],It.cancelAnimationFrame=It[t[n]+"CancelAnimationFrame"]||It[t[n]+"CancelRequestAnimationFrame"];It.requestAnimationFrame||(It.requestAnimationFrame=function(t,n){var r=(new Date).getTime(),i=It[wt].max(0,16-(r-e)),a=It.setTimeout((function(){t(r+i)}),i);return e=r+i,a}),It.cancelAnimationFrame||(It.cancelAnimationFrame=function(e){clearTimeout(e)})})(),void 0!==Xe&&!("classList"in Xe.createElement("a"))&&function(e){"use strict";var t="classList",n="prototype",r=(e.HTMLElement||e.Element)[n],i=Object,a=String[n].trim||function(){return this.replace(/^\s+|\s+$/g,"")},o=Array[n].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1},l=function(e,t){this.name=e,this.code=DOMException[e],this.message=t},u=function(e,t){if(""===t)throw new l("SYNTAX_ERR","An invalid or illegal string was specified");if(/\s/.test(t))throw new l("INVALID_CHARACTER_ERR","String contains an invalid character");return o.call(e,t)},s=function(e){for(var t=a.call(e.className),n=t?t.split(/\s+/):[],r=0,i=n.length;r<i;r++)this.push(n[r]);this._updateClassName=function(){e.className=this.toString()}},c=s[n]=[],f=function(){return new s(this)};if(l[n]=Error[n],c.item=function(e){return this[e]||null},c.contains=function(e){return-1!==u(this,e+="")},c.add=function(e){-1===u(this,e+="")&&(this.push(e),this._updateClassName())},c.remove=function(e){var t=u(this,e+="");-1!==t&&(this.splice(t,1),this._updateClassName())},c.toggle=function(e){-1===u(this,e+="")?this.add(e):this.remove(e)},c.toString=function(){return this.join(" ")},i.defineProperty){var h={get:f,enumerable:!0,configurable:!0};try{i.defineProperty(r,t,h)}catch(e){-2146823252===e.number&&(h.enumerable=!1,i.defineProperty(r,t,h))}}else i[n].__defineGetter__&&r.__defineGetter__(t,f)}(self)}(window)</script>