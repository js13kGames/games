<!doctype html><html><head><meta name=viewport content="width=device-width,initial-scale=1.0"><title>Projection</title><script src=/2019/webxr/babylon.js></script><style>body,html{overflow:hidden;margin:0;padding:0;background:#201d33;font-family:sans-serif}#c,body,html{width:100%;height:100%}#c{touch-action:none}#level-selection{position:absolute;left:20px;top:20px;display:flex;flex-wrap:wrap}.level{width:40px;height:40px;margin:0 10px 10px 0;color:#fff;background:rgba(32,29,51,.7);border:2px solid;padding:0;outline:none;font-size:20px;font-weight:700;display:flex;align-items:center;justify-content:center}.level-selected{color:#ff7e5e}.babylonVRicon{background-color:rgba(32,29,51,.7)!important}</style></head><body> <canvas id="c"></canvas> <div id="level-selection"></div><script>!function(){"use strict";const e=5,t=document.getElementById("c"),n=new BABYLON.Engine(t,!0),a=new BABYLON.Scene(n);a.clearColor=BABYLON.Color4.FromHexString("#201d33ff");const o=(e/2+2)*Math.sqrt(3),i=new BABYLON.ArcRotateCamera("camera",Math.PI/-4,Math.PI/3,3*o,new BABYLON.Vector3(0,e/2,0),a);i.panningSensibility=0,i.lowerBetaLimit=Math.PI/9,i.upperBetaLimit=Math.PI/2,i.lowerRadiusLimit=o,i.upperRadiusLimit=5*o,i.attachControl(t,!0,!1);const r=a.createDefaultVRExperience({createDeviceOrientationCamera:!1});r.webVRCamera.deviceScaleFactor=2,r.onAfterEnteringVRObservable.add(()=>{r.teleportCamera(new BABYLON.Vector3(0,0,e/-2-3))});const s=new BABYLON.DefaultRenderingPipeline("default",!0,a,[i,r.webVRCamera,r.vrDeviceOrientationCamera]);s.imageProcessingEnabled=!1,s.fxaaEnabled=!0,s.bloomEnabled=!0,s.bloomThreshold=.25,s.bloomWeight=.7;const l=(()=>{const e="groundPlane",t=new BABYLON.DynamicTexture(e,{width:256,height:256},a,!1),n=t.getContext(),o=n.createRadialGradient(128,128,0,128,128,128);o.addColorStop(0,"#fff"),o.addColorStop(1,"transparent"),n.fillStyle=o,n.fillRect(0,0,256,256),t.update();const i=new BABYLON.StandardMaterial(e,a);i.emissiveColor=BABYLON.Color3.White(),i.opacityTexture=t;const r=BABYLON.Mesh.CreatePlane(e,60,a);return r.rotate(BABYLON.Axis.X,Math.PI/2),r.position.y-=.1,r.material=i,r.visibility=.05,r.isPickable=!1,r.setEnabled(!1),r})(),c=e=>{l.setEnabled(e)};r.onEnteringVRObservable.add(()=>c(!0)),r.onExitingVRObservable.add(()=>c(!1)),n.runRenderLoop(()=>{a.render()}),window.addEventListener("resize",()=>{n.resize()});const d=(e,t)=>Array.from({length:e},(e,n)=>t(n)),B=t=>new BABYLON.Vector3(t/(e*e)|0,(t/e|0)%e,t%e),A=t=>t.x*e*e+t.y*e+t.z,m=e=>{for(let t=e.length-1;t>0;t--){const n=Math.random()*(t+1)|0,a=e[t];e[t]=e[n],e[n]=a}return e},O=(t,n)=>t.map((t,a)=>t?A(((t,n)=>new BABYLON.Vector3(0,t.y,[t.z,t.x,e-1-t.z,e-1-t.x][n]))(B(a),n)):-1).filter(e=>-1!==e),L=(e,t,n)=>e<t?Math.min(e+n,t):Math.max(e-n,t),N=e=>new Promise(t=>setTimeout(t,e)),h=["..0....0....0...00....0.._.000....0...00....0..000.","..0...0.0....0....0..111._.00.....0..000..0.....00.","0.0.00.0.0101.40.0..0.0.0_0.0.00.0.0000.00.0..0.0.0","000000.1.00.0.00.1.000000_.000..1.0...0...0.1..000.",".000..0.0.000000.0.000000_.0.0.000000.0.000000.0.0.","....0...00..000.000000000_00000.0000..000...00....0","2...2.1.1...1...1.1.2...2_11.111...1..1..1...111.11",".0..000000.0..0000..0.000_.00.000...0..000000.....0","..0..0000.0.0000000...0.._.000..0.0.00000.000...0..","...00.000.00....000....00_.000....0..000..0....000.","0.1110...10..000...10.111_.0.1..11...0....11...0.1.","..0....0....0...00....0.._.000....0..000..0.0..000.","1111112221123211222111111_1111112221123211222111111"];function p(t){return u(h[t])||u((n=m(d(e**3,e=>e<13)),d(2,t=>{const a=O(n,t);return d(e*e,e=>a.includes(e)?"0":".").join("")}).join("_")));var n}function u(t){if(t&&t.length===e**2*2+1)return t.split("_").map(e=>e.split("").map(e=>isNaN(Number(e))?-1:Number(e)))}const Y=document.getElementById("level-selection");let f=0|localStorage.getItem("projection.level");const b=()=>M(f+1);let g=!1;const w={},M=e=>{(f!==e||e>h.length-1)&&w.onLevelChange&&(f=Math.min(e,h.length),localStorage.setItem("projection.level",`${f}`),w.onLevelChange()),g=!1,v()};a.onPointerObservable.add(e=>{"pointerdown"===e.event.type&&(g=!1,v())});const v=()=>{Y.innerHTML="",g?d(h.length+1,e=>{x(e,e===f,()=>M(e))}):x(f,!1,()=>{g=!0,v()})},x=(e,t,n)=>{const a=document.createElement("button");a.textContent=e<h.length?`${e+1}`:"?",a.className=`level${t?" level-selected":""}`,a.addEventListener("click",n),Y.appendChild(a)};function C(e,t,n){const o=new BABYLON.DynamicTexture(`square ${e} ${t} ${n||""}`,{width:256,height:256},a,!1),i=o.getContext();return i.fillStyle=t,i.fillRect(0,0,256,256),i.fillStyle=e,i.clearRect(25,25,206,206),i.fillRect(25,25,206,206),n&&(i.fillStyle=t,i.font="bold 200px sans-serif",i.textAlign="center",i.textBaseline="middle",i.fillText(n,128,143)),o.update(),o}v();const y=(e,t,n)=>{const o=new BABYLON.StandardMaterial(`cube ${e} ${t} ${n||""}`,a);return o.emissiveTexture=C(e,t,n),o},P="#2f2666",E="#5342b3",S=[P,E].map(e=>y(e,"#a8a5b6")),I=[P,E].map(t=>d(2*e+1,n=>y(t,"#ff7e5e",n?`${n-e}`:void 0))),V=new BABYLON.StandardMaterial("cubeHover",a);V.emissiveColor=BABYLON.Color3.FromHexString("#ffcf3d"),V.opacityTexture=C("rgba(255,255,255,0.25)","#fff");let T=p(f);const R=d(e**3,()=>!1),_=new BABYLON.Vector3(.5-e/2,.5,.5-e/2),$=new Map,z=new BABYLON.TransformNode("cubeBottom");d(e*e,e=>{const t=B(e),n=new BABYLON.Vector3(t.y,-1,t.z),o=BABYLON.Mesh.CreatePlane(`${e}`,1,a);o.position=n.add(new BABYLON.Vector3(0,.501,0)).add(_),o.rotate(BABYLON.Axis.X,Math.PI/2),o.material=S[0],o.parent=z,$.set(o,{position:n,side:new BABYLON.Vector3(0,1,0)})});const D=[[new BABYLON.Vector3(0,1,0),BABYLON.Axis.X,Math.PI/2],[new BABYLON.Vector3(0,0,1),BABYLON.Axis.Y,Math.PI],[new BABYLON.Vector3(1,0,0),BABYLON.Axis.Y,Math.PI/-2],[new BABYLON.Vector3(0,0,-1),BABYLON.Axis.Y,0],[new BABYLON.Vector3(-1,0,0),BABYLON.Axis.Y,Math.PI/2],[new BABYLON.Vector3(0,-1,0),BABYLON.Axis.X,Math.PI/-2]],F=new BABYLON.TransformNode("cubes"),k=BABYLON.Mesh.CreatePlane("cubePlane",1,a);k.material=S[1],k.setEnabled(!1);const H=R.map((e,t)=>{const n=new BABYLON.TransformNode(`${t}`);return n.position=B(t).add(_),n.scaling.setAll(0),n.parent=F,D.forEach((e,a)=>{const o=k.createInstance(`${a}`);o.position=e[0].scale(.5),o.rotate(e[1],e[2]),o.parent=n,$.set(o,{position:B(t),side:e[0]})}),n}),X=BABYLON.Mesh.CreatePlane("hover",1,a);X.material=V,X.position.z=-.001,X.isPickable=!1;const j=new BABYLON.Animation("","visibility",30,BABYLON.Animation.ANIMATIONTYPE_FLOAT,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);j.setKeys([{frame:0,value:1},{frame:30,value:.3},{frame:60,value:1}]),X.animations.push(j),a.beginAnimation(X,0,60,!0);let G=!0;const q=((t,n)=>{a.onPointerObservable.add(e=>{e.type===BABYLON.PointerEventTypes.POINTERTAP&&n(2!==e.event.button)}),r.enableInteractions();const o=BABYLON.Mesh.CreateGround("teleportationMesh",e+12,e+12,1,a);let i;o.setEnabled(!1),r.enableTeleportation({floorMeshName:o.name}),r.onNewMeshSelected.add(e=>{i=e}),r.onSelectedMeshUnselected.add(()=>{i=void 0}),r.onExitingVRObservable.add(()=>{i=void 0}),r.onControllerMeshLoaded.add(e=>{e.onMainButtonStateChangedObservable.add(e=>{e.pressed&&n(!0)}),e.onSecondaryButtonStateChangedObservable.add(e=>{e.pressed&&n(!1)})});return()=>{let e;if(r.isInVRMode)e=i;else{const t=a.pick(a.pointerX,a.pointerY);t&&(e=t.pickedMesh)}if(e&&t(e))return e}})(e=>$.has(e),t=>{const n=q();if(!n||!G)return;const a=$.get(n),o=t?a.position.add(a.side):a.position;if(!(t=>[t.x,t.y,t.z].every(t=>t>=0&&t<e))(o))return;const i=A(o);if(t&&!R[i]){const e=H[i];e.scaling.setAll(0),e.position=a.position.add(a.side.multiplyByFloats(.5,.5,.5)).add(_)}R[i]=t,U()}),W=d(4,t=>{const n=new BABYLON.TransformNode(`side${t}`);return n.rotate(BABYLON.Axis.Y,Math.PI/2*t),d(e*e,e=>{const t=BABYLON.Mesh.CreatePlane(`${e}`,1,a);return t.position=B(e).add(_).add(new BABYLON.Vector3(-2.5)),t.rotate(BABYLON.Axis.Y,Math.PI/-2),t.isPickable=!1,t.parent=n,t})});function K(e,t,n){return BABYLON.Mesh.MergeMeshes(D.filter(e=>!e[0].y).map(o=>{const i=BABYLON.MeshBuilder.CreatePlane(e,{width:t,height:n},a);return i.position=o[0].scale(t/2),i.rotate(o[1],o[2]),i}))}{const t="groundEdge",n=new BABYLON.StandardMaterial(t,a);n.emissiveColor=BABYLON.Color3.FromHexString("#a8a5b6");const o=K(t,e,.1);o.position.y-=.05,o.material=n;const i="groundCube",r=64,s=new BABYLON.DynamicTexture(i,{width:r,height:r},a,!1),l=s.getContext(),c=l.createLinearGradient(0,0,0,r);c.addColorStop(0,"#fff"),c.addColorStop(1,"transparent"),l.fillStyle=c,l.fillRect(0,0,r,r),s.update();const d=new BABYLON.StandardMaterial(i,a);d.opacityTexture=s,d.emissiveColor=BABYLON.Color3.FromHexString(P);const B=K(i,e,e);B.position.y-=e/2+.1,B.material=d}async function U(){let t=!0;W.forEach((n,a)=>{const o=O(R,a),i=a<2?T[a]:d(e**2,t=>{const n=B(t);return T[a-2][A(new BABYLON.Vector3(0,n.y,e-1-n.z))]});n.forEach((n,a)=>{const r=o.filter(e=>e===a).length,s=i[a];t&&(t=-1===s?!r:0===s?!!r:s===r),n.material=-1===s?S[r?1:0]:I[r?1:0][s?s-r+e:0]})}),t&&(G=!1,await N(100),k.material=I[1][0],await N(500),k.material=S[1],G=!0,b())}U(),w.onLevelChange=()=>{T=p(f),R.fill(!1),U()},a.beforeRender=()=>{H.forEach((e,t)=>{const n=R[t]?1:0,o=.1*a.getAnimationRatio();e.scaling.setAll(L(e.scaling.x,n,o)),((e,t,n)=>{e.set(L(e.x,t.x,n),L(e.y,t.y,n),L(e.z,t.z,n))})(e.position,B(t).add(_),o/2),e.setEnabled(!!e.scaling.x)});const e=q();X.isVisible=!!e,e&&(X.parent=e)}}();</script></body></html>
