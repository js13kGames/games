<!doctype html><script src=/2017/webxr/aframe.js></script><script>const rand=t=>t[Math.floor(t.length*Math.random())],SIZE=64,OPACITY_AVAILABLE=[.2,.5,.8,1],RADIUS_AVAILABLE=[2,3,4,5,6,7,8,10,12,14,16,18,22,26,30,36,40],COLOR_PALETTE=[];for(let t=0;t<256;t+=50)for(let e=0;e<256;e+=50)for(let n=0;n<256;n+=50)COLOR_PALETTE.push([t,e,n]);const wall=new THREE.MeshPhongMaterial({color:16316664}),lat=new THREE.MeshPhongMaterial({color:13158600}),ceiling=new THREE.MeshBasicMaterial({color:8947848}),l=[SIZE,SIZE,RADIUS_AVAILABLE.length,COLOR_PALETTE.length,OPACITY_AVAILABLE.length].map((t=>Math.ceil(Math.log(t)/Math.LN2))),m=[0];l.forEach(((t,e)=>m[e+1]=m[e]+t));const n_dot=l.reduce(((t,e)=>t+e),0),readNumber=(t,e,n)=>{let o=0;for(let r=t;r<e;r++){o+=+!!(n[Math.floor(r/8)]&1<<r%8)<<r-t}return o},arrayToDot=t=>({x:t[0],y:t[1],r:RADIUS_AVAILABLE[t[2]],color:COLOR_PALETTE[t[3]],opacity:OPACITY_AVAILABLE[t[4]]}),unpackADN=t=>{const e=[];let n=0;for(;n<8*t.length-n_dot;)e.push({x:(o=l.map((e=>{const o=n;return n+=e,readNumber(o,n,t)})))[0],y:o[1],r:RADIUS_AVAILABLE[o[2]],color:COLOR_PALETTE[o[3]],opacity:OPACITY_AVAILABLE[o[4]]});var o;return e},readPainting=t=>fetch(t).then((t=>t.text())).then((t=>unpackADN(new Uint8Array(t.split(",").map((t=>+t)))))),paintings=Array.from({length:30},(()=>Array.from({length:30},(()=>{return{x:64*Math.random(),y:64*Math.random(),r:30*Math.random(),color:(t=COLOR_PALETTE,t[Math.floor(t.length*Math.random())]),opacity:1};var t}))));let step=1;const texts=[[["Oups, you are lost in a museum"],[],["Find your way out!"],[],["First stop:"],['Find "La Joconde"']],[["Good!"],[],["Next:"],['Find "Starry nigth"'],["by Van Gogh"],["in the room to your"],["left"]],[["Great!"],[],['Find "Scream"'],["by Munch"],["in the room to your"],["right"]],[["OK!"],[],["Next:"],['"The Great Wave"'],["by Hokusai"],["in this room"]],[["Nice!"],[],["Next:"],['"La libertÃ©"'],["by Delacroix"],["in the next room"]],[["Nice!"],[],["it's 12h30"],["no more time"],["let's say you win"]]],worldMap="                                                                                      \n           ###########################                                                   \n           #                        ###########################                       \n           #                        #                         ##########                        \n           #   ##b#  ##5#   ##b#    #                         #        #                \n    #6#7#8##                            r      r      3       #####    #                    \n                                                                      #               \n           #                                                           #                \n           #                            4      r      r       ##########                        \n           #   ##t#  ##t#   ##t#    #                         #                        \n           #                        #                         #                        \n           #                        ######################  ###                            \n           ####################   ######                 #  #                             \n                 #                    ###################  ####                                             \n                 #                    ##   #       #       #                            \n                 #           #  #     ##   r       l       2                            \n                 #                         #       #       #                           \n                 # ###########   #######       #       #   #                                  \n                          ####   ####  #       l       l   #                            \n                          #         #  #       #       #   ######                            \n                          #         #  #       #       #        #                       \n                          r         l  #       l       l   #### #                           \n                          #         ####       #       #   #  # #                           \n                          #    1           #       #       #  # #                       \n                          #         ####   r       l       #  # #                            \n                          r         l  #   #       #       #  # #                          \n                          #         #  ################ ####### #                                          \n                          #         #                 #         #                      \n                          #### ######                 ###########                             \n                             #   #                                                     \n                             #   #                                                  ",getCell=t=>{switch(t){case"1":return[null,1,null,null];case"2":return[null,null,2,null];case"3":return[3,null,null,null];case"4":return[4,null,null,null];case"5":return[null,5,null,null];case"6":return[null,6,null,null];case"7":return[null,7,null,null];case"8":return[null,8,null,null];case"l":return[null,null,Math.floor(10*Math.random())+20,null];case"t":return[null,null,null,Math.floor(10*Math.random())+20];case"r":return[Math.floor(10*Math.random())+20,null,null,null];case"b":return[null,Math.floor(10*Math.random())+20,null,null];default:return[null,null,null,null]}},world={worldGrid:worldMap.split("\n").map((t=>t.split("").map((t=>" "===t?0:getCell(t))))),tim:{position:{x:30.5,y:31.5},direction:{x:0,y:1}},control:{direction:{x:0,y:0}}},around=[{x:0,y:1},{x:1,y:0},{x:0,y:-1},{x:-1,y:0},{x:1,y:1},{x:-1,y:1},{x:-1,y:-1},{x:1,y:-1}],isInside=(t,e,n)=>e>=0&&e<t.length&&n>=0&&n<t[0].length,getClosestWall=(t,e)=>{const n=Math.floor(t.x),o=Math.floor(t.y);return around.reduce(((r,l)=>{const a=n+l.x,i=o+l.y;if(!isInside(e,a,i)||e[a][i]){const e=0===l.x?0:l.x>0?1-t.x%1:t.x%1,n=0===l.y?0:l.y>0?1-t.y%1:t.y%1,o=Math.sqrt(e*e+n*n);return!r||r.d>o?{x:a,y:i,dir:l,d:o}:r}return r}),null)},tick=()=>{const{position:t,direction:e}=world.tim,n=world.control;t.x+=e.x*n.direction.y*.05,t.y+=e.y*n.direction.y*.05;const o=getClosestWall(t,world.worldGrid);if(o&&o.d<.2){const e=.2-o.d;t.x-=e*o.dir.x,t.y-=e*o.dir.y}};document.onkeydown=t=>32==t.which&&(world.control.direction.y=1),document.onkeyup=t=>32==t.which&&(world.control.direction.y=0),document.ontouchstart=t=>world.control.direction.y=1,document.ontouchend=t=>world.control.direction.y=0,AFRAME.registerComponent("tim",{init:function(){{const t=new THREE.BoxGeometry(.1,.1,.1),e=new THREE.MeshLambertMaterial({color:2200494}),n=new THREE.Mesh(t,e);this.el.object3D.add(n)}},tick:function(){const t=this.el.children[0].object3D.rotation.y;world.tim.direction.x=-Math.sin(t),world.tim.direction.y=-Math.cos(t),tick(),this.el.object3D.position.set(world.tim.position.x,.6,world.tim.position.y)}});const L=.28,K=100,planeGeom=new THREE.PlaneBufferGeometry(1,1),getU=(t,e,n)=>Math.max(0,Math.min(1,(n-(1-L)*(t-e)/t)/L)),getDisplacement=(t,e,n,o)=>{const r=(36*t+e*e*t*137+t*t*89)%37/37,l=Math.sin(.045*(1+r)*o)*n;return{x:t+(t-.5+(t<.5?-.4:.4))*n+.2*l,y:e+(e-.5)*n+.17*(Math.cos(.035*(1+r)*o)*n),z:n*(.6+.6*r)-.1+.17*l*(1+r)}},draw=(t,e,n,o,r,l)=>{const a=512;t.width=t.height=a;const i=t.getContext("2d");i.beginPath(),i.rect(0,0,a,a),i.fillStyle="#fff",i.fill(),n.forEach(((t,o)=>{const s=getU(n.length,o,r),c=getDisplacement(t.x/e,t.y/e,s,l),h=(t.r,t.r,c.z,c.z,c.z>t.r/e?0:Math.sqrt(t.r/e*t.r/e-c.z*c.z));i.beginPath(),i.arc(c.x*a,c.y*a,h*a,0,2*Math.PI),i.fillStyle="rgb("+t.color+")",i.globalAlpha=t.opacity,i.fill()})),r>.8&&o&&(i.globalAlpha=(r-.8)/.2,o.forEach(((t,e)=>{i.fillStyle="#333",i.font="50px Helvetica",i.fillText(t,50,60*e+100)})))},generatePainting=t=>{const e=new THREE.Object3D,n=paintings[t],o=texts[t];n.forEach(((t,n)=>{const o=new THREE.MeshBasicMaterial({});o.color.setRGB(...t.color.map((t=>t/256)));const r=new THREE.SphereBufferGeometry(Math.min(t.r/64,.5),Math.ceil(t.r/2)+2,Math.ceil(t.r/2)+2),l=new THREE.Mesh(r,o);e.add(l)}));const r=document.createElement("canvas"),l=new THREE.Texture(r);{l.needsUpdate=!0,l.wrapS=l.wrapT=THREE.RepeatWrapping,l.repeat.set(1,1);const t=new THREE.MeshBasicMaterial;t.map=l;const n=new THREE.Mesh(planeGeom,t);n.position.z=.02,e.add(n);const o=new THREE.Mesh(planeGeom,lat);o.position.z=.01,o.scale.set(1.1,1.1,1.1),e.add(o)}let a=-1;const i=(i,s)=>{t>step&&(i=0),t==step&&i>.9&&step++,(i>0||Math.abs(i-a)>.1||a>0&&0==i)&&(draw(r,64,n,o,a=i,s),l.needsUpdate=!0),n.forEach(((t,o)=>{const r=getU(n.length,o,i),l=getDisplacement(t.x/64,t.y/64,r,s);e.children[o].visible=r>0;const a=.3+.7*(1-r);e.children[o].scale.set(a,a,a*r),e.children[o].position.set(l.x-.5,-(l.y-.5),l.z)}))};return i(0,0),{object:e,update:i,t:0}},generatePaintings=t=>{const e=[],n=new THREE.Object3D;for(let o=0;o<t.length;o++)for(let r=0;r<t[0].length;r++)for(let l=0;t[o][r]&&l<4;l++)if(t[o][r][l]){const a=generatePainting(t[o][r][l]);e.push(a);const i=around[l],s=.6+.35*Math.random();a.object.scale.set(s,s,s),a.object.position.set(o+.5+.505*i.x,1,r+.5+.505*i.y),a.object.rotation.y=Math.PI/2*l,n.add(a.object)}let o=0;return{object:n,update:({position:t,direction:n})=>{o+=1,e.forEach(((e,r)=>{const l=t.x-e.object.position.x,a=t.y-e.object.position.z,i=Math.sqrt(l*l+a*a),s=Math.max(0,-(l*n.x+a*n.y)/i);e.t=i<3&&s>.88?Math.min(150,e.t+1):Math.max(.98*(e.t+1)-2,0),e.update(Math.max(0,(e.t-50)/K),o)}))}}},generateMazeObject=t=>{const e=new THREE.Object3D,n=t.length,o=t[0].length,r=new THREE.MeshLambertMaterial;{const t=document.createElement("canvas");t.width=16,t.height=1;const e=t.getContext("2d");for(let t=16;t--;){e.beginPath(),e.rect(t,0,1,1);const n=32+(0|8*Math.random()),o=22+(0|20*Math.random());e.fillStyle=`hsl(${n}, 55%, ${o}%)`,e.fill()}const n=new THREE.Texture(t,THREE.UVMapping,THREE.RepeatWrapping,THREE.NearestFilter,THREE.NearestFilter);n.needsUpdate=!0,n.repeat.set(10,1),r.map=n}{const t=new THREE.PlaneBufferGeometry(n,o),l=new THREE.Mesh(t,r);l.position.set(n/2,0,o/2),l.rotation.x=-Math.PI/2,l.receiveShadow=!0,e.add(l)}{const n=new THREE.BoxBufferGeometry(1,3.2,1),o=new THREE.BoxBufferGeometry(1.01,.2,1.01);for(let r=t.length;r--;)for(let l=t[0].length;l--;)if(t[r][l]){const t=new THREE.Mesh(n,wall);t.position.set(r+.5,.8,l+.5),t.castShadow=!0,t.receiveShadow=!1,e.add(t);const a=new THREE.Mesh(o,lat);a.position.set(r+.5,.05,l+.5),e.add(a)}}{const t=[new THREE.BoxBufferGeometry(n,3,1),new THREE.BoxBufferGeometry(n,3,1),new THREE.BoxBufferGeometry(1,3,o),new THREE.BoxBufferGeometry(1,3,o)].map((t=>new THREE.Mesh(t,wall)));t[0].position.set(n/2,1.5,o+.5),t[1].position.set(n/2,1.5,-.5),t[2].position.set(n+.5,1.5,o/2),t[3].position.set(-.5,1.5,o/2),e.add(...t)}{const n=new THREE.PlaneBufferGeometry(.06,o);for(let r=0;r<t.length;r+=3){const t=new THREE.Mesh(n,ceiling);t.rotation.x=Math.PI/2,t.position.set(r+.03,3.5,o/2),e.add(t)}}{const t=document.createElement("canvas");t.height=t.width=512;const n=t.getContext("2d");n.fillStyle="#fff",n.fillRect(0,0,512,512),texts[0].forEach(((t,e)=>{n.fillStyle="#333",n.font="30px Helvetica",n.fillText(t,50,40*e+100)}));const o=new THREE.Texture(t);o.needsUpdate=!0,o.wrapS=o.wrapT=THREE.RepeatWrapping,o.repeat.set(1,1);const r=new THREE.MeshBasicMaterial;r.map=o;const l=new THREE.Mesh(planeGeom,r);l.position.z=.01,l.scale.set(2,2,2);const a=new THREE.Object3D;a.position.set(30,1.2,30),a.rotation.y=0,a.add(l),e.add(a)}return e};AFRAME.registerComponent("museum",{init:function(){const t=this.el.object3D;t.add(generateMazeObject(world.worldGrid)),Promise.all("12345678".split("").map(((t,e)=>{return(n=t,fetch(n).then((t=>t.text())).then((t=>unpackADN(new Uint8Array(t.split(",").map((t=>+t))))))).then((t=>paintings[e+1]=t));var n}))).then((()=>{this.p=generatePaintings(world.worldGrid),t.add(this.p.object)}))},tick:function(){this.p&&this.p.update(world.tim)}}),window.onload=()=>{const{renderer:t}=document.getElementsByTagName("a-scene")[0]}</script><body><a-scene><a-entity museum></a-entity><a-entity tim><a-camera reverse-mouse-drag=false user-height=0 wasd-controls-enabled=false></a-camera></a-entity><a-sky color=#c8dbec></a-sky></a-scene>