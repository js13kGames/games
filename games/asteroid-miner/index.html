<meta name=viewport content=width=device-width,user-scalable=no><style>*{box-sizing:border-box}:root{color:#fff;font:1.5vmin monospace}a{color:inherit}button{background:none;border:1px solid #fff;color:#fff;font:inherit}.screen,canvas{image-rendering:pixelated;left:50%;max-height:49%;max-width:49%;position:fixed;top:50%;transform:translate(-50%,-50%)scale(2,2);transition:background 2s,opacity 2s}#main{text-align:center}#info{padding:2vmin}.margin{margin-top:10vmin}.smol{font-size:.5em}</style><body><script>(()=>{"use strict";const e=["backgroundObjects","objects","ground","decorative","particles"],t=Object.fromEntries(e.map(((e,t)=>[e,t]))),n=new Set;function o(e,o){n.add([t[e],o])}function i(e,t){return e+Math.random()*(t-e)}function r(e){return Math.floor(e/24)}function a(e,t){return`${e},${t}`}function s(e){return e.split(",").map((e=>+e))}let l=0;class c{x;y;constructor(e,t){this.x=e,this.y=t}add(e){return new c(this.x+e.x,this.y+e.y)}mul(e){return new c(this.x*e,this.y*e)}sub(e){return new c(this.x-e.x,this.y-e.y)}distance(e){return((this.x-e.x)**2+(this.y-e.y)**2)**.5}within(e,t,n,o){return this.x>=e&&this.x<e+n&&this.y>=t&&this.y<t+o}ensureWithin(e,t,n,o){return new c(Math.min(e+n,Math.max(e,this.x)),Math.min(t+o,Math.max(t,this.y)))}static zero=new c(0,0);static empty=new c(NaN,NaN)}const d=new Set,f=new Set;function u(e,t,n){if(n<=0)return;const o=a(t,n);d.has(o)||e.has(o)||e.add(o)}const h=p({name:"base",maxHealth:20,getState:()=>({}),upgrades:{armor:1},extra:{width:72,height:72},draw:(e,{x:t,y:n})=>{e.font="60px monospace",e.textAlign="center",e.textBaseline="middle",e.fillText("🗼",t+36,n+36+3)}}),m={"solar panel":p({name:"solar panel",maxHealth:2,getState:()=>({}),upgrades:{efficiency:1,armor:1},draw:(e,{x:t,y:n})=>{e.font="20px monospace",e.textAlign="center",e.textBaseline="middle",e.fillText("🌞",t+12,n+12+1)}}),battery:p({name:"battery",maxHealth:4,getState:()=>({energy:0}),upgrades:{storage:1,armor:1},draw:(e,{x:t,y:n})=>{e.font="20px monospace",e.textAlign="center",e.textBaseline="middle",e.fillText("🔋",t+12,n+12+1)}}),turret:p({name:"turret",maxHealth:8,getState:()=>({targets:[]}),upgrades:{count:1,range:1,power:1,armor:1},draw:(e,{x:t,y:n})=>{e.font="20px monospace",e.textAlign="center",e.textBaseline="middle",e.fillText("🔫",t+12,n+12+1)}}),"drill (free)":p({name:"drill (free)",maxHealth:1/0,getState:()=>({ticksLeft:120}),upgrades:{},extra:{addParticlesWhenDestructing:!1},draw:(e,{x:t,y:n})=>{e.font="20px monospace",e.textAlign="center",e.textBaseline="middle",e.fillText("⛏️",t+12,n+12+1)}})},y={base:h,...m};function g(e,{x:t,y:n},{width:o,height:i}){e.strokeStyle="#fff",e.setLineDash([5,5]),e.lineDashOffset=Math.floor(l/60*-20),e.strokeRect(t+.5,n+.5,o-1,i-1),e.setLineDash([])}function p({name:e,maxHealth:t,getState:n,upgrades:o,extra:i,draw:r}){const a={name:e,width:24,height:24,health:t,maxHealth:t,draw:r,...i};return{get:(e,t)=>{const i={mid:new c(24*e+a.width/2,24*(t+1)-a.height/2),armor:1/0,upgrade:function(e){const t=O();t.resources<100||3===i[e]||(t.resources-=100,i[e]=i[e]+1)},...o,...a,...n?.(e,t)};return i},...a}}const x=new Set;let w=0;function v(e,t,n,o=!1){const r=t**2*(o?.08:.04);for(let o=0;o<r;o+=1){const o=i(0,2*Math.PI),r=new c(Math.sin(o),Math.cos(o));x.add({mid:e.add(r.mul(Math.random()*t)),dMid:r.mul(1*Math.random()),life:60,color:n[Math.floor(Math.random()*n.length)]})}}function M(e,t,n){o("decorative",(o=>{o.lineWidth=2,o.strokeStyle=e,o.beginPath();for(const e of t()){const{value:t,mid:i,offsetY:r,width:a}=n(e);t<0||(o.moveTo(i.x-a/2,i.y+r),o.lineTo(i.x-a/2+a*t,i.y+r))}o.stroke(),o.lineWidth=1}))}const b=new Map,S=["#fc0","#fa0","#f80","#f60","#f40","#ff0"],k=new Set,T=new Set,R=new Set,E=new Set,L={energy:1,battery:0,resources:0};let P,$,H=-1,A=1;function B(){if(!$)return[];if("drill (free)"===$)return function(){const e=new Set;for(const t of d){const[n,o]=s(t);u(e,n-1,o),u(e,n+1,o),u(e,n,o-1),u(e,n,o+1)}return[...e].map((e=>new c(...s(e))))}().filter((e=>!b.has(a(e.x,e.y))&&!b.has(a(e.x,e.y-1))));const[e,t]=C(),n=[];for(let o=e;o<=t;o+=1)(o<-1||o>=2)&&!b.has(a(o,-1))&&n.push(new c(o,-1));return"battery"===$?[...n,...(1===d.size?[]:[...d].filter((e=>{const[t,n]=s(e);return!d.has(a(t,n+1))})).map((e=>new c(...s(e))))).filter((e=>!b.has(a(e.x,e.y))))]:n}function z(e,t,n){const o=n.within(24*t.x,24*t.y,24,24);e.strokeStyle=o?"#fff":"#fff8",e.beginPath(),e.arc(24*(t.x+.5),24*(t.y+.5),8,0,2*Math.PI),e.moveTo(24*(t.x+.3),24*(t.y+.5)),e.lineTo(24*(t.x+.7),24*(t.y+.5)),e.moveTo(24*(t.x+.5),24*(t.y+.3)),e.lineTo(24*(t.x+.5),24*(t.y+.7)),e.stroke()}function I({x:e,y:t}){const n=D(r(e),r(t));if(b.get(n)||B().some((e=>a(e.x,e.y)===n)))return n}function N(e){void 0===e?(P=void 0,$=void 0):b.has(e)?("drill (free)"!==b.get(e).name&&(P=e),$=void 0):$&&function(e,t){if("drill (free)"!==t){if(L.resources<50)return;L.resources-=50}const[n,o]=s(e);H=Math.min(n,H),A=Math.max(n,A);const i=m[t].get(n,o);b.set(e,i),"solar panel"===i.name?k.add(i):"battery"===i.name?T.add(i):"turret"===i.name?R.add(i):"drill (free)"===i.name&&(E.add(i),function(e){f.add(e)}(e))}(e,$)}function W(e,t){b.delete(e),"base"===t.name&&Re("end"),(t.addParticlesWhenDestructing??1)&&v(t.mid,t.height/2,S,!0),P===e&&(P=void 0),"solar panel"===t.name?k.delete(t):"battery"===t.name?T.delete(t):"turret"===t.name?R.delete(t):"drill (free)"===t.name&&(E.delete(t),function(e){f.delete(e),d.add(e)}(e),L.resources+=100)}function O(){return L}function Y(){return void 0!==P?b.get(P):void 0}function j(){return $}function C(){return[24*H-500,24*(A+1)-1+500]}function D(e,t){return e>=-1&&e<2&&t>-4&&t<=-1?a(-1,-1):a(e,t)}function V(e){return 1+Math.round(10*Math.log(e))/10}const F=Math.PI/6,X=new Set,q=["#eee","#ccc","#aaa","#888","#666","#444"];function G(e=Math.floor(i(1,5)),t=i(-F,F),n=i(.5,1.5)/e,o=new c(i(...C())+-1300*Math.tan(t),-1300)){const r={mass:e,radius:24*e/2,angle:t,speed:n,mid:o,dMid:new c(Math.sin(t),Math.cos(t)).mul(n),r:0,dr:Math.sign(Math.random()-.5)*i(.01,.04)/e,health:2**e,maxHealth:2**e,vertexOffsets:Q(e),computedVertices:[]};J(r),X.add(r)}function U(e){if(X.delete(e),v(e.mid,e.radius,q),1===e.mass)return;const t=e.angle;G(e.mass-1,t-Math.PI/12,e.speed,e.mid),G(e.mass-1,t+Math.PI/12,e.speed,e.mid)}function J(e){e.computedVertices=e.vertexOffsets.map(((t,n,{length:o})=>{const i=e.r+2*Math.PI*(n/o);return new c(e.mid.x+Math.sin(i)*t*e.radius,e.mid.y+Math.cos(i)*t*e.radius)}))}function K(e){const t=function(e){for(const t of e){const e=D(r(t.x),r(t.y)),n=b.get(e);if(n&&t.y<=0&&t.y>=-n.height)return n}}(e.computedVertices);if(t)return t.health-=function(e){const t=e.health/e.maxHealth;return e.mass**2*t+(e.mass-1)**2*(1-t)}(e)*(1-.25*(t.armor-1)),void U(e);e.computedVertices.some((({y:e})=>e>0))&&U(e)}function Q(e){const t=2*Math.round(e)+3,n=[];for(let e=0;e<t;e+=1)n.push(i(.5,1));return n}function Z(e,t,n){const o=[];for(const i of X){const r=i.mid.distance(e);if(r>n)continue;const a=o.findIndex((([e])=>r<e));a>=0?(o.splice(a,0,[r,i]),o.length>t&&o.pop()):o.length<t&&o.push([r,i])}return o.map((([,e])=>e))}function _(e,t,n=!1){const o=document.createElement("canvas");o.width=e,o.height=t;const i=o.getContext("2d");return i.imageSmoothingEnabled=n,[o,i]}const[ee,te]=_(500,800);ee.style.background="#000";const ne=[],oe=new c(0,0).distance(new c(250,800))+100,ie={build:ae(Object.values(m),50,((e,{left:t,active:n},{name:o,width:i,draw:r})=>{e.font="12px monospace",e.fillStyle=n?"#000":"#fff",e.textAlign="center",e.textBaseline="middle",e.fillText(le(o),t+50,757),r(e,new c(t+(100-i)/2,768))}),(({name:e})=>{$=e}),(()=>{const e=j();return e&&m[e]})),"upgrade base":se(["armor"]),"upgrade solar panel":se(["efficiency","armor"]),"upgrade battery":se(["storage","armor"]),"upgrade turret":se(["power","range","count","armor"])};function re(){const e=Y()?.name;return e?`upgrade ${e}`:"build"}function ae(e,t,n,o,i){return{options:e,cost:t,draw:(t,o)=>{for(const[r,a]of e.entries()){const e=100*r,s=i?.()===a,l=r===o;t.fillStyle=s?"#fff":l?"#fff4":"#222",t.fillRect(e,744,100,56),t.strokeStyle="#fff",t.beginPath(),t.moveTo(e+100-.5,744),t.lineTo(e+100-.5,800),t.stroke(),n(t,{left:e,active:s,hover:l},a)}},optionClick:o}}function se(e){return ae(e,100,((e,{left:t,active:n},o)=>{e.font="12px monospace",e.fillStyle=n?"#000":"#fff",e.textAlign="center",e.textBaseline="middle",e.fillText(le(o),t+50,757);const i=Y()[o];e.fillText(3===i?`Maxed (${i})`:`${i} 🠖 ${i+1}`,t+50,781)}),(e=>{Y().upgrade(e)}))}function le(e){return e.replace(/(^| )([a-z])/g,((e,t,n)=>`${t}${n.toUpperCase()}`))}const[ce,de]=_(500,800);let fe,ue,he=new c(12,-160),me=1,ye=c.empty,ge=c.empty,pe=c.empty,xe=c.empty,we=!1,ve=!1;function Me({clientX:e,clientY:t}={clientX:NaN,clientY:NaN}){const n=ce.getBoundingClientRect();ye=new c(500/n.width*(e-n.left),800/n.height*(t-n.top)),ge=ye.sub(new c(250,400)).mul(1/me).add(he),fe=function(e){if(!(e.y<720&&e.y>40)){if(e.within(377,8,115,24))return-1;for(let t=0;t<500/108;t+=1)if(e.within(100*t,744,100,56))return t;return-2}}(ye)}function be(e){he=e.sub(ye.sub(new c(250,400)).mul(1/me));const[t,n]=C();he=he.ensureWithin(t+251/me,401/me-1200,n-t-502/me,2400-802/me),he=new c(Math.round(he.x*me)/me,Math.round(he.y*me)/me)}function Se(){pe=c.empty,xe=c.empty,ue=void 0,we=!1,ve=!1}function ke(){de.resetTransform()}let Te="init";function Re(e){Te=e,"init"===Te&&(window.main.style.background="",window.main.style.pointerEvents=""),"play"===Te&&(window.game.style.opacity="",window.game.style.pointerEvents="",window.main.style.opacity="0",window.main.style.pointerEvents="none",setTimeout((()=>{window.main.style.background="#fff"}),2e3),he=new c(12,-160),me=1,ye=c.empty,ge=c.empty,fe=void 0,pe=c.empty,xe=c.empty,ue=void 0,we=!1,ve=!1,X.clear(),b.clear(),b.set(a(-1,-1),y.base.get(-1,-1)),k.clear(),T.clear(),R.clear(),E.clear(),d.clear(),d.add(a(0,0)),f.clear(),x.clear()),"end"===Te&&(window.game.style.opacity="0",window.game.style.pointerEvents="none",window.main.style.opacity="",window.score.innerHTML=b.has(a(-1,-1))?`Score: ${L.resources}`:`Score: ${Math.round(L.resources/2)}<br><div class=smol>(destroyed base: -50%)</div>`,setTimeout((()=>{Re("init")}),2e3))}document.title="Asteroid Miner";let Ee=0;document.body.style.background="#49f",function(){document.body.append(ee);for(let e=0;e<200;e+=1){const e=i(0,2*Math.PI),t=i(0,oe**2)**.5,n=Math.round(i(300,600));ne.push({mid:new c(Math.sin(e)*t,Math.cos(e)*t),cycleOffset:Math.floor(i(0,n)),cycleLength:n})}}(),ce.id="game",ce.style.opacity="0",ce.style.pointerEvents="none",document.body.append(ce),document.addEventListener("mousemove",(e=>{Me(e),!we&&pe.distance(ye)>5&&(we=!0),we&&be(xe)})),ce.addEventListener("contextmenu",(e=>{e.preventDefault()})),ce.addEventListener("wheel",(e=>{Me(e),void 0===fe&&function({deltaY:e}){me=Math.max(.5,Math.min(1.5,me-.08333333333333333*Math.sign(e))),be(ge)}(e)})),ce.addEventListener("mousedown",(e=>{e.preventDefault(),Me(e),void 0!==fe?(ve=!0,function(e){if(-1===e)return void Re("end");const t=re();"build"===re()&&N(void 0),void 0!==e&&e>=0&&e<ie[t].options.length&&ie[t].optionClick(ie[t].options[e])}(fe)):(pe=ye,xe=ge,ue=I(ge))})),document.addEventListener("mouseup",(e=>{Me(e),we||ve||ue!==I(ge)||N(ue),Se()})),document.addEventListener("visibilitychange",(()=>{ye=c.empty,ge=c.empty,fe=void 0,Se()})),function(){const e=document.createElement("div");e.className="screen",e.id="main",e.innerHTML='<div class=margin>Asteroid Miner</div><div class=margin><button id=start>Start</button> <button id=showinfo>How to play</button></div><div class=margin id=score></div><div class="margin smol">Made by <a href=https://fatfisz.com/>FatFisz</a></div>',document.body.appendChild(e),window.start.onclick=()=>{Re("play")},window.showinfo.onclick=()=>{e.style.opacity="0",t.style.opacity="",t.style.pointerEvents=""};const t=document.createElement("div");function n(){const{width:n,height:o}=window.game.getBoundingClientRect();e.style.width=n/2+"px",e.style.height=o/2+"px",t.style.width=n/2+"px",t.style.height=o/2+"px"}t.className="screen",t.id="info",t.innerHTML="<p class=margin>Welcome to the future, where asteroid mining is booming ✨</p><p>Your job is to mine as much resources as possible without getting obliterated by smaller (yet very destructive) asteroids.</p><p>First dig using a drill, then build and upgrade (access by clicking on a building) your power supply and defences.</p><p>When you feel ready, you can launch the rocket - as long as it's not yet destroyed!</p><button id=back>Got it</button>",t.style.opacity="0",t.style.pointerEvents="none",document.body.appendChild(t),window.back.onclick=()=>{e.style.opacity="",t.style.opacity="0",t.style.pointerEvents="none"},n(),window.onresize=n}(),o("objects",((e,{x1:t,y1:n,width:o,height:i})=>{for(const r of X){if(!r.mid.within(t-r.radius,n-r.radius,o+2*r.radius,i+2*r.radius))continue;e.fillStyle="#666",e.strokeStyle="#aaa",e.beginPath();let a=!0;for(const{x:t,y:n}of r.computedVertices)a?(a=!1,e.moveTo(t,n)):e.lineTo(t,n);e.closePath(),e.fill(),e.stroke()}})),M("#0c0",(()=>X),(({radius:e,mid:t,health:n,maxHealth:o})=>({mid:t,offsetY:-e,width:2*e,value:n/o}))),o("objects",((e,{position:t})=>{for(const n of b.values()){const o=r(n.mid.x-n.width/2),i=r(n.mid.y-n.height/2),s=new c(24*o,24*i);n.draw(e,s);const l=t.within(s.x,s.y,n.width,n.height);(a(o,-1)===P||l)&&g(e,s,n)}})),o("decorative",((e,t)=>{for(const n of B())z(e,n,t.position)})),o("backgroundObjects",(e=>{const t=Math.floor(15*L.energy);e.strokeStyle=`#f00${t.toString(16)}`;for(const t of b.values())if("turret"===t.name){e.lineWidth=t.power/2,e.beginPath();for(const n of t.targets)e.moveTo(t.mid.x,t.mid.y),e.lineTo(n.mid.x,n.mid.y);e.stroke()}e.lineWidth=1})),M("#0c0",(()=>b.values()),(({mid:e,width:t,height:n,health:o,maxHealth:i})=>({mid:e,width:t-2,offsetY:-n/2-4,value:o/i}))),M("#49f",(()=>T),(({mid:e,width:t,height:n,energy:o,storage:i})=>({mid:e,width:t-2,offsetY:-n/2-1,value:o/i}))),M("#f00",(()=>E),(({mid:e,width:t,height:n,ticksLeft:o})=>({mid:e,width:t-2,offsetY:-n/2-1,value:(120-o)/120}))),o("ground",((e,{x1:t,y1:n,x2:o,y2:i})=>{const s=r(t),l=Math.max(r(n),0),c=r(o),u=r(i);e.fillStyle="#643";for(let t=l;t<=u;t+=1)for(let n=s;n<=c;n+=1){const o=a(n,t);d.has(o)||f.has(o)||e.fillRect(24*n,24*t,24,24)}})),o("particles",(e=>{for(const t of x){const n=Math.floor(t.life/60*16);e.fillStyle=`${t.color}${n.toString(16)}`,e.fillRect(t.mid.x-1.5,t.mid.y-1.5,3,3)}})),function t(o){requestAnimationFrame(t),o>=Ee+15.666666666666668&&(Ee=o,l+=1,"play"!==Te&&"end"!==Te||(function(){x.size>w&&(w=x.size);for(const e of x)e.life-=1,0===e.life&&x.delete(e),e.mid=e.mid.add(e.dMid)}(),function(){Math.random()>.02||X.size>=20||G();for(const e of X)e.health<=0?U(e):(e.mid=e.mid.add(e.dMid),e.r+=e.dr,J(e),K(e))}(),function(){for(const[e,t]of b.entries())t.health<=0&&W(e,t);let e=20;for(const{efficiency:t}of k)e+=10*t*1;let t=0;for(const{energy:e}of T)t+=4500*e;let n=0;for(const e of R){const{mid:t,count:o,range:i,power:r}=e;e.targets=Z(t,o,200*i),n+=e.targets.length*V(o)*V(r)*15}n+=5*E.size;const o=Math.min(n,e+t);L.energy=o/n||1;for(const e of R){const{targets:t,power:n}=e;for(const e of t)e.health-=.02*n*L.energy}for(const e of E)e.ticksLeft-=L.energy,e.ticksLeft<=0&&W(a(r(e.mid.x),r(e.mid.y)),e);let i=(e-o)/4500;if(i>0){const e=[...T];for(let t=0;t<e.length;t+=1){const n=e[t],o=Math.min(i/(e.length-t),n.storage-n.energy);n.energy+=o,i-=o}}else if(i<0){const e=[...T].reverse();for(let t=0;t<e.length;t+=1){const n=e[t],o=Math.max(i/(e.length-t),-n.energy);n.energy+=o,i-=o}}let s=0,l=0;for(const{energy:e,storage:t}of T)s+=e,l+=t;L.battery=s/l}()),function(){const e=l*Math.PI*2/18e3;te.clearRect(0,0,500,800),te.fillStyle="#fff";for(const t of ne){const n=new c(t.mid.x*Math.cos(e)-t.mid.y*Math.sin(e)+250,t.mid.y*Math.cos(e)+t.mid.x*Math.sin(e)+800+100);if(!n.within(0,0,500,800))continue;const o=Math.floor((Math.sin((t.cycleOffset+l)/t.cycleLength*Math.PI*2)+1)/2*16);te.fillStyle=`#fff${o.toString(16)}`,te.fillRect(n.x-1.5,n.y-1.5,3,3)}}(),ke(),de.clearRect(0,0,500,800),de.translate(250,400),de.scale(me,me),de.translate(-he.x,-he.y),function(t,o){const i=e.map((()=>[]));for(const[e,t]of n)i[e].push(t);for(const e of i)for(const n of e)n(t,o)}(de,{position:ge,x1:he.x-251/me,y1:he.y-361/me,x2:he.x+251/me,y2:he.y+321/me,width:502/me,height:722/me}),ke(),function(e,t){const n=O(),o=re(),{draw:i,cost:r}=ie[o];e.fillStyle="#222",e.fillRect(0,0,500,40),e.strokeStyle="#fff",e.beginPath(),e.moveTo(0,39.5),e.lineTo(500,39.5),e.stroke(),e.fillStyle="#0c04",e.fillRect(8,8,115,24),e.fillStyle="#0c0",e.fillRect(8,8,115*n.energy,24),e.strokeRect(8.5,8.5,114,23),e.fillStyle="#49f4",e.fillRect(131,8,115,24),e.fillStyle="#49f",e.fillRect(131,8,115*n.battery,24),e.strokeRect(131.5,8.5,114,23),e.fillStyle=-1===t?"#fff4":"#222",e.fillRect(377,8,115,24),e.strokeRect(377.5,8.5,114,23),e.fillStyle="#fff",e.font="12px monospace",e.textAlign="left",e.textBaseline="middle",e.fillText("Energy",16,21),e.fillText("Battery",139,21),e.fillText(`Resources: ${n.resources}`,254,21),e.textAlign="center",e.fillText("Launch!",434.5,21),e.fillStyle="#222",e.fillRect(0,720,500,80),e.strokeStyle="#fff",e.strokeRect(-1,720.5,502,23),e.fillStyle="#fff",e.font="12px monospace",e.textAlign="left",e.textBaseline="middle",e.fillText(le(`${o} (cost: ${r})`),8,733.5),i(e,t)}(de,fe))}(0);})()</script>
