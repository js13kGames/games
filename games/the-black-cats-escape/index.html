<!doctype html><title>The Black Cat's Escape - js13kGames 2025</title><meta name=viewport content="width=device-width,maximum-scale=1,user-scalable=no"><style>body{display:flex;justify-content:center;align-items:center;height:100vh;margin:0;background-color:#fff}canvas{background-color:#d3d3d3}</style><canvas id=gameCanvas width=960 height=540></canvas><script>const e=document.getElementById("gameCanvas"),t=e.getContext("2d"),l=["FOOD","MOUSE","BOX","BALL"],i={FOOD:"- FOOD:\n - The cat will follow the food if it is in a straight line and there are no walls in between.",MOUSE:"- MOUSE:\n - The mouse will always try to go to the furthest tile from the cat.\n - The cat will follow it once it sees it, if it is in a straight line with no walls in between.\n - There can only be ONE mouse at a time.",BOX:"- BOX:\n - The box has the same behavior as a wall\n - It can be used to redirect the mouse and cat.",BALL:"- BALL:\n - If a ball is two tiles away from the cat, it will jump to it; ignoring walls."},o=[{grid:["IIIIIIIIIIIIIII","IIIIIIIIIIIIIII","MMMMMMMMMMMMMMM","MIIIIIIIIIIII.F","MMMMMMMMMMMMMMM","IIIIIIIIIIIIIII","IIIIIIIIIIIIIII"],catStart:{row:3,col:1},objects:[],itemCounts:{FOOD:1,MOUSE:0,BOX:0,BALL:0},messages:["- Goal: Bring the cat to the flag.\n- Start the game by pressing the 'GO!' button.","- You can lure the cat to the flag by placing items.","- The items are at the bottom of the screen.\n- You can place them by clicking once on the item, and then on a light green tile.","- The cat will see the food if it is in a straight line and there are no walls in between."],story:["They hunt the black cat, believing it’s a witch’s manifestation. Guide it to the flag before they capture it."],stThre:{gold:5,silver:10,bronze:15}},{grid:["MMMMMMMMMMMMMMM","MIMIIIIIFIMIIIM","MIMIMMMMMMMIIIM","M.MIMIIIIIIIIIM","M.MIMIIIIIIIIIM","M.IIMIIIIIIIIIM","MMMMMMMMMMMMMMM"],catStart:{row:1,col:1},objects:[],itemCounts:{FOOD:0,MOUSE:1,BOX:0,BALL:0},messages:["- The mouse will try to evade the cat. \n- Once the cat sees the mouse, it will chase it."],story:["You helped the cat escape once, but now they’re more cautious. Use the mouse to outmaneuver them and reach the flag again."],stThre:{gold:8,silver:12,bronze:16}},{grid:["M.....MMMMMMMMM","M.MMMMMMM....MM","M.......MM.MMMM","MMMMMM.MMM.MMMM","M.............M","MMMMMMMMMM.MMFM","MMMMMMMM...MMMM"],catStart:{row:4,col:1},objects:[],itemCounts:{FOOD:0,MOUSE:1,BOX:3,BALL:0},messages:["- Place boxes to redirect the mouse.\n- The mouse will always try to go to the furthest tile from the cat."],story:["They’ve learnt that the mouse tries to go to the furthest point from the cat, and modified the path. Redirect the mouse and lead the cat to the flag."],stThre:{gold:8,silver:12,bronze:18}},{grid:["MMMMMMMMMMMMMMM","M.M...........M","MMMMMMMMMMMMMMM","MM.IIIIIIIIII.M","MMMMMMMMMMMMMMM","MM.FMMMMMMMMMMM","MMMMMMMMMMMMMMM"],catStart:{row:1,col:1},objects:[],itemCounts:{FOOD:2,MOUSE:0,BOX:0,BALL:3},messages:["If a ball is two tiles away from the cat, it will jump to it."],story:["They now decided to corner the cat with walls, but thankfully, it can jump over those thanks to the balls."],stThre:{gold:15,silver:20,bronze:30}},{grid:["MMMMMMMMMMMMMMM","M.MI........MMM","M.MIMM.MMMMMMMM","M.MIMM.MMM.MMMM","M.MMMM.MMM.M.MM","M.M....MMMMM.MM","MMMMMMMMF.II.MM"],catStart:{row:1,col:1},objects:[],itemCounts:{FOOD:3,MOUSE:1,BOX:1,BALL:4},messages:["The cat has an order of priority: The destination; then the balls, the mouse and lastly the food."],story:["After guiding safely the cat many times, they decided to make the escape even more difficult, but the hunt is not over."],stThre:{gold:18,silver:22,bronze:26}},{grid:["...............","..MMMMMMMMMMMMM","..MMMMMMMMMMMMM","IMM..........M.","I.MMM.......MM.","I.M.MM......MM.","I...MM......MMF"],catStart:{row:0,col:0},objects:[],itemCounts:{FOOD:0,MOUSE:2,BOX:9,BALL:3},messages:["There can only be a mouse at a time."],story:["They try to confuse you with complex paths, but you have already saved the black cat many times."],stThre:{gold:15,silver:20,bronze:25}},{grid:["FMMMMMMMMMMMMM.",".M.M.M...M.M.M.","IMMMMM..IMMMMM.","IMI.IM..IMI.IM.","IM..IM..IM..IM.","IM.MIM..IM.MIM.","IM.MIM..IM.MIM."],catStart:{row:4,col:14},objects:[{row:2,col:14,type:"MOUSE"},{row:1,col:12,type:"BALL"},{row:1,col:10,type:"BALL"},{row:3,col:10,type:"BALL"},{row:5,col:10,type:"BALL"},{row:1,col:4,type:"BALL"},{row:1,col:2,type:"BALL"},{row:3,col:2,type:"BALL"},{row:5,col:2,type:"BALL"}],itemCounts:{FOOD:4,MOUSE:3,BOX:1,BALL:8},messages:["The cat prefers certain balls to others.\n The order of preference is bottom, top, right, and left."],story:["The hunt is arriving to an end soon, but the cat is stuck in some sort of maze; help it once again."],stThre:{gold:35,silver:40,bronze:45}},{grid:["..IM.......MI..",".IM.MIMMMIM.MI.","IMIMIM...M.M.MI","MIM.MIMIM.M.M.M","IM.M.M..IM.MIMI",".IMIMIMMMM.IMM.","F.IMI.IMI.I.I.."],catStart:{row:3,col:11},objects:[{row:3,col:13,type:"BALL"},{row:3,col:11,type:"BALL"},{row:3,col:9,type:"BALL"},{row:3,col:7,type:"BALL"},{row:1,col:11,type:"BALL"},{row:5,col:11,type:"BALL"},{row:2,col:10,type:"BALL"},{row:4,col:12,type:"BALL"},{row:2,col:12,type:"BALL"},{row:4,col:10,type:"BALL"},{row:3,col:5,type:"BALL"},{row:3,col:1,type:"BALL"},{row:1,col:3,type:"BALL"},{row:5,col:3,type:"BALL"},{row:2,col:2,type:"BALL"},{row:4,col:4,type:"BALL"},{row:2,col:4,type:"BALL"},{row:4,col:2,type:"BALL"},{row:1,col:1,type:"BALL"},{row:2,col:6,type:"BALL"},{row:4,col:8,type:"BALL"},{row:4,col:6,type:"FOOD"},{row:4,col:0,type:"BALL"},{row:2,col:14,type:"BALL"},{row:4,col:14,type:"BALL"},{row:0,col:1,type:"MOUSE"}],itemCounts:{FOOD:2,MOUSE:1,BOX:2,BALL:8},messages:["The cat is stuck between many balls; but its priorities didn't change."],story:["You're almost there, but they decided to confuse you by placing many items too; show them who places item the best."],stThre:{gold:42,silver:46,bronze:50}},{grid:["...I..III......","..II.II.II.....",".I..MM...MM....","M.F.I.....II.IM",".M..MM...MM.II.",".M.MMII.II.II..",".I....III..M..."],catStart:{row:0,col:0},objects:[],teleporters:[{row:3,col:5,destination:{row:5,col:13}},{row:3,col:9,destination:{row:6,col:0}},{row:5,col:7,destination:{row:0,col:0}},{row:1,col:7,destination:{row:6,col:14}},{row:3,col:1,destination:{row:3,col:14}},{row:3,col:3,destination:{row:3,col:1}},{row:4,col:2,destination:{row:6,col:14}},{row:2,col:2,destination:{row:6,col:14}},{row:0,col:2,destination:{row:0,col:14}},{row:0,col:12,destination:{row:3,col:7}},{row:0,col:10,destination:{row:0,col:14}},{row:2,col:0,destination:{row:5,col:2}},{row:2,col:14,destination:{row:4,col:11}},{row:4,col:0,destination:{row:6,col:14}},{row:4,col:14,destination:{row:6,col:14}},{row:6,col:2,destination:{row:4,col:11}},{row:6,col:12,destination:{row:6,col:14}}],itemCounts:{FOOD:3,MOUSE:0,BOX:0,BALL:2},messages:["Use the teleporters to reach the flag!"],story:["This is the final escape; they laid many teleporters to corner the cat; but through trial and error you will be able to save the cat for good."],stThre:{gold:10,silver:14,bronze:20}}];class n{constructor(e,t,l,i,o,n,r){this.x=e,this.y=t,this.color=l,this.size=i,this.speedX=Math.cos(n)*o,this.speedY=Math.sin(n)*o,this.lifetime=r,this.maxLifetime=r}update(){return this.x+=this.speedX,this.y+=this.speedY,this.lifetime--,this.lifetime>0}draw(e){let t=this.lifetime/this.maxLifetime;e.fillStyle=`rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${t})`,e.beginPath(),e.arc(this.x,this.y,this.size*(this.lifetime/this.maxLifetime),0,2*Math.PI),e.fill()}}const r=new class{constructor(){this.particles=[]}addParticle(e,t,l,i,o,r,a){this.particles.push(new n(e,t,l,i,o,r,a))}addX(e,t,l,i,o,n,r){for(let a=0;a<l;a++){let l=Math.random()*Math.PI*2;this.addParticle(e,t,i,o,n,l,r)}}update(){this.particles=this.particles.filter(e=>e.update())}draw(e){this.particles.forEach(t=>t.draw(e))}};let a,c=0,s=new(window.AudioContext||window.webkitAudioContext),M=!1,f=parseInt(localStorage.getItem("tbce_maxLevel"))||0,h=f>0&&0!==c&&c<o.length-1,u=Array.from({length:f+1},(e,t)=>t),g=0,w=0,d=1,I=30,m=null,y=[],T=[],p=[],A={},S=!1,x=null,b={},L="start",B="Tiles",O=!1,v=[],R=!1,P="",k=0,F=!1,D={dr:0,dc:0},X=[],C=null,E=!1,G=!0,$=0,U=0,V=JSON.parse(localStorage.getItem("tbce_levelTimes"))||Array(o.length).fill(1/0),j=JSON.parse(localStorage.getItem("tbce_levelStars"))||Array(o.length).fill(0),z=!1,Y=[],q=0;const _=[220,247,262,294,330,392,220,247,262,294,330,392,220,247,262,294,330,392,262,294,330,262,294,330,440,110,220,110,247,110,262,110,294,110,330,110,392,110,220,110,247,110,262,110,294,110,330,110,392,110,262,110,294,110,330,110,262,110,294,110,330,110,440,220,247,255,294,311,392,220,247,262,294,330,392,220,247,262,287,330,392,262,294,311,262,294,330,440,110,0,220,0,110,0,247,0,110,0,262,0,110,0,294,0,110,0,330,0,110,0,392,0,110,0,0,0,440,0,0,0],W=[.5,.5,1,.5,.5,1,.5,.5,1,.5,.5,1,.5,.5,1,.5,.5,1,.33,.33,.34,.33,.33,.34,2,.3,.5,.3,.5,.3,.5,.3,.5,.3,.5,.3,1,.3,.5,.3,.5,.3,.5,.3,.5,.3,.5,.3,1,.3,.33,.3,.33,.3,.34,.3,.33,.3,.33,.3,.34,.3,2,.5,.5,.5,.5,.5,1,.5,.5,1,.5,.5,1,.5,.5,.5,.5,.5,1,.33,.33,.34,.33,.33,.34,2,1.5,.5,1.5,.5,1.5,.5,1.5,.5,1.5,.5,1.5,.5,1.5,.5,1.5,.5,1.5,.5,1.5,.5,1.5,.5,1.5,.5,2,.5,.5,.5,2,.5,1,1],N=s.createGain(),J=s.createGain();function H(){"suspended"===s.state&&s.resume(),E||"running"!==s.state||(ae(),["click","keydown","touchstart"].forEach(e=>{window.removeEventListener(e,H)}))}function K(e){y=[];let t=o[e];if(T=t.grid.map(e=>e.split("")),A={...t.catStart},b={...t.itemCounts},p=Array.from({length:T.length},()=>Array(T[0].length).fill(null)),X=t.teleporters||[],S=!1,m=null,t.messages&&t.messages.length>0?(v=t.messages,k=0,O=!0,F=!1):(O=!1,F=!1),t.story&&t.story.length>0?(Y=t.story,q=0,z=!1):(Y=[],q=0,z=!1),t.objects)for(let e of t.objects)p[e.row][e.col]="FOOD"===e.type?"D":"MOUSE"===e.type?"O":"BOX"===e.type?"X":"B";x=null;for(let e=0;e<T.length;e++)for(let t=0;t<T[0].length;t++)if("O"===p[e][t]){x={row:e,col:t};break}U=Date.now()}function Q(e,t,l,i,o,n){let r=t.split("\n"),a=i;for(let t of r){let i=t.split(" "),r="";for(let t=0;t<i.length;t++){let c=r+i[t]+" ";e.measureText(c).width>o&&t>0?(e.fillText(r.trim(),l,a),r=i[t]+" ",a+=n):r=c}e.fillText(r.trim(),l,a),a+=n}}function Z(){t.fillStyle="rgba(0, 0, 0, 0.9)",t.fillRect(0,0,e.width,e.height),t.fillStyle="gold",t.font="48px sans-serif",t.textAlign="center",t.fillText("Congratulations!",e.width/2,100),t.font="24px sans-serif",t.fillStyle="white",t.fillText("You've completed all levels!",e.width/2,150);let{totalStars:l,maxStars:i,percentage:n}=function(){let e=j.reduce((e,t)=>e+t,0),t=3*o.length;return{totalStars:e,maxStars:t,percentage:Math.round(e/t*100)}}();t.fillStyle="white",t.font="20px sans-serif",t.fillText(`Total Stars: ${l}/${i}`,e.width/2,200),t.fillText(`Score: ${n}%`,e.width/2,240),t.fillStyle="#4CAF50",t.fillRect(e.width/2-100,280,200,50),t.fillStyle="white",t.font="24px sans-serif",t.fillText("Play Again",e.width/2,310)}function ee(e,l,i,o){if("D"===e)t.strokeStyle="black",t.lineWidth=2,t.fillStyle="#1a8bbc",t.beginPath(),t.moveTo(l+o/2+15,i+o/2+6),t.lineTo(l+o/2,i+o/2-2),t.lineTo(l+o/2+15,i+o/2-6),t.closePath(),t.fill(),t.stroke(),t.ellipse(l+o/2-4,i+o/2,o/4,o/5,0,0,2*Math.PI),t.stroke(),t.beginPath(),t.lineTo(l+o/2+15,i+o/2-6),t.closePath(),t.stroke(),t.beginPath(),t.moveTo(l+o/2-4,i+17),t.lineTo(l+o/2,i+10),t.lineTo(l+o/2+2,i+17),t.closePath(),t.stroke(),t.beginPath(),t.ellipse(l+o/2-4,i+o/2,o/4,o/5,0,0,2*Math.PI),t.fill(),t.beginPath(),t.moveTo(l+o/2-4,i+17),t.lineTo(l+o/2,i+10),t.lineTo(l+o/2+2,i+17),t.closePath(),t.fill(),t.fillStyle="black",t.beginPath(),t.arc(l+o/2-10,i+o/2-2,1.5,0,2*Math.PI),t.fill(),t.lineWidth=1,t.beginPath(),t.arc(l+o/2-12,i+o/2+3,1.5,0,Math.PI,!0),t.stroke();else if("O"===e){let e=l+o/2,n=i+o/2;t.strokeStyle="black",t.beginPath(),t.arc(e,n,14,0,2*Math.PI),t.stroke(),t.beginPath(),t.arc(e-10,n-10,6,0,2*Math.PI),t.arc(e+10,n-10,6,0,2*Math.PI),t.stroke(),t.fillStyle="rgba(220,220,220,1)",t.beginPath(),t.arc(e,n,14,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(e-10,n-10,6,0,2*Math.PI),t.arc(e+10,n-10,6,0,2*Math.PI),t.fill(),t.fillStyle="black",t.beginPath(),t.arc(e-5,n-3,2,0,2*Math.PI),t.arc(e+5,n-3,2,0,2*Math.PI),t.fill(),t.strokeStyle="black",t.lineWidth=1,t.beginPath(),t.moveTo(e-4,n+2),t.lineTo(e-12,n+6),t.moveTo(e-4,n+4),t.lineTo(e-12,n+10),t.moveTo(e+4,n+2),t.lineTo(e+12,n+6),t.moveTo(e+4,n+4),t.lineTo(e+12,n+10),t.stroke()}else"B"===e?(t.fillStyle="#cc050c",t.beginPath(),t.arc(l+o/2,i+o/2,14,0,2*Math.PI),t.fill(),t.strokeStyle="#cc050c",t.stroke()):"X"===e&&(t.fillStyle="#cfa854",t.fillRect(l+4,i+4,o-8,o-8),t.strokeStyle="black",t.strokeRect(l+4,i+4,o-8,o-8),t.beginPath(),t.moveTo(l+4,i+o/2),t.lineTo(l+o-4,i+o/2),t.moveTo(l+o/2,i+4),t.lineTo(l+o/2,i+o-4),t.strokeStyle="#654321",t.stroke())}function te(){M=!0,t.fillStyle="rgba(0,0,0,0.8)",t.fillRect(110,50,735,300),t.fillStyle="white",t.font="24px sans-serif",t.textAlign="center",t.fillText("Level finished!",480,90),t.fillStyle="#4CAF50",t.fillRect(320,130,150,50),t.fillStyle="white",t.fillText("Play again",395,155),c+1<o.length&&(t.fillStyle="#2196F3",t.fillRect(490,130,150,50),t.fillStyle="white",t.fillText("Next level",565,155)),t.font="18px sans-serif",t.textAlign="left";for(let e=0;e<o.length;e++)t.fillStyle=u.includes(e)?"#4CAF50":"#757575",t.fillRect(220+60*e,270,40,40),t.fillStyle="white",t.fillText(e+1,235+60*e,295);for(let e=0;e<j[c];e++)t.fillStyle="gold",t.save(),t.translate(440+40*e,225),le(t,0,0,20),t.restore();for(let e=0;e<o.length;e++)if(u.includes(e))for(let l=0;l<j[e];l++)t.fillStyle="gold",t.save(),t.translate(230+60*e+10*l,280),le(t,0,0,5),t.restore()}function le(e,t,l,i){e.beginPath();let o=i,n=.4*i;for(let i=0;i<10;i++){let r=i*Math.PI/5-Math.PI/2,a=i%2==0?o:n,c=t+Math.cos(r)*a,s=l+Math.sin(r)*a;0===i?e.moveTo(c,s):e.lineTo(c,s)}e.closePath(),e.fill()}function ie(){t.clearRect(0,0,e.width,e.height),"start"===L?(t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(0,0,e.width,e.height),t.fillStyle="white",t.font="36px sans-serif",t.textAlign="center",t.fillText("Welcome to the Game!",e.width/2,e.height/2-50),t.fillStyle="#4CAF50",t.fillRect(e.width/2-100,e.height/2,200,50),t.fillStyle="white",t.font="24px sans-serif",t.fillText("Start Game",e.width/2,e.height/2+30),t.fillStyle="#2196F3",t.fillRect(e.width/2-100,e.height/2+70,200,50),t.fillStyle="white",t.fillText("How to Play",e.width/2,e.height/2+100)):"howToPlay"===L?function(){t.fillStyle="rgba(0, 0, 0, 0.9)",t.fillRect(0,0,e.width,e.height),t.fillStyle="white",t.font="32px sans-serif",t.textAlign="center",t.fillText("How to Play",e.width/2,100);let l=e.width/2-300;t.fillStyle="Tiles"===B?"#007BFF":"#2196F3",t.fillRect(l,150,180,40),t.fillStyle="white",t.font="20px sans-serif",t.textAlign="center",t.fillText("Tiles",l+90,175),t.fillStyle="Items"===B?"#007BFF":"#2196F3",t.fillRect(l+180+30,150,180,40),t.fillStyle="white",t.fillText("Items",l+180+30+90,175),t.fillStyle="Game Buttons"===B?"#007BFF":"#2196F3",t.fillRect(l+420,150,180,40),t.fillStyle="white",t.fillText("Game Buttons",l+420+90,175),t.fillStyle="#f44336",t.fillRect(e.width/2-50,e.height-100,100,40),t.fillStyle="white",t.font="20px sans-serif",t.textAlign="center",t.fillText("Close",e.width/2,e.height-70),t.font="20px sans-serif",t.textAlign="left","Tiles"===B?(t.fillText("Tiles:",100,220),t.fillText("- The cat can pass through light green tiles, and you can place items on those tiles.",120,250),t.fillText("- The cat cannot pass through dark green tiles, but you can place items on those tiles.",120,280),t.fillText("- Walls: The cat cannot pass through black tiles, and you cannot place items on those tiles.",120,310),t.fillText("- The flag is the goal. Bring the cat there to win!",120,340)):"Items"===B?(t.fillText("Items:",100,220),t.fillText("- FOOD: The cat will follow the food if it is in a straight line with no walls.",120,250),t.fillText("- MOUSE: The mouse evades the cat. The cat will chase it if it sees it.",120,280),t.fillText("- BOX: Acts like a wall. Use it to redirect the mouse or cat.",120,310),t.fillText("- BALL: If a ball is two tiles away, the cat will jump to it, ignoring walls and boxes.",120,340)):"Game Buttons"===B&&(t.fillText("Game Buttons:",100,220),t.fillText("- GO!: Start the game.",120,250),t.fillText("- Reset (↻): Reset the current level.",120,280),t.fillText("- Cancel (✕): Remove the last placed item.",120,310),t.fillText("- Sound: Toggle sound on/off.",120,340),t.fillText("- Speed: Adjust the game speed with the plus and minus buttons.",120,370))}():(function(){t.lineWidth=2;for(let e=0;e<7;e++)for(let l=0;l<15;l++){let i=T[e][l],o=60+56*l,n=8+56*e;if(t.fillStyle="#92c487",t.fillRect(o,n,52,52),t.strokeStyle="#fff",t.strokeRect(o,n,52,52),"I"===i&&(t.fillStyle="#5b8452",t.fillRect(o,n,52,52),t.strokeStyle="#fff",t.strokeRect(o,n,52,52)),"M"===i){t.fillStyle="black",t.strokeStyle="black";let i=l>0&&"M"===T[e][l-1],r=l<14&&"M"===T[e][l+1],a=e>0&&"M"===T[e-1][l],c=e<6&&"M"===T[e+1][l],s=a&&i&&"M"===T[e-1][l-1],M=a&&r&&"M"===T[e-1][l+1],f=c&&i&&"M"===T[e+1][l-1],h=c&&r&&"M"===T[e+1][l+1],u=o,g=n,w=52,d=52;i&&(u-=2,w+=2),r&&(w+=2),a&&(g-=2,d+=2),c&&(d+=2),t.fillRect(u,g,w,d),!s&&a&&i&&(t.fillStyle="#D3D3D3",t.fillRect(o-4,n-4,4,4)),!M&&a&&r&&(t.fillStyle="#D3D3D3",t.fillRect(o+52,n-4,4,4)),!f&&c&&i&&(t.fillStyle="#D3D3D3",t.fillRect(o-4,n+52,4,4)),!h&&c&&r&&(t.fillStyle="#D3D3D3",t.fillRect(o+52,n+52,4,4))}else if("F"===i){t.fillStyle="#5b8452",t.fillRect(o,n,52,52),t.fillStyle="black",t.fillRect(o+7,n+10,3,40),t.fillStyle="red";for(let e=0;e<8;e++)for(let l=0;l<5;l++)t.fillStyle=(e+l)%2==0?"white":"black",t.fillRect(o+10+4*e,n+10+4*l,4,4)}p[e][l]&&ee(p[e][l],o,n,52)}}(),function(){for(let e of X){let l=60+56*e.col+26,i=8+56*e.row+26,o=52/3,n=t.createRadialGradient(l,i,.2*o,l,i,o);n.addColorStop(0,"rgba(200, 100, 255, 0.8)"),n.addColorStop(1,"rgba(100, 0, 150, 0.9)"),t.fillStyle=n,t.beginPath(),t.arc(l,i,o,0,2*Math.PI),t.fill(),t.strokeStyle="white",t.lineWidth=2,t.beginPath();for(let e=0;e<4*Math.PI;e+=.2){let n=o*e/(4*Math.PI),r=l+Math.cos(e)*n,a=i+Math.sin(e)*n;0===e?t.moveTo(r,a):t.lineTo(r,a)}t.stroke()}}(),x&&x&&ee("O",60+56*x.col,8+56*x.row,52),function(e){let l=60+56*A.col,i=8+56*e,o=l+26,n=i+26;t.fillStyle="black",t.beginPath(),t.fillRect(l+10,i+10,32,32),t.fill(),t.beginPath(),t.moveTo(l+10,i+10),t.lineTo(l+15,i+2),t.lineTo(l+20,i+10),t.closePath(),t.fill(),t.beginPath(),t.moveTo(l+32,i+10),t.lineTo(l+37,i+2),t.lineTo(l+42,i+10),t.closePath(),t.fill(),t.beginPath(),D.dc<0?(t.fillRect(l+52-10,n+8,8,4),t.fillRect(l+52-6,n+8,4,-20)):(D.dc,t.fillRect(l+2,n+8,8,4),t.fillRect(l+2,n+8,4,-20)),t.fill(),t.fillStyle="white",t.beginPath(),t.fillRect(o-10,n-7,4,10),t.fillRect(o+6,n-7,4,10),t.fill(),t.fillStyle="pink",t.beginPath(),t.fillRect(o-6,n+8,12,4),t.fill()}(A.row),t.strokeStyle="#AAAAAA",t.beginPath(),t.moveTo(40,410),t.lineTo(920,410),t.stroke(),function(){for(let e=0;e<l.length;e++){let i=l[e],o=20+190*e;t.beginPath(),t.fillStyle=m===i?"#AAAAAA":"#C3C3C3",t.roundRect(o,420,180,100,10),t.fill(),t.fillStyle="#000",t.font="20px sans-serif",t.textAlign="center",t.textBaseline="middle",t.fillText(i,o+90,450),t.fillStyle="red",t.beginPath(),t.arc(o+180-30,450,20,0,2*Math.PI),t.fill(),t.fillStyle="white",t.font="16px sans-serif",t.fillText(b[i],o+180-30,450),ee("FOOD"===i?"D":"MOUSE"===i?"O":"BOX"===i?"X":"B",o+70,470,40),t.fillStyle="#3A8DFF",t.beginPath(),t.arc(o+20,450,15,0,2*Math.PI),t.fill(),t.fillStyle="white",t.font="16px sans-serif",t.textAlign="center",t.textBaseline="middle",t.fillText("i",o+20,450)}}(),function(){let e=20+190*l.length;t.fillStyle="#AAAAAA",t.fillRect(e,430,40,40),t.fillStyle="white",t.font="20px sans-serif",t.textAlign="center",t.textBaseline="middle",t.fillText("GO!",e+20,450)}(),function(){let e=20+190*l.length+40+10;t.fillStyle="#AAAAAA",t.fillRect(e,430,40,40),t.fillStyle="white",t.font="24px sans-serif",t.textAlign="center",t.textBaseline="middle",t.fillText("↻",e+20,450)}(),function(){let e=20+190*l.length+40+10+50;t.fillStyle="#AAAAAA",t.fillRect(e,430,40,40),t.fillStyle="white",t.font="20px sans-serif",t.textAlign="center",t.textBaseline="middle",t.fillText("✕",e+20,450)}(),function(){let e=20+190*l.length;t.fillStyle=G?"#4CAF50":"#f44336",t.fillRect(e,480,40,40),t.fillStyle="white",t.font="20px Arial",t.textAlign="center",t.fillText(G?"🔊":"🔇",e+20,500,30,30)}(),function(){let e=20+190*l.length+40+10;t.fillStyle="#AAAAAA",t.fillRect(e,495,25,25),t.fillStyle="white",t.font="24px sans-serif",t.textAlign="center",t.textBaseline="middle",t.fillText("-",e+12.5,507.5)}(),function(){let e=20+190*l.length+40+10+65;t.fillStyle="#AAAAAA",t.fillRect(e,495,25,25),t.fillStyle="white",t.font="24px sans-serif",t.textAlign="center",t.textBaseline="middle",t.fillText("+",e+12.5,507.5)}(),function(){let e=20+190*l.length+40+10+45;t.fillStyle="white",t.font="12px sans-serif",t.textAlign="center",t.textBaseline="middle",t.fillText("Game speed: ",e,485),t.fillText(`${d.toFixed(2)}x`,e,507)}(),O?O&&(t.fillStyle="rgba(0,0,0,0.7)",t.fillRect(50,100,800,200),t.fillStyle="white",t.font="18px sans-serif",t.textAlign="left",t.textBaseline="top",t.fillText(`Message ${k+1}/${v.length}`,70,105),t.font="20px sans-serif",Q(t,v[k],70,135,760,28),t.fillStyle="yellow",t.font="18px sans-serif",t.textAlign="right",t.fillText("Click to continue...",830,270)):z&&z&&(t.fillStyle="rgba(30, 30, 80, 0.85)",t.fillRect(50,100,800,200),t.fillStyle="white",t.font="18px sans-serif",t.textAlign="left",t.textBaseline="top",t.fillText(`Story ${q+1}/${Y.length}`,70,105),t.font="20px sans-serif",Q(t,Y[q],70,135,760,28),t.fillStyle="yellow",t.font="18px sans-serif",t.textAlign="right",t.fillText("Click to continue...",830,270)),R&&R&&(t.fillStyle="rgba(0,0,0,0.7)",t.fillRect(100,120,700,180),t.fillStyle="white",t.font="20px sans-serif",t.textAlign="left",t.textBaseline="top",Q(t,P,120,140,660,26),t.fillStyle="yellow",t.font="18px sans-serif",t.textAlign="right",t.fillText("Click to close...",780,270)),M&&(c+1>=o.length?Z():te()),r.update(),r.draw(t))}function oe(e,t=c){let l=o[t].stThre,i=e*d;return i<=l.gold?3:i<=l.silver?2:i<=l.bronze?1:0}function ne(e=440,t=.2,l="square"){if(G)try{let i=s.createOscillator(),o=s.createGain();i.type=l,i.frequency.value=e,i.connect(o),o.connect(J),o.gain.setValueAtTime(0,s.currentTime),o.gain.linearRampToValueAtTime(.05,s.currentTime+.01),o.gain.linearRampToValueAtTime(.05,s.currentTime+.01),o.gain.linearRampToValueAtTime(0,s.currentTime+t),i.start(s.currentTime),i.stop(s.currentTime+t)}catch(e){console.error("Error playing note:",e)}}function re(){if(!E||!G)return;let e=_[$],t=W[$],l=s.createOscillator(),i=s.createGain();l.type="sine",l.frequency.value=e,i.gain.setValueAtTime(0,s.currentTime),i.gain.linearRampToValueAtTime(.1,s.currentTime+.05),i.gain.linearRampToValueAtTime(0,s.currentTime+t),l.connect(i),i.connect(N),l.start(),l.stop(s.currentTime+t+.1),$=($+1)%_.length,a=setTimeout(re,1e3*t)}function ae(){E||"running"!==s.state||(E=!0,$=0,re())}function ce(){G&&[150,350].forEach((e,t)=>{setTimeout(()=>{ne(e,.15)},150*t)})}function se(){G&&["sawtooth","triangle"].forEach((e,t)=>{let l=s.createOscillator(),i=s.createGain();l.type=e,l.frequency.setValueAtTime(800,s.currentTime),l.frequency.exponentialRampToValueAtTime(300,s.currentTime+.25),i.gain.setValueAtTime(0,s.currentTime),i.gain.linearRampToValueAtTime(.05+.1*t,s.currentTime+.01),i.gain.linearRampToValueAtTime(0,s.currentTime+.25),l.connect(i),i.connect(J),l.start(s.currentTime),l.stop(s.currentTime+.25)})}function Me(){if(!G)return;let e=s.createOscillator(),t=s.createGain();e.type="triangle",e.frequency.setValueAtTime(1500,s.currentTime),e.frequency.exponentialRampToValueAtTime(150,s.currentTime+.4);let l=s.createOscillator(),i=s.createGain();l.frequency.value=25,i.gain.value=80,l.connect(i),i.connect(e.frequency),t.gain.setValueAtTime(0,s.currentTime),t.gain.linearRampToValueAtTime(.15,s.currentTime+.02),t.gain.exponentialRampToValueAtTime(.001,s.currentTime+.4),e.connect(t),t.connect(J),e.start(s.currentTime),e.stop(s.currentTime+.4),l.start(s.currentTime),l.stop(s.currentTime+.4);let o=s.createOscillator(),n=s.createGain();o.type="sine",o.frequency.setValueAtTime(2e3,s.currentTime),n.gain.setValueAtTime(.3,s.currentTime),n.gain.exponentialRampToValueAtTime(.001,s.currentTime+.15),o.connect(n),n.connect(J),o.start(s.currentTime),o.stop(s.currentTime+.15)}function fe(){G&&ne(800,.1,"triangle")}function he(){G&&[440,660,880].forEach((e,t)=>{setTimeout(()=>{ne(e,.15)},150*t)})}function ue(e,t,l,i,o=new Set){let n=T.length,r=T[0].length,a=Array.from({length:n},()=>Array(r).fill(!1)),c=[],s={},M=(e,t)=>`${e},${t}`;for(c.push({row:e,col:t}),a[e][t]=!0;c.length>0;){let f=c.shift();if(f.row===l&&f.col===i){let o=[],n={row:l,col:i};for(;n.row!==e||n.col!==t;)o.unshift(n),n=s[`${n.row},${n.col}`];return o}let h=[[0,1],[1,0],[0,-1],[-1,0]];for(let[e,t]of h){let l=f.row+e,i=f.col+t;l>=0&&l<n&&i>=0&&i<r&&!a[l][i]&&"M"!==T[l][i]&&"X"!==p[l][i]&&!o.has(M(l,i))&&(a[l][i]=!0,s[`${l},${i}`]={row:f.row,col:f.col},c.push({row:l,col:i}))}}return null}function ge(){u.includes(c+1)||u.push(c+1),c+1>f&&(f=c+1,localStorage.setItem("tbce_maxLevel",f)),localStorage.setItem("tbce_currentLevel",c+1);let e=60+56*A.col+26,t=8+56*A.row+26;r.addX(e,t,350,{r:255,g:255,b:0},4,2,30),c+1<o.length?te():(M=!0,Z())}N.connect(s.destination),J.connect(s.destination),["click","keydown","touchstart"].forEach(e=>{window.addEventListener(e,H)}),e.addEventListener("click",t=>{if(h){let l=e.getBoundingClientRect(),i=t.clientX-l.left,o=t.clientY-l.top;if(i>=300&&i<=400&&o>=260&&o<=300){let e=parseInt(localStorage.getItem("tbce_currentLevel"))||0;K(c=e),h=!1,ie()}else i>=400&&i<=500&&o>=260&&o<=300&&(h=!1,K(c),ie());return}if(M&&c+1>=o.length){let l=e.getBoundingClientRect(),i=t.clientX-l.left,o=t.clientY-l.top;i>=e.width/2-100&&i<=e.width/2+100&&o>=280&&o<=330&&(M=!1,K(c=0))}let n=e.getBoundingClientRect(),s=t.clientX-n.left,f=t.clientY-n.top;if("start"===L)s>=e.width/2-100&&s<=e.width/2+100&&(f>=e.height/2&&f<=e.height/2+50?(L="game",K(0),F=!0):f>=e.height/2+70&&f<=e.height/2+120&&(L="howToPlay"));else if("howToPlay"===L){let l=e.getBoundingClientRect(),i=t.clientX-l.left,o=t.clientY-l.top,n=e.width/2-300;i>=n&&i<=n+180&&o>=150&&o<=190?(B="Tiles",ie()):i>=n+180+30&&i<=n+360+30&&o>=150&&o<=190?(B="Items",ie()):i>=n+420&&i<=n+540+60&&o>=150&&o<=190?(B="Game Buttons",ie()):i>=e.width/2-50&&i<=e.width/2+50&&o>=e.height-100&&o<=e.height-60&&(L="start",ie())}else{if(M){let l=e.getBoundingClientRect(),i=t.clientX-l.left,n=t.clientY-l.top;if(i>=320&&i<=470&&n>=130&&n<=180)M=!1,K(c);else if(c+1<o.length&&i>=490&&i<=640&&n>=130&&n<=180)M=!1,K(++c);else for(let e=0;e<o.length;e++){let t=220+60*e;if(i>=t&&i<=t+40&&n>=270&&n<=310&&u.includes(e)){M=!1,K(c=e);break}}return}if(O)return void(++k>=v.length&&(O=!1,Y.length>0&&(z=!0),F=!1));if(z)return void(++q>=Y.length&&(z=!1,F=!1));if(R)return R=!1,void ie();{let o=e.getBoundingClientRect(),n=t.clientX-o.left,s=t.clientY-o.top;if(s>420&&s<520){let e=Math.floor((n-20)/190),t=20+180*e;if(e>=0&&e<l.length){let o=n-(20+190*e+20),r=s-450;if(15>=Math.sqrt(o*o+r*r))return P=i[l[e]],R=!0,void ie();e>=0&&e<l.length&&n>=t&&n<=t+200&&(m=l[e],ie())}}else if(s<410&&m&&b[m]>0){let e=Math.floor((n-60)/56),t=Math.floor((s-8)/56);if(t>=0&&t<7&&e>=0&&e<15&&!p[t][e]&&"M"!==T[t][e]&&"F"!==T[t][e]&&"I"!==T[t][e]&&(t!==A.row||e!==A.col)&&!X.some(l=>l.row===t&&l.col===e)){if("MOUSE"===m){if(null===x){let l=60+56*e+26,i=8+56*t+26;r.addX(l,i,10,{r:255,g:0,b:0},2,1,30),p[t][e]="O",x={row:t,col:e},b[m]--,ce(),y.push({row:t,col:e,type:m})}}else{p[t][e]="FOOD"===m?"D":"BOX"===m?"X":"BALL"===m?"B":null;let l=60+56*e+26,i=8+56*t+26;r.addX(l,i,10,{r:255,g:0,b:0},2,1,30),b[m]--,ce(),y.push({row:t,col:e,type:m})}ie()}}let M=20+190*l.length+40+10;if(n>=M&&n<=M+40&&s>=430&&s<=470)return void K(c);let f=20+190*l.length;n>=f&&n<=f+40&&s>=430&&s<=470&&(F=!0,U=Date.now());let h=20+190*l.length+40+10+50;n>=h&&n<=h+40&&s>=430&&s<=470&&(function(){if(0===y.length||F)return;let e=y.pop(),{row:t,col:l,type:i}=e;"O"===p[t][l]&&(x=null),p[t][l]=null,b[i]++}(),ie());let u=20+190*l.length;if(n>=u&&n<=u+40&&s>=480&&s<=520)return void((G=!G)&&!E?ae():G||(E=!1,clearTimeout(a)));let g=20+190*l.length+40+10;if(n>=g&&n<=g+25&&s>=495&&s<=520)return void(F||(I=Math.round(30/(d=Math.max(.25,d-.25))),ie()));let w=20+190*l.length+40+10+65;if(n>=w&&n<=w+25&&s>=495&&s<=520)return void(F||(I=Math.round(30/(d=Math.min(2,d+.25))),ie()))}}}),"game"!==L||F||(K(c),F=!0),function e(){ie(),!M&&F&&(function(){if(null===x&&(S=!1),S||(S=function(e,t){for(let[l,i]of[[0,1],[1,0],[0,-1],[-1,0]]){let o=e,n=t;for(;o+=l,n+=i,!(o<0||o>=7||n<0||n>=15||"M"===T[o][n]||"X"===p[o][n]);)if(x&&o===x.row&&n===x.col)return[o,n]}return null}(A.row,A.col)),g>0)return void g--;for(let e of(C&&(C.row!==A.row||C.col!==A.col)&&(C=null),X))if(!(A.row!==e.row||A.col!==e.col||A.row===e.destination.row&&A.col===e.destination.col||C&&C.row===e.row&&C.col===e.col)){A.row=e.destination.row,A.col=e.destination.col;let t=60+56*A.col+26,l=8+56*A.row+26;r.addX(t,l,20,{r:0,g:0,b:255},3,2,40);let i=56*(e.col+1)+26,o=56*e.row+26;return r.addX(i,o,20,{r:0,g:0,b:255},3,2,40),Me(),g=I,void(C=e.destination)}for(let[e,t]of[[0,1],[1,0],[0,-1],[-1,0]]){let l=A.row+e,i=A.col+t;if(l>=0&&l<7&&i>=0&&i<15&&"F"===T[l][i]){A.row=l,A.col=i,he();let e=Math.floor((Date.now()-U)/1e3),t=oe(e,c);return t>j[c]&&(j[c]=t,localStorage.setItem("tbce_levelStars",JSON.stringify(j))),e<V[c]&&(V[c]=e,localStorage.setItem("tbce_levelTimes",JSON.stringify(V))),F=!1,void ge()}}for(let[e,t]of[[2,0],[-2,0],[0,2],[0,-2]]){let l=A.row+e,i=A.col+t;if(l>=0&&l<7&&i>=0&&i<15&&"B"===p[l][i])return A.row=l,A.col=i,p[l][i]=null,g=Math.round(60/d),void se()}if(x&&S){let e=ue(A.row,A.col,x.row,x.col);if(e&&e.length>0){let t=e[0];return D={dr:t.row-A.row,dc:t.col-A.col},A.row=t.row,A.col=t.col,fe(),g=I,void(A.row===x.row&&A.col===x.col&&(p[x.row][x.col]=null,x=null))}}let e=function(e,t){for(let[l,i]of[[0,1],[1,0],[0,-1],[-1,0]]){let o=e,n=t;for(;o+=l,n+=i,!(o<0||o>=7||n<0||n>=15||"M"===T[o][n]||"X"===p[o][n]);)if("D"===p[o][n])return[o,n]}return null}(A.row,A.col);if(e){let[t,l]=e;return D={dr:t-A.row,dc:l-A.col},t!==A.row?A.row+=Math.sign(t-A.row):l!==A.col&&(A.col+=Math.sign(l-A.col)),t===A.row&&l===A.col&&(p[t][l]=null),fe(),void(g=Math.round(Math.floor(30*Math.random()+10)/d))}let t=X.filter(e=>Math.abs(e.row-A.row)+Math.abs(e.col-A.col)===1);if(t.length>0){let e=t[0];D={dr:e.row-A.row,dc:e.col-A.col},A.row=e.row,A.col=e.col,g=I}}(),function(){if(!x)return;if(w>0)return void w--;let e=[],t=new Set,l=[[x.row,x.col]],i=(e,t)=>`${e},${t}`;for(;l.length>0;){let[o,n]=l.shift();!(o<0||o>=T.length||n<0||n>=T[0].length||"M"===T[o][n]||"X"===p[o][n]||o===A.row&&n===A.col||t.has(i(o,n)))&&(t.add(i(o,n)),e.push([o,n]),l.push([o-1,n]),l.push([o+1,n]),l.push([o,n-1]),l.push([o,n+1]))}if(0===e.length)return;let o=e.map(([e,t])=>{let l=ue(e,t,A.row,A.col);return{cell:[e,t],distance:l?l.length:1/0}});o.sort((e,t)=>t.distance-e.distance);let n=o[0].cell,r=new Set([`${A.row},${A.col}`]),a=ue(x.row,x.col,n[0],n[1],r);if(a&&a.length>0){"O"===p[x.row][x.col]&&(p[x.row][x.col]=null);let e=a[0];x.row=e.row,x.col=e.col}w=I}(),x&&A.row===x.row&&A.col===x.col&&(p[x.row][x.col]=null,x=null)),requestAnimationFrame(e)}()</script>