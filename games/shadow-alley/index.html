<!doctype html><meta content="width=device-width" name=viewport><title>Shadow Alley - js13kGames 2025</title><style>#hud,.hint{opacity:.8}#tutorial,.kbd{background:#0f1320}body,html{height:100%;margin:0;background:#0b0d12;color:#dbe0ea;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}.wrap{display:grid;place-items:center;height:100%;gap:12px}canvas{background:#121621;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.45),inset 0 0 0 1px rgba(255,255,255,.04)}.hint{font-size:14px}.kbd{padding:2px 6px;border:1px solid #384152;border-bottom-width:2px;border-radius:6px;color:#c7cee0}a{color:#9ec5ff;text-decoration:none}#hud{width:100%;text-align:center;font:14px system-ui,sans-serif;color:#dbe0ea;pointer-events:none;margin-bottom:4px}#tutorial{border:1px solid #384152;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35),inset 0 0 0 1px rgba(255,255,255,.04);padding:12px;opacity:0}</style><div class=wrap><div id=hud>Level: <span class=kbd id=levelCount></span> · Fish: <span class=kbd id=fishCount></span> · <span id=doorState></span></div><canvas aria-label="Shadow Alley" height=320 id=game width=480></canvas><div class=hint id=tutorial></div><div class=hint id=levelSelectWrapper style=margin-top:6px;text-align:center><label for=levelSelect>Select Level:</label> <select class=kbd id=levelSelect style=min-width:140px></select></div><div class=hint>Controls: <span class=kbd>WASD</span>/<span class=kbd>Arrows</span> · Restart: <span class=kbd>R</span> · Mute: <span class=kbd>M</span></div></div><script>const e=["##############################\n#............f............x..#\n#..####....####.......####...#\n#..#..#................#.....#\n#..#..#................#.....#\n#..####................#.....#\n#............................#\n#.####..####..####..####.....#\n#............................#\n#............................#\n#..........####..............#\n#..........#..#..............#\n#..........#..#..............#\n#..####....####..####..####..#\n#..#..#..................#...#\n#..#..#..................#...#\n#..####..................#...#\n#c...........................#\n#..f.........................#\n##############################","##############################\n#....l.......f...............#\n#......####...........####...#\n#.....................#..#...#\n#.........####........#..#...#\n#.....................#..#...#\n#..##.........l.......####...#\n#............................#\n#............f...............#\n#..l.....####............l...#\n#........#..#..............###\n#.######.#..#...........#....#\n#........####...........#....#\n#.......................#....#\n#..............l........#....#\n#...........#...........#....#\n#...........#...........#....#\n#c..........#......f....#....#\n#...........#...........#.x..#\n##############################","##############################\n#....l..........f...l........#\n#............................#\n#.x.....####.................#\n#.......................####.#\n#...####......####...........#\n#........l........####.......#\n#.................#..#.......#\n#......f..........#..#.......#\n#.................####...l...#\n#............................#\n#....L......###...........f..#\n#.####........#..............#\n#.#..#........#..........#####\n#.#..#...................#...#\n#.####........L..........#...#\n#........................#...#\n#c.......................#...#\n#...................f....#...#\n##############################","##############################\n#...................s........#\n#............................#\n#.....####l...........#..###.#\n#l....#..#............#......#\n#.....####............#......#\n#.....................#......#\n#.....####...............###.#\n#........................#.#f#\n#.f.......s......L.......#.#.#\n#...........##...........###.#\n######.......................#\n#....#.......................#\n#....#.............s...s.....#\n######..........###......#####\n#.x.L...........#........#...#\n#.c......f......#s.......#...#\n#........s......#f.......#...#\n#...............#..l.....#...#\n##############################","##############################\n#........#..#...#............#\n#........#..#...#............#\n#l.......####...L.....l......#\n#........f...................#\n#........####.........s......#\n#............................#\n#.#......s...####.......##...#\n#.#...####......#.......##...#\n#x#L..#..#..s.c.#.......##..f#\n#.#...#..#......#.......##...#\n#.#...####......#.......##...#\n#........s...####.......##...#\n#............................#\n#........####.........s......#\n#........f...................#\n#........####...L............#\n#l.......#..#...#............#\n#........#..#...#.....l......#\n##############################","##############################\n#.........#...#..#.......#...#\n#.........#...#f.#.......#...#\n#f........#####..#########...#\n#.L.......s..............#...#\n#....###.......###.s.....#...#\n#..............#.#.......#...#\n#..............#.#.......#...#\n#l......####...###.......#####\n#................L.......s..c#\n#.....s###...............#####\n#####..###....###........#...#\n#...#.........#.#........#...#\n#...#f.l......#.#........#...#\n#...#..###....###........#...#\n#...#..#........f........#...#\n#...#..#l.......s#########...#\n#...#..###.......#.......#...#\n#...#...x#.......#.......#...#\n##############################","##############################\n#...........................c#\n#.############################\n#.......s....................#\n#.L............f.............#\n############################.#\n#...#.....#.......f..........#\n#.#.#.....#......###.........#\n#.#.#.....l......#.#....######\n#.#s.f...........###.L..#....#\n#.#.#.....s.............#....#\n#.#.#..####.........###s#....#\n#.#.L..#..#...###.......#....#\n#.#.#..####.............######\n#.#.#........................#\n#.#.#...s....................#\n#.#.#......#...l......###....#\n#.#.#f.....#..###.....#.#....#\n#x#........#..........#.#..f.#\n##############################","##############################\n#........#...#f.........s...f#\n#........#...#s.......####...#\n#l.......#...#........#..#...#\n#...f....#...#........####...#\n#...####.#####L..............#\n#............................#\n#............................#\n#....................ssss....#\n#x...........................#\n#.........c......###..L......#\n#l.......###.................#\n#####........###.............#\n#...#......L.................#\n#...#........................#\n#...#..................####..#\n#...#.....#####........#..#..#\n#...#f....#...#........####..#\n#...#.....#...#.....s.......f#\n##############################","##############################\n#f.........###L....#.#.#...#f#\n#s...###...#.#.....#.#.#...#.#\n#....l.....###.....###.#...#.#\n#..###.......f.........#...#.#\n#....s.....#####.###...#...#.#\n####.......#...#.......#...#.#\n#..........#...#.......#####.#\n#x.........#####.............#\n#.........................####\n#L..........c....l........#..#\n#####......###............####\n#...#......#.#...............#\n#####......#.#.###.......##..#\n#..........###.......###.....#\n#.l..........................#\n#..##...................l##..#\n#s.....##..............####..#\n#f............L.......s.....f#\n##############################"],t=["Collect all fish and head to the door.","Watch out for fixed lamps — stay in the shadows, collect all fish, then reach the door.","Moving guards with light cones — timing matters! Collect all fish and reach the door.","Use hiding spots (bluish patches), avoid light cones, collect all fish, and reach the door."];function n(){if(C){C.innerHTML="";for(let t=0;t<e.length;t++){const e=document.createElement("option");e.value=t,e.textContent=`Level ${t+1}`,t>G.unlocked&&(e.disabled=1),t===w&&(e.selected=1),C.appendChild(e)}}}function l(e,t,n){return Math.max(t,Math.min(n,0|e))}function a(){try{localStorage.setItem(V,JSON.stringify(G))}catch(e){}}function o(){const t=e.length-1,n=Math.min(w+1,t);G.unlocked<n&&(G.unlocked=n,a())}function i(e){B.length=W.length=E.length=O.length=F.length=0,J=0,_=0,U=0,K=0,e.split("\n").forEach((e,t)=>{for(let n=0;n<e.length;n++){const l=e[n],a=n*A,o=t*A;if("#"==l)B.push({x:a,y:o,w:A,h:A});else if("s"==l)W.push({x:a,y:o,w:A,h:A,glowIntensity:0});else if("l"==l)E.push({x:a+8,y:o+8,range:120,fov:Math.PI/3,angle:0,offX:10,offY:-11});else if("L"==l){const e=["#cc4455","#4aa3ff","#7bd389","#f2b134","#d45ed4","#ff8c00","#88cfff","#00bfff","#3cb371"],t=e[Math.floor(Math.random()*e.length)];O.push({x:a+8,y:o+8,range:160,fov:Math.PI/2,angle:0,dir:1,sweep:.9,accent:t})}else"f"==l?F.push({x:a+8,y:o+8,t:1,dir:.5>Math.random()?0:Math.PI,p:6.28*Math.random(),anim:0,cycle:1.5+3*Math.random()}):"x"==l?D={x:a,y:o,w:A,h:A}:"c"==l&&(N.x=a+8,N.y=o+8)}}),z=F.length}function r(){o();const t=e.length-1;w=t>w?Math.min(G.unlocked,t):t,G.current=w,a(),i(e[w]),ae=0,oe=0,U=0,_=0,te=null,n(),p()}function c(e,t,n){return t>e?t:e>n?n:e}function s(e,t,n){return!(e<n.x||e>n.x+n.w||t<n.y||t>n.y+n.h)}function f(e,t,n){for(let l=0;l<n.length;l++)if(s(e,t,n[l]))return 1;return 0}function h(e,t){return f(e,t,W)}function d(e,t,n,l,a,o,i){const r=e-n,c=t-l;if(Math.hypot(r,c)>i)return 0;const s=Math.atan2(c,r),f=Math.atan2(Math.sin(s-a),Math.cos(s-a));return Math.abs(f)<=.5*o}function u(e,t){for(const n of E)if(d(e,t,n.x+(n.offX||0),n.y+(n.offY||0),0,n.fov,n.range))return 1;for(const n of O)if(d(e,t,n.x,n.y,n.angle,n.fov,n.range))return 1;return 0}function y(){if(ce)return;ce=1,ie=new(window.AudioContext||window.webkitAudioContext),re=ie.createGain(),re.gain.value=se?0:.7,re.connect(ie.destination),fe=ie.createGain(),fe.gain.value=.05,ge=ie.createStereoPanner(),ge.pan.value=0,fe.connect(ge).connect(re);const e=g(1),t=ie.createBiquadFilter();t.type="lowpass",t.frequency.value=700,t.Q.value=1e-4;const n=ie.createBiquadFilter();n.type="lowshelf",n.frequency.value=180,n.gain.value=8;const l=ie.createBiquadFilter();l.type="highshelf",l.frequency.value=1500,l.gain.value=-24;const a=ie.createGain();a.gain.value=.9,e.connect(t).connect(n).connect(l).connect(a).connect(fe);const o=g(1),i=ie.createBiquadFilter();i.type="bandpass",i.frequency.value=900,i.Q.value=.8;const r=ie.createBiquadFilter();r.type="highshelf",r.frequency.value=1500,r.gain.value=-12;const c=ie.createGain();c.gain.value=.35,o.connect(i).connect(r).connect(c).connect(fe),he=ie.createOscillator(),he.frequency.value=.5,de=ie.createGain(),de.gain.value=.04,he.connect(de).connect(fe.gain),ue=ie.createOscillator(),ue.frequency.value=.12,ye=ie.createGain(),ye.gain.value=.18,ue.connect(ye).connect(ge.pan);const s=ie.currentTime;e.start(s),o.start(s),he.start(s),ue.start(s),(()=>{if(!ie||me)return;be=ie.createGain(),be.gain.value=.05,pe=ie.createGain(),pe.gain.value=0,me=ie.createOscillator(),me.type="triangle",me.frequency.value=440,me.connect(pe).connect(be).connect(re);const e=ie.currentTime;me.start(e);const t=[440,523.25,587.33,659.25,783.99,880];!function e(){!function(){if(!ie)return;const e=ie.currentTime;Me=(()=>{if(.72>Math.random()){const e=[-1,0,1][Math.floor(3*Math.random())];let n=Me+e;return n=Math.max(0,Math.min(t.length-1,n)),n}return Math.floor(Math.random()*t.length)})();const n=t[Me]*(.08>Math.random()?.5:1);me.frequency.cancelScheduledValues(e),me.frequency.setValueAtTime(me.frequency.value,e),me.frequency.exponentialRampToValueAtTime(Math.max(60,n),e+.12),pe.gain.cancelScheduledValues(e),pe.gain.setValueAtTime(0,e),pe.gain.linearRampToValueAtTime(.12,e+.04),pe.gain.exponentialRampToValueAtTime(1e-4,e+.35)}();const n=.6+.2*Math.random();Te=setTimeout(e,1e3*n)}()})()}function g(e=0){const t=(ie||new(window.AudioContext||window.webkitAudioContext)).createBuffer(1,Math.floor(44100),44100),n=t.getChannelData(0);for(let e=0;e<n.length;e++)n[e]=.6*(2*Math.random()-1);const l=ie.createBufferSource();return l.buffer=t,l.loop=!!e,l}function m(){ie&&setTimeout(()=>{ie.suspend()},500)}function p(){ie&&setTimeout(()=>{ie.resume()},500)}function b(e,t){const n=e.range,l=e.fov,a=t?0:e.angle,o=t&&null!=e.offX?e.x+e.offX:e.x,i=t&&null!=e.offY?e.y+e.offY:e.y,r=a-l/2,c=a+l/2,s=k.createRadialGradient(o,i,8,o,i,n);s.addColorStop(0,"rgba(255,220,120,0.45)"),s.addColorStop(.7,"rgba(255,210,110,0.18)"),s.addColorStop(1,"rgba(255,200,100,0.0)"),k.save(),k.fillStyle=s,k.beginPath(),k.moveTo(o,i),k.lineTo(o+Math.cos(r)*n,i+Math.sin(r)*n),k.arc(o,i,n,r,c),k.closePath(),k.fill(),k.restore()}function T(e){const{x:t,y:n,dir:l,p:a,anim:o}=e,i=le,r=1+1.2*o,c=Math.sin(7*i+(a||0))*(.7*r),s=Math.sin(1.6*i+(a||0))*(.9*(.5+.5*r)),f=Math.sin(2.2*i+1.3*(a||0))*(.05*r),h=1+f,d=1-.7*f;k.save();const u=k.createRadialGradient(t,n,0,t,n,10);u.addColorStop(0,"rgba(255,214,102,0.16)"),u.addColorStop(1,"rgba(255,214,102,0)"),k.fillStyle=u,k.fillRect(t-12,n-12,24,24),k.restore(),k.save(),k.translate(t,n+s);const y=l&&.001>Math.abs(l-Math.PI);k.scale((y?-1:1)*h,d),k.fillStyle="#ffd166",k.beginPath(),k.ellipse(0,0,9*.6,3,0,0,2*Math.PI),k.fill(),k.strokeStyle="rgba(50,60,80,0.35)",k.lineWidth=.8,k.stroke(),k.fillStyle="#eab54a",k.beginPath(),k.moveTo(.6*-9,0),k.lineTo(.6*-9-3.5,2+c),k.lineTo(.6*-9-3.5,-2-c),k.closePath(),k.fill(),k.fillStyle="#f6c255",k.save(),k.translate(1.2,-2.25),k.rotate(.1*c),k.beginPath(),k.moveTo(-2.2,0),k.lineTo(1.8,-3),k.lineTo(3.2,0),k.closePath(),k.fill(),k.restore(),o>.05&&(k.fillStyle="rgba(80,70,60,0.25)",k.beginPath(),k.ellipse(-1.5,.2,1.2*(1+.6*o),1,0,0,2*Math.PI),k.fill()),k.fillStyle="#4b4f5a",k.beginPath(),k.arc(9*.28,-.4,.7,0,2*Math.PI),k.fill(),k.globalAlpha=.28+.22*o,k.fillStyle="#ffffff",k.beginPath(),k.ellipse(.45,-1.25,2,1,0,0,2*Math.PI),k.fill(),k.globalAlpha=1,k.restore()}function M(e){const{x:t,y:n,angle:l,accent:a}=e,o=le;k.save(),k.translate(t,n),k.rotate(l);const i=.72;k.fillStyle="rgba(0,0,0,0.35)",k.beginPath(),k.ellipse(0,6*i,8*i,2.6*i,0,0,2*Math.PI),k.fill();const r="#4f4436",c=a||"#cc4455";k.fillStyle=r,k.beginPath(),k.ellipse(-1*i,0,9*i,6*i,0,0,2*Math.PI),k.fill(),k.fillStyle="#3f362c",k.beginPath(),k.ellipse(-2*i,2.6*i,4.608,2.6*i,0,0,2*Math.PI),k.fill();const s=3.8*i;k.fillStyle=r,k.beginPath(),k.ellipse(s,-.72,2.592,1.7999999999999998,0,0,2*Math.PI),k.fill(),k.strokeStyle=c,k.lineWidth=.864,k.beginPath(),k.ellipse(s,-.648,2.4624,.99,0,0,2*Math.PI),k.stroke(),k.fillStyle="#ffd166",k.beginPath(),k.arc(s-.2*2.592,.72,.648,0,2*Math.PI),k.fill(),k.fillStyle=r,k.beginPath(),k.ellipse(7.6*i,-1.584,3.312,2.592,0,0,2*Math.PI),k.fill(),k.fillStyle="#c7ab92",k.beginPath(),k.moveTo(6.912,-3*i),k.lineTo(9.072,-2.016),k.lineTo(9.072,-.864),k.lineTo(6.912,-1.3*i),k.closePath(),k.fill(),k.beginPath(),k.ellipse(12.7*i,-2*i,1*i,1*i,0,0,2*Math.PI),k.fill(),k.fillStyle="#1b1f28",k.beginPath(),k.arc(9.648,-2*i,.54,0,2*Math.PI),k.fill();const f=.18*Math.sin(5.2*o)*i;k.fillStyle=r,k.beginPath(),k.moveTo(4.752,-5.2*i),k.lineTo(5.616,-5.688-f),k.lineTo(9*i,-5*i),k.closePath(),k.fill(),k.globalAlpha=.85,k.beginPath(),k.moveTo(4.104,-3.528),k.lineTo(4.968,-7.3*i+.6*f),k.lineTo(7.6*i,-3.384),k.closePath(),k.fill(),k.globalAlpha=1,k.fillStyle="#12151b",k.beginPath(),k.arc(7.056,-3*i,.432,0,2*Math.PI),k.fill();const h=2.304,d=Math.sin(4.8*o);k.fillStyle=r,k.fillRect(3.168,h+-.2*d*i,1.152,2.592),k.fillRect(6.2*i,h+.2*d*i,1.152,2.592),k.fillRect(-3.888,h+.2*d*i,1.296,3.8*i),k.fillRect(-2.448,h+-.2*d*i,1.296,3.8*i);const u=.5*Math.sin(9.5*o)*i;k.strokeStyle=r,k.lineWidth=2,k.beginPath(),k.moveTo(-9*i,-.432),k.quadraticCurveTo(-8.352,-4*i+u,-6.048,-4.896+u),k.stroke(),k.restore()}function x(e){const{x:t,y:n}=e;k.save(),k.fillStyle="rgba(0,0,0,0.25)",k.beginPath(),k.ellipse(t,n+8,6,2,0,0,2*Math.PI),k.fill(),k.fillStyle="#2a3140",k.fillRect(t-1,n-12,2,16),k.fillRect(t+0,n-10,8,2);const l=t+(e.offX??10),a=n+(e.offY??-11);k.fillStyle="#232a38",k.fillRect(l-5,a-3,10,6),k.fillStyle="#1d2330",k.fillRect(l-4,a-5,8,2),k.fillStyle="rgba(255,236,170,0.9)",k.fillRect(l-4,a-2,8,4),k.fillStyle="#1d2330",k.fillRect(l-1,a-6,2,1),k.fillStyle="#2a3140",k.fillRect(t-3,n+3,6,2);const o=l+2,i=a,r=k.createRadialGradient(o,i,0,o,i,12);r.addColorStop(0,"rgba(255,236,170,0.30)"),r.addColorStop(1,"rgba(255,236,170,0.0)"),k.fillStyle=r,k.fillRect(l-26,a-26,52,52),k.restore()}function S(e){function t(){return y=1e4*Math.sin(y),y-Math.floor(y)}const n=e.x,l=e.y,a=e.w,o=e.h,i=le||0;k.save(),k.fillStyle="rgba(8,14,24,0.78)",k.fillRect(n,l,a,o);const r=n+.5*a,c=l+.5*o,s=k.createRadialGradient(r,c,2,r,c,.75*Math.max(a,o));s.addColorStop(0,"rgba(0,0,0,0.38)"),s.addColorStop(.65,"rgba(0,0,0,0.2)"),s.addColorStop(1,"rgba(0,0,0,0)"),k.fillStyle=s,k.fillRect(n-8,l-8,a+16,o+16);let f=k.createLinearGradient(n,l,n,l+7);f.addColorStop(0,"rgba(0,0,0,0.65)"),f.addColorStop(1,"rgba(0,0,0,0.0)"),k.fillStyle=f,k.fillRect(n,l,a,7),f=k.createLinearGradient(n,l+o,n,l+o-7),f.addColorStop(0,"rgba(0,0,0,0.55)"),f.addColorStop(1,"rgba(0,0,0,0.0)"),k.fillStyle=f,k.fillRect(n,l+o-7,a,7),f=k.createLinearGradient(n,l,n+7,l),f.addColorStop(0,"rgba(0,0,0,0.6)"),f.addColorStop(1,"rgba(0,0,0,0.0)"),k.fillStyle=f,k.fillRect(n,l,7,o),f=k.createLinearGradient(n+a,l,n+a-7,l),f.addColorStop(0,"rgba(0,0,0,0.6)"),f.addColorStop(1,"rgba(0,0,0,0.0)"),k.fillStyle=f,k.fillRect(n+a-7,l,7,o),k.strokeStyle="rgba(120,170,220,0.12)",k.lineWidth=1,k.strokeRect(n+.5,l+.5,a-1,o-1),k.globalAlpha=.08,k.fillStyle="#5f6d85";const h=n/a|0,d=l/o|0;let y=1e4*Math.sin(91*(h+31)+57*(d+17)+.8*i);for(let e=0;8>e;e++){const e=n+Math.floor(t()*a),i=l+Math.floor(t()*o);k.fillRect(e,i,1,1)}k.globalAlpha=1;const g=n+.5*a,m=l+.5*o,p=u(g,m)?1:0;if("number"!=typeof e.glowIntensity&&(e.glowIntensity=0),e.glowIntensity+=.08*(p-e.glowIntensity),e.glowIntensity>.01){const t=.18*(.6+.4*(.5+.5*Math.sin(1.6*(le||0))))*e.glowIntensity,i=k.createRadialGradient(g,m,2,g,m,1.2*Math.max(a,o));i.addColorStop(0,`rgba(120,170,255,${t})`),i.addColorStop(1,"rgba(120,170,255,0)"),k.fillStyle=i,k.fillRect(n-12,l-12,a+24,o+24)}k.restore()}function P(e,t,n){k.fillStyle="rgba(0,0,0,0.6)",k.fillRect(0,0,R,I),k.textAlign="center",k.fillStyle=e,k.font="bold 24px system-ui, sans-serif",k.fillText(t,R/2,I/2-6),k.fillStyle="#dbe0ea",k.font="14px system-ui, sans-serif",k.fillText(n,R/2,I/2+16),k.textAlign="left"}const v=document.getElementById("game"),k=v.getContext("2d"),R=v.width,I=v.height,A=16;Math.floor(R/A),Math.floor(I/A);let w=0;const C=document.getElementById("levelSelect"),q=document.getElementById("levelSelectWrapper"),L=document.getElementById("hud");C&&C.addEventListener("change",()=>{const t=parseInt(C.value,10);Number.isNaN(t)||t>G.unlocked||(w=t,G.current=t,a(),i(e[w]),ae=0,oe=0,U=0,_=0,te=null),n()});const V="js13k_shadowalley_v1";let G={current:0,unlocked:0},B=[],W=[],E=[],O=[],F=[],D={x:R-32,y:16,w:A,h:A};const N={x:64,y:I-64,r:6,speed:1.7,vx:0,vy:0,dir:"R",step:0,state:"idle",idle:0,blink:1,blinkTimer:2,fpTimer:0,pawParity:0,db:0},Y=[],$=[],X=[],j=[{x:80,y:60,dx:.06,dy:.02,r:90,a:.12},{x:240,y:140,dx:-.04,dy:.03,r:120,a:.1},{x:380,y:220,dx:.03,dy:-.05,r:100,a:.09}];let H=0;const Q=[];let z=0,J=0,U=0,_=0,K=0,Z=1;(()=>{try{const e=localStorage.getItem(V);if(e){const t=JSON.parse(e);"object"==typeof t&&t&&(G={current:0|t.current,unlocked:0|t.unlocked})}}catch(t){}const t=e.length-1;G.unlocked=l(G.unlocked,0,t),G.current=l(G.current,0,G.unlocked)})(),w=l(G.current,0,Math.max(0,Math.min(G.unlocked,e.length-1))),i(e[w]),n();const ee=Object.create(null);addEventListener("keydown",t=>{if(ee[t.key]=1,Z&&("Enter"===t.key||" "===t.key||"Space"===t.code))return Z=0,y(),p(),q.style.opacity="1",void(L.style.opacity="1");ce||y(),"m"!==t.key&&"M"!==t.key||(se=!se,re&&(re.gain.value=se?0:.7)),"r"!==t.key&&"R"!==t.key||(K?(w=0,G.current=0,a(),i(e[w]),ae=0,oe=0,U=0,_=0,K=0,te=null,n(),p()):(i(e[w]),ae=0,oe=0,N.vx=N.vy=0,K=0,G.current=w,a(),n(),p())),"n"!==t.key&&"N"!==t.key||!_||r()}),addEventListener("keyup",e=>ee[e.key]=0);let te=null,ne=performance.now(),le=0,ae=0,oe=0,ie=null,re=null,ce=0,se=0,fe=null,he=null,de=null,ue=null,ye=null,ge=null,me=null,pe=null,be=null,Te=null,Me=0,xe=0;const Se={collect(){if(!ie)return;const e=ie.currentTime,t=ie.createGain();t.gain.setValueAtTime(0,e),t.gain.linearRampToValueAtTime(.25,e+.005),t.gain.exponentialRampToValueAtTime(1e-4,e+.18);const n=ie.createOscillator();n.type="sine",n.frequency.setValueAtTime(880,e),n.frequency.exponentialRampToValueAtTime(1320,e+.12);const l=ie.createOscillator();l.type="sine",l.frequency.setValueAtTime(660,e+.02),l.frequency.exponentialRampToValueAtTime(990,e+.18),n.connect(t),l.connect(t),t.connect(re),n.start(e),n.stop(e+.2),l.start(e+.02),l.stop(e+.22)},door(){if(!ie)return;const e=ie.currentTime,t=g(),n=ie.createGain();n.gain.setValueAtTime(0,e),n.gain.linearRampToValueAtTime(.2,e+.05),n.gain.exponentialRampToValueAtTime(1e-4,e+.6);const l=ie.createBiquadFilter();l.type="bandpass",l.frequency.value=1200,l.Q.value=.8,t.connect(l).connect(n).connect(re),t.start(e),t.stop(e+.65);const a=ie.createOscillator();a.type="sine",a.frequency.setValueAtTime(180,e),a.frequency.exponentialRampToValueAtTime(90,e+.5);const o=ie.createGain();o.gain.setValueAtTime(0,e),o.gain.linearRampToValueAtTime(.12,e+.1),o.gain.exponentialRampToValueAtTime(1e-4,e+.6),a.connect(o).connect(re),a.start(e),a.stop(e+.65)},alert(){if(!ie)return;const e=ie.currentTime,t=ie.createOscillator();t.type="square",t.frequency.setValueAtTime(340,e),t.frequency.exponentialRampToValueAtTime(160,e+.08);const n=ie.createGain();n.gain.setValueAtTime(0,e),n.gain.linearRampToValueAtTime(.28,e+.005),n.gain.exponentialRampToValueAtTime(1e-4,e+.15),t.connect(n).connect(re),t.start(e),t.stop(e+.16);const l=g(),a=ie.createGain();a.gain.setValueAtTime(.2,e),a.gain.exponentialRampToValueAtTime(1e-4,e+.06),l.connect(a).connect(re),l.start(e),l.stop(e+.08)},footstep(e){if(!ie)return;const t=ie.currentTime,n=ie.createBuffer(1,Math.floor(.05*ie.sampleRate),ie.sampleRate),l=n.getChannelData(0);for(let e=0;e<l.length;e++){const t=Math.exp(-e/180),n=.5*(2*Math.random()-1);l[e]=n*t}const a=ie.createBufferSource();a.buffer=n;const o=ie.createBiquadFilter();o.type="lowpass",o.frequency.value=1100+200*Math.random();const i=ie.createBiquadFilter();i.type="highshelf",i.frequency.value=2e3,i.gain.value=-10;const r=ie.createGain(),c=.16+.05*Math.random();r.gain.value=e?.55*c:c,a.connect(o).connect(i).connect(r).connect(re),a.start(t)},success(){if(!ie)return;const e=ie.currentTime;[523.25,659.25,783.99].forEach(t=>{const n=ie.createOscillator();n.type="sine",n.frequency.value=t;const l=ie.createGain();l.gain.setValueAtTime(0,e),l.gain.linearRampToValueAtTime(.15,e+.02),l.gain.exponentialRampToValueAtTime(1e-4,e+.25),n.connect(l).connect(re),n.start(e),n.stop(e+.3)})}};requestAnimationFrame(function n(l){const i=(l-ne)/1e3;ne=l,le+=i,(t=>{if(Z)return;if(U||_||K)return _&&null!=te&&le>=te?void r():void 0;let n=0,l=0;if((ee.ArrowLeft||ee.a||ee.A)&&(n-=1),(ee.ArrowRight||ee.d||ee.D)&&(n+=1),(ee.ArrowUp||ee.w||ee.W)&&(l-=1),(ee.ArrowDown||ee.s||ee.S)&&(l+=1),n||l){const e=Math.hypot(n,l);n/=e,l/=e}const i=60*N.speed*t;let u=c(N.x+n*i,N.r+1,R-N.r-1);f(u,N.y,B)||(N.x=u),u=c(N.y+l*i,N.r+1,I-N.r-1),f(N.x,u,B)||(N.y=u),-.01>n?N.dir="L":n>.01&&(N.dir="R"),n||l?N.step+=8*t:N.step=0;const y=!(!n&&!l),g=h(N.x,N.y);if(y?(N.idle=0,N.state=g?"crouch":"walk"):(N.idle+=t,g?N.state="crouch":N.idle>.8?N.state="sit":N.state="idle"),N.blinkTimer-=t,N.blinkTimer>0||(N.blink>.5?(N.blink=0,N.blinkTimer=.1):(N.blink=1,N.db?(N.db=0,N.blinkTimer=1.8+2.2*Math.random()):.25>Math.random()&&"walk"!==N.state?(N.db=1,N.blinkTimer=.2):N.blinkTimer=1.8+2.2*Math.random())),(n||l)&&(N.fpTimer-=t,0>=N.fpTimer)){const e=Math.hypot(n,l)||1,t=n/e,a=l/e,o=N.pawParity?1:-1,i=N.x-6*t+3*-a*o,r=N.y-6*a+3*t*o;if(Y.push({x:i,y:r,life:1}),N.fpTimer=.14,N.pawParity^=1,ce&&ie){const e=ie.currentTime;if((n||l)&&e-xe>.25){const t=h(N.x,N.y);Se.footstep(t),xe=e}}}for(let e=Y.length-1;e>=0;e--)Y[e].life-=.35*t,Y[e].life>0||Y.splice(e,1);for(const e of F)if(e.t){if(e.cycle-=t,0>=e.cycle){e.anim=1,e.cycle=1.8+2.8*Math.random(),.2>Math.random()&&(e.dir=0===e.dir?Math.PI:0);for(let t=0;3>t;t++){const t=(0===e.dir?1:-1)*(3.5+Math.random()),n=1*Math.random()-.5;Q.push({x:e.x+t,y:e.y+n,vy:-20-15*Math.random(),life:.9})}}e.anim>0&&(e.anim=Math.max(0,e.anim-1.5*t))}for(let e=Q.length-1;e>=0;e--){const n=Q[e];n.y+=n.vy*t,n.life-=.7*t,n.life>0&&n.y>=0||Q.splice(e,1)}if(H-=t,0>=H){for(let e=0;3>e;e++){const e=Math.random()*R,t=-10-40*Math.random(),n=220+80*Math.random(),l=-60-40*Math.random();$.push({x:e,y:t,vx:l,vy:n,len:10+8*Math.random()})}H=.05/.3}for(let e=$.length-1;e>=0;e--){const n=$[e];n.x+=n.vx*t,n.y+=n.vy*t,n.y>I-18?(X.push({x:n.x,y:I-18,life:1}),$.splice(e,1)):(-20>n.x||n.x>R+20||n.y>I+20)&&$.splice(e,1)}for(let e=X.length-1;e>=0;e--)X[e].life-=1.8*t,X[e].life>0||X.splice(e,1);for(const e of j)e.x+=e.dx,e.y+=e.dy,e.x<-e.r?e.x=R+e.r:e.x>R+e.r&&(e.x=-e.r),e.y<-e.r?e.y=I+e.r:e.y>I+e.r&&(e.y=-e.r);for(const e of O)e.angle+=e.dir*e.sweep*t,e.angle>1&&(e.angle=1,e.dir=-1),-1>e.angle&&(e.angle=-1,e.dir=1);const m=h(N.x,N.y);let p=0;for(const e of E)if(d(N.x,N.y,e.x+(e.offX||0),e.y+(e.offY||0),0,e.fov,e.range)){p=1;break}if(!p)for(const e of O)if(d(N.x,N.y,e.x,e.y,e.angle,e.fov,e.range)){p=1;break}p&&!m&&(!U&&ce&&Se.alert(),U=1);for(const e of F)e.t&&8>Math.hypot(N.x-e.x,N.y-e.y)&&(e.t=0,J++,ce&&Se.collect());if(J!==z||ae||(ce&&Se.door(),ae=1),J===z&&s(N.x,N.y,D)&&!_&&!K){const t=e.length-1;w===t?(K=1,_=0,ce&&!oe&&(Se.success(),oe=1),o(),G.current=Math.min(G.unlocked,t),a()):(_=1,ce&&!oe&&(Se.success(),oe=1),null==te&&(te=le+5),o(),G.current=Math.min(G.unlocked,e.length-1),a())}})(i),(()=>{const n=e.length-1;if(G.unlocked>n&&(G.unlocked=n),w>G.unlocked&&(w=G.unlocked),G.current!==w&&(G.current=w,a()),Z)return void(()=>{q.style.opacity="0",L.style.opacity="0",m(),k.clearRect(0,0,R,I);const e=k.createLinearGradient(0,0,0,I);e.addColorStop(0,"#0f1420"),e.addColorStop(1,"#0b0e17"),k.fillStyle=e,k.fillRect(0,0,R,I);const t=k.createRadialGradient(R/2,I/2,20,R/2,I/2,.7*Math.max(R,I));t.addColorStop(0,"rgba(0,0,0,0)"),t.addColorStop(1,"rgba(0,0,0,0.55)"),k.fillStyle=t,k.fillRect(0,0,R,I),k.textAlign="center",k.fillStyle="#dbe0ea",k.font="bold 28px system-ui, sans-serif",k.fillText("🐾 Shadow Alley 🐾",R/2,72),k.save(),k.translate(R/2,100),k.fillStyle="#0b0d12",k.beginPath(),k.ellipse(0,8,22,12,0,0,2*Math.PI),k.fill(),k.beginPath(),k.arc(14,2,6,0,2*Math.PI),k.fill(),k.beginPath(),k.moveTo(10.5,-1.5),k.lineTo(12.5,-6.5),k.lineTo(14,-1.5),k.closePath(),k.moveTo(17.5,-1.5),k.lineTo(15.5,-6.5),k.lineTo(14,-1.5),k.closePath(),k.fill(),k.beginPath(),k.moveTo(-18,6),k.quadraticCurveTo(-28,-2,-12,-6),k.strokeStyle="#0b0d12",k.lineWidth=3,k.stroke(),k.restore(),k.fillStyle="#b7c3d6",k.font="13px system-ui, sans-serif";const n=["The city never sleeps. Rain falls, lamps flicker, and dogs guard the alleys.","You are a lone black cat, hungry and unseen.","Sneak through the night, gather fish to survive,","and escape through the glowing door before the light finds you."];let l=170;for(const e of n)k.fillText(e,R/2,l),l+=18;k.fillStyle="#5fd08a",k.font="bold 14px system-ui, sans-serif",k.fillText("Press Enter or Space to begin",R/2,I-36),k.textAlign="left"})();k.clearRect(0,0,R,I);const l=k.createLinearGradient(0,0,0,I);l.addColorStop(0,"#0f1420"),l.addColorStop(1,"#0b0e17"),k.fillStyle=l,k.fillRect(0,0,R,I),k.fillStyle="rgba(0,0,0,0.0)",k.fillRect(0,0,R,I),k.fillStyle="#0b0d12";for(const e of B)k.fillRect(e.x,e.y,e.w,e.h);for(const e of W)S(e);const o=J===z;((e,t,n,l,a)=>{const o=e+n/2,i=t+l/2;if(k.save(),k.fillStyle="#0b0d12",k.fillRect(e,t,n,l),k.fillStyle="#141a22",k.fillRect(e+1,t+1,n-2,l-2),a){const a=2,r=e+a,c=t+a,s=n-2*a,f=l-2*a;k.fillStyle="#0a0f14",k.fillRect(r,c,s,f);const h=k.createRadialGradient(o,i,2,o,i,Math.max(n,l));h.addColorStop(0,"rgba(95,208,138,0.35)"),h.addColorStop(1,"rgba(95,208,138,0)"),k.fillStyle=h,k.fillRect(e-8,t-8,n+16,l+16),k.fillStyle="rgba(95,208,138,0.22)",k.beginPath();const d=o-.25*s,u=o+.25*s;k.moveTo(d,t+l),k.lineTo(u,t+l),k.lineTo(u+4,t+l+5),k.lineTo(d-4,t+l+5),k.closePath(),k.fill(),k.fillStyle="#23323b",k.strokeStyle="rgba(200,210,230,0.1)",k.lineWidth=1,k.beginPath();const y=r+.15*s,g=c+1;k.moveTo(y,g),k.lineTo(y+.55*s,g+.1*f),k.lineTo(y+.55*s,g+f-1),k.lineTo(y,g+f-2),k.closePath(),k.fill(),k.stroke();const m=.5*(Math.sin(3*le)+1),p=Math.max(1.5,3+3*m);k.fillStyle="#5fd08a",k.fillRect(o-p/2,c+2,p,f-4),k.strokeStyle="rgba(95,208,138,0.35)",k.lineWidth=1,k.strokeRect(e+.5,t+.5,n-1,l-1)}else{const a=2,o=e+a,i=t+a,r=n-2*a,c=l-2*a;k.fillStyle="#2a2f3a",k.fillRect(o,i,r,c),k.strokeStyle="rgba(200,210,230,0.12)",k.lineWidth=1,k.beginPath(),k.moveTo(o+.5*r,i+2),k.lineTo(o+.5*r,i+c-2),k.stroke(),k.beginPath(),k.moveTo(o+2,i+.35*c),k.lineTo(o+r-2,i+.35*c),k.moveTo(o+2,i+.7*c),k.lineTo(o+r-2,i+.7*c),k.stroke(),k.fillStyle="#c7cedd",k.beginPath(),k.arc(o+1.5,i+.25*c,.8,0,2*Math.PI),k.arc(o+1.5,i+.55*c,.8,0,2*Math.PI),k.fill(),k.beginPath(),k.arc(o+r-2.2,i+.5*c,1,0,2*Math.PI),k.fill(),k.strokeStyle="rgba(95,208,138,0.35)",k.lineWidth=1,k.strokeRect(e+.5,t+.5,n-1,l-1)}k.restore()})(D.x,D.y,D.w,D.h,o);for(const e of j){const t=k.createRadialGradient(e.x,e.y,0,e.x,e.y,e.r);t.addColorStop(0,`rgba(30,35,50,${e.a})`),t.addColorStop(1,"rgba(30,35,50,0)"),k.fillStyle=t,k.fillRect(0,0,R,I)}for(const e of E)b(e,1);for(const e of O)b(e,0);for(const e of E)x(e);for(const e of O)M(e);for(const e of Q)k.save(),k.globalAlpha=.25*Math.max(0,e.life),k.fillStyle="#bcd4ff",k.beginPath(),k.ellipse(e.x,e.y,1.2,1.2,0,0,2*Math.PI),k.fill(),k.restore();for(const e of F)e.t&&T(e);for(const e of X)k.save(),k.globalAlpha=.2*Math.max(0,e.life),k.strokeStyle="#8fa3c2",k.lineWidth=1,k.beginPath(),k.ellipse(e.x,e.y+1,4.5*(1-.6*e.life),1.2,0,0,2*Math.PI),k.stroke(),k.restore();for(const e of Y){let t=.18*Math.max(0,e.life);u(e.x,e.y)&&(t*=1.8),k.save(),k.globalAlpha=t,k.fillStyle="#7b8aa1",k.beginPath(),k.ellipse(e.x,e.y+2,3.2,1.4,0,0,2*Math.PI),k.fill(),k.restore()}const i=h(N.x,N.y);((e,t,n,l,a,o,i)=>{function r(e,t){const a=Math.max(.12,t);k.fillStyle=l?"rgba(255,230,120,0.25)":"#ffe678";const o=s+("R"===n?1.2:-1.2);k.beginPath(),k.ellipse(o-1.5,f-.5+(e||0),.9,.9*a,0,0,2*Math.PI),k.ellipse(o+1.5,f-.5+(e||0),.9,.9*a,0,0,2*Math.PI),k.fill()}function c(){k.strokeStyle=l?"rgba(200,210,230,0.25)":"rgba(200,210,230,0.55)",k.lineWidth=1,k.beginPath(),k.moveTo(s-4,f),k.lineTo(s-8,f-1),k.moveTo(s-4,f+2),k.lineTo(s-8,f+2),k.moveTo(s+4,f),k.lineTo(s+8,f-1),k.moveTo(s+4,f+2),k.lineTo(s+8,f+2),k.stroke()}k.save(),k.globalAlpha=l?.7:1;const s=e+("R"===n?5:-5),f=t-6;if("sit"===o)k.strokeStyle="#11131a",k.lineWidth=2,k.beginPath(),k.arc(e-("R"===n?6:-6),t+6,6,.2*Math.PI,1.6*Math.PI),k.stroke(),k.fillStyle="#0b0d12",k.beginPath(),k.ellipse(e,t+2,7,9,0,0,2*Math.PI),k.fill(),k.beginPath(),k.arc(s,f-2,4,0,2*Math.PI),k.fill(),k.beginPath(),k.moveTo(s-3,f-4),k.lineTo(s-1,f-8),k.lineTo(s,f-4),k.closePath(),k.moveTo(s+3,f-4),k.lineTo(s+1,f-8),k.lineTo(s,f-4),k.closePath(),k.fill(),k.fillStyle="#0c0e14",k.beginPath(),k.arc(e-3,t+8,1.2,0,2*Math.PI),k.arc(e+3,t+8,1.2,0,2*Math.PI),k.fill(),r(0,i),c();else if("crouch"===o){const l=2*Math.sin(a*Math.PI)*("R"===n?1:-1);k.fillStyle="#0b0d12",k.beginPath(),k.ellipse(e,t+3,9,4.5,0,0,2*Math.PI),k.fill(),k.beginPath(),k.arc(e+("R"===n?6:-6),t-3,3.6,0,2*Math.PI),k.fill();const o=e+("R"===n?6:-6),s=t-3;k.beginPath(),k.moveTo(o-3,s-1),k.lineTo(o-1,s-4),k.lineTo(o,s-1),k.closePath(),k.moveTo(o+3,s-1),k.lineTo(o+1,s-4),k.lineTo(o,s-1),k.closePath(),k.fill(),k.strokeStyle="#11131a",k.lineWidth=2,k.beginPath();const f=e-("R"===n?10:-10),h=t+5;k.moveTo(f,h),k.bezierCurveTo(f-4,h-1+l,f-8,h+1+l,f-2,h+2+l),k.stroke();const d=.6*Math.sin(2*a);k.fillStyle="#0c0e14",k.beginPath(),k.arc(e-3,t+6-d,1,0,2*Math.PI),k.arc(e+3,t+6+d,1,0,2*Math.PI),k.arc(e-1,t+5+d,1,0,2*Math.PI),k.arc(e+1,t+5-d,1,0,2*Math.PI),k.fill(),r(.8,i),c()}else{const l=3*Math.sin(a*Math.PI)*("R"===n?1:-1);k.fillStyle="#0b0d12",k.beginPath(),k.ellipse(e,t+1,8,6,0,0,2*Math.PI),k.fill(),k.beginPath(),k.arc(s,f,4,0,2*Math.PI),k.fill(),k.beginPath(),k.moveTo(s-3,f-2),k.lineTo(s-1,f-6),k.lineTo(s,f-2),k.closePath(),k.moveTo(s+3,f-2),k.lineTo(s+1,f-6),k.lineTo(s,f-2),k.closePath(),k.fill(),k.strokeStyle="#11131a",k.lineWidth=2,k.beginPath();const o=e-("R"===n?9:-9),h=t+1;k.moveTo(o,h),k.bezierCurveTo(o-4,h-2+l,o-6,h-6+l,o-2,h-8+l),k.stroke();const d=1.2*Math.sin(2*a);k.fillStyle="#0c0e14",k.beginPath(),k.arc(e-3,t+6-d,1,0,2*Math.PI),k.arc(e+3,t+6+d,1,0,2*Math.PI),k.arc(e-1,t+5+d,1,0,2*Math.PI),k.arc(e+1,t+5-d,1,0,2*Math.PI),k.fill(),r(0,i),c()}k.restore()})(N.x,N.y,N.dir,i,N.step,N.state,N.blink),k.save(),k.strokeStyle="rgba(170,190,220,0.35)",k.lineWidth=.5,k.beginPath();for(const e of $)k.moveTo(e.x,e.y),k.lineTo(e.x-.03*e.vx,e.y-.03*e.vy-e.len);k.stroke(),k.restore();const r=document.getElementById("fishCount"),c=document.getElementById("levelCount"),s=document.getElementById("doorState");r&&(r.textContent=`${J}/${z}`),c&&(c.textContent=`${w+1}/${e.length}`),s&&(s.textContent=o?"Door open":"Door closed");const f=document.getElementById("tutorial");f&&t[w]&&""!==t[w].trim()?(f.innerHTML="<strong>Level "+(w+1)+": </strong>"+t[w],f.style.opacity=1):(f.innerHTML="",f.style.opacity=0),U?(m(),P("#ffd166","Discovered!","R to Restart")):_?(m(),P("#5fd08a","Well Done!","All fish collected – continuing in 5s (Press N for instant)")):K&&(m(),P("#9ec5ff","Thanks for playing!","Press R to play again from Level 1"))})(),requestAnimationFrame(n)})</script>