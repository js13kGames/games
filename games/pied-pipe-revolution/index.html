<!doctype html><title>Pied Pipe Revolution - js13kGames 2023</title><style>body,html{background-color:#ddd;width:100vw;height:100vh;margin:0;padding:0}body{display:flex;align-items:center;justify-content:center}canvas{border:6px solid #333;border-radius:3px;width:400px;height:520px;image-rendering:crisp-edges}</style><canvas width=400 height=520></canvas><script>var y=()=>{},i={};function w(t,e){i[t]=i[t]||[],i[t].push(e)}function m(t,...e){(i[t]||[]).map(t=>t(...e))}var h,v,L={get:(t,e)=>"_proxy"==e||y};function Y(){return v}function R(t,e,i){return Math.min(Math.max(t,i),e)}var D=class y{constructor(t=0,e=0,i={}){null!=t.x?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e),i._c&&(this.clamp(i._a,i._b,i._d,i._e),this.x=t,this.y=e)}set(t){this.x=t.x,this.y=t.y}add(t){return new y(this.x+t.x,this.y+t.y,this)}subtract(t){return new y(this.x-t.x,this.y-t.y,this)}scale(t){return new y(this.x*t,this.y*t)}normalize(t=this.length()||1){return new y(this.x/t,this.y/t)}dot(t){return this.x*t.x+this.y*t.y}length(){return Math.hypot(this.x,this.y)}distance(t){return Math.hypot(this.x-t.x,this.y-t.y)}angle(t){return Math.acos(this.dot(t)/(this.length()*t.length()))}direction(){return Math.atan2(this.y,this.x)}clamp(t,e,i,s){this._c=!0,this._a=t,this._b=e,this._d=i,this._e=s}get x(){return this._x}get y(){return this._y}set x(t){this._x=this._c?R(this._a,this._d,t):t}set y(t){this._y=this._c?R(this._b,this._e,t):t}};function n(){return new D(...arguments)}var t=class extends class{constructor(t){return this.init(t)}init(t={}){this.position=n(),this.velocity=n(),this.acceleration=n(),this.ttl=1/0,Object.assign(this,t)}update(t){this.advance(t)}advance(t){let e=this.acceleration,i=(t&&(e=e.scale(t)),this.velocity=this.velocity.add(e),this.velocity);t&&(i=i.scale(t)),this.position=this.position.add(i),this._pc(),this.ttl--}get dx(){return this.velocity.x}get dy(){return this.velocity.y}set dx(t){this.velocity.x=t}set dy(t){this.velocity.y=t}get ddx(){return this.acceleration.x}get ddy(){return this.acceleration.y}set ddx(t){this.acceleration.x=t}set ddy(t){this.acceleration.y=t}isAlive(){return 0<this.ttl}_pc(){}}{init({width:t=0,height:e=0,context:i=Y(),render:s=this.draw,update:h=this.advance,children:o=[],anchor:n={x:0,y:0},opacity:r=1,rotation:a=0,scaleX:l=1,scaleY:c=1,...d}={}){this._c=[],super.init({width:t,height:e,context:i,anchor:n,opacity:r,rotation:a,scaleX:l,scaleY:c,...d}),this._di=!0,this._uw(),this.addChild(o),this._rf=s,this._uf=h,w("init",()=>{this.context||(this.context=Y())})}update(e){this._uf(e),this.children.map(t=>t.update&&t.update(e))}render(){var t=this.context,e=(t.save(),(this.x||this.y)&&t.translate(this.x,this.y),this.rotation&&t.rotate(this.rotation),1==this.scaleX&&1==this.scaleY||t.scale(this.scaleX,this.scaleY),-this.width*this.anchor.x),i=-this.height*this.anchor.y;(e||i)&&t.translate(e,i),this.context.globalAlpha=this.opacity,this._rf(),(e||i)&&t.translate(-e,-i),this.children.map(t=>t.render&&t.render()),t.restore()}draw(){}_pc(){this._uw(),this.children.map(t=>t._pc())}get x(){return this.position.x}get y(){return this.position.y}set x(t){this.position.x=t,this._pc()}set y(t){this.position.y=t,this._pc()}get width(){return this._w}set width(t){this._w=t,this._pc()}get height(){return this._h}set height(t){this._h=t,this._pc()}_uw(){var t,e,i,s,h,o,n;this._di&&({_wx:t=0,_wy:e=0,_wo:i=1,_wr:o=0,_wsx:s=1,_wsy:h=1}=this.parent||{},{x:i,y:s}=(this._wx=this.x,this._wy=this.y,this._ww=this.width,this._wh=this.height,this._wo=i*this.opacity,this._wsx=s*this.scaleX,this._wsy=h*this.scaleY,this._wx=this._wx*s,this._wy=this._wy*h,this._ww=this.width*this._wsx,this._wh=this.height*this._wsy,this._wr=o+this.rotation,h={x:this._wx,y:this._wy},n=Math.sin(o),o=Math.cos(o),{x:h.x*o-h.y*n,y:h.x*n+h.y*o}),this._wx=i,this._wy=s,this._wx+=t,this._wy+=e)}get world(){return{x:this._wx,y:this._wy,width:this._ww,height:this._wh,opacity:this._wo,rotation:this._wr,scaleX:this._wsx,scaleY:this._wsy}}set children(t){this.removeChild(this._c),this.addChild(t)}get children(){return this._c}addChild(...t){t.flat().map(t=>{this.children.push(t),t.parent=this,t._pc=t._pc||y,t._pc()})}removeChild(...t){t.flat().map(t=>{var e,i=this.children;-1!=(e=i.indexOf(t))&&(i.splice(e,1),1)&&(t.parent=null,t._pc())})}get opacity(){return this._opa}set opacity(t){this._opa=R(0,1,t),this._pc()}get rotation(){return this._rot}set rotation(t){this._rot=t,this._pc()}setScale(t,e=t){this.scaleX=t,this.scaleY=e}get scaleX(){return this._scx}set scaleX(t){this._scx=t,this._pc()}get scaleY(){return this._scy}set scaleY(t){this._scy=t,this._pc()}},q=class extends t{init({image:t,width:e=t?t.width:void 0,height:i=t?t.height:void 0,...s}={}){super.init({image:t,width:e,height:i,...s})}get animations(){return this._a}set animations(t){let e,i;for(e in this._a={},t)this._a[e]=t[e].clone(),i=i||this._a[e];this.currentAnimation=i,this.width=this.width||i.width,this.height=this.height||i.height}playAnimation(t){this.currentAnimation?.stop(),this.currentAnimation=this.animations[t],this.currentAnimation.start()}advance(t){super.advance(t),this.currentAnimation?.update(t)}draw(){this.image&&this.context.drawImage(this.image,0,0,this.image.width,this.image.height),this.currentAnimation&&this.currentAnimation.render({x:0,y:0,width:this.width,height:this.height,context:this.context}),this.color&&(this.context.fillStyle=this.color,this.context.fillRect(0,0,this.width,this.height))}};function e(){return new q(...arguments)}var d=new WeakMap,I={},W={},B={0:"left",1:"middle",2:"right"};function u(t,e){return parseFloat(t.getPropertyValue(e))||0}function N(t){var e=null!=t.button?B[t.button]:"left";W[e]=!0,$(t,"onDown")}function F(t){var e=null!=t.button?B[t.button]:"left";W[e]=!1,$(t,"onUp")}function H(t){$(t,"onOver")}function J(t){d.get(t.target)._oo=null,W={}}function U(t,e,i){var s=function(e){var i=e._lf.length?e._lf:e._cf;for(let t=i.length-1;0<=t;t--){var s=i[t];if(s.collidesWithPointer?s.collidesWithPointer(e):function(t,e){let{x:i,y:s,width:h,height:o}=function(t){let{x:e=0,y:i=0,width:s,height:h}=t.world||t;return t.mapwidth&&(s=t.mapwidth,h=t.mapheight),t.anchor&&(e-=s*t.anchor.x,i-=h*t.anchor.y),s<0&&(e+=s,s*=-1),h<0&&(i+=h,h*=-1),{x:e,y:i,width:s,height:h}}(t);for(;i-=t.sx||0,s-=t.sy||0,t=t.parent;);var n=e.x-Math.max(i,Math.min(e.x,i+h)),r=e.y-Math.max(s,Math.min(e.y,s+o));return n*n+r*r<e.radius*e.radius}(s,e))return s}}(t);s&&s[e]&&s[e](i),I[e]&&I[e](i,s),"onOver"==e&&(s!=t._oo&&t._oo&&t._oo.onOut&&t._oo.onOut(i),t._oo=s)}function $(h,o){h.preventDefault();let t=h.target,n=d.get(t),{scaleX:r,scaleY:a,offsetX:l,offsetY:c}=function(t){var{canvas:t,_s:e}=t,i=t.getBoundingClientRect(),s="none"!=e.transform?e.transform.replace("matrix(","").split(","):[1,1,1,1],h=parseFloat(s[0]),o=(s=parseFloat(s[3]),(u(e,"border-left-width")+u(e,"border-right-width"))*h),n=(u(e,"border-top-width")+u(e,"border-bottom-width"))*s,r=(u(e,"padding-left")+u(e,"padding-right"))*h,a=(u(e,"padding-top")+u(e,"padding-bottom"))*s;return{scaleX:(i.width-o-r)/t.width,scaleY:(i.height-n-a)/t.height,offsetX:i.left+(u(e,"border-left-width")+u(e,"padding-left"))*h,offsetY:i.top+(u(e,"border-top-width")+u(e,"padding-top"))*s}}(n);h.type.includes("touch")?(Array.from(h.touches).map(({clientX:t,clientY:e,identifier:i})=>{let s=n.touches[i];s||(s=n.touches[i]={start:{x:(t-l)/r,y:(e-c)/a}},n.touches.length++),s.changed=!1}),Array.from(h.changedTouches).map(({clientX:t,clientY:e,identifier:i})=>{var s=n.touches[i];s.changed=!0,s.x=n.x=(t-l)/r,s.y=n.y=(e-c)/a,U(n,o,h),m("touchChanged",h,n.touches),"onUp"==o&&(delete n.touches[i],n.touches.length--,n.touches.length||m("touchEnd"))})):(n.x=(h.clientX-l)/r,n.y=(h.clientY-c)/a,U(n,o,h))}function K(t){var e=t.canvas;t.clearRect(0,0,e.width,e.height)}var o,r=[],V={},Q={},Z={0:"south",1:"east",2:"west",3:"north",4:"leftshoulder",5:"rightshoulder",6:"lefttrigger",7:"righttrigger",8:"select",9:"start",10:"leftstick",11:"rightstick",12:"dpadup",13:"dpaddown",14:"dpadleft",15:"dpadright"},tt={},et=(t=!1,{swipe:{touches:1,threshold:10,touchend({0:t}){var e=t.x-t.start.x,i=(t=t.y-t.start.y,Math.abs(e)),s=Math.abs(t);if(!(i<this.threshold&&s<this.threshold))return s<i?e<0?"left":"right":t<0?"up":"down"}},pinch:{touches:2,threshold:2,touchstart({0:t,1:e}){this.prevDist=Math.hypot(t.x-e.x,t.y-e.y)},touchmove({0:t,1:e}){if(t=Math.hypot(t.x-e.x,t.y-e.y),!(Math.abs(t-this.prevDist)<this.threshold))return e=t>this.prevDist?"out":"in",this.prevDist=t,e}}}),it={},st={},s={},c={Enter:"enter",Escape:"esc",Space:"space",ArrowLeft:"arrowleft",ArrowUp:"arrowup",ArrowRight:"arrowright",ArrowDown:"arrowdown"};function ht(t=y,e){t._pd&&e.preventDefault(),t(e)}function ot(t){var e=c[t.code],i=it[e];s[e]=!0,ht(i,t)}function nt(t){var e=c[t.code],i=st[e];s[e]=!1,ht(i,t)}function rt(){s={}}function at(){let t;for(t=0;t<26;t++)c["Key"+String.fromCharCode(t+65)]=String.fromCharCode(t+97);for(t=0;t<10;t++)c["Digit"+t]=c["Numpad"+t]=""+t;window.addEventListener("keydown",ot),window.addEventListener("keyup",nt),window.addEventListener("blur",rt)}function lt(t,e,{handler:i="keydown",preventDefault:s=!0}={}){let h="keydown"==i?it:st;e._pd=s,[].concat(t).map(t=>h[t]=e)}function a(t){return[].concat(t).some(t=>s[t])}function ct(t,e){return Object.values(e).includes(t)}function l(t,r,{gamepad:a,key:l}={}){[].concat(t).map(t=>{if(ct(t,Z)){var[i,s,{gamepad:h,handler:o="gamepaddown"}={}]=[t,r,a];let e="gamepaddown"==o?V:Q;[].concat(i).map(t=>{isNaN(h)?e[t]=s:(e[h]=e[h]||{},e[h][t]=s)})}else if(n=t,Object.keys(et).some(t=>n.startsWith(t)))e=r,[].concat(t).map(t=>{tt[t]=e});else if(ct(t,c))lt(t,r,l);else{if(!["down","up"].includes(t))throw new TypeError(`"${t}" is not a valid input name`);o=r,i=(i=t)[0].toUpperCase()+i.substr(1),I["on"+i]=o}var e,n})}var dt=class{constructor({create:t,maxSize:e=1024}={}){let i;if(!t||!(i=t())||!(i.update&&i.init&&i.isAlive&&i.render))throw Error("Must provide create() function which returns an object with init(), update(), render(), and isAlive() functions");this._c=t,this.objects=[t()],this.size=0,this.maxSize=e}get(t={}){if(this.size==this.objects.length){if(this.size==this.maxSize)return;for(let t=0;t<this.size&&this.objects.length<this.maxSize;t++)this.objects.push(this._c())}var e=this.objects[this.size];return this.size++,e.init(t),e}getAliveObjects(){return this.objects.slice(0,this.size)}clear(){this.size=this.objects.length=0,this.objects.push(this._c())}update(e){let i,s=!1;for(let t=this.size;t--;)(i=this.objects[t]).update(e),i.isAlive()||(s=!0,this.size--);s&&this.objects.sort((t,e)=>e.isAlive()-t.isAlive())}render(){for(let t=this.size;t--;)this.objects[t].render()}};function ut(){return new dt(...arguments)}function p(...t){pt.play(...t)}var pt={volume:.3,sampleRate:44100,x:new AudioContext,play:function(...t){return this.playSamples(this.buildSamples(...t))},playSamples:function(...t){let i=this.x.createBuffer(t.length,t[0].length,this.sampleRate),e=this.x.createBufferSource();return t.map((t,e)=>i.getChannelData(e).set(t)),e.buffer=i,e.connect(this.x.destination),e.start(),e},buildSamples:function(t=1,e=.05,i=220,s=0,h=0,o=.1,n=0,r=1,a=0,l=0,c=0,d=0,u=0,p=0,f=0,g=0,x=0,y=1,w=0,m=0){let v,_,b=2*Math.PI,T=this.sampleRate,M=a*=500*b/T/T,S=i*=(1+2*e*Math.random()-e)*b/T,k=[],P=0,C=0,E=0,A=1,G=0,z=0,X=0;for(l*=500*b/T**3,f*=b/T,c*=b/T,d*=T,u=u*T|0,_=(s=s*T+9)+(w*=T)+(h*=T)+(o*=T)+(x*=T)|0;E<_;k[E++]=X)++z%(100*g|0)||(X=n?1<n?2<n?3<n?Math.sin((P%b)**3):Math.max(Math.min(Math.tan(P),1),-1):1-(2*P/b%2+2)%2:1-4*Math.abs(Math.round(P/b)-P/b):Math.sin(P),X=(u?1-m+m*Math.sin(b*E/u):1)*(0<X?1:-1)*Math.abs(X)**r*t*this.volume*(E<s?E/s:E<s+w?1-(E-s)/w*(1-y):E<s+w+h?y:E<_-x?(_-E-x)/o*y:0),X=x?X/2+(x>E?0:(E<_-x?1:(_-E)/x)*k[E-x|0]/2):X),v=(i+=a+=l)*Math.cos(f*C++),P+=v-v*p*(1-1e9*(Math.sin(E)+1)%2),A&&++A>d&&(i+=c,S+=c,A=0),!u||++G%u||(i=S,a=M,A=A||1);return k},getNote:function(t=0,e=440){return e*2**(t/12)}},{canvas:f,context:g}=function({contextless:t=!1}={}){if(h=document.getElementById(void 0)||document.querySelector("canvas"),h=t?h||new Proxy({},L):h)return(v=h.getContext("2d")||new Proxy({},L)).imageSmoothingEnabled=!1,m("init"),{canvas:h,context:v};throw Error("You must provide a canvas element for the game")}(),x=t=>Math.floor(Math.random()*t),_=(g.imageSmoothingEnabled=!1,g={},at(),function({radius:t=5,canvas:e=h}={}){let i,s=d.get(e);s||(i=window.getComputedStyle(e),s={x:0,y:0,radius:t,touches:{length:0},canvas:e,_cf:[],_lf:[],_o:[],_oo:null,_s:i},d.set(e,s)),e.addEventListener("mousedown",N),e.addEventListener("touchstart",N),e.addEventListener("mouseup",F),e.addEventListener("touchend",F),e.addEventListener("touchcancel",F),e.addEventListener("blur",J),e.addEventListener("mousemove",H),e.addEventListener("touchmove",H),s._t||(s._t=!0,w("tick",()=>{s._lf.length=0,s._cf.map(t=>{s._lf.push(t)}),s._cf.length=0}))}(g.pointer),t||(t=!0,w("touchChanged",(s,h)=>{Object.keys(et).map(t=>{let e,i=et[t];(!o||o==t)&&h.length==i.touches&&[...Array(h.length).keys()].every(t=>h[t])&&(e=i[s.type]?.(h)??"")&&tt[t+e]&&tt[(o=t)+e](s,h)})}),w("touchEnd",()=>{o=0})),window.addEventListener("gamepadconnected",function(t){r[t.gamepad.index]={pressedButtons:{},axes:{}}}),window.addEventListener("gamepaddisconnected",function(t){delete r[t.gamepad.index]}),window.addEventListener("blur",function(){r.map(t=>{t.pressedButtons={},t.axes={}})}),w("tick",function(){var e,i=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads||[];for(let t=0;t<i.length;t++){let n=i[t];n&&(n.buttons.map((e,t)=>{let i=Z[t],s=e.pressed,h=r[n.index].pressedButtons,o=h[i];!o&&s?[V[n.index],V].map(t=>{t?.[i]?.(n,e,i)}):o&&!s&&[Q[n.index],Q].map(t=>{t?.[i]?.(n,e,i)}),h[i]=s}),(e=r[n.index].axes).leftstickx=n.axes[0],e.leftsticky=n.axes[1],e.rightstickx=n.axes[2],e.rightsticky=n.axes[3])}}),at(),{width:400,height:400}),b=e({x:240,y:100,color:"#333",width:40,height:40,dx:2,dy:2,speed:2,r:20,flipX:1,anim:1,render:function(t=!0){var e=Math.sin(this.anim*Math.PI),i=this.context;i.scale(this.flipX,1),t&&(i.fillStyle="#8884",i.beginPath(),i.arc(0,10,this.r,0,2*Math.PI),i.fill()),i.strokeStyle="#333",i.lineJoin="bevel",i.lineCap="round",i.lineWidth=4,t=2*e,i.beginPath(),i.moveTo(-10,0+t),i.lineTo(-10,20+t),i.quadraticCurveTo(-10,20+t,-5,20+t),i.lineTo(15,20+t),i.quadraticCurveTo(20,20+t,20,15+t),i.lineTo(20,5+t),i.quadraticCurveTo(20,0+t,15,0+t),i.stroke(),mt(i,14,7+t),mt(i,14,13+t),e*=4,i.beginPath(),i.moveTo(-10,e-12),i.lineTo(-10,e-4),i.quadraticCurveTo(-10,e,-6,e),i.lineTo(6,e),i.quadraticCurveTo(10,e,10,e-4),i.lineTo(10,e-8),i.quadraticCurveTo(10,e-12,6,e-12),i.stroke(),mt(i,3,e-7),i.beginPath(),i.moveTo(-12,1.2*e-13),i.lineTo(17,1.2*e-13),i.lineTo(-10,1.2*e-23),i.closePath(),i.stroke(),i.beginPath(),i.moveTo(-10,1.2*e-13),i.quadraticCurveTo(-15,e-20,-20,2*e-17),i.stroke(),i.strokeRect(-4-e,20+t,8,7-t),i.strokeRect(4+e,20+t,8,7-t)},update:function(t){this.x+=this.dx,this.y+=this.dy,this.flipX=0<this.dx?1:-1,this.anim+=Math.min(.1,.04*n(this.dx,this.dy).length()),1<this.anim&&--this.anim,!this.controlled&&(.8<Math.random()&&100*Math.random()<this.r&&yt(this.x-10*this.flipX,this.y),(this.x+this.width>_.width||this.x<0)&&(this.randomDir(),this.x+=this.dx),this.y+this.height>_.height||this.y<0)&&(this.randomDir(),this.y+=this.dy)},randomDir:function(){let t,e=n(x(_.width/4*3)+_.width/8-b.x,x(_.height/4*3)+_.height/8-b.y),i=gt();0<i.length&&(t=i[x(i.length)],e=n(t.x-b.x,t.y-b.y)),e=e.normalize().scale(this.speed),b.dx=e.x,b.dy=e.y},inSway:function(t){return e=this.x,i=this.y+10,s=this.r-Math.min(t.width,t.height)/2,h=t.x,t=t.y,Math.sqrt(Math.pow(e-h,2)+Math.pow(i-t,2))<s;var e,i,s,h}}),T=()=>{var t=Math.random()*Math.PI*2;return n(Math.cos(t),Math.sin(t)).normalize()},M=ut({create:e}),ft=e=>M.getAliveObjects().filter(t=>t.follow===e),gt=()=>M.getAliveObjects().filter(t=>!t.follow),xt=(t,e)=>{var i=T().scale(1.2*Math.max(_.width,_.height));M.get({x:t||_.width/2+i.x,y:e||_.height/2+i.y,d:i.normalize().scale(-4),offScreen:!0,color:"#333",width:30,height:30,follow:!1,will:1,anim:0,flipX:1,update:function(){if(this.x+=this.d.x,this.y+=this.d.y,this.flipX=(t=this.flipX+(0<this.d.x?.1:-.1),Math.min(1,Math.max(-1,t))),this.offScreen)this.x>this.width&&this.x<_.width-this.width&&this.y>this.height&&this.y<_.height-this.height&&(this.offScreen=!1,this.d=this.d.normalize().scale(.2));else if(this.will<=.2&&this.follow){let t=n(this.follow.x-this.x,this.follow.y-this.y),e=t.length(),i=(t=t.normalize(),ft(this.follow)),s=n(0,0);for(var h of i)s=s.add(h.d);for(var o of(0<i.length&&(t=t.add(s.scale(1/i.length).normalize().scale(.5))),i))(o=n(this.x-o.x,this.y-o.y)).length()<30&&(t=t.add(o.normalize()));t=(t=e<40?t.scale(-.8):t).add(T().scale(.1)),this.d.set(t.normalize().scale(this.follow.speed))}else(this.x+this.width/2>_.width||this.x-this.width/2<0)&&(this.x-=this.d.x,this.d.x*=-1),(this.y+this.height/2>_.height||this.y-this.width/2<0)&&(this.y-=this.d.y,this.d.y*=-1);var t;this.anim+=.07*Math.abs(this.dx),1<this.anim&&--this.anim,0<this.will&&b.inSway(this)?(this.will-=.07,this.will<=0&&(this.follow=b)):this.follow&&.3<this.will&&(this.follow=!1,this.d=this.d.normalize().scale(.4))},render:function(){var t,e=this.context,i=(e.fillStyle=this.color,Math.floor(this.height/2*(1-this.will))),s=(e.fillStyle="#3333",2*Math.sin(this.anim*Math.PI)),h=3*Math.cos(this.anim*Math.PI);e.scale((t=this.flipX)<0?Math.floor(t):Math.ceil(t),1),e.beginPath(),e.moveTo(-15,-5),e.bezierCurveTo(-25-s,h-30,-5-s,h-15,-5-h,s-25),e.stroke(),e.strokeRect(s-12,0,3,3),e.strokeRect(-5-s,0,3,3),e.strokeRect(2+s,0,3,3),e.strokeRect(9-s,0,3,3),e.strokeStyle="#333",e.lineJoin="bevel",e.lineCap="round",e.lineWidth=4,e.beginPath(),e.moveTo(15,0),e.lineTo(-10,0),e.quadraticCurveTo(-15,0,-15,s-5),e.bezierCurveTo(-15,s-20,0,s-20,15,0),e.closePath(),e.stroke(),e.clip(),e.fillRect(-this.width/2,s-i,this.width,i-s),mt(e,5,s/2-5)}})},S=ut({create:e}),yt=(t,e)=>{S.get({x:t,y:e,d:T().scale(.5),width:6,height:10,life:4+x(5),alive:!0,update:function(){this.x+=this.d.x,this.y+=this.d.y,this.life-=.2,this.life<0&&(this.alive=!1)},render:function(){var t=this.context,e=1<this.life?"f":Math.floor(10*this.life);t.strokeStyle="#333"+e,t.fillStyle="#333"+e,t.lineWidth=3,t.beginPath(),t.moveTo(0,0),t.arc(0,0,2,0,2*Math.PI),t.moveTo(2,0),t.lineTo(2,-8),t.closePath(),t.fill(),t.stroke(),t.fillStyle="#fff"},isAlive:function(){return this.alive}})},wt=(t,e,i,s,h)=>{t.beginPath(),t.moveTo(e,i),t.lineTo(s,h),t.stroke(),t.closePath()},mt=(t,e,i)=>{t.beginPath(),t.moveTo(e,i),t.lineTo(e,i),t.stroke()},vt=(i,s,h)=>{i.strokeStyle="#333",i.lineWidth=4,i.lineJoin="bevel",[20,26,32,40].forEach((t,e)=>i.strokeRect(s+6*e,h,6,t))},_t=e({x:0,y:400,width:f.width,height:120,lanes:[26,50,74,98],render:function(){let e=this.context;e.strokeStyle="#333",e.lineWidth=4,e.lineJoin="bevel",wt(e,0,0,this.width,0),this.lanes.forEach(t=>wt(e,50,t,this.width,t)),vt(e,12,this.height/2-20),e.fillStyle="#333",a("arrowup")?e.strokeStyle="#888":e.strokeStyle="#333",e.beginPath(),e.moveTo(65,18),e.lineTo(55,34),e.lineTo(75,34),e.lineTo(65,18),e.closePath(),e.fill(),e.stroke(),a("arrowleft")?e.strokeStyle="#888":e.strokeStyle="#333",e.beginPath(),e.moveTo(57,50),e.lineTo(73,60),e.lineTo(73,40),e.lineTo(57,50),e.closePath(),e.fill(),e.stroke(),a("arrowright")?e.strokeStyle="#888":e.strokeStyle="#333",e.beginPath(),e.moveTo(73,74),e.lineTo(57,84),e.lineTo(57,64),e.lineTo(73,74),e.closePath(),e.fill(),e.stroke(),e.stroke(),a("arrowdown")?e.strokeStyle="#888":e.strokeStyle="#333",e.beginPath(),e.moveTo(65,106),e.lineTo(55,90),e.lineTo(75,90),e.lineTo(65,106),e.closePath(),e.fill(),e.stroke()}}),k=e({x:50,y:400,width:30,height:120,color:"#8884"}),P=ut({create:e}),bt=t=>{var e;void 0!==t&&(e=[],1&~t||e.push(0),2&~t||e.push(1),4&~t||e.push(2),8&~t||e.push(3),e.forEach(t=>P.get({noteType:t,x:f.width+67,y:f.height-_t.height+_t.lanes[t],width:20,height:20,color:"#333",dx:-2,alive:!0,update:function(){this.x+=this.dx,this.x<k.x&&(this.alive=!1,b.r=Math.max(b.r-10,20),ft(b).forEach(t=>t.will+=.1),p(...Tt(Mt[this.noteType]-20)),Pt())},render:function(){var t=this.context;t.strokeStyle="#333",t.fillStyle="#333",t.lineWidth=4,t.beginPath(),t.moveTo(0,0),t.arc(0,0,6,0,2*Math.PI),t.moveTo(6,0),t.lineTo(6,-20),t.closePath(),t.fill(),t.stroke(),t.fillStyle="#fff"},isAlive:function(){return this.alive}})))},Tt=t=>[3,0,t,.05,.1,,1,,,,,,,.1,,,.09,.5,.22],Mt=[261.63,311.13,392,523.25],St=t=>[t||.6,0,65.40639,,.01,.07,,3,,,,,,.2,,.5,,1.3,.01],C=[{introText:["","","Here is an easy","song to start you off.","","Good luck!"],outroText:[["Oh hero,","the streets are cleaner!","Everyone is happy!"],["Well, you cleared","some rats, at least."],["Are you sure","you are blowing into","the right end of the pipes?"]],rats:5,song:{notes:[1,,1,,2,,4,,8,,4,,2,,1,,1,2,1,,1,,1,,1,2,1,,1,,1]}},{introText:["","Something a little","trickier, since we","see you can truly play.","","Good luck!"],outroText:[["Our rats they flee,","Oh sweet melody!","","Well done Piper!"],["Some rats gone","is better than","no rats gone."],["Have your tried","turning it off and","back on again?"]],rats:6,song:{notes:[1,,2,4,8,,2,4,8,,8,,4,,4,2,4,,4,2,4,,4,2,4,8,4,,1]}},{introText:["","Harmonies will do","the trick to cause","the rats to flee.","","Good luck!"],outroText:[["Nice playing!","Our children would love","to hear your sweet melodies!"],["Maybe the cats","will take care","of the rest of them?"],["Maybe you should try","playing an auto pan pipe?"]],rats:7,song:{notes:[1,,12,,8,4,12,,8,4,2,,2,4,1,,1,2,6,,1,2,6,,1,2,6,,2,,1]}},{introText:["The final push!","","These rats get a","free concert basically.","","Good luck!"],outroText:[["All the rats","are gone!","","Piper, you hero!"],["Piper you missed","a few rats..."],["Obviously you","aren't cut out for","this line of work!"]],rats:8,song:{notes:[1,,3,,6,,12,,4,2,6,2,4,2,12,,12,,8,4,2,1,2,1,6,,2,,3]}}].map(t=>({freqs:Mt,...t})),kt=t=>Math.abs(k.x+k.width/2-t),Pt=()=>{setTimeout(()=>{if(0<P.getAliveObjects().length)return!1;zt(Ct)},500)},E=(l(["arrowup","w"],(g=i=>function(t){var e;X.scene===z&&X.state===A?void 0!==(e=(e=>{var t,i=P.getAliveObjects().filter(t=>t.noteType===e&&kt(t.x)<k.width/2).pop();if(i)return t=kt(i.x),i.alive=!1,t})(i))&&(p(...Tt(Mt[i])),yt(Xt.x+3+6*i,Xt.y+24+7*i),[e=5]=[e],b.r=Math.min(b.r+e,100),X.score+=e,Pt()):(X.scene===z&&X.state===E&&X.introText?yt(j.x+3+6*i,j.y+24+7*i):X.scene===G&&(0===i||1===i?X.menuChoice--:3!==i&&2!==i||X.menuChoice++),p(...Tt(Mt[i])))})(0)),l(["arrowleft","a"],g(1)),l(["arrowright","d"],g(2)),l(["arrowdown","s"],g(3)),lt(["enter","space"],t=>{X.scene===G?Gt(A):X.scene===z&&X.state===E&&X.introText?X.introText=!1:X.scene===Et&&Gt(G)},{handler:"keyup"}),0),A=1,Ct=2,G=0,z=1,Et=2,X={scene:z,song:null,highScores:{},level:0,state:E,introText:!0,intro:80,outroText:!1,outro:80,score:0,menuChoice:0},At=()=>{var t;window.localStorage?(t=window.localStorage.getItem("highscores"),X.highScores=t?JSON.parse(t):{}):X.highScores={}},Gt=t=>{X.scene=t,S.clear(),t===G?(b.x=100,b.y=150,b.r=0,X.menuChoice=0,xt(330,175),xt(270,175)):t===z?(X.level=X.menuChoice,M.clear(),zt(E)):t===Et&&(X.postGame={score:X.score,cleared:ft(b).length,loose:gt().length},t=X.postGame.cleared+X.postGame.loose,t=X.postGame.cleared/t,X.postGame.score+=50*X.postGame.cleared,X.postGame.score-=50*X.postGame.loose,X.postGame.score=Math.max(0,X.postGame.score),0===X.postGame.loose?X.postGame.text=C[X.level].outroText[0]:X.postGame.text=.35<t?C[X.level].outroText[1]:C[X.level].outroText[2],X.postGame.gotHighScore=(t=>{let e,i=!1;return window.localStorage&&(At(),(!(e=X.highScores[X.level])||e<t)&&0<(X.highScores[X.level]=t)&&(i=!0),window.localStorage.setItem("highscores",JSON.stringify(X.highScores))),i})(X.postGame.score),M.clear(),P.clear())},zt=t=>{if(t===E)X.introText=!0,X.intro=80,b.x=-100,b.y=_.height/2,b.dy=0,b.dx=3,b.r=10,b.controlled=!0;else if(t===A){b.speed=2;var e=T().scale(b.speed);b.dx=e.x,b.dy=e.y,delete b.controlled,X.song=C[X.level].song;for(let t=X.songPlace=0;t<C[X.level].rats;t++)xt()}else t===Ct&&(b.controlled=!0,b.dx=3,b.dy=0,b.speed=3,X.outro=80,X.outroText=!1);X.state=t},j=n(f.width/2-20,f.height-128),Xt=n(12,f.height-50),jt=0,Ot=0,O=(t=function({fps:t=60,clearCanvas:e=!0,update:i,render:s,context:h=v,blur:o=!1}){if(!s)throw Error("You must provide a render() function");let n,r,a,l,c,d=0,u=1e3/t,p=1/t,f=e?K:y,g=!0;function x(){if(r=requestAnimationFrame(x),g&&(a=performance.now(),l=a-n,n=a,!(1e3<l))){for(m("tick"),d+=l;d>=u;)c.update(p),d-=u;f(c.context),c.render()}}return o||(window.addEventListener("focus",()=>{g=!0}),window.addEventListener("blur",()=>{g=!1})),w("init",()=>{c.context||(c.context=v)}),c={update:i,render:s,isStopped:!0,context:h,start(){n=performance.now(),this.isStopped=!1,requestAnimationFrame(x)},stop(){this.isStopped=!0,cancelAnimationFrame(r)},_frame:x,set _last(t){n=t}}}({update:function(t){X.scene===G?(X.menuChoice<0?X.menuChoice+=C.length:X.menuChoice>C.length-1&&(X.menuChoice-=C.length),b.anim+=.1,M.getAliveObjects().forEach(t=>{t.anim+=.05+.1*Math.random(),t.will=1})):X.scene===z&&(X.state===E?X.introText||(b.update(t),b.x>=_.width/2&&zt(A)):X.state===A?(b.update(),M.update(),P.update(),a("t")&&(b.r=Math.min(b.r+1,100)),a("g")&&(b.r=Math.max(b.r-1,20)),(X.song||0<P.getAliveObjects().length)&&(jt<=0?(jt=.25,2==++Ot?(X.song&&(X.songPlace++,bt(X.song.notes[X.songPlace])),p(...St(.6))):4===Ot?(X.song&&(X.songPlace++,bt(X.song.notes[X.songPlace])),p(...St(1.2)),Ot=0):p(...St(.6))):jt-=t)):X.state===Ct&&(b.update(t),M.update(),b.x>=_.width+_.width/2)&&Gt(Et)),S.update()},render:function(){let s=this.context;s.fillStyle="#333",X.scene===G?(s.font="bold 32px sans-serif",O(s,"Pied Pipe",48),s.font="bold 36px sans-serif",s.save(),s.translate(10,0),s.rotate(.1),O(s,"Revolution",65),s.restore(),s.font="bold 28px sans-serif",C.forEach((t,e)=>{var i="Level "+(e+1);O(s,X.menuChoice===e?`> ${i} <`:i,200+32*(e+1))}),vt(s,j.x,j.y),s.font="bold 24px sans-serif",O(s,"Space/Enter to choose level",f.height-20),O(s,"Arrow keys to play pipes",f.height-52),b.render(),M.render()):X.scene===z?X.state===E?X.introText?(s.font="bold 28px sans-serif",C[X.level].introText.forEach((t,e)=>O(s,t,32*(e+1))),vt(s,j.x,j.y),O(s,"Space/Enter to start",f.height-32)):(M.render(),b.render()):X.state===A?(M.render(),b.render(),k.render(),_t.render(),P.render()):X.state===Ct&&(M.render(),b.render()):X.scene===Et&&(s.font="bold 32px sans-serif",O(s,"Song Complete",32),s.font="bold 28px sans-serif",O(s,X.postGame.cleared+" rats gone",96),O(s,X.postGame.loose+" rats left",128),O(s,"Score: "+X.postGame.score,160),X.postGame.gotHighScore&&O(s,"High Score!",192),X.postGame.text.forEach((t,e)=>O(s,t,224+32*(e+1))),O(s,"Space/Enter for menu",f.height-32)),S.render()}}),(t,e,i)=>{var s=t.measureText(e).width;t.fillText(e,f.width/2-s/2,i)});At(),Gt(G),t.start()</script>