<!doctype html><title>Death and Taxes - js13kGames 2021</title><body style=margin:0><div id=intro style=position:absolute;top:0;right:0;bottom:0;left:0;color:#fff;z-index:999;font-family:consolas,monospace;padding:2em><h1>Death and taxes</h1><p>Your <span style=color:#4f4>city</span> is <span style=color:#f44>bombarded from orbit</span>.<p>You control an <span style=color:#0fc>defence platform</span>, your task is to ensure survival of at least 25% of population for as long as possible.<h2>How to play</h2><p>This game requires a VR headset and two hand controllers<p>To shoot use the main trigger. To move use the grab button and move your controller. To zoom in and out use the grab button on both controllers and pinch them closer or further from each other.<p>Click anywhere to start VR.</div><script type=module>import*as u from"/2021/webxr/three.js";let O=.3;function e(e,t){if(t=t[e])return t;throw new Error("The component is not registered")}function o(t){t.id&&r.forEach(function(e){return e.match(t)})}function t(e){this.id=e||(q++).toString(36),this.components=Object.assign({},N),this.mask=0}function s(e,t){this.entity=e,this.prev=null,this.next=t}function n(e){if(!e)throw new Error("Empty selector");for(var t in this.mask=e,this.map={},this.list=null,this.length=0,a)Object.prototype.hasOwnProperty.call(a,t)&&this.match(a[t])}var F,j=new AudioContext,r=[],A=[],a={},i="_sign",c="_mask",W=("undefined"!=typeof Symbol&&(i=Symbol(i),c=Symbol(c)),e.bind(null,i)),R=e.bind(null,c),q=1,N={},h=(t.prototype.add=function(){for(var t=this,e=[],s=arguments.length;s--;)e[s]=arguments[s];e.forEach(function(e){t.components[W(e.constructor)]=e,t.mask|=R(e.constructor)}),o(this)},t.prototype.remove=function(){for(var i=this,e=[],t=arguments.length;t--;)e[t]=arguments[t];e.forEach(function(e){var t=W(e),s=i.components[t];s&&(s.destructor&&s.destructor(),delete i.components[t],i.mask&=~R(e))}),o(this)},t.prototype.has=function(e){return W(e)in this.components},t.prototype.get=function(e){return this.components[e[i]]},t.prototype.eject=function(){var e,t,s=this,i=s.components;for(e in i)Object.prototype.hasOwnProperty.call(i,e)&&(t=i[e])&&t.destructor&&t.destructor();r.forEach(function(e){return e.remove(s)}),delete a[s.id],s.id=0},n.prototype.iterate=function(e){for(var t=this.list;t;)e(t.entity),t=t.next},n.prototype.match=function(e){(this.mask&e.mask)===this.mask?this.add(e):this.remove(e)},n.prototype.add=function(e){var t;this.map[e.id]||(t=new s(e,this.list),this.list&&(this.list.prev=t),this.list=t,this.map[e.id]=t,this.length++)},n.prototype.remove=function(e){var t=this.map[e.id];t&&(t.prev?t.prev.next=t.next:this.list=t.next,t.next&&(t.next.prev=t.prev),delete this.map[e.id],this.length--)},0),l=performance||Date,H=l.now.bind(l),p={register:function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];e.forEach(function(e){if(31<h)throw new Error("Components limit reached");var t;e[i]||(t=h.toString(36),N[t]=null,e[i]=t,e[c]=1<<h,h++)})},process:function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];e.forEach(function(e){return A.push(e)})},create:function(e){if(e=new t(e),a[e.id])throw new Error("The ID already exist");return a[e.id]=e},get:function(e){return a[e]},select:function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];var s=0;e.forEach(function(e){s|=R(e)});for(var i=0;i<r.length;i++)if(r[i].mask===s)return r[i];var o=new n(s);return r.push(o),o},update:function(s){var i={};return A.forEach(function(e){var t=H();e.update(s),i[e.constructor.name]=H()-t}),i}};class m{constructor(e){z.add(this.mesh=e.clone())}destructor(){z.remove(this.mesh),this.mesh.dispose&&this.mesh.dispose()}}class w{constructor(e){this.position=e.clone(),this.delta=G(),this.lastMovedInFrame=-1}moveBy(e){this.position.add(e),this.delta=e,this.lastMovedInFrame=Q}moveTo(e){this.moveBy(e.clone().sub(this.position))}hasMoved(){return this.lastMovedInFrame==Q}}class f{constructor(e,t=500){this.geometry=new u.BufferGeometry,t=this.position=new Float32Array(3*t),this.count=0,this.geometry.setAttribute("position",new u.BufferAttribute(t,3)),z.add(this.mesh=new u.Line(this.geometry,e))}destructor(){z.remove(this.mesh),this.geometry.dispose()}}class g{constructor(e=0,t=0){this.radius=e,this.height=t,this.collides=null}}class v{constructor(e=null){this.onDestroy=e}}class y{constructor(e,t,s,i){this.start=e.clone(),this.position=e.clone(),this.destination=t.clone(),this.speed=s,this.onTarget=i}}const $=[,,476,,.31,.54,,4.53,,.4,,,,.1,,.8,,.7];class d{constructor(e){this.size=e,this.t=0;{var[m=1,w=.05,f=220,g=0,v=0,y=.1,x=0,M=1,S=0,b=0,G=0,T=0,C=0,P=0,z=0,E=0,B=0,k=1,L=0,I=0]=[...$];let e,t,s=Math,i=44100,o=2*s.PI,n=S*=500*o/i/i,r=f*=(1-w+2*w*s.random(w=[]))*o/i,a=0,c=0,h=0,l=1,d=0,u=0,p=0;for(b*=500*o/i**3,z*=o/i,G*=o/i,T*=i,C=i*C|0,t=(g=i*g+9)+(L*=i)+(v*=i)+(y*=i)+(B*=i)|0;h<t;w[h++]=p)++u%(100*E|0)||(p=x?1<x?2<x?3<x?s.sin((a%o)**3):s.max(s.min(s.tan(a),1),-1):1-(2*a/o%2+2)%2:1-4*s.abs(s.round(a/o)-a/o):s.sin(a),p=(C?1-I+I*s.sin(o*h/C):1)*(0<p?1:-1)*s.abs(p)**M*m*O*(h<g?h/g:h<g+L?1-(h-g)/L*(1-k):h<g+L+v?k:h<t-B?(t-h-B)/y*k:0),p=B?p/2+(B>h?0:(h<t-B?1:(t-h)/B)*w[h-B|0]/2):p),e=(f+=S+=b)*s.cos(z*c++),a+=e-e*P*(1-1e9*(s.sin(h)+1)%2),l&&++l>T&&(f+=G,r+=G,l=0),!C||++d%C||(f=r,S=n,l=l||1);(m=j.createBuffer(1,t,i)).getChannelData(0).set(w),(f=j.createBufferSource()).buffer=m,f.connect(j.destination),f.start()}}}const _=new u.Mesh(new u.SphereGeometry,new u.MeshLambertMaterial({emissive:16777215,fog:!1}));function x(e,t=2){p.create().add(new d(t),new w(e),new g(0),new m(_))}_.scale.set(0,0,0),(l=new u.PointLight(16777215,3)).intensity=0,_.add(l);const X=new u.PlaneGeometry,U=document.createElement("canvas").getContext("2d");let V,Y;U.font="20px consolas";class J{constructor(e=400){this.w=e,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.height=this.canvas.width=this.w,this.messageTex=new u.CanvasTexture(this.canvas),this.mat=new u.MeshBasicMaterial({map:this.messageTex,transparent:!0}),this.messagePlane=new u.Mesh(X,this.mat),this.timeoutId=null,this.lastText=null}setText(t,e=5e3){let s=this.messagePlane;if(t!=this.lastText){var i,o=function(){var e,i=[];for(e of t.split("\n")){let t=(e+"").split(" "),s="";for(let e=0;e<t.length;e++){var o=s+t[e]+" ",n=U.measureText(o);Y=(V=n.fontBoundingBoxAscent)+n.fontBoundingBoxDescent,s=400<n.width&&0<e?(i.push(s.trim()),t[e]+" "):o}i.push(s.trim())}return i}(),n=Y*o.length,r=(this.canvas.height!=n&&(this.canvas.height=n,s.scale.set(1,n/this.w,1)),this.ctx);r.clearRect(0,0,this.w,n),r.font=U.font,r.fillStyle="#fff",r.strokeStyle="#000",r.lineWidth=5,r.textAlign="center";let e=V;for(i of o)r.strokeText(i,200,e),r.fillText(i,200,e),e+=Y;this.messageTex.needsUpdate=!0,this.lastText=t}this.messagePlane.visible=!0,this.timeoutId&&clearTimeout(this.timeoutId),0<e&&(this.timeoutId=setTimeout(()=>s.visible=!1,1e3*e))}}const K=new J;function M(e,t=5){K.setText(e,t),K.messagePlane.position.set(0,0,-1),b.add(K.messagePlane)}window.message=M;let Q=0;const S=new u.WebGLRenderer,b=(S.xr.enabled=!0,S.antialias=!0,new u.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3));function Z(){S.setPixelRatio(window.devicePixelRatio),b.aspect=window.innerWidth/window.innerHeight,b.updateProjectionMatrix(),S.setSize(window.innerWidth,window.innerHeight)}b.position.set(0,1.7,0),b.lookAt(-5,-3,-1),addEventListener("resize",Z),Z(),document.body.appendChild(S.domElement);const G=(e=0,t=0,s=0)=>new u.Vector3(e,t,s),T=Math.PI;function C(e=1,t=0,s=1){return t+Math.pow(Math.random(),s)*e}function P(e=1,t=0){var s=Math.random;return t+(s()+s()+s()+s()+s()-2.5)/5*e}const z=new u.Scene;{z.add(new u.GridHelper(100,100)),z.fog=new u.Fog(1909036,1,15),z.background=new u.Color(1909036);const O=new u.Mesh(new u.BoxGeometry(100,1,100),new u.MeshBasicMaterial({color:0})),e=(O.position.y=-.51,z.add(O),new u.Group),o=new u.Mesh(new u.SphereGeometry,new u.MeshBasicMaterial({color:16777113,fog:!1})),t=(o.position.set(0,1e3,0),o.scale.set(10,10,10),o.clone()),s=(t.scale.set(.3,.3,.3),t.position.set(5,0,0),o.add(t),e.add(o),new u.DirectionalLight(16777215,.5));e.add(s),e.rotation.set(Math.PI/3,0,0),z.add(e)}class ee{constructor(){this.time=0,this.points=0,this.events=[],this.died=0,this.rescued=0,this.lastScoreTime=0,this.lastScoreSum=0,this.over=!1,this.wave=0,this.waitForNextWave=10}update(e){if(!this.over){if(0==this.time){p.select(w).iterate(e=>e.eject());{E=0;let o,n,r=[],e=new u.BoxGeometry,t=new u.MeshLambertMaterial({color:65280,emissive:13434828,opacity:.4,transparent:!0}),a=new u.Mesh(e,t),c=0;for(let e=0;e<1e4;e++){let e=C(1,.2,3),t=C(.1,.1),s=G(P(20),e/2,P(20)),i=!1;for(h of r){var h,l=h.x-s.x,d=h.z-s.z;if(l*l+d*d<(h=h.r+t)*h){i=!0;break}}i?c++:((o=new m(a)).mesh.scale.set(t,e,.1),o.mesh.rotation.y=C(T),n=~~(1e6*t*e*.1),E+=n,p.create().add(new w(s),new g(Math.sqrt(t*t/4+.1*.1/4),e),new v,new te(-n),o),r.push({x:s.x,z:s.z,r:t}))}}}if(this.time+=e,~~(100*(1-(this.died+this.rescued)/E))<25&&(this.over=!0),this.waitForNextWave-=e,this.waitForNextWave<0){this.wave++,this.waitForNextWave=10,M("Bombardment\nimminent!");var t=G(0,20,-20),s=2+this.wave;this.events=[];for(let e=0;e<s;e++){let s=G(P(25),0,P(25)),i=G(P(1),P(1),P(1)).add(t);this.events.push([C(3)+this.time,()=>{var e=i,t=s;p.create().add(new w(e),new g,new y(e,t,3,e=>x(e)),new m(se),new f(oe,500),new v(e=>{x(e.get(w).position)}))}])}}this.events=this.events.filter(e=>e[0]>this.time||(e[1](),!1))}}score(e){this.points+=e,(this.time>this.lastScoreTime+2||0<this.lastScoreSum!=0<e)&&(this.lastScoreTime=this.time,this.lastScoreSum=0),this.lastScoreSum+=e;var t=E-(this.died+this.rescued),s=~~(100*(1-(this.died+this.rescued)/E));this.lastScoreSum<0?(ce(-this.lastScoreSum+` just died\n${t} (${s}%) remain`,2),this.died-=e):(ce(this.lastScoreSum+` rescued\n${t} (${s}%) remain`,2),this.rescued+=e)}}let E,B=new ee;class te{constructor(e){this.points=e}destructor(){B.score(this.points)}}const se=new u.Group;{const O=new u.ConeGeometry(.1,.3),e=new u.Mesh(O,new u.MeshLambertMaterial({emissive:16711680}));e.rotation.set(22/14,0,0),se.add(e)}const ie=new u.Group;{const O=new u.ConeGeometry(.1,.3),e=new u.Mesh(O,new u.MeshLambertMaterial({emissive:65484}));e.rotation.set(22/14,0,0),ie.add(e)}const oe=new u.LineBasicMaterial({color:13369344}),ne=new u.LineBasicMaterial({color:52377}),re=(p.register(d,y,f,w,m,v,g,te),p.process(new class{constructor(e){this.selector=e.select(d,w,m,g)}update(i){this.selector.iterate(e=>{var t=e.get(d),s=t.t+=.5*i;1<t.t?e.eject():(t=(s=Math.sin(22/7*s))*t.size,e.get(g).radius=t,(e=e.get(m)).mesh.scale.set(t,t,t),e.mesh.children[0].intensity=s,e.mesh.children[0].needsUpdate=!0)})}}(p),new class{constructor(e){this.selector=e.select(y,w,m)}update(r){this.selector.iterate(e=>{var t=e.get(w),s=e.get(y),i=e.get(m),o=s.destination.clone().sub(t.position),n=r*s.speed;n>o.length()?(t.moveTo(s.destination),s.onTarget&&s.onTarget(t.position,e),e.eject()):(o.normalize(),o.multiplyScalar(n),t.moveBy(o),i.mesh.lookAt(o.add(t.position)))})}}(p),new class{constructor(e){this.selector=e.select(f)}update(e){this.selector.iterate(e=>{const t=e.get(f),s=e.get(w).position,i=t.position;let o=t.count;if(6<=o){const e=G(i[o-6],i[o-5],i[o-4]),t=G(i[o-3],i[o-2],i[o-1]),n=new u.Line3(e,s),r=G();n.closestPointToPoint(t,!0,r),r.distanceTo(t)/n.distance()<.01&&(o-=3)}o>i.length||(i[o++]=s.x,i[o++]=s.y,i[o++]=s.z,t.count=o,t.geometry.setDrawRange(0,o/3),t.mesh.geometry.attributes.position.needsUpdate=!0)})}}(p),new class{constructor(e){this.updateCollisionsSelector=e.select(w,g)}update(e){window.stats.collisionsChecked=0,window.stats.collisions=0,this.updateCollisionsSelector.iterate(e=>{e.collides=null});const l=[];for(var t in this.updateCollisionsSelector.iterate(i=>{var e=i.get(w).position,t=(r=i.get(g)).radius,[o,n,r,a,c,h]=[e.x-t,e.x+t,e.y-(r=t+r.height),e.y+r,e.z-t,e.z+t].map(Math.floor);for(let s=r;s<=a;s++){l[s]||(l[s]={});for(let t=o;t<=n;t++){l[s][t]||(l[s][t]={});for(let e=c;e<=h;e++)l[s][t][e]||(l[s][t][e]=[]),l[s][t][e].push(i)}}}),l)for(var s in l[t])for(var i in l[t][s]){var o=l[t][s][i];for(let i=0;i<o.length;i++)for(let s=i+1;s<o.length;s++){var n=o[i],r=o[s];window.stats.collisionsChecked++;let e=n.get(w),t=r.get(w);e.position.y<t.position.y&&([e,t]=[t,e]);var n=n.get(g),r=r.get(g),a=n.radius+r.radius;if(0==a)return;var c=n.height,h=r.height,d=e.position,u=t.position,p=d.x-u.x,m=d.z-u.z;p*p+(d=u.y-h<=d.y+c&&d.y-c<=u.y+h?0:d.y-c-(u.y+h))*d+m*m<a*a&&(n.collides=t,r.collides=e,window.stats.collisions++)}}}}(p),new class{constructor(e){this.updateMeshesSelector=e.select(w,m)}update(e){this.updateMeshesSelector.iterate(e=>{var t=e.get(m);e=e.get(w),t.mesh.position.copy(e.position)})}}(p),new class{constructor(e){this.selector=e.select(w,g),this.helpers=[],this.mat=new u.MeshBasicMaterial({wireframe:!0,color:16711935}),this.mat2=new u.MeshBasicMaterial({wireframe:!0,color:16776960}),this.sphere=new u.SphereGeometry(1,8,4),this.sphereTop=new u.SphereGeometry(1,8,2,0,2*Math.PI,0,Math.PI/2),this.sphereBottom=new u.SphereGeometry(1,8,2,0,2*Math.PI,Math.PI/2,Math.PI/3),this.cylinder=new u.CylinderGeometry(1,1,1,8,1,!0)}update(e){for(var t of this.helpers)z.remove(t),t.dispose&&t.dispose();this.helpers=[],window.enableDebugCollidersSystem&&this.selector.iterate(e=>{let t,s=e.get(w),i=e.get(g),o=i.height/2,n=i.radius;if(o){t=new u.Group;const e=new u.Mesh(this.sphereTop,this.mat),s=(e.scale.set(n,n,n),e.position.y+=o,new u.Mesh(this.sphereBottom,this.mat)),i=(s.scale.set(n,n,n),s.position.y-=o,new u.Mesh(this.cylinder,this.mat));i.scale.set(n,2*o,n),t.add(e),t.add(s),t.add(i)}else n?(t=new u.Mesh(this.sphere,this.mat)).scale.set(n,n,n):t=new u.AxesHelper(.1);t.position.copy(s.position),t.renderOrder=999,z.add(t),this.helpers.push(t)})}}(p),new class{constructor(e){this.destroyOnCollisionSelector=e.select(g,v)}update(e){this.destroyOnCollisionSelector.iterate(e=>{var t;!e.get(g).collides||(t=e.get(v).onDestroy)&&!1===t(e)||e.eject()})}}(p)),G(0,1.5,-1)),k=new u.Group;z.add(k),l=new u.MeshPhongMaterial({color:65280,emissive:204,specular:16777215});{const O=new u.SphereGeometry,e=new u.BoxGeometry;var L=new u.Mesh(O,l);const o=new u.Mesh(e,l),t=(o.position.set(0,0,-2),o.rotation.set(T/4,0,0),o.scale.set(5.2,2,2),L.add(o),o.clone()),s=(t.position.z=2,L.add(t),new u.Mesh(e,l));s.position.set(-2,0,0),s.scale.set(3.6,1.2,4),L.add(s),L.scale.set(.1,.1,.1),k.add(L),L.rotation.set(0,-T/2,0)}L=new u.Group;{const O=new u.CylinderGeometry,e=new u.Mesh(O,l);e.scale.set(.1,1,.1),e.rotation.set(0,0,T/2),e.position.set(-1,0,0),L.add(e.clone()),e.position.set(1,0,0),L.add(e.clone()),e.rotation.set(T/2,0,0),e.position.set(0,0,-1),L.add(e.clone()),e.position.set(0,0,1),L.add(e),L.scale.set(.1,.1,.1)}const I=new u.Group,D=(I.position.set(0,0,0),I.scale.set(8,8,8),z.add(I),I.add(b),new class{constructor(e,t,o){this.controllers=[e.getControllerGrip(0),e.getControllerGrip(1)],this.gizmos=[t.clone(),t.clone()],this.select=(e,t)=>{};for(let i=0;i<2;i++){o.add(this.gizmos[i]);let s=this.controllers[i];s.addEventListener("select",e=>{var t=new u.Vector3;this.gizmos[i].getWorldPosition(t),this.select(t,s)}),s.addEventListener("squeezestart",()=>this.squeezestart(s)),s.addEventListener("squeezeend",()=>this.squeezeend(s))}this.cameraGroup=o}update(e){for(let e=0;e<2;e++){var t=this.gizmos[e],s=this.controllers[e];t.position.copy(s.position),t.rotation.copy(s.rotation)}if(this.controllerDiffStart){const e=this.controllers[0].position.distanceTo(this.controllers[1].position),t=this.controllerDiffStart/e;this.cameraGroup.scale.copy(this.camStartScale),this.cameraGroup.scale.multiplyScalar(t),this.cameraGroup.position.copy(this.camOrigin),this.cameraGroup.position.multiplyScalar(t)}else if(this.dragOrigin){const e=5*this.cameraGroup.scale.x;var i=this.dragOrigin.clone().sub(this.dragController.position);i.y=0,i.multiplyScalar(e),i.add(this.camOrigin),this.cameraGroup.position.copy(i)}this.controllerCount=this.controllers[0].visible+this.controllers[1].visible}squeezestart(e){this.dragOrigin?(this.controllerDiffStart=this.controllers[0].position.distanceTo(this.controllers[1].position),this.camStartScale=this.cameraGroup.scale.clone()):(this.dragOrigin=e.position.clone(),this.dragController=e),this.camOrigin=this.cameraGroup.position.clone()}squeezeend(e){delete this.dragOrigin,delete this.controllerDiffStart}}(S.xr,L,I)),ae=((window.gg=D).select=e=>{B.over?B=new ee:p.create().add(new w(re),new g,new y(re,e,10,e=>x(e)),new m(ie),new f(ne,500),new v(e=>{x(e.get(w).position)}))},[]);function ce(e,t){for(var s of ae)s.setText(e,t)}for(F of D.gizmos){const O=new J,e=O.messagePlane,o=new u.Group;o.position.set(0,-.5,0),o.scale.set(3,3,3),e.rotation.set(-T/2,0,0),e.position.set(0,0,0),o.add(e),F.add(o),ae.push(O)}ce("press trigger\nto shoot\n\ngrab to move",100);const he=new u.Clock;if(S.setAnimationLoop(()=>{var e,t=he.getDelta(),s=((S.xr.isPresenting||window.nonXrMode)&&(D.update(t),window.ecs_stats=p.update(t),window.ecs_inst=p,B.update(t)),B.over&&M(`You have saved your city for ${Math.round(100*B.time)/100} seconds.\n\nCongratulations?\n\nShoot to restart.`),S.render(z,b),S.xr.isPresenting&&(S.xr.enabled=!1,t=S._framebuffer,S.state.bindXRFramebuffer(null),S.setRenderTarget(S.getRenderTarget()),S.render(z,b),S.xr.enabled=!0,S.state.bindXRFramebuffer(t)),t=I.scale.x,z.fog=new u.Fog(1909036,2/t,30/t),G()),i=G();for(e of D.gizmos)e.getWorldPosition(i),s.add(i);s.multiplyScalar(.5),k.lookAt(s),k.position.copy(re),Q++}),setInterval(()=>{!S.xr.isPresenting||0<D.controllerCount||M("Two working controllers are required for this game",void 0)},1e4),O=.1,window.stats={},addEventListener("load",async()=>{const s=document.getElementById("intro");try{{var i=S,e=s,o=e=>{s.hidden=!!e};let t=null;if(!("xr"in navigator))throw"No XR support in browser.";if(!await navigator.xr.isSessionSupported("immersive-vr"))throw"No immersive-vr. If you just connected your headset, refresh the page.";e.addEventListener("click",async()=>{var e;t?t.end():((e=await navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]})).addEventListener("end",function e(){t.removeEventListener("end",e),t=null,o(t)}),await i.xr.setSession(e),t=e,await!o(t))})}}catch(s){alert(s)}}),u.OrbitControls){const O=new u.OrbitControls(b,S.domElement);O.minDistance=1,O.maxDistance=5,O.target.set(0,1.7),O.update()}b.position.set(0,2,-5),b.lookAt(0,0,0)</script>