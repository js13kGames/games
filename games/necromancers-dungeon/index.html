<!doctype html><meta content="width=device-width" name=viewport><script src=https://cdn.jsdelivr.net/npm/near-api-js@0.45.1/dist/near-api-js.min.js></script><style>body,html{height:100%}body{align-items:center;background-color:#121212;display:flex;image-rendering:pixelated;image-rendering:crisp-edges;justify-content:center;margin:0;width:100%}#game{background-color:#f0f8ff;display:block;max-height:100vh;max-width:177.77778vh;width:100%}</style><canvas height=144 id=game width=256></canvas><script>(()=>{"use strict";let t=()=>{},e="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);";function i(t,e){let i=e.parentNode;if(t.setAttribute("data-kontra",""),i){let s=i.querySelector("[data-kontra]:last-of-type")||e;i.insertBefore(t,s.nextSibling)}else document.body.appendChild(t)}function s(t,e){let i=t.indexOf(e);if(-1!=i)return t.splice(i,1),!0}let n,h,o={};function a(t,...e){(o[t]||[]).map((t=>t(...e)))}let r={get:(e,i)=>"_proxy"==i||t};function l(){return n}function c(){return h}class d{constructor({spriteSheet:t,frames:e,frameRate:i,loop:s=!0}){this.spriteSheet=t,this.frames=e,this.frameRate=i,this.loop=s;let{width:n,height:h,margin:o=0}=t.frame;this.width=n,this.height=h,this.margin=o,this._f=0,this._a=0}clone(){return new d(this)}reset(){this._f=0,this._a=0}update(t=1/60){if(this.loop||this._f!=this.frames.length-1)for(this._a+=t;this._a*this.frameRate>=1;)this._f=++this._f%this.frames.length,this._a-=1/this.frameRate}render({x:t,y:e,width:i=this.width,height:s=this.height,context:n=c()}){let h=this.frames[this._f]/this.spriteSheet._f|0,o=this.frames[this._f]%this.spriteSheet._f|0;n.drawImage(this.spriteSheet.image,o*this.width+(2*o+1)*this.margin,h*this.height+(2*h+1)*this.margin,this.width,this.height,t,e,i,s)}}function u(){return new d(...arguments)}function p(t,e){return[t,e]=[t,e].map((t=>f(t))),t.x<e.x+e.width&&t.x+t.width>e.x&&t.y<e.y+e.height&&t.y+t.height>e.y}function f(t){let{x:e=0,y:i=0,width:s,height:n}=t.world||t;return t.mapwidth&&(s=t.mapwidth,n=t.mapheight),t.anchor&&(e-=s*t.anchor.x,i-=n*t.anchor.y),s<0&&(e+=s,s*=-1),n<0&&(i+=n,n*=-1),{x:e,y:i,width:s,height:n}}class g{constructor(t=0,e=0,i={}){this.x=t,this.y=e}add(t){return new g(this.x+t.x,this.y+t.y,this)}}function m(){return new g(...arguments)}class w extends class{constructor(t){return this.init(t)}init(t={}){this.position=m(),this.velocity=m(),Object.assign(this,t)}update(t){this.advance(t)}advance(t){let e=this.velocity;this.position=this.position.add(e),this._pc()}get dx(){return this.velocity.x}get dy(){return this.velocity.y}set dx(t){this.velocity.x=t}set dy(t){this.velocity.y=t}_pc(){}}{init({width:t=0,height:e=0,context:i=c(),render:s=this.draw,update:n=this.advance,children:h=[],anchor:o={x:0,y:0},scaleX:a=1,scaleY:r=1,...l}={}){this._c=[],super.init({width:t,height:e,context:i,anchor:o,scaleX:a,scaleY:r,...l}),this._di=!0,this._uw(),this.addChild(h),this._rf=s,this._uf=n}update(t){this._uf(t),this.children.map((e=>e.update&&e.update(t)))}render(){let t=this.context;t.save(),(this.x||this.y)&&t.translate(this.x,this.y),1==this.scaleX&&1==this.scaleY||t.scale(this.scaleX,this.scaleY);let e=-this.width*this.anchor.x,i=-this.height*this.anchor.y;(e||i)&&t.translate(e,i),this._rf(),(e||i)&&t.translate(-e,-i),this.children.map((t=>t.render&&t.render())),t.restore()}draw(){}_pc(){this._uw(),this.children.map((t=>t._pc()))}get x(){return this.position.x}get y(){return this.position.y}set x(t){this.position.x=t,this._pc()}set y(t){this.position.y=t,this._pc()}get width(){return this._w}set width(t){this._w=t,this._pc()}get height(){return this._h}set height(t){this._h=t,this._pc()}_uw(){if(!this._di)return;let{_wx:t=0,_wy:e=0,_wsx:i=1,_wsy:s=1}=this.parent||{};this._wx=this.x,this._wy=this.y,this._ww=this.width,this._wh=this.height,this._wsx=i*this.scaleX,this._wsy=s*this.scaleY,this._wx=this._wx*i,this._wy=this._wy*s,this._ww=this.width*this._wsx,this._wh=this.height*this._wsy,this._wx+=t,this._wy+=e}get world(){return{x:this._wx,y:this._wy,width:this._ww,height:this._wh,scaleX:this._wsx,scaleY:this._wsy}}set children(t){this.removeChild(this._c),this.addChild(t)}get children(){return this._c}addChild(...e){e.flat().map((e=>{this.children.push(e),e.parent=this,e._pc=e._pc||t,e._pc()}))}removeChild(...t){t.flat().map((t=>{s(this.children,t)&&(t.parent=null,t._pc())}))}setScale(t,e=t){this.scaleX=t,this.scaleY=e}get scaleX(){return this._scx}set scaleX(t){this._scx=t,this._pc()}get scaleY(){return this._scy}set scaleY(t){this._scy=t,this._pc()}}class _ extends w{init({image:t,width:e=(t?t.width:void 0),height:i=(t?t.height:void 0),...s}={}){super.init({image:t,width:e,height:i,...s})}get animations(){return this._a}set animations(t){let e,i;for(e in this._a={},t)this._a[e]=t[e].clone(),i=i||this._a[e];this.currentAnimation=i,this.width=this.width||i.width,this.height=this.height||i.height}playAnimation(t){this.currentAnimation=this.animations[t],this.currentAnimation.loop||this.currentAnimation.reset()}advance(t){super.advance(t),this.currentAnimation&&this.currentAnimation.update(t)}draw(){this.image&&this.context.drawImage(this.image,0,0,this.image.width,this.image.height),this.currentAnimation&&this.currentAnimation.render({x:0,y:0,width:this.width,height:this.height,context:this.context}),this.color&&(this.context.fillStyle=this.color,this.context.fillRect(0,0,this.width,this.height))}}function x(){return new _(...arguments)}let y=/(\d+)(\w+)/;class b extends w{init({text:t="",textAlign:e="",lineHeight:i=1,font:s=c().font,...n}={}){t=""+t,super.init({text:t,textAlign:e,lineHeight:i,font:s,...n}),this._p()}get width(){return this._w}set width(t){this._d=!0,this._w=t,this._fw=t}get text(){return this._t}set text(t){this._d=!0,this._t=""+t}get font(){return this._f}set font(t){this._d=!0,this._f=t,this._fs=function(t){let e=t.match(y),i=+e[1];return{size:i,unit:e[2],computed:i}}(t).computed}get lineHeight(){return this._lh}set lineHeight(t){this._d=!0,this._lh=t}render(){this._d&&this._p(),super.render()}_p(){this._s=[],this._d=!1;let t=this.context;t.font=this.font,this._s.length||(this._s.push(this.text),this._w=this._fw||t.measureText(this.text).width),this.height=this._fs+(this._s.length-1)*this._fs*this.lineHeight,this._uw()}draw(){let t=this.textAlign,e=this.context;this._s.map(((i,s)=>{e.textBaseline="top",e.textAlign=t,e.fillStyle=this.color,e.font=this.font,e.fillText(i,0,this._fs*this.lineHeight*s)}))}}let v=new WeakMap,E={},S={},k={0:"left",1:"middle",2:"right"};function O(t,e){let{x:i,y:s,width:n,height:h}=f(t);do{i-=t.sx||0,s-=t.sy||0}while(t=t.parent);let o=e.x-Math.max(i,Math.min(e.x,i+n)),a=e.y-Math.max(s,Math.min(e.y,s+h));return o*o+a*a<e.radius*e.radius}function T(t,e){return parseFloat(t.getPropertyValue(e))||0}function A(t){let e=null!=t.button?k[t.button]:"left";S[e]=!0,L(t,"onDown")}function C(t){let e=null!=t.button?k[t.button]:"left";S[e]=!1,L(t,"onUp")}function P(t){L(t,"onOver")}function X(t){v.get(t.target)._oo=null,S={}}function M(t,e,i){let s=function(t){let e=t._lf.length?t._lf:t._cf;for(let i=e.length-1;i>=0;i--){let s=e[i];if(s.collidesWithPointer?s.collidesWithPointer(t):O(s,t))return s}}(t);s&&s[e]&&s[e](i),E[e]&&E[e](i,s),"onOver"==e&&(s!=t._oo&&t._oo&&t._oo.onOut&&t._oo.onOut(i),t._oo=s)}function L(t,e){t.preventDefault();let i=t.target,s=v.get(i),{scaleX:n,scaleY:h,offsetX:o,offsetY:r}=function(t){let{canvas:e,_s:i}=t,s=e.getBoundingClientRect(),n="none"!=i.transform?i.transform.replace("matrix(","").split(","):[1,1,1,1],h=parseFloat(n[0]),o=parseFloat(n[3]),a=(T(i,"border-left-width")+T(i,"border-right-width"))*h,r=(T(i,"border-top-width")+T(i,"border-bottom-width"))*o,l=(T(i,"padding-left")+T(i,"padding-right"))*h,c=(T(i,"padding-top")+T(i,"padding-bottom"))*o;return{scaleX:(s.width-a-l)/e.width,scaleY:(s.height-r-c)/e.height,offsetX:s.left+(T(i,"border-left-width")+T(i,"padding-left"))*h,offsetY:s.top+(T(i,"border-top-width")+T(i,"padding-top"))*o}}(s);t.type.includes("touch")?(Array.from(t.touches).map((({clientX:t,clientY:e,identifier:i})=>{let a=s.touches[i];a||(a=s.touches[i]={start:{x:(t-o)/n,y:(e-r)/h}},s.touches.length++),a.changed=!1})),Array.from(t.changedTouches).map((({clientX:i,clientY:l,identifier:c})=>{let d=s.touches[c];d.changed=!0,d.x=s.x=(i-o)/n,d.y=s.y=(l-r)/h,M(s,e,t),a("touchChanged",t,s.touches),"onUp"==e&&(delete s.touches[c],s.touches.length--,s.touches.length||a("touchEnd"))}))):(s.x=(t.clientX-o)/n,s.y=(t.clientY-r)/h,M(s,e,t))}function j(...t){t.flat().map((t=>{let e=t.context?t.context.canvas:l(),i=v.get(e);t._r||(t._r=t.render,t.render=function(){i._cf.push(this),this._r()},i._o.push(t))}))}class Y extends _{init({padX:s=0,padY:n=0,text:h,disabled:o=!1,onDown:a,onUp:r,...l}={}){super.init({padX:s,padY:n,...l}),this.textNode=function(){return new b(...arguments)}({...h,context:this.context}),this.width||(this.width=this.textNode.width,this.height=this.textNode.height),j(this),this.addChild(this.textNode),this._od=a||t,this._ou=r||t;let c=this._dn=document.createElement("button");c.style=e,c.textContent=this.text,o&&this.disable(),c.addEventListener("focus",(()=>this.focus())),c.addEventListener("blur",(()=>this.blur())),c.addEventListener("keydown",(t=>this._kd(t))),c.addEventListener("keyup",(t=>this._ku(t))),i(c,this.context.canvas),this._uw(),this._p()}get text(){return this.textNode.text}set text(t){this._d=!0,this.textNode.text=t}destroy(){this._dn.remove()}_p(){this.text!=this._dn.textContent&&(this._dn.textContent=this.text),this.textNode._p();let t=this.textNode.width+2*this.padX,e=this.textNode.height+2*this.padY;this.width=Math.max(t,this.width),this.height=Math.max(e,this.height),this._uw()}render(){this._d&&this._p(),super.render()}enable(){this.disabled=this._dn.disabled=!1,this.onEnable()}disable(){this.disabled=this._dn.disabled=!0,this.onDisable()}focus(){this.disabled||(this.focused=!0,document.activeElement!=this._dn&&this._dn.focus(),this.onFocus())}blur(){this.focused=!1,document.activeElement==this._dn&&this._dn.blur(),this.onBlur()}onOver(){this.disabled||(this.hovered=!0)}onOut(){this.hovered=!1}onEnable(){}onDisable(){}onFocus(){}onBlur(){}onDown(){this.disabled||(this.pressed=!0,this._od())}onUp(){this.disabled||(this.pressed=!1,this._ou())}_kd(t){"Enter"!=t.code&&"Space"!=t.code||this.onDown()}_ku(t){"Enter"!=t.code&&"Space"!=t.code||this.onUp()}}function N(){return new Y(...arguments)}function H(t){let e=t.canvas;t.clearRect(0,0,e.width,e.height)}let F={},R={},I={},B={Enter:"enter",Escape:"esc",Space:"space",ArrowLeft:"arrowleft",ArrowUp:"arrowup",ArrowRight:"arrowright",ArrowDown:"arrowdown"};function U(e=t,i){e._pd&&i.preventDefault(),e(i)}function D(t){let e=B[t.code],i=F[e];I[e]=!0,U(i,t)}function W(t){let e=B[t.code],i=R[e];I[e]=!1,U(i,t)}function q(){I={}}function K(t){let e=[];return t._dn?e.push(t._dn):t.children&&t.children.map((t=>{e=e.concat(K(t))})),e}class G{constructor({id:t,name:s=t,objects:n=[],context:h=c(),cullObjects:o=!0,cullFunction:a=p,sortFunction:r,...l}){this._o=[];let d=h.canvas,u=this._dn=document.createElement("section");u.tabIndex=-1,u.style=e,u.id=t,u.setAttribute("aria-label",s),i(u,d),Object.assign(this,{id:t,name:s,context:h,cullObjects:o,cullFunction:a,sortFunction:r,...l});let{width:f,height:g}=d,m=f/2,_=g/2;this.camera=function(){return new w(...arguments)}({x:m,y:_,width:f,height:g,context:h,centerX:m,centerY:_,anchor:{x:.5,y:.5},render:this._rf.bind(this)}),this.add(n)}set objects(t){this.remove(this._o),this.add(t)}get objects(){return this._o}add(...t){t.flat().map((t=>{this._o.push(t),K(t).map((t=>{this._dn.appendChild(t)}))}))}remove(...t){t.flat().map((t=>{s(this._o,t),K(t).map((t=>{i(t,this.context)}))}))}show(){this.hidden=this._dn.hidden=!1;let t=this._o.find((t=>t.focus));t?t.focus():this._dn.focus(),this.onShow()}hide(){this.hidden=this._dn.hidden=!0,this.onHide()}destroy(){this._dn.remove(),this._o.map((t=>t.destroy&&t.destroy()))}lookAt(t){let{x:e,y:i}=t.world||t;this.camera.x=e,this.camera.y=i}update(t){this.hidden||this._o.map((e=>e.update&&e.update(t)))}_rf(){let{_o:t,context:e,_sx:i,_sy:s,camera:n,sortFunction:h,cullObjects:o,cullFunction:a}=this;e.translate(i,s);let r=t;o&&(r=r.filter((t=>a(n,t)))),h&&r.sort(h),r.map((t=>t.render&&t.render()))}render(){if(!this.hidden){let{context:t,camera:e}=this,{x:i,y:s,centerX:n,centerY:h}=e;t.save(),this._sx=n-i,this._sy=h-s,t.translate(this._sx,this._sy),e.render(),t.restore()}}onShow(){}onHide(){}}function z(){return new G(...arguments)}function V(t){if(+t==t)return t;let e=[],i=t.split(".."),s=+i[0],n=+i[1],h=s;if(s<n)for(;h<=n;h++)e.push(h);else for(;h>=n;h--)e.push(h);return e}class J{constructor({image:t,frameWidth:e,frameHeight:i,frameMargin:s,animations:n}={}){this.animations={},this.image=t,this.frame={width:e,height:i,margin:s},this._f=t.width/e|0,this.createAnimations(n)}createAnimations(t){let e,i;for(i in t){let{frames:s,frameRate:n,loop:h}=t[i];e=[],[].concat(s).map((t=>{e=e.concat(V(t))})),this.animations[i]=u({spriteSheet:this,frames:e,frameRate:n,loop:h})}}}class Q{constructor(t={}){let{width:e,height:i,tilewidth:s,tileheight:n,tilesets:h}=t,o=e*s,a=i*n,r=document.createElement("canvas");r.width=o,r.height=a,this._c=r,this._ctx=r.getContext("2d"),Object.assign(this,{context:c(),layerMap:{},layerCanvases:{},mapwidth:o,mapheight:a,...t}),this._p()}render(t=this._c,e=!0){let{_d:i,context:s,sx:n=0,sy:h=0}=this;i&&this._p();let{width:o,height:a}=l(),r=Math.min(t.width,o),c=Math.min(t.height,a);s.drawImage(t,n,h,r,c,0,0,r,c)}renderLayer(t){let{layerCanvases:e,layerMap:i}=this,s=i[t],n=e[t],h=n?.getContext("2d");if(!n){let{mapwidth:i,mapheight:o}=this;n=document.createElement("canvas"),h=n.getContext("2d"),n.width=i,n.height=o,e[t]=n,this._r(s,h)}this.render(n,!1)}_p(){let{_ctx:t,layers:e=[],layerMap:i}=this;this._d=!1,e.map((e=>{let{name:s,data:n,visible:h}=e;e._d=!1,i[s]=e,n&&0!=h&&this._r(e,t)}))}_r(t,e){let{opacity:i,data:s=[]}=t,{tilesets:n,width:h,tilewidth:o,tileheight:a}=this;e.save(),e.globalAlpha=i,s.map(((t,i)=>{if(!t)return;let s;for(let e=n.length-1;e>=0&&(s=n[e],!(t/s.firstgid>=1));e--);let{image:r,margin:l=0,firstgid:c,columns:d}=s,u=t-c,p=d??r.width/(o+l)|0,f=i%h*o,g=(i/h|0)*a,m=u%p*(o+l),w=(u/p|0)*(a+l);e.drawImage(r,m,w,o,a,f,g,o,a)})),e.restore()}}const{connect:Z,Contract:$,keyStores:tt,WalletConnection:et}=nearApi,it={networkId:"testnet",nodeUrl:"https://rpc.testnet.near.org",contractName:"levels-browsing.svntax.testnet",walletUrl:"https://wallet.testnet.near.org",helperUrl:"https://helper.testnet.near.org",explorerUrl:"https://explorer.testnet.near.org"};class st{constructor(t,e,i,s){this.frame=i,this.cost=s,this.row=t,this.col=e,this.depth=1/0,this.isObstacle=3===i,this.isGroundObstacle=2===i||3===i}}const nt=["img/bones.png","img/bones2.png"];class ht{constructor(t,e,i){this.row=i.row,this.col=i.col,this.type=i.type,this.scene=t,this.grid=e;let s=this,n=new Image;n.src=nt[i.type],n.onload=function(){let h=s.sprite=x({x:16*i.col+2,y:16*i.row+2,image:n});t.add(h),e[i.row][i.col].bonesObj=s}}}let ot,at,rt=new Array(16),lt=[],ct=[],dt=[];function ut(t,e){this.row=t,this.col=e,this.f=0,this.g=0,this.h=0,this.neighbors=[],this.parent=void 0,this.walkable=!0,this.updateNeighbors=function(t){let e=this.row,i=this.col;e<8&&t[e+1][i].walkable&&this.neighbors.push(t[e+1][i]),e>0&&t[e-1][i].walkable&&this.neighbors.push(t[e-1][i]),i<15&&t[e][i+1].walkable&&this.neighbors.push(t[e][i+1]),i>0&&t[e][i-1].walkable&&this.neighbors.push(t[e][i-1])}}class pt{constructor(t,e,i,s,n){this.row=s,this.col=n,this.moves=i.moves,this.range=i.range,this.team=i.team,this.unitType=i.unitType,this.damageRange=i.damage,this.state=0,this.name=i.name,this.health=i.maxHealth,this.maxHealth=i.maxHealth,this.healthBar=x({x:0,y:-9,anchor:{x:.5,y:.5},width:12,height:2,color:"#00e436"}),this.scene=t,this.grid=e;let h=this,o=new Image;o.src=i.imagePath,o.onload=function(){let a=function(){return new J(...arguments)}({image:o,frameWidth:16,frameHeight:16,animations:{idle:{frames:i.frames,frameRate:4}}}),r=h.unitSprite=x({x:16*n+8,y:16*s+8,anchor:{x:.5,y:.5},animations:a.animations,update:function(){this.dx=0,this.dy=0,this.advance()}});r.addChild(h.healthBar),t.add(r),"player"===i.team?(e[s][n].containsPlayer=!0,r.scaleX=-1):e[s][n].containsEnemy=!0,j(r),r.unit=h}}move(t){const e=t.row,i=t.col;"player"===this.team?(this.grid[e][i].containsPlayer=!0,this.grid[this.row][this.col].containsPlayer=!1):(this.grid[e][i].containsEnemy=!0,this.grid[this.row][this.col].containsEnemy=!1),i>this.col?this.unitSprite.scaleX=-1:i<this.col&&(this.unitSprite.scaleX=1),this.row=e,this.col=i,this.unitSprite.x=16*i+8,this.unitSprite.y=16*e+8,this.state=2}canOccupyTile(t){return!(t.isObstacle||0===this.unitType&&t.isGroundObstacle)}damage(t){if(this.health-=t,this.health<=0){if(this.health=0,("Bird"===this.name||"Knight"===this.name)&&null==this.grid[this.row][this.col].bonesObj){let t=0;"Bird"===this.name&&(t=1),new ht(this.scene.bonesList,this.grid,{row:this.row,col:this.col,type:t})}let t=this.scene.objects.indexOf(this.unitSprite);t>-1&&this.scene.objects.splice(t,1),"player"===this.team?this.grid[this.row][this.col].containsPlayer=!1:this.grid[this.row][this.col].containsEnemy=!1}this.healthBar.width=this.health/12*12}distanceTo(t){return Math.abs(this.row-t.row)+Math.abs(this.col-t.col)}findTarget(t){if(t.length>0){let e=[];for(let i=0;i<t.length;i++)this.distanceTo(t[i])<=Math.round(this.moves+this.range)&&e.push(t[i]);if(e.length>0)return e.sort((function(t,e){return t.health-e.health})),e[0];{let e=1/0,i=t[0];for(let s=0;s<t.length;s++){let n=this.distanceTo(t[s]);n<e&&(e=n,i=t[s])}return i}}return null}calculatePathTo(t){const e={row:this.row,col:this.col},i={row:t.row,col:t.col};return function(t,e,i,s){for(function(t,e,i,s){for(let t=0;t<9;t++)rt[t]=new Array(9);for(let e=0;e<9;e++)for(let i=0;i<16;i++)rt[e][i]=new ut(e,i),(!s.canOccupyTile(t[e][i])||"enemy"===s.team&&t[e][i].containsPlayer)&&(rt[e][i].walkable=!1);rt[i.row][i.col].walkable=!0;for(let t=0;t<9;t++)for(let e=0;e<16;e++)rt[t][e].walkable&&rt[t][e].updateNeighbors(rt);ot=rt[e.row][e.col],at=rt[i.row][i.col],lt.push(ot)}(t,e,i,s);lt.length>0;){let t=0;for(let e=0;e<lt.length;e++)lt[e].f<lt[t].f&&(t=e);let e=lt[t];if(e===at){let t=e;for(dt.push({row:t.row,col:t.col});t.parent;)dt.push({row:t.parent.row,col:t.parent.col}),t=t.parent;return dt.reverse()}lt.splice(t,1),ct.push(e);let i=e.neighbors;for(let t=0;t<i.length;t++){let s=i[t];if(!ct.includes(s)){let t=e.g+1;if(lt.includes(s)){if(t>=s.g)continue}else lt.push(s);s.g=t,s.h=(n=s,h=at,Math.abs(n.row-h.row)+Math.abs(n.col-h.col)),s.f=s.g+s.h,s.parent=e}}}var n,h;return[]}(this.grid,e,i,this)}}let{canvas:ft}=function(t,{contextless:e=!1}={}){return n=document.getElementById(t)||t||document.querySelector("canvas"),e&&(n=n||new Proxy({},r)),h=n.getContext("2d")||new Proxy({},r),h.imageSmoothingEnabled=!1,a("init"),{canvas:n,context:h}}();(function(){let t;for(t=0;t<26;t++)B["Key"+String.fromCharCode(t+65)]=String.fromCharCode(t+97);for(t=0;t<10;t++)B["Digit"+t]=B["Numpad"+t]=""+t;window.addEventListener("keydown",D),window.addEventListener("keyup",W),window.addEventListener("blur",q)})(),function({radius:t=5,canvas:e=l()}={}){let i=v.get(e);if(!i){let s=window.getComputedStyle(e);i={x:0,y:0,radius:t,touches:{length:0},canvas:e,_cf:[],_lf:[],_o:[],_oo:null,_s:s},v.set(e,i)}return e.addEventListener("mousedown",A),e.addEventListener("touchstart",A),e.addEventListener("mouseup",C),e.addEventListener("touchend",C),e.addEventListener("touchcancel",C),e.addEventListener("blur",X),e.addEventListener("mousemove",P),e.addEventListener("touchmove",P),i._t||(i._t=!0,n=()=>{i._lf.length=0,i._cf.map((t=>{i._lf.push(t)})),i._cf.length=0},o[s="tick"]=o[s]||[],o[s].push(n)),i;var s,n}({radius:.5});let gt=z({id:"bones"}),mt=z({id:"gameObjects"});mt.bonesList=gt;const wt={moves:2,range:1,maxHealth:10,team:"player",damage:[2,3],name:"Skeleton",unitType:0,imagePath:"img/skeleton.png",frames:[0,1]},_t={moves:2,range:1,maxHealth:5,team:"player",damage:[1,2],name:"Skelebird",unitType:1,imagePath:"img/skelebird.png",frames:[0,1]},xt={moves:2,range:1,maxHealth:10,team:"enemy",damage:[2,3],name:"Knight",unitType:0,imagePath:"img/knight.png",frames:[0,1]},yt={moves:2,range:1,maxHealth:5,team:"enemy",damage:[1,2],name:"Bird",unitType:1,imagePath:"img/bird.png",frames:[0,1]};let bt,vt,Et,St,kt,Ot=N({x:236,y:32,anchor:{x:.5,y:.5},padX:4,padY:2,text:{text:"Stay",color:"white",font:"12px Arial, sans-serif",anchor:{x:.5,y:.5}},onUp(){null!=Mt&&0===Mt.state&&(Mt.state=2,Ft(),Rt(Mt))},render(){this.hovered?this.textNode.color="#ff004d":this.textNode.color="white",this.context.lineWidth=2,this.context.strokeStyle=this.textNode.color,this.context.strokeRect(0,-1,this.width,this.height)}}),Tt=N({x:236,y:12,anchor:{x:.5,y:.5},padX:4,padY:2,text:{text:"End",color:"white",font:"12px Arial, sans-serif",anchor:{x:.5,y:.5}},onUp(){for(let t=0;t<Pt.length;t++)Pt[t].state=1;Ft(),Mt=null,Ut(Lt.EnemyTurn)},render(){this.hovered?this.textNode.color="#ff004d":this.textNode.color="white",this.context.lineWidth=2,this.context.strokeStyle=this.textNode.color,this.context.strokeRect(0,-1,this.width,this.height)}}),At=[],Ct=[],Pt=[],Xt=[],Mt=null;const Lt={PlayerTurn:0,EnemyTurn:1};let jt=0,Yt=z({id:"tileMap"}),Nt=new Image;function Ht(t){const e=[[-1,0],[1,0],[0,-1],[0,1]];let i=[];for(let s=0;s<e.length;s++){let n=t.col+e[s][0],h=t.row+e[s][1];h>=0&&h<=At.length-1&&n>=0&&n<=At[0].length-1&&i.push(At[h][n])}return i}function Ft(){Ct=[]}function Rt(t){Ft();let e=function(t){let e=[],i=[];const s=2===t.state;for(let t=0;t<At.length;t++)for(let e=0;e<At[0].length;e++)At[t][e].depth=1/0;let n=At[t.row][t.col];if(n.depth=0,i.push(n),1===t.state)return i;for(e.push(n);0!=i.length;){let n=i.shift();-1==e.indexOf(n)&&(!s&&t.canOccupyTile(n)||s)&&e.push(n);let h=Ht(n);for(let e=0;e<h.length;e++)if(s){let s=n.depth+1;if(s>t.range)continue;s<h[e].depth&&(h[e].depth=s,h[e].cameFrom=n,i.push(h[e]))}else{let s=n.depth+Math.max(h[e].cost,n.cost);const o="player"===Mt.team&&h[e].containsEnemy||"enemy"===Mt.team&&h[e].containsPlayer;if((!t.canOccupyTile(h[e])||o||s>t.moves)&&(s=Math.max(n.depth+1,t.moves+1),s>t.moves+t.range))continue;s<h[e].depth&&(h[e].depth=s,h[e].cameFrom=n,i.push(h[e]))}}return e}(t);for(let i=0;i<e.length;i++){if(1!==t.state&&e[i].row===t.row&&e[i].col===t.col)continue;let s=x({x:16*e[i].col,y:16*e[i].row,width:16,height:16,color:"player"===Mt.team?"#ff000077":"#ff000055"});s.dataObj=e[i],2===t.state?(e[i].depth<=t.range&&"player"===Mt.team&&e[i].containsEnemy&&j(s),s.isTile=!0):e[i].depth<=t.moves&&(s.color="player"===Mt.team?"#0000ff77":"#0000ff33","player"!==Mt.team||e[i].containsPlayer||j(s),s.isTile=!0),1===t.state&&(s.color="#23232344"),s.row=e[i].row,s.col=e[i].col,Ct.push(s)}}function It(t,e){if(t.health<=0)return;const i=(s=t.damageRange[0],n=t.damageRange[1],(Math.random()*(n-s+1)|0)+s);var s,n;if(e.damage(i),e.health<=0)if(e==bt&&console.log("Game over"),"player"===e.team){let t=Pt.indexOf(e);t>-1&&Pt.splice(t,1)}else if("enemy"===e.team){let t=Xt.indexOf(e);t>-1&&Xt.splice(t,1)}}function Bt(t){let e;0===t.type?e=new pt(mt,At,wt,t.row,t.col):1===t.type&&(e=new pt(mt,At,_t,t.row,t.col)),Pt.push(e),At[t.row][t.col].bonesObj=null;let i=gt.objects.indexOf(t.sprite);i>-1&&gt.objects.splice(i,1)}function Ut(t){if(jt=t,t===Lt.PlayerTurn){for(let t=0;t<Pt.length;t++)Pt[t].state=0;if(bt.health>0){let t=Ht(At[bt.row][bt.col]);for(let e=0;e<t.length;e++)t[e].containsEnemy||t[e].containsPlayer||t[e].bonesObj&&Bt(t[e].bonesObj)}}else if(t===Lt.EnemyTurn){for(let t=0;t<Xt.length;t++){let e=Xt[t],i=e.findTarget(Pt);if(null!=i)if(e.distanceTo(i)<=e.range)e.state=2,console.log(e.name+" can attack "+i.name),It(e,i),It(i,e),e.state=1;else{let t=e.calculatePathTo(e.findTarget(Pt)),s=[];for(let i=0;i<t.length&&i<=e.moves;i++){let e=x({x:16*t[i].col+4,y:16*t[i].row+4,width:8,height:8,color:"#ff000055"});Ct.push(e),s.push(t[i])}let n=s.length-1,h=s[n],o=At[h.row][h.col];for(;n>0&&(o.containsEnemy||o.containsPlayer);)n--,h=s[n],o=At[h.row][h.col];e.move(s[n]),e.distanceTo(i)<=e.range&&(console.log(e.name+" can attack "+i.name),It(e,i),It(i,e)),e.state=1}}Ut(Lt.PlayerTurn)}}Nt.src="img/tiles.png",Nt.onload=function(){let t=function(){return new Q(...arguments)}({tilewidth:16,tileheight:16,width:16,height:9,tilesets:[{firstgid:1,image:Nt}],layers:[{name:"main",data:[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,1,1,1,1,1,1,2,2,1,1,1,1,1,1,3,3,1,3,1,1,1,1,1,1,1,1,1,1,1,1,3,3,1,1,1,1,1,1,2,2,1,1,3,2,3,1,3,3,1,3,1,1,1,1,1,1,1,1,1,1,1,1,3,3,1,1,1,1,1,1,2,2,1,1,3,2,3,1,3,3,1,3,1,1,1,1,1,1,1,1,1,1,1,1,3,3,1,1,1,1,1,1,2,2,1,1,1,1,1,1,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]}]});Yt.add(t);for(let e=0;e<t.height;e++)At[e]=[];for(let e=0;e<t.layers[0].data.length;e++){const i=t.layers[0].data[e],s=Math.floor(e/t.width),n=e%t.width;At[s][n]=new st(s,n,i,1)}bt=new pt(mt,At,{moves:2,range:1,maxHealth:10,team:"player",damage:[1,2],name:"Player",unitType:0,imagePath:"img/lich.png",frames:[0,1]},4,3),Pt.push(bt),St=new pt(mt,At,_t,5,2),Pt.push(St),Et=new pt(mt,At,wt,3,2),Pt.push(Et),vt=new pt(mt,At,xt,4,14),Xt.push(vt),kt=new pt(mt,At,yt,4,12),Xt.push(kt),Xt.push(new pt(mt,At,yt,2,12)),Xt.push(new pt(mt,At,yt,6,12))},function(t,e){let i=t[0].toUpperCase()+t.substr(1);E["on"+i]=function(t,e){if(jt===Lt.PlayerTurn)if(e&&e.unit){let t=e.unit;Mt==t?(Mt=null,Ft()):(Mt=t,Rt(t))}else if(null==e)Mt=null,Ft();else if(e.isTile&&"player"===Mt.team)if(0===Mt.state)Mt.move(e),Ft(),Mt=null;else if(2===Mt.state){let t;for(let i=0;i<Xt.length;i++)if(Xt[i].row===e.dataObj.row&&Xt[i].col===e.dataObj.col){t=Xt[i];break}Mt.state=1,It(Mt,t),It(t,Mt),Ft(),Mt=null}}}("down"),function({fps:e=60,clearCanvas:i=!0,update:s=t,render:n,context:h=c(),blur:o=!1}={}){let r,l,d,u,p,f=0,g=1e3/e,m=1/e,w=i?H:t,_=!0;function x(){if(l=requestAnimationFrame(x),_&&(d=performance.now(),u=d-r,r=d,!(u>1e3))){for(a("tick"),f+=u;f>=g;)p.update(m),f-=g;w(h),p.render()}}return o||(window.addEventListener("focus",(()=>{_=!0})),window.addEventListener("blur",(()=>{_=!1}))),p={update:s,render:n,isStopped:!0,start(){r=performance.now(),this.isStopped=!1,requestAnimationFrame(x)},stop(){this.isStopped=!0,cancelAnimationFrame(l)}},p}({update:function(){Yt.update(),mt.update()},render:function(){Yt.render(),gt.render(),mt.render();for(let t=0;t<Ct.length;t++)Ct[t].render();jt===Lt.PlayerTurn&&(Mt&&"player"===Mt.team&&0===Mt.state&&Ot.render(),Tt.render())}}).start(),window.nearInitPromise=async function(){const t=await Z(Object.assign({deps:{keyStore:new tt.BrowserLocalStorageKeyStore}},it));window.walletConnection=new et(t),window.accountId=window.walletConnection.getAccountId(),window.contract=await new $(window.walletConnection.account(),it.contractName,{viewMethods:["getLevels"],changeMethods:["addLevel"]})}().then((()=>{window.walletConnection.isSignedIn()&&console.log("Signed in:",window.accountId)})).catch(console.error)})()</script>