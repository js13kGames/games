<!doctype html><title>Feline Fury - js13kGames 2025</title><style>#c2d{width:min(100vw,100vh);height:min(100vw,100vh);position:absolute}body,html{background-image:radial-gradient(1px 1px at 20px 20px,#fff,transparent),radial-gradient(1.5px 1.5px at 100px 200px,#fff,transparent),radial-gradient(2px 2px at 300px 100px,#fff,transparent),radial-gradient(ellipse at bottom,#1b2735 0,#090a0f 100%);display:flex;justify-content:center;align-items:center;height:100%;margin:0;overflow:hidden}</style><canvas height=360 id=c2d width=240></canvas><script>const t=new class{constructor(){this.context=c2d.getContext("2d"),this.context.imageSmoothingEnabled=!0}get canvasWidth(){return this.context.canvas.width}get canvasHeight(){return this.context.canvas.height}drawText(t,e,s,i,n="white",a="center"){const h=this.context;h.font=`${e}px Impact, sans-serif-black`,h.textAlign=a,h.strokeStyle="black",h.lineWidth=4,h.strokeText(t,s,i),h.fillStyle=n,h.fillText(t,s,i)}},e=new class{constructor(){this.isUp=!1,this.isDown=!1,this.isLeft=!1,this.isRight=!1,this.isConfirm=!1,this.isEscape=!1,this.isAttacking=!1,this.keyMap=new Map,this.previousState={isUp:this.isUp,isDown:this.isDown,isConfirm:this.isConfirm,isEscape:this.isEscape,isAttacking:this.isAttacking},this.isMobile=!1,this.shouldShowMobileControls=!1,this.mobileSpeedMultiplier=.7,this.mobileWidthThreshold=912,this.touchControls={joystick:null,joystickKnob:null,attackButton:null,joystickCenter:{x:0,y:0},joystickRadius:75,isDragging:!1,touchDirection:{x:0,y:0},isAttackPressed:!1,lastAttackTime:0,attackThrottleMs:200},document.addEventListener("keydown",t=>this.toggleKey(t,!0)),document.addEventListener("keyup",t=>this.toggleKey(t,!1)),this.inputDirection=new DOMPoint,this.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0,this.checkMobileControlsVisibility(),window.addEventListener("resize",()=>this.handleResize())}queryController(){this.previousState.isUp=this.isUp,this.previousState.isDown=this.isDown,this.previousState.isConfirm=this.isConfirm,this.previousState.isEscape=this.isEscape,this.previousState.isAttacking=this.isAttacking;const t=navigator.getGamepads()[0],e=e=>t?.buttons[e].pressed,s=this.keyMap.get("KeyA")||this.keyMap.get("ArrowLeft")||e(14)?-1:0,i=this.keyMap.get("KeyD")||this.keyMap.get("ArrowRight")||e(15)?1:0,n=this.keyMap.get("KeyW")||this.keyMap.get("ArrowUp")||e(12)?-1:0,a=this.keyMap.get("KeyS")||this.keyMap.get("ArrowDown")||e(13)?1:0;let h=s+i||t?.axes[0]||(this.shouldShowMobileControls?this.touchControls.touchDirection.x:0),o=n+a||t?.axes[1]||(this.shouldShowMobileControls?this.touchControls.touchDirection.y:0);!this.shouldShowMobileControls||0===this.touchControls.touchDirection.x&&0===this.touchControls.touchDirection.y||(h*=this.mobileSpeedMultiplier,o*=this.mobileSpeedMultiplier),this.inputDirection.x=h,this.inputDirection.y=o,Math.hypot(this.inputDirection.x,this.inputDirection.y)<.1&&(this.inputDirection.x=0,this.inputDirection.y=0),this.isUp=this.inputDirection.y<0,this.isDown=this.inputDirection.y>0,this.isLeft=this.inputDirection.x<0,this.isRight=this.inputDirection.x>0,this.isConfirm=Boolean(this.keyMap.get("Enter")||e(0)||e(9)),this.isEscape=Boolean(this.keyMap.get("Escape")||e(8));const r=Boolean(this.keyMap.get("KeyZ")),c=this.shouldShowMobileControls&&this.touchControls.isAttackPressed;let l=!0;if(c){const t=Date.now();l=t-this.touchControls.lastAttackTime>=this.touchControls.attackThrottleMs,l&&(this.touchControls.lastAttackTime=t)}const d=r||c&&l;this.isAttacking=d&&!this.previousState.isAttacking}toggleKey(t,e){this.keyMap.set(t.code,e)}setupMobileControls(){if(this.touchControls.joystick||this.touchControls.attackButton)return;const t=document.createElement("div");t.className="mobile-joystick",t.style.cssText="\n      position: fixed;\n      bottom: 120px;\n      left: 120px;\n      width: 150px;\n      height: 150px;\n      background: rgba(255, 255, 255, 0.2);\n      border: 3px solid rgba(255, 255, 255, 0.4);\n      border-radius: 50%;\n      z-index: 1000;\n      touch-action: none;\n      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);\n    ";const e=document.createElement("div");e.className="mobile-joystick-knob",e.style.cssText="\n      position: absolute;\n      width: 60px;\n      height: 60px;\n      background: rgba(255, 255, 255, 0.9);\n      border: 2px solid rgba(200, 200, 200, 0.8);\n      border-radius: 50%;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      transition: all 0.1s ease;\n      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);\n    ";const s=document.createElement("div");s.className="mobile-attack-button",s.style.cssText="\n      position: fixed;\n      bottom: 120px;\n      right: 120px;\n      width: 110px;\n      height: 110px;\n      background: rgba(255, 80, 80, 0.8);\n      border: 3px solid rgba(255, 255, 255, 0.6);\n      border-radius: 50%;\n      z-index: 1000;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      color: white;\n      font-weight: bold;\n      font-size: 28px;\n      touch-action: none;\n      user-select: none;\n      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);\n      transition: all 0.1s ease;\n    ",s.textContent="Z",t.appendChild(e),document.body.appendChild(t),document.body.appendChild(s),this.touchControls.joystick=t,this.touchControls.joystickKnob=e,this.touchControls.attackButton=s;const i=t.getBoundingClientRect();this.touchControls.joystickCenter.x=i.left+i.width/2,this.touchControls.joystickCenter.y=i.top+i.height/2,this.addTouchEventListeners()}addTouchEventListeners(){const t=this.touchControls.joystick,e=this.touchControls.attackButton;t.addEventListener("touchstart",t=>this.handleJoystickStart(t),{passive:!1}),t.addEventListener("touchmove",t=>this.handleJoystickMove(t),{passive:!1}),t.addEventListener("touchend",t=>this.handleJoystickEnd(t),{passive:!1}),e.addEventListener("touchstart",t=>this.handleAttackStart(t),{passive:!1}),e.addEventListener("touchend",t=>this.handleAttackEnd(t),{passive:!1}),document.addEventListener("touchend",t=>this.handleGlobalTouchEnd(t),{passive:!1})}handleJoystickStart(t){t.preventDefault(),this.touchControls.isDragging=!0;const e=this.touchControls.joystick.getBoundingClientRect();this.touchControls.joystickCenter.x=e.left+e.width/2,this.touchControls.joystickCenter.y=e.top+e.height/2}handleJoystickMove(t){if(t.preventDefault(),!this.touchControls.isDragging)return;const e=t.touches[0],s=e.clientX-this.touchControls.joystickCenter.x,i=e.clientY-this.touchControls.joystickCenter.y,n=Math.hypot(s,i),a=this.touchControls.joystickRadius;if(n<=a)this.touchControls.touchDirection.x=s/a,this.touchControls.touchDirection.y=i/a,this.touchControls.joystickKnob.style.transform=`translate(${s-30}px, ${i-30}px)`;else{const t=Math.atan2(i,s),e=Math.cos(t)*a,n=Math.sin(t)*a;this.touchControls.touchDirection.x=e/a,this.touchControls.touchDirection.y=n/a,this.touchControls.joystickKnob.style.transform=`translate(${e-30}px, ${n-30}px)`}}handleJoystickEnd(t){t.preventDefault(),this.touchControls.isDragging=!1,this.touchControls.touchDirection.x=0,this.touchControls.touchDirection.y=0,this.touchControls.joystickKnob.style.transform="translate(-50%, -50%)"}handleAttackStart(t){t.preventDefault(),this.touchControls.isAttackPressed=!0,this.touchControls.attackButton.style.background="rgba(255, 30, 30, 0.95)",this.touchControls.attackButton.style.transform="scale(0.95)",this.touchControls.attackButton.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.5)"}handleAttackEnd(t){t.preventDefault(),this.touchControls.isAttackPressed=!1,this.touchControls.attackButton.style.background="rgba(255, 80, 80, 0.8)",this.touchControls.attackButton.style.transform="scale(1)",this.touchControls.attackButton.style.boxShadow="0 4px 20px rgba(0, 0, 0, 0.3)"}handleGlobalTouchEnd(t){0===t.touches.length&&(this.handleJoystickEnd(t),this.handleAttackEnd(t))}checkMobileControlsVisibility(){const t=this.isMobile||window.innerWidth<this.mobileWidthThreshold;t&&!this.shouldShowMobileControls?(this.shouldShowMobileControls=!0,this.setupMobileControls()):!t&&this.shouldShowMobileControls&&(this.shouldShowMobileControls=!1,this.hideMobileControls())}handleResize(){this.checkMobileControlsVisibility()}hideMobileControls(){this.touchControls.joystick&&(this.touchControls.joystick.remove(),this.touchControls.joystick=null),this.touchControls.attackButton&&(this.touchControls.attackButton.remove(),this.touchControls.attackButton=null),this.touchControls.joystickKnob=null,this.touchControls.isDragging=!1,this.touchControls.touchDirection.x=0,this.touchControls.touchDirection.y=0,this.touchControls.isAttackPressed=!1}};class s{constructor(t,...e){this.currentState=t,this.currentState.onEnter?.(...e)}setState(t,...e){this.currentState.onLeave?.(),this.currentState=t,this.currentState.onEnter?.(...e)}resumeState(t){this.currentState.onLeave?.(),this.currentState=t}update(t){this.currentState.onUpdate(t)}getState(){return this.currentState}}let i;class n{constructor(t,e,s=!0){this.name=t,this.frames=e,this.loops=s,this.frameIndex=0,this.timer=0,this.isFinished=!1}update(t){if(this.isFinished||this.frames.length<=1)return;this.timer+=t;const[,e]=this.frames[this.frameIndex];this.timer>=e&&(this.timer-=e,this.frameIndex===this.frames.length-1?this.loops?this.frameIndex=0:this.isFinished=!0:this.frameIndex++)}get currentFrameImage(){return this.frames[this.frameIndex][0]}reset(){this.frameIndex=0,this.timer=0,this.isFinished=!1}}function a(t){return new Promise((e,s)=>{const i=new Image;i.onload=()=>e(i),i.onerror=e=>s(new Error(`Failed to load image at ${t}: ${e}`)),i.src=t})}const h={"attack-16.png":{x:1,y:1,w:16,h:16},"bookshelf-16.png":{x:19,y:1,w:16,h:16},"boss-anger.png":{x:37,y:1,w:36,h:48},"boss-base.png":{x:1,y:51,w:36,h:48},"boss-defeat.png":{x:39,y:51,w:36,h:48},"boss-hurt.png":{x:75,y:1,w:36,h:48},"cabinet-16.png":{x:113,y:1,w:16,h:16},"cat-12-24.png":{x:1,y:19,w:12,h:24},"cucumber-16.png":{x:15,y:19,w:16,h:16},"flippers-16.png":{x:113,y:19,w:16,h:16},"robot-16.png":{x:113,y:37,w:16,h:16}},o=new class{constructor(){this.spritesheet=null,this.spriteCache=new Map,this.imageCache=new Map}async loadSpritesheet(t){this.spritesheet=await a(t)}getSprite(t){if(!this.spritesheet)throw new Error("Spritesheet not loaded. Call loadSpritesheet() first.");if(this.spriteCache.has(t))return this.spriteCache.get(t);const e=h[t];if(!e)throw new Error(`Sprite "${t}" not found in spritesheet.`);const s=document.createElement("canvas");s.width=e.w,s.height=e.h;const i=s.getContext("2d");if(!i)throw new Error("Could not get 2D context for sprite canvas");return i.drawImage(this.spritesheet,e.x,e.y,e.w,e.h,0,0,e.w,e.h),this.spriteCache.set(t,s),s}getSpriteAsImage(t){return this.getSprite(t)}isLoaded(){return null!==this.spritesheet}},r=new class{constructor(){this.images=new Map,this.usesSpritesheet=!1}async loadImages(t){const e=t.map(t=>a(t).then(e=>this.images.set(t,e)));await Promise.all(e)}async loadSpritesheet(t){await o.loadSpritesheet(t),this.usesSpritesheet=!0}getImage(t){if(this.images.has(t))return this.images.get(t);if(this.usesSpritesheet)try{const e=t.startsWith("/")?t.substring(1):t,s=this.getSprite(e);return this.images.set(t,s),s}catch(t){}throw new Error(`Image not found: ${t}. Make sure to preload it.`)}getSprite(t){if(!this.usesSpritesheet)throw new Error("Spritesheet not loaded. Call loadSpritesheet() first.");return o.getSprite(t)}getSpriteAsImage(t){if(!this.usesSpritesheet)throw new Error("Spritesheet not loaded. Call loadSpritesheet() first.");return o.getSpriteAsImage(t)}},c={c_:130.81,"c#_":138.59,d_:146.83,"d#_":155.56,e_:164.81,f_:174.61,"f#_":185,g_:196,"g#_":207.65,a_:220,"a#_":233.08,b_:246.94,c:261.63,"c#":277.18,d:293.66,"d#":311.13,e:329.63,f:349.23,"f#":369.99,g:392,"g#":415.3,a:440,"a#":466.16,b:493.88,C:523.25,"C#":554.37,D:587.33,"D#":622.25,E:659.25,F:698.46,"F#":739.99,G:783.99,"G#":830.61,A:880,"A#":932.33,B:987.77},l=new class{constructor(){this.audioCtx=null,this.isEnabled=!1,this.musicEnabled=!0,this.activeLoops=new Map,this.activeOscillators=[]}init(){if(!this.audioCtx)try{this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.isEnabled=!0}catch(t){console.error("Web Audio API is not supported in this browser"),this.isEnabled=!1}}compileSimplifiedTune(t){const e=[],s=(t,e)=>t&&0!==t.length?t.map(t=>{const s=t.match(/^([a-gA-G]#?_?|[-_])([\d.]+)$/);if(!s)return console.warn(`Invalid note format: ${t}`),[null,e,0];const[,i,n]=s,a=.1*parseFloat(n);if("-"===i||"_"===i)return[null,e,a];const h=c[i];return void 0===h?(console.warn(`Unknown note: ${i}`),[null,e,a]):[h,e,a]}):null,i=s(t.sine,"sine");i&&e.push(i);const n=s(t.square,"square");n&&e.push(n);const a=s(t.sawtooth,"sawtooth");a&&e.push(a);const h=s(t.triangle,"triangle");return h&&e.push(h),e}play(t,e=.3){if(!this.isEnabled||!this.audioCtx)return;const s=this.compileSimplifiedTune(t),i=this.audioCtx.createGain();i.gain.value=e,i.connect(this.audioCtx.destination),s.forEach(t=>{let e=0;const s=this.audioCtx.currentTime;t.forEach(([t,n,a])=>{if(t){const h=this.audioCtx.createOscillator();h.type=n,h.frequency.setValueAtTime(t,s+e);const o=this.audioCtx.createGain();o.gain.setValueAtTime(.001,s+e),o.gain.linearRampToValueAtTime(.3,s+e+.05),o.gain.exponentialRampToValueAtTime(.001,s+e+a),h.connect(o).connect(i),this.activeOscillators.push(h),h.onended=()=>{const t=this.activeOscillators.indexOf(h);t>-1&&this.activeOscillators.splice(t,1)},h.start(s+e),h.stop(s+e+a)}e+=a})})}playLoop(t,e){if(!this.isEnabled||!this.audioCtx||!this.musicEnabled)return;this.stopLoop(t);const s=this.compileSimplifiedTune(t);let i=0;s.forEach(t=>{let e=0;t.forEach(([,,t])=>{e+=t}),e>i&&(i=e)});const n=s.map(t=>{let e=0;if(t.forEach(([,,t])=>{e+=t}),e>=i)return t;const s=[...t];let n=e;for(;n<i;)for(const e of t){if(n>=i)break;const[t,a,h]=e,o=i-n,r=Math.min(h,o);s.push([t,a,r]),n+=r}return s}),a=()=>{const t=this.audioCtx.createGain();t.gain.value=.3,t.connect(this.audioCtx.destination),n.forEach((s,i)=>{let n=0;const a=this.audioCtx.currentTime,h=e&&void 0!==e[i]?e[i]:.3;s.forEach(([e,s,i])=>{if(e){const o=this.audioCtx.createOscillator();o.type=s,o.frequency.setValueAtTime(e,a+n);const r=this.audioCtx.createGain();r.gain.setValueAtTime(.001,a+n),r.gain.linearRampToValueAtTime(h,a+n+.05),r.gain.exponentialRampToValueAtTime(.001,a+n+i),o.connect(r).connect(t),this.activeOscillators.push(o),o.onended=()=>{const t=this.activeOscillators.indexOf(o);t>-1&&this.activeOscillators.splice(t,1)},o.start(a+n),o.stop(a+n+i)}n+=i})})};a();const h=window.setInterval(a,1e3*i);this.activeLoops.set(t,h)}stopLoop(t){this.activeLoops.has(t)&&(clearInterval(this.activeLoops.get(t)),this.activeLoops.delete(t))}stopAllLoops(){this.activeLoops.forEach(t=>{clearInterval(t)}),this.activeLoops.clear(),this.activeOscillators.forEach(t=>{try{t.stop()}catch(t){}}),this.activeOscillators.length=0}setMusicEnabled(t){this.musicEnabled=t,t||this.stopAllLoops()}isMusicEnabled(){return this.musicEnabled}},d={sawtooth:["A0.5","E1"]},u={square:["a1","a_1.5"]},g={sine:["C4","C2","a2","g2","-2","e2","-2","d2","e2","g8","-8","a4","a2","C2","a2","-2","E2","-2","D2","C2","D8","-8","C2","D2","E2","-2","g2","-2","a2","C2","-4","D2","C2","D2","E2","D2","-2","D2","C2","D2","E2","G2","E2","G2","A2","G2","E2","D2","E2","C4","-4"],square:["c4","d4","e4","f4","e4","d4","e4","c4","d4","e4","d4","c4","b_4","a_4","b_4","g_4"],triangle:["c_2","c_2","c2","c_2","c_2","-2","b_2","c2"]},p={square:["a2","D#2","D2","C2","C2","D1","C1","g2","a2","a2","D#2","D2","C2","C2","D1","C1","g2","a2","D2","A2","G#2","F#2","F#2","G#1","F#1","C2","D2","D2","A2","G#2","F#2","F#2","G#1","F#1","C2","D2","a2","D#2","D2","C2","C2","D1","C1","g2","a2","a2","D#2","D2","C2","C2","D1","C1","g2","a2","D2","A2","G#2","F#2","F#2","G#1","F#1","C2","D2","D2","A2","G#2","F#2","F#2","G#1","F#1","C2","D2","a1","a1","a#1","a1","a#1","a1","C1","D1","a1","a1","a#1","a1","a#1","a1","C1","D1","D1","D1","D#1","D1","D#1","D1","F#1","G1","D1","D1","D#1","D1","D#1","D1","F#1","G1","D#1","D1","C#1","D1","D#1","D1","C#1","D1","G#1","G1","F#1","G1","G#1","G1","F#1","G1"],triangle:["g#_2","c2","g#_2","c2","g#_2","a_2","g#_2","c2"]},m={triangle:["C1","E1","G1","A4","F4","G4","A4","G1","A3"],sine:["-8","C4","D4","E4","D1","E3"]};class y{constructor(t,e,s){this.context=t,this.x=e,this.y=s,this.animations=new Map,this.width=12,this.height=24,this.isAttacking=!1,this.attackCooldown=1e3,this.attackTimer=this.attackCooldown,this.isLoaded=!1,this.load()}load(){const t=r.getImage("cat-12-24.png"),e=document.createElement("canvas");e.width=12,e.height=24;const s=e.getContext("2d");s&&(s.translate(12,0),s.scale(-1,1),s.drawImage(t,0,0));const i=new n("normal",[[t,200],[e,200]]);this.animations.set("normal",i),this.currentAnimation=i;const a=r.getImage("attack-16.png"),h=document.createElement("canvas");h.width=16,h.height=16;const o=h.getContext("2d");o&&(o.translate(16,0),o.scale(-1,1),o.drawImage(a,0,0));const c=[[a,100],[h,100]];this.attackAnimation=new n("attack",c,!1)}update(t){this.attackTimer+=t,e.isAttacking&&!this.isAttacking&&this.attackTimer>=this.attackCooldown&&(this.isAttacking=!0,this.attackAnimation.reset(),this.attackTimer=0,l.play(d,1.5)),this.isAttacking&&(this.attackAnimation.update(t),this.attackAnimation.isFinished&&(this.isAttacking=!1)),this.handleMovement(),this.currentAnimation.update(t)}handleMovement(){this.x+=2*e.inputDirection.x,this.y+=2*e.inputDirection.y,this.x<0&&(this.x=0),this.x>this.context.canvas.width-12&&(this.x=this.context.canvas.width-12),this.y<0&&(this.y=0),this.y>this.context.canvas.height-24&&(this.y=this.context.canvas.height-24)}draw(){if(this.context.drawImage(this.currentAnimation.currentFrameImage,this.x,this.y),this.isAttacking){const t=this.x+this.width/2-8,e=this.y-24;this.context.drawImage(this.attackAnimation.currentFrameImage,t,e)}}getAttackCooldownProgress(){return Math.min(this.attackTimer/this.attackCooldown,1)}isAttackReady(){return this.attackTimer>=this.attackCooldown}}class w{constructor(t){this.drawEngine=t,this.y=0,this.speed=.03,this.patternHeight=0,this.pattern=null,this.cabinetImage=r.getImage("cabinet-16.png"),this.bookshelfImage=r.getImage("bookshelf-16.png"),this.createPattern()}createPattern(){if(!this.cabinetImage||!this.bookshelfImage)return;const t=document.createElement("canvas");t.width=32,t.height=48;const e=t.getContext("2d");e&&e.drawImage(this.cabinetImage,0,0,32,48);const s=document.createElement("canvas");s.width=32,s.height=64;const i=s.getContext("2d");i&&(i.drawImage(this.cabinetImage,0,22,32,32),i.drawImage(this.bookshelfImage,0,0,32,32));const{canvasWidth:n,canvasHeight:a}=this.drawEngine;this.patternHeight=2*a;const h=document.createElement("canvas");h.width=n,h.height=this.patternHeight;const o=h.getContext("2d");if(o){o.fillStyle="#8f563b",o.strokeStyle="#45283c",o.lineWidth=1;for(let t=0;t<h.height;t+=16)for(let e=t/16%2==0?0:-48;e<h.width;e+=96)o.fillRect(e,t,96,16),o.strokeRect(e,t,96,16);for(let e=0;e<h.height;e+=128){const i=Math.random()*(n-32);Math.random()<.5?o.drawImage(s,i,e):o.drawImage(t,i,e)}this.pattern=this.drawEngine.context.createPattern(h,"repeat-y")}}update(t){this.patternHeight>0&&(this.y=(this.y+this.speed*t)%this.patternHeight)}draw(){const{context:t,canvasWidth:e,canvasHeight:s}=this.drawEngine;this.pattern&&(t.save(),t.translate(0,this.y),t.fillStyle=this.pattern,t.fillRect(0,-this.y,e,s),t.restore())}}const x=new class{constructor(){this.isVictory=!1,this.enterTime=0,this.INPUT_DELAY=500}onEnter(t){this.isVictory=t||!1,this.enterTime=performance.now(),l.stopAllLoops(),this.isVictory&&l.isMusicEnabled()&&l.play(m,1.2)}onUpdate(){this.updateControls()}onDraw(){const e=t.context.canvas.width/2,s=E.getScore().toString().padStart(8,"0");this.isVictory&&(t.context.fillStyle="black",t.context.fillRect(0,0,t.context.canvas.width,t.context.canvas.height));const i=this.isVictory?"Victory!":"Game Over";if(t.drawText(i,30,e,80),t.drawText(`Final Score: ${s}`,18,e,140,"white"),this.isVictory){const s=r.getImage("ending-32.png");s&&t.context.drawImage(s,e-32,160,64,64),t.drawText("Start Over",18,e,240,"white")}else t.drawText("Start Over",18,e,200,"white")}updateControls(){performance.now()-this.enterTime<this.INPUT_DELAY||(e.isConfirm&&!e.previousState.isConfirm||e.isAttacking&&!e.previousState.isAttacking)&&i.setState(E)}onExit(){l.stopAllLoops()}};class f{constructor(t,e){this.context=t,this.mainCharacter=e,this.x=0,this.y=0,this.isDead=!1}update(t){this.currentAnimation.update(t),this.checkCollision()}checkCollision(){const t=this.mainCharacter;if(t.isAttacking){const e=16,s=16,i=t.x+t.width/2-e/2,n=t.y-24;if(this.x<i+e&&this.x+this.width>i&&this.y<n+s&&this.y+this.height>n)return this.isDead=!0,void l.play(u)}this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y&&i.setState(x)}draw(){this.context.drawImage(this.currentAnimation.currentFrameImage,this.x,this.y,this.width,this.height)}}class b extends f{constructor(t,e,s){super(t,s),this.path=e,this.animations=new Map,this.time=0,this.width=24,this.height=24,this.load()}load(){const t=r.getImage("robot-16.png"),e=document.createElement("canvas");e.width=16,e.height=16;const s=e.getContext("2d");s&&(s.translate(16,0),s.scale(-1,1),s.drawImage(t,0,0),s.fillStyle="#B13E53",s.fillRect(6,5,2,2));const i=new n("default",[[t,200],[e,200]]);this.animations.set("default",i),this.currentAnimation=i}update(t){this.time+=t;const e=this.path(this.time);this.x=e.x,this.y=e.y,super.update(t)}}class C extends f{constructor(t,e,s){super(t,s),this.path=e,this.animations=new Map,this.time=0,this.width=24,this.height=24,this.load()}load(){const t=r.getImage("flippers-16.png"),e=document.createElement("canvas");e.width=16,e.height=16;const s=e.getContext("2d");s&&(s.translate(16,0),s.scale(-1,1),s.drawImage(t,0,0));const i=new n("default",[[t,500],[e,300]]);this.animations.set("default",i),this.currentAnimation=i}update(t){this.time+=t;const e=this.path(this.time);this.x=e.x,this.y=e.y,super.update(t)}}class k extends f{constructor(t,e,s){super(t,s),this.path=e,this.animations=new Map,this.time=0,this.angle=0,this.width=16,this.height=16,this.isReflected=!1,this.speed=0,this.load()}load(){const t=r.getImage("cucumber-16.png"),e=new n("default",[[t,100]]);this.animations.set("default",e),this.currentAnimation=e}update(t){if(this.isReflected)this.y-=1.5*this.speed*t;else{this.time+=t;const e=this.path(this.time);this.x=e.x,this.y=e.y}this.angle+=.005*t,super.update(t)}checkCollision(){const t=this.mainCharacter;if(t.isAttacking&&!this.isReflected){const e=16,s=16,i=t.x+t.width/2-e/2,n=t.y-24;if(this.x<i+e&&this.x+this.width>i&&this.y<n+s&&this.y+this.height>n)return this.isReflected=!0,void(this.time>0&&(this.speed=this.y/this.time))}this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y&&i.setState(x)}draw(){this.context.save(),this.context.translate(this.x+this.width/2,this.y+this.height/2),this.context.rotate(this.angle),this.context.drawImage(this.currentAnimation.currentFrameImage,-this.width/2,-this.height/2),this.context.restore()}}class v extends f{constructor(e,s,i){super(e,s),this.animations=new Map,this.time=0,this.width=36,this.height=48,this.health=8,this.stage=1,this.paths=new Map,this.isInvincible=!1,this.invincibilityTime=0,this.hurtTime=0,this.gameOverCallback=i,this.x=t.canvasWidth/2-this.width/2,this.y=20,this.isInvincible=!0,this.invincibilityTime=300,this.load(),this.setupPaths(),this.setState("anger")}load(){const t=r.getImage("boss-base.png"),e=r.getImage("boss-anger.png"),s=r.getImage("boss-hurt.png"),i=r.getImage("boss-defeat.png"),a=e=>{const s=document.createElement("canvas");s.width=36,s.height=48;const i=s.getContext("2d");return i&&(i.drawImage(t,0,0,36,48),i.drawImage(e,0,0,36,48)),s},h=a(e),o=a(s),c=a(i);this.animations.set("anger",new n("anger",[[h,200]])),this.animations.set("hurt",new n("hurt",[[o,200]])),this.animations.set("defeat",new n("defeat",[[c,200]]))}setupPaths(){this.paths.set("stage1_anger",e=>({x:t.canvasWidth/2-this.width/2+70*Math.cos(e/500-1.57),y:100+70*Math.sin(e/500-1.57)})),this.paths.set("stage2_anger",e=>({x:t.canvasWidth/2-this.width/2+Math.sin(e/1e3)*(t.canvasWidth/2-this.width/2-20),y:80+30*Math.sin(e/300)})),this.paths.set("stage3_defeat",e=>({x:this.x,y:this.y<t.canvasHeight?this.y+1:this.y})),this.paths.set("hurt",()=>({x:this.x,y:this.y}))}update(t){this.time+=t,this.updateTimers(t),this.updateStageAndState(),"repositioning"===this.state?this.handleRepositioning():this.handleMovement(),super.update(t)}updateTimers(t){this.isInvincible&&(this.invincibilityTime-=t,this.invincibilityTime<=0&&(this.isInvincible=!1)),this.hurtTime>0&&(this.hurtTime-=t,this.hurtTime<=0&&this.stage<3&&this.setState("anger"))}updateStageAndState(){const t=this.stage;this.health>4?this.stage=1:this.health>0?this.stage=2:(this.stage=3,this.setState("defeat")),2===this.stage&&1===t&&this.setState("repositioning")}handleRepositioning(){const e=t.canvasWidth/2-this.width/2,s=e-this.x,i=80-this.y,n=Math.sqrt(s*s+i*i);n<2?(this.x=e,this.y=80,this.setState("anger")):(this.x+=s/n*2,this.y+=i/n*2)}handleMovement(){let t=`stage${this.stage}_${this.state}`;"hurt"===this.state&&(t="hurt");const e=this.paths.get(t);if(e){const t=e(this.time);this.x=t.x,this.y=t.y}}checkCollision(){if("defeat"===this.state||this.isInvincible)return;const t=this.mainCharacter;!t.isAttacking&&this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y&&this.triggerGameOver()}triggerGameOver(){this.gameOverCallback&&this.gameOverCallback()}checkAttackCollision(){if(!this.mainCharacter.isAttacking||this.isInvincible||"defeat"===this.state)return!1;const t=this.mainCharacter,e=t.x+t.width/2-8,s=t.y-24;return this.x<e+16&&this.x+this.width>e&&this.y<s+16&&this.y+this.height>s}takeDamage(){this.isInvincible||"defeat"===this.state||(this.health>0&&this.health--,this.isInvincible=!0,this.invincibilityTime=300,this.setState("hurt"),this.hurtTime=200)}setState(t){if(this.state===t)return;if("defeat"===this.state&&"defeat"!==t)return;this.state=t;const e=this.animations.get(t);e?this.currentAnimation=e:"repositioning"===t&&(this.currentAnimation=this.animations.get("anger"))}isDefeated(){return this.health<=0}draw(){this.currentAnimation&&this.currentAnimation.currentFrameImage?this.context.drawImage(this.currentAnimation.currentFrameImage,this.x,this.y,this.width,this.height):(this.context.fillStyle="#FF0000",this.context.fillRect(this.x,this.y,this.width,this.height))}}class S{constructor(){this.enemies=[],this.enemyTypes=[],this.isSpawning=!0,this.enemyScoreMap=new Map}registerEnemyType(t,e,s){this.enemyTypes.push({generator:t,spawnInterval:e,lastSpawn:0,score:s})}start(){this.isSpawning=!0}stop(){this.isSpawning=!1}clear(){this.enemies=[],this.enemyScoreMap.clear(),this.enemyTypes=[]}setScoreCallback(t){this.scoreCallback=t}update(e){if(this.isSpawning){const t=performance.now();this.enemyTypes.forEach(e=>{if(t-e.lastSpawn>e.spawnInterval){e.lastSpawn=t;const s=e.generator();this.enemies.push(s),this.enemyScoreMap.set(s,e.score)}})}this.enemies.forEach(t=>t.update(e));const s=this.enemies.filter(t=>t instanceof k&&t.isReflected&&!t.isDead),i=this.enemies.filter(t=>!s.includes(t)&&!t.isDead);if(s.length>0)for(const t of s)for(const e of i)if(t.x<e.x+e.width&&t.x+t.width>e.x&&t.y<e.y+e.height&&t.y+t.height>e.y){t.isDead=!0,e.isDead=!0;break}this.enemies.filter(e=>e.y>=t.canvasHeight||e.y<=-e.height||e.isDead).forEach(t=>{const e=this.enemyScoreMap.get(t)||0;this.scoreCallback&&e>0&&(t.isDead?this.scoreCallback(5*e):this.scoreCallback(e)),this.enemyScoreMap.delete(t)}),this.enemies=this.enemies.filter(e=>e.y<t.canvasHeight&&e.y>-e.height&&!e.isDead)}draw(){this.enemies.forEach(t=>t.draw())}}const D=new class{constructor(){this.previousState=null}onEnter(t){this.previousState=t}onUpdate(){this.updateControls()}onDraw(){this.previousState&&"function"==typeof this.previousState.drawBackground&&this.previousState.drawBackground(),this.drawPauseOverlay()}drawPauseOverlay(){const e=t.context.canvas.width,s=t.context.canvas.height,i=e/2,n=s/2;t.context.fillStyle="rgba(0, 0, 0, 0.7)",t.context.fillRect(0,0,e,s),t.drawText("Pause",48,i,n,"white"),t.drawText("Press ESC to resume",18,i,n+60,"white")}updateControls(){e.isEscape&&!e.previousState.isEscape&&this.previousState&&i.resumeState(this.previousState)}onExit(){}},E=new class{constructor(){this.boss=null,this.gameTime=0,this.bossFightStarted=!1,this.bossFightPending=!1,this.bossDefeated=!1,this.score=0}onEnter(){l.stopAllLoops(),l.playLoop(g,[1,.3,.6,.1]),this.character=new y(t.context,120,300),this.background=new w(t),this.enemyFactory=new S,this.enemyFactory.setScoreCallback(t=>this.addScore(t)),this.gameTime=0,this.boss=null,this.bossFightStarted=!1,this.bossFightPending=!1,this.bossDefeated=!1,this.score=0,this.enemyFactory.registerEnemyType(()=>{const e=Math.random()*t.canvasWidth,s=.08+.04*Math.random(),i=40+30*Math.random(),n=.0015+5e-4*Math.random();return new b(t.context,t=>({x:e+Math.sin(t*n)*i,y:t*s}),this.character)},1e3,500),this.enemyFactory.registerEnemyType(()=>{const e=Math.random()*t.canvasWidth,s=.05+.1*Math.random();return new k(t.context,t=>({x:e,y:t*s}),this.character)},1e3,100),this.enemyFactory.registerEnemyType(()=>{const e=Math.random()*t.canvasWidth,s=.05*(Math.random()-.5),i=.05+.05*Math.random(),n=40*Math.random()+20,a=.002*Math.random()+.001,h=Math.random()*Math.PI*2;return new C(t.context,t=>({x:e+s*t,y:i*t-16+n*Math.sin(a*t+h)}),this.character)},2e3,800)}startBossFight(){l.stopAllLoops(),this.enemyFactory.stop(),this.enemyFactory.clear(),this.bossFightPending=!0,this.registerBossFightEnemies(),setTimeout(()=>{l.playLoop(p,[1,.3,.6,.1]),this.enemyFactory.start()},1e3)}registerBossFightEnemies(){this.enemyFactory.registerEnemyType(()=>{const e=Math.random()*t.canvasWidth,s=.08+.12*Math.random();return new k(t.context,t=>({x:e,y:t*s}),this.character)},800,100)}onUpdate(s){!e.isEscape||e.previousState.isEscape?(!this.bossFightStarted&&this.gameTime>6e4&&(this.bossFightStarted=!0,this.startBossFight()),this.gameTime+=s,this.boss&&this.boss.checkAttackCollision()&&this.boss.takeDamage(),this.background.update(s),this.character.update(s),this.bossDefeated||this.enemyFactory.update(s),this.bossFightPending&&0===this.enemyFactory.enemies.length&&(this.boss=new v(t.context,this.character,()=>this.triggerGameOver()),this.bossFightPending=!1),this.boss&&(this.boss.update(s),this.checkReflectedCucumberBossCollision(),!this.bossDefeated&&this.boss.isDefeated()&&(this.bossDefeated=!0,this.enemyFactory.stop(),this.enemyFactory.clear()),this.checkBossVictory())):i.setState(D,this)}onDraw(){this.background.draw(),this.character.draw(),this.enemyFactory.draw(),this.boss&&this.boss.draw(),this.drawUI()}drawBackground(){this.background.draw(),this.character.draw(),this.enemyFactory.draw(),this.boss&&this.boss.draw(),this.drawUI()}drawUI(){const e=this.score.toString().padStart(8,"0"),s=t.context.canvas.width,i=t.context.canvas.height;t.drawText(e,16,s-10,25,"white","right");const n=i-20,a=this.character.getAttackCooldownProgress(),h=this.character.isAttackReady();t.context.fillStyle="rgba(0, 0, 0, 0.5)",t.context.fillRect(8,n-2,124,12),t.context.strokeStyle="white",t.context.lineWidth=1,t.context.strokeRect(10,n,120,8);const o=120*a;t.context.fillStyle=h?"#00ff00":"#ffff00",t.context.fillRect(10,n,o,8),t.drawText("Attack",12,10,n-5,"white","left")}onExit(){l.stopAllLoops()}getScore(){return this.score}addScore(t){this.score+=t}triggerGameOver(){i.setState(x,!1)}checkReflectedCucumberBossCollision(){if(!this.boss)return;const t=this.enemyFactory.enemies.filter(t=>t instanceof k&&t.isReflected&&!t.isDead);for(const e of t)if(e.x<this.boss.x+this.boss.width&&e.x+e.width>this.boss.x&&e.y<this.boss.y+this.boss.height&&e.y+e.height>this.boss.y){e.isDead=!0,this.boss.takeDamage();break}}checkBossVictory(){this.boss&&this.bossDefeated&&this.boss.y>t.context.canvas.height&&(this.addScore(1e4),this.boss=null,i.setState(x,!0))}},A=new class{constructor(){this.selectedOption=0,this.lastToggleTime=0,this.TOGGLE_THROTTLE_MS=300}onUpdate(t){this.updateControls()}onDraw(){const e=t.context.canvas.width/2;t.drawText("Feline Fury",36,e,80),t.drawText("Start Game",24,e,180,0===this.selectedOption?"white":"gray");const s="Music: "+(l.isMusicEnabled()?"ON":"OFF"),i=t.context;i.fillStyle="black",i.fillRect(e-100,200,200,30),t.drawText(s,24,e,220,1===this.selectedOption?"white":"gray"),t.drawText("Toggle Fullscreen",24,e,260,2===this.selectedOption?"white":"gray")}updateControls(){if(e.isUp&&!e.previousState.isUp&&(this.selectedOption=(this.selectedOption-1+3)%3),e.isDown&&!e.previousState.isDown&&(this.selectedOption=(this.selectedOption+1)%3),e.isConfirm&&!e.previousState.isConfirm||e.isAttacking&&!e.previousState.isAttacking){const t=performance.now();switch(this.selectedOption){case 0:i.setState(E);break;case 1:t-this.lastToggleTime>this.TOGGLE_THROTTLE_MS&&(l.setMusicEnabled(!l.isMusicEnabled()),this.lastToggleTime=t);break;case 2:this.toggleFullscreen()}}}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}};!async function(){const{context:n,canvasWidth:a,canvasHeight:h}=t;n.fillStyle="black",n.fillRect(0,0,a,h);let o=!1;const c=()=>{o||(l.init(),o=!0)};document.body.addEventListener("keydown",c),document.body.addEventListener("touchstart",c),await r.loadImages(["ending-32.png"]),await r.loadSpritesheet("spritesheet.png"),i=new s(A,...[]);let d=0;!function t(s){const n=s-d;d=s,e.queryController(),i.update(n),i.getState().onDraw(),requestAnimationFrame(t)}(0)}()</script>