<!doctype html><meta content="width=device-width" name=viewport><title>1257 Samalas - js13kGames 2023</title><style>body{margin:0;background:#000}canvas{display:block}.b{border:5px solid #fff;border-image:linear-gradient(45deg,#266F56,#C52F34) 1}.u{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);margin-right:-33%;font-family:Courier,monospace;font-size:1.3em;color:#fff;background:rgba(0,0,0,.6);padding:1em;box-sizing:border-box;overflow:auto;text-align:center}.c{display:block;margin:0 auto;font-size:1em;padding:1em 2em;margin-top:1em;border:1px solid #fff;background:rgba(0,0,0,.5);color:#fff;cursor:pointer}#i{display:none}#d{font-size:1.3em}#p{display:none}h1{margin-top:0}</style><div id=s class="b u"><h1>1257 Samalas</h1><p>The eruption of Lombok's volcano in 1257 unleashed more than just ash; it awoke an ancient AI, Abyssus, buried deep within.<p>As the AI's consciousness spread, so did the effects of the eruption, causing an ice age that lasted over 700 years.<p>You have been sent back in time to restore balance with the aid of sacred Banyan trees.</p><button id=x class=c>Continue</button></div><div id=i class="b u"><h1>1257 Samalas</h1><p>Drag and drop from one island to another.<p>In VR, point at an island with your controller, press and hold the trigger, then point to another one and release.<p>Difficulty</p><select id=d><option value=0>Easy<option value=1>So so<option value=2>Hard<option value=3>Don't do it</select> <button id=b class=c>Play</button></div><div id=p class="b u">Paused</div><script type=module>import*as bt from"/2023/webxr/three.js";var r={34:function(t){t.exports="void main(){vec2 A=gl_FragCoord.xy/resolution.xy;vec4 B=texture2D(tP,A);vec4 C=texture2D(tV,A);gl_FragColor=vec4(B.x,B.w,C.x,C.w);}"},883:function(t){t.exports="#define A  (1.0/60.0)\nvoid main(){vec2 B=gl_FragCoord.xy/resolution.xy;vec4 C=texture2D(tP,B);vec3 D=C.xyz;float E=C.w;vec4 F=texture2D(tV,B);vec3 G=F.xyz;float H=F.w;if(H==0.){G=vec3(0.);}if(E>0.5){D+=G*A;}gl_FragColor=vec4(D,E);}"},118:function(t){t.exports="#define A  (1.0/60.0)\nuniform float d;float B=0.45;const float C=resolution.x;const float D=resolution.y;bool E(float F,float G){return abs(F-G)<0.01;}void main(){float H=100.*(d+1.);vec2 I=gl_FragCoord.xy/resolution.xy;float J=I.y*resolution.x+I.x;vec4 K=texture2D(tP,I);vec3 L=K.xyz;float M=K.w;vec4 N=texture2D(tV,I);vec3 O=N.xyz;float P=N.w;if(P>0.){vec3 Q=vec3(0.);for(float R=0.;R<D;R++){for(float S=0.;S<C;S++){vec2 T=vec2(S+0.5,R+0.5)/resolution.xy;vec4 U=texture2D(tP,T);vec3 V=U.xyz;vec4 W=texture2D(tV,T);vec3 X=W.xyz;float Y=W.w;float Z=T.y*resolution.x+T.x;if(J==Z){continue;}if(Y==0.){continue;}vec3 a=V-L;float distance=length(a);if(distance==0.){continue;}float b=U.w;float c=max(distance*distance,0.0001);if(distance<.5&&E(M,0.6)&&E(Z,P)){O=vec3(0);gl_FragColor=vec4(O,-P);return;}if(E(M,0.6)&&E(b,0.6)){float d=(-0.1)/(c*c);Q+=d*normalize(a);}else if(E(M,0.6)&&E(Z,P)){float e=H*Y/distance;Q+=e*normalize(a);}else if(E(M,0.6)&&E(b,0.1)){float f=-0.5*H*Y/(c*c*c);Q+=f*normalize(a);}}}O+=A*Q;if(length(O)>0.){O=normalize(O)*min(length(O),1.5*(d+1.));}}else{gl_FragColor=vec4(0);return;}gl_FragColor=vec4(O,P);}"},68:function(t){t.exports="varying vec4 vColor;varying vec4 vPosition;varying vec4 vVelocity;void main(){float A=vPosition.z/10.;gl_FragColor=vec4(vColor.xyz*0.7+0.3*abs(vVelocity.xyz)*(1.-A),1.);}"},79:function(t){t.exports="uniform sampler2D tP;uniform sampler2D tV;uniform vec3 pC;uniform vec3 eC;attribute vec2 dtUv;varying vec4 vColor;varying vec4 vPosition;varying vec4 vVelocity;bool A(float B,float C,float D){return abs(B-C)<D;}mat3 E(vec3 F){vec3 G=vec3(0.,-1.,0.);vec3 H=normalize(cross(G,F));vec3 I=cross(F,H);return mat3(H,I,F);}void main(){vec4 J=texture2D(tP,dtUv);vec3 K=J.xyz;vec4 L=texture2D(tV,dtUv);vec3 M=L.xyz;float N=L.w;if(A(J.w,0.600,0.0001)){vColor=vec4(pC,1.);}else if(A(J.w,0.601,0.0001)){vColor=vec4(eC,1.);}else{vColor=vec4(1.,1.,0.,0.);}vVelocity=L;vec3 O=mat3(modelMatrix)*position;mat3 P=E(normalize(M));O=P*O;O+=K;vec4 Q=modelViewMatrix*(vec4(position,1.)+vec4(K,1.));gl_Position=projectionMatrix*viewMatrix*vec4(O,1.);vPosition=gl_Position;}"},751:function(t){t.exports="uniform sampler2D t;uniform sampler2D m;varying float l;varying vec3 c;varying vec2 u;varying float i;uniform float time;void main(){int A=int(floor(mod(u.x*l,128.)));vec2 B=vec2(float(A)/float(128.),i/float(1024.));float C=texture2D(m,B).r*255.;vec2 D;float E=0.125;float F=(45./512.)/1.;float G=floor(C/8.);float H=mod(C,8.);float I=(u.x*F*l);float J=(-u.y*0.10+0.11);D.x=(H*F)+mod(I,F);D.y=(1.-G*E)-mod(J,E);vec4 K=texture2D(t,D);if(K.a<0.2){discard;};gl_FragColor=(K)*vec4(c,1.);}"},449:function(t){t.exports="attribute float length;attribute float instance;varying vec2 u;varying vec3 c;varying float l;varying float i;void main(){u=uv;l=length;\n#ifdef USE_INSTANCING_COLOR\nc=instanceColor;\n#endif\ni=instance;gl_Position=projectionMatrix*modelViewMatrix*instanceMatrix*vec4(position,1.);}"}},o={};function i(t){var e=o[t];return void 0===e&&(e=o[t]={exports:{}},r[t](e,e.exports,i)),e.exports}i.m=r,i.n=function(t){var e=t&&t.i?function(){return t.default}:function(){return t};return i.d(e,{a:e}),e},i.d=function(t,e){for(var n in e)i.o(e,n)&&!i.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="/",i.b=document.baseURI||self.location.href;{class Rt{constructor(t){this.h=t,this.l=null}v(){return t=this,s=function*(){if(null===this.l)try{if(!navigator.xr)throw new Error("!WebXR");var t=yield navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]});yield this.h.xr.setSession(t),this.l=t}catch(t){}else this.l.end()},o=void 0,new(o=Promise)(function(n,e){function i(t){try{r(s.next(t))}catch(t){e(t)}}function a(t){try{r(s.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?n(t.value):((e=t.value)instanceof o?e:new o(function(t){t(e)})).then(i,a)}r((s=s.apply(t,[])).next())});var t,o,s}T(){this.l&&(this.l.end(),this.l=null)}}var t=i(449),D=i.n(t),F=(t=i(751),i.n(t));class Lt{constructor(t,e,n){this.R=t||" ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.,!?",this.H=e||128,this.M=n||1024,this._=this.P(),this.O=[],this.S=[],this.I=0,this.V=new bt.InstancedBufferAttribute(new Float32Array(this.M),1),this.k=new bt.InstancedBufferAttribute(new Float32Array(this.M),1),this.H=128,this.L=new Uint8Array(this.H*this.M),this.N=new bt.DataTexture(this.L,this.H,this.M,bt.RedFormat),this.U=[],this.K=[],this.W=new bt.Object3D,this.J=new bt.Quaternion,this.Y=new bt.Quaternion,this.j=0,(t=new bt.ShaderMaterial({uniforms:{t:{value:this._},m:{value:this.N},time:{value:0}},vertexShader:D(),fragmentShader:F(),depthWrite:!1,depthTest:!1})).transparent=!0,t.side=bt.DoubleSide,t.vertexColors=!0,(e=new bt.PlaneGeometry(1,.1)).setAttribute("length",this.V),e.setAttribute("instance",this.k),this.instancedMesh=new bt.InstancedMesh(e,t,this.M),this.instancedMesh.frustumCulled=!1,this.instancedMesh.onBeforeRender=(t,e,n,i,a,r)=>{if(n.matrixWorld.decompose(this.W.position,this.W.quaternion,this.W.scale),0<this.U.length)for(let t=0;t<this.U.length;t++)this.O[this.U[t]].quaternion.copy(this.W.quaternion),this.updateMatrix(this.U[t])}}P(){var e,n,i,a,r=document.createElement("canvas"),o=(r.width=1024,r.height=1024,r.getContext("2d"));if(!o)throw new Error;o.textAlign="center",o.textBaseline="bottom",o.fillStyle="white",o.strokeStyle="black";for(let t=0;t<this.R.length;t++){const r=t%8*90+45,s=128*Math.floor(t/8)+128;e=o,n=this.R[t],i=r,a=s,e.font="128px monospace",e.strokeStyle="black",e.lineWidth=2,e.lineJoin="miter",e.miterLimit=2,e.strokeText(n,i,a),e.fillStyle="white",e.fillText(n,i,a)}const s=new bt.Texture(r);return s.needsUpdate=!0,s}Z(e,n){for(let t=0;t<n.length;t++){var i=this.R.indexOf(n[t].toUpperCase());-1!==i&&(this.L[e*this.H+t]=i)}this.V.setX(e,n.length),this.V.needsUpdate=!0;var t=this.S[e]||1;this.setScale(e,n.length*t/10/(128/90),+t,+t),this.N.needsUpdate=!0,this.instancedMesh.material.uniforms.time.value=performance.now()/1e3,this.instancedMesh.material.needsUpdate=!0}X(t,e,n,i){const a=this.I;return this.I>=this.M?null:(this.I++,this.instancedMesh.count=this.I,this.O[a]=new bt.Object3D,this.Z(a,t),this.k.setX(a,a),this.k.needsUpdate=!0,e&&this.setColor(a,e),n&&this.U.push(a),i&&this.K.push(a),{setPosition:(t,e,n)=>{this.setPosition(a,t,e,n)},updateText:(t,e)=>{this.Z(a,t),e&&this.setColor(a,e)},setScale:t=>{this.S[a]=t},instancedMesh:this.instancedMesh,q:a})}setColor(t,e){this.instancedMesh.setColorAt(t,e),this.instancedMesh.instanceColor&&(this.instancedMesh.instanceColor.needsUpdate=!0)}setScale(t,e,n,i){this.O[t].scale.set(e,n,i),this.updateMatrix(t)}setPosition(t,e,n,i){this.O[t].position.set(e,n,i),this.updateMatrix(t)}$(t,e,n,i){this.O[t].rotation.set(e,n,i),this.updateMatrix(t)}updateMatrix(t,e){e?this.O[t].matrix.copy(e):this.O[t].updateMatrix(),this.instancedMesh.setMatrixAt(t,this.O[t].matrix),this.instancedMesh.instanceMatrix.needsUpdate=!0}}function p(t,o,s,l){return new(s=s||Promise)(function(n,e){function i(t){try{r(l.next(t))}catch(t){e(t)}}function a(t){try{r(l.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?n(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(i,a)}r((l=l.apply(t,o||[])).next())})}class qt{constructor(o,s,l){this.tt=[],this.nt=0;const c=bt.FloatType,u=new bt.Scene,h=new bt.Camera,n=(h.position.z=1,{passThruTexture:{value:null}}),d=a("uniform sampler2D passThruTexture; void main(){vec2 uv = gl_FragCoord.xy/resolution.xy;gl_FragColor=texture2D(passThruTexture,uv);}",n),f=new bt.Mesh(new bt.PlaneGeometry(2,2),d);function i(t){t.defines.resolution="vec2( "+o.toFixed(1)+", "+s.toFixed(1)+" )"}function a(t,e){return i(e=new bt.ShaderMaterial({name:"GPUComputationShader",uniforms:e=e||{},vertexShader:"void main(){gl_Position=vec4(position,1.0);}",fragmentShader:t})),e}u.add(f),this.et=function(t,e,n,i){return t={name:t,initialValueTexture:n,material:a(e),dependencies:null,renderTargets:[],wrapS:null,wrapT:null,minFilter:bt.NearestFilter,magFilter:bt.NearestFilter,buffer:i},this.tt.push(t),t},this.it=function(t,e){t.dependencies=e},this.init=function(){if(!1===l.capabilities.isWebGL2&&!1===l.extensions.has("OES_texture_float"))return"!OES_texture_float";if(0===l.capabilities.maxVertexTextures)return"!vertexShaderTex";for(let t=0;t<this.tt.length;t++){var n=this.tt[t],e=(n.renderTargets[0]=this.ot(o,s,n.wrapS,n.wrapT,n.minFilter,n.magFilter),n.renderTargets[1]=this.ot(o,s,n.wrapS,n.wrapT,n.minFilter,n.magFilter),this.st(n.initialValueTexture,n.renderTargets[0]),this.st(n.initialValueTexture,n.renderTargets[1]),n.material),i=e.uniforms;if(null!==n.dependencies)for(let t=0;t<n.dependencies.length;t++){const s=n.dependencies[t];if(s.name!==n.name){let e=!1;for(let t=0;t<this.tt.length;t++)if(s.name===this.tt[t].name){e=!0;break}if(!e)return"!var="+n.name+", dep="+s.name}i[s.name]={value:null},e.fragmentShader="\nuniform sampler2D "+s.name+";\n"+e.fragmentShader}}return this.nt=0,null},this.ct=function(n){var i=this.nt,a=0===this.nt?1:0;for(let t=0,e=this.tt.length;t<e;t++){var r=this.tt[t];if(null!==r.dependencies){const n=r.material.uniforms;for(let t=0,e=r.dependencies.length;t<e;t++){var o=r.dependencies[t];n[o.name].value=o.renderTargets[i].texture}}r.buffer&&n&&n[r.name]?this.rt(r.material,r.renderTargets[a],r.buffer,n[r.name]):this.rt(r.material,r.renderTargets[a])}this.nt=a},this.ht=function(t){return t.renderTargets[this.nt]},this.ut=i,this.ot=function(t,e,n,i,a,r){return n=n||bt.ClampToEdgeWrapping,i=i||bt.ClampToEdgeWrapping,a=a||bt.NearestFilter,r=r||bt.NearestFilter,new bt.WebGLRenderTarget(t=t||o,e=e||s,{wrapS:n,wrapT:i,minFilter:a,magFilter:r,format:bt.RGBAFormat,type:c,depthBuffer:!1})},this.createTexture=function(){var t=new Float32Array(o*s*4);return(t=new bt.DataTexture(t,o,s,bt.RGBAFormat,bt.FloatType)).needsUpdate=!0,t},this.st=function(t,e){n.passThruTexture.value=t,this.rt(d,e),n.passThruTexture.value=null},this.rt=function(t,e,n,i){var a=l.getRenderTarget(),r=l.xr.enabled;l.xr.enabled=!1,f.material=t,l.setRenderTarget(e),l.render(u,h),n&&null!=i&&i.length&&this.lt(n).then(()=>{for(let t=0;t<i.length;t++)i[t](n)}),f.material=d,l.xr.enabled=r,l.setRenderTarget(a)},this.lt=function(i){return p(this,void 0,void 0,function*(){var t=l.getContext(),e=o,n=s;if(t instanceof WebGL2RenderingContext)return yield function(e,n,i,a,r,o){return p(this,void 0,void 0,function*(){var t=e.createBuffer();return e.bindBuffer(e.PIXEL_PACK_BUFFER,t),e.bufferData(e.PIXEL_PACK_BUFFER,o.byteLength,e.STREAM_READ),e.readPixels(0,0,n,i,a,r,0),e.bindBuffer(e.PIXEL_PACK_BUFFER,null),yield function(e,n,i,o){return p(this,void 0,void 0,function*(){var a,r,t=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0);e.flush(),a=e,r=t,yield new Promise((n,i)=>{!function t(){var e=a.clientWaitSync(r,0,0);e!==a.WAIT_FAILED?e!==a.TIMEOUT_EXPIRED?n():setTimeout(t,10):i()}()}),e.deleteSync(t),e.bindBuffer(n,i),e.getBufferSubData(n,0,o,void 0,void 0),e.bindBuffer(n,null)})}(e,e.PIXEL_PACK_BUFFER,t,o),e.deleteBuffer(t),o})}(t,e,n,t.RGBA,t.FLOAT,i)})}}}var t=i(118),Tt=i.n(t),Ct=(t=i(883),i.n(t)),St=(t=i(34),i.n(t)),Pt=(t=i(79),i.n(t)),Vt=(t=i(68),i.n(t));const X=new Event({type:"change"}),h=new Event({type:"start"}),d={type:"end"},f=new bt.Ray,m=new bt.Plane,j=Math.cos(70*bt.MathUtils.DEG2RAD),v=new bt.Vector3,w=(new bt.Quaternion).setFromUnitVectors(new bt.Vector3(0,1,0),new bt.Vector3(0,1,0)),N=w.clone().invert(),M=new bt.Vector3,x=new bt.Quaternion,K=new bt.Vector3,y=2*Math.PI;let r;const g={ft:-1,Et:0,wt:1,vt:3,Tt:4,dt:5,Rt:6};let o=g.ft;const b=new bt.Spherical,T=new bt.Spherical;let s=1;const C=new bt.Vector2,S=new bt.Vector2,P=new bt.Vector2,E=new bt.Vector2,I=new bt.Vector2,Q=new bt.Vector2,J=new bt.Vector3,Z=new bt.Vector2;let l=!1;const A=[],n={};class Ht extends bt.EventDispatcher{constructor(t,e){super(),this.Ht=t,this.Mt=e,this.Mt.style.touchAction="none",this.enabled=!0,this.yt=new bt.Vector3,this.xt=0,this.gt=100,this.Ct=0,this._t=Math.PI,this.Dt=-1/0,this.Ft=1/0,this.Pt=!1,this.At=.05,this.bt=!0,this.Ot=1,this.St=!0,this.It=1,this.Vt=!1,this.autoRotate=!1,this.kt=1.5,this.zt={Bt:bt.MOUSE.ROTATE},this.Lt={Gt:bt.TOUCH.ROTATE,Nt:bt.TOUCH.DOLLY_PAN},this.Ut=this.yt.clone(),this.Kt=this.Ht.position.clone(),this.Wt=null,this.Mt.addEventListener("contextmenu",W),this.Mt.addEventListener("pointerdown",_),this.Mt.addEventListener("pointercancel",u),this.Mt.addEventListener("wheel",k,{passive:!1}),(r=this).update()}update(t=null){const e=this.Ht.position;v.copy(e).sub(this.yt),v.applyQuaternion(w),b.setFromVector3(v),this.autoRotate&&o===g.ft&&a(null!==t?2*Math.PI/60*r.kt*t:2*Math.PI/60/60*r.kt),this.Pt?(b.theta+=T.theta*this.At,b.phi+=T.phi*this.At):(b.theta+=T.theta,b.phi+=T.phi);let n=this.Dt,i=this.Ft;if(isFinite(n)&&isFinite(i)&&(n<-Math.PI?n+=y:n>Math.PI&&(n-=y),i<-Math.PI?i+=y:i>Math.PI&&(i-=y),b.theta=n<=i?Math.max(n,Math.min(i,b.theta)):b.theta>(n+i)/2?Math.max(n,b.theta):Math.min(i,b.theta)),b.phi=Math.max(this.Ct,Math.min(this._t,b.phi)),b.makeSafe(),this.Vt&&l?b.radius=c(b.radius):b.radius=c(b.radius*s),v.setFromSpherical(b),v.applyQuaternion(N),e.copy(this.yt).add(v),this.Ht.lookAt(this.yt),T.set(0,0,0),this.Vt&&l){let t=null;if(this.Ht.isPerspectiveCamera){const e=v.length(),n=e-(t=c(e*s));this.Ht.position.Jt(J,n),this.Ht.updateMatrixWorld()}else this.Vt=!1;null!==t&&(f.origin.copy(this.Ht.position),f.direction.set(0,0,-1).Yt(this.Ht.matrix),Math.abs(this.Ht.jt.dot(f.direction))<j?this.Ht.lookAt(this.yt):(m.Qt(this.Ht.jt,this.yt),f.Zt(m,this.yt)))}if(s=1,l=!1,1e-6<M.distanceToSquared(this.Ht.position)||1e-6<8*(1-x.dot(this.Ht.quaternion))||0<K.distanceToSquared(this.yt))return this.dispatchEvent(X),M.copy(this.Ht.position),x.copy(this.Ht.quaternion),K.copy(this.yt),!0}}function O(){return Math.pow(.95,r.Ot)}function a(t){T.theta-=t}function V(t){T.phi-=t}function B(t){r.Ht.isPerspectiveCamera?s/=t:r.bt=!1}function c(t){return Math.max(r.xt,Math.min(r.gt,t))}function R(t){C.set(t.clientX,t.clientY)}function L(){var t,e;1===A.length?C.set(A[0].pageX,A[0].pageY):(t=.5*(A[0].pageX+A[1].pageX),e=.5*(A[0].pageY+A[1].pageY),C.set(t,e))}function q(){var t=A[0].pageX-A[1].pageX,e=A[0].pageY-A[1].pageY,t=Math.sqrt(t*t+e*e);E.set(0,t)}function H(t){if(1==A.length)S.set(t.pageX,t.pageY);else{const e=Y(t),n=.5*(t.pageX+e.x),i=.5*(t.pageY+e.y);S.set(n,i)}P.subVectors(S,C).multiplyScalar(r.It);const e=r.Mt;a(2*Math.PI*P.x/e.clientHeight),V(2*Math.PI*P.y/e.clientHeight),C.copy(S)}function U(t){var e=Y(t),n=t.pageX-e.x;t=t.pageY-e.y,e=Math.sqrt(n*n+t*t),I.set(0,e),Q.set(0,Math.pow(I.y/E.y,r.Ot)),B(Q.y),E.copy(I)}function _(t){var e;if(!1!==r.enabled){if(0===A.length&&(r.Mt.setPointerCapture(t.pointerId),r.Mt.addEventListener("pointermove",G),r.Mt.addEventListener("pointerup",u)),e=t,A.push(e),"touch"===t.pointerType)switch(z(t),A.length){case 1:if(r.Lt.Gt===bt.TOUCH.ROTATE){if(!1===r.St)return;L(),o=g.vt}else o=g.ft;break;case 2:switch(r.Lt.Nt){case bt.TOUCH.DOLLY_PAN:if(!1===r.bt)return;r.bt&&q(),o=g.dt;break;case bt.TOUCH.DOLLY_ROTATE:if(!1===r.bt&&!1===r.St)return;r.bt&&q(),r.St&&L(),o=g.Rt;break;default:o=g.ft}break;default:o=g.ft}else{var n=t;switch(0===n.button?r.zt.Bt:-1){case bt.MOUSE.ROTATE:if(!1===r.St)return;R(n),o=g.Et;break;case bt.MOUSE.PAN:if(n.ctrlKey||n.metaKey||n.shiftKey){if(!1===r.St)return;R(n),o=g.Et}break;default:o=g.ft}}o!==g.ft&&r.dispatchEvent(h)}}function G(t){if(!1!==r.enabled)if("touch"===t.pointerType){var e,n=t;switch(z(n),o){case g.vt:!1!==r.St&&H(n);break;case g.dt:!1!==r.bt&&(e=n,r.bt)&&U(e);break;case g.Rt:!1===r.bt&&!1===r.St||(e=n,r.bt&&U(e),r.St&&H(e));break;default:o=g.ft}}else o===g.Et&&!1!==r.St&&(S.set(t.clientX,t.clientY),P.subVectors(S,C).multiplyScalar(r.It),t=r.Mt,a(2*Math.PI*P.x/t.clientHeight),V(2*Math.PI*P.y/t.clientHeight),C.copy(S))}function u(t){!function(e){delete n[e.pointerId];for(let t=0;t<A.length;t++)if(A[t].pointerId==e.pointerId)return A.splice(t,1)}(t),0===A.length&&(r.Mt.releasePointerCapture(t.pointerId),r.Mt.removeEventListener("pointermove",G),r.Mt.removeEventListener("pointerup",u)),r.dispatchEvent(d),o=g.ft}function k(t){var e,n,i,a;!1!==r.enabled&&!1!==r.bt&&o===g.ft&&(t.preventDefault(),r.dispatchEvent(h),e=t,r.Vt&&(l=!0,a=r.Mt.getBoundingClientRect(),n=e.clientX-a.left,e=e.clientY-a.top,i=a.width,a=a.height,Z.x=n/i*2-1,Z.y=-e/a*2+1),t.deltaY<0?(n=O(),r.Ht.isPerspectiveCamera?s*=n:r.bt=!1):0<t.deltaY&&B(O()),r.dispatchEvent(d))}function W(t){!1!==r.enabled&&t.preventDefault()}function z(t){let e=n[t.pointerId];void 0===e&&(e=new bt.Vector2,n[t.pointerId]=e),e.set(t.pageX,t.pageY)}function Y(t){return t=t.pointerId===A[0].pointerId?A[1]:A[0],n[t.pointerId]}const $=new window.AudioContext,Ut=Date.now(),e=[609,653,705,822,887,954,1050].map(t=>t/8),_t=[];for(let i=-1;i<3;i++)_t.push(...e.map(t=>{return t=(e=>{var n=[];for(let t=0;t<2205;t++){const i=(t,e,n,i)=>Math.sin(t/e*6.28*n+i),a=(t,e)=>Math.sin(t/44100*e*6.28+Math.pow(i(t,44100,e,0),3)+.75*i(t,44100,e,.25)+.1*i(t,44100,e,.5));n[t]=t<88?t/88.2*a(t,e):Math.pow(1-(t-88.2)/2116.8,Math.pow(.5*Math.log(1e4*e/44100),2))*a(t,e)}return n})(t*Math.pow(2,i)),e=$.createBufferSource(),(n=$.createBuffer(1,t.length,44100)).getChannelData(0).set(t),e.buffer=n,e;var e,n}));let it=0;const tt=(t,e,n)=>(t=(1e3+(t+2*Math.sin(e)+e*n))/n,[.2+.3*(1+Math.sin(2*Math.PI*.1*t)),2.6+1/.96*Math.atan(.96*Math.sin(Math.PI/5*t-1)/(1-.96*Math.cos(Math.PI/5*t-1)))-3*Math.abs(Math.sin(Math.PI/10*t-Math.PI))]);class Gt{constructor(){this.Xt=!1,this.qt=new AudioContext,this.$t=this.qt.sampleRate;const n=this.qt.createConvolver();n.buffer=this.tn(2,2),n.connect(this.qt.destination);var t=this.qt.createBiquadFilter();t.type="lowpass",t.Q.value=1,this.nn=0,this.en={C:261.63,"C#":277.18,D:293.66,"D#":311.13,E:329.63,F:349.23,"F#":369.99,G:392,"G#":415.3,A:440,"A#":466.16,B:493.88};for(const n in this.en)this.en[n+"'"]=2*this.en[n];this.on=["A","E","D","E","","D","E","D","C","B","C","B","","C","G","A"],this.sn=[1,.125,.125,.75,.25,.25,.25,.25,1,.125,.125,.75,.5,.75,.75,1],this.cn=[[.75,.75,.25,.25,.125,.125,.75,1],[.25,.75,.25,.75,.25,.75,.25,.75],[.5,.5,.5,.5,.5,.5,.5,.5],[.125,.25,.375,.75,.375,.25,.125,1.75]],this.rn=0,this.an=new Array(2).fill(0).map(()=>{var t=this.qt.createOscillator(),e=(t.type="triangle",this.qt.createGain());return e.gain.value=0,t.connect(e),e.connect(n),t.start(this.qt.currentTime),t.detune.value=1,{hn:t,gain:e}}),this.init()}init(){return t=this,s=function*(){yield this.qt.audioWorklet.addModule("a.js");var t=new AudioWorkletNode(this.qt,"a");t.port.postMessage(tt.toString());const e=this.qt.createBiquadFilter();e.type="lowpass",e.Q.value=1,t.connect(e),e.connect(this.qt.destination),setInterval(()=>{e.frequency.exponentialRampToValueAtTime(300+400*tt(0,this.qt.currentTime+.1,this.qt.sampleRate)[1],this.qt.currentTime+.1)},100)},o=void 0,new(o=Promise)(function(n,e){function i(t){try{r(s.next(t))}catch(t){e(t)}}function a(t){try{r(s.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?n(t.value):((e=t.value)instanceof o?e:new o(function(t){t(e)})).then(i,a)}r((s=s.apply(t,[])).next())});var t,o,s}tn(t,e){var n=this.$t*t,i=(t=this.qt.createBuffer(2,n,this.$t)).getChannelData(0),a=t.getChannelData(1);for(let t=0;t<n;t++)i[t]=(100*Math.random()-1)*Math.pow(1-t/n,e),a[t]=(100*Math.random()-1)*Math.pow(1-t/n,e);return t}un(){var t=this.qt.createOscillator(),e=this.qt.createGain(),n=(t.type="sine",t.frequency.setValueAtTime(80,this.qt.currentTime),e.gain.setValueAtTime(.8,this.qt.currentTime),t.frequency.exponentialRampToValueAtTime(30,this.qt.currentTime+.2),e.gain.exponentialRampToValueAtTime(.001,this.qt.currentTime+.5),this.qt.createBiquadFilter());n.type="lowpass",n.frequency.setValueAtTime(300,this.qt.currentTime),t.connect(e),e.connect(n),n.connect(this.qt.destination),t.start(this.qt.currentTime),t.stop(this.qt.currentTime+.5),this.ln(()=>this.un(),2e3,this.qt.currentTime+1)}fn(t,e){var n={1:0,2:4,3:7,4:12},i=Object.keys(this.en).indexOf(t);if(-1===i)return[];var a=[];for(let t=0;t<e.length;t++){var r=n[parseInt(e[t])];if(void 0===r)return[];r=i+r,a.push(Object.keys(this.en)[r])}return a||[]}En(){if(0===this.nn||this.nn%48!=0){const t=Object.keys(this.en)[Math.floor(12*Math.random())],e=["12132124","34121234","34132312","12314321"][Math.floor(4*Math.random())],n=this.fn(t,e),i=this.cn[Math.floor(Math.random()*this.cn.length)];this.ln(()=>this.wn(n,i),2e3)}else this.nn%48==0&&0<this.nn&&this.ln(()=>this.wn(this.on,this.sn),2e3)}wn(e,n){let i=0;for(let t=0;t<e.length;t++){const a=1e3*n[t];setTimeout(()=>this.vn(this.en[e[t]],a*(1+.05*Math.random())),i),i+=a}setTimeout(()=>this.En(),i)}vn(t,e){var n,i,a,r;this.nn++,t&&({hn:n,gain:i}=this.an[this.rn],a=e=e/1e3/3.5,r=this.qt.currentTime,i.gain.setValueAtTime(0,this.qt.currentTime),n.frequency.setTargetAtTime(t/2,this.qt.currentTime,.01),i.gain.linearRampToValueAtTime(.8,r+.01),i.gain.linearRampToValueAtTime(.8,r+.01+e),i.gain.linearRampToValueAtTime(0,r+.01+e+a),this.rn=(this.rn+1)%2)}ln(t,e=2e3,n=0){var i=this.qt.currentTime;1986<(e=1e3*(Math.ceil(1e3*i/e)*e/1e3-i))&&n<i?t():setTimeout(()=>{t()},e)}start(){this.Xt||(this.Xt=!0,this.En(),setTimeout(()=>{this.ln(()=>this.un(),2e3)},4e3))}}function Bt(t,o,s,l){return new(s=s||Promise)(function(n,e){function i(t){try{r(l.next(t))}catch(t){e(t)}}function a(t){try{r(l.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?n(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(i,a)}r((l=l.apply(t,o||[])).next())})}let at=null,rt=null;const Et=[];let ot;const It=4096;let st;const At=[],Dt=[];let lt,ct,ut,ht,dt,ft,pt,mt=!1,vt=!1,wt=0;const kt=new Float32Array(4*It),Wt=new Float32Array(4*It),zt=new Float32Array(4*It),Ft={},Yt=[];let Mt=!1;const Ot={p:0,e:0},Xt=[];let xt,yt=null,gt=0;class jt extends bt.Group{constructor(){super(...arguments),this.u={}}}Bt(void 0,void 0,void 0,function*(){const o=new bt.Scene,l=(o.background=new bt.Color(5263440),new bt.Color(65433)),c=new bt.Color(12922676),s=new bt.Color(16753920),u=new bt.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.01,200),L=(u.position.set(0,6,-10),(pt=new bt.Object3D).add(u),o.add(pt),function(){var t,e=document.createElement("canvas"),n=(e.width=16,e.height=256,e.getContext("2d"));if(n)return(t=n.createLinearGradient(0,0,e.width,e.height)).addColorStop(.5,"#000833"),t.addColorStop(.51,"#03123B"),t.addColorStop(1,"#03123B"),n.fillStyle=t,n.fillRect(0,0,e.width,e.height),(t=new bt.Texture(e)).needsUpdate=!0,t;throw new Error}()),q=new bt.MeshBasicMaterial({map:L,side:bt.BackSide,depthWrite:!1}),H=new bt.IcosahedronGeometry(100,3),U=new bt.Mesh(H,q);o.add(U),(t=new bt.DirectionalLight(16777215,1.1)).position.set(0,1,1),o.add(t);var t=new bt.AmbientLight(16777215,1);o.add(t),(lt=new bt.WebGLRenderer({antialias:!0,Tn:"high-performance"})).xr.enabled=!0;const h=new Rt(lt),d=(lt.setPixelRatio(window.devicePixelRatio),lt.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(lt.domElement),new Ht(u,lt.domElement)),f=(d.autoRotate=!0,()=>{var t=window.innerWidth,e=window.innerHeight;lt.setSize(t,e),u.aspect=t/e,u.updateProjectionMatrix()}),_=(window.addEventListener("resize",function(){f()}),new bt.BoxGeometry(.1,1,.1)),G=new bt.MeshBasicMaterial({color:l}),p=new bt.Mesh(_,G),k=(p.visible=!1,o.add(p),(t=new bt.SphereGeometry(1,32,32,0,2*Math.PI,0,Math.PI/2)).translate(0,.5,0),(P=new bt.CylinderGeometry(0,.5,1,4,1)).translate(0,.5,0),"vec3 transformed = vec3(position);transformed.x += sin(position.y * 10.0 + time + float(gl_InstanceID)) * 0.1;transformed.z += cos(position.y * 10.0 + time + float(gl_InstanceID)) * 0.1;"),m=new bt.MeshStandardMaterial({color:65280,side:bt.DoubleSide});m.onBeforeCompile=t=>{t.uniforms.time={value:0},t.vertexShader="uniform float time;\n"+t.vertexShader,t.vertexShader=t.vertexShader.replace("#include <begin_vertex>",k),m.userData.dn=t};var e=new bt.MeshStandardMaterial({color:9127187,side:bt.DoubleSide}),a=new bt.BufferGeometry,n=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0]);a.setIndex([0,1,2,2,3,0]),a.setAttribute("position",new bt.BufferAttribute(n,3)),a.translate(0,1,0),a.computeVertexNormals(),a.rotateY(Math.PI);const v=new bt.MeshStandardMaterial({color:9127187,side:bt.DoubleSide}),i=(v.onBeforeCompile=t=>{t.uniforms.time={value:0},t.vertexShader="uniform float time;\n"+t.vertexShader,t.vertexShader=t.vertexShader.replace("#include <begin_vertex>",k),v.userData.dn=t},new bt.InstancedMesh(t,m,64)),r=new bt.InstancedMesh(P,e,64),w=new bt.InstancedMesh(a,v,512),W=new bt.Group,M=new bt.AudioListener,z=(u.add(M),t=>((t=new bt.PositionalAudio(t)).setRefDistance(20),t.setVolume(.5),o.add(t),t)),Y={p:[1,2,3,4].map(()=>z(M)),e:[1,2,3,4].map(()=>z(M))};function x(e,n,i,a,r,o,s,l=0,c=1){var u=W,h=Xt[n],d=new bt.Object3D;d.position.set(0,.05,0),(u.parent=d).parent=h;for(let t=0;t<8;t++){var f=1===c?n:8*n+t;"r"===e?u.matrix.copy(h.u.r[t]):u.matrix.copy(h.u[e]),u.matrix.decompose(u.position,u.quaternion,u.scale),h.setRotationFromAxisAngle(new bt.Vector3(1,0,0),l),d.scale.set(.3*i*r,.3*i*o,.3*i*s),u.updateWorldMatrix(!0,!0),a.setMatrixAt(f,u.matrixWorld),a.instanceMatrix.needsUpdate=!0}}function y(t,e,n){x("c",t,e,i,1,1,1,n),x("t",t,e,r,1,1,1,n),x("r",t,e,w,.03,.3,1,n,8)}var g,b,T,C,S,X=(1+Math.sqrt(5))/2;for(let e=0;e<64;e++){b=5,T=Math.acos(1-2*(e+.5)/64),C=2*Math.PI*(e%X)/X,S=void 0,S=5*Math.sin(T)*Math.cos(C),C=5*Math.sin(T)*Math.sin(C),b*=Math.cos(T);const s=new bt.Vector3(S,C,b),u=([T=.5]=[0===e?0:63===e?1:void 0],C=g=S=void 0,S=new jt,C=1+2*Math.random(),b=3+4*Math.random(),g=new bt.CylinderGeometry(b,C,1,24),C=new bt.CylinderGeometry(C,b,1,24),g.morphAttributes.position=[],g.morphAttributes.normal=[],g.morphAttributes.position[0]=C.attributes.position,g.morphAttributes.normal[0]=C.attributes.normal,b=new bt.MeshStandardMaterial({color:l}),(C=new bt.Mesh(g,b)).morphTargetInfluences[0]=T,C.position.set(0,0,0),S.add(C),g.computeBoundingSphere(),S.u=S.userData,S.u.size=g.boundingSphere?g.boundingSphere.radius:0,S.u.mn=Math.floor(Math.random()*S.u.size*10),S.u.Mn=null,S.u.scale=0,S.u.yn=0,S.u.xn=C,S.scale.set(.1,.1,.1),S),Tt=(o.add(u),new bt.MeshBasicMaterial),Ct=(At.push(u),u.position.copy(s),new bt.Mesh(new bt.SphereGeometry(u.u.size/10),Tt)),St=(Ct.position.copy(u.position.clone()),Dt.push(Ct),(u.u.Rn=Ct).visible=!1,o.add(Ct),new jt),Pt=(St.position.copy(u.position),Xt.push(St),new bt.Object3D);i.setMatrixAt(e,Pt.matrix),St.u.c=Pt.matrix.clone(),r.setMatrixAt(e,Pt.matrix),St.u.t=Pt.matrix.clone(),St.u.r=[];for(let t=0;t<8;t++)Pt.matrix.identity().decompose(Pt.position,Pt.quaternion,Pt.scale),Pt.position.x+=1.5*Math.random()*30-22.5,Pt.position.z+=1.5*Math.random()-.75,Pt.updateMatrix(),St.u.r.push(Pt.matrix.clone()),w.setMatrixAt(8*e+t,Pt.matrix);0===(u.u.Hn=e)?(u.u.Mn="p",u.u.color=l,u.u.mn=100,y(e,1),u.u.scale=1):(63===e?(u.u.Mn="e",u.u.mn=100,u.u.color=c):u.u.color=new bt.Color(16777215),y(e,0)),D(u,u.u.color)}o.add(i),o.add(r),o.add(w);var n=(ct=new qt(64,64,lt)).createTexture(),t=ct.createTexture(),P=ct.createTexture(),E=n.image.data,I=t.image.data;for(let t=0,e=E.length;t<e;t+=4)t<256?(E[t+0]=At[t/4].position.x,E[t+1]=At[t/4].position.y,E[t+2]=At[t/4].position.z,E[t+3]=.1,I[t+3]=1):(E[t+0]=-3,E[t+1]=Math.random(),E[t+2]=0,E[t+3]=99,I[t+0]=0,I[t+1]=0,I[t+2]=0,I[t+3]=0);(ut=ct.et("tV",Tt(),t,Wt)).material.uniforms.d={value:3},ht=ct.et("tP",Ct(),n,zt),dt=ct.et("tA",St(),P,kt),ct.it(ut,[ht,ut]),ct.it(ht,[ht,ut]),ct.it(dt,[ht,ut]),ct.init();{(e=new bt.CylinderGeometry(.2,0,.9,4,1)).scale(.3,.3,.3),e.rotateX(-Math.PI/2),(a=new bt.InstancedBufferGeometry).index=e.index,a.attributes.position=e.attributes.position,a.attributes.uv=e.attributes.uv,a.instanceCount=It;let n=new Float32Array(8192),i=0;for(let e=0;e<64;e++)for(let t=0;t<64;t++)n[i++]=t/63,n[i++]=e/63;a.setAttribute("dtUv",new bt.InstancedBufferAttribute(n,2)),st={tP:{value:null},tV:{value:null},eC:{value:c},pC:{value:l}},e=new bt.ShaderMaterial({uniforms:st,vertexShader:Pt(),fragmentShader:Vt(),side:bt.DoubleSide}),(a=new bt.InstancedMesh(a,e,It)).frustumCulled=!1,o.add(a)}ft=new Lt,o.add(ft.instancedMesh);const j=yield null==(P=navigator.xr)?void 0:P.isSessionSupported("immersive-vr"),N=j?"Play in VR":"Play";function A(t){t=Et[t];var e=new bt.Matrix4,n=(t.updateMatrixWorld(),e.identity().extractRotation(t.matrixWorld),new bt.Raycaster);return n.camera=u,n.ray.origin.setFromMatrixPosition(t.matrixWorld),n.ray.direction.set(0,0,-1).applyMatrix4(e),n.intersectObjects(Dt)}function K(t,e){var n,i,a,r,o;0<t.length?(null!=e&&e.preventDefault(),e=Dt.indexOf(t[0].object),(t=At[e])&&D(t,s),at&&t!==at&&(D(t,at.u.color),e=p,n=at.position,i=t.position,a=(new bt.Vector3).subVectors(i,n).length(),r=(new bt.Vector3).addVectors(n,i).multiplyScalar(.5),e.rotation.set(0,0,0),e.scale.set(1,1,1),(o=new bt.Matrix4).lookAt(n,i,new bt.Vector3(0,1,0)),n=(new bt.Matrix4).makeRotationX(Math.PI/2),o.multiply(n),e.applyMatrix4(o),e.scale.setY(a),e.position.copy(r),e.visible=!0),rt!==t&&(rt&&D(rt,rt.u.color),rt=t)):(p.visible=!1,rt&&D(rt,rt.u.color))}function Q(t,e){0<t.length&&(null!=e&&e.preventDefault(),"p"===(e=At[Dt.indexOf(t[0].object)]).u.Mn)&&(d.enabled=!1,at=e,mt=!0)}function J(t){0<t.length&&(rt=At[Dt.indexOf(t[0].object)],at)&&rt!==at&&nt(at,rt),d.enabled=!0,at&&D(at,at.u.color),rt&&D(rt,rt.u.color),at=null,rt=null,mt=!1,p.visible=!1}function D(t,e){t.traverse(t=>{t instanceof bt.Mesh&&((t=t.material).emissive.copy(e),t.color.copy(e),t.emissiveIntensity=.1)})}function F(t,e){Ft[t]||(Ft[t]=[]),Ft[t].push(e)}function Z(t,e){Ft[t]&&-1<(e=Ft[t].indexOf(e))&&Ft[t].splice(e,1)}F("tA",n=>{var i,a,r=n;if(!Mt){Ot.e=0;for(let t=Ot.p=0;t<r.length;t+=4)r[t+3]<0?(i=At[Math.floor(64*(-r[t+3]-.5))],a=r[t+1]<.6005?"p":"e",i&&(function(e,n,i){setTimeout(()=>{var t=i[e][it++%i[e].length];if(!i[e].some(t=>t.isPlaying)){t.position.copy(n);const i=_t[6+("p"==e?19:6)];i.buffer&&t.setBuffer(i.buffer),t.play()}},50-(Date.now()-Ut)%50)}(a,i.position,Y),i.u.Mn&&i.u.Mn===a?i.u.mn+=1:(--i.u.mn,i.u.mn<=0&&(i.u.mn=1,i.u.Mn=a,i.u.color="p"==a?l:c,D(i,i.u.color),i.u.yn+="p"==a?Math.PI:-Math.PI,i.u.yn=i.u.yn%(2*Math.PI)))),Yt.push(t)):0<r[t+3]&&(r[t+1]<.6005&&.5995<r[t+1]?Ot.p++:.6005<r[t+1]&&r[t+1]<.6015&&Ot.e++);let t=(n=At.map(t=>t.u.Mn)).every(t=>[null,"p"].includes(t))&&0===Ot.e,e;n=n.every(t=>[null,"e"].includes(t))&&0===Ot.p,t?e="Victory!":n&&(e="You lose. Darkness has fallen."),e&&(vt=!1,lt.xr.isPresenting&&(h.T(),f()),document.getElementById("p").innerHTML=e,R())}var t,e,o,s=Date.now();for(const n of At)t=n,e=n.u.Mn?s-ot:0,o=void 0,o=t.u.size,"p"!==t.u.Mn&&"e"!==t.u.Mn||(t.u.mn+=o*e*.001),o=t,e=Math.floor(t.u.mn),t=Math.min(1,e/100),o.u.pn?(o.u.pn.updateText(e.toString(),new bt.Color(o.u.color.r*t,o.u.color.g*t,o.u.color.b*t)),o.u.pn.setScale(Math.min(1+e/100,2))):(o.u.pn=(t=e.toString(),ft.X(t,new bt.Color(4095),!0,!1)),o.u.pn.setPosition(o.position.x,o.position.y+.2,o.position.z)),"p"===o.u.Mn&&y(o.u.Hn,Math.min(1,e/100));ot=s}),lt.setAnimationLoop(function(t){d.update();const e=t-wt;wt=t,t=lt.xr.getSession();var n=Date.now();if(t){var i=t.inputSources;for(let t=0;t<i.length;t++){var a=i[t].gamepad;a&&(.5<(a=a.axes)[2]&&250<n-gt?(pt.rotateY(-Math.PI/4),gt=n):a[2]<-.5&&250<n-gt&&(gt=n,pt.rotateY(Math.PI/4)),ft.j=pt.rotation.y)}}if(vt){ot=ot||Date.now(),ct.ct(Ft);const t=ct.ht(ht).texture,o=ct.ht(ut).texture;st.tP.value=t,st.tV.value=o,Et[0]&&K(null===yt?[...A(0),...A(1)]:A(yt));for(const t of At){const o=e/1200,n=t.u.yn-t.rotation.x;if(.01<Math.abs(n)){const e=0===t.u.yn;t.rotation.x+=n*o;var r=((("p"===t.u.Mn?1:0)^+e)-t.u.xn.morphTargetInfluences[0])*o;t.u.xn.morphTargetInfluences[0]+=r,t.u.xn.morphTargetInfluences[0]=Math.min(Math.max(t.u.xn.morphTargetInfluences[0],0),1),"p"===t.u.Mn?t.u.scale=(1-Math.abs(n/Math.PI))*t.u.mn/100:"e"===t.u.Mn&&(t.u.scale=0),t.u.scale=Math.min(Math.max(t.u.scale,0),1),y(t.u.Hn,t.u.scale,t.rotation.x+t.u.yn)}}}m.userData.dn&&(m.userData.dn.uniforms.time.value+=.03),v.userData.dn&&(v.userData.dn.uniforms.time.value+=.03),lt.render(o,u)});const O=new bt.Raycaster,V=new bt.Vector2;function B(t){return{x:t.clientX,y:t.clientY}}function $(t){var e=t instanceof TouchEvent?B(t.touches[0]):B(t);V.x=e.x/window.innerWidth*2-1,V.y=-e.y/window.innerHeight*2+1,O.setFromCamera(V,u),Q(O.intersectObjects(Dt),t)}function tt(t){mt&&(t=t instanceof TouchEvent?B(t.touches[0]):B(t),V.x=t.x/window.innerWidth*2-1,V.y=-t.y/window.innerHeight*2+1,O.setFromCamera(V,u),K(O.intersectObjects(Dt)))}function et(t){mt&&(t=t instanceof TouchEvent?B(t.changedTouches[0]):B(t),V.x=t.x/window.innerWidth*2-1,V.y=-t.y/window.innerHeight*2+1,O.setFromCamera(V,u),J(O.intersectObjects(Dt)))}function R(){ot=Date.now();var t=vt?"none":"block";document.getElementById("p").style.display=t}function nt(t,e){{var i=t.u.mn/2,a=t,r=t.u.Mn;const o=(At.indexOf(e)+.5)/64+.5,s=ct.createTexture(),l=ct.createTexture(),c=a.position;let n=0;const u=[],h=t=>{s.image.data.set(t);var e=s.image.data;for(let t=0;t<u.length;t++){var n=u[t];"p"===r?(e[n]=c.x+.1*(Math.random()-.5),e[n+1]=c.y-.1*(Math.random()-.5),e[n+2]=c.z+.1*(Math.random()-.5),e[n+3]=.6):(e[n]=c.x+.1*(Math.random()-.5),e[n+1]=c.y+.5*Math.random(),e[n+2]=c.z+.1*(Math.random()-.5),e[n+3]=.601)}Z("tP",h),s.needsUpdate=!0,t=ct.ht(ht),ct.st(s,t),l.needsUpdate=!0,t=ct.ht(ut),ct.st(l,t),a.u.mn-=a.u.mn/2,u.length=0,Mt=!1},d=t=>{Mt=!0,l.image.data.set(t);var e=l.image.data;for(let t=0;t<e.length&&!(1984<=Ot[r]+n)&&(0===e[t+3]&&(e[t]=0,e[t+1]=0,e[t+2]=0,e[t+3]=o,n++,u.push(t)),!(n>i-1));t+=4);Math.floor(i),Z("tV",d),F("tP",h)};F("tV",d)}}window.addEventListener("mousedown",$,!1),window.addEventListener("mousemove",tt,!1),window.addEventListener("mouseup",et,!1),window.addEventListener("touchstart",$,!1),window.addEventListener("touchmove",tt,!1),window.addEventListener("touchend",et,!1),null!=(t=document.getElementById("x"))&&t.addEventListener("click",()=>{document.getElementById("s").style.display="none",document.getElementById("i").style.display="block"}),(n=document.getElementById("b"))&&(n.innerHTML=N,n.addEventListener("click",function(){var e;return Bt(this,void 0,void 0,function*(){if(xt=parseInt(document.getElementById("d").value),ut.material.uniforms.d.value=xt,j){yield h.v();for(let e=0;e<2;e++){var t=lt.xr.getController(e),n=(pt.add(t),new bt.BoxGeometry(.025,.025,.2)),i=new bt.MeshStandardMaterial({color:l}),n=new bt.Mesh(n,i);t.add(n),Et.push(t),t.addEventListener("selectstart",()=>{var t;Q(A(t=e)),yt=t}),t.addEventListener("selectend",()=>{rt=null,J(A(e)),yt=null})}}(new Gt).start(),null!=(e=document.getElementById("i"))&&e.remove(),d.autoRotate=!1,vt=!0,window.onblur=()=>{vt=!1,R()},window.onfocus=()=>{vt=!0,R()},document.addEventListener("keydown",t=>{"p"===t.key&&(vt=!vt),R()}),window.scene=o,setInterval(()=>{const e=At.filter(t=>"e"===t.u.Mn),t=At.filter(t=>!e.includes(t)),n=t.sort((t,e)=>e.u.size/(e.u.mn+1)-t.u.size/(t.u.mn+1)),i=e[Math.floor(Math.random()*e.length)],a=Math.random()<xt/3?n[0]:t[Math.floor(Math.random()*t.length)];i&&a&&i!==a&&nt(i,a)},5e3-1e3*xt)})}))})}</script>