<!doctype html><title>Shooooooot!! - js13kGames 2020</title><meta content="width=device-width" name=viewport><style>body{background:#000}canvas{position:absolute;left:0;top:0;width:100%}#render-area{position:relative;background:#6495ed;width:80%;padding-top:45%;margin:auto;display:block}.hidecursor{cursor:none}.showcursor{cursor:crosshair}</style><div class=showcursor id=render-area></div><script>const e=document.getElementById("render-area");var t=["#810000","#e97171","#ffcb8e","#f5efef"];class n{static background=t[0];static obstacles=t[1];static enemies=t[2];static player=t[3]}var j=.1,s=j;class h{constructor(t,s,i,e,h){this.s=t,this.f=s,this.o=i,this.p=e,this.d=h,this.t=0,this.isStarted=!1,this.isDone=!1,this.parent=null}update(s){if(this.isStarted){if(!this.isDone){this.t+=s/this.d;let t=0;1<this.t&&(t=this.t-1,this.t=1,this.isDone=!0),this.o[this.p]=this.startValue+this.s*this.f(this.t),this.isDone&&this.next&&(this.next!==this&&this.parent.addAction(this.next),this.next.start(),this.next.update(t))}}else this.isStarted=!0,this.startValue=this.o[this.p]||0}start(){this.isStarted=!1,this.t=0,this.isDone=!1,this.update(0)}then(t){return this.next?this.next.then(t):this.next=t,this}}function B(t){return t*t}function R(t){return t*t*t}function _(t){return t*t*t*t}function W(t){return t*t*t*t*t}function U(t){return 1-(1-t)*(1-t)*(1-t)}function a(t){return 1-(1-t)*(1-t)*(1-t)*(1-t)}function i(s,i){let e=0,h=0;for(let t=0;t<s.length;++t)i(s[t])||(t>e?s[e++]=s[t]:++e,++h);s.length=h}function r(t){t.actions=[],t.updateActions=z,t.addAction=G,t.removeAction=V}function z(t){let s=!1;if(this.actions.length){for(const s of this.actions)s.update(t);s=!0}return i(this.actions,t=>t.isDone),s}function G(t){this.actions.push(t),t.parent=this}function V(s){i(this.actions,t=>t===s),s.parent=null}class o{constructor(){r(this),this.dx=0,this.dy=0,this.context=null}update(t){let s=this.updateActions(t);return(this.dx||this.dy)&&(this.x+=this.dx,this.y+=this.dy,s=!0),s}getLayer(t){return this.parent.getLayer(t)}}class d extends o{constructor(t,s,i){super(),this.text=t,this.x=s,this.y=i}setText(t){this.text!==t&&(this.text=t,this.isDirty=!0)}update(t){return super.update(t)||this.isDirty}draw(){this.context.fillText(this.text,this.x,this.y),this.isDirty=!1}}const F=2*Math.PI;class Z extends o{constructor(t,s,i=0){super(),this.x=t,this.y=s+36}drawThumbStick(t,s,i){var e=this.context;e.beginPath(),e.arc(t,s,i,0,F),e.fill()}draw(){var t=this.context;t.save(),t.lineWidth=36,t.lineCap="round",t.fillStyle=n.background,t.beginPath(),t.moveTo(this.x,this.y+128/3),t.lineTo(this.x+12.8,this.y),t.moveTo(this.x+12.8,this.y+128/3/5),t.rect(this.x+12.8,this.y+128/3/5,38.4,128/3/5),t.moveTo(this.x+51.2,this.y),t.lineTo(this.x+64,this.y+128/3),t.stroke(),this.drawThumbStick(this.x+12.8,this.y+128/3*2/5,9),this.drawThumbStick(this.x+51.2,this.y+128/3*2/5,9),this.context.restore(),this.context.save(),this.context.fillStyle=this.context.strokeStyle,this.context.font="24px verdana",this.context.textAlign="left",this.context.fillText("Gamepad",this.x-30,this.y-48),this.context.restore()}}class X extends o{constructor(t,s,i=1){super(),this.x=t,this.y=s,this.width=300*i,this.keySize=this.width/20,this.keySpacing=1.1*this.keySize,this.height=6*this.keySpacing}drawKey(t,s,i,e){var h=this.keySize,a=1.1*this.keySize;this.context.strokeRect(t+e*a,s+i*a,h,h)}drawKeys(s,i){this.drawKey(s,i,0,1);for(let t=0;t<3;++t)this.drawKey(s,i,1,t)}drawMouse(){var t=this.context,s=1.5*this.keySize,i=this.x+this.width+5*this.keySize,e=(h=this.y+s)+s,h=h+2*s,a=i-s,n=i+s;t.beginPath(),t.arc(i,h,s,0,Math.PI),t.arc(i,e,s,Math.PI,2*Math.PI),t.lineTo(a,e),t.moveTo(i,e-s),t.lineTo(i,e),t.moveTo(n,e),t.lineTo(n,h),t.stroke()}draw(){this.context.strokeRect(this.x,this.y,this.width,this.height),this.drawKeys(this.x+2*this.keySpacing,this.y+this.keySpacing),this.drawKeys(this.x+this.width-5*this.keySpacing,this.y+this.height-3*this.keySpacing),this.drawMouse(),this.context.save(),this.context.fillStyle=this.context.strokeStyle,this.context.font="24px verdana",this.context.textAlign="left",this.context.fillText("Keyboard and Mouse",this.x+50,this.y-24),this.context.restore()}}class c{constructor(t){(this.canvas=t).addEventListener("mousedown",this.onMouseDown.bind(this),!1),t.addEventListener("mousemove",this.onMouseMove.bind(this),!1),t.addEventListener("mouseout",this.onMouseOut.bind(this),!1),t.addEventListener("mouseup",this.onMouseUp.bind(this),!1),this.state="Out",this.isMouseDown=!1,this.isMouseOver=!1,this.current={},this.dragging=null,this.dragComplete=null}clientToCanvas(t,s={}){var i=this.canvas;return s.x=t.offsetX*i.width/i.clientWidth,s.y=t.offsetY*i.height/i.clientHeight,s}updateCurrent(t){this.clientToCanvas(t,this.current)}log(t){}reset(){this.isMouseOver=!1,this.isMouseDown=!1,this.current={},this.dragging=null,this.dragComplete=null}drop(){var t=this.dragComplete;return this.dragComplete=null,t}onMouseEvent(t){this.log(t),this.isMouseOver=!0,this.updateCurrent(t)}onMouseMove(t){this.onMouseEvent(t),this.state="Moving"}onMouseOut(t){this.onMouseEvent(t),this.reset(),this.state="Out"}onBeginDrag(t){this.dragging={begin:this.clientToCanvas(t),end:this.current}}onEndDrag(t){this.dragging.end=this.clientToCanvas(t),this.dragComplete=this.dragging,this.dragging=null}onMouseDown(t){this.onMouseEvent(t);var s=this.isMouseDown,i=1===t.which;!s&&i?(this.isMouseDown=!0,this.onBeginDrag(t),this.state="Dragging"):"Out"===this.state&&(this.state="Moving")}onMouseUp(t){this.onMouseEvent(t);var s=this.isMouseDown,i=1===t.which;s&&i?(this.isMouseDown=!1,this.onEndDrag(t),this.state="Moving"):"Out"===this.state&&(this.state="Moving")}}let[Y,H,q,N]=[65,68,83,87];class l{constructor(t){t.addEventListener("keydown",this.onKeyDown.bind(this),!1),t.addEventListener("keyup",this.onKeyUp.bind(this),!1),this.newKeysDown={},this.keysDown={},this.newKeysUp={}}reset(){for(var t in this.newKeysDown)this.newKeysDown[t]=void 0;for(var s in this.newKeysUp)this.newKeysUp[s]=void 0}onKeyDown(t){let s=t.keyCode;t.metaKey&&(s+=400),this.newKeysDown[s]=s,this.keysDown[s]=s}onKeyUp(t){let s=t.keyCode;t.metaKey&&(s+=400),this.newKeysUp[s]=s,this.keysDown[s]=void 0}isKeyDown(t){return this.keysDown[t]===t}isKeyUp(t){return this.keysDown[t]!==t}}class u{constructor(t,s){this.z=s,this.name=t;var i=this.canvas=document.createElement("canvas");i.id=t,i.width=1920,i.height=1080,i.style="z-index: "+s,this.context=i.getContext("2d"),this.objects=[],this.isDirty=!0,e.appendChild(i)}getLayer(t){return this.parent.layer[t]}addObject(t){t.parent=this,t.context=this.context,"number"!=typeof t.z&&(t.z=0),this.objects.push(t),this.isObjectListDirty=!0}removeObject(s){i(this.objects,t=>t===s),s.parent=null,s.context=null}clear(){var t=this.context,s=this.canvas,i=t.getTransform();t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,s.width,s.height),t.setTransform(i)}update(t){for(const i of this.objects){var s=i.update(t);this.isDirty=s||this.isDirty}this.isObjectListDirty&&(this.objects.sort((t,s)=>t.z-s.z),this.isObjectListDirty=!1)}draw(){if(this.isDirty){this.clear();for(const t of this.objects)t.draw();this.isDirty=!1}}dispose(){e.removeChild(this.canvas)}}const y=["avoid being hit","point to shoot","max ammo: 404"],p="Click or Press Enter to Start";class $ extends u{constructor(t,s){super(t,s),r(this),this.context.strokeStyle=n.enemies,this.context.fillStyle=n.player,this.context.lineWidth=8,this.context.font="64px verdana",this.context.textAlign="center",this.titleEase=0,this.addAction(new h(1,a,this,"titleEase",.75)),this.addObject(new X(100,100)),this.addObject(new Z(this.canvas.width-300,100)),this.keys=new l(window),this.mouse=new c(this.canvas)}clear(){var t=this.context,s=t.canvas,i=s.width/2,e=s.height/2;return t.save(),(i=t.createRadialGradient(i,e,s.height/2,i,e,4*s.height/3)).addColorStop(0,n.background),i.addColorStop(1,n.obstacles),t.fillStyle=i,t.fillRect(0,0,s.width,s.height),t.restore(),this}renderTitle(){var t=this.context,s=(e=t.canvas).width/2,i=e.height/2,e=+e.height/10;t.save(),t.font="128px verdana",.9<Math.random()&&(t.shadowBlur=16,t.shadowOffsetX=Math.round(16*Math.random()-8),t.shadowOffsetY=Math.round(16*Math.random()-8),t.shadowColor=t.fillStyle),t.fillText("Shooooooot!!",s,this.titleEase*i-e),t.restore()}renderInfoText(){var t,s=this.context,i=s.canvas,e=i.width/2,h=i.height/2;for(t in y){var a=y[t],n=this.titleEase*e;s.fillText(a,n,h+80*t)}}renderNext(){var t=this.context,s=(i=t.canvas).width/2,i=i.height/2,e=y.length+3,h=(s+=(1-this.titleEase)*s*2,i+=80*e,e=t.fillStyle,t.strokeStyle),a=(t.fillStyle=n.enemies,t.strokeStyle=n.enemies,t.fillText(p,s,i),1.1*t.measureText(p).width);t.strokeRect(s-a/2,i-70.4,a,88),t.fillStyle=e,t.strokeStyle=h}update(t){super.update(t),this.updateActions(t),(this.keys.isKeyDown(13)||this.mouse.isMouseDown)&&this.parent.start(),this.isDirty=!0}draw(){super.draw(),this.renderTitle(),this.renderInfoText(),this.renderNext()}}class J extends o{constructor(t,s,i,e){super(),this.x=t,this.y=s,this.width=i,this.height=e}draw(){this.context.strokeRect(this.x,this.y,this.width,this.height)}}class Q extends u{constructor(t,s){super(t,s),this.context.strokeStyle=n.obstacles,this.context.fillStyle=n.obstacles,this.context.lineWidth=6,this.addObject(new J(3,3,this.canvas.width-6,this.canvas.height-6))}update(t){return this.checkForBoundaryCollisions(),super.update(t)}checkForBoundaryCollisions(){const t=this.getLayer("simulation").enemies,s=this.getLayer("player").player;this.collidesWithBoundary(s)&&s.explode();for(const s of t)this.collidesWithBoundary(s)&&s.explode()}aabb(){return{left:3,top:3,right:this.canvas.width-6,bottom:this.canvas.height-6}}collidesWithBoundary(t){const s=this.canvas.width-6,i=this.canvas.height-6,e=[t.x-3,s-t.x,t.y-3,i-t.y];for(const s of e)if(s<t.radius)return!0;return!1}}class tt extends o{constructor(t,s,i){super(),this.x=t+i.radius,this.y=s+i.radius,this.enemy=i;var e=Math.floor(11*Math.random())+15;this.particles=new Array(e);for(let t=0;t<e;++t){const s=Math.random()*Math.PI*2;this.particles[t]={length:Math.floor(300*Math.random()),angle:s}}this.duration=1,this.factor=0,this.countDown=new h(1,a,this,"factor",1),this.addAction(this.countDown)}update(t){t=super.update(t);for(const t of this.particles)t.x=Math.cos(t.angle)*t.length*(1-this.factor)+this.x,t.y=Math.sin(t.angle)*t.length*(1-this.factor)+this.y;return 1<=this.factor&&(this.parent.addEnemy(this.enemy),this.parent.removeObject(this)),t}draw(){for(const t of this.particles)this.context.fillRect(t.x,t.y,8,8)}}class x extends o{constructor(t,s,i,e){super();var h=Math.floor(11*Math.random())+15,a=(this.particles=new Array(h),i+i),n=t-i,r=s-i;for(let t=0;t<h;++t){const s=Math.random()*Math.PI*2,i=Math.floor(12*Math.random())+8;this.particles[t]={x:Math.floor(Math.random()*a)+n,y:Math.floor(Math.random()*a)+r,angle:s,dx:Math.cos(s)*i,dy:Math.sin(s)*i,ttl:Math.random()*(1-.33)+.33}}}update(t){let s=!1;for(const i of this.particles)i.x+=i.dx,i.y+=i.dy,i.ttl-=t,s=0<=i.ttl||s;return s||this.parent.removeObject(this),!0}draw(){for(const t of this.particles)0<=t.ttl&&this.context.fillRect(t.x,t.y,5,5)}}function m(){const K=new AudioContext;return(t=1,s=.05,i=220,e=0,h=0,a=.1,n=0,r=1,o=0,d=0,c=0,l=0,u=0,y=0,p=0,x=0,m=0,w=1,g=0,v=0)=>{let f,M,b=2*Math.PI,S=o*=500*b/194481e4,k=(0<p?1:-1)*b/4,D=i*=(1+2*s*Math.random()-s)*b/44100,A=[],T=0,P=0,E=0,O=1,C=0,I=0,L=0;for(d*=500*b/44100**3,p*=b/44100,c*=b/44100,l*=44100,u=44100*u|0,M=(e=99+44100*e)+(g*=44100)+(h*=44100)+(a*=44100)+(m*=44100)|0;E<M;A[E++]=L)++I%(100*x|0)||(L=n?1<n?2<n?3<n?Math.sin((T%b)**3):Math.max(Math.min(Math.tan(T),1),-1):1-(2*T/b%2+2)%2:1-4*Math.abs(Math.round(T/b)-T/b):Math.sin(T),L=(u?1-v+v*Math.sin(2*Math.PI*E/u):1)*(0<L?1:-1)*Math.abs(L)**r*t*j*(E<e?E/e:E<e+g?1-(E-e)/g*(1-w):E<e+g+h?w:E<M-m?(M-E-m)/a*w:0),L=m?L/2+(m>E?0:(E<M-m?1:(M-E)/m)*A[E-m|0]/2):L),f=(i+=o+=d)*Math.sin(P*p-k),T+=f-f*y*(1-1e9*(Math.sin(E)+1)%2),P+=f-f*y*(1-1e9*(Math.sin(E)**2+1)%2),O&&++O>l&&(i+=c,D+=c,O=0),!u||++C%u||(i=D,o=S,O=O||1);return(t=K.createBuffer(1,M,44100)).getChannelData(0).set(A),(i=K.createBufferSource()).buffer=t,i.connect(K.destination),i.start(),i}}let w;class g extends o{constructor(t,s,i){super(),this.x=t,this.y=s,this.radius=i,this._center={x:t,y:s},this.pointValue=10,w=w||m()}center(){return this._center.x=this.x,this._center.y=this.y,this._center}explode(){this.exploded||(this.parent.addObject(new x(this.x,this.y,this.radius,5*this.radius)),this.incrementScore(),this.parent.removeEnemy(this),w(1,.05,240,0,.1,.43,2,1.29,3.2,0,0,0,0,1.7,.5,.5,.1,.55,.08,.27)),this.exploded=!0}incrementScore(){this.getPlayer().exploded||this.getHud().addScore(this.pointValue)}getPlayer(){return this.getLayer("player").player}getHud(){return this.getLayer("hud")}}const v=Math.PI/6,f=2*Math.PI;function M(t){for(;t>f;)t-=f;return t<0&&(t+=f),t}class b extends g{constructor(t,s){super(t,s,22.5),this.originalRadius=this.radius,this.width=45,this.height=45,t=this.angle=2*Math.random()*Math.PI,this.dx=7*Math.cos(t),this.dy=7*Math.sin(t),this.hits=0}getBoundaryBox(){return this.parent.getLayer("background").aabb()}setDirection(t){this.angle=t,this.dx=7*Math.cos(t),this.dy=7*Math.sin(t)}update(t){let s=super.update(t),i=!1;this.context.canvas;var{left:t,right:e,top:h,bottom:a}=this.getBoundaryBox(),n=this.x,r=this.y,o=this.radius;return n-t<o?(i=!0,this.x=t+o+(t+o)-n,this.dx=-this.dx):e-n<o?(i=!0,this.x=e-o+(e-o)-n,this.dx=-this.dx):r-h<o?(i=!0,this.y=h+o+(h+o)-r,this.dy=-this.dy):a-r<o&&(i=!0,this.y=a-o+(a-o)-r,this.dy=-this.dy),i&&(this.angle=Math.atan2(this.dy,this.dx)),s}draw(){var t=this.context;t.beginPath(),t.arc(this.x,this.y,this.radius,0,2*Math.PI),t.fill()}explode(){++this.hits,this.radius=3*this.originalRadius/(3+this.hits),3<=this.hits&&super.explode()}}const st=2*Math.PI;let S;class k extends g{constructor(t,s){super(t,s,15),this.pointValue=0,this.acceleration=1,this.addAction(new h(1,_,this,"acceleration",2.5)),S=S||m()}update(t){var s=this.getPlayer(),i=.5*this.acceleration;if(s){const t=s.center(),e=this.center(),h=t.x-e.x,a=t.y-e.y,n=Math.atan2(a,h)+Math.PI;this.dx=Math.cos(n)*i,this.dy=Math.sin(n)*i}return super.update(t)||!0}draw(){var t=this.context;t.save(),t.fillStyle=n.obstacles,t.strokeStyle=n.background,t.lineWidth=3,t.lineCap="round",t.beginPath(),t.arc(this.x,this.y,this.radius,0,2*Math.PI),t.fill(),t.beginPath(),t.moveTo(this.x-this.radius/2,this.y),t.lineTo(this.x+this.radius/2,this.y),t.moveTo(this.x,this.y-this.radius/2),t.lineTo(this.x,this.y+this.radius/2),t.stroke(),t.restore()}absorb(){this.exploded||(this.pointValue=50,this.incrementScore(),this.incrementAmmo(),this.parent.removeEnemy(this),S(1,.05,1719,0,.09,.11,1,1.14,0,0,992,.08,.02,.1,0,0,0,.7,.01,0)),this.exploded=!0}incrementAmmo(){this.getPlayer().exploded||this.getHud().addAmmo(this.pointValue)}}function D(t){return t*t}function A(t,s){return D(t.x-s.x)+D(t.y-s.y)}function it(t,s){var i=s.x-t.x;return Math.atan2(s.y-t.y,i)}const et={};class T extends h{constructor(s,t){super(0,t=>{1===t&&s()},et,"property",t)}}const ht=[class extends g{constructor(t,s){super(t,s,15),s-=15,this.x=t-=15,this.y=s,this.width=30,this.height=30,this.acceleration=1,this.addAction(new h(.75,W,this,"acceleration",2.5))}center(){return this._center.x=this.x+15,this._center.y=this.y+15,this._center}update(t){var s=this.getPlayer(),i=3*this.acceleration;if(s){const t=s.center(),e=this.center(),h=t.x-e.x,a=t.y-e.y;if(Math.abs(h)<i&&Math.abs(a)<i)this.dx=0,this.dy=0;else{const t=Math.atan2(a,h);this.dx=Math.cos(t)*i,this.dy=Math.sin(t)*i}}return super.update(t)}draw(){this.context.strokeRect(this.x,this.y,this.width,this.height)}},class extends g{constructor(t,s){super(t,s,12.5),s-=12.5,this.x=t-=12.5,this.y=s,this.width=25,this.height=25,this.pointValue=15}center(){return this._center.x=this.x+12.5,this._center.y=this.y+12.5,this._center}update(t){const i=this.getPlayer();if(i){const t=i.center(),s=this.center(),e=t.x-s.x,h=t.y-s.y;if(Math.abs(e)<5&&Math.abs(h)<5)this.dx=0,this.dy=0;else{let t=Math.atan2(h,e),s=0;if(this.inRepelArc(t,i)){const i=Math.random()*(Math.PI/2)-Math.PI/4;t=M(t+Math.PI+i),s=3}this.dx=Math.cos(t)*(5+s),this.dy=Math.sin(t)*(5+s)}}return super.update(t)}inRepelArc(t,s){t=M(t+Math.PI);let i=(s=M(s.angle))-v,e=s+v;return i<0?(i+=f,t<=e&&0<=t||t>=i&&t<=f):e>f?t<=(e-=f)&&0<=t||t>=i&&t<=f:t<=e&&t>=i}draw(){var t=this.context.lineWidth;this.context.lineWidth=9,this.context.strokeRect(this.x,this.y,this.width,this.height),this.context.lineWidth=t}},b,class extends g{constructor(t,s){super(t,s,13),s-=13,this.x=t-=13,this.y=s,this.spinX=t,this.spinY=s,this.width=26,this.height=26,this.spiralRadiusEase=0,this.spiralAngleEase=0,this.spiralAngle=2*Math.random()*Math.PI,this.spinDirection=Math.round(Math.random())?-1:1,t=new h(1,R,this,"spiralRadiusEase",1+Math.random()),s=new h(-1,U,this,"spiralRadiusEase",1+Math.random()),this.addAction(t.then(s).then(t))}center(){return this._center.x=this.x+13,this._center.y=this.y+13,this._center}update(t){this.spiralAngleEase+=this.spinDirection*t;let s=super.update(t);var i=this.getPlayer();if(i){const t=i.center(),s=t.x-this.spinX,e=t.y-this.spinY;if(Math.abs(s)<2&&Math.abs(e)<2)this.dx=0,this.dy=0;else{const t=Math.atan2(e,s);this.dx=2*Math.cos(t),this.dy=2*Math.sin(t)}}this.spinX+=this.dx,this.spinY+=this.dy;const e=this.spiralAngle+2*this.spiralAngleEase*Math.PI,h=100*(.5+this.spiralRadiusEase);return t=this.spinX+Math.cos(e)*h,i=this.spinY+Math.sin(e)*h,this.x=t,this.y=i,s||!0}draw(){var t=this.context;t.beginPath(),t.arc(this.x,this.y,this.radius,0,st),t.stroke()}}],at=["boxSpawn","cornerSpawn","sideSpawn"];function P(t){return Math.floor(Math.random()*t)}function E(t){return t[P(t.length)]}class nt extends u{constructor(t,s){super(t,s),this.context.strokeStyle=n.enemies,this.context.fillStyle=n.enemies,this.context.lineWidth=4,this.enemies=[],r(this),(t=new T(this.spawn.bind(this),5)).then(t),this.spawnTimer=t,this.addAction(this.spawnTimer),this.spawn()}update(t){var s=super.update(t);return this.checkForEnemyOnEnemyCollisions(),this.updateActions(t)||s}spawn(){var t=E(ht);this[E(at)](t)}boxSpawn(i){var e,t=Math.floor(this.canvas.width/8+Math.random()*(this.canvas.width/4)),s=Math.floor(this.canvas.height/8+Math.random()*(this.canvas.height/4)),h=[t,this.canvas.width/2,this.canvas.width-t],a=[s,this.canvas.height/2,this.canvas.height-s];for(let s=0;s<3;++s)for(let t=0;t<3;++t)1==s&&1===t||(e=new i(h[s],a[t]),this.spawnEnemy(e))}cornerSpawn(t){var s=h=Math.floor(this.canvas.height/(4*Math.random()+3)),i=h,e=this.canvas.height-h,h=this.canvas.width-h,a=[];this.addCluster(a,t,i+P(100),s+P(100)),this.addCluster(a,t,h-P(100),e-P(100)),this.addCluster(a,t,h-P(100),s+P(100)),this.addCluster(a,t,i+P(100),e);for(const t of a)this.spawnEnemy(t)}sideSpawn(s){var i=P(this.canvas.width-400)+200,e=P(this.canvas.height-400)+200,h=Math.floor(this.canvas.width/7),a=Math.floor(this.canvas.height/7);if(Math.random()<.5)for(let t=1;t<=5;++t)this.spawnEnemy(new s(i+P(50),t*a+P(50))),this.spawnEnemy(new s(i-P(50)-50,t*a+P(50)));else for(let t=1;t<=5;++t)this.spawnEnemy(new s(t*h+P(50),e+P(50))),this.spawnEnemy(new s(t*h+P(50),e-P(50)-50))}addCluster(t,s,i,e){var h=P(20)+60;t.push(new s(i,e)),t.push(new s(i+h,e+h)),t.push(new s(i,e+h)),t.push(new s(i+h,e))}spawnEnemy(t){Math.random()<=.15&&(t=new k(t.x,t.y)),this.addObject(new tt(t.x,t.y,t))}addEnemy(t){this.enemies.push(t),this.addObject(t)}removeEnemy(s){i(this.enemies,t=>t===s),this.removeObject(s)}checkForEnemyOnEnemyCollisions(){const i=this.enemies;for(let s=0;s<i.length;++s)for(let t=s+1;t<i.length;++t){var e=i[s],h=i[t];if(this.isCollision(e,h))if(e instanceof b){if(h instanceof b){const i=it(e,h);e.setDirection(i-Math.PI),h.setDirection(i)}e.explode(),h.explode()}else h instanceof b&&(e.explode(),h.explode())}}isCollision(t,s){var i=t.radius+s.radius;return A(t.center(),s.center())<=i*i}}const rt=2*Math.PI;class ot extends o{constructor(t,s,i){super(),this.x=t,this.y=s,this.radius=i}draw(){var t=this.context;t.beginPath(),t.arc(this.x,this.y,this.radius,0,rt),t.stroke()}}class O extends ot{constructor(t,s,i){super(t,s,i)}update(t){return this.x<0||this.y<0||this.x>this.parent.canvas.width||this.y>this.parent.canvas.height?(this.parent.removeBullet(this),!0):super.update(t)}}const C=2*Math.PI,I=Math.sqrt(2)/2;let L;class dt extends o{constructor(t,s,i){super(),this.x=t,this.y=s,this.radius=i,this._center={},this.aim={dx:0,dy:0},this.lastAim={dx:0,dy:0},(t=new T(this.shoot.bind(this),.2)).then(t),this.shootAction=t,this.ammo=404,this.shots=1,this.showCursor(),L=L||m()}showCursor(){this.isUsingGamepad&&(e.classList.remove("hidecursor"),e.classList.add("showcursor"),this.isUsingGamepad=!1)}hideCursor(){this.isUsingGamepad||(e.classList.remove("showcursor"),e.classList.add("hidecursor"),this.isUsingGamepad=!0)}startShooting(){this.addAction(this.shootAction)}stopShooting(){this.removeAction(this.shootAction)}magnitude({dx:t,dy:s}){return Math.sqrt(t*t+s*s)}shoot(){switch(this.shots){case 1:this.shoot1();break;case 2:this.shoot2();break;case 3:this.shoot3()}}shoot1(){var t,s;!this.inDeadZone(this.aim.dx,this.aim.dy)&&this.ammo&&(t=this.x+this.aim.dx*this.radius,s=this.y+this.aim.dy*this.radius,t=new O(t,s,5),s=this.magnitude(this.aim),t.dx=this.aim.dx/s*5*2,t.dy=this.aim.dy/s*5*2,this.parent.addBullet(t),this.decrementAmmo(1),L(1,.05,31,.04,0,.08,1,.17,0,0,0,0,.03,0,0,0,0,.23,.01,0))}shoot2(){if(!this.inDeadZone(this.aim.dx,this.aim.dy)&&1<this.ammo){let t,s=this.x+this.aim.dx*this.radius,i=this.y+this.aim.dy*this.radius,e=Math.atan2(this.aim.dy,this.aim.dx),h=5*Math.cos(e+Math.PI/2),a=5*Math.sin(e+Math.PI/2);(t=new O(s+h,i+a,5)).dx=5*Math.cos(e+Math.PI/90)*2,t.dy=5*Math.sin(e+Math.PI/90)*2,this.parent.addBullet(t),(t=new O(s-h,i-a,5)).dx=5*Math.cos(e-Math.PI/90)*2,t.dy=5*Math.sin(e-Math.PI/90)*2,this.parent.addBullet(t),this.decrementAmmo(2),L(1,.05,31,.04,0,.08,1,.17,0,0,0,0,.03,0,0,0,0,.23,.01,0),L(1,.05,31,.04,0,.08,1,.17,0,0,0,0,.03,0,0,0,0,.23,.01,0)}}shoot3(){this.shoot2(),this.shoot1()}decrementAmmo(t){this.ammo=this.getLayer("hud").decrementAmmo(t)}updateGuns(){var t=this.getLayer("hud").addScore(0);1500<t?this.shots=3:500<t&&(this.shots=2)}updateVelocity(t){let s=0,i=0,e=(t&&(s=t.axes[0],i=t.axes[1],this.inDeadZone(s,i))&&(s=0,i=0),!1);(this.parent.keys.isKeyDown(37)||this.parent.keys.isKeyDown(Y))&&(--s,e=!0),(this.parent.keys.isKeyDown(39)||this.parent.keys.isKeyDown(H))&&(s+=1,e=!0),(this.parent.keys.isKeyDown(38)||this.parent.keys.isKeyDown(N))&&(--i,e=!0),(this.parent.keys.isKeyDown(40)||this.parent.keys.isKeyDown(q))&&(i+=1,e=!0),e&&s&&i&&(s*=I,i*=I),this.dx=5*s,this.dy=5*i,this.angle=Math.atan2(i,s)}inDeadZone(t,s){return t*t+s*s<.2*.2}getMouse(){return this.getLayer("hud").mouse}updateAim(t){let s=0,i=0;t&&(s=t.axes[2],i=t.axes[3],this.inDeadZone(s,i)?(s=0,i=0):this.hideCursor());var e=this.getMouse();if(e.isMouseDown){const t=Math.atan2(e.current.y-this.y,e.current.x-this.x);s=Math.cos(t),i=Math.sin(t),this.showCursor()}return this.lastAim.dx=this.aim.dx,this.lastAim.dy=this.aim.dy,this.aim.dx=s,this.aim.dy=i,this.aim.angle=Math.atan2(i,s),this.inDeadZone(this.lastAim.dx,this.lastAim.dy)&&!this.inDeadZone(this.aim.dx,this.aim.dy)?(this.startShooting(),this.shoot()):!this.inDeadZone(this.lastAim.dx,this.lastAim.dy)&&this.inDeadZone(this.aim.dx,this.aim.dy)&&this.stopShooting(),this.lastAim.dx!==s||this.lastAim.dy!==i}explode(){this.exploded||(this.stopShooting(),this.parent.addObject(new x(this.x,this.y,this.radius,5*this.radius)),L(1,.05,776,0,.21,.83,4,4.8,0,1,0,0,0,.6,.2,.6,0,.94,.09,.41)),this.exploded=!0}update(t){var s;if(this.decrementAmmo(0),this.updateGuns(),!this.exploded)return s=navigator.getGamepads()[0],this.updateVelocity(s),s=this.updateAim(s),super.update(t)||s}center(){return this._center.x=this.x,this._center.y=this.y,this._center}draw(){var t=this.context;this.exploded||(t.beginPath(),t.arc(this.x,this.y,this.radius,0,C),t.stroke(),t.beginPath(),t.arc(this.x+this.aim.dx*this.radius,this.y+this.aim.dy*this.radius,5,0,C),t.stroke())}}class ct extends u{constructor(t,s){super(t,s),this.context.strokeStyle=n.player,this.context.fillStyle=n.player,this.context.lineWidth=4,this.context.font="64px serif",this.player=new dt(this.canvas.width/2,this.canvas.height/2,20),this.addObject(this.player),this.keys=new l(window),this.bullets=[]}addBullet(t){this.bullets.push(t),this.addObject(t)}removeBullet(s){i(this.bullets,t=>t===s),this.removeObject(s)}update(t){return t=super.update(t),this.player.exploded&&this.parent.gameOver(),this.checkForBulletCollisions(),this.checkForEnemyCollisions(),t}checkForBulletCollisions(){const t=this.getLayer("simulation").enemies,s=[];for(const i of this.bullets)for(const e of t){const t=i.radius+e.radius;A(i,e.center())<t*t&&(s.push(i),e.explode())}for(const t of s)this.removeBullet(t)}checkForEnemyCollisions(){const t=this.getLayer("simulation").enemies;for(const s of t){const t=this.player.radius+s.radius;A(this.player,s.center())<t*t&&(s instanceof k?s.absorb():(s.explode(),this.player.explode(),this.parent.gameOver()))}}}class lt extends u{constructor(t,s){super(t,s),this.context.strokeStyle=n.player,this.context.fillStyle=n.player,this.context.lineWidth=4,this.context.font="64px verdana",this.score=0,this.ammo=404,this.scoreSprite=new d("score: 0",50,80),this.scoreSprite.state="visible",this.addObject(this.scoreSprite),this.ammoSprite=new d("ammo: "+this.ammo,this.canvas.width-430,80),this.ammoSprite.state="visible",this.addObject(this.ammoSprite),this.mouse=new c(this.canvas)}addScore(t){return this.isDirty=!0,this.score+=t,this.score}addAmmo(t){return this.isDirty=!0,this.ammo=Math.min(404,this.ammo+t),this.ammo}decrementAmmo(t=1){return this.isDirty=!0,this.ammo=Math.max(0,this.ammo-t),this.ammo}setAmmo(t){this.ammo!=t&&(this.ammo=t,this.isDirty=!0)}getPlayer(){return this.getLayer("player").player}hideText(t){var s=new h(-120,B,t,"y",.25);t.addAction(s),t.state="hiding"}showText(t){var s=new h(120,a,t,"y",.33);t.addAction(s),t.state="unhiding"}updateState(t){"hiding"===t.state&&0===t.actions.length?t.state="hidden":"unhiding"===t.state&&0===t.actions.length&&(t.state="visible")}update(t){this.isDirty&&(this.scoreSprite.setText("score: "+this.score),this.ammoSprite.setText("ammo: "+this.ammo)),this.updateState(this.scoreSprite),this.updateState(this.ammoSprite);var s=this.getPlayer(),i=(s=s.exploded?{x:this.canvas.width,y:this.canvas.height}:s).y<160;return i&&s.x<500?"visible"===this.scoreSprite.state&&this.hideText(this.scoreSprite):i&&s.x>this.canvas.width-500?"visible"===this.ammoSprite.state&&this.hideText(this.ammoSprite):"hidden"===this.scoreSprite.state?this.showText(this.scoreSprite):"hidden"===this.ammoSprite.state&&this.showText(this.ammoSprite),super.update(t)}}class ut extends u{constructor(t,s){super(t,s),r(this),this.context.strokeStyle=n.enemies,this.context.fillStyle=n.player,this.context.lineWidth=8,this.context.font="96px verdana",this.context.textAlign="center",this.addAction(new h(1,a,this,"ease",.75)),this.keys=new l(window),this.gameText=new d("GAME",this.canvas.width/2,-120),this.overText=new d("OVER",this.canvas.width/2,this.canvas.height),this.addObject(this.gameText),this.addObject(this.overText),this.addAction(new h(this.canvas.height/2,a,this.gameText,"y",.5)),this.addAction(new h(-this.canvas.height/2,a,this.overText,"y",.5))}showMessage(t){t=new d(t,this.canvas.width/2,this.canvas.height+120),this.addObject(t),this.addAction(new h(-this.canvas.height/2+120,a,t,"y",1.5))}update(t){super.update(t),this.updateActions(t),t=navigator.getGamepads()[0],(this.keys.isKeyDown(13)||t&&t.buttons[0].pressed)&&this.parent.start(),this.isDirty=!0}draw(){super.draw();var t=this.context,s=(t.save(),t.font="64px verdana",t.fillStyle=n.enemies,this.canvas.width/2),i=this.canvas.height-80-80;t.fillText("Press Enter or Button 0 to Restart",s,i),t.restore()}}let K=new class{constructor(){this.gameIsStarted=!1,this.gameIsOver=!1,e.style.background=n.background,this.layer={},this.layers=[],this.highScore=0,this.intro()}addLayer(t){(t.parent=this).layer[t.name]=t,this.layers.push(t)}resetLayers(){for(const t of this.layers)t.parent=null,t.dispose();this.layers.length=0,this.layer={}}update(t){for(const s of this.layers)s.update(t);this.gameIsStarted&&!this.gameIsOver&&this.layer.player.player.exploded&&this.gameOver()}draw(){for(const t of this.layers)t.draw()}intro(){this.resetLayers(),this.addLayer(new $("intro",0))}start(){this.resetLayers(),j=s,this.addLayer(new Q("background",0)),this.addLayer(new nt("simulation",1)),this.addLayer(new ct("player",2)),this.addLayer(new lt("hud",3)),this.gameIsOver=!1}gameOver(){var t;this.gameIsOver||(s=j,j=0,this.addLayer(new ut("gameover",4)),this.gameIsOver=!0,(t=this.layer.hud.score)>this.highScore?(this.highScore=t,this.layer.gameover.showMessage(`New High Score: ${t}!!`)):this.layer.gameover.showMessage("Score to Beat: "+this.highScore))}};new class{constructor(t,s){this.update=t,this.draw=s,this.nextTick=this.tick.bind(this)}start(){var t=this.init.bind(this);window.requestAnimationFrame(t)}init(t){this.lastTimeStamp=t,this.tick(t)}tick(t){let s=(t-this.lastTimeStamp)/1e3;this.lastTimeStamp=t,s>1/15&&(s=1/15),this.update(s),this.draw(),window.requestAnimationFrame(this.nextTick)}}(function(t){K.update(t)},function(){K.draw()}).start()</script>