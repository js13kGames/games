<!doctype html><meta content="width=device-width,user-scalable=no" name=viewport><title>Lost Pacman</title><body><script src=/2017/webxr/aframe.js></script><script>var score=-1,scores=[],go=!1,countDown=!0,gameOver=!1,gameFinish=!1,retry=!1,countDownTimer=20,newGameTimer=3,localStorageId="js13k2017-lost-pacman-hscore",storeScore=!0,flagGameOver=!1,pacmanPos={x:0,z:0},playerPos={x:0,z:0}</script><script>function random(){return Math.random()}function SfxrParams(){this.ss=function(t){for(var e=0;e<24;e++)this[String.fromCharCode(97+e)]=t[e]||0;this.c<.01&&(this.c=.01);var i=this.b+this.c+this.e;if(i<.18){var o=.18/i;this.b*=o,this.c*=o,this.e*=o}}}function SfxrSynth(){var t,e,i,o,r,a,n,s,c,l,u,h;this._p=new SfxrParams,this.r=function(){var t=this._p;o=100/(t.f*t.f+.001),r=100/(t.g*t.g+.001),a=1-t.h*t.h*t.h*.01,n=-t.i*t.i*t.i*1e-6,t.a||(u=.5-t.n/2,h=5e-5*-t.o),s=1+t.l*t.l*(t.l>0?-.9:10),c=0,l=1==t.m?0:(1-t.m)*(1-t.m)*2e4+32},this.tr=function(){this.r();var o=this._p;return t=o.b*o.b*1e5,e=o.c*o.c*1e5,i=o.e*o.e*1e5+12,3*((t+e+i)/3|0)},this.sw=function(d,m){var p=this._p,y=1!=p.s||p.v,f=p.v*p.v*.1,b=1+3e-4*p.w,x=p.s*p.s*p.s*.1,g=1+1e-4*p.t,v=1!=p.s,A=p.x*p.x,z=p.g,w=p.q||p.r,S=p.r*p.r*p.r*.2,P=p.q*p.q*(p.q<0?-1020:1020),k=p.p?32+((1-p.p)*(1-p.p)*2e4|0):0,C=p.d,D=p.j/2,T=p.k*p.k*.01,M=p.a,E=t,q=1/t,O=1/e,F=1/i,j=5/(1+p.u*p.u*20)*(.01+x);j>.8&&(j=.8),j=1-j;for(var R,W,G,I,N,J,U=!1,_=0,B=0,Y=0,H=0,K=0,L=0,Q=0,V=0,X=0,Z=0,$=new Array(1024),tt=new Array(32),et=$.length;et--;)$[et]=0;for(et=tt.length;et--;)tt[et]=random(2,-1);for(et=0;et<m;et++){if(U)return et;if(k&&++X>=k&&(X=0,this.r()),l&&++c>=l&&(l=0,o*=s),(o*=a+=n)>r&&(o=r,z>0&&(U=!0)),W=o,D>0&&(Z+=T,W*=1+Math.sin(Z)*D),(W|=0)<8&&(W=8),M||((u+=h)<0?u=0:u>.5&&(u=.5)),++B>E)switch(B=0,++_){case 1:E=e;break;case 2:E=i}switch(_){case 0:Y=B*q;break;case 1:Y=1+2*(1-B*O)*C;break;case 2:Y=1-B*F;break;case 3:Y=0,U=!0}w&&((G=0|(P+=S))<0?G=-G:G>1023&&(G=1023)),y&&b&&((f*=b)<1e-5?f=1e-5:f>.1&&(f=.1)),J=0;for(var it=8;it--;){if(++Q>=W&&(Q%=W,3==M))for(var ot=tt.length;ot--;)tt[ot]=random(2,-1);switch(M){case 0:N=Q/W<u?.5:-.5;break;case 1:N=1-Q/W*2;break;case 2:N=.225*(((N=1.27323954*(I=6.28318531*((I=Q/W)>.5?I-1:I))+.405284735*I*I*(I<0?1:-1))<0?-1:1)*N*N-N)+N;break;case 3:N=tt[Math.abs(32*Q/W|0)]}y&&(R=L,(x*=g)<0?x=0:x>.1&&(x=.1),v?(K+=(N-L)*x,K*=j):(L=N,K=0),H+=(L+=K)-R,N=H*=1-f),w&&($[V%1024]=N,N+=$[(V-G+1024)%1024],V++),J+=N}J*=.125*Y*A,d[et]=J>=1?32767:J<=-1?-32768:32767*J|0}return m}}function jsfxr(t,e,i){synth._p.ss(t);var o=synth.tr(),r=new Uint8Array(4*((o+1)/2|0)+44),a=2*synth.sw(new Uint16Array(r.buffer,44),o),n=new Uint32Array(r.buffer,0,44);n[0]=1179011410,n[1]=a+36,n[2]=1163280727,n[3]=544501094,n[4]=16,n[5]=65537,n[6]=44100,n[7]=88200,n[8]=1048578,n[9]=1635017060,n[10]=a,a+=44;for(var s=0,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",l="data:audio/wav;base64,";s<a;s+=3){var u=r[s]<<16|r[s+1]<<8|r[s+2];l+=c[u>>18]+c[u>>12&63]+c[u>>6&63]+c[63&u]}return e&&e.decodeAudioData(r.buffer,i),l}var audioCtx,audioDest,audio,play,synth=new SfxrSynth,AudioContext=window.AudioContext||window.webkitAudioContext;if(AudioContext){audioCtx=new AudioContext,audioDest=audioCtx.createDynamicsCompressor();var gain=audioCtx.createGain();gain.gain.value=1,audioDest.connect(gain),gain.connect(audioCtx.destination),audio=function(t){var e=[];return jsfxr(t,audioCtx,(function(t){e.push(t)})),e},play=function(t){if(t[0]){var e=audioCtx.createBufferSource();e.buffer=t[0],e.start(0),e.connect(audioDest),setTimeout((function(){e.disconnect(audioDest)}),1e3*t[0].duration+300)}}}else audio=play=function(){};var ACookie=audio([0,,.0871,.4268,.1343,.4023,,,,,,.5808,.6415,,,,,,1,,,,,.5]),AGameOver=audio([3,.1514,.6943,.0058,.3098,.2826,,-.3168,.0069,-.0025,-.7927,-.0967,.5125,,-.6956,,.9598,-.814,.2006,-.2304,-.6659,,.422,.5]),colors=["#f00","#00f","#fff","#000","#f1c40f","#3498db","#C15AAD"];function aabbCollides(t,e){return t.x-t.width/2<e.x-e.width/2+e.width&&t.x-t.width/2+t.width>e.x-e.width/2&&t.z-t.depth/2<e.z-e.depth/2+e.depth&&t.z-t.depth/2+t.depth>e.z-e.depth/2}function clone(t){var e;if(null==t||"object"!=typeof t)return t;if(t instanceof Date)return(e=new Date).setTime(t.getTime()),e;if(t instanceof Array){e=[];for(var i=0,o=t.length;i<o;i++)e[i]=clone(t[i]);return e}if(t instanceof Object){for(var r in e={},t)t.hasOwnProperty(r)&&(e[r]=clone(t[r]));return e}throw new Error("Unable to copy obj! Its type isn't supported.")}function addTriangle(t,e,i,o,r,a,n){document.querySelector("a-scene");var s=document.createElement("a-entity");s.setAttribute("geometry",{primitive:"triangle",vertexA:AFRAME.utils.coordinates.stringify(t),vertexB:AFRAME.utils.coordinates.stringify(e),vertexC:AFRAME.utils.coordinates.stringify(i)}),s.setAttribute("position",{x:r.x,y:r.y,z:r.z}),s.setAttribute("rotation",{x:0,y:o,z:0}),s.setAttribute("material",{color:a}),n.appendChild(s)}function addPlane(t,e,i,o,r,a,n){addTriangle({x:0,y:0,z:0},{x:0,y:e*a,z:0},{x:t*a,y:0,z:0},i,o,r,n),addTriangle({x:t*a,y:0,z:0},{x:0,y:e*a,z:0},{x:t*a,y:e*a,z:0},i,o,r,n)}function angleTo(t,e){return Math.atan2(e.x-t.x,e.z-t.z)}AFRAME.registerComponent("pacman",{init:function(){},tick:function(t,e){!1===go?this.el.setAttribute("visible",!1):this.el.setAttribute("visible",!0);var i=document.querySelector(".player").getAttribute("position"),o=angleTo(this.el.object3D.position,i);this.el.object3D.rotation.y=o}}),AFRAME.registerComponent("phantom",{schema:{color:{type:"string",default:"#f00"}},init:function(){this.game=document.querySelector("a-scene").systems.game;this.data;var t=this.el,e=.05,i=(t.getAttribute("position"),-.25);this.direction=2;var o=this.data.color;addPlane(1,8,180,{x:-.25,y:0,z:0},o,e,t),addPlane(1,10,180,{x:-.2,y:.05,z:0},o,e,t),addPlane(1,10,180,{x:-.15,y:.1,z:0},o,e,t),addPlane(1,12,180,{x:-.1,y:.05,z:0},o,e,t),addPlane(1,14,180,{x:i+.2,y:0,z:0},o,e,t),addPlane(1,12,180,{x:0,y:.1,z:0},o,e,t),addPlane(1,12,180,{x:i+.3,y:.1,z:0},o,e,t),addPlane(1,14,180,{x:i+.35,y:0,z:0},o,e,t),addPlane(1,12,180,{x:i+.4,y:.05,z:0},o,e,t),addPlane(1,10,180,{x:.2,y:.1,z:0},o,e,t),addPlane(1,10,180,{x:.25,y:.05,z:0},o,e,t),addPlane(1,8,180,{x:i+.55,y:0,z:0},o,e,t),addPlane(4,3,180,{x:i+.2,y:.35,z:.01},colors[2],e,t),addPlane(2,5,180,{x:-.1,y:.3,z:.01},colors[2],e,t),addPlane(2,2,180,{x:-.15,y:.35,z:.02},colors[3],e,t),addPlane(4,3,180,{x:.25,y:.35,z:.01},colors[2],e,t),addPlane(2,5,180,{x:.2,y:.3,z:.01},colors[2],e,t),addPlane(2,2,180,{x:i+.4,y:.35,z:.02},colors[3],e,t)},tick:function(t,e){var i=clone(this.el.object3D.position),o=this.el.object3D.position,r=.7*e/1e3;this.lookToPlayer();if(this.el.setAttribute("position",{x:o.x,y:o.y+=.005*Math.sin(.005*t+.1),z:o.z}),go){switch(this.direction){case 0:this.el.setAttribute("position",{x:o.x,y:o.y,z:o.z+r});break;case 1:this.el.setAttribute("position",{x:o.x,y:o.y,z:o.z-r});break;case 2:this.el.setAttribute("position",{x:o.x-r,y:o.y,z:o.z});break;case 3:this.el.setAttribute("position",{x:o.x+r,y:o.y,z:o.z})}1==this.checkWalls()&&(this.el.setAttribute("position",{x:i.x,y:i.y,z:i.z}),this.direction=~~(3*Math.random()+0))}},lookToPlayer:function(){var t=document.querySelector(".player").getAttribute("position"),e=angleTo(this.el.object3D.position,t);this.el.object3D.rotation.y=e},checkWalls:function(){var t=this.el.getAttribute("position"),e=this.game.map.length,i=this.game.map[0].length,o={};o.x=t.x,o.z=t.z,o.width=.9,o.depth=.9;for(var r=0;r<i;++r)for(var a=0;a<e;++a)if(1===this.game.map[a][r]){var n={};if(n.x=r,n.z=a,n.width=1,n.depth=1,aabbCollides(n,o))return!0}return!1}}),AFRAME.registerComponent("pointer",{init:function(){},tick:function(t,e){var i=this.el;!0===countDown||1==gameOver?i.setAttribute("visible",!1):i.setAttribute("visible",!0)}}),AFRAME.registerComponent("user-interface",{init:function(){},tick:function(t,e){var i=this.el;!0===gameOver&&i.setAttribute("visible",!1),!0===gameFinish&&i.setAttribute("visible",!1),i.setAttribute("text",{value:"Score: "+score})}}),AFRAME.registerComponent("game-state-interface",{init:function(){},tick:function(t,e){var i=this.el,o="";if(!0===retry&&(retry=!1,countDownTimer=7),!0===countDown)countDownTimer>5?o="Ready?\r\n"+~~countDownTimer:countDownTimer>3?o="Steady?\r\n"+~~countDownTimer:countDownTimer>.1&&(o="Go!\r\n"+~~countDownTimer),i.setAttribute("text",{value:o});else if(!0===gameOver){var r=scores[0]<score?score:scores[0];o="Game Over",i.setAttribute("text",{value:o})}else if(!0===gameFinish){scores.sort(),scores.reverse();r=scores[0]<score?score:scores[0];o="Congratulations!\r\n Your score: "+score+"\r\nBest score: "+r,scores[0]<score&&(o+="\r\nNEW RECORD!!!"),i.setAttribute("text",{value:o})}}}),AFRAME.registerComponent("check-cookie",{init:function(){var t=document.querySelector("a-scene");this.cookies=t.querySelectorAll(".cookie")},tick:function(t,e){var i=this.el.object3D.position,o={};o.x=i.x,o.z=i.z,o.width=1,o.depth=1;for(var r=this.cookies.length-1;r>=0;--r){var a={};a.x=this.cookies[r].getAttribute("position").x,a.z=this.cookies[r].getAttribute("position").z,a.width=.5,a.depth=.5,a.visible=this.cookies[r].getAttribute("visible"),aabbCollides(a,o)&&!0===a.visible&&(++score,this.cookies[r].setAttribute("visible",!1),score>0&&play(ACookie))}}}),AFRAME.registerComponent("check-phantom",{init:function(){},tick:function(t,e){this.el.object3D.position;1==this.checkPhantoms()&&!0===storeScore&&(go=!1,gameOver=!0,storeScore=!1)},checkPhantoms:function(){var t=document.querySelector("a-scene"),e=t.querySelector("#camera").getAttribute("position"),i={};i.x=e.x,i.z=e.z,i.width=.1,i.depth=.1;for(var o=t.querySelectorAll(".phantom"),r=o.length-1;r>=0;--r){var a=o[r].getAttribute("position"),n={};if(n.x=a.x,n.z=a.z,n.width=1,n.depth=1,aabbCollides(n,i))return!0}return!1}}),AFRAME.registerComponent("move-player",{init:function(){this.game=document.querySelector("a-scene").systems.game;document.querySelector("a-scene")},tick:function(t,e){if(!0===this.checkPacman()&&(go=!1,gameFinish=!0),!0===this.checkPacman()&&!0===storeScore&&(storeScore=!1,scores=JSON.parse(localStorage.getItem(localStorageId)),scores.push(score),localStorage.removeItem(localStorageId),localStorage.setItem(localStorageId,JSON.stringify(scores))),!1!==go){var i=clone(this.el.object3D.position),o=this.el.object3D.rotation.y,r=this.el.object3D.position,a=1*Math.sin(o)*e/1e3,n=1*Math.cos(o)*e/1e3;this.el.setAttribute("position",{x:r.x-a,y:r.y,z:r.z-n}),1==this.checkWalls()&&this.el.setAttribute("position",{x:i.x,y:i.y,z:i.z})}},checkPacman:function(){var t=document.querySelector("#camera").getAttribute("position"),e={};e.x=t.x,e.z=t.z,e.width=.1,e.depth=.1;var i={};return i.x=pacmanPos.x,i.z=pacmanPos.z,i.width=1,i.depth=1,!!aabbCollides(i,e)},checkWalls:function(){var t=document.querySelector("#camera").getAttribute("position"),e=this.game.map.length,i=this.game.map[0].length,o={};o.x=t.x,o.z=t.z,o.width=.1,o.depth=.1;for(var r=0;r<i;++r)for(var a=0;a<e;++a)if(1===this.game.map[a][r]){var n={};if(n.x=r,n.z=a,n.width=1,n.depth=1,aabbCollides(n,o))return!0}return!1}}),AFRAME.registerSystem("game",{schema:{},init:function(){scores=localStorage.getItem(localStorageId),scores||localStorage.setItem(localStorageId,JSON.stringify([])),scores=JSON.parse(localStorage.getItem(localStorageId)),console.log(scores),this.map=[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1],[1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1],[1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,0,1],[1,0,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,0,1],[1,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,1],[1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1],[1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1],[1,1,1,1,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],this.tileSize=1,this.createMap(),playerPos.x=1,playerPos.z=5,this.instantiatePhantom(colors[0]),this.instantiatePhantom(colors[4]),this.instantiatePhantom(colors[5]),this.instantiatePhantom(colors[6]),this.instantiatePacman()},tick(t,e){!0===gameOver&&newGameTimer>=0&&(newGameTimer-=.1*e/100),newGameTimer,!0===countDown&&(countDownTimer-=.1*e/100),countDownTimer<=0&&!1===gameOver&&(go=!0,countDown=!1),!0===gameOver&&!1===flagGameOver&&(flagGameOver=!0,play(AGameOver))},resetGame:function(){score=-1,go=!1,countDown=!0,gameOver=!1,retry=!1,countDownTimer=7,newGameTimer=3,storeScore=!0,flagGameOver=!1,document.querySelector(".player").setAttribute("position",{x:1,y:.5,z:5})},createMap:function(){for(var t=0,e=this.map.length,i=this.map[0].length,o=0;o<i;++o)for(var r=0;r<e;++r)r===e-1&&0===this.map[r-1][o]?this.instantiateWall(o+.5,r-.5,-180):0===r&&0===this.map[r+1][o]?this.instantiateWall(o-.5,r+.5,0):o===i-1&&0===this.map[r][o-1]?this.instantiateWall(o-.5,r-.5,-90):0===o&&0===this.map[r][o+1]&&this.instantiateWall(o+.5,r+.5,90),o>0&&o<i-1&&r>0&&r<e-1&&1==this.map[r][o]?(0===this.map[r-1][o]&&this.instantiateWall(o+.5,r-.5,-180),0===this.map[r+1][o]&&this.instantiateWall(o-.5,r+.5,0),0===this.map[r][o-1]&&this.instantiateWall(o-.5,r-.5,-90),0===this.map[r][o+1]&&this.instantiateWall(o+.5,r+.5,90)):o>0&&o<i-1&&r>0&&r<e-1&&0==this.map[r][o]&&(this.instantiateCookie(o,r,t),++t)},instantiateWall:function(t,e,i){var o=document.querySelector("a-scene");addTriangle({x:0,y:0,z:0},{x:1,y:0,z:0},{x:1,y:1,z:0},i,{x:t,y:0,z:e},colors[1],o),addTriangle({x:0,y:0,z:0},{x:1,y:1,z:0},{x:0,y:1,z:0},i,{x:t,y:0,z:e},colors[1],o)},instantiatePhantom:function(t){var e=document.querySelector("a-scene"),i=document.createElement("a-entity"),o=this.getFreePosition();i.setAttribute("position",{x:o.x,y:.2,z:o.z}),console.log("Phantom in x: "+o.x+" z: "+o.z),i.setAttribute("phantom",{color:t}),i.className="phantom",e.appendChild(i)},getFreePosition:function(){for(var t=this.map.length,e=this.map[0].length,i=0,o=0,r=0;r<100;++r)if(i=~~(Math.random()*(e-1-1)+1),o=~~(Math.random()*(t-1-1)+1),0===this.map[o][i]&&i!==playerPos.x&&o!==playerPos.z)return{x:i,z:o}},instantiateCookie:function(t,e,i){var o=document.querySelector("a-scene"),r=document.createElement("a-entity");r.setAttribute("geometry",{primitive:"sphere",radius:.1}),r.setAttribute("position",{x:t,y:.25,z:e}),r.setAttribute("material",{color:"#fff"}),r.setAttribute("visible",!0),r.className="cookie",o.appendChild(r)},instantiatePacman:function(){var t=document.querySelector("a-scene"),e=document.createElement("a-entity"),i=this.getFreePosition();e.setAttribute("position",{x:i.x,y:.05,z:i.z}),pacmanPos.x=i.x,pacmanPos.z=i.z,console.log("Pacman in x: "+i.x+" z: "+i.z);var o=document.createElement("a-entity");o.setAttribute("geometry",{primitive:"sphere",radius:.4}),o.setAttribute("position",{x:0,y:.4,z:0}),o.setAttribute("material",{color:colors[4]}),o.setAttribute("visible",!0),e.appendChild(o);var r=document.createElement("a-entity");r.setAttribute("geometry",{primitive:"sphere",radius:.1}),r.setAttribute("position",{x:-.15,y:.5,z:.35}),r.setAttribute("material",{color:colors[3]}),r.setAttribute("visible",!0),e.appendChild(r);var a=document.createElement("a-entity");a.setAttribute("geometry",{primitive:"sphere",radius:.1}),a.setAttribute("position",{x:.15,y:.5,z:.35}),a.setAttribute("material",{color:colors[3]}),a.setAttribute("visible",!0),e.appendChild(a);var n=document.createElement("a-entity");n.setAttribute("geometry",{primitive:"torus",arc:360,radius:.28,radiusTubular:.04}),n.setAttribute("position",{x:0,y:.3,z:.06}),n.setAttribute("rotation",{x:-90,y:0,z:0}),n.setAttribute("material",{color:colors[3]}),n.setAttribute("visible",!0),n.setAttribute("theta-start",45),e.appendChild(n),e.className="pacman",e.setAttribute("pacman",""),t.appendChild(e)}})</script><a-scene game><a-entity position="1 0 5" id=camera camera="userHeight: 0.5" check-cookie check-phantom class=player look-controls move-player rotation="0 0 0"><a-entity position="0 0 0" light="color: #fff; intensity: 0.8; type: point;"></a-entity><a-entity position="0 0.45 -0.65" id=ui-score text=font:kelsonsans;align:center; user-interface></a-entity><a-entity position="0 0 -0.50" id=ui-game-state text=font:kelsonsans;align:center game-state-interface></a-entity><a-box cursor="fuse: true; fuseTimeout: 300" depth=1 height=1 raycaster=far:1; width=1></a-box><a-entity position="0 0 0" id=cursor cursor="fuse: false; fuseTimeout: 300" geometry="primitive: ring; radiusInner: 0.005; radiusOuter: 0.007" material="color: #f00; shader: flat" pointer raycaster=far:1></a-entity></a-entity><a-sky color=#000 id=sky></a-sky><a-plane color=#000 height=28 id=floor position="15 0 14" rotation="-90 0 0" width=30></a-plane></a-scene>