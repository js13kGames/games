<script src=/2018/webxr/aframe.js></script><script>!function(t,e){"function"==typeof define&&define.amd?define(["exports"],e):e("object"==typeof exports&&"string"!=typeof exports.nodeName?exports:t.TinyMusic={})}(this,(function(t){function e(t){var i=t.split(r);this.frequency=e.getFrequency(i[0])||0,this.duration=e.getDuration(i[1])||0}function i(t,e,i){this.ac=t||new AudioContext,this.createFxNodes(),this.tempo=e||120,this.loop=!0,this.smoothing=0,this.staccato=0,this.notes=[],this.push.apply(this,i||[])}var n=440*Math.pow(Math.pow(2,1/12),-9),o=/^[0-9.]+$/,r=/\s+/,a=/(\d+)/,s={};"B#-C|C#-Db|D|D#-Eb|E-Fb|E#-F|F#-Gb|G|G#-Ab|A|A#-Bb|B-Cb".split("|").forEach((function(t,e){t.split("-").forEach((function(t){s[t]=e}))})),e.getFrequency=function(t){var e=t.split(a),i=s[e[0]],o=(e[1]||4)-4;return n*Math.pow(Math.pow(2,1/12),i)*Math.pow(2,o)},e.getDuration=function(t){return o.test(t)?parseFloat(t):t.toLowerCase().split("").reduce((function(t,e){return t+("w"===e?4:"h"===e?2:"q"===e?1:"e"===e?.5:"s"===e?.25:0)}),0)},i.prototype.createFxNodes=function(){var t=this.gain=this.ac.createGain();return[["bass",100],["mid",1e3],["treble",2500]].forEach(function(e,i){(i=this[e[0]]=this.ac.createBiquadFilter()).type="peaking",i.frequency.value=e[1],t.connect(t=i)}.bind(this)),t.connect(this.ac.destination),this},i.prototype.push=function(){return Array.prototype.forEach.call(arguments,function(t){this.notes.push(t instanceof e?t:new e(t))}.bind(this)),this},i.prototype.createCustomWave=function(t,e){e||(e=t),this.waveType="custom",this.customWave=[new Float32Array(t),new Float32Array(e)]},i.prototype.createOscillator=function(){return this.stop(),this.osc=this.ac.createOscillator(),this.customWave?this.osc.setPeriodicWave(this.ac.createPeriodicWave.apply(this.ac,this.customWave)):this.osc.type=this.waveType||"square",this.osc.connect(this.gain),this},i.prototype.scheduleNote=function(t,e){var i=60/this.tempo*this.notes[t].duration,n=i*(1-(this.staccato||0));return this.setFrequency(this.notes[t].frequency,e),this.smoothing&&this.notes[t].frequency&&this.slide(t,e,n),this.setFrequency(0,e+n),e+i},i.prototype.getNextNote=function(t){return this.notes[t<this.notes.length-1?t+1:0]},i.prototype.getSlideStartDelay=function(t){return t-Math.min(t,60/this.tempo*this.smoothing)},i.prototype.slide=function(t,e,i){var n=this.getNextNote(t),o=this.getSlideStartDelay(i);return this.setFrequency(this.notes[t].frequency,e+o),this.rampFrequency(n.frequency,e+i),this},i.prototype.setFrequency=function(t,e){return this.osc.frequency.setValueAtTime(t,e),this},i.prototype.rampFrequency=function(t,e){return this.osc.frequency.linearRampToValueAtTime(t,e),this},i.prototype.play=function(t){return t="number"==typeof t?t:this.ac.currentTime,this.createOscillator(),this.osc.start(t),this.notes.forEach(function(e,i){t=this.scheduleNote(i,t)}.bind(this)),this.osc.stop(t),this.osc.onended=this.loop?this.play.bind(this,t):null,this},i.prototype.stop=function(){return this.osc&&(this.osc.onended=null,this.osc.disconnect(),this.osc=null),this},t.Note=e,t.Sequence=i}));var ac=new AudioContext,coinSound=new TinyMusic.Sequence(ac,120,["G5 s","C6 s"]);coinSound.staccato=.5,coinSound.gain.gain.value=.5,coinSound.waveType="triangle",coinSound.loop=!1;var startSound=new TinyMusic.Sequence(ac,125,["D3 s","G3 s","A3 s","D4 s","D#4 s","E4 s"]);startSound.staccato=.3,startSound.gain.gain.value=.1,startSound.loop=!1;var deadSound=new TinyMusic.Sequence(ac,120,["E2 q","C2 0.2","C2 0.2","C2 0.2","C2 0.2","C2 0.2"]);function toRadians(t){return t*(Math.PI/180)}deadSound.smoothing=.8,deadSound.gain.gain.value=.1,deadSound.loop=!1;var gameOver=!0,currentScore=0,hiScore=0;function restartGame(){currentScore=0;var t=document.getElementById("restart");document.getElementById("score").setAttribute("value","Score: 0\nHigh Score: "+hiScore),t.setAttribute("text",{color:"#339933"}),t.object3D.scale.set(1,1,1),t.object3D.rotation.y=180;for(var e=document.getElementById("swirl-center");e.firstChild;)e.removeChild(e.firstChild);gameOver=!1,document.getElementById("menu").object3D.rotation.y=180,startSound&&startSound.play()}function spawnSwirl(t,e,i,n,o,r){var a=document.getElementById("swirl-center"),s=document.createElement("a-entity");s.setAttribute("rotation",t+" "+e+" "+i),s.setAttribute("position","0 0 0");var c=document.createElement("a-entity");c.setAttribute("geometry",{primitive:"cylinder",openEnded:!0,thetaLength:0,height:.1,radius:1.5}),c.setAttribute("material",{side:"double",color:"red"}),c.setAttribute("swirl",""),a.appendChild(s),s.appendChild(c)}AFRAME.registerComponent("draw-canvas",{schema:{default:""},init:function(){this.canvas=document.getElementById(this.data),this.ctx=this.canvas.getContext("2d"),this.ctx.rect(0,0,16,16),this.ctx.fillStyle="#EFEFEF",this.ctx.fill();for(var t=0;t<16;t++)for(var e=0;e<16;e++)this.ctx.rect(16*t,16*e,16,16);this.ctx.strokeStyle="#000066",this.ctx.stroke()}}),AFRAME.registerComponent("spin",{schema:{rotX:{type:"number",default:0},rotY:{type:"number",default:360},rotZ:{type:"number",default:0}},tick:function(t,e){var i=this.data,n=this.el;gameOver||(n.object3D.rotation.x+=toRadians(i.rotX)*(e/1e3),n.object3D.rotation.y+=toRadians(i.rotY)*(e/1e3),n.object3D.rotation.z+=toRadians(i.rotZ)*(e/1e3))}}),AFRAME.registerComponent("coin-collect",{schema:{delay:{type:"number",default:.75},centerX:{type:"number",default:0},centerY:{type:"number",default:1.6},centerZ:{type:"number",default:0},radius:{type:"number",default:1.3}},init:function(){this.delayTimer=0,this.data;var t=this.el;t.inDelay=!1,t.addEventListener("mouseenter",(function(){gameOver||this.inDelay||(this.inDelay=!0,coinSound&&coinSound.play(),++currentScore>hiScore&&(hiScore=currentScore),document.getElementById("score").setAttribute("value","Score: "+currentScore+"\nHigh Score: "+hiScore),t.object3D.scale.set(.4,.4,1.2))}))},tick:function(t,e){var i=this.data,n=this.el;!gameOver&&n.inDelay&&(this.delayTimer+=e/1e3,this.delayTimer>i.delay&&(this.delayTimer=0,this.respawn(),n.inDelay=!1),n.object3D.rotation.y+=e/1e3*12)},respawn:function(){var t=this.data,e=this.el,i=(e.object3D.position,toRadians(180*Math.random())),n=toRadians(360*Math.random()),o=t.radius*Math.sin(i)*Math.cos(n),r=t.radius*Math.sin(i)*Math.sin(n),a=t.radius*Math.cos(i);e.object3D.position.x=t.centerX+o,e.object3D.position.y=t.centerY+r,e.object3D.position.z=t.centerZ+a,e.object3D.scale.set(1,1,1)}}),AFRAME.registerComponent("swirl",{schema:{rotSpeed:{type:"number",default:60},maxLength:{type:"number",default:60},maxAngleChange:{type:"number",default:90},delay:{type:"number",default:1.5}},init:function(){this.currentRot=0,this.phase01=!0,this.inDelay=!0,this.delayTimer=0,this.stopped=!1;var t=this.el,e=this.data,i=t.getAttribute("geometry");t.addEventListener("mouseenter",(function(){this.inDelay||gameOver||(t.setAttribute("material","color","blue"),deadSound&&!gameOver&&deadSound.play(),gameOver=!0,document.getElementById("restart").object3D.rotation.y=0,document.getElementById("menu").object3D.rotation.y=0,document.getElementById("score").setAttribute("value","Game Over!\nScore: "+currentScore+"\nHigh Score: "+hiScore))}));var n=document.createElement("a-entity");n.setAttribute("geometry",{primitive:"cylinder",openEnded:!0,thetaLength:4,height:.15,radius:1.49}),n.setAttribute("material",{side:"double",color:"green"}),t.parentNode.appendChild(n),this.startPoint=n;var o=document.createElement("a-entity");o.setAttribute("geometry",{primitive:"cylinder",openEnded:!0,thetaStart:i.thetaStart+e.maxLength,thetaLength:4,height:.15,radius:1.49}),o.setAttribute("material",{side:"double",color:"red"}),o.object3D.rotation.y+=toRadians(e.maxAngleChange),t.parentNode.appendChild(o),this.endPoint=o},tick:function(t,e){var i=this.data,n=this.el;if(gameOver)this.stopped||(n.setAttribute("material","color","blue"),this.stopped=!0);else if(this.inDelay)this.delayTimer+=e/1e3,this.delayTimer>i.delay&&(this.delayTimer=0,this.inDelay=!1);else{var o=n.getAttribute("geometry").thetaLength;if(this.phase01)if(o<i.maxLength){var r=i.rotSpeed*(e/1e3);n.setAttribute("geometry",{thetaLength:o+r})}else r=toRadians(i.rotSpeed)*(e/1e3),n.object3D.rotation.y+=r,this.currentRot+=r,this.currentRot>=toRadians(i.maxAngleChange)&&(this.phase01=!1);else if(o>1){r=i.rotSpeed*(e/1e3);var a=n.getAttribute("geometry");n.setAttribute("geometry",{thetaStart:a.thetaStart+r,thetaLength:a.thetaLength-r})}else n.parentNode.removeChild(this.startPoint),n.parentNode.removeChild(this.endPoint),n.parentNode.removeChild(n)}}}),AFRAME.registerComponent("swirl-spawner",{schema:{amount:{type:"number",default:5}},init:function(){this.spawnTimer=0},tick:function(t,e){if(!gameOver){var i=this.data;if(this.el,this.spawnTimer+=e/1e3,this.spawnTimer>2){this.spawnTimer=-3.5;for(var n=0;n<i.amount;n++)spawnSwirl(360*Math.random(),360*Math.random(),360*Math.random(),45,90,90)}}}}),AFRAME.registerComponent("restart-game",{schema:{delay:{type:"number",default:1}},init:function(){var t=this.el;t.inDelay=!1,t.delayTimer=0,t.addEventListener("mouseenter",(function(){gameOver&&!this.inDelay&&(this.inDelay=!0,t.object3D.scale.set(1.2,1.2,1.2),t.setAttribute("text",{color:"#FFFFFF"}))})),t.addEventListener("mouseleave",(function(){gameOver&&(this.inDelay=!1,t.delayTimer=0,t.object3D.scale.set(1,1,1),t.setAttribute("text",{color:"#339933"}))}))},tick:function(t,e){var i=this.data,n=this.el;gameOver&&n.inDelay&&(n.delayTimer+=e/1e3,n.delayTimer>i.delay&&(n.delayTimer=0,n.inDelay=!1,restartGame()))}})</script><a-scene><a-assets><canvas height=16 id=floor-canvas width=16></canvas></a-assets><a-entity position="0 1.6 0" id=swirl-center swirl-spawner="amount: 12"></a-entity><a-entity light="type: ambient; color: #FFFFFF"></a-entity><a-entity geometry="primitive: plane; width: 32; height: 32" material="src: #floor-canvas; repeat: 16 16" rotation="-90 45 0" draw-canvas=floor-canvas></a-entity><a-sky material=src:#floor-canvas radius=8></a-sky><a-entity geometry="primitive: cylinder; height: 0.02; radius: 0.12" material="color: gold" position="0 1.8 -1.1" id=coin coin-collect rotation="90 0 0" spin><a-entity geometry="primitive: box; width: 0.05; height: 0.15; depth: 0.03;" material="color: orange" rotation="90 0 0"></a-entity></a-entity><a-entity position="0 2 -0.95" id=menu text="value: Curvilinear; color: orange; width: 4; align: center"></a-entity><a-entity geometry="primitive: plane; width: 0.3; height: 0.2" material="color: #AAAAFF" position="0 1.4 -0.95" id=restart restart-game text="value: Start; color: #339933; width: 2; align: center"></a-entity><a-camera wasd-controls-enabled=false><a-entity geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03" material="color: #33cc33; shader: flat" position="0 0 -0.9" cursor></a-entity><a-text align=center color=#339933 id=score position="0 -0.45 -1" value="Score: 0\nHigh Score: 0" width=2></a-camera></a-scene>