<!doctype html><title>Exit</title><script src=/2020/webxr/aframe.js></script><script>AFRAME.registerComponent("game",{init:function(){(g_playfield=new Playfield).init()},tick:function(e,t){for(;t>0;){var r=40;r>t&&(r=t),t-=r,g_playfield.tick(e,r)}}});var ARROW_COLOR="#cc6633",ARROW_COLOR_ACTIVE="#ee9988",Block=function(e,t,r){var i=this,n=!1;void 0!==r&&(n=r);var a=1;void 0!==t&&(a=t);var o=null,l=null,s=null,u=null,c=[],b=[],d=0,p=!1,A=e;i.setSwitchDown=function(e){switch(A){case 7:"green"==e?o.setAttribute("position",new THREE.Vector3(0,-.56,0)):o.setAttribute("position",new THREE.Vector3(0,-.5,0));break;case 6:"red"==e?o.setAttribute("position",new THREE.Vector3(0,-.56,0)):o.setAttribute("position",new THREE.Vector3(0,-.5,0));break;case 10:"red"==e?(u.setAttribute("material","opacity: 1;transparent: false"),u.setAttribute("class","clickable"),u.setAttribute("shadow","receive: true; cast: true")):(u.setAttribute("material","opacity: 0.1;transparent: true"),u.setAttribute("class",""),u.setAttribute("shadow","receive: false; cast: false"));break;case 11:"green"==e?(u.setAttribute("material","opacity: 1;transparent: false"),u.setAttribute("class","clickable"),u.setAttribute("shadow","receive: true; cast: true")):(u.setAttribute("material","opacity: 0.1;transparent: true"),u.setAttribute("class",""),u.setAttribute("shadow","receive: false; cast: false"))}};i.setExitUsed=function(){12==A&&(p=!0)},i.getExitUsed=function(){return p},i.tick=function(e,t){if(12==A){var r=60,i=.03;if(p&&(r=14,i=.22),e-d>r){d=e;for(var n=!0,a=.3,o=0;o<c.length;o++)if(!1!==b[o]){var l=b[o]+i;!p||l<c.length?(l%=c.length,b[o]=l,c[o].setAttribute("scale",new THREE.Vector3(.5+l*a,.5+l*a,.5+l*a)),c[o].setAttribute("position",new THREE.Vector3(0,l*(a-.1)-.5,0)),n=!1):(b[o]=!1,c[o].setAttribute("visible",!1))}n&&(A=0)}}};var v=function(){!1===n&&(n=document.createElement("a-entity"));for(var e=0;e<4;e++){var t=document.createElement("a-torus");t.setAttribute("material","flatShading: true; color: orange"),t.setAttribute("rotation","90 0 0"),t.setAttribute("radius","0.25"),t.setAttribute("radius-tubular","0.03"),t.setAttribute("segments-radial","2"),t.setAttribute("scale",new THREE.Vector3(.5+.3*e,.5+.3*e,.5+.3*e)),t.setAttribute("position",new THREE.Vector3(0,.2*e-.5,0)),t.setAttribute("shadow","receive: false; cast: true"),n.append(t),c.push(t),b.push(e)}return n},f=function(e,t){!1===n&&(n=document.createElement("a-entity")),(o=document.createElement("a-cylinder")).setAttribute("color",e),o.setAttribute("height",.2),o.setAttribute("radius",.2),o.setAttribute("position","0, -0.5, 0"),o.setAttribute("segments-radial",16),o.setAttribute("shadow","receive: true; cast: true"),n.append(o);var r=document.createElement("a-cylinder");return r.setAttribute("color",t),r.setAttribute("height",.04),r.setAttribute("radius",.29),r.setAttribute("position","0, -0.5, 0"),r.setAttribute("segments-radial",16),r.setAttribute("shadow","receive: true; cast: true"),n.append(r),n},g=function(){return!1===n&&(n=document.createElement("a-entity")),(u=document.createElement("a-box")).setAttribute("color","#eeeeee"),u.setAttribute("scale","0.9 0.9 0.9"),u.setAttribute("shadow","receive: true; cast: true"),u.setAttribute("class","clickable"),n.append(u),n},m=function(e){return!1===n&&(n=document.createElement("a-entity")),(u=document.createElement("a-box")).setAttribute("color",e),u.setAttribute("material","transparent: true; opacity: 0.5"),u.setAttribute("scale","0.9 0.9 0.9"),u.setAttribute("shadow","receive: true; cast: true"),u.setAttribute("class","clickable"),n.append(u),n},h=function(){return!1===n&&(n=document.createElement("a-entity")),(u=document.createElement("a-box")).setAttribute("scale","0.3 0.05 0.3"),u.setAttribute("position","0 -0.5 0"),u.setAttribute("material","color: #555"),1!=a&&(u.setAttribute("transparent","true"),u.setAttribute("opacity",a)),n.append(u),(u=document.createElement("a-box")).setAttribute("scale","0.5 0.02 0.5"),u.setAttribute("position","0 -0.45 0"),u.setAttribute("material","color: yellow"),1!=a?(u.setAttribute("transparent","true"),u.setAttribute("opacity",a)):u.setAttribute("shadow","receive: true; cast: true"),n.append(u),n},E=function(e){return!1===n&&(n=document.createElement("a-entity")),(l=document.createElement("a-triangle")).setAttribute("shadow","receive: true"),l.setAttribute("color",ARROW_COLOR),l.setAttribute("position","0 -0.5 0.1"),l.setAttribute("vertex-a","0 0 0.2"),l.setAttribute("vertex-b","0.2 0 -0.2"),l.setAttribute("vertex-c","-0.2 0 -0.2"),1!=a&&(l.setAttribute("transparent","true"),l.setAttribute("opacity",a)),n.append(l),(s=document.createElement("a-plane")).setAttribute("shadow","receive: true"),s.setAttribute("color",ARROW_COLOR),s.setAttribute("scale","0.2 0.15 1"),s.setAttribute("position","0 -0.5 -0.175"),s.setAttribute("rotation","-90 0 0"),1!=a&&(s.setAttribute("transparent","true"),s.setAttribute("opacity",a)),n.append(s),n.setAttribute("rotation",{x:0,y:e,z:0}),n};i.actorEnterBlock=function(){switch(A){case 1:case 3:case 2:case 4:l.setAttribute("color",ARROW_COLOR_ACTIVE),s.setAttribute("color",ARROW_COLOR_ACTIVE);break;case 5:u.setAttribute("position",new THREE.Vector3(0,-.4,0))}},i.actorExitBlock=function(){switch(A){case 1:case 3:case 2:case 4:l.setAttribute("color",ARROW_COLOR),s.setAttribute("color",ARROW_COLOR);break;case 5:u.setAttribute("position",new THREE.Vector3(0,-.47,0))}},i.getEntity=function(){return n},i.setPosition=function(e,t,r){n.setAttribute("position",new THREE.Vector3(e,t,r)),n.setAttribute("isblock","yes")},i.setScale=function(e){n&&n.setAttribute("scale",new THREE.Vector3(e,e,e))},function(){switch(A){case 9:n=g();break;case 10:n=m("red");break;case 11:n=m("green");break;case 1:n=E(180);break;case 2:n=E(90);break;case 3:n=E(0);break;case 4:n=E(270);break;case 5:n=h();break;case 6:n=f("#f00","#e00");break;case 7:n=f("#0c0","#0b0");break;case 12:n=v()}}()},ACTOR_STATE_GONE=4,Actor=function(e){var t=this,r=e,i=null,n=null,a=null,o=null,l=!0,s=null,u=Math.PI/2,c=null,b=Math.PI/2,d=.002,p=new THREE.Vector3(0,0,0),A=new THREE.Vector3(0,1,0),v=new THREE.Vector3(1,0,0),f=null,g=null,m=1,h=0,E=1,x=!1,T=!1;t.removeEntity=function(){i.parentNode.removeChild(i)},t.createEntity=function(){return i=document.createElement("a-entity"),1==r&&((n=document.createElement("a-sphere")).setAttribute("scale","0.7 0.9 0.7"),n.setAttribute("radius","0.4"),n.setAttribute("position","0 -0.15 0"),n.setAttribute("material","color: green"),n.setAttribute("shadow","receive: true; cast: true"),i.append(n),(a=document.createElement("a-box")).setAttribute("position","0.4 0.12 -0.2"),a.setAttribute("scale","0.02 0.2 0.2"),a.setAttribute("material","color: white"),n.append(a),(o=document.createElement("a-box")).setAttribute("position","0.4 0.1.2 0.2"),o.setAttribute("scale","0.02 0.2 0.2"),o.setAttribute("material","color: white"),n.append(o),(s=document.createElement("a-sphere")).setAttribute("radius","0.16"),s.setAttribute("position","0 -0.5 -0.24"),s.setAttribute("material","color: red"),s.setAttribute("phi-length","180"),s.setAttribute("rotation","-90 0 0"),s.setAttribute("scale","1 0.4 0.6"),i.append(s),(c=document.createElement("a-sphere")).setAttribute("radius","0.16"),c.setAttribute("position","0 -0.5 0.24"),c.setAttribute("material","color: red"),c.setAttribute("phi-length","180"),c.setAttribute("rotation","-90 0 0"),c.setAttribute("scale","1 0.4 0.6"),i.append(c)),2==r&&((n=document.createElement("a-box")).setAttribute("scale","0.6 0.8 0.6"),n.setAttribute("position","0 -0.15 0"),n.setAttribute("material","color: black"),n.setAttribute("shadow","receive: true; cast: true"),i.append(n),(a=document.createElement("a-box")).setAttribute("position","0.4 0.2 0"),a.setAttribute("scale","0.4 0.25 0.6"),a.setAttribute("material","color: white"),n.append(a),(o=document.createElement("a-box")).setAttribute("position","0.0 0.4 0"),o.setAttribute("scale","0.3 0.3 0.3"),o.setAttribute("material","color: #554444"),n.append(o),g=document.createElement("a-entity"),i.append(g),(f=document.createElement("a-cone")).setAttribute("material","shader: flat; color: red"),f.setAttribute("transparent","true"),f.setAttribute("opacity","0.5"),f.setAttribute("rotation","50 -90 0"),f.setAttribute("scale","0.26 1.4 0.26"),f.setAttribute("position","0.5 -0.16 0"),f.setAttribute("segments-radial","6"),g.append(f)),i},t.setPosition=function(e,t,r){p.x=e,p.y=t,p.z=r,i.setAttribute("position",new THREE.Vector3(e,t,r))},t.setDirection=function(e,t,r){var n=0;-1==r?n=90:1==r?n=270:-1==e?n=180:1==e&&(n=0),i.setAttribute("rotation",{x:0,y:n,z:0}),v.x=e,v.z=r};var y=function(e,i){l=!1,v.y-=.0086*i;var n=p.x+v.x*i*d,a=p.y+v.y*i*d,o=p.z+v.z*i*d,s=Math.floor(n+.5),u=Math.floor(a),c=Math.floor(o+.5);v.y<0&&9==g_playfield.getBlockType(s,u,c)&&(l=!0,a=++u,v.y=0);var b=g_playfield.getBlockType(s,u,c);l||v.y<0&&(b=0);var f=!1;if(v.x<0&&s-n>=0&&(A.x!=s&&(f=!0),5!=b&&9==g_playfield.getBlockType(s-1,u,c)&&t.setDirection(1,0,0),2==r&&(s-1<0||5!=b&&0==v.y&&0==g_playfield.getBlockType(s-1,u-1,c))&&t.setDirection(1,0,0)),v.x>0&&s-n<=0&&(A.x!=s&&(f=!0),5!=b&&9==g_playfield.getBlockType(Math.floor(s+1),Math.floor(u),Math.floor(c))&&t.setDirection(-1,0,0),2==r&&(s+1>=gridWidth||5!=b&&0==v.y&&0==g_playfield.getBlockType(s+1,u-1,c))&&t.setDirection(-1,0,0)),v.z<0&&c-o>=0&&(A.z!=c&&(f=!0),5!=b&&9==g_playfield.getBlockType(Math.floor(s),Math.floor(u),Math.floor(c-1))&&t.setDirection(0,0,1),2==r&&(c-1<0||5!=b&&0==v.y&&0==g_playfield.getBlockType(s,u-1,c-1))&&t.setDirection(0,0,1)),v.z>0&&c-o<=0&&(A.z!=c&&(f=!0),5!=b&&9==g_playfield.getBlockType(Math.floor(s),Math.floor(u),Math.floor(c+1))&&t.setDirection(0,0,-1),2==r&&(c+1>=gridDepth||5!=b&&0==v.y&&0==g_playfield.getBlockType(s,u-1,c+1))&&t.setDirection(0,0,-1)),l&&f)switch(g_playfield.actorExitBlock(A.x,A.y,A.z),A.x=s,A.y=u,A.z=c,g_playfield.actorEnterBlock(A.x,A.y,A.z),g_playfield.getBlockType(s,u,c)){case 2:t.setDirection(1,0,0),o=c;break;case 4:t.setDirection(-1,0,0),o=c;break;case 1:t.setDirection(0,0,-1),n=s;break;case 3:t.setDirection(0,0,1),n=s;break;case 5:g_sound.playSound(SOUND_JUMP),v.y=3.4;break;case 6:"red"!=g_playfield.getSwitchDown()&&g_sound.playSound(SOUND_RED),g_playfield.setSwitchDown("red");break;case 7:"green"!=g_playfield.getSwitchDown()&&g_sound.playSound(SOUND_GREEN),g_playfield.setSwitchDown("green");break;case 12:1==r&&(g_playfield.getExitUsed(s,u,c)||(g_sound.playSound(SOUND_EXIT),function(e){E=2,T=e}(e),g_playfield.setExitUsed(s,u,c)))}if(t.setPosition(n,a,o),a<0&&!x&&(x=!0,g_sound.playSound(SOUND_FALL)),a<-20&&(1==r&&g_playfield.restartLevel(),2==r&&a<-40&&(E=ACTOR_STATE_GONE)),1==r&&z(e,i),2==r){_(e,i),g_playfield.gridHasFriend(s,u,c)&&(g_sound.playSound(SOUND_DIE),g_playfield.restartLevel());var g=g_playfield.gridHasFriend(s+v.x,u,c+v.z);if(!1!==g){var m=!1,h=g.getPosition();v.x>0&&(m=h.x-p.x<.8),v.x<0&&(m=p.x-h<.8),m&&(g_sound.playSound(SOUND_DIE),g_playfield.restartLevel())}}},z=function(e,t){var r=0,i=-.48;b+=t/60;var a=.12*Math.cos(-b);(o=.06*Math.sin(-b)-.44)<i&&(r=i-o,o=i),c.setAttribute("position",{x:a,y:o,z:.22}),u=b+Math.PI;var o;a=.12*Math.cos(-u);(o=.06*Math.sin(-u)-.44)<i&&(r=i-o,o=i),s.setAttribute("position",{x:a,y:o,z:-.22}),n.setAttribute("position",new THREE.Vector3(0,-.15+r,0))},_=function(e,t){(h+=m*t/40)>14&&(m=-1,o.setAttribute("color","#ff1111")),h<-14&&(m=1,o.setAttribute("color","#ff1111")),h>-4&&h<4&&o.setAttribute("color","#554444"),g.setAttribute("rotation",new THREE.Vector3(0,h,0))};t.tick=function(e,t){switch(E){case 1:y(e,t);break;case 2:!function(e){var t=1-(e-T)/300;t<.01&&(t=.01,E=3,g_playfield.actorExited()),i.setAttribute("scale",new THREE.Vector3(t,t,t))}(e)}},t.getType=function(){return r},t.getState=function(){return E},t.getX=function(){return A.x},t.getY=function(){return A.y},t.getZ=function(){return A.z},t.getPosition=function(){return p}},g_playfield=null,g_sound=null,gridWidth=0,gridDepth=0,gridHeight=0,TOOL_COUNT=5,Playfield=function(){var e=this,t=0,r=[],i=[],n=[],a=null,o=null,l=null,s=null,u=!1,c=null,b=null,d=null,p=null,A=-1,v=m,f=!1,g=!1,m=1;e.init=function(){g_sound=new Sound,d=new Cursor,c=new Palette(d),c.getEntity(),new Restart,new Home,b=new LevelSelect,a=document.getElementById("playfield"),o=document.getElementById("controls"),document.getElementById("laser"),s=document.getElementById("holder"),l=document.querySelector("a-scene"),p=document.getElementById("camera-rotation"),l.addEventListener("enter-vr",(function(e){})),l.addEventListener("exit-vr",(function(e){})),e.startLevel(t)};var h=function(e,t,n){gridWidth=e,gridHeight=t,gridDepth=n,r=[];for(var a=0;a<n;a++){r[a]=[],i[a]=[];for(var o=0;o<t;o++){r[a][o]=[],i[a][o]=[];for(var l=0;l<e;l++)r[a][o][l]=0,i[a][o][l]=null}}};e.startLevel=function(e){if(!(e>levels.length)){a.setAttribute("visible",!0),o.setAttribute("visible",!0),v=m,f=!1;var t=levels[e],r=0;h(t[r++],t[r++],t[r++]);for(var i=t[r++],n=t[r++],l=0;l<i;l++)_(t[r++],t[r++],t[r++],t[r++],t[r++],t[r++]);for(l=0;l<n;l++)w(t[r++],t[r++],t[r++],t[r++],t[r++],t[r++]);var s=!1;c.selectTool(0);for(l=0;l<TOOL_COUNT;l++){if(c.setToolCount(l+1,t[r]),!s&&t[r]>0){c.selectTool(l+1),s=!0}r++}for(l=r;l<t.length;l+=4)z(t[l],t[l+1],t[l+2],t[l+3]);g_playfield.setSwitchDown("green"),a.setAttribute("position",new THREE.Vector3(-gridWidth/2,0,-gridDepth))}},e.endLevel=function(){},e.nextLevel=function(){++t>=levels.length&&(t=0),this.startLevel(t)};var E=function(){for(var l=0;l<gridDepth;l++)for(var s=0;s<gridHeight;s++)for(var u=0;u<gridWidth;u++)if(null!=i[l][s][u]){var c=i[l][s][u].getEntity();c.parentNode.removeChild(c),i[l][s][u]=null}for(var d=0;d<n.length;d++)n[d].removeEntity();gridDepth=0,gridWidth=0,gridHeight=0,r=[],i=[],n=[],5==v&&t--,6==v?(v=7,a.setAttribute("visible",!1),o.setAttribute("visible",!1),b.show()):(v=4,setTimeout((function(){e.nextLevel()}),400))};e.restartLevel=function(){v=5,g=!1},e.gotoLevelSelect=function(){v=6,g=!1},e.getExitUsed=function(t,r,n){if(12==e.getBlockType(t,r,n))return i[n][r][t].getExitUsed()},e.setExitUsed=function(t,r,n){12==e.getBlockType(t,r,n)&&i[n][r][t].setExitUsed()},e.actorExited=function(){for(var e=0,r=0;r<n.length;r++)1==n[r].getType()&&3!==n[r].getState()&&e++;0==e&&(b.setLevelAvailable(t+1,!0),v=3,g=!1)},e.getBlockType=function(e,t,n){if(e>=0&&e<gridWidth&&t>=0&&t<gridHeight&&n>=0&&n<gridDepth){var a=r[n][t][e];return 10==a&&"red"==u&&(a=9),11==a&&"green"==u&&(a=9),12==a&&i[n][t][e].getExitUsed()&&(a=0),a}return 0};var x=function(t){var r=t.target;null==r.getAttribute("isblock")&&(r=r.parentNode);var i=r.getAttribute("position"),n=parseInt(i.x,10),a=parseInt(i.y,10),o=parseInt(i.z,10);n<0||n>=gridWidth||a<0||a>=gridHeight-1||o<0||o>=gridDepth?d.setVisible(!1):(9==e.getBlockType(n,a,o)&&a++,e.getBlockType(n,a,o)>5||(d.setPosition(n,a,o),g_playfield.getIsMobile()||d.setVisible(!0)))},T=function(e){d.setVisible(!1)},y=function(t){g_sound.init();var r=t.target;null==r.getAttribute("isblock")&&(r=r.parentNode);var n=r.getAttribute("position"),a=parseInt(n.x,10),o=parseInt(n.y,10),l=parseInt(n.z,10);if(!(a<0||a>=gridWidth||o<0||o>=gridHeight-1||l<0||l>=gridDepth)){9==e.getBlockType(a,o,l)&&o++;var s=c.getCurrentToolIndex(),u=e.getBlockType(a,o,l);if(!(u>5||u==s)){var b=c.getToolCount(s);if(!(b<=0)&&!1!==s){if(null!==i[l][o][a]){var d=i[l][o][a].getEntity();d.parentNode.removeChild(d),i[l][o][a]=null;var p=c.getToolCount(u);p++,0!==u&&c.setToolCount(u,p)}if(z(a,o,l,s),c.setToolCount(s,b-1),0==s?g_sound.playSound(SOUND_REMOVE):g_sound.playSound(SOUND_PLACE),0==s||0==c.getToolCount(s))if(0!=u)c.selectTool(u);else{c.selectTool(0);for(var A=0;A<TOOL_COUNT;A++)if(c.getToolCount(A+1)>0){c.selectTool(A+1);break}}}}}},z=function(e,t,n,o){r[n][t][e]=o;var l=!1;0!==o&&(l=document.createElement("a-entity"),a.append(l));var s=new Block(o,1,l);!1!==l&&(i[n][t][e]=s,s.setPosition(e,t,n),l.setAttribute("class","clickable"),l.addEventListener("mouseenter",x),l.addEventListener("mouseleave",T),l.addEventListener("click",y))},_=function(e,t,r,i,o,l){var s=new Actor(1),u=s.createEntity();s.setPosition(e,t,r),s.setDirection(i,o,l),a.append(u),n.push(s)},w=function(e,t,r,i,o,l){var s=new Actor(2),u=s.createEntity();s.setPosition(e,t,r),s.setDirection(i,o,l),a.append(u),n.push(s)};e.tick=function(e,t){switch(e,l.is("vr-mode")?!1!==A&&-1!=A||(p.setAttribute("rotation",new THREE.Vector3(0,0,0)),l.removeAttribute("cursor"),l.removeAttribute("raycaster"),s.setAttribute("rotation",new THREE.Vector3(0,180,0)),s.setAttribute("position",new THREE.Vector3(0,-1.5,2)),A=!0):!0!==A&&-1!==A||(l.isMobile?(p.setAttribute("rotation",new THREE.Vector3(0,0,0)),s.setAttribute("position",new THREE.Vector3(0,-1,-1.5))):(p.setAttribute("rotation",new THREE.Vector3(-45,0,0)),s.setAttribute("position",new THREE.Vector3(0,-1,-2))),l.setAttribute("cursor","rayOrigin: mouse"),l.setAttribute("raycaster","objects: .clickable"),s.setAttribute("rotation",new THREE.Vector3(0,0,0)),A=!1),v){case m:!function(e,t){!1===f&&(f=e);var r=(e-f)/500;r>1&&(r=1,v=2);for(var n=0;n<gridDepth;n++)for(var a=0;a<gridHeight;a++)for(var o=0;o<gridWidth;o++)null!=i[n][a][o]&&i[n][a][o].setScale(r)}(e);break;case 2:!function(e,t){for(var r=0;r<n.length;r++)n[r].tick(e,t);for(var a=0;a<gridDepth;a++)for(var o=0;o<gridHeight;o++)for(var l=0;l<gridWidth;l++)null!=i[a][o][l]&&i[a][o][l].tick(e,t)}(e,t);break;case 3:case 5:case 6:!function(e,t){!1===g&&(g=e);var r=1-(e-g)/500;if(r<.01)return r=.01,void E();for(var n=0;n<gridDepth;n++)for(var a=0;a<gridHeight;a++)for(var o=0;o<gridWidth;o++)null!=i[n][a][o]&&i[n][a][o].setScale(r)}(e);break;case 7:b.tick(e,t)}},e.actorEnterBlock=function(e,t,r){e>=0&&e<gridWidth&&t>=0&&t<gridHeight&&r>=0&&r<gridDepth&&null!=i[r][t][e]&&i[r][t][e].actorEnterBlock()},e.actorExitBlock=function(e,t,r){e>=0&&e<gridWidth&&t>=0&&t<gridHeight&&r>=0&&r<gridDepth&&null!=i[r][t][e]&&i[r][t][e].actorExitBlock()},e.setSwitchDown=function(e){u=e;for(var t=0;t<gridDepth;t++)for(var r=0;r<gridHeight;r++)for(var n=0;n<gridWidth;n++)null!=i[t][r][n]&&i[t][r][n].setSwitchDown(e)},e.getSwitchDown=function(){return u},e.gridHasFriend=function(e,t,r){for(var i=0;i<n.length;i++)if(1==n[i].getType()&&n[i].getX()==e&&n[i].getY()==t&&n[i].getZ()==r&&1==n[i].getState())return n[i];return!1},e.getIsMobile=function(){return l.isMobile&&!0!==A}},Palette=function(e){var t=this,r="#999999",i=null,n=null,a=!1,o=[],l=[],s=[];t.setToolCount=function(e,t){e>0&&e<s.length&&(t<=0?(t=0,c(e,"#555555")):c(e,r),s[e].setAttribute("value",t),l[e]=parseInt(t,10))},t.getToolCount=function(e){return e>0?l[e]:1};var u=function(e){n.setAttribute("value",function(e){switch(e){case 0:return"Remove";case 1:return"North";case 2:return"East";case 3:return"South";case 4:return"West";case 5:return"Jump"}return""}(e))};t.selectTool=function(i){0!==(i=parseInt(i,10))&&0==t.getToolCount(i)||i!==a&&(!1!==a&&(t.getToolCount(a)>0||0==a)&&c(a,r),c(a=i,"#dddddd"),u(i),e.setType(i))};var c=function(e,t){o[e].children[0].setAttribute("color",t)};!function(){i=document.getElementById("palette"),(n=document.createElement("a-text")).setAttribute("value","Selected Tool"),n.setAttribute("scale","4 4 4"),n.setAttribute("rotation","-90 0 0"),n.setAttribute("color","#eeeeee"),n.setAttribute("position","-0.5 0.1 -1"),i.append(n);for(var e=0;e<6;e++){var b=document.createElement("a-entity");b.setAttribute("position",new THREE.Vector3(e,0,0)),b.setAttribute("tool-index",e),o.push(b);var d=document.createElement("a-box");d.setAttribute("scale","0.9 0.1 0.9"),d.setAttribute("color","#9a9a9a"),d.setAttribute("class","clickable"),b.append(d);var p=document.createElement("a-text");if(p.setAttribute("color","#cccccc"),p.setAttribute("align","center"),p.setAttribute("rotation","-90 0 0"),p.setAttribute("position","-0 0 0.64"),p.setAttribute("width","5"),0==e?p.setAttribute("value",""):p.setAttribute("value","0"),p.setAttribute("scale","1.6 1.6 1.6"),b.append(p),s.push(p),l.push(0),0!=e){var A=document.createElement("a-entity");A.setAttribute("position",new THREE.Vector3(0,.6,0)),A.setAttribute("tool-index",e),b.append(A);new Block(e,1,A)}i.append(b),b.addEventListener("mouseenter",(function(e){var t=parseInt(e.target.parentNode.getAttribute("tool-index"),10);t!==a&&((0==t||l[t]>0)&&c(t,"#bbbbbb"),u(t))})),b.addEventListener("mouseleave",(function(e){var t=parseInt(e.target.parentNode.getAttribute("tool-index"),10);t!==a&&((0==t||l[t]>0)&&c(t,r),u(a))})),b.addEventListener("click",(function(e){g_sound.init(),g_sound.playSound(SOUND_CLICK);var r=parseInt(e.target.parentNode.getAttribute("tool-index"),10);(0==r||l[r]>0)&&t.selectTool(r)}))}}(),t.getEntity=function(){return i},t.getCurrentToolIndex=function(){return a}},Restart=function(){var e=document.getElementById("restart"),t=document.createElement("a-box");t.setAttribute("scale","0.9 0.1 0.9"),t.setAttribute("color","#9a9a9a"),t.setAttribute("class","clickable"),e.append(t);var r=document.createElement("a-torus");r.setAttribute("material","flatShading: true; color: red"),r.setAttribute("rotation","90 0 0"),r.setAttribute("radius","0.25"),r.setAttribute("radius-tubular","0.03"),r.setAttribute("position","0 0.1 0"),r.setAttribute("segments-radial","2"),r.setAttribute("arc","270"),e.append(r);var i=document.createElement("a-triangle");i.setAttribute("shadow","receive: true"),i.setAttribute("color","red"),i.setAttribute("material","flatShading: true; color: red"),i.setAttribute("rotation","-90 -90 0"),i.setAttribute("position","0.1 0.1 -0.24"),i.setAttribute("scale","0.3 0.3 0.3"),e.append(i);var n=document.createElement("a-text");n.setAttribute("value","Restart"),n.setAttribute("scale","4 4 4"),n.setAttribute("rotation","-90 0 0"),n.setAttribute("color","#eeeeee"),n.setAttribute("visible","false"),n.setAttribute("position","-2.5 0.1 -1"),e.append(n),t.addEventListener("mouseenter",(function(e){t.setAttribute("color","#bbbbbb"),n.setAttribute("visible","true")})),t.addEventListener("mouseleave",(function(e){t.setAttribute("color","#9a9a9a"),n.setAttribute("visible","false")})),t.addEventListener("click",(function(e){g_sound.init(),g_sound.playSound(SOUND_CLICK),g_playfield.restartLevel()})),this.setPosition=function(t,r,i){e.setAttribute("position",new THREE.Vector3(t,r,i))}},Home=function(){var e=document.getElementById("home"),t=document.createElement("a-box");t.setAttribute("scale","0.9 0.1 0.9"),t.setAttribute("color","#9a9a9a"),t.setAttribute("class","clickable"),e.append(t);var r=document.createElement("a-plane");r.setAttribute("material","flatShading: true; color: red"),r.setAttribute("rotation","-90 0 0"),r.setAttribute("scale","0.16 0.4 0.4"),r.setAttribute("position","0.13 0.1 0.14"),e.append(r),(r=document.createElement("a-plane")).setAttribute("material","flatShading: true; color: red"),r.setAttribute("rotation","-90 0 0"),r.setAttribute("scale","0.16 0.4 0.4"),r.setAttribute("position","-0.13 0.1 0.14"),e.append(r),(r=document.createElement("a-plane")).setAttribute("material","flatShading: true; color: red"),r.setAttribute("rotation","-90 0 0"),r.setAttribute("scale","0.4 0.2 0.4"),r.setAttribute("position","-0.0 0.1 0.05"),e.append(r),(r=document.createElement("a-plane")).setAttribute("material","flatShading: true; color: red"),r.setAttribute("rotation","-90 0 0"),r.setAttribute("scale","0.1 0.4 0.4"),r.setAttribute("position","0.15 0.1 -0.08"),e.append(r);var i=document.createElement("a-triangle");i.setAttribute("shadow","receive: true"),i.setAttribute("color","red"),i.setAttribute("material","flatShading: true; color: red"),i.setAttribute("rotation","-90 0 0"),i.setAttribute("position","0 0.1 -0.16"),i.setAttribute("scale","0.6 0.24 0.5"),e.append(i);var n=document.createElement("a-text");n.setAttribute("value","Home"),n.setAttribute("scale","4 4 4"),n.setAttribute("rotation","-90 0 0"),n.setAttribute("color","#eeeeee"),n.setAttribute("visible","false"),n.setAttribute("position","-1 0.1 -1"),e.append(n),t.addEventListener("mouseenter",(function(e){t.setAttribute("color","#bbbbbb"),n.setAttribute("visible","true")})),t.addEventListener("mouseleave",(function(e){t.setAttribute("color","#9a9a9a"),n.setAttribute("visible","false")})),t.addEventListener("click",(function(e){g_sound.init(),g_sound.playSound(SOUND_CLICK),g_playfield.gotoLevelSelect()})),this.setPosition=function(e,t,r){restartEntity.setAttribute("position",new THREE.Vector3(e,t,r))}},Cursor=function(){var e=document.getElementById("block-cursor"),t=[];(i=document.createElement("a-plane")).setAttribute("rotation","-90 0 0"),i.setAttribute("position","0 -0.52 0"),i.setAttribute("scale","0.9 0.9 0.9"),i.setAttribute("color","#444444"),i.setAttribute("visible",!1),e.append(i),t.push(i);for(var r=0;r<TOOL_COUNT;r++){var i;(i=document.createElement("a-entity")).setAttribute("visible",!1),e.append(i),new Block(r+1,.4,i),t.push(i)}var n=!1,a=!1;this.setType=function(e){if(e!==n){if(n=e,!g_playfield.getIsMobile())for(var r=0;r<TOOL_COUNT+1;r++)t[r].setAttribute("visible",r==n);null}},this.setPosition=function(t,r,i){e.setAttribute("position",new THREE.Vector3(t,r,i))},this.setVisible=function(t){t!=a&&(t?e.setAttribute("visible","true"):e.setAttribute("visible","false"),a=t)}},levels=[];function levelCreatePlayfield(e){for(var t=e[0],r=e[2],i=0;i<r;i++)for(var n=0;n<t;n++)e.push(n),e.push(0),e.push(i),e.push(9)}levelCreatePlayfield(level=[13,20,13,1,0,5,1,11,1,0,0,1,1,1,1,1,3,1,11,2,9,1,11,4,6,1,6,12]),levels.push(level),level=[13,20,13,1,0,5,1,11,1,0,0,1,0,0,0,1,1,1,11,2,3,1,11,5,11,1,11,4,9,1,11,5,6,1,3,12];for(var x=0;x<13;x++)for(var z=0;z<13;z++)(z>=10||x>4&&x<8&&7!=z)&&level.push(x,0,z,9);levels.push(level),levelCreatePlayfield(level=[13,20,13,1,3,5,1,11,1,0,0,1,1,5,1,0,0,11,1,7,-1,0,0,1,1,9,1,0,0,1,0,0,0,0,3,1,11,2,9,1,11,4,6,1,3,12]),levels.push(level);var level=[13,20,13,2,1,6,1,10,1,0,0,6,1,11,-1,0,0,1,1,7,1,0,0,1,0,0,0,0,0,1,11,9,12,1,11,9,0,1,10,9,12,1,10,9,2,1,3,12,10,1,3,12];for(x=0;x<13;x++)for(z=0;z<13;z++)(z>=10||x<5||x>7||7==z)&&level.push(x,0,z,9);levels.push(level);var level=[13,20,13,2,2,6,1,10,1,0,0,6,1,2,-1,0,0,2,1,6,0,0,1,10,1,6,0,0,-1,0,0,0,0,0,2,1,2,3,10,1,2,4,10,1,10,1,2,1,10,2,6,1,5,12,6,1,7,12];for(x=0;x<13;x++)for(z=0;z<13;z++)(2==z||10==z||2==x||10==x||5==z&&x>2&&x<7||7==z&&x>5&&x<10)&&level.push(x,0,z,9);levels.push(level);for(level=[13,20,13,2,0,6,1,11,-1,0,0,6,1,1,1,0,0,1,1,1,1,1,11,1,11,9,1,1,11,9,3,1,11,6,9,1,11,7,11,1,1,9,1,1,1,9,5,1,6,12,7,1,6,12],x=0;x<13;x++)for(z=0;z<13;z++)(z<4||z>9)&&level.push(x,0,z,9);for(z=4;z<10;z++)level.push(5,0,z,10),level.push(7,0,z,11);levels.push(level);for(level=[13,20,13,2,0,1,4,10,1,0,0,10,4,3,-1,0,0,1,1,1,1,2,9,1,10,6,0,4,10,2,2,4,10,4,0,4,3,11,12,4,3,11,3,1,3,7,9,1,3,7,0,1,3,9,12,1,3,9,10,3,7,12,6,1,7,12],x=0;x<3;x++)for(z=9;z<12;z++)level.push(x,3,z,9);for(x=0;x<13;x++)level.push(x,3,3,11);for(x=5;x<8;x++)for(z=4;z<5;z++)level.push(x,0,z,11);for(x=5;x<8;x++)for(z=6;z<9;z++)level.push(x,0,z,11);for(x=0;x<13;x++)level.push(x,0,3,9);for(x=4;x<7;x++)for(z=9;z<12;z++)level.push(x,1,z,9);for(x=4;x<12;x++)for(z=6;z<9;z++)level.push(x,2,z,10);for(x=7;x<12;x++)for(z=9;z<12;z++)level.push(x,0,z,9);levels.push(level);for(level=[13,20,13,4,8,6,2,8,-1,0,0,6,2,4,1,0,0,8,2,6,0,0,1,4,2,6,0,0,-1,4,1,10,1,0,0,8,1,10,1,0,0,4,1,2,-1,0,0,8,1,2,-1,0,0,10,1,4,0,0,-1,10,1,8,0,0,-1,2,1,4,0,0,1,2,1,8,0,0,1,0,0,0,0,0,4,2,8,1,8,2,8,4,4,2,4,2,8,2,4,3,10,1,2,4,7,1,2,5,2,1,2,3,2,1,5,5,2,1,10,2,5,1,10,5,10,1,10,1,10,1,7,5,1,1,11,12,11,1,1,12,1,1,1,12,11,1,11,12],x=0;x<13;x++)for(z=0;z<13;z++)level.push(x,0,z,9);for(x=3;x<10;x++)for(z=3;z<10;z++)level.push(x,1,z,9);levels.push(level),levelCreatePlayfield(level=[13,20,13,1,2,7,1,6,1,0,0,4,3,10,1,0,0,10,3,4,-1,0,0,1,0,0,0,1,1,1,7,6,10,3,10,1,10,3,4,4,4,3,4,3,4,3,10,2,7,1,12,12]);for(var y=1;y<3;y++)for(x=4;x<11;x++)for(z=4;z<11;z++)4!=x&&10!=x&&4!=z&&10!=z||(1==y?level.push(x,y,z,11):level.push(x,y,z,9));levels.push(level);for(level=[13,20,13,1,1,9,1,11,1,0,0,3,1,11,-1,0,0,5,5,5,5,5,8,1,11,9,12,1,11,9,10,1,10,11,10,1,12,9,0,1,11,9,4,1,11,9,2,1,10,6,2,1,8,7,2,1,12,9,10,1,0,12],x=0;x<13;x++)for(z=0;z<13;z++)x<5&&level.push(x,0,z,9),x>7&&(z<10&&z>6||0==z?level.push(x,0,z,10):z>2&&z<5?level.push(x,0,z,11):level.push(x,0,z,9));levels.push(level);for(level=[13,20,13,1,5,3,3,12,1,0,0,0,3,10,1,0,0,0,3,7,1,0,0,0,3,4,1,0,0,12,3,9,-1,0,0,12,3,5,-1,0,0,9,9,9,9,0,8,2,11,9,0,3,12,2,3,3,12,4,6,1,11,12],x=0;x<13;x++)for(z=0;z<13;z++)z<3?level.push(x,2,z,9):(x<4&&level.push(x,2,z,9),x>8&&level.push(x,2,z,9)),z>9&&x>4&&x<8&&level.push(x,0,z,9);levels.push(level);for(level=[13,20,13,1,0,0,4,12,0,0,-1,9,9,9,9,9,11,1,11,12,0,4,0,3,0,4,12,1],z=0;z<13;z++){if(level.push(0,3,z,9),10==z||11==z)for(x=1;x<5;x++)level.push(x,3,z,9);if(2==z||1==z)for(x=1;x<7;x++)level.push(x,3,z,9)}for(z=1;z<6;z++)level.push(3,0,z,9),level.push(2,0,z,9);for(z=0;z<6;z++)level.push(12,0,z,9),level.push(11,0,z,9);for(z=0;z<6;z++)level.push(8,0,z,9),level.push(9,0,z,9);for(x=5;x<8;x++)level.push(x,1,5,9),level.push(x,1,4,9);for(z=10;z<13;z++)for(x=10;x<13;x++)level.push(x,0,z,9);for(z=7;z<10;z++)for(x=5;x<6;x++)level.push(x,0,z,9);for(x=5;x<9;x++)level.push(x,0,10,9);for(x=0;x<3;x++)for(z=8;z<12;z++)level.push(x,0,z,9);for(x=0;x<5;x++)level.push(x,0,0,9);levels.push(level);var SOUND_CLICK=1,SOUND_EXIT=2,SOUND_DIE=3,SOUND_JUMP=4,SOUND_FALL=5,SOUND_GREEN=6,SOUND_RED=7,SOUND_REMOVE=8,SOUND_PLACE=9,SOUND_LEVEL_END=10,Sound=function(){var e=null;this.init=function(){null==e&&(e=new AudioContext)};var t=function(e){return 440*Math.pow(2,(e-69)/12)};this.playSound=function(r){if(null!=e){var i=e.currentTime,n=1/16,a=n,o=e.createGain(),l=null;switch((l=e.createOscillator()).type="square",l.connect(o),o.connect(e.destination),r){case SOUND_REMOVE:n=1/32,l.type="triangle",l.frequency.setValueAtTime(t(69),i),o.gain.setValueAtTime(0,i),o.gain.linearRampToValueAtTime(.3,e.currentTime+1/16),o.gain.linearRampToValueAtTime(0,e.currentTime+3*n),a=3*n;break;case SOUND_PLACE:case SOUND_CLICK:n=1/32,l.type="triangle",l.frequency.setValueAtTime(t(69),i),o.gain.setValueAtTime(0,i),o.gain.linearRampToValueAtTime(.3,e.currentTime+1/128),o.gain.linearRampToValueAtTime(0,e.currentTime+3*n),a=3*n;break;case SOUND_FALL:n=1/4,l.type="triangle",l.frequency.setValueAtTime(t(62),i),l.frequency.linearRampToValueAtTime(t(55),i+4*n),o.gain.setValueAtTime(0,i),o.gain.linearRampToValueAtTime(.3,e.currentTime+1/128),o.gain.linearRampToValueAtTime(0,e.currentTime+3*n),a=4*n;break;case SOUND_DIE:n=1/12,l.type="sawtooth",l.frequency.setValueAtTime(t(56),i),l.frequency.linearRampToValueAtTime(t(49),i+n),o.gain.setValueAtTime(0,i),o.gain.linearRampToValueAtTime(.2,e.currentTime+n),o.gain.linearRampToValueAtTime(0,e.currentTime+2*n),a=2*n;break;case SOUND_JUMP:n=1/12,l.type="triangle",l.frequency.setValueAtTime(t(55),i),l.frequency.setValueAtTime(t(62),i+n),o.gain.setValueAtTime(0,i),o.gain.linearRampToValueAtTime(.2,e.currentTime+1/64),o.gain.linearRampToValueAtTime(0,e.currentTime+2*n),a=2*n;break;case SOUND_GREEN:n=1/4,l.type="triangle",l.frequency.setValueAtTime(t(43),i),o.gain.setValueAtTime(0,i),o.gain.linearRampToValueAtTime(.2,e.currentTime+1/32),o.gain.linearRampToValueAtTime(0,e.currentTime+n),a=n;break;case SOUND_RED:n=1/4,l.type="triangle",l.frequency.setValueAtTime(t(47),i),o.gain.setValueAtTime(0,i),o.gain.linearRampToValueAtTime(.2,e.currentTime+1/32),o.gain.linearRampToValueAtTime(0,e.currentTime+n),a=n;break;case SOUND_EXIT:n=1/12,l.type="triangle",l.frequency.setValueAtTime(t(55),i),l.frequency.setValueAtTime(t(62),i+n),l.frequency.setValueAtTime(t(67),i+2*n),o.gain.setValueAtTime(0,i),o.gain.linearRampToValueAtTime(.3,e.currentTime+1/64),o.gain.linearRampToValueAtTime(0,e.currentTime+6*n),a=6*n}l.start(e.currentTime),l.stop(e.currentTime+a)}}},LevelSelect=function(e){var t=this,r=null,i="#999999",n="#333333",a=0,o=0,l=!1,s=[],u=[],c=[],b=0,d=0,p=function(e,t){s[e].children[0].setAttribute("color",t),t==n?u[e].setAttribute("color","#999999"):u[e].setAttribute("color","#eeeeee")};t.tick=function(e,t){switch(b){case 1:(d+=t/500)>1&&(d=1,b=3),A(d);break;case 2:if((d-=t/500)<.01)return d=.01,r.setAttribute("visible",!1),r.setAttribute("position",new THREE.Vector3(-2*a/2,-10.5,0)),b=4,void setTimeout((function(){g_playfield.startLevel(l)}),20);A(d)}};var A=function(e){d=e;for(var t=0;t<s.length;t++)s[t].setAttribute("scale",new THREE.Vector3(e,e,e))};t.show=function(){v(),A(.01),b=1,r.setAttribute("visible",!0),r.setAttribute("position",new THREE.Vector3(-2*a/2,-.5,0))},t.setLevelAvailable=function(e,t){e<c.length&&(c[e]=t)},t.getLevelAvailable=function(e){return c[e]};var v=function(){for(var e=0;e<s.length;e++)t.getLevelAvailable(e)?p(e,i):p(e,n)},f=function(e){l=e,b=2};!function(){var e=levels.length,n=.4;a=5,o=1.4*Math.ceil(e/4),(r=document.getElementById("level-select")).setAttribute("visible",!1),r.setAttribute("position",new THREE.Vector3(-2*a/2,-10.5,0)),r.setAttribute("scale","2 2 2");var l=document.createElement("a-text");l.setAttribute("value","Level Select"),l.setAttribute("scale","4 4 4"),l.setAttribute("color","#eeeeee"),l.setAttribute("position",new THREE.Vector3(.05,1.6,.5-o)),r.append(l);for(var b=0;b<e;b++){c.push(!1);var d=n+b%4*1.4,A=-n-1.4*Math.floor(b/4),v=document.createElement("a-entity");v.setAttribute("position",new THREE.Vector3(d,0,A)),v.setAttribute("level-index",b);var g=document.createElement("a-box");g.setAttribute("scale",new THREE.Vector3(1,.05,1)),g.setAttribute("color",i),g.setAttribute("class","clickable"),v.append(g);var m=document.createElement("a-text");m.setAttribute("color","#eeeeee"),m.setAttribute("align","center"),m.setAttribute("rotation","-90 0 0"),m.setAttribute("position","0 0.1 0");var h=b+1;m.setAttribute("value",h),m.setAttribute("scale","2.6 2.6 2.6"),v.append(m),u.push(m),s.push(v),r.append(v),g.addEventListener("mouseenter",(function(e){var r=parseInt(e.target.parentNode.getAttribute("level-index"),10);t.getLevelAvailable(r)&&p(r,"#bbbbbb")})),g.addEventListener("mouseleave",(function(e){var r=parseInt(e.target.parentNode.getAttribute("level-index"),10);t.getLevelAvailable(r)&&p(r,i)})),g.addEventListener("click",(function(e){var r=parseInt(e.target.parentNode.getAttribute("level-index"),10);if(t.getLevelAvailable(r)){g_sound.init(),g_sound.playSound(SOUND_CLICK);r=parseInt(e.target.parentNode.getAttribute("level-index"),10);f(r)}}))}c[0]=!0}(),v()}</script><body><a-scene game background="color: #111144" shadow="type: basic" cursor="rayOrigin: mouse; fuse: false" raycaster="objects: .clickable"><a-entity id=laser-right laser-controls="hand: right" raycaster="objects: .clickable"></a-entity><a-entity id=laser-left laser-controls="hand: left" raycaster="objects: .clickable"></a-entity><a-light type=ambient color=#555577></a-light><a-entity id=camera-rotation rotation="0 0 0"><a-camera></a-camera></a-entity><a-entity id=holder rotation="0 0 0" scale="0.3 0.3 0.3" position="0 -1 -2"><a-entity light="type: directional; castShadow: true; shadowMapHeight: 4096; shadowMapWidth: 4096;" position="8.3 13.3 8.6"></a-entity><a-entity id=level-select></a-entity><a-entity id=playfield><a-entity id=block-cursor position="0 0 0"></a-entity></a-entity><a-entity id=controls position="-6.5 0.5 1"><a-entity id=palette position="0 0 0"></a-entity><a-entity id=restart position="12 0 0"></a-entity><a-entity id=home position="11 0 0"></a-entity></a-entity></a-entity></a-scene>