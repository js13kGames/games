<!doctype html><meta name=viewport content="width=device-width"><title>Roll for Mischief - js13kGames 2025</title><style>*{margin:0;padding:0;box-sizing:border-box}body{background:#1a1a1a;color:#fff;font-family:monospace;overflow:hidden}canvas{display:block;width:100vw;height:100vh;background:#222}.ui-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:100}.dialog-box{position:absolute;bottom:20px;left:20px;right:20px;background:#000;border:3px solid #666;border-radius:8px;padding:15px;font-size:14px;line-height:1.4;display:none;pointer-events:all}.dialog-box.active{display:block}.leaderboard,.stats-panel{position:absolute;top:20px;background:rgba(0,0,0,.8);border:2px solid #444;padding:10px;font-size:12px}.stats-panel{right:20px;min-width:200px}.leaderboard{left:20px;max-width:250px}@media(max-width:1200px){.leaderboard,.stats-panel{top:80px}}</style><canvas id=gameCanvas></canvas><div class=ui-overlay><div class=leaderboard><h3>üèÜ Roll for Mischief</h3><div id=leaderboard-list>Connecting...</div></div><div class=stats-panel><div id=player-stats><h3>Your Cat</h3><div>Loading...</div></div></div><div id=dialog-box class=dialog-box><div id=dialog-text>Welcome to the alley...</div></div><div class=event-log style="position:absolute;bottom:20px;right:20px;width:400px;height:150px;background:rgba(0,0,0,.9);border:2px solid #444;padding:10px;font-size:11px;overflow-y:auto"><div style=color:#888;margin-bottom:5px>Event Log</div><div id=event-list></div></div></div><script>const t={cat:{data:"00000000000000000000000000000000000000000010000000000000002000000000000000340000000000000530000000000000067340000000000046700000000000000677360000000002377000000000000006777789777777A3777000000000000006777737777777377770000000000000067777777777777777700000000000000B77777777777777777000000000CC0000777777777777777777D000000E77000F7777GDH777770IJ777K00000L77700067777M007777N0PJ777D00000Q77N0006777CR007777N0SJ777K00000Q7N00006777777777777777777K00000Q7N000001377777770K7777770000000H77000000TU777777VE7777NW0000000H77000000X1337777777777E00000000H7700000AAAAA3777777773200000000H77700007777777777777777700000000H77000V777777777777777770000000007700W7777777777777777770000000007700677777777777777777700000000067056776377777777777777000000000030QY777T07777777777771000000000060H7777K07777KN77DN77A000000000060L7777K0777N0E7N0E77A000000000060Z7777D0777N0E7N0177A000000000000H7777D0777708610N77A000000000000K7773230E77L04A0N773T000000000005E7731A0H77700A0N7777D0000000000007773A0Z77700A097777D00000000000000000000000000000000000",colors:{1:"#d07010",2:"#c05000",3:"#a03010",4:"#d04010",5:"#704010",6:"#f05000",7:"#f07010",8:"#d04000",9:"#e06010",A:"#e04000",B:"#f04000",C:"#f08010",D:"#905020",E:"#d06010",F:"#c04010",G:"#f0a030",H:"#b05020",I:"#e09030",J:"#f09020",K:"#a05020",L:"#b05010",M:"#f0b040",N:"#e07010",P:"#e0a040",Q:"#a05010",R:"#f0b030",S:"#e0a030",T:"#c05010",U:"#f06010",V:"#c06010",W:"#804020",X:"#b03000",Y:"#f07000",Z:"#b06020"},size:32}},s={C:{F:{n:"Fighter",h:10,a:1,s:[]},R:{n:"Rogue",h:8,a:1,s:["hide","sneak"]},W:{n:"Wizard",h:6,a:0,s:["firebolt"]},C:{n:"Cleric",h:8,a:1,s:["heal1","heal2","heal3","harm"]}},g(t="Cat"){const s=Object.keys(this.C),e=this.C[s[Math.floor(Math.random()*s.length)]],i=()=>10+(8*Math.random()|0),o={S:i(),D:i(),C:i(),I:i(),W:i(),H:i()};"Fighter"===e.n?(o.S+=3,o.D+=2):"Rogue"===e.n?o.D+=3:"Wizard"===e.n?(o.I+=3,o.D+=1):"Cleric"===e.n&&(o.W+=3,o.D+=1);const a=e.h+Math.floor((o.C-10)/2);let n=10+Math.floor((o.D-10)/2);return"Fighter"===e.n?n+=3:"Cleric"===e.n&&(n+=2),{n:t,c:e,s:o,h:a,m:a,a:n,p:{x:0,y:0,z:0},v:1,t:0}},r:(t=0)=>Math.floor(20*Math.random())+1+t,i(t){return t.i=this.r(Math.floor((t.s.D-10)/2))},k(t,s,e=0){const i=Math.floor(20*Math.random())+1,o=t.c.a+Math.floor((t.s.S-10)/2)+e,a=i+o;if(a>=s.a){const e=Math.floor(6*Math.random())+1,n=Math.floor((t.s.S-10)/2),h=Math.max(1,e+n);return s.h=Math.max(0,s.h-h),s.h>0||(s.v=0),{h:1,d:h,d20:i,atkBonus:o,total:a,targetAC:s.a,d6:e,strMod:n}}return{h:0,d:0,d20:i,atkBonus:o,total:a,targetAC:s.a}},d(t){return this.r(Math.floor((t.s.H-10)/2))>=12},spell(t,s,e,i=30){const o=s?Math.sqrt(Math.pow(s.pos.x-t.pos.x,2)+Math.pow(s.pos.z-t.pos.z,2)):0;switch(e){case"firebolt":if(o>i)return{h:0,msg:"Out of range"};const e=Math.floor(20*Math.random())+1,a=Math.floor((t.s.I-10)/2),n=t.c.a+a,h=e+n;if(h>=s.a){const t=Math.floor(10*Math.random())+1;return s.h=Math.max(0,s.h-t),s.h>0||(s.v=0),{h:1,d:t,d20:e,atkBonus:n,total:h,targetAC:s.a,die:"d10"}}return{h:0,d:0,d20:e,atkBonus:n,total:h,targetAC:s.a};case"harm":if(o>i)return{h:0,msg:"Out of range"};const r=Math.floor(20*Math.random())+1,c=Math.floor((t.s.W-10)/2),l=t.c.a+c,d=r+l;if(d>=s.a){const t=Math.floor(8*Math.random())+1+c;return s.h=Math.max(0,s.h-t),s.h>0||(s.v=0),{h:1,d:t,d20:r,atkBonus:l,total:d,targetAC:s.a,die:"d8+Wis"}}return{h:0,d:0,d20:r,atkBonus:l,total:d,targetAC:s.a};case"heal1":const f=Math.floor(8*Math.random())+1+Math.floor((t.s.W-10)/2);return t.h=Math.min(t.m,t.h+f),{heal:f,msg:"1d8+Wis healing"};case"heal2":const u=2*(Math.floor(8*Math.random())+1)+Math.floor((t.s.W-10)/2);return t.h=Math.min(t.m,t.h+u),{heal:u,msg:"2d8+Wis healing"};case"heal3":const p=3*(Math.floor(8*Math.random())+1)+Math.floor((t.s.W-10)/2);return t.h=Math.min(t.m,t.h+p),{heal:p,msg:"3d8+Wis healing"};case"hide":return t.hidden=1,{msg:"Hidden until next attack"};case"sneak":return{sneakDmg:Math.floor(6*Math.random())+1,msg:"+1d6 sneak attack"}}return{msg:"Unknown spell"}}},e={init(t){this.c=t,this.ctx=t.getContext("2d"),this.w=t.width=innerWidth,this.h=t.height=innerHeight,this.cam={x:0,y:50,z:100,rx:-.5,ry:0,rz:0,fov:60,zoom:1},this.near=1,this.far=1e3,this.objects=[],this.catScreenPositions={},this.gridSize=5},add(t,s,e,i,o,a,n,h){const r={type:t,x:s,y:e,z:i,w:o,h:a,d:n,color:h};if("building"===t){const t=["#FFA500","#FFD700","#FF8C00","#FFAA00","#FFCC00"],s=Math.floor(a/10);r.windowColors=[];for(let e=0;s>e;e++){r.windowColors[e]=[];for(let s=0;4>s;s++)for(let i=0;2>i;i++){const o=Math.floor(Math.random()*t.length);r.windowColors[e][2*s+i]=t[o]}}}this.objects.push(r)},project(t,s,e){let i=t-this.cam.x,o=s-this.cam.y,a=e-this.cam.z;const n=Math.cos(this.cam.ry),h=Math.sin(this.cam.ry);let r=i*h+a*n;i=i*n-a*h,a=r;const c=Math.cos(this.cam.rx),l=Math.sin(this.cam.rx);if(r=o*l+a*c,o=o*c-a*l,a=r,a<this.near)return null;const d=.5*this.h/Math.tan(.5*this.cam.fov*Math.PI/180);return{x:i*d/a*this.cam.zoom+this.w/2,y:-o*d/a*this.cam.zoom+this.h/2,z:a}},drawBox(t,s,e,i,o,a,n,h=1){const r=[{x:t,y:s,z:e},{x:t+i,y:s,z:e},{x:t+i,y:s,z:e+a},{x:t,y:s,z:e+a},{x:t,y:s+o,z:e},{x:t+i,y:s+o,z:e},{x:t+i,y:s+o,z:e+a},{x:t,y:s+o,z:e+a}].map(t=>this.project(t.x,t.y,t.z));if(r.some(t=>!t))return;const c=[{indices:[4,5,6,7],color:n,normal:[0,1,0]},{indices:[0,1,2,3],color:this.darken(n,.9),normal:[0,-1,0]},{indices:[0,4,7,3],color:this.darken(n,.95),normal:[-1,0,0]},{indices:[1,5,6,2],color:this.darken(n,.95),normal:[1,0,0]},{indices:[0,1,5,4],color:this.darken(n,.98),normal:[0,0,-1]},{indices:[3,2,6,7],color:this.darken(n,.95),normal:[0,0,1]}].filter(n=>{const h=[t+i/2+n.normal[0]*i/2,s+o/2+n.normal[1]*o/2,e+a/2+n.normal[2]*a/2],r=[this.cam.x-h[0],this.cam.y-h[1],this.cam.z-h[2]];return n.normal[0]*r[0]+n.normal[1]*r[1]+n.normal[2]*r[2]>0}).map(t=>{const s=t.indices.reduce((t,s)=>t+r[s].z,0)/t.indices.length;return{...t,depth:s}});c.sort((t,s)=>s.depth-t.depth),this.ctx.globalAlpha=h,c.forEach(t=>{this.ctx.fillStyle=t.color,this.ctx.beginPath(),this.ctx.moveTo(r[t.indices[0]].x,r[t.indices[0]].y);for(let s=1;s<t.indices.length;s++)this.ctx.lineTo(r[t.indices[s]].x,r[t.indices[s]].y);this.ctx.closePath(),this.ctx.fill(),this.ctx.strokeStyle="rgba(0,0,0,0.3)",this.ctx.lineWidth=1,this.ctx.stroke()}),this.ctx.globalAlpha=1},drawGrid(){this.ctx.strokeStyle="rgba(100,100,150,0.3)",this.ctx.lineWidth=1;for(let t=-500;500>=t;t+=this.gridSize)for(let s=-500;500>=s;s+=this.gridSize){const e=[this.project(t,0,s),this.project(t+this.gridSize,0,s),this.project(t+this.gridSize,0,s+this.gridSize),this.project(t,0,s+this.gridSize)];e.every(t=>t)&&(this.ctx.beginPath(),this.ctx.moveTo(e[0].x,e[0].y),this.ctx.lineTo(e[1].x,e[1].y),this.ctx.lineTo(e[2].x,e[2].y),this.ctx.lineTo(e[3].x,e[3].y),this.ctx.closePath(),this.ctx.stroke())}},darken(t,s){if(!t)return"#666666";if("string"==typeof t&&t.startsWith("#")){const e=parseInt(t.slice(1,3),16),i=parseInt(t.slice(3,5),16),o=parseInt(t.slice(5,7),16);return`rgb(${Math.floor(e*s)},${Math.floor(i*s)},${Math.floor(o*s)})`}return t},clear(){const t=this.ctx.createLinearGradient(0,0,0,this.h);t.addColorStop(0,"#0a0a1a"),t.addColorStop(.5,"#1a1a2e"),t.addColorStop(1,"#2a2a3e"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.w,this.h);const s=this.ctx.createRadialGradient(this.w/2,this.h/2,0,this.w/2,this.h/2,.7*this.w);s.addColorStop(0,"rgba(255,165,0,0.02)"),s.addColorStop(1,"rgba(100,100,200,0.05)"),this.ctx.fillStyle=s,this.ctx.fillRect(0,0,this.w,this.h)},render(){this.clear(),this.drawGrid();const t=this.objects.filter(t=>"building"===t.type),s=this.objects.filter(t=>"cat"===t.type||"boss"===t.type),e=t.map(t=>{const s=t.x+t.w/2-this.cam.x,e=t.y+t.h/2-this.cam.y,i=t.z+t.d/2-this.cam.z,o=Math.sqrt(s*s+e*e+i*i);return{...t,dist:o}}).sort((t,s)=>s.dist-t.dist),i=s.map(t=>{const s=t.x+t.w/2-this.cam.x,e=t.y+t.h/2-this.cam.y,i=t.z+t.d/2-this.cam.z,o=Math.sqrt(s*s+e*e+i*i);return{...t,dist:o}}).sort((t,s)=>s.dist-t.dist);e.forEach(t=>{this.drawBox(t.x,t.y,t.z,t.w,t.h,t.d,t.color),this.drawBuildingWindows(t)}),i.forEach(t=>{let s=0;for(const i of e)if(this.isObjectBehind(t,i)){s=1;break}s||this.drawCat(t)}),i.forEach(t=>{this.calculateCatScreenPosition(t)})},calculateCatScreenPosition(t){if(!t.catId)return;const{x:s,y:e,z:i,w:o,h:a,d:n}=t,h=this.project(s+o/2,e+a,i+n/2);if(!h)return;this.cam.x,this.cam.y,this.cam.z;const r=h.z,c=Math.max(8,4e3/r),l=h.y-c;this.catScreenPositions[t.catId]={x:h.x,y:l}},isObjectBehind(t,s){const e=t.x+t.w/2,i=t.y+t.h/2,o=t.z+t.d/2,a=s.x+s.w/2,n=s.y+s.h/2,h=s.z+s.d/2,r=t.x,c=t.x+t.w,l=t.z,d=t.z+t.d,f=s.x,u=s.x+s.w,p=s.z,m=s.z+s.d;return c>f&&u>r&&d>p&&m>l?Math.sqrt((e-this.cam.x)**2+(i-this.cam.y)**2+(o-this.cam.z)**2)>Math.sqrt((a-this.cam.x)**2+(n-this.cam.y)**2+(h-this.cam.z)**2):0},drawTriangle(t,s,e,i){const o=this.project(t.x,t.y,t.z),a=this.project(s.x,s.y,s.z),n=this.project(e.x,e.y,e.z);if(!o||!a||!n)return;const h=s.x-t.x,r=s.y-t.y,c=s.z-t.z,l=e.x-t.x,d=e.y-t.y,f=e.z-t.z,u=r*f-c*d,p=c*l-h*f,m=h*d-r*l,x=(t.x+s.x+e.x)/3,g=(t.y+s.y+e.y)/3,y=(t.z+s.z+e.z)/3;0>u*(this.cam.x-x)+p*(this.cam.y-g)+m*(this.cam.z-y)||(this.ctx.fillStyle=i,this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(a.x,a.y),this.ctx.lineTo(n.x,n.y),this.ctx.closePath(),this.ctx.fill(),this.ctx.strokeStyle="rgba(0,0,0,0.2)",this.ctx.lineWidth=.5,this.ctx.stroke())},sprites:{cat:t.cat.data,colors:t.cat.colors,size:t.cat.size},drawSprite(t,s,e,i,o,a=32,n=null,h={}){const r=o/a,{isDefeated:c=0,clipToHead:l=0,isBoss:d=0}=h,f=l?16:a,u=l?8:0,p=a;for(let o=l?2:0;f>o;o++)for(let h=u;p>h;h++){let l=s[t[o*a+h]];l&&(c?l=this.bleachColor(l):d?l=this.darkenColor(l):n&&"#f07010"!==n&&null!==n&&(l=this.strongTint(l,n)),this.ctx.fillStyle=l,this.ctx.fillRect(e+h*r,i+o*r,r,r))}c&&l?this.drawDefeatedEyes(e,i,o,a):d&&this.drawBossEyes(e,i,o,a)},strongTint(t,s){if("#f07010"===t)return s;const e=this.hexToRgb(s);if(e.r===e.g&&e.g===e.b||20>Math.abs(e.r-e.g)&&20>Math.abs(e.g-e.b)){const s=this.hexToRgb(t),i=.85;return`rgb(${Math.floor(s.r*(1-i)+e.r*i)},${Math.floor(s.g*(1-i)+e.g*i)},${Math.floor(s.b*(1-i)+e.b*i)})`}{const s=this.hexToRgb(t),i=.6;return`rgb(${Math.floor(s.r*(1-i)+e.r*i)},${Math.floor(s.g*(1-i)+e.g*i)},${Math.floor(s.b*(1-i)+e.b*i)})`}},blendColors(t,s){const e=this.hexToRgb(t),i=this.hexToRgb(s);return`rgb(${Math.floor(.6*e.r+.4*i.r)},${Math.floor(.6*e.g+.4*i.g)},${Math.floor(.6*e.b+.4*i.b)})`},hexToRgb:t=>({r:parseInt(t.slice(1,3),16),g:parseInt(t.slice(3,5),16),b:parseInt(t.slice(5,7),16)}),bleachColor(t){const s=this.hexToRgb(t),e=Math.floor(1.5*(.3*s.r+.59*s.g+.11*s.b)),i=Math.min(255,e);return`rgb(${i},${i},${i})`},darkenColor(t){const s=this.hexToRgb(t),e=Math.floor(.2*(.3*s.r+.3*s.g+.3*s.b));return`rgb(${e},${e},${e})`},drawDefeatedEyes(t,s,e,i){const o=e/i;this.ctx.fillStyle="#000000";const a=t+14*o,n=t+22*o,h=s+10*o,r=4*o,c=3*o;this.ctx.fillRect(a,h,r,c),this.ctx.fillRect(n,h,r,c)},drawBossEyes(t,s,e,i){const o=e/i;this.ctx.fillStyle="#ffff00";const a=t+14*o,n=t+22*o,h=s+10*o,r=4*o,c=3*o;this.ctx.fillRect(a,h,r,c),this.ctx.fillRect(n,h,r,c)},drawCat(t){const{x:s,y:e,z:i,w:o,h:a,d:n,color:h,type:r}=t,c=s-this.cam.x,l=e+a/2-this.cam.y,d=i-this.cam.z;if(Math.sqrt(c*c+l*l+d*d)>this.far)return;const f=Math.floor(s/this.gridSize)*this.gridSize,u=Math.floor(i/this.gridSize)*this.gridSize,p="boss"===r?2*this.gridSize:this.gridSize,m=f+p/2,x=u+p/2,g=this.project(m,0,x);if(!g)return;const y=[this.project(f,0,u),this.project(f+p,0,u),this.project(f+p,0,u+p),this.project(f,0,u+p)],M="boss"===r?80:40;let v=0;if(t.catId&&window.G&&window.G.turnOrder){const s=window.G.turnOrder.find(s=>s.id===t.catId);v=s&&!s.v}if(window.G&&window.G.combat&&window.G.turnOrder){const s=window.G.turnOrder[window.G.currentTurn];t.catId===s.id&&(this.ctx.strokeStyle=v?"rgba(100,100,100,0.8)":"rgba(255,255,0,0.8)",this.ctx.lineWidth=3,this.ctx.fillStyle=v?"rgba(100,100,100,0.1)":"rgba(255,255,0,0.1)",y.every(t=>t)&&(this.ctx.beginPath(),this.ctx.moveTo(y[0].x,y[0].y),this.ctx.lineTo(y[1].x,y[1].y),this.ctx.lineTo(y[2].x,y[2].y),this.ctx.lineTo(y[3].x,y[3].y),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()))}let b=g.y-M;"boss"===r&&(b+=10),v&&(b+=.4*M),this.drawSprite(this.sprites.cat,this.sprites.colors,g.x-M/2,b,M,this.sprites.size,"boss"===r?null:h,{isDefeated:v,clipToHead:v,isBoss:"boss"===r}),t.screenTop={x:g.x,y:b}},drawBuildingWindows(t){const{x:s,y:e,z:i,w:o,h:a,d:n,windowColors:h}=t;[{normal:[-1,0,0],side:"left",index:0},{normal:[1,0,0],side:"right",index:1},{normal:[0,0,-1],side:"front",index:2},{normal:[0,0,1],side:"back",index:3}].filter(t=>{const h=[s+o/2+t.normal[0]*o/2,e+a/2+t.normal[1]*a/2,i+n/2+t.normal[2]*n/2],r=[this.cam.x-h[0],this.cam.y-h[1],this.cam.z-h[2]];return t.normal[0]*r[0]+t.normal[1]*r[1]+t.normal[2]*r[2]>0}).forEach(t=>{const r=Math.floor(a/6);for(let c=1;r>=c;c++){const r=6*c-3,l=2.5,d=l,f=2*l,u=d+(.5*Math.sin(1.7*c+.3*s+.7*i)+.5)*(Math.min(f,Math.max(d,a-r-3))-d),p=Math.floor(4*(c-1)+2*t.index),m=h&&h[c-1]&&h[c-1][p]?h[c-1][p]:"#FFA500";if("front"===t.side){if(this.drawBox(s+2,e+r,i-.1,l,u,.2,m),o>10){const t=p+1,a=h&&h[c-1]&&h[c-1][t]?h[c-1][t]:"#FFD700";this.drawBox(s+o-2-l,e+r,i-.1,l,u,.2,a)}}else if("back"===t.side){if(this.drawBox(s+2,e+r,i+n-.1,l,u,.2,m),o>10){const t=p+1,a=h&&h[c-1]&&h[c-1][t]?h[c-1][t]:"#FFD700";this.drawBox(s+o-2-l,e+r,i+n-.1,l,u,.2,a)}}else if("left"===t.side){if(this.drawBox(s-.1,e+r,i+2,.2,u,l,m),n>10){const t=p+1,o=h&&h[c-1]&&h[c-1][t]?h[c-1][t]:"#FFD700";this.drawBox(s-.1,e+r,i+n-2-l,.2,u,l,o)}}else if("right"===t.side&&(this.drawBox(s+o-.1,e+r,i+2,.2,u,l,m),n>10)){const t=p+1,a=h&&h[c-1]&&h[c-1][t]?h[c-1][t]:"#FFD700";this.drawBox(s+o-.1,e+r,i+n-2-l,.2,u,l,a)}}})},moveCamera(t,s,e){this.cam.x+=t,this.cam.y+=s,this.cam.z+=e},rotateCamera(t,s){this.cam.rx=Math.max(-Math.PI/2,Math.min(Math.PI/2,this.cam.rx+t)),this.cam.ry+=s},zoomCamera(t){this.cam.zoom=Math.max(.5,Math.min(3,this.cam.zoom*t))},setIsometric(){this.cam.rx=-Math.PI/4,this.cam.ry=Math.PI/4,this.cam.y=50,this.cam.zoom=1}};let i={s:"splash",p:null,cs:[],t:0,k:new Set,mouseDrag:0,rightMouseDrag:0,lastMouse:{x:0,y:0},w:null,id:"cat_"+(1e6*Math.random()|0),combat:null,turnOrder:[],currentTurn:0,currentActions:3,actionType:null,attackCount:0,moveDistance:0,eventLog:[],targetDialog:null,healDialog:0,showStatBlock:0,menuSelection:0,roomCode:"",gameMode:null,connectedPlayers:0,ws:null,init(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.initAfterDOM()):this.initAfterDOM()},initAfterDOM(){const t=document.querySelector("canvas");e.init(t),this.generateCity(),this.catColors=[null,"#CD853F","#D2691E","#A0A0A0","#F5DEB3","#DDA0DD"],t.addEventListener("mousedown",t=>{0===t.button?this.mouseDrag=1:2===t.button&&(this.rightMouseDrag=1,t.preventDefault()),this.lastMouse={x:t.clientX,y:t.clientY}}),t.addEventListener("mouseup",()=>{this.mouseDrag=0,this.rightMouseDrag=0}),t.addEventListener("contextmenu",t=>{t.preventDefault()}),t.addEventListener("mousemove",t=>{if(this.mouseDrag||this.rightMouseDrag){const s=t.clientX-this.lastMouse.x,i=t.clientY-this.lastMouse.y;if(this.mouseDrag)e.rotateCamera(.01*-i,.01*s);else if(this.rightMouseDrag){const t=.5,o=e.cam.ry,a=Math.cos(o),n=Math.sin(o),h=s*a*t,r=s*n*t,c=-i*n*t,l=i*a*t;e.moveCamera(h+c,0,r+l)}this.lastMouse={x:t.clientX,y:t.clientY}}}),this.setupKeyboardControls(),this.updateUI(),this.loop()},spawnCats(){if(e.objects=[],this.cs=[],!this.p){this.p=s.g("You"),this.p.id=this.id;const t=Math.random()*Math.PI*2,e=4+Math.floor(7*Math.random()),i=Math.cos(t)*e*5,o=Math.sin(t)*e*5;this.p.pos={x:5*Math.round(i/5),y:0,z:5*Math.round(o/5)},this.p.color=this.catColors[0]||"#f07010"}this.lastCatPos={x:this.p.pos.x,z:this.p.pos.z},e.add("cat",this.p.pos.x,this.p.pos.y,this.p.pos.z,3,5,3,this.p.color),e.objects[e.objects.length-1].catId=this.p.id;const t=s.g("??????");t.id="boss",t.n="??????",t.c={...t.c,n:"??????"},t.isBoss=1,t.isAI=1,t.h=t.m=60,t.a=16,t.c.a=3,t.s={S:16,D:14,C:16,I:10,W:12,H:8},t.color="#000000",t.pos={x:0,y:0,z:30},this.cs.push(t);const i={type:"boss",x:t.pos.x,y:t.pos.y,z:t.pos.z,w:10,h:10,d:10,color:t.color,catId:t.id};e.objects.push(i),this.joinedPlayers&&this.joinedPlayers.forEach(t=>{this.cs.push(t),e.add("cat",t.pos.x,t.pos.y,t.pos.z,3,5,3,t.color),e.objects[e.objects.length-1].catId=t.id});const o=6-this.connectedPlayers,a=new Set([`${this.p.pos.x},${this.p.pos.z}`,"0,30"]);this.joinedPlayers&&this.joinedPlayers.forEach(t=>{a.add(`${t.pos.x},${t.pos.z}`)});for(let t=0;o>t;t++){const i=s.g("AI Cat "+(t+1));i.id="ai_"+t,i.isAI=1;const o=(t+1)%this.catColors.length;let n,h,r;i.color=this.catColors[o]||"#f07010";do{n=5*(Math.floor(12*Math.random())-6),h=5*(Math.floor(12*Math.random())-6),r=`${n},${h}`}while(a.has(r));a.add(r),i.pos={x:n,y:0,z:h},this.cs.push(i);const c={type:"cat",x:i.pos.x,y:i.pos.y,z:i.pos.z,w:3,h:5,d:3,color:i.color,catId:i.id};e.objects.push(c)}this.cs.unshift(this.p),this.cs.forEach(t=>{t.isBoss||t.isAI}),e.cam.x=this.p.pos.x,e.cam.y=25,e.cam.z=this.p.pos.z+25,e.cam.rx=-.3,e.cam.ry=Math.PI,e.canvas&&!this.cameraControlsSetup&&(this.cameraControlsSetup=1,e.canvas.addEventListener("mousedown",t=>{0===t.button?this.mouseDrag=1:2===t.button&&(this.rightMouseDrag=1,t.preventDefault()),this.lastMouse={x:t.clientX,y:t.clientY}}),e.canvas.addEventListener("mouseup",()=>{this.mouseDrag=0,this.rightMouseDrag=0}),e.canvas.addEventListener("contextmenu",t=>{t.preventDefault()}),e.canvas.addEventListener("mousemove",t=>{if(this.mouseDrag||this.rightMouseDrag){const s=t.clientX-this.lastMouse.x,i=t.clientY-this.lastMouse.y;if(this.mouseDrag)e.rotateCamera(.01*-i,.01*s);else if(this.rightMouseDrag){const t=.5,o=e.cam.ry,a=s*Math.cos(o)*t,n=s*Math.sin(o)*t;e.moveCamera(a,-i*t,n)}this.lastMouse={x:t.clientX,y:t.clientY}}}),e.canvas.addEventListener("wheel",t=>{const s=t.deltaY>0?1.1:.9;e.zoomCamera(s),t.preventDefault()}))},setupKeyboardControls(){document.addEventListener("keydown",t=>{this.k.add(t.code),"Space"!==t.code&&" "!==t.key||(t.preventDefault(),"splash"===this.s?this.s="menu":this.combat&&("host"===this.gameMode?this.nextTurn():this.send("end_turn",{}))),"ArrowUp"!==t.code&&"KeyW"!==t.code||this.menuUp(),"ArrowDown"!==t.code&&"KeyS"!==t.code||this.menuDown(),"Enter"===t.code&&this.menuSelect(),"KeyI"===t.code&&e.setIsometric(),this.combat&&this.turnOrder&&this.turnOrder[this.currentTurn]?.id===this.p?.id&&("KeyM"===t.code&&this.setAction("move"),"KeyX"===t.code&&this.setAction("attack"),"KeyC"===t.code&&this.setAction("cast"),"KeyH"===t.code&&this.setAction("heal"),"KeyZ"===t.code&&this.setAction("stealth")),"KeyT"===t.code&&(this.showStatBlock=!this.showStatBlock),"Escape"===t.code&&this.endAction(),this.targetDialog&&("Digit1"===t.code&&this.selectTarget(1),"Digit2"===t.code&&this.selectTarget(2),"Digit3"===t.code&&this.selectTarget(3),"Digit4"===t.code&&this.selectTarget(4),"Digit5"===t.code&&this.selectTarget(5),"Digit6"===t.code&&this.selectTarget(6)),this.healDialog&&("Digit1"===t.code&&this.executeHeal(1),"Digit2"===t.code&&this.executeHeal(2),"Digit3"===t.code&&this.executeHeal(3))}),document.addEventListener("keyup",t=>{this.k.delete(t.code)})},connect(){try{this.w=new WebSocket("wss://relay.js13kgames.com/roll-for-mischief"),this.w.onopen=()=>this.send("join",{id:this.id,cat:this.p}),this.w.onmessage=t=>{try{const s=JSON.parse(t.data);this.handle(s)}catch(t){}}}catch(t){}},send(t,s){this.w&&1===this.w.readyState&&this.w.send(JSON.stringify({type:t,data:{...s,id:this.id}}))},handle(t){switch(t.type){case"join":if(t.data.id!==this.id){const s=t.data.cat;s.id=t.data.id,this.cs.push(s),e.add("cat",s.pos.x,s.pos.y,s.pos.z,3,5,3,"#654321")}break;case"move":if(t.data.id!==this.id){const s=this.cs.find(s=>s.id===t.data.id);if(s){s.pos=t.data.pos;const i=e.objects.find(t=>"cat"===t.type&&t.x===s.pos.x&&t.z===s.pos.z);i&&(i.x=s.pos.x,i.z=s.pos.z)}}}},generateCity(t=0,s=null){if(t){if(s)return void s.forEach(t=>{e.add("building",t.x,t.y,t.z,t.w,t.h,t.d,t.color)});for(let t=-5;5>=t;t++)for(let s=-5;5>=s;s++){const i=60*t,o=60*s;if(1>=Math.abs(t)&&1>=Math.abs(s))continue;const a=25+10*Math.random(),n=15+50*Math.random(),h=25+10*Math.random(),r=["#4a4a6a","#5a5a7a","#6a5a7a","#5a6a7a"],c=r[Math.floor(Math.random()*r.length)],l=i-a/2,d=0,f=o-h/2;e.add("building",l,d,f,a,n,h,c),this.buildings&&this.buildings.push({x:l,y:d,z:f,w:a,h:n,d:h,color:c})}for(let t=0;20>t;t++){const t=400*(Math.random()-.5),s=400*(Math.random()-.5);if(50>Math.abs(t)&&50>Math.abs(s))continue;const i=10+15*Math.random(),o=8+25*Math.random(),a=10+15*Math.random(),n=0,h="#3a3a5a";e.add("building",t,n,s,i,o,a,h),this.buildings&&this.buildings.push({x:t,y:n,z:s,w:i,h:o,d:a,color:h})}}},loop(){this.update(),this.render(),requestAnimationFrame(()=>this.loop())},update(){"playing"===this.s&&this.p&&(this.updateCamera(),this.updatePlayer())},updateCamera(){const t=-e.cam.ry,s=Math.cos(t),i=Math.sin(t);this.k.has("KeyW")&&e.moveCamera(2*-i,0,2*s),this.k.has("KeyS")&&e.moveCamera(2*i,0,2*-s),this.k.has("KeyA")&&e.moveCamera(2*-s,0,2*-i),this.k.has("KeyD")&&e.moveCamera(2*s,0,2*i),this.k.has("KeyQ")&&e.moveCamera(0,2,0),this.k.has("KeyE")&&e.moveCamera(0,-2,0)},occupied(t,s,e=null){return this.p&&this.p!==e&&this.p.v&&this.p.pos.x===t&&this.p.pos.z===s?1:this.cs.some(i=>{if(i===e||!i.v)return 0;if(i.isBoss){const e=5,o=Math.floor(i.pos.x/e)*e,a=Math.floor(i.pos.z/e)*e,n=2*e;return t>=o&&o+n>t&&s>=a&&a+n>s}return i.pos.x===t&&i.pos.z===s})},updatePlayer(){if(!this.p||!this.p.pos)return;const t=Date.now();if(this.combat){if(this.turnOrder[this.currentTurn]?.id!==this.p.id)return;if("move"!==this.actionType||0>=this.currentActions)return;if(this.moveDistance>=25)return}if(!this.lastMove||t-this.lastMove>300){let s=0;if("host"!==this.gameMode){const s=5;let e=this.p.pos.x,i=this.p.pos.z,o=0;return this.k.has("ArrowUp")&&(i-=s,o=1),this.k.has("ArrowDown")&&(i+=s,o=1),this.k.has("ArrowLeft")&&(e+=s,o=1),this.k.has("ArrowRight")&&(e-=s,o=1),void(!o||e===this.p.pos.x&&i===this.p.pos.z||(this.send("player_move",{targetX:e,targetZ:i,playerId:this.p.id,currentActions:this.currentActions,moveDistance:this.moveDistance}),this.lastMove=t,this.combat&&"move"===this.actionType&&(this.moveDistance+=5,this.addEvent(`Moved 5ft (${this.moveDistance}/25ft used)`),25>this.moveDistance||(this.currentActions--,this.moveDistance=0,this.addEvent(`Movement action consumed. ${this.currentActions} actions remaining.`),this.currentActions>0||(this.actionType=null),this.send("player_move",{targetX:e,targetZ:i,playerId:this.p.id,currentActions:this.currentActions,moveDistance:this.moveDistance})))))}{const t=5;let e=this.p.pos.x,i=this.p.pos.z;this.k.has("ArrowUp")&&(i-=t),this.k.has("ArrowDown")&&(i+=t),this.k.has("ArrowLeft")&&(e+=t),this.k.has("ArrowRight")&&(e-=t),e===this.p.pos.x&&i===this.p.pos.z||this.occupied(e,i,this.p)||(this.p.pos.x=e,this.p.pos.z=i,s=1)}if(s){this.lastMove=t,this.combat&&"move"===this.actionType&&(this.moveDistance+=5,this.addEvent(`Moved 5ft (${this.moveDistance}/25ft used)`),25>this.moveDistance||(this.currentActions--,this.moveDistance=0,this.addEvent(`Movement action consumed. ${this.currentActions} actions remaining.`),this.currentActions>0||(this.actionType=null)));const s=e.objects.findIndex(t=>"cat"===t.type);if(0>s||(e.objects[s].x=this.p.pos.x,e.objects[s].z=this.p.pos.z),this.send("move",{pos:this.p.pos}),this.checkCombat(),"host"===this.gameMode){const t=this.p.pos.x-this.lastCatPos.x,s=this.p.pos.z-this.lastCatPos.z;e.cam.x+=t,e.cam.z+=s}this.lastCatPos={x:this.p.pos.x,z:this.p.pos.z}}}},checkCombat(){const t=this.cs.filter(t=>{const s=t.pos.x-this.p.pos.x,e=t.pos.z-this.p.pos.z;return 30>=Math.sqrt(s*s+e*e)&&t.v});t.length>0&&!this.combat&&this.startCombat([this.p,...t])},startCombat(t){this.combat={participants:t,round:1},t.forEach(t=>s.i(t)),this.turnOrder=t.sort((t,s)=>s.i-t.i),this.currentTurn=0;const i=this.turnOrder[0];this.addEvent(i.c.n+"'s turn begins"),i.isAI&&i.v&&setTimeout(()=>this.runAITurn(i),1e3);const o=t.reduce((t,s)=>t+s.pos.x,0)/t.length,a=t.reduce((t,s)=>t+s.pos.z,0)/t.length;e.cam.x=o,e.cam.z=a+40,e.cam.y=25,e.cam.rx=-.3},handleSpace(){"splash"===this.s?this.s="menu":this.combat&&this.nextTurn()},menuUp(){("menu"===this.s||"lobby"===this.s&&"host"===this.gameMode)&&(this.menuSelection=Math.max(0,this.menuSelection-1))},menuDown(){"menu"===this.s?this.menuSelection=Math.min(1,this.menuSelection+1):"lobby"===this.s&&"host"===this.gameMode&&(this.menuSelection=Math.min(2,this.menuSelection+1))},menuSelect(){"menu"===this.s?0===this.menuSelection?this.startGame():this.joinGame():"lobby"===this.s&&("host"===this.gameMode?0===this.menuSelection?(this.send("game_start",{roomCode:this.roomCode}),this.s="playing",this.initGame(),setTimeout(()=>{this.syncGameState()},500)):1===this.menuSelection?(this.connectedPlayers=1,this.s="playing",this.initGame()):(this.s="menu",this.menuSelection=0):(this.s="menu",this.menuSelection=0))},startGame(){this.gameMode="host",this.roomCode=this.generateRoomCode(),this.s="lobby",this.connectToLobby()},joinGame(){this.gameMode="join";const t=prompt("Enter 4-letter room code:");t&&4===t.length&&(this.roomCode=t.toUpperCase(),this.s="lobby",this.connectToJoinLobby())},connectToJoinLobby(){try{this.connectedPlayers=0,this.ws=new WebSocket("wss://relay.js13kgames.com/roll-for-mischief"),this.ws.onopen=()=>{this.generateClientPlayer(),this.send("join_room",{id:this.id,playerData:this.p}),setTimeout(()=>{this.send("request_room_state",{id:this.id})},100)},this.ws.onmessage=t=>{if("string"!=typeof t.data||!t.data.startsWith("@")&&!t.data.startsWith("+"))try{const s=JSON.parse(t.data);this.handleLobbyMessage(s)}catch(t){}},this.ws.onclose=()=>{},this.ws.onerror=()=>{}}catch(t){this.connectedPlayers=1}},connectToLobby(){try{this.generateClientPlayer(),this.connectedPlayers=1,this.ws=new WebSocket("wss://relay.js13kgames.com/roll-for-mischief"),this.ws.onopen=()=>{this.send("create_room",{roomCode:this.roomCode,id:this.id,host:1})},this.ws.onmessage=t=>{if("string"!=typeof t.data||!t.data.startsWith("@")&&!t.data.startsWith("+"))try{const s=JSON.parse(t.data);this.handleLobbyMessage(s)}catch(t){}},this.ws.onclose=()=>{},this.ws.onerror=()=>{}}catch(t){this.connectedPlayers=1}},send(t,s){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const e=JSON.stringify({type:t,...s,room:this.roomCode});this.ws.send(e)}},handleLobbyMessage(t){if("create_room"!==t.type||!t.host||t.id===this.id)if("join_room"===t.type&&t.id!==this.id)"host"===this.gameMode&&(this.connectedPlayers++,t.playerData&&t.playerData.id!==this.id&&(this.joinedPlayers||(this.joinedPlayers=[]),this.joinedPlayers.push(t.playerData)),this.send("room_update",{playerCount:this.connectedPlayers}));else if("room_update"===t.type)void 0!==t.playerCount&&(this.connectedPlayers=t.playerCount);else if("request_room_state"===t.type)"host"===this.gameMode&&this.send("room_update",{playerCount:this.connectedPlayers});else if("game_start"===t.type)"host"!==this.gameMode&&(this.s="playing");else if("game_state"===t.type)this.receiveGameState(t);else if("turn_update"===t.type)this.receiveTurnUpdate(t);else if("player_attack"===t.type&&"host"===this.gameMode)this.clearTurnTimeout(),this.handleClientAttack(t);else if("end_turn"===t.type&&"host"===this.gameMode)this.clearTurnTimeout(),this.nextTurn();else if("player_move"===t.type&&"host"===this.gameMode)this.clearTurnTimeout(),this.handleClientMove(t);else if("event_broadcast"===t.type)if("host"===this.gameMode)this.addEvent(t.text);else{this.eventLog.unshift(t.text),this.eventLog.length>8&&this.eventLog.pop();const s=document.querySelector("#event-list");if(s){const e=document.createElement("div");for(e.style.color="#00ff00",e.style.marginBottom="2px",e.textContent=t.text,s.insertBefore(e,s.firstChild);s.children.length>8;)s.removeChild(s.lastChild)}}else"action_update"===t.type&&"host"===this.gameMode&&(this.currentActions=t.currentActions)},generateClientPlayer(){const t=this.id.split("").reduce((t,s)=>(t<<5)-t+s.charCodeAt(0)&4294967295,0),e=Math.abs(t)/4294967295;Math.random();for(let s=0;Math.abs(t)%10>s;s++)Math.random();this.p=s.g("You"),this.p.id=this.id;const i=e*Math.PI*2+Math.random()*Math.PI*.5,o=4+Math.floor(7*Math.random()),a=Math.cos(i)*o*5,n=Math.sin(i)*o*5;this.p.pos={x:5*Math.round(a/5),y:0,z:5*Math.round(n/5)};const h=1+Math.abs(t)%(this.catColors.length-1);this.p.color=this.catColors[h]},handleClientAttack(t){const e=t.id||t.playerId,i=this.turnOrder.find(t=>t.id===e),o=this.turnOrder.find(s=>s.id===t.targetId);if(!i||!o)return;void 0!==t.currentActions&&(this.currentActions=t.currentActions),void 0!==t.attackCount&&(this.attackCount=t.attackCount);const a=-5*(t.attackCount-1),n=s.k(i,o,a),h=0>a?` (MAP ${a})`:"",r=`1d20${0>n.atkBonus?""+n.atkBonus:"+"+n.atkBonus} [${n.total}] vs AC ${n.targetAC}`;if(n.h){const t=`1d6${0>n.strMod?""+n.strMod:"+"+n.strMod} [${n.d}]`;this.addEvent(`${i.c.n} claw attack${h}: ${r} HIT for ${t} damage`),o.v||this.addEvent(o.c.n+" is defeated!")}else this.addEvent(`${i.c.n} claw attack${h}: ${r} MISS`);this.syncGameState()},handleClientMove(t){const s=t.playerId,i=this.turnOrder.find(t=>t.id===s);if(!i)return;const o=t.targetX,a=t.targetZ;if(!this.occupied(o,a,i)){i.pos.x=o,i.pos.z=a;const s=e.objects.findIndex(t=>("cat"===t.type||"boss"===t.type)&&t.catId===i.id);0>s||(e.objects[s].x=o,e.objects[s].z=a),void 0!==t.currentActions&&(this.currentActions=t.currentActions),void 0!==t.moveDistance&&(this.moveDistance=t.moveDistance),this.syncGameState()}},syncGameState(){if("host"!==this.gameMode||!this.combat)return;const t={cats:this.cs.map(t=>({id:t.id,n:t.n,pos:t.pos,h:t.h,m:t.m,a:t.a,v:t.v,c:t.c,s:t.s,color:t.color,i:t.i,isBoss:t.isBoss,isAI:t.isAI})),buildings:this.buildings||[],turnOrder:this.turnOrder.map(t=>t.id),currentTurn:this.currentTurn,currentActions:this.currentActions,combat:{round:this.combat.round},eventLog:this.eventLog||[]};this.send("game_state",t)},receiveGameState(t){if("host"===this.gameMode)return;e.objects=[],t.buildings&&t.buildings.length>0&&this.generateCity(1,t.buildings),this.cs=t.cats.map(t=>{const s={...t};if(s.isBoss){const t={type:"boss",x:s.pos.x,y:s.pos.y,z:s.pos.z,w:10,h:10,d:10,color:s.color,catId:s.id};e.objects.push(t)}else e.add("cat",s.pos.x,s.pos.y,s.pos.z,3,5,3,s.color),e.objects[e.objects.length-1].catId=s.id;return s});const s=this.cs.find(t=>t.id===this.id);if(s){if(this.p&&this.lastCatPos){const t=s.pos.x-this.p.pos.x,i=s.pos.z-this.p.pos.z;e.cam.x+=t,e.cam.z+=i}else e.cam.x=s.pos.x,e.cam.y=25,e.cam.z=s.pos.z+25,e.cam.rx=-.3,e.cam.ry=Math.PI;this.p=s,this.lastCatPos={x:this.p.pos.x,z:this.p.pos.z}}this.turnOrder=t.turnOrder.map(t=>this.cs.find(s=>s.id===t)).filter(t=>t),this.currentTurn=t.currentTurn,this.currentActions=t.currentActions,this.combat={participants:[...this.cs,this.p],...t.combat},t.eventLog&&(this.eventLog=t.eventLog)},syncTurnState(){"host"===this.gameMode&&this.send("turn_update",{currentTurn:this.currentTurn,currentActions:this.currentActions,round:this.combat.round,actionType:this.actionType,moveDistance:this.moveDistance,attackCount:this.attackCount})},receiveTurnUpdate(t){"host"!==this.gameMode&&(this.currentTurn=t.currentTurn,this.currentActions=t.currentActions,this.combat&&(this.combat.round=t.round),this.actionType=t.actionType,this.moveDistance=t.moveDistance||0,this.attackCount=t.attackCount||0)},renderLobby(){const t=e.ctx,s=e.w/2,i=e.h/2;if(t.font="48px monospace",t.textAlign="center",t.fillStyle="#ffaa00",t.fillText("Game Lobby",s,i-150),t.font="32px monospace",t.fillStyle="#00ffff",t.fillText("Room Code: "+this.roomCode,s,i-80),t.font="24px monospace",t.fillStyle="#ffffff",t.fillText(`Players Connected: ${this.connectedPlayers}/6`,s,i-40),t.font="20px monospace","host"===this.gameMode)["Start Game (with current players)","Start Game (solo)","Back to Menu"].forEach((e,o)=>{const a=i+20+30*o;t.fillStyle=this.menuSelection===o?"#ffffff":"#888888",t.fillText(e,s,a)});else{t.fillStyle="#cccccc",t.fillText("Waiting for host to start the game...",s,i+20),t.font="16px monospace";const e="Back to Menu";t.fillStyle="#ffffff",t.fillText(e,s,i+60)}t.font="16px monospace",t.fillStyle="#cccccc",t.textAlign="left",t.fillText("Use W/S to navigate",20,e.h-60),t.fillText("ENTER to select",20,e.h-40),t.fillText("Players join with code",20,e.h-20)},generateRoomCode(){let t="";for(let s=0;4>s;s++)t+="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(26*Math.random())];return t},initGame(){this.gameInitialized||(this.gameInitialized=1,this.buildings=[],this.spawnCats(),this.generateCity(1),setTimeout(()=>{const t=this.cs.filter(t=>t&&t.v);t.length>0&&this.startCombat(t)},500))},addEvent(t,s=0){this.eventLog.unshift(t),this.eventLog.length>8&&this.eventLog.pop();const e=s||t.includes("Selected")&&t.includes("action")||t.includes("Choose")||t.includes("No enemies in range")||t.includes("Not enough actions")||/^\d+\)/.test(t);"host"===this.gameMode&&!e&&this.send("event_broadcast",{text:t});const i=document.querySelector("#event-list");if(i){const s=document.createElement("div");for(s.style.color="#00ff00",s.style.marginBottom="2px",s.textContent=t,i.insertBefore(s,i.firstChild);i.children.length>8;)i.removeChild(i.lastChild)}},wrapText(t,s){if(t.length<=s)return[t];const e=t.split(" "),i=[];let o="";return e.forEach(t=>{(o+t).length>s?(o&&i.push(o),o=t):o+=(o?" ":"")+t}),o&&i.push(o),i},showTargetDialog(t,s){this.targetDialog={targets:t,actionType:s},this.addEvent(`Choose target (1-${t.length}):`,1),t.forEach((t,s)=>{this.addEvent(`${s+1}) ${t.c.n} Cat`,1)})},selectTarget(t){if(!this.targetDialog)return;const s=t-1;if(s>=0&&s<this.targetDialog.targets.length){const t=this.targetDialog.targets[s];"attack"===this.targetDialog.actionType?this.executeAttack(t):"cast"===this.targetDialog.actionType&&this.executeCast(t,this.targetDialog.spell),this.targetDialog=null}},setAction(t){this.combat&&this.currentActions>0&&this.turnOrder[this.currentTurn]?.id===this.p.id&&(this.clearTurnTimeout(),this.actionType=t,this.addEvent(`Selected ${t} action`,1),"attack"===t?this.attemptAttack():"cast"===t?this.attemptCast():"heal"===t?this.attemptHeal():"stealth"===t&&this.attemptStealth())},endAction(){this.combat&&this.turnOrder[this.currentTurn]?.id===this.p.id&&("move"===this.actionType&&this.moveDistance>0&&(this.currentActions--,this.addEvent(`Movement ended. ${this.currentActions} actions remaining.`),this.moveDistance=0),this.actionType=null)},attemptAttack(){const t=this.cs.filter(t=>{if(!t.v||t.id===this.p.id)return 0;if(t.isBoss){const s=5,e=Math.floor(this.p.pos.x/s)*s,i=Math.floor(this.p.pos.z/s)*s,o=Math.floor(t.pos.x/s)*s,a=Math.floor(t.pos.z/s)*s,n=2*s;for(let t=o;o+n>t;t+=s)for(let o=a;a+n>o;o+=s){const s=Math.abs(e-t),a=Math.abs(i-o);if(5===s&&0===a||0===s&&5===a||5===s&&5===a)return 1}return 0}{const s=5,e=Math.floor(this.p.pos.x/s)*s,i=Math.floor(this.p.pos.z/s)*s,o=Math.floor(t.pos.x/s)*s,a=Math.floor(t.pos.z/s)*s,n=Math.abs(e-o),h=Math.abs(i-a);return 5===n&&0===h||0===n&&5===h||5===n&&5===h}});if(0!==t.length)if(1===t.length){const s=t[0];this.executeAttack(s)}else this.showTargetDialog(t,"attack");else{const t=this.cs.filter(t=>t.v&&t.id!==this.p.id);if(t.length>0){const s=t[0],e=Math.abs(s.pos.x-this.p.pos.x),i=Math.abs(s.pos.z-this.p.pos.z);this.addEvent(`No enemies in range for attack (nearest: dx=${e}, dz=${i})`,1)}else this.addEvent("No enemies in range for attack",1)}},executeAttack(t){if("host"===this.gameMode){const e=-5*this.attackCount,i=s.k(this.p,t,e);this.currentActions--,this.attackCount++;const o=0>e?` (MAP ${e})`:"",a=`1d20${0>i.atkBonus?""+i.atkBonus:"+"+i.atkBonus} [${i.total}] vs AC ${i.targetAC}`;if(i.h){const s=`1d6${0>i.strMod?""+i.strMod:"+"+i.strMod} [${i.d}]`;this.addEvent(`Claw attack${o}: ${a} HIT for ${s} damage`),t.v||this.addEvent(t.c.n+" is defeated!")}else this.addEvent(`Claw attack${o}: ${a} MISS`);this.syncGameState()}else this.currentActions--,this.attackCount++,this.send("player_attack",{targetId:t.id,playerId:this.p.id,currentActions:this.currentActions,attackCount:this.attackCount});this.turnOrder.filter(t=>t.v).length>1?this.currentActions>0||(this.actionType=null):this.endCombat()},attemptCast(){const t=(this.p.c.s||[]).filter(t=>"firebolt"===t||"harm"===t);if(0===t.length)return void this.addEvent("No offensive spells available");const s=t[0],e=this.cs.filter(t=>{if(!t.v||t.id===this.p.id)return 0;const s=t.pos.x-this.p.pos.x,e=t.pos.z-this.p.pos.z;return 30>=Math.sqrt(s*s+e*e)});0!==e.length?1===e.length?this.executeCast(e[0],s):(this.targetDialog={targets:e,actionType:"cast",spell:s},this.addEvent(`Cast ${s} - Choose target (1-${e.length}):`,1),e.forEach((t,s)=>{this.addEvent(`${s+1}) ${t.c.n} Cat`,1)})):this.addEvent("No enemies in spell range (30ft)")},executeCast(t,e){const i=s.spell(this.p,t,e);let o;if(this.currentActions--,i.h){const s=`1d20+${i.atkBonus} [${i.total}] vs AC ${i.targetAC}`;if(o=`${this.p.c.n} ${e}: ${s} HIT for ${i.d} damage (${i.die})`,t.v)"host"===this.gameMode?this.addEvent(o):this.send("event_broadcast",{text:o});else{const s=t.c.n+" is defeated!";"host"===this.gameMode?(this.addEvent(o),this.addEvent(s)):(this.send("event_broadcast",{text:o}),this.send("event_broadcast",{text:s}))}}else if(i.msg)o=`${this.p.c.n} ${e}: ${i.msg}`,"host"===this.gameMode?this.addEvent(o):this.send("event_broadcast",{text:o});else{const t=`1d20+${i.atkBonus} [${i.total}] vs AC ${i.targetAC}`;o=`${this.p.c.n} ${e}: ${t} MISS`,"host"===this.gameMode?this.addEvent(o):this.send("event_broadcast",{text:o})}"host"!==this.gameMode&&this.send("action_update",{playerId:this.p.id,currentActions:this.currentActions}),this.turnOrder.filter(t=>t.v).length>1?this.currentActions>0||(this.actionType=null):this.endCombat()},attemptHeal(){0!==(this.p.c.s||[]).filter(t=>t.startsWith("heal")).length?(this.addEvent("Choose healing spell:",1),this.addEvent("1) Heal (1 action) - 1d8+Wis",1),this.addEvent("2) Greater Heal (2 actions) - 2d8+Wis",1),this.addEvent("3) Mass Heal (3 actions) - 3d8+Wis",1),this.healDialog=1):this.addEvent("No healing spells available")},executeHeal(t){const e=t;if(this.currentActions<e)return void this.addEvent(`Not enough actions (need ${e}, have ${this.currentActions})`);const i="heal"+t,o=s.spell(this.p,null,i);this.currentActions-=e;const a=`${this.p.c.n} ${i}: Healed ${o.heal} HP (${o.msg})`;this.addEvent(a),"host"!==this.gameMode&&(this.send("event_broadcast",{text:a}),this.send("action_update",{playerId:this.p.id,currentActions:this.currentActions})),this.currentActions>0||(this.actionType=null),this.healDialog=0},attemptStealth(){if(!(this.p.c.s||[]).includes("hide"))return void this.addEvent("Stealth not available for this class");const t=s.spell(this.p,null,"hide");this.currentActions--;const e=`${this.p.c.n} Hide: ${t.msg}`;this.addEvent(e),"host"!==this.gameMode&&(this.send("event_broadcast",{text:e}),this.send("action_update",{playerId:this.p.id,currentActions:this.currentActions})),this.currentActions>0||(this.actionType=null)},clearTurnTimeout(){this.turnTimeout&&(clearTimeout(this.turnTimeout),this.turnTimeout=null)},nextTurn(){if(this.clearTurnTimeout(),"host"!==this.gameMode)return;do{this.currentTurn=(this.currentTurn+1)%this.turnOrder.length}while(!this.turnOrder[this.currentTurn].v);this.currentActions=3,this.actionType=null,this.attackCount=0,this.moveDistance=0,0===this.currentTurn&&this.combat.round++;const t=this.turnOrder[this.currentTurn];this.addEvent(t.c.n+"'s turn begins"),this.syncTurnState(),t.isAI&&t.v?setTimeout(()=>this.runAITurn(t),1500):t.v&&(this.turnTimeout=setTimeout(()=>{this.addEvent(t.c.n+"'s turn timed out"),this.nextTurn()},3e4))},runAITurn(t){let i=3,o=0;const a=this.turnOrder.filter(s=>s.v&&s.id!==t.id);if(0===a.length)return void this.endCombat();let n=a[0],h=1/0;if(a.forEach(s=>{if(s.id===t.id)return;const e=s.pos.x-t.pos.x,i=s.pos.z-t.pos.z,o=Math.sqrt(e*e+i*i);h>o&&(h=o,n=s)}),n.id!==t.id){for(;i>0&&t.v;){if(!n.v){const s=this.turnOrder.filter(s=>s.v&&s.id!==t.id);if(0===s.length)return void this.endCombat();n=s[0]}const a=n.pos.x-t.pos.x,h=n.pos.z-t.pos.z,r=Math.sqrt(a*a+h*h);if(5>=r&&n.v){const e=-5*o,a=s.k(t,n,e),h=0>e?` (MAP ${e})`:"",r=`1d20${0>a.atkBonus?""+a.atkBonus:"+"+a.atkBonus} [${a.total}] vs AC ${a.targetAC}`;if(a.h){const s=`1d6${0>a.strMod?""+a.strMod:"+"+a.strMod} [${a.d}]`;this.addEvent(`${t.c.n} claw attack${h}: ${r} HIT for ${s} damage`),n.v||this.addEvent(n.c.n+" is defeated!")}else this.addEvent(`${t.c.n} claw attack${h}: ${r} MISS`);o++,i--,this.syncGameState()}else{if(5>=r)break;{let s=0,o=0;const n=[];Math.abs(a)>Math.abs(h)?n.push({x:a>0?5:-5,z:0},{x:a>0?4:-4,z:0},{x:a>0?3:-3,z:0},{x:a>0?2:-2,z:0},{x:a>0?1:-1,z:0},{x:0,z:h>0?5:-5},{x:0,z:h>0?4:-4},{x:0,z:h>0?3:-3},{x:0,z:h>0?2:-2},{x:0,z:h>0?1:-1}):n.push({x:0,z:h>0?5:-5},{x:0,z:h>0?4:-4},{x:0,z:h>0?3:-3},{x:0,z:h>0?2:-2},{x:0,z:h>0?1:-1},{x:a>0?5:-5,z:0},{x:a>0?4:-4,z:0},{x:a>0?3:-3,z:0},{x:a>0?2:-2,z:0},{x:a>0?1:-1,z:0});for(const e of n){const i=t.pos.x+e.x,a=t.pos.z+e.z;if(!this.occupied(i,a,t)){t.pos.x=i,t.pos.z=a,o=5*(Math.abs(e.x)+Math.abs(e.z)),s=1;break}}if(s){const s=e.objects.findIndex(s=>("cat"===s.type||"boss"===s.type)&&s.catId===t.id);0>s||(e.objects[s].x=t.pos.x,e.objects[s].z=t.pos.z),i--,this.addEvent(`${t.c.n} moves ${o}ft closer. ${i} actions remaining.`),this.syncGameState()}else i--,this.addEvent(t.c.n+" is blocked.")}}}this.turnOrder.filter(t=>t.v).length>1?this.nextTurn():this.endCombat()}else this.nextTurn()},endCombat(){const t=this.turnOrder.filter(t=>t.v),s=this.turnOrder.find(t=>t.isBoss);s&&!s.v?(this.addEvent("üèÜüèÜüèÜ ?????? DEFEATED! The alley is saved!"),this.p&&this.p.v?this.addEvent("You are victorious!"):this.addEvent("You are defeated but witnessed the victory!")):1===t.length?(t[0].isBoss?this.addEvent("üíÄ ?????? reigns supreme! All hope is lost..."):this.addEvent(`üèÜ ${t[0].c.n} wins the battle!`),this.p&&!this.p.v&&this.addEvent("You are defeated!")):0===t.length&&this.addEvent("üíÄ All cats have fallen..."),this.combat=null,this.currentTurn=0,this.currentActions=3,this.actionType=null},render(){e.render(),"splash"===this.s||"menu"===this.s||"lobby"===this.s?this.renderMenuOverlay():this.renderUI()},renderMenuOverlay(){const t=e.ctx;"splash"===this.s?this.renderSplash(t):"menu"===this.s?this.renderGameMenu(t):"lobby"===this.s&&this.renderLobby()},renderSplash(t){t.textAlign="center";const s=e.w/2,i=e.h/2;t.font="36px monospace",t.fillStyle="#00ffff",t.fillText("polyhedron games",s,i-100),t.font="24px monospace",t.fillStyle="#ffffff",t.fillText("presents",s,i-50),t.font="48px monospace",t.fillStyle="#ffaa00",t.fillText("Roll for Mischief",s,i+20),t.font="24px monospace",t.fillStyle="#888888",t.fillText("https://polyhedron.games",s,i+80),t.font="18px monospace",t.fillStyle="#ffffff",t.fillText("SPACE to continue",s,i+140),t.textAlign="left"},renderGameMenu(t){const s=e.w/2,i=e.h/2,o=s-60,a=i+60*this.menuSelection-52;t.font="48px monospace",t.textAlign="left",t.fillStyle="#ffaa00",t.fillText("Roll for Mischief",o,i-100);const n=s-350,h=i-120;this.renderCatSprite(t,n,h,200,"#000000",1),t.font="32px monospace",["Start Game","Join Game"].forEach((e,o)=>{const a=i+60*o-20;t.fillStyle=this.menuSelection===o?"#ffffff":"#888888",t.fillText(e,s+60,a)}),this.renderCatSprite(t,o,a,48,"#ffaa00",0),t.textAlign="left",t.font="16px monospace",t.fillStyle="#cccccc",t.fillText("Use W/S to navigate",20,e.h-60),t.fillText("ENTER to select",20,e.h-40)},renderCatSprite(s,e,i,o,a,n){if(!t.cat)return;const h=t.cat.data,r=t.cat.colors,c=t.cat.size,l=o/c;let d=0;for(let t=0;t<h.length;t++){const o=h[t];if("0"!==o){const t=n&&"0"!==o?"#000000":r[o]||a;if(t){const o=d%c,a=Math.floor(d/c);s.fillStyle=t,s.fillRect(e+o*l,i+a*l,l,l)}}d++}n&&(s.fillStyle="#ffff00",s.fillRect(e+14*l,i+10*l,4*l,3*l),s.fillRect(e+22*l,i+10*l,4*l,3*l))},updateUI(){const t="splash"===this.s||"menu"===this.s||"lobby"===this.s,s=document.querySelector(".stats-panel");s&&(s.style.display=t?"none":"block");const e=document.querySelector(".event-log");e&&(e.style.display=t?"none":"block");const i=document.querySelector(".leaderboard");if(i&&(i.style.display=t?"none":"block"),!t){const t=document.querySelector("#player-stats div");t&&this.p&&(t.innerHTML=`<strong>${this.p.c.n} Cat</strong><br>HP: ${this.p.h}/${this.p.m}<br>AC: ${this.p.a}<br>Pos: (${this.p.pos.x}, ${this.p.pos.z})`);const s=document.querySelector("#leaderboard-list");if(s){const t=this.ws&&1===this.ws.readyState||this.w&&1===this.w.readyState,e=this.cs.filter(t=>t.v).length+(this.p&&this.p.v?1:0);s.innerHTML=t?`Connected: ${e} cats`:"Connecting..."}}},renderUI(){this.updateUI();const s=e.ctx;if(this.combat){const i=120,o=60,a=(e.w-this.turnOrder.length*i)/2,n=10;this.turnOrder.forEach((e,h)=>{const r=a+h*i,c=h===this.currentTurn,l=e.isBoss||"boss"===e.id;if(s.fillStyle=c?"rgba(255,255,0,0.8)":l?"rgba(64,64,64,0.8)":"rgba(0,0,0,0.7)",s.fillRect(r,n,i-2,o),s.strokeStyle=c?"#ffff00":"#666666",s.lineWidth=2,s.strokeRect(r,n,i-2,o),t&&t.cat){const i=30,o=r+5,a=n+5,h=t.cat.size,c=Math.floor(.75*h);for(let n=0;c>n;n++)for(let r=0;h>r;r++){const c=n*h+r,l=t.cat.data[c];if(l&&"0"!==l&&t.cat.colors[l]){let c=t.cat.colors[l];if(e.isBoss||"boss"===e.id)c="#f0a030"===c||"#e09030"===c||"#e06010"===c||"#d06010"===c?"#ffff00":"#000000";else if(e.color&&"#f07010"!==e.color&&null!==e.color)if("#f07010"===c)c=e.color;else{const t=parseInt(e.color.slice(1,3),16),s=parseInt(e.color.slice(3,5),16),i=parseInt(e.color.slice(5,7),16),o=parseInt(c.slice(1,3),16),a=parseInt(c.slice(3,5),16),n=parseInt(c.slice(5,7),16),h=Math.min(255,Math.floor(t*(o/240))),r=Math.min(255,Math.floor(s*(a/112))),l=Math.min(255,Math.floor(i*(n/16)));c=`#${h.toString(16).padStart(2,"0")}${r.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}`}s.fillStyle=c;const d=o+Math.floor(r*i/h),f=a+Math.floor(n*i/h),u=Math.max(1,Math.floor(i/h));s.fillRect(d,f,u,u)}}}s.font="10px monospace";const d="#8B4513"===e.color||"#CD853F"===e.color;if(s.fillStyle=c?"#000000":l||d?"#ffffff":e.color,s.fillText(e.c.n,r+40,n+15),s.fillStyle=c?"#000000":"#ffffff",e===this.p)s.fillText(`HP: ${e.h}/${e.m}`,r+40,n+28),s.fillText("Init: "+e.i,r+40,n+45);else{const t=e.h/e.m;let i="Healthy";t>0?t>.25?t>.5?t>.75||(i="Injured"):i="Bloodied":i="Critical":i="Defeated",s.fillText(i,r+40,n+28),s.fillText("Init: "+e.i,r+40,n+45)}})}if(s.fillStyle="rgba(0,0,0,0.5)",s.fillRect(10,e.h-100,300,90),s.fillStyle="#fff",s.font="12px monospace",this.combat){if(this.showStatBlock&&this.p.v){const t=e.h-250;s.fillStyle="#00ffff",s.fillText(this.p.c.n+" Stats:",20,t),s.fillStyle="#ffffff",s.fillText(`HP: ${this.p.h}/${this.p.m}`,20,t+15),s.fillText("AC: "+this.p.a,20,t+30);const i=Math.floor((this.p.s.S-10)/2),o=Math.floor((this.p.s.D-10)/2),a=Math.floor((this.p.s.C-10)/2),n=Math.floor((this.p.s.I-10)/2),h=Math.floor((this.p.s.W-10)/2),r=Math.floor((this.p.s.H-10)/2);s.fillText(`STR: ${this.p.s.S} (${0>i?"":"+"}${i})`,20,t+45),s.fillText(`DEX: ${this.p.s.D} (${0>o?"":"+"}${o})`,20,t+60),s.fillText(`CON: ${this.p.s.C} (${0>a?"":"+"}${a})`,20,t+75),s.fillText(`INT: ${this.p.s.I} (${0>n?"":"+"}${n})`,20,t+90),s.fillText(`WIS: ${this.p.s.W} (${0>h?"":"+"}${h})`,20,t+105),s.fillText(`CHA: ${this.p.s.H} (${0>r?"":"+"}${r})`,20,t+120);const c=this.p.c.a+i,l="1d6+"+i;s.fillText(`Melee: +${c} (${l})`,180,t+45);const d=this.p.c.s||[];if(d.includes("firebolt")){const e=this.p.c.a+n;s.fillText(`Spell: +${e} (1d10)`,180,t+60)}if(d.includes("harm")){const e=this.p.c.a+h,i="1d8+"+h;s.fillText(`Spell: +${e} (${i})`,180,t+60)}d.includes("hide")&&s.fillText("Stealth: +"+o,180,t+75)}const t=this.turnOrder[this.currentTurn];if(t===this.p&&this.p.v){s.fillStyle="#00ff00";const t=`Actions: ${this.currentActions}/3`;s.fillText(t,20,e.h-80);const i=s.measureText(t).width;for(let t=0;3>t;t++)s.fillStyle=t<this.currentActions?"#00ff00":"#666666",s.beginPath(),s.arc(30+i+15*t,e.h-85,4,0,2*Math.PI),s.fill();s.fillStyle="#00ff00";const o="move"===this.actionType?`Mode: ${this.actionType} (${this.moveDistance}/25ft)`:"Mode: "+(this.actionType||"None");s.fillText(o,20,e.h-65);const a=this.p.c.s||[];let n="M=Move, X=Attack";(a.includes("firebolt")||a.includes("harm"))&&(n+=", C=Cast"),a.some(t=>t.startsWith("heal"))&&(n+=", H=Heal"),a.includes("hide")&&(n+=", Z=Stealth");const h="M=Move, X=Attack, T=Stats";s.fillText(h,20,e.h-50);const r=n.replace("M=Move, X=Attack","").trim();r&&s.fillText(r.substring(2),20,e.h-35),s.fillText("Space=End Turn",20,e.h-20)}else s.fillStyle="#ffff00",s.fillText(t.c.n+"'s Turn",20,e.h-80),s.fillStyle="#fff",this.p.v?s.fillText("Waiting for enemy...",20,e.h-65):(s.fillStyle="#ff0000",s.fillText("You are defeated!",20,e.h-65),s.fillText("Watching remaining combat...",20,e.h-50))}else s.fillText("WASD: Camera",20,e.h-80),s.fillText("Mouse: Look",20,e.h-65),s.fillText("Scroll: Zoom",20,e.h-50),s.fillText("Arrows: Move",20,e.h-35),s.fillText("I: Isometric",20,e.h-20)}};document.addEventListener("DOMContentLoaded",()=>{window.G=i,i.init()})</script>