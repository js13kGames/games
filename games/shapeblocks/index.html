<!doctype html><title>ShapeBlocks - js13kGames 2012</title><style>html{height:100%;width:100%}body{margin:0;padding:0;height:100%;width:100%;overflow:hidden}#menu{height:10%;background:url(tile.jpg);font-family:arial helvetica san-serif;font-size:20px;padding-top:10px;text-align:center;font-weight:700;color:#555}#game{height:90%;margin:0;padding:0;background:url(tile2.jpg)}canvas{margin:0;padding:0}.left{float:left}.right{float:right}</style><div id=menu>Level:<span id=level>1</span> | Score: <span id=score>0</span> | Time:<span id=timer>0</span></div><div id=game><canvas></canvas></div><div id=overlay class=hide></div><script>function e(){var e=null,t=null;this.grid=[],this.childNodes={},this.getCoordsFromCell=function(t,i){return[t*e,i*e]},this.getCellFromCoords=function(t,i){return[Math.floor(i/e),Math.floor(t/e)]},this.setboundSize=function(e){t=e},this.setgridSize=function(t){e=t},this.resetGrid=function(){this.generateGrid(e,t)}}function t(e){this.color=e.color||S.utils.getRandomColor(),this.position=e.position||[0,0],this.size=e.size,this.shape=null,this.cachedShape=null,this.visible=!0,this.generateShape()}function i(e){return[e.clientX-d.offsetLeft,e.clientY-d.offsetTop]}function n(e,t){for(var i,n,o,r=null;null===r;)i=t[0]-e,n=t[1]-e,i=Math.round(Math.random()*i),n=Math.round(Math.random()*n),o=g.getCellFromCoords(i,n),r=0===g.getCell(o[0],o[1]).length||null;return o}function o(e,t){v.addShape(e),g.addObject(e,t[0],t[1]),e.position=g.getCoordsFromCell(t[1],t[0])}var r,a,s,h,l,c,d,u,f,m,g,v,p,S,M,b=(r=this).requestAnimationFrame||r.webkitRequestAnimationFrame||r.mozRequestAnimationFrame||r.oRequestAnimationFrame||r.msRequestAnimationFrame||function(e){r.setTimeout(e,1e3/60)};r.requestAnimFrame=b,c=(a=document.getElementsByTagName("canvas")[0]).getContext("2d"),s=Math.PI/180,S={canvas:a,ctx:c,cleanCanvas:function(){a.width=a.width},utils:{getGridSize:function(e,t){var i=t[0]>t[1]?t[0]:t[1];return Math.floor(i/Math.ceil(i/Math.floor(Math.sqrt(t[0]*t[1]/e))))},gcd:function(e,t){var i=S.utils.gcd;return 0===t?e:i(t,e%t)},lcd:function(e,t){return e*t/S.utils.gcd(e,t)},getRandomColor:function(){for(var e=[],t=[255,255,255],i=0;i<3;i++)e[i]=Math.round((Math.floor(256*Math.random())+t[i])/2);return"rgb("+e[0]+","+e[1]+","+e[2]+")"},getRandomPoints:function(e,t,i){var n=Math.floor(Math.cos(t*s)*i);t=Math.floor(Math.sin(t*s)*i);return[e[0]+n,e[1]+t]},getRandomPolygonPoints:function(e,t,i){for(var n=[],o=[],r=0;r<i;r++)n[n.length]=Math.floor(361*Math.random());n.sort(function(e,t){return e-t});for(var a=0,s=n.length;a<s;a++)o[o.length]=S.utils.getRandomPoints(e,n[a],t);return o},getFullScreen:function(){},matchProbability:function(e){var t=Math.random,i=Math.ceil;return i(t()*i(100/e))===i(100/e)},getInt:function(e){return parseInt(e,10)}}},e.prototype={generateGrid:function(e,t){for(var i=[],n=Math.floor(t[0]/e),o=Math.floor(t[1]/e),r=0;r<o;r++){i[r]=[];for(var a=0;a<n;a++)i[r][a]={}}this.grid=i},addObject:function(e,t,i){if(void 0===e.id)throw new Error("WorldGrid.addObject: Object must have an ID.");e.id in this.childNodes?this.updateObject(e.id,t,i):(this.childNodes[e.id]={row:t,col:i,node:e},this.grid[t][i][e.id]=this.getObject(e.id))},updateObject:function(e,t,i){this.childNodes[e].col=i,this.childNodes[e].row=t,this.removeObject(e),this.grid[t][i][e]=this.getObject(e)},removeObject:function(e,t){var i=this.childNodes[e];delete this.grid[i.row][i.col][e],t&&delete this.childNodes[e]},getObject:function(e){return this.childNodes[e].node},getCell:function(e,t){var i=!1;if(void 0!==this.grid[e]&&void 0!==this.grid[e][t]){i=[];var n,o=this.grid[e][t];for(n in o)o.hasOwnProperty(n)&&(i[i.length]=n)}return i}},t.prototype={clone:function(){var e,t={};for(e in this)t[e]=this[e];return t},generateShape:function(){var e=document.createElement("canvas"),t=e.getContext("2d"),i=this.size,n=i/2;null===this.shape&&(this.shape=S.utils.getRandomPolygonPoints([n,n],n,Math.floor(6*Math.random())+5)),e.height=i,e.width=i,t.fillStyle=this.color,t.strokeStyle=this.color,t.beginPath(),t.moveTo(this.shape[0][0],this.shape[0][1]);for(var o=1,r=this.shape.length;o<r;o++)t.lineTo(this.shape[o][0],this.shape[o][1]);t.closePath(),t.stroke(),t.fill(),this.cachedShape=e},draw:function(){this.visible&&S.ctx.drawImage(this.cachedShape,this.position[0],this.position[1],this.size,this.size)}},c=document.getElementById("game"),d=S.canvas,S.ctx,u={level:document.getElementById("level"),score:document.getElementById("score"),timer:document.getElementById("timer")},f={canvasSize:[c.offsetWidth,c.offsetHeight],numOfItems:2,itemSize:null,whiteSpace:.3,scorePoints:9,levelIncrementShape:2,gameTimer:30,dropColor:"#555"},m={},g=new e,v=new function(){var e=[],t={},i=0;this.running=!1,this.getPoolSum=function(){return e.length},this.addShape=function(n,o){return n.id=n.id||"ID_"+ ++i,o?e.splice(o,1,n.id):e[e.length]=n.id,(t[n.id]=n).id},this.removeShape=function(i){var n=!1,o=i;if(o){for(var r=e.length;0<=r;r--)if(e[r]===t[o].id){n=t[e[r]],e.splice(r,1);break}}else n=t[e.pop()];return n},this.mainloop=function(){S.cleanCanvas();for(var i=0,n=e.length;i<n;i++)t[e[i]].draw()},this.stopMainLoop=function(){this.running=!1},this.start=function(){this.running=!0;var e=this;!function t(){b(t),e.running&&e.mainloop()}()}},p=new function(){var e=!1,t=!1,i=0,n=[0,0];this.matchId=!1,this.show=function(){t=!0},this.hide=function(){t=!1},this.updateSize=function(e){i=e},this.getSize=function(){return i},this.updateShape=function(t){e=t},this.updatePosition=function(e){n=e},this.draw=function(){t&&e&&S.ctx.drawImage(e,n[0],n[1],i,i)}},d.width=f.canvasSize[0],d.height=f.canvasSize[1],d.addEventListener("mousedown",function(e){var t;e.preventDefault(),e.stopPropagation(),p.cachedShape||(e=i(e),t=g.getCellFromCoords(e[0],e[1]),(t=!(!(t=g.getCell(t[0],t[1]))||!t.length)&&g.getObject(t[0]))&&!t.matchId&&t.visible&&(t.visible=!1,p.matchId=t.id,p.show(),p.updateSize(t.size),p.updatePosition([e[0]-t.size/2,e[1]-t.size/2]),p.updateShape(t.cachedShape))),d.dragging=!0},!1),d.addEventListener("mouseup",function(e){e.preventDefault(),e.stopPropagation(),e=i(e),e=g.getCellFromCoords(e[0],e[1]),(e=!(!(e=g.getCell(e[0],e[1]))||!e.length)&&g.getObject(e[0]))&&e.matchId&&e.matchId===p.matchId?(e.visible=!1,m.Shapes+=1,m.currentShapes+=1,m.score+=f.scorePoints,u.score.innerHTML=m.score,m.currentShapes===m.TotalLevelShapes&&l.levelUp()):p.matchId&&(g.getObject(p.matchId).visible=!0),p.hide(),p.matchId=!1,d.dragging=!1},!1),d.addEventListener("mousemove",function(e){var t,i;d.dragging&&(t=p.getSize(),i=e.clientX-d.offsetLeft-t/2,e=e.clientY-d.offsetTop-t/2,p.updatePosition([i,e]))},!1),M=l={init:function(){m={Shapes:0,score:0,level:1,currentShapes:0,TotalLevelShapes:f.numOfItems},l.start(),h=r.setInterval(function(){var e=u.timer,t=S.utils.getInt(e.innerHTML)-1;(e.innerHTML=t)<=0&&(clearTimeout(h),h=null,l.gameOver())},1e3),v.start()},getStats:function(){return m},start:function(e){var i=(e=e||{}).numOfItems||f.numOfItems,r=e.gridSize||f.canvasSize,a=S.utils.getGridSize(2*i*(1+f.whiteSpace),r),s=[];if(u.timer.innerHTML=f.gameTimer,p.id&&v.removeShape(p.id),0!==v.getPoolSum())for(;v.getPoolSum();)s.push(v.removeShape());if(g.setboundSize(r),g.setgridSize(a),g.resetGrid(),s.length)for(var h=0,l=s.length,c=2*i;h<c&&h<l;h++)s[h].visible=!0,s[h].size=a,o(s[h],n(a,r));if(0<(e=i-s.length/2))for(var d,m,M=(i={bounds:r,size:a,num:e}).bounds,b=i.size,z=i.num,I=0;I<z;I++)m=(d=new t({size:b})).clone(),o(d,n(b,M)),o(m,n(b,M)),m.matchId=d.id,m.color=f.dropColor,m.generateShape();v.addShape(p)},newGame:function(){window.location=""},gameOver:function(){var e=this.getStats();v.stopMainLoop(),r.confirm("Unfortunetely your time has run out.\nLevel: "+e.level+"\nScore: "+e.score+"\n Would you like to play again ?")&&M.newGame()},levelUp:function(){var e=f,t=m;t.currentShapes=0,t.level+=1,t.TotalLevelShapes+=e.levelIncrementShape,u.level.innerHTML=t.level,u.timer.innerHTML=f.gameTimer,l.start({numOfItems:t.TotalLevelShapes,gridSize:f.canvasSize})}},r.shapeBlocks=M,r.onload=M.init</script>