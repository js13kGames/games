<!doctype html><title>Ninja Tracking - js13kGames 2012</title><style>*{margin:0;padding:0}canvas{-moz-transform:scale(-1,1);-o-transform:scale(-1,1);-webkit-transform:scale(-1,1);filter:FlipH;transform:scale(-1,1)}</style><body><script>!function(t,e){var n=t.document,r=t.navigator,a=Object.prototype.hasOwnProperty,i=Array.prototype.slice,o={type:{},all:function(t,e){return Array.prototype.slice.call((e||n).querySelectorAll(t))},augment:function(t,e){function n(){e.apply(this,arguments),t.apply(this,arguments)}function r(){}return r.prototype=e.prototype,n.superclass=e.prototype,n.prototype=new r,n.prototype.constructor=n,o.merge(n.prototype,t.prototype),n},bind:function(t,n,r){var a=this;return r!==e&&(r=i.call(arguments,2)),function(o){return o!==e&&(o=i.call(arguments),r!==e&&(o=o.concat(r))),t.apply(n||a,o||r)}},forEach:function(t,e,n){var r;if(Array.isArray(t))t.forEach((function(){e.apply(n||this,arguments)}));else for(r in t)a.call(t,r)&&e.call(n||t,t[r],r,t);return t},isNode:function(t){return t.nodeType||this.isWindow(t)},isString:function(t){return"string"==typeof t},isWindow:function(t){return!!(t&&t.alert&&t.document)},merge:function(t,e){var n;for(n in e)a.call(e,n)&&(t[n]=e[n]);return t},one:function(t,e){return this.isNode(t)?t:(e||n).querySelector(t)}};o.math={distance:function(t,e,n,r){var a=n-t,i=r-e;return Math.sqrt(a*a+i*i)}};var s=function(){this.attrs_={}};s.prototype={attrs_:null,setAttrs:function(t,e){var n=this;o.forEach(t,(function(t,r){e?n.attrs_[r]=t:n.set(r,t)}))},set:function(t,e){var n=this,r=n[t+"Change_"];return n.attrs_[t]=e,r&&r.call(n,e,t),e},get:function(t){return this.attrs_[t]},getAttrs:function(){return this.attrs_},linkAttr:function(t,e,n){var r=this,a=t+"Change_",i=r[a];r[a]=function(n){i&&i.apply(this,arguments),e.set(t,n)},n&&e.set(t,r.get(t))}},o.Attribute=s;var c=function(t){this.setAttrs(o.merge({height:240,visible:!0,width:320},t),!0)};c.prototype={domElement:null,heightChange_:function(t){this.domElement.height=t},hide:function(){return this.set("visible",!1),this},render:function(t){var e=this;return e.heightChange_(e.get("height")),e.visibleChange_(e.get("visible")),e.widthChange_(e.get("width")),o.one(t||n.body).appendChild(e.domElement),e},show:function(){return this.set("visible",!0),this},visibleChange_:function(t){this.domElement.style.display=t?"block":"none"},widthChange_:function(t){this.domElement.width=t}},o.DomElement=o.augment(c,o.Attribute);var u=function(t){this.createCanvas_()};u.prototype={context:null,createCanvas_:function(){var t=n.createElement("canvas");this.domElement=t,this.context=t.getContext("2d")},getImageData:function(t,e,n,r){var a=this,i=t||0,o=e||0,s=n||a.get("width"),c=r||a.get("height");return a.context.getImageData(i,o,s,c)},setImageData:function(t,e,n){var r=e||0,a=n||0;return this.context.putImageData(t,r,a),this},forEach:function(t,e,n){var r,a=t.width,i=t.height,o=t.data,s=0,c=0;for(s=0;s<i;s++)for(c=0;c<a;c++)r=s*a*4+4*c,e.call(this,o[r],o[r+1],o[r+2],o[r+3],r,s,c)},toDataURL:function(t){return this.domElement.toDataURL(t||"image/png")},transform:function(t){var e=this,n=e.getImageData(),r=e.context.createImageData(n),a=r.data;return e.forEach(n,(function(t,e,n,r,i,o,s){var c=(t+e+n)/3;a[i]=c,a[i+1]=c,a[i+2]=c,a[i+3]=255})),e.setImageData(r),e}},o.Canvas=o.augment(u,o.DomElement);var l=function(t){var e=this;e.setAttrs(o.merge({autoplay:!0,controls:!0},t),!0),e.trackers_={},e.createVideo_(),e.createCanvas_()};l.prototype={canvas:null,trackers_:null,createCanvas_:function(){var t=this;t.canvas=new o.Canvas,t.linkAttr("height",t.canvas,!0),t.linkAttr("width",t.canvas,!0)},createVideo_:function(){var t=this,e=t.get("autoplay"),r=n.createElement("video");r.autoplay=e,r.controls=t.get("controls"),t.domElement=r,e&&t.play()},getVideoCanvasImageData:function(){return this.syncVideoCanvas(),this.canvas.getImageData()},load:function(){var t=this.domElement;return t.load.apply(t,arguments),this},loop_:function(){var t,e=this,n=e.trackers_;o.forEach(n,(function(n,r){(t=o.type[r]).track&&t.track(n,e)})),Object.keys(n).length&&requestAnimationFrame((function(){e.loop_()}))},pause:function(){var t=this.domElement;return t.pause.apply(t,arguments),this},play:function(){var t=this.domElement;return t.play.apply(t,arguments),this},renderVideoCanvas:function(t){var e=this;return e.syncVideoCanvas(),o.one(t||n.body).appendChild(e.canvas.domElement),e},srcChange_:function(t){this.domElement.src=t},stopTracking:function(){this.trackers_={}},syncVideoCanvas:function(){var t=this,e=t.domElement,n=t.get("width"),r=t.get("height");return e.readyState===e.HAVE_ENOUGH_DATA&&t.canvas.context.drawImage(t.domElement,0,0,n,r),t},toDataURL:function(t){return this.syncVideoCanvas(),this.canvas.toDataURL(t)},track:function(t){var e=o.type[t.type.toUpperCase()],n=this.trackers_;if(!e)throw Error("A tracker type should be specified.");n[e.NAME]||(n[e.NAME]=[]),n[e.NAME].push(t),1===Object.keys(n).length&&this.loop_()}},o.Video=o.augment(l,o.DomElement);var h=function(t){this.setAttrs(o.merge({audio:!0},t),!0),this.initUserMedia_()};h.prototype={initUserMedia_:function(){var t=this;r.getUserMedia(r.mozGetUserMedia?{video:!0}:{audio:t.get("audio"),video:!0},o.bind(t.defSuccessHandler_,t),o.bind(t.defErrorHandler_,t))},defSuccessHandler_:function(t){try{this.set("src",URL.createObjectURL(t))}catch(e){this.set("src",t)}},defErrorHandler_:function(t){throw Error(t)}},o.VideoCamera=o.augment(h,o.Video),self.Int32Array||(self.Int32Array=Array,self.Float32Array=Array),t.URL||(t.URL=t.URL||t.webkitURL||t.msURL||t.oURL),r.getUserMedia||(r.getUserMedia=r.getUserMedia||r.webkitGetUserMedia||r.mozGetUserMedia||r.msGetUserMedia),function(){var e,n=0,r=["ms","moz","webkit","o"];for(e=0;e<r.length&&!t.requestAnimationFrame;++e)t.requestAnimationFrame=t[r[e]+"RequestAnimationFrame"],t.cancelAnimationFrame=t[r[e]+"CancelAnimationFrame"]||t[r[e]+"CancelRequestAnimationFrame"];t.requestAnimationFrame||(t.requestAnimationFrame=function(e,r){var a=(new Date).getTime(),i=Math.max(0,16-(a-n)),o=t.setTimeout((function(){e(a+i)}),i);return n=a+i,o}),t.cancelAnimationFrame||(t.cancelAnimationFrame=function(t){clearTimeout(t)})}(),t.tracking=o}(window),function(t,e){var n=tracking.isString,r=tracking.math.distance;tracking.type.COLOR={NAME:"COLOR",defaults:{color:"magenta",minFoundPixels:30},cyan:function(t,e,n){var r=t-0,a=e-255,i=n-255;return e-t>=50&&n-t>=50||Math.sqrt(r*r+a*a+i*i)<80},magenta:function(t,e,n){var r=t-255,a=e-0,i=n-255;return t-e>=50&&n-e>=50||Math.sqrt(r*r+a*a+i*i)<140},findCoordinates_:function(t,e){var n,r,a,i=0,o=0,s=0,c=1/0,u=1/0,l=-1,h=-1;for(a=0;a<e;a+=2)n=t[a],r=t[a+1],n>-1&&r>-1&&(i+=n,o+=r,s++,n<c&&(c=n),n>l&&(l=n),r<u&&(u=r),r>h&&(h=r));return{x:i/s,y:o/s,z:60-(l-c+(h-u))/2}},flagOutliers_:function(t,e){var n,a,i;for(a=0;a<e;a+=2){for(n=0,i=2;i<e;i+=2)n+=r(t[a],t[a+1],t[i],t[i+1]);n/e>30&&(t[a]=-1,t[a+1]=-1,e[a]--)}},track:function(t,e){var r,a,i,o,s=this,c=s.defaults,u=[],l=[];for(e.canvas.forEach(e.getVideoCanvasImageData(),(function(e,i,h,d,f,m,g){for(a=-1;r=t[++a];)l[a]||(u[a]=0,l[a]=[]),o=r.color||c.color,n(o)&&s.hasOwnProperty(o)&&(o=s[o]),o(e,i,h,d,f,m,g)&&(u[a]+=2,l[a].push(g,m))})),a=-1;r=t[++a];)u[a]<=c.minFoundPixels?r.onNotFound&&r.onNotFound.call(e,i):(s.flagOutliers_(l[a],u[a]),(i=s.findCoordinates_(l[a],u[a])).pixels=l[a],r.onFound&&r.onFound.call(e,i))}}}(window),function(t){function e(t,e){this.x=t[0],this.y=210,this.clockwise=this.x<n.CANVAS_WIDTH/2?1:-1,this.speedX=t[1],this.speedY=t[2],this.bomb=e,this.image=e?"bomb.png":"ninja.png",this.rotation=0,this.height=30,this.width=e?41:32,this.tick=1}var n={CANVAS_HEIGHT:240,CANVAS_WIDTH:320,GRAVITY:.001,MAX_WAVES:5,ROTATION_ANGLE:Math.PI/12,TRACKING_COLOR:"magenta",POSITIONS:[[20,5,7],[30,4,8],[40,3,9],[50,1,5],[100,2,10],[140,1,9],[150,3,9],[65,1.5,8.3],[82,7.5,2],[155,.7,9.4],[94,4.3,4],[105,3.8,7.6],[5,2.7,7.8],[12,7,7]]};e.prototype.move=function(){this.x+=this.speedX*this.clockwise,this.y-=this.speedY-this.speedY*n.GRAVITY*Math.pow(this.tick,2),this.tick++},e.prototype.render=function(){var t=this.x+this.width/2,e=this.y+this.height/2;context.save(),context.translate(t,e),context.rotate(this.rotation),context.translate(-1*t,-1*e);var n=new Image;n.src=this.image,context.drawImage(n,this.x,this.y),context.restore()},e.prototype.rotate=function(){this.rotation=this.rotation+n.ROTATION_ANGLE*this.clockwise};var r={drawSegments:[],fruits:[],context:null,intervalId:0,finished:!1,wave:0,score:0,init:function(){var t=this,e=(new tracking.VideoCamera).hide().render().renderVideoCanvas();context=e.canvas.context,e.track({type:"color",color:n.TRACKING_COLOR,onFound:function(e){t.drawSegments.push(e.x,e.y,(new Date).getTime())},onNotFound:function(){}}),t.loop(),t.intervalId=setInterval(t.fruitWave,5e3)},checkCollision:function(t){var e=r,n=e.drawSegments.length,a=e.drawSegments[n-3],i=e.drawSegments[n-2];return a>t.x&&a<t.x+t.width&&i>t.y&&i<t.y+t.height},gameOver:function(){context.save(),context.scale(-1,1),context.textAlign="center",context.fillStyle="red",context.font="20pt impact",context.fillText("game over",-n.CANVAS_WIDTH/2,n.CANVAS_HEIGHT/2),context.fillText(r.score+" points",-n.CANVAS_WIDTH/2,n.CANVAS_HEIGHT/2+30),context.restore()},renderFruits:function(){for(var t=r,e=t.fruits.slice(0),n=0,a=t.fruits.length;n<a;n++){var i=t.fruits[n];t.drawSegments.length>0&&t.checkCollision(i)?(i.bomb&&t.score>0?t.score--:t.score++,e.splice(n,1)):(i.render(),i.rotate(),i.move())}t.fruits=e},renderScore:function(){context.save(),context.scale(-1,1),context.fillStyle="red",context.font="12pt sans-serif",context.fillText("score "+r.score,-70,230),context.restore()},renderTrail:function(){for(var t=r,e=(new Date).getTime(),n=0,a=0,i=t.drawSegments.length;a<i;a+=3){var o=1-(e-t.drawSegments[a+2])/1e3;o>0&&o<=1?(context.save(),context.fillStyle="rgba(255,255,255,"+o+")",context.fillRect(t.drawSegments[a],t.drawSegments[a+1],4,4),context.restore()):n+=3}n>0&&t.drawSegments.splice(0,n)},fruitWave:function(){var t=r,a=n.POSITIONS.slice(0);t.fruits=[];for(var i=0;i<4;i++){var o=Math.floor(Math.random()*a.length),s=a[o],c=Math.round(Math.random()),u=s[0];c&&(u=n.CANVAS_WIDTH-u);var l=!1;0==i&&(l=!0);var h=new e([u,s[1],s[2]],l);t.fruits.push(h),a.splice(o,1)}t.wave++,r.wave>=n.MAX_WAVES&&(clearInterval(t.intervalId),setTimeout((function(){t.finished=!0}),4e3))},loop:function(){var t=r;t.finished?t.gameOver():(t.renderTrail(),t.renderFruits(),t.renderScore()),requestAnimationFrame(t.loop)}};t.game=r}(window),game.init()</script>