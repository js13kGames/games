<link href=main.css rel=stylesheet><meta name=viewport content="width=device-width,maximum-scale=1.01"><title>Space Jam - js13kGames 2021</title><body class=full><div id=root class="full flex flex-centered fill-absolute"><canvas class=centered id=canvas-pre></canvas><canvas class="centered hide-intro" id=canvas-tiles></canvas><canvas class="centered hide-intro" id=canvas-instruments></canvas><canvas class="centered hide-intro" id=canvas-oscillators></canvas><canvas class="centered hide-intro" id=canvas-audio></canvas><canvas class="centered hide-intro" id=canvas-post></canvas><canvas class="centered hide-intro" id=canvas-stats></canvas><p class=hint id=hint><div class="full centered flex flex-centered" id=menu style=visibility:hidden><h2 id=menu-notes>Notes:</h2><div class="full flex flex-col flex-centered" id=menu-col><h1 id=osh class="mb-2 mt-2">Oscillators</h1><p class="mb-2 text-large">Use oscillators to play instruments<div class=mb-5 class="flex flex-centered"><div id=os class=flex></div></div><h1 id=inh class=mb-2>Instruments</h1><p class="mb-2 text-large" style=width:50%>Use instruments to emit sounds and collect additional notes<div class=full class="flex flex-centered"><div id=dr class="flex flex-row flex-centered"><p class=row-label>Drums</div><div id=bs class="flex flex-row flex-centered"><p class=row-label>Basic Synths</div><div id=cs class="flex flex-row flex-centered"><p class=row-label>Complex Synths</div></div></div></div><div class="flex centered flex-centered" id=inspect style=visibility:hidden><div id=inner-inspect class="full flex flex-centered flex-col"><button id=close-inspect>✖</button><h1 class=mb-2 id=inspect-name>SnareSound</h1><div class="flex flex-centered"><p>Cost: <p class=pink id=inspect-cost>50</div><div class="flex flex-centered mb-2"><p>Notes produced: <p class=green id=inspect-notes>50</div><button class="flex flex-centered mb-2" id=sell-button><p>Sell for <p class=green id=inspect-sell>50</button></div></div><button class="mb-5 hide-intro" id=menu-button>✖</button><div id=intro class="full flex flex-col flex-centered fill-absolute"><h1 id=title class=mb-2>SPACE JAM</h1><p class=text-lg>You are the first to reach the planet Mixolydia,<p class="text-lg mb-2">where the only resource is sound...<p class="text-lg mb-5">What will you make of this new frontier?<div class=flex><button disabled id=start>Start</button></div></div></div><div id=templates class=hidden><div class="flex flex-col flex-centered m-1"><p class=mb-half></p><button class=entity-button><canvas class=full></canvas></button><div class=flex><span class="item-stats pink"></span><span class=item-stats> </span><span class="item-stats green"></span></div></div></div><script>(()=>{"use strict";var t={d:(e,s)=>{for(var i in s)t.t(s,i)&&!t.t(e,i)&&Object.defineProperty(e,i,{i:!0,get:s[i]})},t:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};t.d({},{a:()=>Yt});const e="rgba(0,0,0,0)",s="#FFFFFF",i="#272838",n="#ff4c7a",o="#00e19e",r="#B0C4DE",h={root:document.getElementById("root"),h:document.getElementById("canvas-tiles"),o:document.getElementById("canvas-pre"),u:document.getElementById("canvas-post"),l:document.getElementById("canvas-audio"),p:document.getElementById("canvas-stats"),m:document.getElementById("canvas-oscillators"),v:document.getElementById("canvas-instruments"),M:document.getElementById("menu"),g:document.getElementById("menu-button"),q:document.getElementById("menu-col"),k:document.getElementById("menu-notes"),hint:document.getElementById("hint"),T:document.getElementById("inspect"),A:document.getElementById("inner-inspect"),O:document.getElementById("close-inspect"),$:document.getElementById("inspect-name"),F:document.getElementById("inspect-cost"),S:document.getElementById("inspect-notes"),B:document.getElementById("inspect-sell"),P:document.getElementById("sell-button"),R:document.getElementById("intro"),start:document.getElementById("start")},a={C:h.h?.getContext("2d"),U:h.o?.getContext("2d"),L:h.u?.getContext("2d"),N:h.p?.getContext("2d"),j:h.l?.getContext("2d"),X:h.m?.getContext("2d"),Y:h.v?.getContext("2d")},c=2*Math.PI;class l{constructor({type:t,H:e=!1}={}){this.type=t,this.H=e}}class u{constructor(t=0,e=0){this.x=t,this.y=e}set(t,e){this.x=t,this.y=e}I(){return this.x+this.y}}const d=new class{constructor(t){this.canvas=t}V(t){return this.canvas.width*((t+1)/2)}D(t){return this.canvas.height*((t+1)/2)}width(t=1,e=!1){return this.canvas.width*t/(e?window.devicePixelRatio:1)}height(t=1,e=!1){return this.canvas.height*t/(e?window.devicePixelRatio:1)}}(h.h),p=t=>t-63,m=t=>t-63,y=t=>t+63,v=t=>t+63,f=t=>d.width(.5)+(t-W.position.x)*d.width(.06)-d.width(.03),w=t=>d.height(.5)+(W.position.y-t)*d.width(.06)-d.width(.03),g=t=>void 0===t,x=t=>{t.width=t.clientWidth*window.devicePixelRatio||1,t.height=t.clientHeight*window.devicePixelRatio||1},b=(t,e,s)=>Math.max(e,Math.min(t,s)),E=(t,e,s)=>t*s+e*(1-s),T=t=>{const e=t/1e6;if(e>1)return e.toFixed(2)+"M";const s=t/1e3;return s>1?s.toFixed(2)+"K":t+""},M=t=>new Float32Array(t),S=()=>Math.random(),q=(t,e,s=A.context.currentTime)=>{e&&e.forEach((({value:e,time:i,exp:n=!1})=>{n?t.exponentialRampToValueAtTime(e,s+i):t.linearRampToValueAtTime(e,s+i)}))},C=t=>{let e;return e=t>0?2:.5,V*Math.pow(Math.pow(e,1/12),Math.abs(t))},B=(t=A.context,e,s,i)=>{const n=t.createBiquadFilter();return n.frequency.value=s,n.type=e,i&&n.connect(i),n},k=t=>{const e=b((t.position.x-W.position.x)/7,-1,1),s=b((t.position.y-W.position.y)/7,-1,1),i=Math.sqrt(e**2+s**2);t.K.pan.pan.value=e,t.K.J(Math.abs(e)),t.K.G(b(1-i,0,1))},L=(t,e=256)=>{const s=100*t,i=new Float32Array(e),n=Math.PI/180;for(let t=0;t<e;t++){let o=2*t/e-1;i[t]=(3+s)*o*20*n/(Math.PI+s*Math.abs(o))}return i};class R{constructor(){this.context=new(window.AudioContext||window.webkitAudioContext)({sampleRate:44100}),this.context.suspend(),this.W=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(2,88200,44100),this.Z=this.context.createAnalyser(),this.Z.fftSize=64,this._=new Uint8Array(this.Z.frequencyBinCount),this.tt=this.context.createDynamicsCompressor(),this.tt.threshold.value=-24,this.tt.knee.value=24,this.tt.ratio.value=12,this.tt.attack.value=0,this.tt.release.value=.25,this.st=this.context.createGain(),this.st.connect(this.Z),this.Z.connect(this.context.destination),this.et=this.context.createConvolver(),this.et.connect(this.st)}async init(){const t=await this.it();this.et.buffer=t,this.et.connect(this.st)}async it(){return new Promise((t=>{const e=this.W.createGain();e.connect(this.W.destination),e.gain.setValueAtTime(1,0),e.gain.exponentialRampToValueAtTime(1e-4,2);const s=B(this.W,"lowpass",5e3,e),i=B(this.W,"highpass",500,s),n=this.W.createBufferSource();n.buffer=(t=>{const e=88200,s=M(e),i=M(e);for(let t=0;t<e;t++)s[t]=1-2*S(),i[t]=1-2*S();const n=A.context.createBuffer(2,e,44100);return n.getChannelData(0).set(s),n.getChannelData(1).set(i),n})(),n.connect(i),n.start(),this.W.startRendering(),this.W.oncomplete=e=>{t(e.renderedBuffer)}}))}}R.nt=196,R.ht=2,R.ot=44100;const P=[0,4,5,7,10],A=new R,N=new class{constructor(){this.rt=[],this.ct=0}at(t,e){this.ct++;const s=this.ct,i=A.context.createBuffer(1,1,44100),n=A.context.createBufferSource();return n.buffer=i,n.connect(A.context.destination),this.rt.push({id:s,time:t,type:"single",source:n}),n.onended=()=>{e(),this.cancel(s)},n.start(t-i.duration),s}ut(t){t.count++;const e=A.context.createBufferSource();e.buffer=t.source.buffer,e.connect(A.context.destination),e.onended=()=>{t.lt(),this.ut(t)},e.start(t.time+t.count*t.frequency-e.buffer.duration),t.source=e}dt(t,e,s){const i=A.context.createBuffer(1,1,44100),n=A.context.createBufferSource();n.buffer=i,n.connect(A.context.destination);const o={id:++this.ct,count:0,time:t,frequency:e,type:"repeating",lt:s,source:n};return n.onended=()=>{s(),this.ut(o)},n.start(Math.max(0,t-i.duration)),this.rt.push(o),o.id}wt(t){return this.rt.find((e=>e.id===t))}clear(){this.rt.forEach((t=>{t.source.onended=null,t.source.stop(),t.source.disconnect()})),this.rt.length=0}cancel(t){const e=this.wt(t);if(e){e.source.onended=null;try{e.source.stop()}catch(t){}e.source.disconnect(),this.rt=this.rt.filter((t=>t.id!==e.id))}}},V=196,I="Tahoma, sans-serif",X=(t,e,s=!1,i=!0,n=a.C)=>{i&&n.strokeRect(t,e,d.width(.06),d.width(.06)),s&&n.fillRect(t,e,d.width(.06),d.width(.06))},D=t=>{t.beginPath(),t.arc(d.V(0),d.D(0),d.width(.42),0,c),t.clip()},$=(t,e,s)=>{t.save(),t.strokeStyle=e,t.lineWidth=d.width(.2),t.beginPath(),s.forEach((([e,s],i)=>{const n=d.V(e),o=d.D(s);0===i?t.moveTo(n,o):t.lineTo(n,o)})),t.stroke(),t.restore()},J={yt:0,vt:{ft:!1,M:!0,escape:!1},xt:!0,Mt:!1,bt:!1},O={gt:0,qt:0},W=new class extends l{constructor({type:t="camera",coords:e}){super({type:t}),this.coords=e,this.position=new u,this.kt=new u,this.Tt={Et:void 0,At:void 0,Ot:void 0,$t:void 0},this.Ft()}Ft(){const t=Math.round(this.position.x),e=Math.round(this.position.y);this.Tt={Et:Math.max(0,y(t-7)),At:Math.min(126,y(t+7)),Ot:Math.max(0,v(e-7)),$t:Math.min(126,v(e+7))}}St(){this.Ft(),x(h.h),a.C.fillStyle=i,a.C.strokeStyle=s,a.C.lineWidth=d.width(.006),D(a.C),a.C.fillRect(0,0,d.width(),d.height()),W.Bt(((t,e,s)=>{X((t=>f(p(t)))(e),(t=>w(m(t)))(s))}))}Bt(t){for(let e=this.Tt.Et;e<=this.Tt.At;e++)for(let s=this.Tt.Ot;s<=this.Tt.$t;s++)t(F[e][s],e,s)}Pt(){(()=>{if(x(h.p),J.Mt)return;a.N.font=`${d.width(.11249999999999999)}px ${I}`,a.N.fillStyle=s,a.N.textAlign="center";const t="SPACE JAM",e=a.N.measureText(t);a.N.font=`${d.width(.11249999999999999)}px Impact`,a.N.fillText(t,d.V(0),d.D(-.78));const i="Notes: "+T(O.gt);a.N.font=`${d.width(.075)}px ${I}`,a.N.fillText(i,d.V(0),d.D(-.78)+e.actualBoundingBoxAscent);const n=`Camera: (x: ${Math.round(W.position.x)}, y: ${Math.round(W.position.y)})`;a.N.font=`${d.width(.0375)}px ${I}`,a.N.fillText(n,d.V(0),d.D(-.78)+1.75*e.actualBoundingBoxAscent),a.N.textAlign="right";const o="Score: "+T(O.qt);a.N.font=`${d.width(.0375)}px ${I}`;const r=a.N.measureText(o);if(a.N.fillText(o,d.V(.95),d.D(-1)+r.actualBoundingBoxAscent+d.width(.025)),J.vt.M){a.N.lineWidth=d.width(.006),a.N.strokeStyle=s,a.N.beginPath();const t="Main Menu";a.N.fillText(t,d.V(-.45)+a.N.measureText(t).width/2,d.D(.7)),a.N.moveTo(d.V(-.45),d.D(.725)),a.N.quadraticCurveTo(d.V(-.35),d.D(.825),d.V(-.15),d.D(.825)),a.N.moveTo(d.V(-.15),d.D(.825)),a.N.lineTo(d.V(-.2),d.D(.795)),a.N.moveTo(d.V(-.15),d.D(.825)),a.N.lineTo(d.V(-.2),d.D(.855)),a.N.stroke()}})(),this.Bt(((t,e,n)=>{const{Rt:o,state:r}=t;"instrument"===o?.type&&"playing"===r&&((t,e,n,o,r)=>{const h=e.width(.0165);t.fillStyle=i,t.globalAlpha=1,t.beginPath(),t.arc(n,o,h,0,c),t.fill(),t.globalAlpha=1,t.font=`${e.width(.01875)}px ${I}`,t.textAlign="center",t.fillStyle=s;const a="+"+r,l=t.measureText(a);t.fillText(a,n,o+l.actualBoundingBoxAscent/2)})(a.N,this.coords,f(p(e)+.5),w(m(n)-.5),o.Ct)})),x(h.m),a.X.lineCap="round",a.X.lineJoin="round",a.X.lineWidth=d.width(.006),D(a.X),W.Bt((({Rt:t})=>{"oscillator"===t?.type&&t.Pt()})),x(h.v),a.Y.font=`${d.width(.01875)}px ${I}`,a.Y.textAlign="center",a.Y.fillStyle=i,a.Y.strokeStyle=s,a.Y.lineWidth=d.width(.006),a.Y.lineJoin="round",D(a.Y),W.Bt((({Rt:t})=>{"instrument"===t?.type&&t.Pt()})),this.Ut?.Pt()}}({coords:d}),F=Array.from({length:127}).map((()=>Array.from({length:127},Object))),K=new Array(100).fill(null).map((()=>[1-2*Math.random(),1-2*Math.random(),.001*(1+Math.random()),Math.random()*c])),U=new Array(2).fill(null).map((()=>new Array(10).fill(null).map(((t,e)=>[.5-Math.random(),2.2*e/9-1.1]))));class H extends l{constructor(t={}){super(t);const{x:e,y:s,Lt:i=!1,id:n=""}=t;this.id=n,this.Lt=i,this.position=new u(e,s),this.Nt=0,this.jt=r}}class Y extends H{constructor(t){super(t),this.type="instrument",this.color=o}init(){this.Xt=(t=>{let e=0,s=0,i=0,n=0;return t.forEach((t=>{const[o,r]=t;o<e&&(e=o),o>i&&(i=o),r<s&&(s=r),r>n&&(n=r)})),{Yt:e,Ht:i,It:s,Vt:n}})(this.outline),this.shape=((t,e,s)=>{const{Yt:i,Ht:n,It:o,Vt:r}=s,h=[],a=new Path2D;((t,e)=>{for(let s=0;s<e.length;s++){const[i,n]=e[s];0===s?t.moveTo(i,n):t.lineTo(i,n)}})(a,e);for(let e=i;e<n;e++)for(let s=o;s<r;s++)t.isPointInPath(a,e+.5,s+.5)&&h.push([e,s+1]);return h})(a.Y,this.outline,this.Xt),this.zt=this.Xt.Ht-this.Xt.Yt,this.Qt=this.Xt.Vt-this.Xt.It,this.Lt||this.Dt(),this.Kt=Math.round(this.Jt/3),k(this)}Gt(){const{Et:t,At:e,Ot:s,$t:i}=W.Tt,{x:n,y:o}=this.position,r=y(n),h=v(o),a=F[r][h],c=r>t&&r<e&&h>s&&h<i,l=Boolean(a.Rt),u=a.Wt||!1,d=this.shape.some((([t,e])=>F[r+t][h+e].Wt||Boolean(F[r+t][h+e].Rt)));return c&&!l&&!u&&!d}Dt(){this.Lt=!1;const t=y(this.position.x),e=v(this.position.y);F[t][e].Rt=this,this.shape.forEach((([s,i])=>{F[t+s][e+i].Wt=!0}))}Zt(){const t=y(this.position.x),e=v(this.position.y);F[t][e]=new Object,this.shape.forEach((([s,i])=>{F[t+s][e+i].Wt=!1}));for(let s=t-1;s<=t+1;s++)for(let t=e-1;t<=e+1;t++){const e=F[s][t];"oscillator"===e?.Rt?.type&&e.Rt._t()}}Pt(t=a.Y,e=!0){t.save(),t.beginPath();for(let e=0;e<this.outline.length;e++){const[s,i]=this.outline[e],n=f(this.position.x+s),o=w(this.position.y+i);0===e?t.moveTo(n,o):t.lineTo(n,o)}t.closePath(),t.clip();const{Yt:n,Vt:h}=this.Xt,l=d.width(.06)*this.Qt,u=d.width(.06)*this.zt,p=f(this.position.x+n),m=w(this.position.y+h),y=t.createLinearGradient(p,m,p+u,m+l);if(y.addColorStop(0,o),y.addColorStop(1,"#00f9ff"),t.fillStyle=this.disabled?r:y,t.fillRect(p,m,u,l),t.stroke(),e){const e=f(this.position.x+.5),n=w(this.position.y-.5);t.fillStyle=s,t.beginPath(),t.arc(e,n,d.width(.015),0,c),t.fill(),t.fillStyle=i;const o=this.display.substr(0,1),r=t.measureText(o);t.fillText(this.display.substr(0,2),e,n+r.actualBoundingBoxAscent/2)}t.restore()}}class j{constructor(t={}){this.note=t.note,this.ts=0,this.pan=A.context.createStereoPanner(),this.ss=A.context.createGain(),this.es=A.context.createGain(),this.ns=A.context.createGain(),this.hs=0,this.os={baseVolume:.5,baseReverb:0,lpEnvQ:1.7,hpEnvQ:1.7}}play(t,e=this.rs()){}cs(){if(!this.us)return!1;let t=!1;for(let e in Object.values(this.us)){e.length>0&&(t=!0);break}return t}ls(){const t=(this.us?.filters||[]).map((({ps:t,type:e,frequency:s,gain:i})=>{const n=A.context.createBiquadFilter();return n.type=e,t&&(n.Q.value=t),s&&(n.frequency.value=s),i&&(n.gain.value=i),n})),e=(this.us?.ds||[]).map((({threshold:t,attack:e,knee:s,ratio:i,release:n})=>{const o=A.context.createDynamicsCompressor();return o.threshold.value=t,o.attack.value=e,o.knee.value=s,o.ratio.value=i,o.release.value=n,o})),s=[...(this.us?.ws||[]).map((t=>{const e=A.context.createWaveShaper();return e.curve=t.curve,e})),...t,...e];return s.forEach(((t,e,s)=>{e!==s.length-1&&t.connect(s[e+1])})),s}J(t){g(t)||(this.hs=t),this.ss.gain.value=1-this.hs-this.os.baseReverb,this.es.gain.value=this.os.baseReverb+this.hs}G(t){g(t)||(this.ys=t),this.ns.gain.value=b(this.os.baseVolume*this.ys,0,1)}vs(t,e,s={}){const i=A.context.createGain();q(i.gain,this.fs.amplitude),this.J();const n=A.context.createBiquadFilter();n.type="lowpass",n.frequency.value=2e4,n.Q.value=this.xs("lpEnvQ",s.lpEnvQ);const o=A.context.createBiquadFilter();o.type="highpass",o.frequency.value=20,o.Q.value=this.xs("hpEnvQ",s.hpEnvQ),this.G(),this.fs?.Ms&&q(n.frequency,this.fs.Ms),this.fs?.bs&&q(o.frequency,this.fs.bs);const{source:r,gain:h}=e;if(r.connect(h),h.connect(i),i.connect(n),n.connect(o),this.cs()){const t=this.ls(),e=t[0],s=t.pop();o.connect(e),s.connect(this.ns)}else n.connect(this.ns);this.ns.connect(this.pan),this.pan.connect(this.ss),this.pan.connect(this.es),this.ss.connect(A.st),this.es.connect(A.et),r.start(t),r.stop(t+this.duration),r.onended=()=>{r.disconnect()}}gs(t,e,s={}){let i;const n=A.context.createGain(),o=this.rs(e);if("waveform"===t){const{qs:t}=s;i=A.context.createOscillator(),i.type=t,i.frequency.value=C(o)}if("harmonics"===t){const{ks:t,qs:e}=s;if(i=A.context.createOscillator(),i.type=e,g(t))throw new Error("harmonic option required");n.gain.value=.2/(1+Math.log2(t)),i.frequency.value=C(o)*t}if("waveform"!==t&&"harmonics"!==t||(this.duration=this.fs.amplitude?.map((({time:t})=>t)).reduce(((t,e)=>t+e))||0),"sample"===t){const{buffer:t}=s;i=A.context.createBufferSource(),i.buffer=t,this.duration=t.duration}return{source:i,gain:n,note:e}}xs(t,e){return g(e)?this.os[t]:e}rs(t){return g(t)?g(this.note)?this.ts+P[Math.floor(Math.random()*P.length)]:this.ts+this.note:this.ts+t}}class G extends j{constructor(t={}){super(t),this.ts=-24,this.fs={amplitude:[{time:0,value:1},{time:.75,value:1e-4,exp:!0}]},this.us={ws:[{curve:L(.2)}]},this.os.baseVolume=.5}play(t,e){const s=this.gs("waveform",e,{qs:"sine"});this.vs(t,s)}}class Q extends Y{constructor(t={}){super(t),this.Ts="dr",this.display="Kick",this.Jt=50,this.Ct=3,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.K=new G({note:0}),this.init()}}class Z extends j{constructor(t={}){super(t),this.ts=0,this.fs={amplitude:[{time:0,value:0},{time:.015,value:1},{time:.45,value:1e-4,exp:!0}]},this.us={filters:[{type:"highpass",frequency:90,ps:1.7}]},this.os.baseReverb=.05,this.os.baseVolume=.25}play(t,e=this.rs()){const s=this.gs("waveform",e,{qs:"sine"});s.gain.gain.value=.3;const i=this.gs("sample",e,{buffer:A.et.buffer});i.gain.gain.value=.5,this.vs(t,s),this.vs(t,i)}}class z extends Y{constructor(t={}){super(t),this.Ts="dr",this.display="Snare",this.Jt=25,this.Ct=2,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.K=new Z({note:0}),this.init()}}class _ extends H{constructor(t={}){super(t),this.type="oscillator",this.Es=[]}init(){this.Lt||this.Dt(),this.Kt=Math.round(this.Jt/3)}As(){return A.context.currentTime%this.duration/this.duration}Gt(){const{Et:t,At:e,Ot:s,$t:i}=W.Tt,{x:n,y:o}=this.position,r=y(n),h=v(o),a=F[r][h],c=r>t&&r<e&&h>s&&h<i,l=Boolean(a.Rt),u=a.Wt||!1;return c&&!l&&!u}Dt(){this.Lt=!1,F[y(this.position.x)][v(this.position.y)].Rt=this,this.Es.forEach((t=>{N.cancel(t)})),this._t()}Zt(){const t=y(this.position.x),e=v(this.position.y);F[t][e]=new Object,this.Os()}Pt(){const t=f(this.position.x+.5),e=w(this.position.y-.5);this.$s(t,e),this.Fs(t,e),this.Lt&&(a.X.globalAlpha=.5,this.Ss.forEach((t=>{const[e,s]=t;a.X.beginPath(),X(f(this.position.x+e),w(this.position.y+s),!0,!1,a.X)})),a.X.globalAlpha=1)}Fs(t,e){a.X.moveTo(t,e);const s=this.As();let i,n;for(let t=0;t<this.Ss.length;t++){const e=(t+1)/this.Ss.length;if(s<e){const o=(e-s)*this.Ss.length;i=f(this.position.x+.5+E(this.Ss[t][0],this.Ss[(t+1)%this.Ss.length][0],o)),n=w(this.position.y-.5+E(this.Ss[t][1],this.Ss[(t+1)%this.Ss.length][1],o)),a.X.lineTo(i,n),a.X.stroke(),a.X.beginPath(),a.X.arc(i,n,d.width(.015),0,c),a.X.fill();break}}}$s(t,e){}Os(){this.Es.forEach((t=>{N.cancel(t)}))}_t(){this.Os();const t=y(this.position.x),e=v(this.position.y),s=Math.ceil(Math.max(this.As()||.1)*this.Ss.length),i=(t=>{const e=A.context.currentTime/t;return(Math.floor(e)+1)*t})(this.interval);for(let n=0;n<this.Ss.length;n++){const o=i+n*this.interval,r=(n+s)%this.Ss.length,h=this.Ss[r],a=F[t+h[0]][e+h[1]];this.Es.push(N.dt(o,this.duration,(()=>{if("instrument"===a?.Rt?.type&&"playing"!==a.state){a.state="playing";const t=a.Rt,e=t.Ct;this.Nt+=e,O.gt+=e,O.qt+=e,t.Nt+=e,t.K.ys>0&&t.K.play(A.context.currentTime),N.at(A.context.currentTime+.5142857142857142,(()=>{a.state="stopped"}))}})))}}}class tt extends _{constructor(t={}){super(t)}init(){this.Ss=[[0,this.Bs],[this.Bs,0],[0,-this.Bs],[-this.Bs,0]],this.duration=this.interval*this.Ss.length,super.init()}$s(t,e,s=a.X,i=d.width(.048),n=d.width(.006),o=(this.disabled?this.jt:this.color)){s.strokeStyle=o,s.fillStyle=o,s.lineWidth=n,s.beginPath(),s.arc(t,e,i/2,0,c)}Fs(t,e){a.X.moveTo(t,e);const s=((t,e,s,i,n)=>({x:Math.cos(n)*(t-s)-Math.sin(n)*(e-i)+s,y:Math.sin(n)*(t-s)+Math.cos(n)*(e-i)+i}))(t+d.width(.06*this.Bs),e,t,e,c*this.As()-Math.PI/2);a.X.lineTo(s.x,s.y),a.X.stroke(),a.X.beginPath(),a.X.arc(s.x,s.y,d.width(.015),0,c),a.X.fill()}}class et extends tt{constructor(t={}){super(t),this.display="Circle",this.Jt=25,this.Bs=1,this.color=n,this.interval=.8571428571428571,this.init()}}const st={screenX:void 0,screenY:void 0,Ps:void 0,Rs:void 0},it=new class{constructor(t,e){this.x=t,this.y=e}}(9,16),nt=t=>{let e;switch(t){case"menu":J.vt.M=!0;break;case"drag":e="Hint: click and drag the map to move around and build in new places",J.vt.ft=!0;break;case"escape":e="Hint: press `Escape` to cancel your placement.",J.vt.escape=!0;break;case"hide":Object.keys(J.vt).forEach((t=>J.vt[t]=!1)),e=""}h.hint.innerHTML=e},ot=()=>{J.vt.M&&(J.vt.M=!1),"hidden"===h.M.style.visibility?(h.M.style.visibility="visible",h.g.style.transform="rotate(0deg)",J.Mt=!0,at(),J.bt&&rt(),W.Ut=null,document.addEventListener("mousedown",dt)):(h.M.style.visibility="hidden",h.g.style.transform="rotate(45deg)",J.Mt=!1,document.removeEventListener("mousedown",dt))},rt=()=>{"hidden"===h.T.style.visibility?(h.T.style.visibility="visible",J.bt=!0,ht(),document.addEventListener("mousedown",dt)):(h.T.style.visibility="hidden",J.bt=!1,W.Cs=null,document.removeEventListener("mousedown",dt))},ht=()=>{if(W.Cs){const t=Math.round(W.Cs.Jt/3);h.F.innerHTML=T(W.Cs.Jt),h.$.innerHTML=W.Cs.display,h.S.innerHTML=T(W.Cs.Nt),h.B.innerHTML=T(t)}},at=()=>{h.k.innerHTML="Notes: "+T(O.gt),document.querySelectorAll(".entity-button").forEach((t=>{parseInt(t.getAttribute("cost"))<=O.gt?t.disabled&&(t.disabled=!1):t.disabled||(t.disabled=!0)}))},ct=()=>{const t=document.querySelectorAll(".hide-intro");t.forEach((t=>{t.style.opacity="1"})),h.R.style.transform="translate(0, -100%)",window.setTimeout((()=>{Yt(),t.forEach((t=>t.style.transitionDuration="0ms"))}),1e3)},lt=()=>{W.Cs&&(W.Cs.Zt(),O.gt+=W.Cs.Kt,O.qt+=W.Cs.Kt,rt())},ut=()=>{x(h.o),a.U.fillStyle="white",a.U.strokeStyle="white",K.forEach((([t,e,s,i])=>{a.U.lineWidth=d.width(s),((t,e,s,i,n)=>{t.save(),t.translate(e,s),t.rotate(n),t.translate(-e,-s),t.beginPath(),t.moveTo(e,s-i/2),t.quadraticCurveTo(e,s,e+i/2,s),t.quadraticCurveTo(e,s,e,s+i/2),t.quadraticCurveTo(e,s,e-i/2,s),t.quadraticCurveTo(e,s,e,s-i/2),t.restore()})(a.U,d.V(t),d.D(e),d.width(6*s),i),a.U.fill(),a.U.stroke()})),$(a.U,"rgba(189, 91, 255, .2)",U[0]),$(a.U,"rgba(0, 225, 158, .2)",U[1]),(()=>{const t=a.L.createRadialGradient(d.V(0),d.D(0),d.width(.21),d.V(0),d.D(0),d.width(.42));t.addColorStop(0,e),t.addColorStop(.25,e),t.addColorStop(1,i),x(h.u),a.L.lineWidth=d.width(.006),a.L.strokeStyle=s,a.L.fillStyle=t,a.L.beginPath(),a.L.arc(d.V(0),d.D(0),d.width(.42),0,c),a.L.fill(),a.L.stroke()})(),W.St()},dt=t=>{!J.Mt||h.M.contains(t.target)||h.g.contains(t.target)||ot(),J.bt&&!h.A.contains(t.target)&&rt()},pt=t=>{"Escape"===t.key&&J.Mt&&ot()},mt=t=>{"Escape"===t.key&&J.bt&&rt()},yt=t=>{st.screenX=t.x,st.screenY=t.y,st.Ps=(t=>{const{left:e,right:s}=h.h.getBoundingClientRect();if(!(t<e||t>s)){const s=d.width()/d.width(.06),i=-s/2+(t-e)/d.width(1,!0)*s+W.position.x;return Math.round(i)}})(t.x),st.Rs=(t=>{const{top:e,bottom:s}=h.h.getBoundingClientRect();if(!(t<e||t>s)){const i=d.height()/d.width(.06),n=-i/2+(s-t-e)/d.height(1,!0)*i+W.position.y;return Math.round(n)}})(t.y)},vt=t=>{if(A.context.resume(),!J.Mt&&!J.bt){const e=.06*h.h.clientWidth;let s=t.clientX,i=t.clientY;const{x:n,y:o}=W.position,r=t=>{J.vt.ft&&nt("hide");const r=t.clientX-s,h=t.clientY-i;W.position.set(n-r/e,o+h/e),W.St();for(let t=W.Tt.Et;t<=W.Tt.At;t++)for(let e=W.Tt.Ot;e<=W.Tt.$t;e++){const s=F[t][e]?.Rt;"instrument"===s?.type&&k(s)}},a=()=>{document.removeEventListener("mousemove",r),document.addEventListener("mousemove",yt)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",a,{once:!0}),document.removeEventListener("mousemove",yt)}},ft=()=>{!W.Cs||J.bt||W.Ut||rt()},wt=()=>{if(J.Mt||J.bt)return;if(g(st.Ps)||g(st.Rs))return;const t=y(st.Ps),e=v(st.Rs);if(g(t)||g(e))return;const s=F[t][e];return W.Cs=s.Rt,s.Rt?h.p.style.cursor="pointer":W.Ut||(h.p.style.cursor="grab"),s};class gt extends j{constructor(t={}){super(t),this.ts=36,this.fs={amplitude:[{time:0,value:1},{time:.2,value:0}]},this.os.baseReverb=.25,this.os.baseVolume=.09,this.us={filters:[{type:"lowpass",frequency:1500,ps:.71},{type:"highpass",frequency:250,ps:1.2}]}}play(){[this.gs("waveform",P[0],{qs:"sine"}),this.gs("waveform",P[1],{qs:"sine"}),this.gs("waveform",P[3],{qs:"sine"}),this.gs("waveform",P[4],{qs:"sine"})].forEach(((t,e)=>{window.setTimeout((()=>{this.vs(A.context.currentTime,t)}),.10714285714285714*e*1e3)}))}}class xt extends Y{constructor(t={}){super(t),this.Ts="cs",this.display="Cosmic Ray",this.Jt=5e3,this.Ct=75,this.outline=[[0,0],[1,0],[1,1],[2,1],[2,0],[2,-1],[1,-1],[0,-1],[0,-2],[-1,-2],[-1,-1],[-1,0]],this.K=new gt,this.init()}}class bt extends j{constructor(t){super(t)}play(t,e){this.Us?.forEach((s=>{const i=this.gs("harmonics",e,{qs:"sine",ks:s});this.vs(t,i)})),this.Ls?.forEach((s=>{const i=this.gs("harmonics",e,{qs:"square",ks:s});this.vs(t,i)})),this.Ns?.forEach((s=>{const i=this.gs("harmonics",e,{qs:"sawtooth",ks:s});this.vs(t,i)}))}}class Et extends bt{constructor(t={}){super(t),this.Ns=[0,2,4],this.ts=-24,this.fs={amplitude:[{time:0,value:0},{time:.5,value:1},{time:.75,value:0}]},this.os.baseReverb=.2,this.os.baseVolume=.4}}class Tt extends Y{constructor(t={}){super(t),this.Ts="cs",this.display="Harmonix",this.Jt=500,this.Ct=15,this.outline=[[0,0],[0,1],[1,1],[1,0],[2,0],[3,0],[3,-1],[2,-1],[1,-1],[1,-2],[0,-2],[0,-1],[-1,-1],[-2,-1],[-2,0],[-1,0]],this.K=new Et,this.init()}}class Mt extends j{constructor(t={}){super(t),this.ts=0,this.fs={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.25,value:1e-4,exp:!0}]},this.us={filters:[{type:"highpass",frequency:350,ps:1.7},{type:"peaking",gain:-12,frequency:8780,ps:.85},{type:"lowpass",frequency:18e3,ps:.59}]},this.os.baseVolume=.1}play(t,e){const s=this.gs("sample",e,{buffer:A.et.buffer});s.source.detune.value=2400,this.vs(t,s)}}class St extends Y{constructor(t={}){super(t),this.Ts="dr",this.display="HiHat",this.Jt=5,this.Ct=1,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.K=new Mt({note:0}),this.init()}}class qt extends bt{constructor(t={}){super(t),this.Us=[1,2,4,8],this.fs={amplitude:[{time:0,value:0},{time:.05,value:1},{time:.35,value:0}],Ms:[{time:.35,value:.001,exp:!0}]},this.os.baseReverb=.2,this.us={filters:[{type:"lowpass",frequency:2500,ps:.71},{type:"highpass",frequency:120,ps:.71}]}}}class Ct extends Y{constructor(t={}){super(t),this.Ts="bs",this.display="Organ",this.Jt=25,this.Ct=2,this.outline=[[0,1],[0,0],[0,-1],[1,-1],[2,-1],[2,0],[1,0],[1,1]],this.K=new qt,this.init()}}class Bt extends bt{constructor(t={}){super(t),this.ts=-12,this.Us=[0,2,4],this.Ls=[1],this.fs={amplitude:[{time:0,value:0},{time:.1,value:1},{time:.5,value:.7},{time:.95,value:1e-4,exp:!1}],Ms:[{time:0,value:0},{time:.25,value:3500},{time:1.75,value:1e-4,exp:!0}]},this.os.baseReverb=.5,this.os.baseVolume=.4,this.us={filters:[{type:"lowpass",frequency:1500,ps:.71},{type:"highpass",frequency:150,ps:1.2}]}}}class kt extends Y{constructor(t={}){super(t),this.Ts="cs",this.display="Plutonia",this.Jt=2500,this.Ct=25,this.outline=[[0,0],[-1,0],[-1,1],[0,1],[1,1],[1,0],[1,-1],[2,-1],[2,-2],[1,-2],[0,-2],[0,-1]],this.K=new Bt,this.init()}}class Lt extends bt{constructor(t={}){super(t),this.Ns=[1],this.fs={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.7,value:0}],Ms:[{time:0,value:0,exp:!1},{time:.15,value:5e3,exp:!1}]},this.os.baseReverb=.4,this.us={filters:[{type:"lowpass",frequency:1500,ps:1},{type:"highpass",frequency:120,ps:.71}]}}}class Rt extends Y{constructor(t={}){super(t),this.Ts="bs",this.display="Saw",this.Jt=50,this.Ct=3,this.outline=[[0,0],[1,0],[1,-1],[1,-2],[0,-2],[0,-1],[-1,-1],[-1,0]],this.K=new Lt,this.init()}}class Pt extends bt{constructor(t={}){super(t),this.Us=[1,8,9,12,15],this.fs={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.35,value:0}],Ms:[{time:.35,value:.001,exp:!0}]},this.os.baseReverb=.2,this.us={filters:[{type:"lowpass",frequency:2500,ps:.71},{type:"highpass",frequency:120,ps:.71}]}}}class At extends Y{constructor(t={}){super(t),this.Ts="bs",this.display="Sine",this.Jt=75,this.Ct=4,this.outline=[[0,0],[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0]],this.K=new Pt,this.init()}}class Nt extends bt{constructor(t={}){super(t),this.Us=[2,4,6],this.Ls=[1],this.fs={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.15,value:0}],Ms:[{time:.35,value:.001,exp:!0}]},this.os.baseReverb=.2,this.us={filters:[{type:"lowpass",frequency:1500,ps:.71},{type:"highpass",frequency:120,ps:.71}]}}}class Vt extends Y{constructor(t={}){super(t),this.Ts="bs",this.display="Square",this.Jt=100,this.Ct=5,this.outline=[[0,0],[1,0],[2,0],[2,-1],[1,-1],[1,-2],[0,-2],[0,-1]],this.K=new Nt,this.init()}}class It extends j{constructor(t={}){super(t),this.ts=-24,this.fs={amplitude:[{time:0,value:0},{time:.1,value:1},{time:.5,value:.7},{time:.95,value:1e-4,exp:!1}]},this.us={filters:[{type:"lowpass",frequency:2500,ps:1},{type:"highpass",frequency:90}],ws:[{curve:L(.5)}]},this.os.baseVolume=.2}play(t,e){const s=this.gs("waveform",e,{qs:"sine"});this.vs(t,s)}}class Xt extends Y{constructor(t={}){super(t),this.Ts="cs",this.display="Thermal Bass",this.Jt=250,this.Ct=10,this.outline=[[0,0],[-1,0],[-1,1],[0,1],[1,1],[2,1],[2,0],[2,-1],[2,-2],[1,-2],[0,-2],[-1,-2],[-1,-1],[0,-1]],this.K=new It,this.init()}}class Dt extends j{constructor(t={}){super(t),this.ts=0,this.fs={amplitude:[{time:0,value:1},{time:.25,value:1e-4,exp:!0}]},this.os.baseReverb=.05}play(t,e){const s=this.gs("waveform",e,{qs:"sine"});s.gain.gain.value=.5,this.vs(t,s)}}class $t extends Y{constructor(t={}){super(t),this.Ts="dr",this.display="Tom",this.Jt=15,this.Ct=3,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.K=new Dt,this.init()}}const Jt=[t=>new St(t),t=>new $t(t),t=>new z(t),t=>new Q(t),t=>new Ct(t),t=>new Rt(t),t=>new At(t),t=>new Vt(t),t=>new Xt(t),t=>new Tt(t),t=>new kt(t),t=>new xt(t)];class Ot extends _{constructor(t={}){super(t),this.width=1}$s(t,e,s=a.X,i=d.width(.06*this.width-.012),n=d.width(.006),o=(this.disabled?this.jt:this.color)){s.strokeStyle=o,s.fillStyle=o,s.lineWidth=n,s.beginPath(),s.strokeRect(t-i/2,e-i/2,i,i),s.stroke()}}class Wt extends Ot{constructor(t={}){super(t),this.display="Square",this.interval=.21428571428571427,this.Jt=500,this.color=n,this.Ss=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]],this.duration=this.interval*this.Ss.length,this.init()}}class Ft extends _{constructor(t={}){super(t),this.width=1}$s(t,e,s=a.X,i=d.width(.06*this.width-.012),n=d.width(.006),o=(this.disabled?this.jt:this.color)){s.strokeStyle=o,s.fillStyle=o,s.lineWidth=n,s.beginPath(),((t,e,s,i)=>{const n=i*Math.sqrt(3)/2;t.beginPath(),t.moveTo(e,s-n/2),t.lineTo(e+i/2,s+n/2),t.lineTo(e-i/2,s+n/2),t.closePath()})(s,t,e,i),s.stroke()}}class Kt extends Ft{constructor(t={}){super(t),this.display="Triangle",this.interval=.5714285714285714,this.Jt=50,this.color=n,this.Ss=[[0,1],[1,-1],[-1,-1]],this.duration=this.interval*this.Ss.length,this.init()}}const Ut=[t=>new et(t),t=>new Kt(t),t=>new Wt(t)],Ht=(t,e)=>{x(t);const s=t.getContext("2d"),i=e.id.substr(0,2);if("oscillator"===e.type&&(e.$s(t.width/2,t.height/2,s,t.width*("co"===i?.075:.3),t.width/15),s.stroke()),"instrument"===e.type){const i=e;t.width=h.v.width,t.height=h.v.height;const n=8/Math.max(i.zt,i.Qt),{x:o,y:r}=it;s.save(),s.setTransform(n,0,0,n*r/o,-(n-1)*t.width/2,-(n*r/o-1)*t.height/2),e.Pt(s,!1),s.restore(),s.scale(1,r/o)}},Yt=()=>{A.context.resume();let t=0;const e=()=>{(()=>{x(h.l),a.j.lineWidth=d.width(.006),a.L.strokeStyle=s,A.Z.getByteFrequencyData(A._);const t=A._.reduce(((t,e)=>t+e))/A.Z.frequencyBinCount;for(let e=0;e<5;e++)a.j.strokeStyle=`rgba(255,255,255,${1-(e+1)/5})`,a.j.arc(d.V(0),d.D(0),d.width(.42)+t*e/6,0,c),a.j.stroke()})(),W.Pt(),(J.Mt||J.bt)&&O.gt!==t&&(at(),ht()),t=O.gt,window.requestAnimationFrame(e)};window.requestAnimationFrame(e)};(async()=>{await A.init(),[h.h,h.o,h.u,h.l,h.p,h.m,h.v,h.M,h.T].forEach((t=>{(t=>{const e=t.parentElement;new ResizeObserver((()=>{const{width:s,height:i}=e.getBoundingClientRect(),n=Math.min(s/it.x,i/it.y),o=n*it.x,r=n*it.y,h=window.devicePixelRatio||1;t.width=o*h,t.height=r*h,t.style.width=o+"px",t.style.height=r+"px",W.St()})).observe(e)})(t)})),h.start.addEventListener("click",ct),h.g.addEventListener("click",ot),h.O.addEventListener("click",rt),h.P.addEventListener("click",lt),document.addEventListener("keydown",pt),document.addEventListener("keydown",mt),document.addEventListener("mousemove",yt),document.addEventListener("mousemove",wt),document.addEventListener("mousedown",vt),document.addEventListener("click",ft),new ResizeObserver(ut).observe(h.root),[...Ut,...Jt].forEach((t=>{((t,e)=>{const{type:s,Jt:i}=t,n=document.getElementById("templates").firstElementChild.cloneNode(!0),o=n.querySelector("button");o.classList.add("entity-button"),o.setAttribute("cost",i.toString());const r=n.querySelector("canvas");n.querySelector("p").innerHTML=t.display;const a=n.querySelectorAll("span");a[0].innerHTML="-"+t.Jt,"instrument"===s&&(a[1].innerHTML="&nbsp;/&nbsp;",a[2].innerHTML="+"+t.Ct);const c="instrument"===s?t.Ts:"os";document.getElementById(c).append(n),o.onclick=s=>{s.stopPropagation(),ot(),((t,e)=>{let s,i;J.xt&&nt("escape"),t.position.set(st.Ps,st.Rs),W.Ut=t,h.p.style.cursor="pointer";const n=()=>{const e=st.Ps,s=st.Rs;if(void 0!==e&&void 0!==s){t.position.set(e,s);const i=!t.Gt();t.disabled=i,h.p.style.cursor=i?"not-allowed":"pointer"}},o=r=>{const a=Math.abs(r.x-s),c=Math.abs(r.y-i);if(a>5||c>5)return document.addEventListener("click",o,{once:!0}),void(h.p.style.cursor="pointer");if(t.disabled)document.addEventListener("click",o,{once:!0});else{nt("hide"),J.yt+=1;const{x:s,y:i}=t.position;e({x:s,y:i}),O.gt-=W.Ut.Jt,W.Ut=null,document.removeEventListener("mousemove",n),h.p.style.cursor="grab",2===J.yt&&nt("drag")}};document.addEventListener("keydown",(e=>{"Escape"===e.key&&(nt("hide"),J.xt=!1,t.disabled=!0,W.Ut=null,document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",o),h.p.style.cursor="grab")})),document.addEventListener("mousedown",(t=>{h.p.style.cursor="grab",s=t.x,i=t.y})),document.addEventListener("mousemove",n),document.addEventListener("mouseup",o,{once:!0})})(t,e)};const l=()=>{x(r),Ht(r,t)},u=new ResizeObserver(l);window.addEventListener("resize",l),Ht(r,t),u.observe(o)})(t({Lt:!0}),t)})),at(),W.St(),new Q({x:1,y:0}),new z({x:-1,y:0}),new et({x:0,y:0}),h.start.disabled=!1})()})()</script>