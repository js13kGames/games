/**
 * This file is part of JS13kGames - SPACE.
 * Lido Space is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * Lido Space is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * You should have received a copy of the GNU General Public License
 * along with Lido Space.  If not, see <https://www.gnu.org/licenses/>.
 */

var lido=function(e){"use strict";var t="Game not properly initialised!",n="addUser",o="keyUp",r="selectMode",i={avatars:[],highscore:null,highscoreName:null,host:null,opponents:null,opponentsState:null,roleState:null,socket:null,socketState:null,tweet:null};function c(e){if(null===i.socketState)throw new Error("HTML broken");i.socketState.textContent=e}function a(){c("Connected and waiting for opponentâ€¦")}function s(){c("Connection lost!")}function u(){c("Connection error!")}function l(e){var t,n,o=new URL(window.location.href);o.hash="#scene-"+e,window.history.pushState({},"",o.href),window.location.hash=o.hash,Array.from(document.querySelectorAll("section")).forEach((function(e){e.style.display="none"})),t=o.hash,(n=document.querySelector(t))&&(n.style.display=""),i.socket.emit("navigate",{scene:e})}function d(){fetch("/highscore").then((function(e){return e.json()})).then((function(e){var t="<thead><tr>"+["Name","Role","Score"].map((function(e){return'<th scope="column">'+e+"</th>"})).join("")+"</tr></thead>",n="<tbody>"+e.map((function(e){return"<tr><td>"+e.name+"</td><td>"+e.role+"</td><td>"+e.score+"</td></tr>"})).join("")+"</tbody>";return i.highscore.innerHTML=t+n,e})).catch((function(e){return console.error(e),null})).then((function(e){!function(e){if(!i.highscoreName||!i.tweet)return;var t=i.highscoreName.textContent,n=e.find((function(e){return e.name===t})),o=n?"I played Lido Space and scored "+n.score+" as "+n.role+"!":"I played Lido Space.",r=encodeURIComponent(location.href.replace(location.hash,"")),c=encodeURIComponent(o),a=["js13k","js13kgames"].map(encodeURIComponent).join(","),s="AndreJaenisch";i.tweet.href="https://twitter.com/intent/tweet?url="+r+"&text="+c+"&hashtags="+a+"&via="+s,i.tweet.textContent="Share your score"}(e),l("fin")}))}function f(e){var n=e.host,o=e.opponents;!function(e){var n=e.host,o=e.opponents;if(!i.host||!i.opponents)throw new Error(t);i.host.style.stroke=n.color;var r=i.opponents;o.forEach((function(e,n){var o=r.children[2*n],i=r.children[2*n+1];if(!o||!i)throw new Error(t);o.style.fill=e.color,i.style.fill=e.color}))}({host:n,opponents:o}),function(e){var n=e.host,o=e.opponents;if(!i.opponentsState||!i.roleState)throw new Error(t);i.roleState.innerHTML='<span class="tile" style="--user-color: '+n.color+';">\n    '+n.name+"\n  </span>",i.opponentsState.innerHTML="",o.forEach((function(e){var t='<span class="tile" style="--user-color: '+e.color+';">\n      '+e.name+"\n    </span>";i.opponentsState.innerHTML+=t}))}({host:n,opponents:o})}var h={downTime:0,isPressed:!1,upTime:0};function p(){h.isPressed||(h.downTime=(new Date).valueOf(),h.upTime=0,h.isPressed=!0)}function m(){h.upTime=(new Date).valueOf();var e=(h.upTime-h.downTime)/1e3;Number.isNaN(e)||i.socket.emit(o,{delta:e}),h.isPressed=!1,h.downTime=0}function w(e){var t=e.role;document.body.dataset.role=t,t===ROLE_HOST&&(document.body.addEventListener("keydown",(function(e){"Space"===e.code&&(e.preventDefault(),p())}),!1),document.body.addEventListener("keyup",(function(e){"Space"===e.code&&(e.preventDefault(),m(),k("shoot"))}),!1)),t===ROLE_OPPONENT&&document.body.addEventListener("keyup",(function(e){switch(e.code){case"ArrowUp":e.preventDefault(),v(),k("hit");break;case"ArrowRight":e.preventDefault(),E(),k("hit");break;case"ArrowDown":e.preventDefault(),y(),k("hit");break;case"ArrowLeft":e.preventDefault(),g(),k("hit")}}),!1),Array.from(document.querySelectorAll("#scene-game form")).forEach((function(e){e.addEventListener("submit",(function(t){switch(t.preventDefault(),new FormData(e).get("key")){case"SPACE":p(),setTimeout(m,1300*Math.random()),k("shoot");break;case"TOP":v(),k("hit");break;case"LEFT":g(),k("hit");break;case"BOTTOM":y(),k("hit");break;case"RIGHT":E(),k("hit")}}))})),c("Playing")}function v(){i.socket.emit(o,{direction:0})}function E(){i.socket.emit(o,{direction:1})}function y(){i.socket.emit(o,{direction:2})}function g(){i.socket.emit(o,{direction:3})}function k(e){"shoot"===e&&window.zzfx.apply(window,[,,4,.02,.09,.06,4,.09,-4.6,-.1,,,.08,.3,,,,.82,.04]),"hit"===e&&window.zzfx.apply(window,[,,350,,,.09,4,1.13,,6.9,,,,.9,,.5,,.93,.01,.18])}function S(e){var n=e.points,o=e.role;if(o===ROLE_HOST){if(null===i.host)throw new Error(t);var r=n.map((function(e){return e.join(",")})).join(" ");i.host.setAttribute("points",r)}if(o===ROLE_OPPONENT){if(!i.opponents)throw new Error(t);var c=i.opponents;n.forEach((function(e,n){var o=c.children[2*n],r=c.children[2*n+1],i=e[e.length-1];if(!o||!r)throw new Error(t);var a=i[0],s=i[1];o.setAttribute("cx",a),o.setAttribute("cy",s);var u=e.join(",");r.setAttribute("points",u)}))}}function b(){i.socket=window.io({upgrade:!1,transports:["websocket"]}),function(e){e.highscore=function(){var e=document.getElementById("highscore");if(!e)throw new Error(t);return e}(),e.highscoreName=function(){var e=document.getElementById("highscore-name");if(!e)throw new Error(t);return e}(),e.host=function(){var e=document.getElementById("host");if(!e)throw new Error(t);return e}(),e.opponents=function(){var e=document.getElementById("opponents");if(!e)throw new Error(t);return e}(),e.socketState=function(){var e=document.getElementById("socketState");if(!e)throw new Error(t);return e}(),e.roleState=function(){var e=document.getElementById("role");if(!e)throw new Error(t);return e}(),e.opponentsState=function(){var e=document.getElementById("opponent-list");if(!e)throw new Error(t);return e}(),e.tweet=function(){var e=document.getElementById("tweet");if(!e)throw new Error(t);return e}()}(i),function(){if(null===i.socket)throw new Error(t);i.socket.on("joined",f),i.socket.on("start",w),i.socket.on("sync",S),i.socket.on("gameOver",d),i.socket.on("connect",a),i.socket.on("disconnect",s),i.socket.on("error",u)}(),function(){var e=document.getElementById("user-form");if(!e)throw new Error(t);e.addEventListener("submit",(function(e){if(e.preventDefault(),!e.target||!i.highscoreName)throw new Error(t);var o=new FormData(e.target).get("name");o?(i.highscoreName.textContent=String(o),i.socket.emit(n,{name:o}),l("match-form")):console.error("Show validation error")}))}(),function(){var e=document.getElementById("match-form");if(!e)throw new Error(t);e.addEventListener("submit",(function(e){if(e.preventDefault(),!e.target)throw new Error(t);var n=new FormData(e.target).get("mode");n?(i.socket.emit(r,{mode:n}),l("game")):console.error("Show validation error")}))}(),Array.from(document.querySelectorAll("a")).filter((function(e){return!Boolean(e.target)})).forEach((function(e){e.addEventListener("click",(function(t){var n=e.getAttribute("href");n&&(t.preventDefault(),l(n.slice("#scene-".length)))}),!1)})),l("title")}return e.app=function(){window.addEventListener("load",b,!1)},Object.defineProperty(e,"__esModule",{value:!0}),e}({});
