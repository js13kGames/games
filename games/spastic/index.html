<!doctype html><title>Spastic - js13kGames 2012</title><style>body{background:#111;overflow:hidden}#cul{z-index:0;background:#000;border:1px solid #333}input{position:absolute;left:-666px}</style><canvas id=cul></canvas><input type=file id=local><script>var o={init_callback:null,render_callback:null,update_callback:null,onload_callback:null,canvas:null,context:null,max_fps:30,fps:0,frame:0,current_time:0,update_time:0,keys:[],mouse:{x:0,y:0,wheel:{up:!1,down:!1},button:[]},browser:{width:0,height:0},screen:{width:0,height:0,center:!1},listen:function(t,e,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent&&e.attachEvent("on"+t,i)},trigger:function(t,e){"function"==typeof e[t]&&e[t]()},start:function(){null!=this.init_callback&&(this.init_callback(),this.init_callback=null),this.run()},run:function(){if(this.current_time=(new Date).getTime(),this.frame+=1,this.frame>=this.max_fps&&(this.frame=0),null!=o.update_callback){o.update_callback(),o.mouse.wheel.down=!1,o.mouse.wheel.up=!1;for(var t=0;t<2;t++)o.mouse.button[t].down=!1,o.mouse.button[t].up=!1;for(t=0;t<255;t++)o.keys[t].down=!1,o.keys[t].up=!1}null!=o.render_callback&&o.render_callback(),this.update_time=(new Date).getTime()-this.current_time,this.fps=1e3/this.update_time,this.fps>this.max_fps&&(this.fps=this.max_fps),window.setTimeout(o.run,1e3/o.max_fps)},ready:function(t){var e=window.onload;"function"!=typeof window.onload?this.listen("load",window,t):this.listen("load",window,function(){e&&e(),t()})},resize:function(){window.innerWidth?(o.browser.width=window.innerWidth,o.browser.height=window.innerHeight):0!=document.documentElement.clientWidth?(o.browser.width=document.documentElement.clientWidth,o.browser.height=document.documentElement.clientHeight):(o.browser.width=document.body.clientWidth,o.browser.height=document.body.clientHeight),o.context.canvas.width=(null==o.screen.width?o.browser:o.screen).width,o.context.canvas.height=(null==o.screen.height?o.browser:o.screen).height,o.context.canvas.style.cssText="width: "+o.context.canvas.width+"px; height: "+o.context.canvas.height+"px; position: absolute;"+(o.screen.center?" left: "+(o.browser.width/2-o.context.canvas.width/2)+"px; top: "+(o.browser.height/2-o.context.canvas.height/2)+"px;":"")},create:function(t,e,i,s){this.canvas=document.getElementById("cul"),this.context=this.canvas.getContext("2d"),this.context.imageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.resize(),this.listen("resize",window,this.resize),this.screen.width=e,this.screen.height=i,this.screen.center=s,this.listen("mousemove",document,function(t){(t=t||window.event).pageX||t.pageY?(o.mouse.x=t.pageX,o.mouse.y=t.pageY):(o.mouse.x=t.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,o.mouse.y=t.clientY+document.body.scrollTop+document.documentElement.scrollTop),o.mouse.x-=o.canvas.offsetLeft,o.mouse.y-=o.canvas.offsetTop});for(var n=0;n<2;n++)this.mouse.button[n]={down:!1,up:!1,state:1};for(this.listen("mousedown",window,function(t){t.which?(o.mouse.button[0].down=1==t.which,o.mouse.button[1].down=3==t.which):t.button&&(o.mouse.button[0].down=0==t.button,o.mouse.button[1].down=2==t.button);for(var e=0;e<2;e++)o.mouse.button[e].down&&(o.mouse.button[e].state=0)}),this.listen("mouseup",window,function(t){t.which?(o.mouse.button[0].up=1==t.which,o.mouse.button[1].up=3==t.which):t.button&&(o.mouse.button[0].up=0==t.button,o.mouse.button[1].up=2==t.button);for(var e=0;e<2;e++)o.mouse.button[e].up&&(o.mouse.button[e].state=1)}),this.listen("contextmenu",window,function(t){t.preventDefault()}),this.listen("mousewheel",window,function(t){var e=0;o.mouse.wheel.up=!1,o.mouse.wheel.down=!1,(t=t||window.event).wheelDelta?(e=event.wheelDelta/120,window.opera&&(e=-e)):t.detail&&(e=-t.detail/3),0<e?o.mouse.wheel.up=!0:e<0&&(o.mouse.wheel.down=!0)}),n=0;n<255;n++)this.keys[n]={down:!1,up:!1,state:1,once:!1};return this.listen("keydown",window,function(t){o.keys[t.keyCode].once||(o.keys[t.keyCode].down=!0,o.keys[t.keyCode].state=0,o.keys[t.keyCode].once=!0)}),this.listen("keyup",window,function(t){o.keys[t.keyCode].up=!0,o.keys[t.keyCode].once=!1,o.keys[t.keyCode].state=1}),this.canvas.width=null==e?this.browser.width:e,this.canvas.height=null==i?this.browser.height:i,this.canvas.style.cssText="width: "+this.canvas.width+"px; height: "+this.canvas.height+"px; position: absolute;"+(this.screen.center?" left: "+(this.browser.width/2-this.canvas.width/2)+"px; top: "+(this.browser.height/2-this.canvas.height/2)+"px;":""),this.context&&setTimeout(function(){o.start()}),this.context},render:function(t){this.render_callback=t},update:function(t){this.update_callback=t},init:function(t){this.init_callback=t},load:function(t){this.load_callback=t},keycode:function(t){for(var e in CUL_CHAR[0])if(CUL_CHAR[0][e]==t)return e},keydown:function(t){return"string"==typeof t&&(t=this.keycode(t)),!(void 0===this.keys[t]||!this.keys[t].down)},keyup:function(t){return"string"==typeof t&&(t=this.keycode(t)),!(void 0===this.keys[t]||!this.keys[t].up)},keypressed:function(t){return"string"==typeof t&&(t=this.keycode(t)),void 0!==this.keys[t]&&0==this.keys[t].state},mousedown:function(t){return!!this.mouse.button[t].down},mouseup:function(t){return!!this.mouse.button[t].up},mousepressed:function(t){return 0==this.mouse.button[t].state},mousewheelup:function(){return this.mouse.wheel.up},mousewheeldown:function(){return this.mouse.wheel.down},mousepos:function(){return{x:this.mouse.x,y:this.mouse.y}},get_fps:function(){return Math.floor(this.fps)}},i=[0,1,2,3,4,5],a={context:null,m_vertices:[],m_primitive:null,m_color:"#FFFFFF",m_alpha:1,m_texture:null,m_point_size:1,m_ortho:{left:0,right:640,bottom:480,top:0},ortho:function(t,e,i,s){this.m_ortho.left=t,this.m_ortho.right=e,this.m_ortho.bottom=i,this.m_ortho.top=s},to_ortho:function(t,e){return{x:t/this.context.canvas.width*(this.m_ortho.right-this.m_ortho.left),y:e/this.context.canvas.height*(this.m_ortho.bottom-this.m_ortho.top)}},dec2hex:function(t){var e="0123456789ABCDEF";return e[t>>4]+e[15&t]},color:function(t,e,i,s){t*=255,e*=255,i*=255,(s=s||1)!=this.m_alpha&&(this.m_alpha=s,this.alpha(s)),this.m_color="#"+this.dec2hex(t)+this.dec2hex(e)+this.dec2hex(i)},alpha:function(t){this.context.globalAlpha=t},point_size:function(t){this.m_point_size=t},is_valid_primitive:function(t){for(var e=0;e<i.length;e++)if(t==i[e])return!0;return!1},bind:function(t){this.m_texture=t},unbind:function(){this.m_texture=null},begin:function(t){this.is_valid_primitive(t)?(this.m_primitive=t,0==this.m_primitive||1==this.m_primitive?this.context.strokeStyle=this.m_color:null!=this.m_texture?this.context.fillStyle=this.context.createPattern(this.m_texture,"repeat"):this.context.fillStyle=this.m_color,this.context.beginPath()):this.m_primitive=null},end:function(){null!=this.m_primitive&&(this.context.closePath(),0==this.m_primitive||1==this.m_primitive?this.context.stroke():this.context.fill(),this.m_primitive=null,this.m_vertices=[])},vertex:function(t,e){t=t/(this.m_ortho.right-this.m_ortho.left)*this.context.canvas.width,e=e/(this.m_ortho.bottom-this.m_ortho.top)*this.context.canvas.height,null!=this.m_primitive&&(5==this.m_primitive&&1==this.m_vertices.length?this.end():0==this.m_primitive&&2==this.m_vertices.length||(2==this.m_primitive&&3==this.m_vertices.length||3==this.m_primitive&&4==this.m_vertices.length)&&this.end(),5==this.m_primitive?this.context.arc(t,e,this.m_point_size-Math.PI,2*Math.PI,0,!0):0==this.m_vertices.length?this.context.moveTo(t,e):this.context.lineTo(t,e),5!=this.m_primitive)&&this.m_vertices.push({x:t,y:e})},clear:function(){this.unbind();var t=this.context.canvas.width;this.context.canvas.width=1,this.context.canvas.width=t},get_pixel:function(t,e){return this.context.getImageData(t,e,1,1).data},set_pixel:function(t,e,i){this.context.putImageData(i,t,e)},rotate:function(t){this.context.rotate(t*(Math.PI/180))},translate:function(t,e){t=t/(this.m_ortho.right-this.m_ortho.left)*this.context.canvas.width,e=e/(this.m_ortho.bottom-this.m_ortho.top)*this.context.canvas.height,this.context.translate(t,e)},scale:function(t,e){this.context.scale(t,e)},push_matrix:function(){this.context.save()},pop_matrix:function(){this.context.restore()},sprite:function(t,e,i,s,n,o,r,h,a){var c=this.m_texture.width,l=this.m_texture.height,u=(i=i||c,s=s||l,n=n||0,o=o||0,r=r||i/c,h=h||s/l,t),m=i;t=t/(this.m_ortho.right-this.m_ortho.left)*this.context.canvas.width,e=e/(this.m_ortho.bottom-this.m_ortho.top)*this.context.canvas.height,i=i/(this.m_ortho.right-this.m_ortho.left)*this.context.canvas.width,s=s/(this.m_ortho.bottom-this.m_ortho.top)*this.context.canvas.height,a=a||!1,this.push_matrix(),a&&(this.context.translate(c+u-m,0),this.context.scale(-1,1)),this.context.drawImage(this.m_texture,parseInt(n*c),parseInt(o*l),parseInt(r*c),parseInt(h*l),t,e,i,s),this.pop_matrix()},write:function(t,e,i,s,n){e=e/(this.m_ortho.right-this.m_ortho.left)*this.context.canvas.width,i=i/(this.m_ortho.bottom-this.m_ortho.top)*this.context.canvas.height,this.context.font="normal "+(n=n||16)/(this.m_ortho.right-this.m_ortho.left)*this.context.canvas.width+"px "+t,this.context.fillStyle=this.m_color,this.context.fillText(s,e,i)}};function r(t,e){(function(a,t){this.bufferSize=a,this.sampleRate=t,this.bandwidth=2/a*t/2,this.spectrum=new Float32Array(a/2),this.real=new Float32Array(a),this.imag=new Float32Array(a),this.peakBand=0,this.peak=0,this.getBandFrequency=function(t){return this.bandwidth*t+this.bandwidth/2},this.calculateSpectrum=function(){for(var t,e=this.spectrum,i=this.real,s=this.imag,n=2/this.bufferSize,o=Math.sqrt,r=0,h=a/2;r<h;r++)(t=n*o((t=i[r])*t+(t=s[r])*t))>this.peak&&(this.peakBand=r,this.peak=t),e[r]=t}}).call(this,t,e),this.reverseTable=new Uint32Array(t);for(var i,s=1,n=t>>1;s<t;){for(i=0;i<s;i++)this.reverseTable[i+s]=this.reverseTable[i]+n;s<<=1,n>>=1}for(this.sinTable=new Float32Array(t),this.cosTable=new Float32Array(t),i=0;i<t;i++)this.sinTable[i]=Math.sin(-Math.PI/i),this.cosTable[i]=Math.cos(-Math.PI/i)}function m(t,e,i,s){return-Math.atan2(i-t,s-e)+Math.PI-f(90)}function h(t,e,i,s){return Math.sqrt((i-t)*(i-t)+(s-e)*(s-e))}function d(t){return t/(Math.PI/180)}function f(t){return t*(Math.PI/180)}function s(t,e,i){return t<i?t-i+e:e<t?t-e+i:t}function p(t){return s(t,2*Math.PI,0)}r.prototype.forward=function(t){var e=this.bufferSize,i=this.cosTable,s=this.sinTable,n=this.reverseTable,o=this.real,r=this.imag,h=(this.spectrum,Math.floor(Math.log(e)/Math.LN2));if(Math.pow(2,h)!==e)throw"Invalid buffer size, must be a power of 2.";if(e!==t.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+e+" Buffer Size: "+t.length;for(var a,c,l,u,m=1,d=0;d<e;d++)o[d]=t[n[d]],r[d]=0;for(;m<e;){for(var f=i[m],p=s[m],g=1,_=0,v=0;v<m;v++){for(d=v;d<e;)c=g*o[a=d+m]-_*r[a],l=g*r[a]+_*o[a],o[a]=o[d]-c,r[a]=r[d]-l,o[d]+=c,r[d]+=l,d+=m<<1;g=(u=g)*f-_*p,_=u*p+_*f}m<<=1}return this.calculateSpectrum()};var g={font_indices:[[0,0],[1,0],[2,0],[3,0],[4,0],[0,1],[1,1],[2,1],[3,1],[4,1],[0,2],[1,2],[2,2],[3,2],[4,2],[0,3],[1,3],[2,3],[3,3],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]],font_letters:{a:"0,1,2,3,4,5,9,10,11,12,13,14,15,19,20,24",b:"0,1,2,3,5,9,10,11,12,13,14,15,19,20,21,22,23",c:"0,1,2,3,4,5,10,15,20,21,22,23,24",d:"0,1,2,3,5,9,10,14,15,19,20,21,22,23",e:"0,1,2,3,4,5,10,11,12,13,15,20,21,22,23,24",f:"0,1,2,3,4,5,10,11,12,13,15,20",g:"0,1,2,3,4,5,10,12,13,14,15,19,20,21,22,23,24",h:"0,4,5,9,10,11,12,13,14,15,19,20,24",i:"0,1,2,3,4,7,12,17,20,21,22,23,24",j:"0,1,2,3,7,12,15,17,20,21,22",k:"0,3,5,7,10,11,15,17,20,23",l:"0,5,10,15,20,21,22,23",m:"0,4,5,6,8,9,10,12,14,15,19,20,24",n:"0,4,5,6,9,10,12,14,15,18,19,20,24",o:"0,1,2,3,4,5,9,10,14,15,19,20,21,22,23,24",p:"0,1,2,3,4,5,9,10,11,12,13,14,15,20",q:"0,1,2,3,4,5,9,10,14,15,18,19,20,21,22,23,24",r:"0,1,2,3,4,5,9,10,11,12,13,14,15,18,20,24",s:"0,1,2,3,4,5,10,11,12,13,14,19,20,21,22,23,24",t:"0,1,2,3,4,7,12,17,22",u:"0,4,5,9,10,14,15,19,20,21,22,23,24",v:"0,4,5,9,11,13,16,18,22",w:"0,4,5,9,10,12,14,15,16,18,19,20,24",x:"0,4,6,8,12,16,18,20,24",y:"0,4,6,8,12,17,22",z:"0,1,2,3,4,8,12,16,20,21,22,23,24",0:"1,2,3,5,9,10,14,15,19,21,22,23",1:"1,2,7,12,17,22",2:"1,2,5,8,12,16,20,21,22,23",3:"0,1,2,3,8,11,12,13,18,20,21,22,23",4:"0,3,5,8,10,11,12,13,18,23",5:"1,2,3,5,10,11,12,13,18,20,21,22,23",6:"0,1,2,3,5,10,11,12,13,15,18,20,21,22,23",7:"0,1,2,3,8,12,16,20",8:"0,1,2,3,5,8,11,12,15,18,20,21,22,23",9:"0,1,2,3,5,8,10,11,12,13,18,20,21,22,23"," ":"",".":"23","+":"7,10,11,12,17"},width:640,height:480,viewport:{x:320,y:240,zoom:1,angle:30},state:"menu",menu:[{entries:[{label:"load music from hard drive",click:function(){}}]},{entries:[{label:"play again",click:function(){g.init_track(g.buffer)}},{label:"choose another track",click:function(){g.state="menu"}}]}],buffer:null,frame_buffer:4096,buffer_size:2048,signal:[null,null],fft:[null,null],req:null,source:[null,null],context:[null,null],gain:null,proc:[null,null],waveform:[[],[]],frequency:[0,10],threshold:.3,decay:.02,current_threshold:.3,tick:0,running:[!(String.prototype.repeat=function(t){return--t?this+this.repeat(t):""+this}),!1],mute:!1,angle:0,angle_dir:1,angle_speed:1,last_pos:null,delay:0,time_diff:0,timer:[0,0],end_points:0,points:0,tmp_points:0,missed:0,scored:0,combo:0,color:[1,1,1],bg:[{x:0,y:0,r:0,g:0,b:0,timer:0,angle:0},{x:0,y:0,r:0,g:0,b:0,timer:0,angle:0}],circle:{angle:[0,0],base_size:Math.PI/4,size:[Math.PI/4,Math.PI/4],radius:100},msg:{message:"",r:1,g:1,b:1,timer:0},message:function(t,e,i,s){this.msg.message=t,this.msg.r=e,this.msg.g=i,this.msg.b=s,this.msg.timer=20},init_menu:function(t){for(var e=this.menu[t],i=0,s=0;s<e.entries.length;s++){var n=e.entries[s];this.menu[t].entries[s].hover=!1,void 0===n.size&&(this.menu[t].entries[s].size=2.5),void 0===n.x&&(this.menu[t].entries[s].min={x:320-n.label.length*n.size*6/2,y:120+35*i},this.menu[t].entries[s].max={x:320+n.label.length*n.size*6/2,y:120+35*i+35},i++)}},render_menu:function(t){for(var e=this.menu[t],i=0,s=0;s<e.entries.length;s++){var n=e.entries[s];n.hover?a.color(this.color[0],this.color[1],this.color[2]):a.color(1,1,1),void 0===n.x?(this.write(320,120+35*i,n.label,n.size,1),i++):this.write(n.x,n.y,n.label,n.size,0)}},update_menu:function(t){for(var e=this.menu[t],i=o.mousepos(),s=(i=a.to_ortho(i.x,i.y),0);s<e.entries.length;s++){var n=e.entries[s];n.min.x<i.x&&n.min.y<i.y&&n.max.x>i.x&&n.max.y>i.y?(this.menu[t].entries[s].hover=!0,o.mousedown(0)&&n.click()):this.menu[t].entries[s].hover=!1}},load:function(t){this.state="loading",this.render(),setTimeout(function(){null!==g.req&&delete g.req,g.req=new XMLHttpRequest,g.req.open("GET",t,!0),g.req.responseType="arraybuffer",g.req.onload=function(){g.init_track(g.req.response)},g.req.send()},500)},stop:function(){this.clean()},clean:function(){this.timer[0]=0,this.running[0]=!1,this.timer[1]=0,this.running[1]=!1,this.time_diff=0,this.angle=90,this.angle_dir=-1,this.angle_speed=1,this.points=0,this.tmp_points=0,this.missed=0,this.scored=0,this.combo=0,this.last_pos=null,this.delay=0,this.time_diff=null,this.bg=[{x:0,y:0,r:0,g:0,b:0,timer:0,angle:0},{x:0,y:0,r:0,g:0,b:0,timer:0,angle:0}],this.circle={angle:[0,0],base_size:Math.PI/4,size:[Math.PI/4,Math.PI/4],radius:100};for(var t=0;t<2;t++)null!==this.source[t]&&(this.source[t].disconnect(),this.source[t].stop(0),delete this.source[t],this.source[t]=null),null!==this.proc[t]&&(this.proc[t].onaudioprocess=function(){},this.proc[t].disconnect(),delete this.proc[t],this.proc[t]=null),null!==this.waveform[t]&&(delete this.waveform[t],this.waveform[t]=null),null!==this.signal[t]&&(delete this.signal[t],this.signal[t]=null),null!==this.fft[t]&&(delete this.fft[t],this.fft[t]=null),null!==this.context[t]&&(delete this.context[t],this.context[t]=null)},init_track:function(t){function e(t){var e=new ArrayBuffer(t.byteLength);return new Uint8Array(e).set(new Uint8Array(t)),e}this.buffer=t,this.clean();for(var i=e(t),s=e(t),n=0;n<2;n++)this.signal[n]=new Float32Array(this.buffer_size),this.waveform[n]=new Float32Array(this.buffer_size),this.fft[n]=new r(this.buffer_size,44100),this.context[n]=new AudioContext,this.source[n]=this.context[n].createBufferSource(),this.proc[n]=this.context[n].createScriptProcessor(this.buffer_size,2,2),this.source[n].connect(this.proc[n]),this.proc[n].connect(this.context[n].destination),this.proc[n].onaudioprocess=this.process_track[n],0==n?this.context[n].decodeAudioData(i,function(t){g.source[0].buffer=t},function(t){}):this.context[n].decodeAudioData(s,function(t){g.source[1].buffer=t,g.ready_track()},function(t){}),this.source[n].loop=!1},ready_track:function(){this.state="game",this.source[0].start(0),this.source[1].start(this.context[1].currentTime+3)},get_waveform:function(){return this.signal[1]},get_spectrum:function(t){return this.fft[t].spectrum},max_amplitude:function(t){var e=0,i=this.get_spectrum(0);if(!t.length)return t<i.length?i[~~t]:null;for(var s=t[0],n=t[1];s<=n;s++)i[s]>e&&(e=i[s]);return e},get_frequency:function(t,e){var i=0;if(void 0===e)return this.get_spectrum(1)[t];for(var s=t;s<=e;s++)i+=this.get_spectrum(1)[s];return i/(e-t+1)},process_track:[function(){2==g.source[0]&&(g.running[0]=!0);for(var t,e=event.inputBuffer.getChannelData(0),i=event.inputBuffer.getChannelData(1),s=(event.outputBuffer.getChannelData(0),event.outputBuffer.getChannelData(1),0),n=e.length;s<n;s++)t=parseFloat(e[s])+parseFloat(i[s]),g.waveform[0][2*s]=t/2,g.waveform[0][2*s+1]=t/2,g.signal[0][2*s]=.93*t,g.signal[0][2*s+1]=.93*t;g.fft[0].forward(g.signal[0]);var o,r,h,a,c,l,u=g.max_amplitude(g.frequency);u>=g.current_threshold&&g.threshold<=u?(o=p(f(g.angle+d(t/2.8))),r=320+900*Math.cos(o),h=240+900*Math.sin(o),a=!1,null!=g.last_pos&&g.delay<10&&!g.last_pos.inverted&&(a=!0,o=p(f(g.angle+180+t)),r=320+900*Math.cos(o),h=240+900*Math.sin(o)),o=m(r,h,320,240),c=10*Math.cos(o),l=10*Math.sin(o),g.add_particle(r,h,c,l,0,u,g.timer[0]),g.last_pos={x:r,y:h,dir:o,inverted:a},g.delay=0,g.current_threshold=u):g.current_threshold-=g.decay},function(){2==g.source[1].playbackState&&(g.running[1]||(g.time_diff=g.timer[0]),g.running[1]=!0);for(var t,e=event.inputBuffer.getChannelData(0),i=event.inputBuffer.getChannelData(1),s=event.outputBuffer.getChannelData(0),n=event.outputBuffer.getChannelData(1),o=0,r=e.length;o<r;o++)t=parseFloat(e[o])+parseFloat(i[o]),g.waveform[1][2*o]=t/2,g.waveform[1][2*o+1]=t/2,g.signal[1][2*o]=.93*t,g.signal[1][2*o+1]=.93*t;if(!g.mute&&g.running[1])for(o=0;o<e.length;++o)s[o]=e[o],n[o]=i[o];g.fft[1].forward(g.signal[1])}],particle:function(t,e,i,s,n,o,r){this.x=t,this.y=e,this.vx=i,this.vy=s,this.type=n,this.remove=!1,this.color=[1,1,1],this.alpha=1,this.size=5,this.render_size=5,this.base_size=5,this.magn=3*o,this.timer=0,this.angle=0,this.start=r,this.hit=!1},particles:[],particles_ids:[],add_particle:function(t,e,i,s,n,o,r){var h;0==this.particles_ids.length?this.particles.push(new this.particle(t,e,i,s,n,o,r)):(h=this.particles_ids.pop(),this.particles[h]=new this.particle(t,e,i,s,n,o,r))},init:function(){o.listen("click",o.canvas,function(){"menu"==g.state&&g.menu[0].entries[0].hover&&o.trigger("click",document.getElementById("local"))}),o.listen("change",document.getElementById("local"),function(t){for(var e,i=t.target.files,s=0;e=i[s];s++){if("audio/mp3"==e.type||"audio/mpeg"==e.type){g.state="loading",g.render(),setTimeout(function(){var t=new FileReader;t.onload=function(t){var e=this.result;g.init_track(e)},t.readAsArrayBuffer(e)},500);break}alert("MP3 file required.")}});for(var t=0;t<2;t++)this.init_menu(t)},update:function(){if(this.color[0]=this.rand(30,80)/100,this.color[1]=this.rand(30,80)/100,this.color[2]=this.rand(30,80)/100,"menu"==this.state)this.update_menu(0);else if("end"==this.state)this.update_menu(1);else if("game"==this.state)for(var t=0;t<this.particles.length;t++)null!==this.particles[t]&&(this.particles[t].remove?(delete this.particles[t],this.particles[t]=null,this.particles_ids.push(t)):this.particles[t].update());if(this.running[0]&&this.delay++,o.keypressed(37)&&(this.circle.angle[0]-=9),o.keypressed(39)&&(this.circle.angle[0]+=9),o.keypressed(38)&&0<this.tmp_points&&(this.points+=this.tmp_points,this.message("+"+this.tmp_points,1,.9,0),this.combo=0,this.angle_speed=1,this.tmp_points=0,this.circle.size[0]=this.circle.size[1]=this.circle.base_size),this.circle.angle=s(this.circle.angle,360,0),this.circle.angle[1]=this.circle.angle[0]+180,this.circle.size[1]=this.circle.size[0],this.running[1]){for(t=0;t<2;t++)this.running[t]&&this.timer[t]++;this.timer[1]%200==0&&50<g.rand(0,100)&&(this.angle_dir*=-1);var e=.2*this.get_frequency(1);.2<e&&(e=.2),this.angle+=this.angle_speed*this.angle_dir,this.viewport.zoom=1-e,0==this.context[1].activeSourceCount&&(this.end_points=this.points+this.tmp_points,this.stop(),this.state="end",this.render())}this.tick++,100<=this.tick&&(this.tick=0)},render_hud:function(){var t;a.unbind(),a.begin(0),a.vertex(5,50),a.vertex(635,50),a.end(),a.begin(0),a.vertex(5,430),a.vertex(635,430),a.end(),"game"==this.state?(this.write(5,440,o.get_fps()+"fps",5),t=(1e6-this.points).toString().length-this.points.toString().length+(0<this.points?1:0),this.write(635,10,"score "+"0".repeat(t)+this.points,5,2),t=(1e6-this.tmp_points).toString().length-this.tmp_points.toString().length+(0<this.tmp_points?1:0),this.write(635,440,"points "+"0".repeat(t)+this.tmp_points,5,2),this.write(320,227.5,"x"+this.combo,5,1),0<this.msg.timer&&(a.color(this.msg.r,this.msg.g,this.msg.b),this.write(320,195,this.msg.message,5,1),this.msg.timer--)):"loading"==this.state?this.write(320,220,"loading...",5,1):"end"==this.state?(this.write(320,10,"spastic",5,1),this.render_menu(1),a.color(1,1,1),this.write(320,300,"score "+this.end_points,5,1)):(this.write(320,10,"spastic",5,1),this.render_menu(0))},render:function(){a.clear(),this.running[1]&&(this.draw_bg(!1),this.draw_circle(512,384,100,0,2*Math.PI,1,"#000",!0)),a.push_matrix(),a.scale(this.viewport.zoom,this.viewport.zoom),a.translate(-this.viewport.x+this.width/2/this.viewport.zoom,-this.viewport.y+this.height/2/this.viewport.zoom),a.unbind(),this.running[1]&&(this.draw_bg(!0),this.draw_circle(512,384,100,0,2*Math.PI,1,"#000",!0));for(var t=0;t<this.particles.length;t++)null===this.particles[t]||this.particles[t].remove||this.particles[t].render();if(a.color(1,1,1),"game"==this.state)for(this.draw_circle(512,384,100,0,2*Math.PI,2,"#ccc",!1),t=0;t<2;t++)this.draw_circle(512,384,100,f(this.circle.angle[t])-this.circle.size[t],f(this.circle.angle[t])+this.circle.size[t],15,"#fff",!1);a.pop_matrix(),a.push_matrix(),this.render_hud(),a.pop_matrix()},rand:function(t,e){return t+Math.floor(Math.random()*e)},rect:function(t,e,i,s){a.begin(3),a.vertex(t,e),a.vertex(t+i,e),a.vertex(t+i,e+s),a.vertex(t,e+s),a.end()},quad:function(t,e,i,s){a.begin(3),a.vertex(t-i/2,e-s/2),a.vertex(t+i/2,e-s/2),a.vertex(t+i/2,e+s/2),a.vertex(t-i/2,e+s/2),a.end()},write:function(t,e,i,s,n){i=i.toString().toLowerCase().split("");var o=0;1==(n=n||0)?o=-(i.length*(6*s)-s)/2:2==n&&(o=-i.length*(6*s));for(var r=0;r<i.length;r++){var h=i[r];if(" "!=h)for(var a=this.font_letters[h].split(","),c=0;c<a.length;c++)this.rect(o+r*s+t+this.font_indices[a[c]][0]*s+r*(5*s),e+this.font_indices[a[c]][1]*s,s,s)}},draw_circle:function(t,e,i,s,n,o,r,h){h?a.context.fillStyle=r:a.context.strokeStyle=r,a.context.lineWidth=o,a.context.beginPath(),a.context.arc(t,e,i,s,n),h?a.context.fill():a.context.stroke()},draw_bg:function(t){for(var e,i=0;i<2;i++)0<this.bg[i].timer&&(e=p(f(360/(this.bg[i].x+1))),p(this.bg[i].x*e),t?(e=(this.bg[i].timer+20)/30,a.color(.5*this.bg[i].r*e,.5*this.bg[i].g*e,.5*this.bg[i].b*e)):a.color(.5*this.bg[i].r,.5*this.bg[i].g,.5*this.bg[i].b),a.begin(2),a.vertex(320,240),a.vertex(320+900*Math.cos(this.bg[i].angle+(t?f(this.angle):0)),240+900*Math.sin(this.bg[i].angle+(t?f(this.angle):0))),a.vertex(320+900*Math.cos(this.bg[i].angle+(t?f(this.angle):0)+f(30)),240+900*Math.sin(this.bg[i].angle+(t?f(this.angle):0)+f(30))),a.end(),t||this.bg[i].timer--)}};g.particle.prototype.update=function(){if(g.timer[1]>=this.start){if(this.hit&&(this.color[0]=g.color[0],this.color[1]=g.color[1],this.color[2]=g.color[2],500<h(320,240,this.x,this.y))&&(this.remove=!0),0==this.type){for(var t=!0,e=0;e<2;e++){f(g.circle.angle[e]-90);var i=d(m(320,240,this.x,this.y)),s=g.circle.angle[e]-d(g.circle.size[e]),n=g.circle.angle[e]+d(g.circle.size[e]),o=h(320,240,this.x,this.y);if(o<=80&&70<=o){if(i=(360+i%360)%360,(s=(36e5+s)%360)<(n=(36e5+n)%360)?s<=i&&i<=n:s<=i||i<=n){for(this.hit=!0,this.vx*=-1,this.vy*=-1,g.circle.size[0]-=.005,g.circle.size[1]-=.005,g.circle.size[0]<Math.PI/30&&(g.circle.size[0]=Math.PI/30),g.circle.size[1]<Math.PI/30&&(g.circle.size[1]=Math.PI/30),this.render_size=this.base_size*this.magn,g.combo++,g.angle_speed+=.02,g.scored++,g.tmp_points+=10*g.combo,e=0;e<2;e++)g.bg[e].x=g.rand(0,8),g.bg[e].y=g.rand(0,2),g.bg[e].r=g.rand(20,80)/100,g.bg[e].g=g.rand(20,80)/100,g.bg[e].b=g.rand(20,80)/100,g.bg[e].timer=0==e?25:30,g.bg[e].angle=f(g.rand(0,360));break}}else o<20&&1==e&&(t=!1)}t||(g.missed++,g.combo=0,g.tmp_points=0,this.remove=!0,g.angle_speed=1,g.message("miss",.8,.1,.1),g.circle.size[0]=g.circle.size[1]=g.circle.base_size)}1==this.type&&(this.size+=2,!(0<this.alpha)||(this.alpha-=.05,this.alpha<=0))&&(this.remove=!0),this.render_size>this.base_size&&(this.render_size-=.2),this.render_size<this.base_size&&(this.render_size=this.base_size),this.x+=this.vx,this.y+=this.vy}},g.particle.prototype.render=function(){a.color(this.color[0],this.color[1],this.color[2]),a.alpha(this.alpha),g.quad(this.x,this.y,2*this.render_size,2*this.render_size)},o.ready(function(){a.context=o.create("Spastic",1024,768,!0),a.ortho(0,g.width,g.height,0)}),o.init(function(){g.init()}),o.update(function(){g.update()}),o.render(function(){g.render()})</script>