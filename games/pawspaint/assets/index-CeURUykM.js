(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();function k(r,e){return Math.abs(r)>Math.abs(e)?r>0?"R":"L":Math.abs(e)>Math.abs(r)?e>0?"D":"U":null}function v(r){const e=`${r}`.split(".");for(;e.length<3;)e.push("0");let t=[];return e.forEach((s,i)=>{t.push({raw:s||null,type:parseInt(s)||0,data:s.replace(/[^a-zA-Z]/g,"")||null,spriteIndex:i,isEmpty:s==="0"||s===""})}),t}function M(r,e){let t=["0","0","0"];return r.forEach(s=>{t[s.spriteIndex]=s.raw||"0"}),t.join(".")}function x(r,e,t){for(const s of e)s instanceof r&&t(s)}function P(r){switch(r){case"U":return 0;case"R":return 90;case"D":return 180;case"L":return 270;default:return 0}}function A(r){switch(r){case"U":return{x:0,y:-1};case"R":return{x:1,y:0};case"D":return{x:0,y:1};case"L":return{x:-1,y:0};default:return{x:0,y:0}}}class f{pos;div;element;dir;g;id=crypto.randomUUID();billboard=!1;cameraPos;moving=!1;canWalkOver=!0;constructor(e){this.pos=e.pos,this.element=e.el,this.dir=e.el.data?.length===1?e.el.data[0]:"U",this.g=e.g,this.cameraPos={x:(this.g.w-1)/-2,y:4},this.div=this.divGenerator(e.animationName),this.setBillboard(),this.rotateTo(P(this.dir))}divGenerator(e){let t=document.createElement("div");return t.classList.add("sprite"),t.setAttribute("anim",e??"drop-animation"),t.style.gridArea=`${this.pos.y+1} / ${this.pos.x+1}`,t.style.setProperty("--rotZ",Math.atan2(this.pos.x+this.cameraPos.x,this.pos.y+this.cameraPos.y)+"rad"),t}setBillboard(e=!1){this.billboard=e,this.billboard?(this.div.setAttribute("sprite-render","billboard"),this.div.style.setProperty("--rotX","-90deg"),this.div.style.setProperty("--rotZ",Math.atan2(this.pos.x+this.cameraPos.x,this.pos.y+this.cameraPos.y)+"rad"),this.div.style.setProperty("--sprite-y-offset","-0.3rem"),this.div.style.setProperty("--sprite-z-offset","0.0rem"),this.div.style.transformOrigin="center bottom"):(this.div.setAttribute("sprite-render","flat"),this.div.style.setProperty("--rotX","0"),this.div.style.setProperty("--rotZ","0"),this.div.style.setProperty("--sprite-y-offset","0rem"),this.div.style.setProperty("--sprite-z-offset","0rem"),this.div.style.transformOrigin="center center")}setAnimation(e="no-animation"){this.div.setAttribute("anim",e)}rotateTo(e){this.div.style.setProperty("--rotZ",e+"deg")}moveTo(e,t=!1){!t&&(this.moving||this.g.getTileAt(e)===null||e.x<0||e.y<0||e.x>=this.g.w||e.y>=this.g.h)||(this.g.game.moveCount++,this.g.game.uiEl.querySelector(".moves-remaning").textContent=this.g.game.maxMoves?String(this.g.game.maxMoves-this.g.game.moveCount):"∞",this.g.game.maxMoves&&this.g.game.maxMoves-this.g.game.moveCount===0&&this.g.game.changeStatus("levelFailed"),this.moving=!0,this.dir=k(e.x-this.pos.x,e.y-this.pos.y)||this.dir,this.div.style.transition="none",this.div.style.transform=`
            translate3d(0, var(--sprite-y-offset), var(--sprite-z-offset))
            translate(${this.pos.x-e.x}rem, ${this.pos.y-e.y}rem)
            rotateZ(var(--rotZ))
            rotateX(var(--rotX))`,this.div.offsetWidth,this.div.style.transition="transform 0.3s ease-in-out",this.actionWhenMoving(e,this.dir),this.pos=e,this.div.style.gridArea=`${this.pos.y+1} / ${this.pos.x+1}`,this.div.style.setProperty("--rotZ",this.billboard?Math.atan2(this.pos.x+this.cameraPos.x,this.pos.y+this.cameraPos.y)+"rad":"0"),this.div.style.transform=`
            translate3d(0, var(--sprite-y-offset), var(--sprite-z-offset))
            translate(0rem, 0rem)
            rotateZ(var(--rotZ))
            rotateX(var(--rotX))`,setTimeout(()=>{this.moving=!1,this.hasChangedPosition(e,this.dir)},300))}actionWhenMoving(e,t){}hasChangedPosition(e,t){}dispose(){this.div?.remove()}}const m="15px",S=new Map([[1,"Marble"]]),C=new Map([[1,"Paint"],[2,"Yarn"],[3,"Soap"],[4,"Bucket"],[5,"Puddle"],[6,"Ladyline"],[7,"EmptyBucket"]]),j=new Map([[1,"Cat"],[2,"Mouse"],[3,"Lady"]]);class g extends f{constructor(e){super(e),setTimeout(()=>this.spawnElement(),e.spawnDelay)}spawnElement(){this.div.classList.add("base");const t=[this.chkBorder(-1,-1)?"0":m,this.chkBorder(1,-1)?"0":m,this.chkBorder(1,1)?"0":m,this.chkBorder(-1,1)?"0":m].join(" ");this.div.style.borderRadius=t,this.g.gEl?.appendChild(this.div)}chkNear(e,t){return(this.g.getTileAt({x:this.pos.x+e,y:this.pos.y+t})?.base??null)!==null}chkBorder(e,t){return this.chkNear(e,0)||this.chkNear(0,t)}removeElement(){this.g.bases=this.g.bases.filter(e=>e.id!==this.id),this.dispose()}}class l extends f{constructor(e){super(e),setTimeout(()=>this.spawnElement(),e.spawnDelay)}spawnElement(){this.div.classList.add("obj"),this.g.gEl?.appendChild(this.div)}removeElement(){this.g.objects=this.g.objects.filter(e=>e.id!==this.id),this.dispose()}}class c extends f{constructor(e){super(e),setTimeout(()=>this.spawnElement(),e.spawnDelay)}spawnElement(){this.div.classList.add("entity"),this.g.gEl?.appendChild(this.div)}removeElement(){this.g.entities=this.g.entities.filter(e=>e.id!==this.id),this.dispose()}}class p extends l{constructor(e){super(e),this.div.classList.add("obj-paint")}}class E extends l{constructor(e){super(e),this.div.classList.add("obj-puddle"),this.animateSpread()}animateSpread(){this.setAnimation("spread-animation"),setTimeout(()=>this.removeElement(),1e3)}}class w extends l{constructor(e){super(e),this.div.classList.add("obj-empty-bucket"),this.canWalkOver=!1}}class T extends l{isUsed;constructor(e){super(e),this.div.classList.add("obj-bucket"),this.setBillboard(!0),this.canWalkOver=!1,this.isUsed=!1}passingBy(e,t){if(!e||!t||this.isUsed)return;this.isUsed=!0,this.g.setTileAt(e,new w({pos:{...e},el:v(`0.7${t}`)[1],g:this.g,spawnDelay:0,animationName:"fade-animation"}));let s={...e};const i=A(t);for(;s={x:s.x+i.x,y:s.y+i.y},!(s.x<0||s.y<0||s.x>=this.g.w||s.y>=this.g.h);){const n=this.g.getTileAt(s);if(!n)break;n.obj&&n.obj instanceof p&&n.obj.removeElement(),this.g.setTileAt(s,new E({pos:{...s},el:v("0.5")[1],g:this.g,spawnDelay:0,animationName:"fade-animation"}))}this.removeElement()}}class d extends c{constructor(e){super(e),this.div.classList.add("entity-cat"),this.setBillboard(!0),this.canWalkOver=!1}moveCat(e){let t={x:this.pos.x,y:this.pos.y};t.x+=e.x,t.y+=e.y;const s=this.g.getTileAt(t);if(s.entity instanceof d){let i={x:t.x+e.x,y:t.y+e.y};const n=this.g.getTileAt(i);if(!n||!n.isWalkable)return}else if(!s||!s.isWalkable)return;this.moveTo(t)}actionWhenMoving(e,t){!e||!t||([{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}].forEach(n=>{const a={x:e.x+n.x,y:e.y+n.y},o=this.g.getTileAt(a),h=n.x===1?"R":n.x===-1?"L":n.y===1?"D":"U";console.log(a,o,h),o.obj&&o.obj instanceof T&&o.obj.passingBy(a,h)}),this.g.getTileAt(e).obj)||this.g.setTileAt(e,new p({pos:e,el:v("0.1"+t)[1],g:this.g,spawnDelay:0,animationName:"fade-animation"}))}hasChangedPosition(e,t){!e||!t||this.g.setTileAt(e,this)}}class B extends g{constructor(e){super(e),this.div.classList.add("walkable","base-marble")}actionWhenMoving(){console.log("Cat is moving to",this.pos)}hasChanegedPosition(){console.log("Cat moved to",this.pos)}}class R extends c{constructor(e){super(e),this.div.classList.add("entity-lady"),this.setBillboard(!0)}actionWhenMoving(){console.log("Lady is moving to",this.pos)}hasChanegedPosition(){console.log("Lady moved to",this.pos)}}class D extends c{constructor(e){super(e),this.div.classList.add("entity-mouse"),this.setBillboard(!0)}actionWhenMoving(){console.log("Mouse is moving to",this.pos)}hasChanegedPosition(){console.log("Mouse moved to",this.pos)}}class W extends l{constructor(e){super(e),this.div.classList.add("obj-ladyline")}}class N extends l{constructor(e){super(e),this.div.classList.add("obj-soap")}}class q extends l{constructor(e){super(e),this.div.classList.add("obj-yarn"),this.setBillboard(!0)}}function y(r,e){if(!r.el)return null;let t;switch(e){case g:t=S.get(r.el.type)||null;break;case l:t=C.get(r.el.type)||null;break;case c:t=j.get(r.el.type)||null;break}if(!t)return null;const i={Marble:B,Paint:p,Yarn:q,Soap:N,Bucket:T,EmptyBucket:w,Puddle:E,Ladyline:W,Cat:d,Mouse:D,Lady:R}[t];return i?new i(r):null}class U{game;p=[];bases=[];objects=[];entities=[];prevL=[];gEl;animate=!0;_extractedData=[];get objectsAll(){return[...this.bases,...this.objects,...this.entities]}get w(){return Math.max(...this.p.map(e=>e.length))}get h(){return this.p.length}constructor(e,t,s,i=!0,n=!0){this.game=s,this.gEl=t.appendChild(document.createElement("div")),this.gEl.classList.add("grid"),this.animate=n,this.setPattern(e,i)}getTileAt(e){const t=u=>u.find(b=>b.pos.x===e.x&&b.pos.y===e.y)??null,s=t(this.bases),i=t(this.objects),n=t(this.entities),a=!!(s||i||n),o=[s,i,n].filter(u=>u!==null),h=o.length===0?!0:o.every(u=>u.canWalkOver);return{pos:e,base:s,obj:i,entity:n,tileArray:[s,i,n],isTile:a,isWalkable:a&&h}}setTileAt(e,t){const s=n=>{const a=n.findIndex(o=>o.id===t.id);a!==-1&&n.splice(a,1)};t instanceof g&&(s(this.bases),this.bases.push(t)),t instanceof l&&(s(this.objects),this.objects.push(t)),t instanceof c&&(s(this.entities),this.entities.push(t));const i=e.y*this.w+e.x;i>=0&&i<this._extractedData.length&&(this.p=this.getPattern())}getPattern(){let e=[];for(let t=0;t<this.h;t++){let s=[];for(let i=0;i<this.w;i++){const n=this.getTileAt({x:i,y:t});let a=[];n.base&&a.push(n.base.element),n.obj&&a.push(n.obj.element),n.entity&&a.push(n.entity.element),s.push(M(a))}e.push(s)}return e}setPattern(e,t=this.animate,s=!0){this.p=e,this.p.forEach(i=>{const n=Array(this.w-i.length).fill(0);i.push(...n)}),this._extractedData=[];for(let i=0;i<this.h;i++)for(let n=0;n<this.w;n++)this._extractedData.push(v(this.p[i][n]));s&&this.loadGrid(t)}savePattern(){this.game.currentLevel&&(this.game.currentLevel={...this.game.currentLevel,pattern:this.getPattern(),moveCount:this.game.moveCount},this.prevL.push(this.game.currentLevel))}_goBackToLevel(e){e&&(this.setPattern(e.pattern,!1),this.game.moveCount=e.moveCount,e.maxMoves&&e.maxMoves-e.moveCount>0&&(this.game.status="inLevel"),this.game._setMovesRemaning(),console.log(e,this.game))}rewindLevel(){this.prevL.length!==0&&this._goBackToLevel(this.prevL.pop())}resetLevel(){this.prevL.length!==0&&(this._goBackToLevel(this.prevL[0]),this.prevL=[])}loadGrid(e){if(this.gEl===null)return;this.bases=[],this.objects=[],this.entities=[],this.gEl.innerHTML="",this.gEl.style.gridTemplate=`repeat(${this.h}, 1rem) / repeat(${this.w}, 1rem)`;let t=0;for(let s=0;s<this.h;s++)for(let i=0;i<this.w;i++){const n=this._extractedData[t];let a={base:null,obj:null,entity:null};const o=e?100*t+(e?500:0):0,h=e?"drop-animation":"no-animations";a.base=y({pos:{x:i,y:s},el:n[0],g:this,spawnDelay:o,animationName:h},g),a.obj=y({pos:{x:i,y:s},el:n[1],g:this,spawnDelay:o,animationName:h},l),a.entity=y({pos:{x:i,y:s},el:n[2],g:this,spawnDelay:o,animationName:h},c),a.base&&this.bases.push(a.base),a.obj&&this.objects.push(a.obj),a.entity&&this.entities.push(a.entity),t++}}keyEvent(e,t){this.savePattern(),e.key==="k"&&console.log(this.p);for(const s of this.entities)if(s instanceof d)switch(t){case"U":s.moveCat({x:0,y:-1});break;case"D":s.moveCat({x:0,y:1});break;case"L":s.moveCat({x:-1,y:0});break;case"R":s.moveCat({x:1,y:0});break}this.allTilesPainted()&&this.game.changeStatus("levelComplete")}mouseEvent(e){const t={x:e.type==="mousemove"?e.clientX/e.view.innerWidth-.5:0,y:e.type==="mousemove"?e.clientY/e.view.innerHeight-.5:0};this.gEl.style.setProperty("--rotX",t.y*20+"deg"),this.gEl.style.setProperty("--rotZ",t.x*20+"deg")}clickEvent(e){this.game.status==="levelComplete"&&this.game.loadNextLevel()}allTilesPainted(){for(let e=0;e<this.h;e++)for(let t=0;t<this.w;t++){const s=this.getTileAt({x:t,y:e});if(s.isTile&&(s.isWalkable||s.entity?.element.type===1)&&!(s.obj instanceof p))return!1}return!0}dispose(){this.gEl?.remove()}}class O{creator="Unknown";name="Untitled";id="unknown";levelsData=[];constructor(e){this.name=e.name,this.id=e.id,this.creator=e.creator,e.levels.forEach((t,s)=>{this.levelsData.push(new I(t,s))})}}class I{index=0;name;description;pattern;maxMoves=null;moveCount=0;levelData=null;constructor(e,t){this.index=t,this.levelData=e,this.name=e.name,this.description=e.description||"",this.pattern=e.pattern,e.maxMoves&&(this.maxMoves=e.maxMoves)}}const Z="nonoreo",G="Main Levels",$="main",F=[{name:"Beginning 1",description:"There once was a cat who needed to walk on every tiles to paint them.",pattern:[["1.1R.1",1,1,1,1]]},{name:"Beginning 2",description:"He was able to walk up, down, left and right.",pattern:[[1,1,1,0,1],[1,0,1,0,1],["1.1R.1",0,1,1,1]]},{name:"Beginning 3",description:"A big cataclysm happened, removing color from the world.",pattern:[[0,1,1,0,1],["1.1R.1",1,1,1,1]]},{name:"Beginning 4",description:"That's why he decided to repaint everything by himself!",pattern:[[1,1,1,0,"1.1R.1"],[1,1,1,1,1],[1,0,1,1,0]]},{name:"Beginning 5",description:"Sometimes, he had a maximum number of moves.",maxMoves:13,pattern:[[0,0,0,0,1],["1.1R.1",1,1,1,1],[0,0,1,1,1],[0,1,1,1,1]]},{name:"Beginning 6",description:"The path is often straightforward.",maxMoves:17,pattern:[[1,1,1,0,1],["1.1R.1",0,1,1,1],[1,1,1,0,1],[0,1,1,1,1]]},{name:"Beginning 7",description:"Buckets will wash already painted tiles.",pattern:[["1.1R.1",1,0,1.4,1],[1,1,0,0,1],[1,1,1,1,1]]},{name:"Beginning 8",maxMoves:11,pattern:[[1,1,1,1,1.1],[1,1,1,1.4,1.1],[1,1,"1.1R.1",0,1.1]]},{name:"Beginning 9",pattern:[["1.1R.1",1,1,1,1.1],[1,1.4,1,1.4,1.1],[1,1.4,0,0,1.1],[1,1.4,0,0,1.1]]},{name:"Beginning 10",maxMoves:21,pattern:[["1.1R.1",1,1.4,1,1.1],[1,1,1,1,1.1],[1.4,1,1,1,1.4],[1,1,1.4,1,1.1],[1.1,1,1,1,1.1]]},{name:"Beginning 11",maxMoves:11,pattern:[[1,1,"1.1R.1",1,1],[1,1.4,1.1,1.4,1],[1,1.1,1.1,1.1,1]]},{name:"TEST",description:"TEST",pattern:[["1.1R.1","1.1R.1",1,1,1.3],[0,1,1.4,0,1,1],[0,1,0,1,1.2]]},{name:"TEST",description:"TEST",pattern:[["1.1R.1",1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,"1.4",1,1,1,1],[1,1,1,1,1,1,1]]},{name:"TEST",description:"TEST",pattern:[["1.1R.1",1,1,0,1,1,1],[1,0,1,0,1,0,1],[1,1,1,0,"1.1R.1",1,1]]}],L={creator:Z,name:G,id:$,levels:F};class X{status="init";el;grid=null;levels=[];currentLevel=null;currentLevelIndex=0;currentLevelsID="main";moveCount=0;maxMoves=null;levelEl=document.querySelector(".level");uiEl=document.querySelector(".ui");constructor(e=document.getElementById("game")){if(!e)throw new Error("Game element not found");this.el=e,this.uiEl.querySelector(".follow-mouse").setAttribute("hidden",""),this.initGame()}initGame(){this.grid=new U([],this.levelEl,this,!1,!0),this.loadLevels(L),console.log(L);let e={U:["w","z","ArrowUp"],D:["s","ArrowDown"],L:["a","q","ArrowLeft"],R:["d","ArrowRight"]};window.addEventListener("keydown",t=>{let s=null;Object.entries(e).forEach(([i,n])=>{n.includes(t.key)&&(s=i)}),s!==null&&this.status==="inLevel"&&this.grid.keyEvent(t,s)}),window.addEventListener("mousemove",t=>{this.grid.mouseEvent(t),this._putDivToMouse(t)}),window.addEventListener("mouseout",t=>{this.grid.mouseEvent(t)}),window.addEventListener("click",t=>{this.grid.clickEvent(t)}),console.log(this.uiEl.querySelector(".undo")),this.uiEl.querySelector(".undo").onclick=()=>{this.grid?.rewindLevel()},this.uiEl.querySelector(".home").onclick=()=>{this.changeStatus("levelSelection")},this.uiEl.querySelector(".reset").onclick=()=>{this.grid?.resetLevel()}}loadLevels(e){this.levels.push(new O(e))}loadLevel(e,t){this.moveCount=0;const s=this.levels.find(i=>i.id===e)?.levelsData[t];if(!s){console.error("Level not found");return}this.currentLevel={...s,moveCount:0},this.currentLevelIndex=t,this.currentLevelsID=e,this.maxMoves=s.maxMoves??null,this.grid?.setPattern(s.pattern,!0),this.uiEl.querySelector(".level-name").textContent=s.name,this.uiEl.querySelector(".level-description").textContent=s.description,this.uiEl.querySelector(".moves-remaning-div").hidden=!this.maxMoves,this._setMovesRemaning(),this.changeStatus("inLevel")}loadNextLevel(){this.currentLevelIndex++,this.loadLevel(this.currentLevelsID,this.currentLevelIndex),this.changeStatus("inLevel"),this.grid.prevL=[]}changeStatus(e){switch(this.status=e,this.uiEl.querySelector(".follow-mouse").setAttribute("hidden",""),e){case"init":break;case"intro":break;case"levelSelection":break;case"inLevel":this.uiEl.setAttribute("visible","true");break;case"levelComplete":this.uiEl.setAttribute("visible","false"),this.uiEl.querySelector(".follow-mouse").removeAttribute("hidden"),x(d,this.grid.entities,t=>t.setAnimation("joy-animation"));break;case"levelFailed":x(d,this.grid.entities,t=>t.setAnimation("sad-animation"))}}_putDivToMouse(e){const t=this.uiEl.querySelector(".follow-mouse");t.style.left=e.clientX+"px",t.style.top=e.clientY+"px"}_setMovesRemaning(){this.uiEl.querySelector(".moves-remaning").textContent=this.maxMoves?String(this.maxMoves-this.moveCount):"∞"}}const z=new X;setTimeout(()=>{console.log("Game started"),z.loadLevel("main",10)},1e3);
