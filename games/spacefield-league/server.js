(()=>{let a=3000,b=['#e03636','#17ae09','#ff0','#ff3ba5','#0ff'],c=['Omicronians','Brain Slugs','Amphibiosans','Nibblonians','Blobs','Robots','Humans'],e=(a)=>Math.ceil(Math.random()*a),f=(a)=>a&&0<=a.px&&0<=a.py&&99>=a.px&&99>=a.py,d=(b,c)=>{let d=b.filter((a)=>a!=c);return d[e(d.length)-1]},g=0;class h{constructor(f){let h=d(b),i=d(b,h),j=d(c),k=d(c,j);this.ss={},this.pc={},this.ps={},this.s={m:{_:{id:++g,started:!1,ended:!1,sleeping:!1,time:a,name:f.name,maxp:f.maxp,minp:f.minp}},p:{},w:{},ba:{_:{id:'ba',px:48+e(2),py:48+e(2)}},t:{a:{id:'tA',name:j,color:h,score:0},b:{id:'tB',name:k,color:i,score:0}},bl:{}},this.lt=null,this.ap=null,this.lgt=a,this.st={goal:{},assist:{},pass:{},recover:{},loss:{},og:{},touch:{},vote:{}};for(let a=20;80>a;a++)[30,69].forEach((b)=>{let c='b'+a+'_'+b;this.s.bl[c]={id:c,px:a,py:b,x:a}});this.interval=setInterval(()=>{let a=!1;if(!this.s.m._.sleeping&&!this.s.m._.ended&&this.s.m._.started&&(0<this.s.m._.time&&this.s.m._.time--,!this.cg())){for(let b in this.s.p){let c=this.s.p[b];if(c.u(this),!a&&this.ub(c.px,c.py,c.dir,c.power)){let b=this.lt;if(this.lt=c.cid,b&&b!=this.lt){let a=this.s.p[this.cti(b)];if(a){let c=a.team,d=this.s.p[this.cti(this.lt)].team;c==d?(this.inc('pass',b),this.ap=b):(this.inc('recover'),this.inc('loss',b),this.ap=null)}}this.inc('touch'),c.back(this),c.stop(1),c.rp(),a=!0}}if(250==this.lgt-this.s.m._.time)for(let a in this.s.bl)47<=this.s.bl[a].px&&53>this.s.bl[a].px&&(this.s.bl[a].px+=50<=this.s.bl[a].px?3:-3)}if(this.bc(),this.s.m._.ended)clearInterval(this.interval);else if(0>=this.s.m._.time||0==Object.keys(this.s.p).length){this.s.m._.ended=!0;let a=this.s.t.a.score>this.s.t.b.score?'a':this.s.t.a.score<this.s.t.b.score?'b':'';this.bc('stats',{p:this.st,t:a?this.s.t[a].name+' won':'draw',w:a}),console.log(this.s.m._.name,this.st)}},100)}ub(a,b,c,d){let g=!1,h=()=>{let d={px:a,py:b};if(a==this.s.ba._.px&&b==this.s.ba._.py){c==U?d.py--:c==D?d.py++:c==L?d.px--:c==R&&d.px++}return f(d)&&this.fp(d)?(this.s.ba._.px=d.px,this.s.ba._.py=d.py,g=!0,1):void 0};for(;0<d&&h();)a=this.s.ba._.px,b=this.s.ba._.py,d--;if(!this.fp(this.s.ba._)){let a={py:this.s.ba._.py,px:this.s.ba._.px};L==c||R==c?1==e(2)?a.py++:a.py--:1==e(2)?a.px++:a.px--,f(a)&&this.fp(a)&&(this.s.ba._.px=a.px,this.s.ba._.py=a.py)}return g}cg(){if(0==this.s.ba._.py||99==this.s.ba._.py){let a=0==this.s.ba._.py?'b':'a';return this.s.t[a].score++,this.s.p[this.cti(this.lt)].team==a?this.inc('goal'):this.inc('og'),this.ap&&this.s.p[this.cti(this.ap)].team==a&&this.inc('assist',this.ap),this.lgt=this.s.m._.time,this.sf(2e3).then(()=>{this.r()}),!0}}r(){for(let a in this.s.ba._.px=this.s.ba._.py=50,this.lt=null,this.s.p)this.s.p[a].r();for(let a in this.s.bl)this.s.bl[a].px=this.s.bl[a].x}sf(a){return this.s.m._.sleeping=!0,new Promise((b)=>{setTimeout(()=>{this.s.m._.sleeping=!1,b()},a)})}adp(c,d,e,f){for(let a in this.s.p)if(this.s.p[a].cid==e)return;if(this.f())return void(this.s.w[c]={cid:e,name:d,id:c});let g,h=this.cp('a'),a=this.cp('b');g=h>a?'b':'a',this.s.p[c]=new i({id:c,team:g,name:d,cid:e,v:f},this),!this.s.m._.started&&this.cp()>=this.s.m._.minp&&(2>this.cp()?this.s.m._.started=!0:this.sf(2e3).then(()=>{this.s.m._.started=!0})),this.inc('vote',e,0)}cti(a){for(let b in this.s.p)if(this.s.p[b].cid==a)return b}cp(a){let b=0;for(let c in this.s.p)a&&this.s.p[c].team!=a||b++;return b}fp(a){for(let b in this.s.p)if(this.s.p[b].px==a.px&&this.s.p[b].py==a.py)return!1;for(let b in this.s.bl)if(this.s.bl[b].px==a.px&&this.s.bl[b].py==a.py)return!1;return!0}inc(a,b,c=1){b||(b=this.lt);let d=this.st[a];d[b]||(d[b]={name:this.s.p[this.cti(b)].name,v:'vote'==a?5:0,t:this.s.p[this.cti(b)].team}),d[b].v+=c;let e={goal:0.35,og:-0.3,recover:0.15,loss:-0.1,touch:5e-3,pass:0.15,assist:0.15}[a];e&&this.inc('vote',b,e)}f(){return this.cp()>=this.s.m._.maxp}bc(a,b){let c;for(let d in this.ss)if(a)this.ss[d].emit(a,b);else if(!this.ss[d]._firstSend)this.ss[d].emit('update',this.s),this.ss[d]._firstSend=!0;else{if(!c)for(let a in c=[],this.s)for(let b in this.s[a])for(let d in this.s[a][b]){if('_'==d[0])continue;let e=this.ps,f=this.s[a][b][d];e[a]&&e[a][b]&&void 0!=e[a][b][d]&&e[a][b][d]==f||c.push({k:`${a}.${b}.${d}`,v:f})}this.ss[d].emit('update',{patches:c})}a||(this.ps=JSON.parse(JSON.stringify(this.s)))}}class i{constructor(a,b){this.id=a.id,this.cid=a.cid,this.name=a.name,this.v=a.v,this.team=a.team,this.px,this.py,this.power,this.powerL,this.dir,this._dirs=[],this.energy,this.info='',this.stopped=0,this._ld,this.r(),b.pc[this.cid]?(this.px=b.pc[this.cid].px,this.py=b.pc[this.cid].py):b.pc[this.cid]={px:this.px,py:this.py}}u(a){0<this.stopped&&this.stopped--,this._dirs.length?this.dir=this._dirs.splice(0,1)[0]:!this._ld&&(this.dir=''),a.pc[this.cid]={px:this.px,py:this.py};let b={px:this.px,py:this.py};this.stopped||(this.dir==U?b.py--:this.dir==D?b.py++:this.dir==L?b.px--:this.dir==R&&b.px++);f(b)&&a.fp(b)&&(this.px=b.px,this.py=b.py),this.power==this.h()&&100>this.energy&&(this.energy+=V[this.v].rec/4),100<this.energy&&(this.energy=100),this.info=100>this.energy?'LOST ENERGY':''}go(a,b){let c=this.dir;this._dirs.length&&(c=this._dirs[0]),this._ld=b;c==a||this._dirs.push(a)}shot(){100==this.energy&&(this.power=4*V[this.v].shot,this.powerL=!0)}stop(a){this.stopped+=a}switch(a){let b='a'==this.team?'b':'a';a.s.m._.started||a.f()||!(a.cp(b)<a.s.m._.maxp/2)||(this.team=b,this.py='a'==this.team?4:95)}r(){this.px=e(98),this.py='a'==this.team?4:95,this.dir='',this._dirs=[],this.energy=100,this.power=this.h(),this.info='',this.powerL=!1,this.stopped=0,this._ld=!1}rp(){this.power!=this.h()&&(this.power=this.h(),this.energy=0,this.powerL=!1)}back(a){let b=a.pc[this.cid];b&&(this.px=b.px,this.py=b.py)}h(){return V[this.v].hit/2}}let j=(a)=>a.replace(/[<>]/gi,''),k={};setInterval(()=>{for(let a in k)k[a].s.m._.ended&&delete k[a]},10000),module.exports=(a)=>{let b=a.handshake.query.cid,c=j(a.handshake.query.name.substr(0,12)),d=j((a.handshake.query.room||'training').substr(0,14)),e=parseInt(a.handshake.query.playersNr||0),f=a.handshake.query.v,g='training'==d;(!k[d]||k[d].s.m._.ended||k[d].f()&&g)&&(0==e&&k[d]&&(e=k[d].s.m._.maxp),!e&&(e=10),k[d]=new h({name:d,maxp:e,minp:g?1:e}),console.log('new match',k[d].s.m._.id,d)),a.m=k[d],a.on('disconnect',()=>{a.m.s.p[a.id]?(a.m.s.p[a.id].deleted=!0,a.m.bc(),delete a.m.s.p[a.id]):a.m.s.w[a.id]&&delete a.m.s.w[a.id],delete a.m.ss[a.id]}),a.on('move',(b)=>{a.m.s.m._.started&&a.m.s.p[a.id]&&a.m.s.p[a.id].go(b.dir,b.lock)}),a.on('shot',()=>{a.m.s.p[a.id]&&a.m.s.p[a.id].shot()}),a.on('switch',()=>{a.m.s.p[a.id]&&a.m.s.p[a.id].switch(a.m)}),a.on('roomlist',()=>{let b=[{room:'training'}];for(let a in k){let c=k[a].cp();0<c&&'training'!=a&&b.push({room:a,p:c,m:k[a].s.m._.maxp})}a.emit('rooms',b)}),a.on('msg',(b)=>{if(a.m.s.p[a.id])b.user=a.m.s.p[a.id].name,b.team=a.m.s.p[a.id].team;else if(a.m.s.w[a.id])b.user=a.m.s.w[a.id].name;else return;console.log(a.m.s.m._.name,'-',b.user,':',b.text),b.text=j(b.text),a.m.bc('msg',b)}),console.log(c,'join',d),a.m.ss[a.id]=a,a.m.adp(a.id,c,b,f),a.m.bc()}})();