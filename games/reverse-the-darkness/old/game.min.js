/*! intothedark 2015-09-10 */
function uEnd(a,b){this.color="rgb(255, 0, 0)",this.power=.25,this.state&&this.interactive&&a.level>0&&endLevel(a,!0)}function uHBounce(a,b){return function(c,d){d/=b,this.x=this.originX+Math.sin(d)*a}}function uVBounce(a,b,c){return c=c||0,function(d,e){e/=b,this.y=this.originY+Math.sin(e+c)*a}}function uCircle(a,b){return function(c,d){d/=b;var e=d%360,f=Math.cos(e*Math.PI/180)*a,g=Math.sin(e*Math.PI/180)*a;this.x=this.originX+f,this.y=this.originY+g}}function loadAssets(a){var b=new Image,c=[["lightOff",0,0,26,70],["lightOn",26,0,26,70],["floaterOff",52,0,26,70],["floaterOn",78,0,26,70],["orbOff",104,0,30,30],["orbOn",104,30,30,30]];b.onload=function(){for(var b=0,d=c.length;d>b;b++){var e=c[b];sprites[e[0]]=document.createElement("canvas");var f=sprites[e[0]].getContext("2d");sprites[e[0]].width=e[3],sprites[e[0]].height=e[4],f.drawImage(this,e[1],e[2],e[3],e[4],0,0,e[3],e[4])}a()},b.src="sprites.png"}function stageCoordToViewport(a,b){return{x:(a.x-b.viewport.bx)*b.viewport.z,y:(a.y-b.viewport.by)*b.viewport.z}}function viewportToStageCoord(a,b){return{x:a.x/b.viewport.z+b.viewport.bx,y:a.y/b.viewport.z+b.viewport.by}}function start(a){function b(){a.levelInit(a),a.dateStart=new Date,a.inLoop=!0,gameLoop()}a.inLoop=!1,a.level<2?setTip("<h1>Reverse the Darkness</h1>",3e3,function(){b()}):(setTip(""),b())}function prepareLevel(a,b,c){teardownControls(b);var d=levelMeta[a];b.level=a,b.levelMeta=d,b.maxLightRadius=d.lr,b.powerDrainPerLight=d.ld,b.lights=[];for(var e={x:1e5,y:1e5,w:0,h:0},f=0,g=d.l.length;g>f;f++)b.lights.push(new Light(d.l[f].x,d.l[f].y,d.l[f].i,d.l[f].s,d.l[f].p,d.l[f].col,d.l[f].t)),e.x=Math.min(e.x,d.l[f].x),e.y=Math.min(e.y,d.l[f].y),e.w=Math.max(e.w,Math.abs(e.x-d.l[f].x)),e.h=Math.max(e.h,Math.abs(e.y-d.l[f].y));b.viewport.z=b.viewport.ztgt=Math.min(.8*Math.min(window.innerHeight/e.h,window.innerWidth/e.w),2),b.viewport.cx=b.viewport.cxtgt=b.lights[b.lights.length-1].state?.5*(b.lights[b.lights.length-1].x+b.lights[0].x)-.5*d.sw:0,b.viewport.cy=b.viewport.cytgt=b.lights[b.lights.length-1].state?.5*(b.lights[b.lights.length-1].y+b.lights[0].y)-.5*d.sh:0,b.levelTick=d.lvlt||function(){},b.levelInit=d.lvli||function(){},b.levelEnd=d.lvle||function(){};var h=new Image;h.onload=function(){var a=document.createElement("canvas");a.width=d.sw,a.height=d.sh;var e=a.getContext("2d"),f=e.createPattern(this,"repeat");e.rect(0,0,d.sw,d.sh),e.fillStyle=f,e.fill(),b.bg=a,b.stage.w=d.sw,b.stage.h=d.sh,setupControls(b,c)},h.src="bg.jpg"}function setupControls(a,b){var c,d,e,f,g=300,h=10,i=!1;document.body.addEventListener("mousedown",controls.mousedown=controls.touchstart=function(a){c=(new Date).getTime(),d="touchstart"===a.type?{x:a.touches[0].clientX,y:a.touches[0].clientY}:{x:a.clientX,y:a.clientY}},!1),document.body.addEventListener("touchstart",controls.touchstart,!1),document.body.addEventListener("mouseup",controls.mouseup=controls.touchend=function(a){var b=(new Date).getTime()-c;if(g>b&&b>0){var f=new CustomEvent("tap",{detail:d});document.body.dispatchEvent(f)}c=0,d=null,e=!1},!1),document.body.addEventListener("touchend",controls.touchend,!1),document.body.addEventListener("mousemove",controls.mousemove=controls.touchmove=function(b){var g="touchmove"===b.type?b.touches[0].clientX:b.clientX,i="touchmove"===b.type?b.touches[0].clientY:b.clientY;if(e){var j=d.x-g,k=d.y-i;a.viewport.cxtgt=a.viewport.cx=f.x+j/a.viewport.z,a.viewport.cytgt=a.viewport.cy=f.y+k/a.viewport.z}else d&&(Math.abs(g-d.x)>h||Math.abs(i-d.y)>h)&&(c=0,e=!0,f={x:a.viewport.cx,y:a.viewport.cy})}),document.body.addEventListener("touchmove",controls.touchmove,!1),window.addEventListener("mouseout",controls.mouseout=function(){c=0,d=null,e=!1},!1),document.body.addEventListener("tap",controls.tap=function(b){var c=viewportToStageCoord(b.detail,a),d=c.x,e=c.y,f=ctxMask.getImageData(b.detail.x,b.detail.y,1,1).data,g=f[0]<<16|f[1]<<8|f[2];if(65e3>g)return!1;for(var h=0,j=a.lights.length;j>h;h++)a.lights[h].interactive&&a.lights[h].hitTest(d,e)&&(a.lights[h].state=!a.lights[h].state,h===a.lights.length-1||i||(i=!0,a.lights[0].interactive=1,a.lights[a.lights.length-1].state=0,a.lights[a.lights.length-1].interactive=1,a.viewport.ztgt=a.levelMeta.sz||1,a.viewport.cxtgt=a.levelMeta.sx-.5*a.levelMeta.sw,a.viewport.cytgt=a.levelMeta.sy-.5*a.levelMeta.sh))},!1),b()}function teardownControls(state,cb){with(document.body)for(var i in controls)removeEventListener(i,controls[i],!1);cb&&cb()}function setTip(a,b,c){var d=document.getElementsByTagName("div")[0];d.innerHTML=a||"",d.className="",console.log(a,b,c),b?setTimeout(function(){d.className="clear",setTimeout(function(){c&&c()},1e3)},b):a||(d.className="")}function gameLoop(){gameState.inLoop&&requestAnimationFrame(gameLoop),renderGame(gameState)}function nextLevel(a){return a.inLoop=!1,setTip("",1,function(){prepareLevel(a.level+1,a,function(){start(a)})}),!1}function endLevel(a,b){if(!b)return a.inLoop=!1,void setTip("You're alone, in the dark.",2e3,function(){prepareLevel(1,gameState,function(){start(gameState)})});for(var c=a.lights.length-2;c>=0;c--)a.lights[c].state=!1;var d=a.lights[a.lights.length-1];d.state=!0,d.interactive=!1,a.viewport.cxtgt=d.x-.5*a.stage.w,a.viewport.cytgt=d.y-.5*a.stage.h,a.viewport.ztgt=2,window.nextLevel=function(){return a.inLoop=!1,ctxMain.width=ctxMain.width,ctxMain.height=ctxMain.height,levelMeta.length<=a.level+1?setTip("<h1>The End</h1><p>You've got yourself a nice bag of orbs there.</p>"):prepareLevel(a.level+1,a,function(){start(a)}),!1},setTip('<button onclick="nextLevel()" type="button">Play more?</button>')}function renderGame(a){cMain.width=cMain.width,cMain.height=cMain.height,a.viewport.z+=.03*(a.viewport.ztgt-a.viewport.z),a.viewport.cx+=.03*(a.viewport.cxtgt-a.viewport.cx),a.viewport.cy+=.03*(a.viewport.cytgt-a.viewport.cy),a.viewport.bw=window.innerWidth/a.viewport.z,a.viewport.bh=window.innerHeight/a.viewport.z,a.viewport.bx=.5*(a.stage.w-a.viewport.bw)+a.viewport.cx,a.viewport.by=.5*(a.stage.h-a.viewport.bh)+a.viewport.cy,a.numActiveLights=0;for(var b=0,c=a.lights.length;c>b;b++)a.numActiveLights+=a.lights[b].state;for(var b=0,c=a.lights.length;c>b;b++)a.lights[b].targetPower=Math.pow(a.powerDrainPerLight,a.numActiveLights-1),a.lights[b].updateTick(a,(new Date).getTime()-a.dateStart.getTime());return a.level>0&&a.numActiveLights<1?void endLevel(a,!1):(a.levelTick(a,(new Date).getTime()-a.dateStart.getTime()),renderStage(a),renderSprites(a),void renderMask(a))}function renderStage(a){ctxMain.drawImage(a.bg,-a.viewport.bx*a.viewport.z,-a.viewport.by*a.viewport.z,a.stage.w*a.viewport.z,a.stage.h*a.viewport.z)}function renderSprites(a){for(var b,c,d,e=0,f=a.lights.length;f>e;e++){d=a.lights[e];var g=stageCoordToViewport(d,a);b=g.x,c=g.y,d.plotSprite(a,ctxMain,b,c)}}function renderMask(a){ctxMask.globalCompositeOperation="source-over",ctxMask.fillStyle="#000000",ctxMask.fillRect(0,0,cMask.width,cMask.height),ctxMask.globalCompositeOperation="lighter";for(var b,c,d,e,f,g,h=0,i=a.lights.length;i>h;h++)f=a.lights[h],f.state&&(d=2*a.maxLightRadius*a.viewport.z*f.power,e=stageCoordToViewport(f,a),b=e.x,c=e.y,g=ctxMask.createRadialGradient(b,c,.45*d*f.power,b,c,.5*d),g.addColorStop(0,f.color),g.addColorStop(1,"black"),ctxMask.beginPath(),ctxMask.arc(b,c,.5*d,0,2*Math.PI,!1),ctxMask.fillStyle=g,ctxMask.fill());ctxMain.globalCompositeOperation="multiply",ctxMain.drawImage(cMask,0,0),ctxMain.globalCompositeOperation="source-over"}var levelMeta=[{sw:1e3,sh:500,sx:200,sy:250,sz:1,lr:150,ld:.9,lvli:function(a){a.lights.length;setTip("<p>Illuminate the darkness around you,<br/>by tapping the lamps ...</p>",3e3,function(){setTip("<p>... and finding your way ...</p>",3e3,function(){setTip("<p>... to the orb of awesomeness.</p>",3e3,function(){})})}),a.lights[0].state=!0,setTimeout(function(){a.lights[1].state=!0},2e3),setTimeout(function(){a.lights[2].state=!0,a.viewport.cxtgt=400-.5*a.stage.w},2500),setTimeout(function(){a.lights[3].state=!0,a.viewport.cxtgt=500-.5*a.stage.w},3e3),setTimeout(function(){a.lights[4].state=!0,a.viewport.cxtgt=600-.5*a.stage.w},3500),setTimeout(function(){a.lights[0].state=!1},6e3),setTimeout(function(){a.lights[1].state=!1},6500),setTimeout(function(){a.lights[2].state=!1},7e3),setTimeout(function(){a.lights[3].state=!1},7500),setTimeout(function(){a.lights[5].state=!0,a.viewport.cxtgt=700-.5*a.stage.w},8e3),setTimeout(function(){a.lights[6].state=!0,a.viewport.cxtgt=800-.5*a.stage.w},8500),setTimeout(function(){a.lights[0].state=a.lights[4].state=a.lights[5].state=!1,a.viewport.ztgt=2},1e4),setTimeout(function(){window.localStorage.tut=!0,a.lights[6].state=!1,setTip("<p>Now your turn ...</p>",2e3,function(){nextLevel(a)})},13e3)},l:[{x:200,y:250},{x:300,y:250},{x:400,y:250},{x:500,y:250},{x:600,y:250},{x:700,y:250},{x:800,y:250,t:2,p:uEnd}]},{sw:1e3,sh:500,sx:500,sy:250,sz:1,lr:150,ld:.9,l:[{x:200,y:250,s:1},{x:300,y:250,i:1},{x:400,y:250,i:1},{x:500,y:250,i:1},{x:600,y:250,i:1},{x:700,y:250,i:1},{x:800,y:250,s:1,i:0,t:2,p:uEnd}]},{sw:1e3,sh:1e3,sx:500,sy:500,sz:1,lr:200,ld:.9,lvli:function(a){setTip("<p>&quot;A step in the wrong direction,<br/>is yet a step of discovery.&quot;<br/><em>&mdash; Anon.</em></p>",3e3)},l:[{x:200,y:200,i:0,s:1},{x:268,y:326,i:1,s:0},{x:359,y:582,i:1,s:0},{x:288,y:473,i:1,s:0},{x:338,y:181,i:1,s:0},{x:491,y:173,i:1,s:0},{x:759,y:430,i:1,s:0},{x:631,y:187,i:1,s:0},{x:782,y:545,i:1,s:0},{x:746,y:294,i:1,s:0},{x:788,y:680,i:1,s:0},{x:800,y:800,s:1,i:0,t:2,p:uEnd}]},{sw:1e3,sh:1e3,sx:500,sy:500,sz:1,lr:200,ld:.9,lvli:function(a){setTip("<p>&quot;Jump aboard! We're headed for the moon!&quot;<br/><em>&mdash; Bob.</em></p>",3e3)},l:[{x:200,y:200,i:0,s:1},{x:400,y:200,i:1,s:0,t:1,p:uHBounce(50,500)},{x:580,y:200,i:1,s:0},{x:668,y:297,i:1,s:0},{x:677,y:556,i:1,s:0},{x:742,y:688,i:1,s:0},{x:673,y:418,i:1,s:0},{x:800,y:800,s:1,i:0,t:2,p:uEnd}]},{sw:1e3,sh:1700,sx:500,sy:625,sz:1,lr:200,ld:.9,lvli:function(a){setTip("<p>&quot;What goes around, comes around.&quot;<br/><em>&mdash; Anon.</em></p>",3e3)},l:[{x:500,y:500,i:0,s:1},{x:500,y:500,i:1,s:1,t:1,p:uCircle(125,25)},{x:500,y:750,i:1,s:0},{x:500,y:1e3,i:1,s:0,t:1,p:uCircle(125,-25)},{x:500,y:1250,i:1,s:0},{x:500,y:1400,i:0,s:1,t:2,p:uEnd}]},{sw:600,sh:600,sx:100,sy:100,sz:1,lr:100,ld:.8,lvli:function(a){setTip("<p>&quot;Sometimes, there's not a lot of light to go around.&quot;<br/><em>&mdash; The Deity of Light</em></p>",3e3)},l:[{x:100,y:100,i:0,s:1},{x:385,y:270,i:1,s:0},{x:160,y:120,i:1,s:0},{x:225,y:140,i:1,s:0},{x:285,y:160,i:1,s:0},{x:130,y:240,i:1,s:0},{x:115,y:160,i:1,s:0},{x:346,y:188,i:1,s:0},{x:400,y:365,i:1,s:0},{x:429,y:452,i:1,s:0},{x:500,y:500,s:1,i:0,t:2,p:uEnd}]},{sw:2e3,sh:2e3,sx:700,sy:1e3,sz:1,lr:200,ld:.9,lvli:function(a){setTip("<p>&quot;A journey of a thousand miles<br/>begins with a single step.&quot;<br/><em>&mdash; Laozi</em></p>",3e3)},l:[{x:700,y:1e3,i:1,s:1},{x:702,y:867,i:1,s:0},{x:702,y:750,i:1,s:0},{x:701,y:640,i:1,s:0},{x:700,y:530,i:1,s:0},{x:475,y:530,i:1,s:0},{x:925,y:530,i:1,s:0},{x:475,y:640,i:1,s:0},{x:475,y:750,i:1,s:0},{x:475,y:867,i:1,s:0},{x:475,y:1e3,i:1,s:0},{x:475,y:1150,i:1,s:0},{x:700,y:1300,i:1,s:0,t:1,p:uHBounce(225,1e3)},{x:1050,y:1300,i:1,s:0,t:1,p:uHBounce(-225,1e3)},{x:1450,y:1300,i:1,s:0},{x:1450,y:1150,i:1,s:0},{x:1450,y:1e3,i:1,s:0},{x:1225,y:1e3,i:1,s:0,t:1,p:uHBounce(125,750)},{x:699,y:389,i:1,s:0,t:1,p:uHBounce(225,1e3)},{x:1e3,y:1e3,s:1,i:0,t:2,p:uEnd}]},{sw:800,sh:800,sx:400,sy:400,sz:1,lr:130,ld:.9,lvli:function(a){setTip("<p>&quot;Extinguish the light to see more clearly.&quot;<br/><em>&mdash; The Dungeon Master</em></p>",3e3)},l:[{x:200,y:200,i:1,s:1,t:0},{x:300,y:200,i:1,s:1,t:0},{x:400,y:200,i:1,s:1,t:0},{x:500,y:200,i:1,s:1,t:0},{x:600,y:200,i:1,s:1,t:0},{x:200,y:300,i:1,s:1,t:0},{x:300,y:300,i:1,s:1,t:0},{x:400,y:300,i:1,s:1,t:0},{x:500,y:300,i:1,s:1,t:0},{x:600,y:300,i:1,s:1,t:0},{x:200,y:400,i:1,s:1,t:0},{x:300,y:400,i:1,s:1,t:0},{x:400,y:400,i:1,s:1,t:0},{x:500,y:400,i:1,s:1,t:0},{x:600,y:400,i:1,s:1,t:0},{x:200,y:500,i:1,s:1,t:0},{x:300,y:500,i:1,s:1,t:0},{x:400,y:500,i:1,s:1,t:0},{x:500,y:500,i:1,s:1,t:0},{x:600,y:500,i:1,s:1,t:0},{x:200,y:600,i:1,s:1,t:0},{x:300,y:600,i:1,s:1,t:0},{x:400,y:600,i:1,s:1,t:0},{x:500,y:600,i:1,s:1,t:0},{x:600,y:600,i:1,s:1,t:0},{x:250,y:450,s:0,i:0,t:2,p:uEnd}]}],cMain,ctxMain,cMask,ctxMask,sprites={lightOff:null,lightOn:null,floaterOff:null,floaterOn:null},controls={mouseup:null,mousedown:null,mousemove:null,mouseout:null,tap:null,touchstart:null,touchend:null,touchmove:null},gameState={inLoop:!1,level:0,bg:null,dateStart:null,levelTick:null,levelInit:null,levelEnd:null,viewport:{z:1,ztgt:1,cx:0,cxtgt:0,cy:0,cytgt:0,bx:0,by:0,bw:0,bh:0},stage:{w:0,h:0},maxLightRadius:null,powerDrainPerLight:.9,numActiveLights:0,lights:[]},Light=function(a,b,c,d,e,f,g){this.x=a,this.y=b,this.originX=a,this.originY=b,this.interactive=1===c,this.state=1===d,this.tickFunc=e?"function"==typeof e?[e]:e:[function(){}],this.color=f||"rgb(230, 230, 220)",this.type=g||0,this.power=1,this.targetPower=1,this.updateTick=function(a,b){for(var c=0,d=this.tickFunc.length;d>c;c++)this.tickFunc[c].call(this,a,b);this.targetPower=Math.min(1,this.targetPower+.1*Math.random()-.05),this.power+=.1*(this.targetPower-this.power)},this.hitTest=function(a,b){var c=1===this.type?20:15,d=Math.sqrt(Math.pow(this.x-a,2)+Math.pow(this.y-b,2));return c>d},this.plotSprite=function(a,b,c,d){var e,f=0,g=0;switch(this.type){case 2:e=sprites[this.state?"orbOn":"orbOff"],f=.5*-e.width,g=.5*-e.height;break;case 1:e=sprites[this.state?"floaterOn":"floaterOff"],f=.5*-e.width,g=-15;break;default:e=sprites[this.state?"lightOn":"lightOff"],f=.5*-e.width,g=-15}b.drawImage(e,c+f*a.viewport.z,d+g*a.viewport.z,e.width*a.viewport.z,e.height*a.viewport.z)}};window.onload=function(){cMain=document.createElement("canvas"),cMask=document.createElement("canvas"),ctxMain=cMain.getContext("2d"),ctxMask=cMask.getContext("2d"),document.body.appendChild(cMain),window.onresize(),loadAssets(function(){var a=window.localStorage.tut?1:0;prepareLevel(a,gameState,function(){start(gameState)})})},window.onresize=function(){cMain.width=cMask.width=window.innerWidth,cMain.height=cMask.height=window.innerHeight};