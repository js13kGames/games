<!doctype html><title>Fort Knight - js13kGames 2023</title><meta name=viewport content="width=device-width"><style>canvas{background-image:linear-gradient(to right top,#221f21,#1d1b1c,#181617,#131112,#0c0b0b,#0b0a0b,#0b0a0a,#0a090a,#0f0f11,#131416,#15191a,#181d1d);padding-left:0;padding-right:0;margin-left:auto;margin-right:auto;display:block;width:100%;height:100%;image-rendering:-moz-crisp-edges;image-rendering:-webkit-crisp-edges;image-rendering:pixelated;image-rendering:crisp-edges}body{background-image:radial-gradient(circle,#000,#060405,#0c080c,#0f0c11,#101016)}</style><body><script>function X(){for(this.ui=[],this.tree=new T(16,23,0,0,0,w.TREE,"",1.2),this.tree.ui=!0,this.rock=new T(16,16,0,0,0,w.ROCK,"",1.5),this.rock.ui=!0,ms=[[-75,w.HAM],[-161,w.SWD],[13,w.AX],[99,w.HAND]],i=0;i<ms.length;i++)this.ui.push(new T(16,16,n/2+ms[i][0],d-96,0,w.UI,"",4,0,!0,ms[i][1])),this.ui.push(new T(10,10,n/2+ms[i][0]+14,d-88,0,ms[i][1],"",4,!0));for(this.ui[7].sx=96,this.ui[7].sy=0,i=0;i<3;i++)this.ui.push(new T(16,16,20+32*i,0,0,w.HP,"",4,!0));this.ui.push(new T(6,16,148,0,0,w.HPE,"",4,!0)),(m=new T(6,16,0,0,0,w.HPE,"",4,!0)).flip=!0,this.ui.push(m),this.tick=function(){this.ui.forEach(t=>{t.type==w.UI&&M&&k(t.hb,v)&&(M=!1,D.hero.setWeapon(t.weapon))})}}zzfxX=new AudioContext;var h,o,a=!1;function l(t,s,i,e,h){this.x=t,this.y=s,this.dst=0,this.remove=!1,this.dud=!1,this.dead=!1,i-=t,t=e-s,e=Math.sqrt(i*i+t*t),this.dx=i/e*h,this.dy=t/e*h,this.angle=Math.atan2(t,i),this.hb=new g(0,0,0,0),this.update=function(s){this.dst+=Math.sqrt(this.dx*this.dx+this.dy*this.dy),this.x+=this.dx,this.y+=this.dy,this.hb.x=this.x,this.hb.y=this.y,this.hb.w=-2,this.hb.h=8,k(this.hb,D.hero.e.hb)&&!this.dud&&(D.hero.isShielded()?D.hero.isShielded()&&(D.shakeTime=.2,zzfx(1.12,void 0,205,void 0,.02,void 0,1,2.25,void 0,-5.5,void 0,void 0,void 0,.2,void 0,.2,void 0,.45,.1,.09),this.dud=!0,this.dx=4*(Math.random()-.5),this.dx=4*(Math.random()-.5),this.dy=4*(Math.random()-.5),this.dx*=-.8,this.dy*=-.8,this.angle=Math.atan2(this.dy,this.dx)):(D.shakeTime=.2,D.hero.hit(3,this),this.remove=!0)),this.dud&&!this.dead&&D.level.mobs.forEach(t=>{k(this.hb,t.e.hb)&&(t.hit(s,w.SPEAR,2),zzfx(1.03,void 0,334,void 0,.07,.06,2,.15,void 0,2.3,void 0,.01,void 0,1.7,-2.4,.1,void 0,.42,.04),this.dead=!0)})},this.draw=function(t,s){t.save(),t.translate(D.cam.x+this.x,D.cam.y+this.y),t.rotate(this.angle),t.fillStyle="#7B3F00",t.fillRect(0,-1.5,16,3),t.fillStyle="silver",t.strokeStyle="#56675B",t.lineWidth=1,t.beginPath(),t.moveTo(20,0),t.lineTo(14,-4),t.lineTo(14,4),t.fill(),t.stroke(),t.restore()},this.isSkelly=function(){return!1}}function U(t=0,s=0){this.x=t,this.y=s}const w={AIR:0,GRASS:1,HERO:2,BRDE:3,WTR:4,SEA:5,SND:6,TREE:7,ROCK:8,CST:9,CNE:10,UI:11,HAM:12,SWD:13,AX:14,HP:15,HPE:16,HAND:17,SKELLY:18,GOB:19,SHIELD:20,STUMP:21};function K(t,s,i,e,h,o,a,n,r,c){var l,d,p,f,u,x;this.id=t,this.obj=null,this.up=(t=n,l=r,f=(d=colz)/2,u=(p=colz)/2,x=Math.min(d,p)/4,d=Math.min(d,p)/3,t+=p=2*(Math.random()-.5),l+=p,(p=Math.sqrt((t-f)*(t-f)+(l-u)*(l-u)))<x?-24:p<d?-12:0),e+=this.up,this.drop=(t=n,f=r,x=(l=colz)/2,p=(u=colz)/2,l=Math.min(l,u)/3,-500*Math.exp(-((t-x)*(t-x)+(f-p)*(f-p))/(2*l*l))),this.e=new T(s,s,i,e,h,o,"",c,0,0),0<=this.up&&o==w.GRASS?(this.e.sx=16,this.e.sy=16):-12==this.up&&o==w.GRASS&&(this.e.sx=32,this.e.sy=16),this.column=n,this.row=r,this.active=!0,o==w.GRASS&&(this.e.y-=4),o==w.SND&&(this.e.y+=2),this.progress=!1,this.oscillationSpeed=.8,this.oscillationAmount=7,this.initialY=this.e.y,this.e.y=this.e.y+this.drop,this.update=function(t){var s;this.e.y=S(this.e.y,this.initialY,.08),this.e.type==w.SEA&&(s=.001*Date.now(),s=Math.sin(s*this.oscillationSpeed+this.column)*this.oscillationAmount,this.e.offsetY=0,this.e.y=this.initialY+s),this.e.update(t)}}function g(t,s,i,e){this.x=t,this.y=s,this.w=i,this.h=e}function b(t,s){return Math.floor(Math.random()*(s-t+1)+t)}function k(t,s){return t.x<s.x+s.w&&s.x<t.x+t.w&&t.y<s.y+s.h&&s.y<t.y+t.h}function t(t,s){this.x=t,this.y=s,this.set=function(t,s){this.x=t,this.y=s}}function S(t,s,i){return(1-i)*t+i*s}function q(t,s){return D.level.tiles[s+D.levels[D.hero.e.curLevel].cols*t]}function u(t,s,i){var e=[-80,i.y-85];return i=[85,i.y+50],e[0]<=t&&t<=i[0]&&e[1]<=s&&s<=i[1]}function V(t,s,i,p){var e,h;switch(this.tiles=[],this.objs=[],this.mobs=[],this.castle=[],this.active=!1,this.startPos=[-120,280],this.cols=colz,this.rocks=0,this.trees=0,this.mobs,this.complete=!1,this.bridge=!1,this.mobTime=0,this.cen=(e=colz-1,h=colz-1,cenX=Math.floor(e/2),cenY=Math.floor(h/2),{x:16*(cenX-cenY)/2,y:16*(cenX+cenY)/2}),this.delay=10,this.maxMobs=10,this.dead=[],this.decor=[],this.maxTrees=t-1,this.maxRocks=t-2,this.gobz=!0,this.tip=null,this.id=t){case 1:this.tip="Use the Axe (3) to cut (space) down the trees",this.tip2="Cross the bridge!!",this.maxMobs=0,this.maxTrees=2,this.maxRocks=0,this.gobz=!1;break;case 2:this.tip="Hammer (2) break the rocks",this.tip2="Clearing resources, stop spawns",this.maxMobs=0,this.maxTrees=0,this.maxRocks=1,this.gobz=!1;break;case 3:this.tip="Attack Sword (1) or fist (4)",this.top2="Rocks may give HP.",this.maxMobs=1,this.maxTrees=1,this.maxRocks=0,this.gobz=!1,this.delay=20,skelly=new Y(16,16,this.cen.x,this.cen.y,0,w.SKELLY,0,p,10),this.mobs.push(skelly),this.objs.push(skelly.e);break;case 4:this.tip="Use shield on spears!",this.maxMobs=4,this.maxTrees=2,this.maxRocks=2;break;case 11:this.maxMobs=0,this.maxTrees=10,this.maxRocks=10;break;default:this.maxMobs=t,this.maxTrees=t/2+1,this.maxRocks=t/2+2,this.gobz=!0,this.delay=5}this.draw=function(t,i,s){if(this.tiles.forEach(t=>t.update(i,s)),t.e.hp<=0&&(P=!0),s)this.castle.forEach(t=>t.update(i)),t.e.update(0),t.hands[0].x=30,t.hands[1].x=9,t.hands[0].y=29,t.hands[1].y=29;else{this.objs.sort((t,s)=>t.y-s.y),this.decor.sort((t,s)=>t.y-s.y),this.rocks=0,this.trees=0,this.decor.forEach(t=>{t.update(i,!0),t.update(i)}),this.objs.forEach(t=>{t.update(i,!0),t.update(i),t.isRock()&&0<=t.hp&&this.rocks++,t.isTree()&&0<=t.hp&&this.trees++}),u(t.e.x,t.e.y,this.cen)?this.castle.forEach(t=>t.alpha=.3):this.castle.forEach(t=>t.alpha=1),this.castle.forEach(t=>t.update(i)),t.tool.type!=w.HAND&&t.tool.update(i),290<t.e.y&&u(t.e.x,t.e.y,this.cen)&&t.e.update(i),0==this.mobs.length&&0==this.rocks&&0==this.trees&&this.id<11&&(this.complete=!0);for(let t=0;t<this.mobs.length;t++)this.mobs[t].update(i,this.mobs);if(this.complete&&!this.bridge){zzfx(1.02,void 0,72,.02,.17,.26,void 0,.01,void 0,void 0,100,.01,.14,void 0,15,.1,void 0,.7,.12,.24),this.bridge=!0;var e=colz/2;for(r=0;r<3;r++)for(c=1;c<7;c++){var h=q(e+r,colz-c);h.e.type=w.BRDE,c<3&&(h.progress=!0),h.e.setType(),h.e.y=200,h.initialY-=5}}this.mobTime+=i/1e3,this.mobTime>this.delay&&(0<this.trees||0<this.rocks)&&this.mobs.length<this.maxMobs&&(this.mobTime=0,skelly=new Y(16,16,this.cen.x,this.cen.y,0,w.SKELLY,0,p,10),this.mobs.push(skelly),this.objs.push(skelly.e),this.gobz)&&(gob=new Y(18,15,this.cen.x,this.cen.y,0,w.GOB,1,p,20),this.mobs.push(gob),this.objs.push(gob.e)),this.dead.forEach((t,s)=>{t.update(i),t.e.update(i)})}},this.reset=function(t,s){this.tiles=[],this.dead=[];let i=b(2,5),e=0,h=colz,o=0;for(r=0;r<h;r++)for(c=0;c<this.cols;c++){let t=1;r<4||c<4||c>colz-4||r>colz-4||(r<6||c<6||c>colz-6||r>colz-6)&&50<b(0,100)?t=w.SEA:(r<8||c<8||c>colz-8||r>colz-8)&&20<b(0,100)?t=w.SND:99<b(0,100)&&e<i&&(t=w.WTR,e++),xx=16*(c-r),yy=8*(c+r);var a=colz/2;(r==a||r-1==a||r+1==a)&&c<6&&(t=w.BRDE,r==a-1)&&2==c&&(this.startPos=[xx,yy]),a=new K(o,16,xx,yy,0,t,0,c,r,p),this.tiles.push(a),o++}const n=[];this.tiles.forEach((i,t)=>{i.e.type==w.WTR&&Array.from({length:b(3,8)},(t,s)=>s).forEach(s=>{Array.from({length:b(3,5)},(t,s)=>s).forEach(t=>{0<=(t=(i.row+s)*colz+(i.column+t))&&t<this.tiles.length&&n.push(t)})})}),n.forEach(t=>{20<b(0,100)&&this.tiles[t].e.type!=w.WTR&&(this.tiles[t].e.type=w.WTR,this.tiles[t].e.setType(),this.tiles[t].initialY+=6)}),this.tiles.forEach(t=>{t.e.type==w.GRASS&&98<b(0,100)&&this.trees<this.maxTrees?u(t.e.x,t.e.y-t.drop-10-30,this.cen)||((obj=new T(16,23,t.e.x,t.e.y-t.drop-10-30,0,w.TREE,"",p,!1,3)).parent=t,this.objs.push(t.obj=obj),this.trees++):t.e.type==w.GRASS&&98<b(0,100)&&this.rocks<this.maxRocks&&(u(t.e.x,t.e.y-t.drop-10,this.cen)||((obj=new T(16,16,t.e.x,t.e.y-t.drop-10,0,w.ROCK,"",p,!1,3)).parent=t,this.objs.push(t.obj=obj),this.rocks++))});var l=this.cen.x,d=this.cen.y;f(this.castle,l+5,d-86,4,0,16,!0,w.CST,!0),f(this.castle,l-10,d-64,1,0,16),f(this.castle,l-26,d-56,1,0,16),f(this.castle,l-41,d-64,4,0,16,!0,w.CST,!0),f(this.castle,l+22,d-64,1,0,-16,!1),f(this.castle,l+38,d-56,1,0,-16,!1),f(this.castle,l+54,d-64,4,0,16,!0,w.CST,!0),f(this.castle,l+38,d-24,2,0,-16,!1),f(this.castle,l+22,d-18,2,0,-16,!1),f(this.castle,l-26,d-8,3,0,-16,!1),f(this.castle,l-10,d,3,0,-16,!1),f(this.castle,l+6,d-40,4,0,16,!0,w.CST,!0)};const f=(s,i,e,h,o=0,a=8,n=!0,r=w.CST,t=!1)=>{var c=n?t=>0<=t:t=>t<h,l=n?t=>--t:t=>++t;for(let t=n?h-1:0;c(t);t=l(t))s.push(new T(16,16,i+o*t,e+a*t,0,r,"",p,!1,0));t&&s.push(new T(16,16,i+o,e+a-20,0,w.CNE,"",p,!1,0))}}function T(a,n,t,i,e,h,o,r,c=!1,l=0,d=0){this.weapon=d,this.scale=r,this.type=h,this.width=a,this.height=n,this.mhWidth=a/-2,this.mhHeight=n/-2,this.mhWScld=a/-2*r,this.mhHScld=n/-2*r,this.hWidth=a/2,this.hHeight=n/2,this.cenX=t-this.mhWScld,this.cenY=i-this.mhHScld,this.angle=e,this.x=t,this.y=i,this.z=0,this.active=!0,this.colour=o,this.image=A,this.alpha=1,this.currentTile=0,this.isSolid=!1,this.isButton=c,this.time=0,this.maxHP=l,this.hp=this.maxHP,this.flip=!1,this.idle=0,this.offsetY=0,this.parent=null,this.wet=!1,this.ui=!1,this.hands=[],this.dead=!1,this.sx=0,this.sy=0,this.setHitbox=function(){this.hb=new g(0,0,0,0),this.sensor=new g(0,0,0,0),this.isButton&&(this.hb.w=2*this.width*this.scale,this.hb.h=2*this.height*this.scale)},this.setHitbox(),this.updateHitbox=function(){this.isButton?(this.hb.x=this.x-this.width,this.hb.y=this.y-this.height):(this.hb.x=this.x+this.scale/2,this.hb.y=this.y+this.scale/2,this.hb.w=this.width*this.scale-this.scale-10,this.hb.h=this.height*this.scale-this.scale,this.sensor.x=this.x-5,this.sensor.y=this.y-5,this.sensor.w=this.width*this.scale+10,this.sensor.h=this.height*this.scale+10)},this.update=function(t,i=!1){if(this.idle+=t/1e3,this.updateHitbox(),this.active){if(ctx.save(),ctx.translate(this.x,this.y-this.z),ctx.globalAlpha=this.alpha,img=this.image,s=this.scale,mhw=this.mhWidth,mhh=this.mhHeight,hw=this.hWidth,hh=this.hHeight,a=this.width,n=this.height,0<D.shakeTime&&ctx.translate(D.shake,D.shake),this.ui)ctx.setTransform(1,0,0,1,0,0),this.flip&&(ctx.scale(-1,1),ctx.translate(-a*s,0)),ctx.drawImage(img,this.sx,this.sy,a,n,this.x,this.y,a*s,n*s);else if(ctx.translate(D.cam.x,D.cam.y),null==this.image)ctx.fillStyle=this.colour,ctx.fillRect(.5*mhw*s,.5*mhh*s,.5*a*s,.5*n*s);else if(this.flip?(ctx.scale(-1,1),ctx.translate(-a*s-a,0)):ctx.scale(1,1),(z=0)<this.angle&&(ctx.translate(24,24),ctx.rotate(this.angle*Math.PI/180),ctx.translate(-24,-24)),this.wet&&(n-=2),this.isHero()&&!i){var e,h,o;(t=D.hero).hands.forEach(t=>{ctx.drawImage(img,t.sx,t.sy,t.width,t.height,t.x,t.y,t.width*t.scale,t.height*t.scale)}),t.dance&&(ctx.shadowColor="gold",ctx.shadowBlur=10),t.isGad&&(ctx.shadowColor="red",ctx.shadowBlur=20),ctx.drawImage(img,this.sx,this.sy,a,n,hw+z,hh,a*s,n*s),2<=t.defence&&ctx.drawImage(img,96,16,11,10,12,12,11*s,10*s),t.isShielded()&&(e=t.shield,ctx.drawImage(img,e.sx,e.sy,e.width,e.height,e.x,e.y,e.width*e.scale,e.height*e.scale)),t.renderPower&&(ctx.globalAlpha=2<t.wepPower?t.wepPower/10:0,e=t.wepPower<10,h=t.facing==j?a*s-10:a*s-20,o=10-n,t.facing!=j&&(ctx.scale(-1,1),ctx.translate(-a*s,0)),ctx.beginPath(),ctx.arc(h,o,20,Math.PI,2*Math.PI),ctx.lineWidth=e?10:15,(h=ctx.createLinearGradient(h-20,o,20+h,o)).addColorStop(0,e?"#0a910f":"#fff"),h.addColorStop(t.wepPower/10,"#db6532"),o=1<t.wepPower/10+.01?1:t.wepPower/10+.01,h.addColorStop(o,e?"#06062e":"#db6532"),ctx.strokeStyle=h,ctx.stroke())}else if(i){ctx.scale(1,-1),ctx.shadowColor="#000",ctx.shadowBlur=8,ctx.globalAlpha=.1;let t=this.isHero()?3.2:3.6;this.isSkelly()&&(t=3),ctx.drawImage(R,this.sx,this.sy,a,n,hw+z,-t*n,a*s,n*s)}else(this.isRock()||this.isTree())&&D.level.id<6&&(ctx.shadowColor="gold",ctx.shadowBlur=10),ctx.drawImage(img,this.sx,this.sy,a,n,hw+z,hh,a*s,n*s),(this.isSkelly()||this.isGob())&&this.hands.forEach(t=>{ctx.drawImage(img,t.sx,t.sy,t.width,t.height,t.x,t.y,t.width*t.scale,t.height*t.scale)}),(this.isSkelly()||this.isGob()||this.isRock()||this.isTree())&&this.hp<this.maxHP&&1==this.alpha&&(ctx.globalAlpha=.7,ctx.fillRect(8,-15,26,10),ctx.fillStyle=this.isRock()?"#ededed":"#E15353",ctx.fillStyle=this.isTree()?"green":ctx.fillStyle,ctx.fillRect(10,-13,22/this.maxHP*this.hp,6));ctx.restore()}this.cenX=this.x-this.mhWScld,this.cenY=this.y-this.mhHScld},this.isHero=function(){return this.type==w.HERO},this.isSkelly=function(){return this.type==w.SKELLY},this.isGob=function(){return this.type==w.GOB},this.isRock=function(){return this.type==w.ROCK},this.isTree=function(){return this.type==w.TREE},this.setType=function(){switch(this.alpha=1,this.sy=0,this.sx=0,this.isSolid=!1,this.type){case w.HERO:this.isSolid=!0,this.sx=0,this.sy=0;break;case w.GRASS:this.sx=16;break;case w.BRDE:this.sx=32;break;case w.WTR:case w.SEA:this.sx=48;break;case w.AIR:this.sx=144;break;case w.SND:this.sy=16;break;case w.TREE:this.isSolid=!0,this.sx=80;break;case w.ROCK:this.isSolid=!0,this.sx=64;break;case w.CST:this.isSolid=!0,this.sx=64,this.sy=16;break;case w.CNE:this.sx=48,this.sy=16;break;case w.UI:this.ui=!0,this.sy=32;break;case w.HAM:this.sx=16,this.sy=33,this.ui=!0;break;case w.SWD:this.sx=26,this.sy=33,this.ui=!0;break;case w.AX:this.sx=36,this.sy=32,this.ui=!0;break;case w.HP:this.sx=48,this.sy=32,this.ui=!0;break;case w.HPE:this.sx=64,this.sy=32,this.ui=!0;break;case w.HAND:this.sx=71,this.sy=42,this.ui=!0;break;case w.SKELLY:this.sx=96,this.sy=16;break;case w.GOB:this.sx=83,this.sy=33;break;case w.GRAVE:this.sx=85,this.sy=23;break;case w.SHIELD:this.sx=77,this.sy=32;break;case w.STUMP:this.sx=81,this.sy=23}},this.setType()}function F(t,s,i,e,h,o,n){this.e=new T(t,s,i,e,h,o,"",n,!1,100),this.e.z=0,this.active=!0,this.particles=[];let a,l,d,p=null,f=0,u=j,x=0,y=(this.time=0,this.deaths=0,this.moved=!1,this.tool=new T(10,10,i,e,0,w.HAND,"",n),this.shield=new T(6,8,i,e,0,w.SHIELD,"",n),this.tool.setType(),this.wepPower=0,this.powPlus=0,this.defence=1,this.speed=0,this.attackTime=0,this.renderPower=!1,this.facing=u,this.attackOver=!1,this.dance=!1,this.axePower=1,this.hammerPower=1,this.castleDst=0,this.isGad=!1,this.gadDur=1e3,this.dmgTime=0,this.stopsound=0,this.walkSound=0,this.step1=!0,0),v=(this.punchProgress=0,!1),m="idle";this.hState=m,this.hands=[],this.hands.push(new T(4,4,i,e,0,w.HAND,"",n,!1)),this.hands.push(new T(4,4,i,e,0,w.HAND,"",n,!1)),this.update=function(s,i){this.time+=i/1e3,this.moved=!1,this.active&&null!=zzfx&&(this.curTile&&this.curTile.progress&&(this.e.hp+=20,100<this.e.hp&&(this.e.hp=100),D.nextLevel()),$()||_()||tt()||st()?(x+=i,this.moved=!0,this.walkSound<=0?(this.walkSound=.3,zzfxV=.17,this.step1?zzfx(void 0,void 0,2,.01,.02,.03,3,.2,-85,-75,-673,.03,.01,-.1,1,.3,void 0,.3,void 0,.04):zzfx(void 0,void 0,2,.01,.02,.03,3,.2,-85,-75,-673,.03,.01,-.1,1,.3,void 0,.42,void 0,.03),zzfxV=.3,this.step1=!this.step1):this.walkSound-=i/1e3):(f=0,x=0),tt()&&(this.e.y-=this.gMove(0,-1)),st()&&(this.e.y+=this.gMove(0,1)),$()&&(this.e.x-=this.gMove(-1,0),"punch"!=m)&&"retracting"!=m&&(this.e.flip=!0,u=it),_()&&(this.e.x+=this.gMove(1,0),"punch"!=m)&&"retracting"!=m&&(this.e.flip=!1,u=j),O.keys&&O.keys[pt]&&this.tool!=w.SWD&&this.setWeapon(w.SWD),O.keys&&O.keys[ft]&&this.tool!=w.HAM&&this.setWeapon(w.HAM),O.keys&&O.keys[ut]&&this.tool!=w.AX&&this.setWeapon(w.AX,!0),O.keys)&&O.keys[xt]&&this.tool!=w.HAND&&this.setWeapon(w.HAND);for(let t=0;t<=this.particles.length-1;t++)this.particles[t].update(s,i);this.punchDistance=75,this.punchSpeed=5;var t=this.e.wet?-6:0,e=this.moved?.01:.003,h=1.7*Math.sin(this.time*e),e=1.7*Math.sin(this.time*e+Math.PI);if(this.hands[0].x=30,this.hands[1].x=9,this.hands[0].y=this.moved?29+e+t:29+h+t,this.hands[1].y=29+h+t,(10<this.e.idle||this.dance||this.moved)&&(e=.6*Math.sin(15*this.time),this.moved||(this.e.z+=e),this.hands[0].y-=6*e,this.hands[1].y+=6*e,15<this.e.idle)&&(this.e.idle=0),this.setWeaponX(i),this.setWeaponY(),!(O.keys&&O.keys[dt]||L)||"idle"!=m&&"spin"!=m&&"swipe"!=m)switch(v&&(this.punchProgress+=this.punchSpeed,this.hands[1].x=this.punchProgress,this.hands[1].scale+=.1,this.tool.scale+=.1,m="punch",this.punchProgress>=this.punchDistance)&&(m="retracting",v=!1,this.wepPower=0),m){case"idle":this.wepPower=0,this.attackOver=!1;break;case"swipe":m="retracting"}else switch(m){case"idle":m=this.tool.type==w.HAND?"spin":"swipe";break;case"spin":y+=.8,this.hands[1].x+=4*Math.cos(y),this.hands[1].y+=4*Math.sin(y),y>=2*Math.PI&&(y=0,v=!0,this.punchProgress=0),this.chargeUp()}10<=this.wepPower?(D.shakeTime=.1,this.dance=!0):this.dance=!1,l=this.e.x-this.e.mhWScld,d=this.e.y-this.e.mhHScld,this.hState=m,(0<this.attackTime||0<this.punchProgress)&&(hb=u==j?(xtra=this.tool.type==w.HAND?25:0,new g(this.e.x+16,this.e.y-10,33+xtra,35)):(xtra=this.tool.type==w.HAND?35:0,new g(this.e.x-15-xtra,this.e.y-10,33+xtra,35)),D.level.decor.forEach(t=>{t.type==w.HERO||this.attackOver||k(hb,t.hb)&&(this.stopsound<=0&&(zzfx(2.04,void 0,265,void 0,void 0,.13,4,.74,void 0,-9.2,void 0,void 0,.15,1.9,void 0,.2,.16,.71,.08),this.stopsound=.25),t.hp=0,t.isSkelly()&&70<b(1,100)&&this.defence<=5&&(zzfx(void 0,void 0,679,.06,.19,.35,void 0,1.67,void 0,void 0,-172,.13,.2,void 0,void 0,void 0,void 0,.59,.25,.06),this.defence++),t.type==w.GRAVE&&70<b(1,100)&&this.powPlus<=5&&(zzfx(void 0,void 0,679,.06,.19,.35,void 0,1.67,void 0,void 0,-172,.13,.2,void 0,void 0,void 0,void 0,.59,.25,.06),this.powPlus++),t.type==w.STUMP)&&70<b(1,100)&&this.speed<=1&&(zzfx(void 0,void 0,679,.06,.19,.35,void 0,1.67,void 0,void 0,-172,.13,.2,void 0,void 0,void 0,void 0,.59,.25,.06),this.speed+=.25)}),D.level.objs.forEach(h=>{if(h.type!=w.HERO&&!this.attackOver&&k(hb,h.hb))switch(h.type){case w.TREE:this.tool.type==w.AX?(zzfx(2.15,void 0,312,.02,.08,.13,4,.08,void 0,1.7,void 0,void 0,.1,.9,void 0,.1,.08,.7,void 0,.25),h.hp-=this.axePower+this.powPlus,h.hp<=0&&(D.level.decor.push(new T(4,6,h.x+18,h.y+41,0,w.STUMP,"",n,!1,3)),zzfx(2.03,void 0,585,.05,.18,.35,2,3.08,void 0,.4,void 0,void 0,.06,1.7,void 0,.1,.42,.33,.14)),this.attackOver=!0):this.stopsound<=0&&(zzfx(1.99,void 0,1163,.01,.03,.01,4,.49,void 0,void 0,void 0,void 0,void 0,.1,-219,.1,.19,void 0,void 0,.26),this.stopsound=.25),D.shakeTime=.15;break;case w.ROCK:this.tool.type==w.HAM?(h.hp-=this.hammerPower+this.powPlus,zzfx(2.04,void 0,265,void 0,void 0,.13,4,.74,void 0,-9.2,void 0,void 0,.15,1.9,void 0,.2,.16,.71,.08),h.hp-=this.axePower,this.attackOver=!0,0==h.hp&&50<b(1,100)&&(this.e.hp+=5)):this.stopsound<=0&&(zzfx(1.99,void 0,1163,.01,.03,.01,4,.49,void 0,void 0,void 0,void 0,void 0,.1,-219,.1,.19,void 0,void 0,.26),this.stopsound=.25),D.shakeTime=.1;break;case w.SKELLY:h.parent.hit(i,this.tool.type,this.wepPower),D.shakeTime=.2,this.attackOver=!0,h.parent.e.hp<=0&&(5<b(1,10)&&D.level.decor.push(new T(11,10,h.x+18,h.y+10,b(-45,45),w.SKELLY,"",n,!1,1)),D.level.dead.push(h.parent));{var o=h.parent.e,a=this.wepPower+this.powPlus;zzfx(void 0,void 0,102,void 0,.03,.15,3,1.95,-1.5,void 0,void 0,void 0,void 0,1,void 0,.1,void 0,.55,.07,.28);let t=25+a,s=o.x-this.e.x,i=o.y-this.e.y,e=Math.sqrt(s*s+i*i);0!==length&&(s/=e,i/=e),T.x+=s*t,T.y+=i*t}break;case w.GOB:h.parent.hit(i,this.tool.type,this.wepPower+this.powPlus),zzfx(void 0,void 0,354,.01,.08,.13,2,.3,-1.5,.1,void 0,.01,void 0,1.7,void 0,.4,void 0,.75,.02,.22),D.shakeTime=.2,this.attackOver=!0,h.parent.e.hp<=0&&(D.level.dead.push(h.parent),D.level.decor.push(new T(7,9,h.parent.e.x,h.parent.e.y,0,w.GRAVE,"",n,!1,1)))}})),this.renderPower=!("spin"!=m&&"swipe"!=m||this.tool.type!=w.HAND&&this.tool.type!=w.SWD),this.facing=u,this.isGad&&Date.now()-this.dmgTime>=this.gadDur&&(this.isGad=!1),u==j?(this.shield.x=this.hands[1].x,this.shield.y=this.hands[1].y-3):(this.shield.x=this.hands[0].x,this.shield.y=this.hands[0].y-3),0<this.stopsound&&(this.stopsound-=i/1e3)},this.hit=function(t,s){var i;this.isGad&&!s.isSkelly()||(zzfx(.9,-.05,105,.04,.06,.03,3,1.1,-2.6,-1.1,void 0,void 0,void 0,.4,void 0,.4,void 0,.7,.01,.21),this.e.hp-=t/this.defence,this.isGad=!0,this.dmgTime=Date.now(),i=this.e.x>(t=s).x?1:-1,t=this.e.y>s.y?1:-1,this.e.x+=5*i,this.e.y+=5*t)},this.reset=function(){this.done=!1,this.particles=[];var t=D.levels[this.e.curLevel];this.e.x=t.startPos[0],this.e.y=t.startPos[1]},this.kill=function(){this.active&&(D.shakeTime=3)},this.setCurrentTile=function(t){var s,i,e;this.moved&&(a=p,s=this.e.x,e=(s/=32)+(i=(this.e.y+2*this.e.height+this.e.z)/32*2),r=Math.floor(i-s),c=Math.floor(e),p=q(r,c))&&a&&p.id!==a.id&&a.up!==p.up&&(this.e.z=.25*-p.up),null!=p&&(p.e.type==w.WTR?(f=1,this.e.wet=!0):p.e.type==w.SEA?(f=.3,this.e.wet=!0):(f=3.2+this.speed,this.e.wet=!1)),this.curTile=p},this.setWeaponX=function(t){switch(this.tool.type){case w.SWD:"idle"==m&&(this.tool.angle=u==j?80:45),"swipe"==m&&(this.chargeUp(),u==j?10<this.tool.angle&&(this.tool.angle-=3):this.tool.angle<90&&(this.tool.angle+=3)),"retracting"==m&&this.retract(),this.tool.x=this.e.x+this.hands[1].x+1;break;case w.HAM:"idle"==m&&(this.tool.angle=u==j?70:30),"swipe"==m&&(this.tool.angle=this.tool.angle=u==j?30:70,this.hands[0].y-=10,this.hands[1].y-=7),"retracting"==m&&this.retract(),this.tool.x=u==j?this.e.x+this.hands[1].x+1:this.e.x+this.hands[1].x-20,this.hands[1].x=30;break;case w.AX:"idle"==m&&(this.tool.angle=30),"swipe"==m&&(this.tool.angle=90,this.hands[0].y-=10,this.hands[1].y-=7),"retracting"==m&&this.retract(),this.tool.flip=u==j,this.hands[1].x=30,this.tool.x=u==j?this.e.x+this.hands[0].x+1:this.e.x+this.hands[0].x-40;break;case w.HAND:"retracting"==m&&(this.punchProgress-=this.punchSpeed,this.hands[1].x=this.punchProgress,this.hands[1].scale-=.1,this.tool.scale-=.1,this.punchProgress<=0)&&(this.punchProgress=0,m="idle")}},this.setWeaponY=function(){var t;"idle"!=m&&"swipe"!=m||(t=u==j?0:1,this.tool.y=this.hands[t].y+this.e.y-this.e.z-17)},this.chargeUp=function(){this.wepPower=10<=this.wepPower?10:this.wepPower+=.25,this.wepPower},this.retract=function(){var t=u==j?1:0;this.tool.y=this.hands[t].y+this.e.y-this.e.z-17,this.tool.type==w.AX?this.tool.angle=330:this.tool.type==w.HAM?this.tool.angle=u==j?120:330:this.tool.type==w.SWD&&(this.tool.angle=u==j?S(this.tool.angle,120,.8):330),.2<this.attackTime?(m="idle",this.attackTime=0):this.attackTime+=E/1e3},this.setWeapon=function(t,s=!1){"idle"==m&&(this.tool.type=t,this.tool.setType(),this.tool.flip=s,this.tool.ui=!1)},this.isShielded=function(){return(O.keys&&O.keys[ot]||C)&&(this.tool.type==w.SWD||D.hero.tool.type==w.HAND)},this.gMove=function(t,s,i=0,e){var h;this.e.idle=0,(rec=new g((h=this.e.hb).x,h.y,h.w,h.h)).w=20,rec.h=10,rec.x+=t*f,rec.y+=s*f/2,canMove=!0;for(var o=0;o<D.level.objs.length;o++)if(null!=(obj=D.level.objs[o])&&k(obj.hb,rec)&&2!=obj.type&&obj.isSolid){canMove=!1;break}return canMove?0!=s?f/2:f:0}}let n=window.innerWidth,d=window.innerHeight,p=!1,E=0,J=void Date.now(),f=Date.now(),x=0,y=new t(0,0),Q=new t(0,0),v=new g(0,0,0,0),M=!1,P=!1,H=1,A=(colz=40+2*H,new Image),R=(A.src="atlas.png",A.crossOrigin="anonymous",new Image),D=new function(){var h=!0;this.cam=new U,this.ratio=1,this.tips=!0,this.time=0,this.ratio=800<n?n/800:d/600,this.scale=2,this.cube=16,this.scaled=this.scale*this.cube,this.hero=new F(16,16,0,0,0,w.HERO,this.scale),this.introT=0,this.shake=0,this.shakeTime=0,this.reset=!1,this.wait=2,this.genLevel=function(t){this.levels=[];for(let t=1;t<=11;t++){var s=new V(t,n,d,this.scale);s.reset(t,this.scaled),this.levels.push(s)}},this.setLevel=function(t){this.level=this.levels[t],this.hero.e.curLevel=t,this.hero.e.x=this.level.startPos[0],this.hero.e.y=this.level.startPos[1],this.level.objs.push(this.hero.e)},this.nextLevel=function(){this.setLevel(H),H++},this.genLevel(0),this.setLevel(0),this.menu=new X,this.update=function(s,t,e=!1){if(this.time+=s/1e3,h&&(h=!1,ctx.scale(this.ratio,this.ratio)),this.shake=Math.cos(x),0<D.shakeTime&&(D.shakeTime-=s/1e3),this.hero.setCurrentTile(this.scaled),e)this.level.draw(this.hero,s,e);else{for(this.level.draw(this.hero,s),this.hero.update(ctx,s),N(ctx,.8,"black",0,0,n,75),this.level.tip&&(font="25px Papyrus",N(ctx,.8,"black",0,d-100,n,100),D.level.complete?G(ctx,1,font,"WHITE",this.level.tip2,20,d-10):G(ctx,1,font,"WHITE",this.level.tip,20,d-10)),font="30px Papyrus",G(ctx,1,font,"WHITE","[M] Music: "+!I,n-230,d-10),this.menu.ui.forEach(t=>t.update(s)),this.menu.tick(),i=1;i<=this.level.trees;i++)this.menu.tree.x=n-30*i,this.menu.tree.y=18,this.menu.tree.update(s);for(i=1;i<=this.level.rocks;i++)this.menu.rock.x=n-30*i,this.menu.rock.y=45,this.menu.rock.update(s)}this.level.mobs.forEach(t=>t.update(s)),this.cam.x=S(400-this.hero.e.x-20,this.cam.x,.8),this.cam.y=S(300-this.hero.e.y-80,this.cam.y,.8),this.level.objs=this.level.objs.filter(function(t){return 0<t.hp}),this.level.decor=this.level.decor.filter(function(t){return 0<t.hp}),this.level.dead=this.level.dead.filter(function(t){return 0<=t.e.alpha}),this.level.mobs=this.level.mobs.filter(function(t){return 0<t.e.hp})}},W=!(start=!1),I=!1,L=!1,C=!1,B=2,O=((o=new function(){function L(t){return Math.sin(6.283184*t)}function C(t){return.003959503758*2**((t-128)/12)}var B,O,N,G,j,Y=[L,function(t){return t%1<.5?1:-1},function(t){return t%1*2-1},function(t){return(t=t%1*4)<2?t-1:3-t}];this.init=function(t){O=(B=t).endPattern,N=0,G=t.rowLen*t.patternLen*(O+1)*2,j=new Int32Array(G)},this.generate=function(){for(var t,s,i,e,h,o,a,n=new Int32Array(G),r=B.songData[N],E=B.rowLen,c=B.patternLen,l=0,d=0,p=!1,f=[],u=0;u<=O;++u)for(i=r.p[u],t=0;t<c;++t){for(var x=i?r.c[i-1].f[t]:0,y=(x&&(r.i[x-1]=r.c[i-1].f[t+c]||0,x<17)&&(f=[]),Y[r.i[16]]),v=r.i[17]/512,m=2**(r.i[18]-9)/E,w=r.i[19],g=r.i[20],b=43.23529*r.i[21]*3.141592/44100,k=1-r.i[22]/255,S=1e-5*r.i[23],T=r.i[24]/32,z=r.i[25]/512,M=6.283184*2**(r.i[26]-9)/E,P=r.i[27]/255,H=r.i[28]*E&-2,A=(u*c+t)*E,R=0;R<4;++R)if(s=i?r.c[i-1].n[t+R*c]:0){f[s]||(f[s]=function(t,s){for(var i,e,h,o,a=Y[t.i[0]],n=t.i[1],r=t.i[3]/32,c=Y[t.i[4]],l=t.i[5],d=t.i[8]/32,p=t.i[9],f=t.i[10]*t.i[10]*4,u=t.i[11]*t.i[11]*4,x=t.i[12]*t.i[12]*4,y=1/x,v=-t.i[13]/16,m=t.i[14],w=E*2**(2-t.i[15]),g=new Int32Array(f+u+x),b=0,k=0,S=0,T=0;S<f+u+x;S++,T++)0<=T&&(T-=w,h=C(s+(15&(m=m>>8|(255&m)<<4))+t.i[2]-128),o=C(s+(15&m)+t.i[6]-128)*(1+8e-4*t.i[7])),i=1,S<f?i=S/f:f+u<=S&&(i=(1-(i=(S-f-u)*y))*3**(v*i)),e=a(b+=h*i**r)*n,e+=c(k+=o*i**d)*l,p&&(e+=(2*Math.random()-1)*p),g[S]=80*e*i|0;return g}(r,s));for(var D=f[s],W=0,I=2*A;W<D.length;W++,I+=2)n[I]+=D[W]}for(W=0;W<E;W++)(h=n[e=2*(A+W)])||p?(o=b,w&&(o*=y(m*e)*v+.5),d+=(o=1.5*Math.sin(o))*(o=k*(h-d)-(l+=o*d)),h=3==g?d:1==g?o:l,S&&(h=(h*=S)<1?-1<h?L(.25*h):-1:1,h/=S),p=1e-5<(h*=T)*h,a=h*(1-(o=Math.sin(M*e)*z+.5)),h*=o):a=0,H<=e&&(a+=n[e-H+1]*P,h+=n[e-H]*P),n[e]=0|a,n[1+e]=0|h,j[e]+=0|a,j[1+e]+=0|h}return++N/B.numChannels},this.createAudioBuffer=function(t){for(var s=t.createBuffer(2,G/2,44100),i=0;i<2;i++)for(var e=s.getChannelData(i),h=i;h<G;h+=2)e[h>>1]=j[h]/65536;return s},this.createWave=function(){var t=44+2*G-8,s=t-36,i=new Uint8Array(44+2*G);i.set([82,73,70,70,255&t,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&s,s>>8&255,s>>16&255,s>>24&255]);for(var e=0,h=44;e<G;++e){var o=j[e];i[h++]=255&(o=o<-32767?-32767:32767<o?32767:o),i[h++]=o>>8&255}return i},this.getData=function(t,s){for(var i=2*Math.floor(44100*t),e=new Array(s),h=0;h<2*s;h+=1){var o=i+h;e[h]=0<t&&o<j.length?j[o]/32768:0}return e}}).init({songData:[{i:[2,96,128,0,2,8,164,0,0,5,12,44,43,0,0,0,0,69,3,1,1,26,116,0,32,0,6,76,6],p:[1,3,1,4,5,6,7,8],c:[{n:[147,,,,,,,,150,,,,,,,,149,,,,,,150,149,147,,,,,,145],f:[]},{n:[],f:[]},{n:[147,,,,,,145,147,149,,,,,,147,145,147],f:[]},{n:[147,,,,,,145,147,149,,,,,,150,152,154,,,,,,,,153],f:[]},{n:[154,,,,,,,,157,,,,,,156,157,159,,,,,,,,154,,,,,,152],f:[]},{n:[154,,,,,,,,157,,,,,,156,157,159,,,,,,,,,,,,,,161],f:[]},{n:[162,,,,,,,,,,,,,,161,162,164,,,,,,,,,,,,,,161,164],f:[]},{n:[166,,,,,,,,,,,,,,,173,173],f:[]}]},{i:[3,61,128,0,3,63,128,0,0,9,17,40,72,0,0,0,1,178,7,0,2,255,15,0,32,83,8,84,8],p:[11,12,11,14,13,13,15,16],c:[{n:[],f:[]},{n:[147,,,,147,,,,147,,,,147,,,,147,,,,147,,,,147,,,,147],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[135,,,,,,,,,,,,,,,,135,,,,,,,,,,,,,,,,138,,,,,,,,,,,,,,,,140,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,144],f:[]},{n:[131,,,,,,,,133,,,,,,,,135,,,,,,,,,,,,,,,,135,,,,,,,,137,,,,,,,,139,,,,,,,,,,,,,,,,138,,,,,,,,140,,,,,,,,142],f:[]},{n:[142,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,145,,,,,,,,,,,,,,,,147,,,,,,,,,,,,,,,,149,,,,,,,,,,,,,,,,151],f:[]},{n:[131,,,,,,,,133,,,,,,,,138,,,,,,,,137,,,,,,,,135,,,,,,,,137,,,,,,,,142,,,,,,,,141,,,,,,,,138,,,,,,,,140,,,,,,,,145,,,,,,,,144],f:[]},{n:[138,,,,,,,,,,,,,,,,140,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,144,,,,,,,,,,,,,,,,145,,,,,,,,,,,,,,,,147],f:[]},{n:[142,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,147,,,,,,,,,,,,,,,,146,,,,,,,,,,,,,,,,149,,,,,,,,,,,,,,,,149],f:[]}]},{i:[1,0,128,0,1,0,128,9,0,37,13,5,20,0,0,0,0,0,0,0,2,255,0,0,32,47,3,0,1],p:[17,17,17,17,17,17,17,17],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147],f:[]}]},{i:[0,99,116,79,0,53,116,0,83,0,4,6,69,52,0,0,0,0,0,0,2,14,0,0,32,0,0,0,0],p:[18,18,18,18,18,18,18,18],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[135,,,,135,,,,137,,,,135,,,,135,,,,135,,,,135,,,,135],f:[]}]},{i:[2,83,128,0,3,182,128,0,0,0,0,6,29,0,0,0,0,0,0,0,3,5,184,119,244,147,6,0,0],p:[19,20,19,21,22,22,23,24],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[111,,111,111,111,,111,111,111,,111,111,111,,111,,104,,104,104,104,,104,104,104,,104,104,104,,106],f:[]},{n:[107,,107,107,107,,107,107,109,,109,109,109,,109,109,111,,111,111,111,,111,111,111,,111,111,111,,111],f:[]},{n:[107,,107,107,107,,107,107,109,,109,109,109,,109,109,114,,114,114,114,,114,114,113,,113,113,113,114,115,116],f:[]},{n:[118,,118,118,118,,118,118,118,,118,118,118,,118,,111,,111,111,111,,111,111,111,,111,111,111,113,114,116],f:[]},{n:[114,,114,114,114,,114,114,114,,114,114,114,,114,114,116,,116,116,116,,116,116,116,,116,116,116,,116],f:[]},{n:[118,,118,118,118,,118,118,118,,118,118,118,,113,,118,,118,118,118,,118,118,118,,118,118,118,116,114,113],f:[]}]}],rowLen:4562,patternLen:32,endPattern:7,numChannels:5}),setInterval(function(){var t;!a&&(a=1<=o.generate())&&(t=o.createWave(),(h=document.createElement("audio")).src=URL.createObjectURL(new Blob([t],{type:"audio/wav"})))},0),{canvas:document.createElement("canvas"),start:function(){this.canvas.width=n,this.canvas.height=d,this.context=this.canvas.getContext("2d"),this.context.scale(1,1),(ctx=this.context).mozImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=ctx.webkitImageSmoothingEnabled=!1,this.canvas.classList.add("screen"),document.body.insertBefore(this.canvas,document.body.childNodes[6]),this.frameNo=0,this.interval=setInterval(Z,20),R.crossOrigin="anonymous",R.src="atlas.png",R.onload=function(){R=function(t){var s=document.createElement("canvas"),i=(s.width=t.width,s.height=t.height,s.getContext("2d")),e=(i.drawImage(t,0,0),(t=i.getImageData(0,0,s.width,s.height)).data);for(let t=0;t<e.length;t+=4)0!==e[t+3]&&(e[t]=0,e[t+1]=0,e[t+2]=0);return i.putImageData(t,0,0),(i=new Image).src=s.toDataURL("image/png"),i}(R)},window.addEventListener("keydown",function(t){B<=0&&(start=!0),t.preventDefault(),O.keys=O.keys||[],O.keys[t.keyCode]="keydown"==t.type}),dd=!0,window.addEventListener("keyup",function(t){O.keys[t.keyCode]="keydown"==t.type,t.keyCode==lt&&(I=!I),t.keyCode==yt&&(D.tips=!D.tips),dd=dd&&!1}),window.addEventListener("mouseup",function(t){t.preventDefault(),Q.set(y.x,y.y),v.x=y.x-5,v.y=y.y+5,v.h=10,v.w=10,M=!0,0===t.button?L=!1:2===t.button&&(C=!1)}),window.addEventListener("mousedown",function(t){t.preventDefault(),0===t.button?L=!0:2===t.button&&(C=!0)}),window.addEventListener("mousemove",function(t){t.preventDefault();var s=O.canvas.getBoundingClientRect();y.set((t.clientX-s.left)/(s.right-s.left)*n,(t.clientY-s.top)/(s.bottom-s.top)*d)}),this.canvas.oncontextmenu=function(t){t.preventDefault()}},stop:function(){clearInterval(this.interval)},clear:function(){this.context.clearRect(0,0,4*this.canvas.width,4*this.canvas.height)}});function Z(){var t;P&&(x=0,P=!1,H=0,start=!1,p=!1,D.hero.e.hp=100,D.genLevel(),D.setLevel(0),B=3),start&&(null!=D.hero&&(D.hero.e.active=!0),p=!0),J=f,f=Date.now(),x+=E=f-J,0<B&&(B-=E/1e3),p?(O.clear(),D.update(E,x,!1),t="30px Papyrus",11==D.level.id?G(ctx,1,t,"WHITE","You have saved the land!",n/2-100,40):G(ctx,1,t,"WHITE","Stage: "+(D.hero.e.curLevel+1),n/2,40),G(ctx,1,t,"WHITE","HP: "+Math.floor(D.hero.e.hp),20,40),t="20px Papyrus",G(ctx,1,t,"WHITE","Attack+    : "+D.hero.powPlus,200,20),G(ctx,1,t,"WHITE","Defence+ : "+(D.hero.defence-1),200,40),G(ctx,1,t,"WHITE","Speed+     : "+D.hero.speed,200,60),G(ctx,1,t,"WHITE","Castle Resources:",n-260,18),D.hero.e.curLevel,I&&(h.pause(),W=!0),W&&a&&!I&&(h.play(),h.loop=!0,W=!1)):(O.clear(),ctx=O.context,D.update(E,x,!0),ctx.save(),N(ctx,.8,"black",0,0,n,d),t="70px Papyrus",G(ctx,1,"70px Papyrus","WHITE","Fort Knight",30,90),G(ctx,1,t="50px Papyrus","WHITE",0<B?"Generating World ..":"Press any key to start",30,d-120),t="30px Papyrus",G(ctx,1,t,"RED","Controls",30,160),G(ctx,1,t,"WHITE","Move: WASD/Arrows",30,200),G(ctx,1,t,"WHITE","Attack: Space/LMB (Hold)",30,250),G(ctx,1,t,"WHITE","Weapon: 1-4/RMB on icons",30,300),G(ctx,1,t,"WHITE","Block: Shift/RMB",30,350),G(ctx,1,t,"WHITE","Upgrade chance: Destroy drops",30,400),G(ctx,1,t,"WHITE","@CarelessLabs & @AdamTheWilliams for JS13k",30,d-50),ctx.restore()),M=!1}function N(t,s,i,e,h,o,a){t.save(),t.setTransform(1,0,0,1,0,0),t.globalAlpha=s,t.fillStyle=i,t.fillRect(e,h,o,a),t.restore()}function G(t,s,i,e,h,o,a){t.save(),t.setTransform(1,0,0,1,0,0),t.globalAlpha=s,t.font=i,t.fillStyle=e,t.fillText(h,o,a),t.restore()}function $(){return O.keys&&(O.keys[it]||O.keys[nt])}function _(){return O.keys&&(O.keys[j]||O.keys[ct])}function tt(){return O.keys&&(O.keys[et]||O.keys[at])}function st(){return O.keys&&(O.keys[ht]||O.keys[rt])}var it=37,j=39,et=38,ht=40,ot=16,at=87,nt=65,rt=83,ct=68,lt=77,dt=32,pt=49,ft=50,ut=51,xt=52,yt=84;function Y(t,s,i,h,o,a,n,r,c){this.e=new T(t,s,i,h,o,a,"",r,!1,c),(this.e.parent=this).mtype=n,this.lastShotTime=0,this.spears=[],this.bspd=100,this.spd=.3,this.time=0,this.facing=j,this.e.hands.push(new T(4,4,i,h,0,w.HAND,"",r,!1)),this.e.hands.push(new T(4,4,i,h,0,w.HAND,"",r,!1)),this.spear=null,a==w.GOB&&(this.e.hands[0].sx=78,this.e.hands[1].sx=78,this.e.hands[0].sy=42,this.e.hands[1].sy=42,this.spear=new l(this.e.hands[0].x,this.e.hands[0].y,0,0,0)),this.shotDelay=3+b(0,5),this.dead=!1,this.hit=function(t,s,i){this.e.hp-=1+i},this.update=function(s){this.time+=s/1e3;let t=this.e.x,i=this.e.y;if((e=this.e).hp<=0)this.dead||(zzfx(2.02,void 0,164,.01,.05,.01,void 0,.96,-5.1,void 0,void 0,-.01,void 0,void 0,void 0,.3,.12,.53,.04,.01),this.dead=!0),e.x-=2*Math.cos(1e3*this.time*.008),e.y-=.7,e.alpha=0<e.alpha-.03?e.alpha-=.03:0;else{var h,o,a,n=1.7*Math.sin(500*this.time*.008);this.e.isSkelly()?(e.hands[0].y=25+n,e.hands[1].y=25-n,e.hands[0].x=25,e.hands[1].x=15):(e.hands[0].y=20-n,e.hands[1].y=20+n,e.hands[0].x=35,e.hands[1].x=10),n=this.steerFromNearbyMobs(D.level.mobs,26),0==this.mtype?(e.y=i<D.hero.e.y?i+=this.spd/2+n.y:i+=-this.spd/2+n.y,e.x=t<D.hero.e.x?t+=this.spd+n.x:t+=-this.spd+n.x):1==this.mtype&&(Math.sqrt(Math.pow(this.e.x-D.hero.e.x,2)+Math.pow(this.e.y-D.hero.e.y,2))<120?(o=this.e.x-D.hero.e.x,a=this.e.y-D.hero.e.y,a/=h=Math.sqrt(o*o+a*a),this.e.x+=(o/=h)*this.spd*.8,this.e.y+=a*this.spd*.8):(e.y=i<D.hero.e.y?i+=this.spd/4+n.y:i+=-this.spd/4+n.y,e.x=t<D.hero.e.x?t+=this.spd/2+n.x:t+=-this.spd/2+n.x),this.time-this.lastShotTime>=this.shotDelay)&&(h=new l(this.e.x+20,this.e.y+20,D.hero.e.x+16,D.hero.e.y+16,2.5),this.spears.push(h),this.lastShotTime=this.time,50<b(0,100)?zzfx(1.02,void 0,947,.04,.05,.14,2,.8,-1.1,-.4,-100,.04,-.01,void 0,void 0,void 0,.01,.6,.02,.1):zzfx(1.02,void 0,947,.04,.06,.14,2,.8,-1.1,-.4,-100,.04,-.01,void 0,void 0,-.1,.01,.6,.02,.1)),this.e.x>D.hero.e.x?this.e.flip=!0:this.e.flip=!1;for(let t=0;t<this.spears.length;t++)this.spears[t].update(s),this.spears[t].draw(ctx,!1);this.spear&&(this.spear.x=this.e.x+8+this.e.hands[1].x,this.spear.y=this.e.y+this.e.hands[1].y,o=D.hero.e.x-this.spear.x,a=D.hero.e.y-this.spear.y,this.spear.angle=Math.atan2(a,o),this.time-this.lastShotTime>=this.shotDelay-2)&&this.spear.draw(ctx,!0)}this.spears=this.spears.filter(function(t){return!t.remove&&t.dst<400}),this.e.isSkelly()&&0<this.e.hp&&k(this.e.hb,D.hero.e.hb)&&D.hero.hit(1,e)},this.steerFromNearbyMobs=function(s,i){let e=0,h=0,o=0;for(let t=0;t<s.length;t++){var a=s[t],n=Math.sqrt(Math.pow(this.e.x-a.e.x,2)+Math.pow(this.e.y-a.e.y,2));a!==this&&n<i&&(e+=this.e.x-a.e.x,h+=this.e.y-a.e.y,o++)}0<o&&(e/=o,h/=o);var t=Math.sqrt(e*e+h*h);return 0<t&&(e/=t,h/=t),{x:e,y:h}}}zzfxV=.3,zzfx=(t=1,s=.05,i=220,e=0,h=0,o=.1,a=0,n=1,r=0,c=0,l=0,d=0,p=0,f=0,u=0,x=0,y=0,v=1,m=0,w=0,g=Math,b=44100,k=2*g.PI,S=r*=500*k/b/b,T=i*=(1-s+2*s*g.random(s=[]))*k/b,E=0,z=0,M=0,P=1,H=0,A=0,R=0,D,W)=>{for(c*=500*k/b**3,u*=k/b,l*=k/b,d*=b,p=b*p|0,W=(e=b*e+9)+(m*=b)+(h*=b)+(o*=b)+(y*=b)|0;M<W;s[M++]=R)++A%(100*x|0)||(R=a?1<a?2<a?3<a?g.sin((E%k)**3):g.max(g.min(g.tan(E),1),-1):1-(2*E/k%2+2)%2:1-4*g.abs(g.round(E/k)-E/k):g.sin(E),R=(p?1-w+w*g.sin(k*M/p):1)*(0<R?1:-1)*g.abs(R)**n*zzfxV*t*(M<e?M/e:M<e+m?1-(M-e)/m*(1-v):M<e+m+h?v:M<W-y?(W-M-y)/o*v:0),R=y?R/2+(M<y?0:(M<W-y?1:(W-M)/y)*s[M-y|0]/2):R),E+=(D=(i+=r+=c)*g.cos(u*z++))-D*f*(1-1e9*(g.sin(M)+1)%2),P&&++P>d&&(i+=l,T+=l,P=0),!p||++H%p||(i=T,r=S,P||=1);return(t=zzfxX.createBuffer(1,W,b)).getChannelData(0).set(s),(i=zzfxX.createBufferSource()).buffer=t,i.connect(zzfxX.destination),i.start(),i},O.start()</script>