<!DOCTYPE html><html><head><meta charset="utf-8"><title>Johnny Smiter - Episode Zero</title><meta name="viewport" content="width=device-width,initial-scale=1"><script src="https://js13kgames.com/webxr-src/aframe.js"></script><style type="text/css">body,html{width:100%;height:100%;margin:0;padding:0}body{background-color:#000}body .a-enter-vr-button{background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg width='141' height='141' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M23 57a47 52 0 1 1 95 0' fill='%23eee'/%3E%3Crect x='46' y='105' width='53' height='24' ry='9' fill='%23eee'/%3E%3Cpath d='M93 91c-9 0-16-7-16-16s7-16 16-16 16 7 16 16c0 8-7 16-16 16zM34 75c0-8 7-16 16-16s16 7 16 16c0 8-7 16-16 16s-16-7-16-16zm0-26c-6 0-11 4-10 10l2 20c1 13 15 21 21 22h16s1 0 2-1l4-7c1-1 3-1 5 0l4 7s1 1 2 1h16c6 0 23-13 23-28V57.722c0-6-4-10-11-10' fill='%23888' fill-rule='evenodd'/%3E%3C/svg%3E");min-height:50px;padding-top:5%;border-radius:100%;border:5px solid red}</style><script type="text/javascript">!function(t){var e={};function i(s){if(e[s])return e[s].exports;var o=e[s]={i:s,l:!1,exports:{}};return t[s].call(o.exports,o,o.exports,i),o.l=!0,o.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(s,o,function(e){return t[e]}.bind(null,o));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=5)}([function(t,e){var i=function(t,e){var i=.15*Math.pow((t*t+e*e)/1e3,1.5);return Math.sin(1345*t+8500*e)*i*.05+.05*i-1};AFRAME.registerComponent("terrain",{init:function(){for(var t=this.el.getObject3D("mesh").geometry.attributes.position.array,e=2;e<t.length;e+=3)t[e]=i(t[e-1],t[e-2])}})},function(t,e){AFRAME.registerComponent("getbow",{tick:function(){if(!this.bow&&0!=this.el.object3D.position.x){this.bow=!0;var t=document.getElementById("bow");t.setAttribute("position","0 -0.15 -0.05"),t.object3D.rotation.x=-1.2,this.el.appendChild(t)}}})},function(t,e){AFRAME.registerComponent("cameracorrect",{tick:function(){document.querySelector("[camera]").object3D.position.y>0?this.el.object3D.position.y=0:this.el.object3D.position.y=1.2}})},function(t,e,i){},,function(t,e,i){"use strict";i.r(e);var s=function(t,e,i){return t*(1-i)+i*e};class o{constructor(){this.segment=new THREE.BoxBufferGeometry(2,.3,.3),this.segment.applyMatrix((new THREE.Matrix4).makeTranslation(1,0,0)),this.root=new THREE.Group,this.joint0=new THREE.Group,this.joint0.add(new THREE.Mesh(this.segment,null)),this.root.add(this.joint0),this.joint1=this.joint0.clone(),this.joint1.position.x=1.8,this.joint0.add(this.joint1),this.joint2=this.joint1.clone(),this.joint1.add(this.joint2)}setTime(t){var e=t/2e3%1;e=.5*(Math.sin(e*Math.PI*2)+1);var i=s(-.9,-.3,e),o=s(.9,1.2,e),r=s(.9,1.2,e);this.joint0.rotation.z=-i,this.joint1.rotation.z=-o,this.joint2.rotation.z=-r;var a=s(-.4,.5,e*e);this.joint0.rotation.y=a;var n=s(-.2,.3,e);this.joint0.rotation.x=n;var h=s(-.2,.2,e);this.joint0.position.y=h}}var r=(new class{constructor(){this.root=new THREE.Group;var t=[[0,.6,1,1],[1,.25,1,1.25],[2,-.25,1,1.25],[3,-1,1,1],[0,-.6,-1,-1],[1,-.25,-1,-1.25],[2,.25,-1,-1.25],[3,1,-1,-1]];this.legs=[];for(var e=0;e<t.length;e++){var i=new o;i.root.position.z=t[e][0],i.root.rotation.y=t[e][1],i.root.scale.x=t[e][2],i.root.position.x=t[e][3],this.root.add(i.root),this.legs.push(i)}this.bodygroup=new THREE.Group;var s=new THREE.SphereBufferGeometry(5,8,8),r=new THREE.Mesh(s,null);r.scale.set(.3,.25,.5),r.position.z=2;var a=r.clone();a.position.z=-2.7,a.position.y=.6,a.scale.set(.45,.35,.6),a.rotation.x=.3,this.ab=a,this.bodygroup.add(r),this.bodygroup.add(a),this.root.add(this.bodygroup),s=new THREE.ParametricBufferGeometry((t,e,i)=>{var s=.5*(1-t),o=e*Math.PI*2,r=Math.sin(o)*s+t*t*t,a=Math.cos(o)*s;i.set(.75*r,.75*a,3*t)},8,8);var n=new THREE.Mesh(s,null);n.position.set(-.5,0,3.5);var h=n.clone();h.position.set(.5,0,3.5),h.scale.x=-1,this.bodygroup.add(n),this.bodygroup.add(h),this.jaw1=n,this.jaw2=h}setTime(t,e){for(var i=this.legs,o=0;o<i.length;o++)i[o].setTime(t),e||(t=(t+450)%2e3);var r=t/2e3%1;r=.5*(Math.sin(r*Math.PI*2)+1),this.bodygroup.rotation.x=s(-.1,.1,r*r),this.ab.rotation.x=s(.35,.25,r),r=t/2e3%1,r=.5*(Math.sin(r*Math.PI*4)+1);var a=s(-.5,0,r*r);this.jaw1.rotation.y=a,this.jaw2.rotation.y=-a}getTarget(t,e){this.setTime(t,e);var i=new THREE.Geometry;this.root.traverse(t=>{if(t.updateMatrix(),t.updateMatrixWorld(),t.geometry){var e=new THREE.Geometry;e.fromBufferGeometry(t.geometry),e.applyMatrix(t.matrixWorld),i.merge(e)}});var s=new THREE.BufferGeometry;return s.fromGeometry(i),s.groups=[],s}getMorphGeometry(){var t=this.getTarget(0,!0);t.morphAttributes.position=[];for(var e=0;e<11;e++){var i=e/10*2e3,s=this.getTarget(i);t.morphAttributes.position.push(s.attributes.position)}return t}}).getMorphGeometry();class a{constructor(t,e){this.size=t,this.position=e.position,this.velocity=new THREE.Vector3,this.rotation=e.rotation}update(t,e,i){for(var s=i,o=0;o<t.length;o++){var r=t[o],a=this.position.clone().sub(r.position),n=Math.max(1,a.length());if(n<1.5*(this.size+r.size))var h=50*e;else h=-.1*e/n/n;a.multiplyScalar(h),this.velocity.add(a)}this.velocity.length()>s&&this.velocity.multiplyScalar(s/this.velocity.length()),this.velocity.multiplyScalar(.98),this.velocity.add(this.position.clone().negate().multiplyScalar(50*e/Math.pow(this.position.length()+1,2))),this.velocity.y=0,this.position.add(this.velocity.clone().multiplyScalar(e)),this.rotation.y=(29*this.rotation.y+Math.atan2(this.velocity.clone().normalize().x,this.velocity.clone().normalize().z))/30}}var n=function(t,e,i){var s=new function(){var t,e,i,s,o,r=function(t){return Math.sin(6.283184*t)},a=function(t){return.003959503758*Math.pow(2,(t-128)/12)},n=function(t,e,i){var s,o,r,n,l,d,u,c=h[t.i[0]],p=t.i[1],f=t.i[3],m=h[t.i[4]],v=t.i[5],g=t.i[8],y=t.i[9],b=t.i[10]*t.i[10]*4,w=t.i[11]*t.i[11]*4,E=t.i[12]*t.i[12]*4,x=1/E,M=t.i[13],T=i*Math.pow(2,2-t.i[14]),R=new Int32Array(b+w+E),z=0,j=0;for(s=0,o=0;s<b+w+E;s++,o++)o>=0&&(o-=T,d=a(e+(15&(M=M>>8|(255&M)<<4))+t.i[2]-128),u=a(e+(15&M)+t.i[6]-128)*(1+8e-4*t.i[7])),r=1,s<b?r=s/b:s>=b+w&&(r-=(s-b-w)*x),n=d,f&&(n*=r*r),l=c(z+=n)*p,n=u,g&&(n*=r*r),l+=m(j+=n)*v,y&&(l+=(2*Math.random()-1)*y),R[s]=80*l*r|0;return R},h=[r,function(t){return t%1<.5?1:-1},function(t){return t%1*2-1},function(t){var e=t%1*4;return e<2?e-1:3-e}];this.init=function(r){t=r,e=r.endPattern,i=0,s=r.rowLen*r.patternLen*(e+1)*2,o=new Int32Array(s)},this.generate=function(){var a,l,d,u,c,p,f,m,v,g,y,b,w,E,x=new Int32Array(s),M=t.songData[i],T=t.rowLen,R=t.patternLen,z=0,j=0,P=!1,H=[];for(d=0;d<=e;++d)for(f=M.p[d],u=0;u<R;++u){var C=f?M.c[f-1].f[u]:0;C&&(M.i[C-1]=M.c[f-1].f[u+R]||0,C<16&&(H=[]));var A=h[M.i[15]],B=M.i[16]/512,S=Math.pow(2,M.i[17]-9)/T,D=M.i[18],q=M.i[19],I=43.23529*M.i[20]*3.141592/44100,G=1-M.i[21]/255,k=1e-5*M.i[22],L=M.i[23]/32,O=M.i[24]/512,F=6.283184*Math.pow(2,M.i[25]-9)/T,W=M.i[26]/255,V=M.i[27]*T&-2;for(y=(d*R+u)*T,c=0;c<4;++c)if(p=f?M.c[f-1].n[u+c*R]:0){H[p]||(H[p]=n(M,p,T));var U=H[p];for(l=0,a=2*y;l<U.length;l++,a+=2)x[a]+=U[l]}for(l=0;l<T;l++)(g=x[m=2*(y+l)])||P?(b=I,D&&(b*=A(S*m)*B+.5),j+=(b=1.5*Math.sin(b))*(w=G*(g-j)-(z+=b*j)),g=3==q?j:1==q?w:z,k&&(g=(g*=k)<1?g>-1?r(.25*g):-1:1,g/=k),P=(g*=L)*g>1e-5,E=g*(1-(v=Math.sin(F*m)*O+.5)),g*=v):E=0,m>=V&&(E+=x[m-V+1]*W,g+=x[m-V]*W),x[m]=0|E,x[m+1]=0|g,o[m]+=0|E,o[m+1]+=0|g}return++i/t.numChannels},this.createWave=function(){var t=44+2*s-8,e=t-36,i=new Uint8Array(44+2*s);i.set([82,73,70,70,255&t,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&e,e>>8&255,e>>16&255,e>>24&255]);for(var r=0,a=44;r<s;++r){var n=o[r];n=n<-32767?-32767:n>32767?32767:n,i[a++]=255&n,i[a++]=n>>8&255}return i},this.getData=function(t,e){for(var i=2*Math.floor(44100*t),s=new Array(e),r=0;r<2*e;r+=1){var a=i+r;s[r]=t>0&&a<o.length?o[a]/32768:0}return s}};s.init(t),s.generate();var o=new Blob([s.createWave()],{type:"audio/wav"}),r=URL.createObjectURL(o);return function(){var t=new Audio;t.volume=e,t.src=r,i&&(t.loop=!0),t.play()}},h=n({songData:[{i:[2,47,116,0,3,91,128,4,0,0,47,5,36,53,4,0,28,4,1,2,200,74,3,32,147,4,121,1],p:[1],c:[{n:[170],f:[]}]}],rowLen:11025,patternLen:3,endPattern:0,numChannels:1},.3),l=n({songData:[{i:[1,255,104,0,1,255,118,0,0,125,35,0,55,97,4,1,0,0,0,2,161,0,0,31,176,2,91,3],p:[1],c:[{n:[154],f:[]}]}],rowLen:5513,patternLen:7,endPattern:0,numChannels:1},1),d=n({songData:[{i:[3,0,164,0,3,0,157,0,0,196,43,36,0,0,0,0,51,2,1,2,79,85,0,171,88,1,0,5],p:[1],c:[{n:[170],f:[]}]}],rowLen:11025,patternLen:32,endPattern:0,numChannels:1},.2),u=n({songData:[{i:[1,255,97,0,3,0,128,0,0,0,55,96,139,0,0,0,195,6,0,2,181,243,0,186,147,6,28,6],p:[1],c:[{n:[99],f:[]}]}],rowLen:5513,patternLen:30,endPattern:0,numChannels:1},1),c=n({songData:[{i:[0,0,140,0,0,0,140,0,0,255,128,127,128,0,0,0,51,2,1,2,58,239,0,200,88,1,157,2],p:[1],c:[{n:[147,,,,,,,,,,,,,,,,,,,,111,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,158],f:[]}]}],rowLen:22050,patternLen:32,endPattern:0,numChannels:1},.5,!0),p=n({songData:[{i:[2,138,116,0,2,138,128,4,0,0,47,48,107,124,3,0,139,4,1,3,64,160,3,32,147,4,121,5],p:[1],c:[{n:[135,,,,142,,144,,142,,,,135,,,,,,,,,,,,,,,,,,,,142,,,,,,,,,,,142],f:[]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:1},1),f=n({songData:[{i:[2,138,116,0,2,138,128,4,0,0,47,48,107,124,3,0,139,4,1,3,64,160,3,32,147,4,121,5],p:[1],c:[{n:[141,,,,136,,138,,136,,,,141,,,,,,,,,,,,,,,,,,,,142],f:[]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:1},1),m=1323,v=function(){return m=.5*(Math.sin(1e5*m)+1)},g=document.createElement("canvas");g.width=g.height=128;for(var y=g.getContext("2d"),b=0;b<5;b++){var w=64*v()+32,E=64*v()+32,x=v();y.beginPath(),y.moveTo(w,E),y.arc(w,E,8*x+5,0,2*Math.PI),y.fillStyle="#600",y.fill(),y.beginPath(),y.moveTo(w,E),y.arc(w,E-3,4*x+1,0,2*Math.PI),y.fillStyle="#c88",y.fill()}var M=new THREE.CanvasTexture(g);function T(t){for(var e=new THREE.BufferGeometry,i=[],s=[],o=[],r=0;r<300;r++)i.push(0,0,0),s.push(new THREE.Vector3(Math.random()-.5,Math.random(),Math.random()-.5).normalize()),o.push(Math.random()+.5);var a=new THREE.PointsMaterial({map:M,size:.75*t,color:16777215,fog:!1,depthWrite:!1,depthTest:!0,transparent:!0}),n=new THREE.Float32BufferAttribute(i,3);n.dynamic=!0,e.addAttribute("position",n),this.object=new THREE.Points(e,a),this.object.visible=!1,this.object.scale.set(t,t,t),this.explode=function(t){if(!this.object.visible){this.object.visible=!0,this.object.position.copy(t);var e=0,i=()=>{this.update(e/10),++e<50?setTimeout(i,15):this.object.visible=!1};i()}},this.update=function(t){for(var e=n.array,i=e.length/3,r=0;r<i;r++){var a=3*r;e[a]=s[r].x*t*o[r],e[a+1]=s[r].y*t*o[r]*2-.5*t*t,e[a+2]=s[r].z*t*o[r]}n.needsUpdate=!0}}AFRAME.registerComponent("spiders",{schema:{life:{type:"selector"},grid:{type:"selector"}},init:function(){this.state="new",this.createSpiders(),this.start=+new Date,this.spiders[0].position.set(0,this.spiders[0].position.y,-3)},createSpiders:function(){var t=523,e=new THREE.MeshStandardMaterial({color:4473924,morphTargets:!0,side:THREE.DoubleSide,flatShading:!0,roughness:.8});this.spiders=[],this.boids=[],this.explotions=[];for(var i=0;i<25;i++){var s=new THREE.Mesh(r,e);this.el.setObject3D("spider"+i,s),this.spiders.push(s);Math.random();var o=1*Math.pow(t=.5*(Math.sin(1e5*t)+1),3)+.4;s.castShadow=!0,this.boids.push(new a(o,s));var n=new T(o);this.explotions.push(n),this.el.setObject3D("explode"+i,n.object)}this.reset()},gameover(){document.getElementById("menu").setAttribute("visible",!0);var t=document.getElementById("fail"),e=document.getElementById("win"),i=document.getElementById("intro");t.setAttribute("visible",!1),e.setAttribute("visible",!1),i.setAttribute("visible",!1),document.getElementById("score").score>=window.localStorage.highscore?e.setAttribute("visible",!0):t.setAttribute("visible",!0),this.reset(),this.data.grid.components.grid.gameGrid.reset(),document.getElementById("correct").object3D.rotation.y=-document.getElementById("camera").object3D.rotation.y},reset(){this.state="new",this.boids[0].size=.8;for(var t=0;t<this.spiders.length;t++){var e=100*Math.random(),i=100*Math.random(),s=this.boids[t],o=this.spiders[t];o.updateMorphTargets(),o.visible=!1,o.rotation.set(0,0,0),o.scale.set(.2*s.size,.2*s.size,.2*s.size),o.position.set(Math.sin(i)*(10+e),.35*this.boids[t].size,Math.cos(i)*(10+e))}this.spiders[0].position.set(0,this.spiders[0].position.y,-3),this.spiders[0].visible=!0},kill:function(t){"new"==this.state&&(setTimeout(p,1e3),this.start=+new Date,this.data.grid.components.grid.gameGrid.start(),this.state="play",document.getElementById("menu").setAttribute("visible",!1),document.getElementById("score").score=0,document.getElementById("score").setAttribute("text","value: RUNES: 0/"+window.localStorage.highscore));var e=0,i=this.spiders[t];i.dead=!0,this.explotions[t].explode(i.position);var s=()=>{e++,i.scale.multiplyScalar(.9),e<50?setTimeout(s,15):(i.dead=!1,this.respawn(t))};s()},respawn:function(t){var e=this.spiders[t],i=this.boids[t],s=100*Math.random();e.scale.set(.2*i.size,.2*i.size,.2*i.size),e.position.set(50*Math.sin(s),e.position.y,50*Math.cos(s))},tick:function(t,e){if("play"==this.state){for(var i=0;i<this.spiders.length;i++){var s=Math.min(1,.8*this.boids[i].velocity.length()),o=this.spiders[i];if(o.position.length()>20)o.visible=!1;else{o.visible=!0;var r=(t+5100*i)/50%10;o.updateMorphTargets(),o.morphTargetInfluences[Math.floor(r)]=(1-r%1)*s,o.morphTargetInfluences[(Math.floor(r)+1)%10]=r%1*s,!o.dead&&o.position.length()<1.5*this.boids[i].size&&(life.components.life.hit(),u(),this.respawn(i))}}for(i=0;i<this.boids.length;i++)this.boids[i].update(this.boids,e/1e3,(+new Date-this.start)/5e4+.5)}}});class R{constructor(t,e,i,s,o,r,a,n){this.x=t,this.y=e,this.z=i,this.tx=s,this.ty=o,this.size=r,this.height=0,this.offset=0,this.explodeTime=0,this.bounceTime=0,this.scale=1,this.indexX=a,this.indexY=n,this.tiles=8,this.type=Math.floor(3*Math.random())}setHeight(t){this.start=+new Date,this.height=t,this.offset=t,this.bounceTime=0,this.explodeTime=0}startBounce(){this.bounceTime=+new Date}explode(t){this.explodeTime>0||(this.explodeTime=+new Date,this.explodeCallback=t)}update(t){var e=t-this.start;if(this.offset=Math.max(this.height-5e-6*e*e,0),0==this.offset&&0==this.bounceTime&&this.height>0&&(this.startBounce(),this.height=0),this.bounceTime>0){var i=t-this.bounceTime,s=Math.max(1-i/500,0);this.offset=Math.abs(Math.sin(.01*i)*this.size*.5*s),0==s&&(this.bounceTime=0)}if(this.explodeTime>0){var o=t-this.explodeTime;s=Math.max(1-o/500,0);if(this.scale=Math.abs(Math.cos(s*Math.PI*2))*s,0==s){this.scale=1,this.explodeTime=0;var r=this.explodeCallback;r&&(this.explodeCallback=null,r(this.indexX,this.indexY))}}}setVerts(t,e){var i=this.tx*this.size/2*this.scale,s=this.ty*this.size/2*this.scale,o=this.offset+(this.size-this.size*this.scale)/2,r=4*e*3;t[r++]=this.x-i,t[r++]=this.z+o,t[r++]=this.y-s,t[r++]=this.x-i,t[r++]=this.z+this.size*this.scale+o,t[r++]=this.y-s,t[r++]=this.x+i,t[r++]=this.z+this.size*this.scale+o,t[r++]=this.y+s,t[r++]=this.x+i,t[r++]=this.z+o,t[r++]=this.y+s}setUVs(t,e){var i=4*e*2,s=1/this.tiles,o=this.type*s;t[i++]=o,t[i++]=0,t[i++]=o,t[i++]=1,t[i++]=s+o,t[i++]=1,t[i++]=s+o,t[i++]=0}setIndices(t,e){var i=3*e*2,s=4*e;t[i++]=0+s,t[i++]=1+s,t[i++]=2+s,t[i++]=0+s,t[i++]=2+s,t[i++]=3+s}}var z=document.createElement("canvas");z.width=1024,z.height=128;var j=z.getContext("2d"),P=[[0,0],[1,0],[0,1],[1,1],[0,2],[1,2],[0,3],[1,3]],H=function(t,e,i,s,o){var r=4&t;j.moveTo(P[r][0]*s+e,P[r][1]*o+i);for(var a=1;a<6;a++){r=t>>4*a&15;j.lineTo(P[r][0]*s+e,P[r][1]*o+i)}j.closePath(),j.stroke()};j.lineWidth=4,j.shadowBlur=10,j.shadowColor="#f00",j.strokeStyle="#fff",j.lineJoin="round";for(var C=[214113,87602,414022,91392,349026,90930],A=0;A<C.length;A++){j.beginPath();for(var B=0;B<3;B++)j.rect(128*A+16,16,96,96),H(C[A],128*A+34,30,68,23)}var S=z;AFRAME.registerComponent("grid",{init:function(){this.gameGrid=new class{constructor(t,e,i,s){this.rows=t,this.cols=e,this.margin=i,this.radius=s,this.initSquares(),this.buildGeometry(),this.reset()}reset(){for(var t=0;t<this.cols;t++)for(var e=0;e<this.rows;e++)this.squares[t][e].start=+new Date,this.squares[t][e].setHeight((50+Math.random())*(e+1));this.update(),this.state="new"}ray(t,e){var i=new THREE.Vector3(0,0,0),s=t.x,o=t.z,r=e.x,a=e.z,n=this.radius,h=(Math.sqrt((2*s*r+2*o*a)*(2*s*r+2*o*a)-4*(r*r+a*a)*(s*s+o*o-n*n))-2*s*r-2*o*a)/(2*(r*r+a*a));return i.x=s+h*r,i.z=o+h*a,i.y=(i.x-t.x)/e.x*e.y+t.y,i}hit(t){var e=Math.atan2(t.x,t.z),i=this.radius*Math.PI*2/this.cols,s=Math.round((e+Math.PI)/(2*Math.PI)*this.cols)%this.cols,o=Math.floor(t.y/i),r=((e+Math.PI)/(2*Math.PI)*this.cols+.5)%1,a=t.y/i%1;o>-1&&o<this.rows&&r>.15&&r<.85&&a<.8&&this.squareHit(s,o)}squareHit(t,e){var i=document.getElementById("score");i.score++,i.setAttribute("text","value: RUNES: "+i.score+"/"+window.localStorage.highscore),i.score>window.localStorage.highscore&&(window.localStorage.highscore=i.score),this.explodeSquare(t,e),e<this.rows-1&&this.squares[t][e].type==this.squares[t][e+1].type&&0==this.squares[t][e+1].explodeTime&&0==this.squares[t][e+1].height&&setTimeout(()=>this.squareHit(t,e+1),150),e>0&&this.squares[t][e].type==this.squares[t][e-1].type&&0==this.squares[t][e-1].explodeTime&&0==this.squares[t][e-1].height&&setTimeout(()=>this.squareHit(t,e-1),150);var s=(t+1)%this.cols,o=(t-1+this.cols)%this.cols;this.squares[t][e].type==this.squares[s][e].type&&0==this.squares[s][e].explodeTime&&0==this.squares[s][e].height&&setTimeout(()=>this.squareHit(s,e),150),this.squares[t][e].type==this.squares[o][e].type&&0==this.squares[o][e].explodeTime&&0==this.squares[o][e].height&&setTimeout(()=>this.squareHit(o,e),150)}initSquares(){for(var t=this.radius*Math.PI*2/this.cols-this.margin,e=[],i=0;i<this.cols;i++){for(var s=[],o=0;o<this.rows;o++){var r=-Math.sin(i/this.cols*2*Math.PI),a=-Math.cos(i/this.cols*2*Math.PI),n=o*(t+this.margin);s.push(new R(r*this.radius,a*this.radius,n,a,-r,t,i,o))}e.push(s)}this.squares=e}start(){this.state="play";for(var t=0;t<this.cols;t++)for(var e=0;e<this.rows;e++)this.squares[t][e].start=+new Date}buildGeometry(){var t=this.rows*this.cols*3*4,e=this.rows*this.cols*2*4;this.geometry=new THREE.BufferGeometry,this.verts=new THREE.BufferAttribute(new Float32Array(t),3),this.uvs=new THREE.BufferAttribute(new Float32Array(e),2),this.indices=new THREE.BufferAttribute(new Uint16Array(this.rows*this.cols*2*3),1),this.verts.dynamic=!0,this.uvs.dynamic=!0;for(var i=0,s=0;s<this.cols;s++)for(var o=0;o<this.rows;o++)this.squares[s][o].setHeight((50+Math.random())*(o+1)),this.squares[s][o].setVerts(this.verts.array,i),this.squares[s][o].setUVs(this.uvs.array,i),this.squares[s][o].setIndices(this.indices.array,i),i++;this.geometry.setIndex(this.indices),this.geometry.addAttribute("position",this.verts),this.geometry.addAttribute("uv",this.uvs)}explodeSquare(t,e){"play"==this.state&&(h(),this.squares[t][e].explode((t,e)=>{for(var i=e;i<this.rows-1;i++){var s=this.squares[t][i+1],o=this.squares[t][i],r=s.z-o.z;s.height>0?(o.start=s.start,o.height=s.height+r):(o.height=r,o.start=+new Date),o.bounceTime=0,o.explodeTime=s.explodeTime,o.explodeCallback=s.explodeCallback,o.scale=s.scale,o.type=s.type}var a=this.squares[t][this.rows-1];a.setHeight((10+Math.random())*this.rows),a.scale=1,a.explodeTime=0,a.bounceTime=0,a.type=Math.floor(6*Math.random()),this.update()}))}update(){if("new"!=this.state){for(var t=+new Date,e=0,i=0;i<this.cols;i++)for(var s=0;s<this.rows;s++)this.squares[i][s].update(t),this.squares[i][s].setVerts(this.verts.array,e),this.squares[i][s].setUVs(this.uvs.array,e),e++;this.verts.needsUpdate=!0,this.uvs.needsUpdate=!0}}}(5,40,.3,15);var t=new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide,flatShading:!0,transparent:!0,fog:!1});t.map=new THREE.CanvasTexture(S);var e=new THREE.Mesh(this.gameGrid.geometry,t);e.frustumCulled=!1,this.geometry=e,this.el.setObject3D("grid",e),this.el.addEventListener("hit",t=>{this.gameGrid.hit(t.detail)})},tick:function(){this.gameGrid.update()}});var D=function(t,e){return t<e?1:0},q=Math.max,I=Math.pow,G=Math.abs,k=Math.sin,L=Math.cos,O=Math.exp,F=Math.sign,W=new THREE.ParametricBufferGeometry((t,e,i)=>{var s=q((1.7*(t*=9)-1)*D(t,2)*.1+.1,.3*I(G(t-7),.3)*D(7,t))*D(t,9),o=e*Math.PI*2,r=Math.sin(o),a=Math.cos(o);t>7&&(s*=.15/(I(G(r),9)+I(G(a),9))),t>8&&s<.2&&(t=9-t+7.5),t>8&&(a*=.5),t<2&&(a*=.6),i.set(r*s*.2,-a*s*.2,.1*-t)},16,16),V=new THREE.ParametricGeometry((t,e,i)=>{var s=2*(t-.5),o=1-G(s*s),r=e*Math.PI*2,a=.05*k(r)*(o+.5),n=.03*L(r)*o+s*s*.5;i.set(5*-a,5*-n,5*s)},8,8),U=new THREE.ParametricGeometry((t,e,i)=>{var s=1.5*t,o=e*Math.PI*2,r=2*q(.5,1-O(-t-.3))-.5,a=I(G(k(o)),1/3)*F(k(o))*.1*r+.1*r-.05,n=I(G(L(o)),1/3)*F(L(o))*.08;1.5==s&&(a=0,n=0,s=1.3125),i.set(5*a,5*-s,5*n)},8,8),_=new THREE.ParametricGeometry((t,e,i)=>{var s=2*(t-.5),o=(G(s*s),e*Math.PI*2),r=.01*Math.sin(o)+.1*(1-G(s)),a=.01*Math.cos(o)-.5*G(s)+1;i.set(5*-r,5*-a,5*s)},8,8);V.merge(U),V.merge(_);class Y{constructor(){var t=W,e=new THREE.MeshStandardMaterial({color:8947848,fog:!0,flatShading:!0}),i=new THREE.Mesh(t,e);i.visible=!1,this.object=i,this.maxLife=1e3,this.speed=20,this.lastPosition=new THREE.Vector3(0,0,0),this.currentPosition=new THREE.Vector3(0,0,0)}updateMatrix(t){var e=t-this.fired;if(e>this.maxLife)this.hide();else if(this.fired>0){this.lastPosition.copy(this.object.position);var i=this.getCurrentPosition(e);this.object.position.copy(i);var s=this.getCurrentPosition(e+.01);this.object.lookAt(s)}}getCurrentPosition(t){var e=-t*this.speed/1e3;return this.currentPosition.copy(this.direction),this.currentPosition.multiplyScalar(e),this.currentPosition.add(this.position),this.currentPosition}fire(t,e){this.fired=+new Date,this.position=t,this.direction=e,this.show()}hide(){this.fired=0,this.object.visible=!1}show(){this.object.visible=!0}}AFRAME.registerComponent("bullets",{schema:{grid:{type:"selector"},spiders:{type:"selector"},source:{type:"selector"}},init:function(){this.bulletCount=10,this.availableBullets=[],this.bullets=[],this.fired=!1;for(var t=0;t<this.bulletCount;t++){var e=new Y;this.availableBullets.push(e),this.el.setObject3D("bullet"+t,e.object)}this.loadeBullet=new Y,this.loadeBullet.object.position.z=-.6,this.loadeBullet.object.rotation.y=3.141,this.loadeBullet.object.visible=!0,this.data.source.setObject3D("arrow",this.loadeBullet.object);var i=new THREE.MeshStandardMaterial({color:8947848,fog:!0,flatShading:!0}),s=new THREE.Mesh(V,i);s.rotation.z=-1.57,s.rotation.y=1.57,s.position.z=-.5,s.position.y=-.07,s.scale.set(.15,.15,.15),this.data.source.setObject3D("bow",s);var o=!1,r=t=>{this.fire(),o||(setTimeout(c,1e3),o=!0)};document.addEventListener("click",r),document.addEventListener("mousedown",r),document.addEventListener("touchstart",r),document.addEventListener("keydown",r),document.getElementById("hand").addEventListener("triggerdown",r)},fire:function(){if(!this.fired){d(),this.fired=!0,this.loadeBullet.object.visible=!1,setTimeout(()=>{this.fired=!1,this.loadeBullet.object.visible=!0},500);var t=(new THREE.Vector3).setFromMatrixPosition(this.loadeBullet.object.matrixWorld),e=this.data.source.object3D.getWorldDirection(new THREE.Vector3(0,0,0)),i=this.availableBullets.pop();i&&(i.fire(t,e),this.bullets.push(i))}},checkCollisions:function(){if(this.data.grid&&this.data.grid.components.grid.gameGrid)for(var t=this.data.grid.components.grid.gameGrid,e=t.radius,i=e*e,s=0;s<this.bullets.length;s++){var o=this.bullets[s],r=o.currentPosition;(o.currentPosition.y<-10||o.currentPosition.y>30)&&(o.hide(),this.bullets.splice(s,1),this.availableBullets.push(o));var a=o.lastPosition;if(o.fired>0){if(r.x*r.x+r.z*r.z>i){var n=r.clone().sub(a).normalize(),h=a.clone().sub(this.data.grid.object3D.position),d=t.ray(h,n);this.data.grid.emit("hit",d),o.hide(),this.bullets.splice(s,1),this.availableBullets.push(o),s--}var u=this.data.spiders.components.spiders.boids,c=new THREE.Ray(a,n);for(s=0;s<u.length;s++){if(c.distanceToPoint(u[s].position)<.9*u[s].size){o.hide(),this.bullets.splice(s,1),this.availableBullets.push(o),this.data.spiders.components.spiders.kill(s),l();break}}}}},update:function(){},tick:function(){for(var t=+new Date,e=0;e<this.bullets.length;e++)this.bullets[e].updateMatrix(t);this.checkCollisions()},remove:function(){for(var t=0;t<this.bulletCount;t++)this.el.removeObject3D("bullet"+t)}});i(0);function J(t){return.5*(Math.sin(1e6*Math.sin(1e9*t))+1)}AFRAME.registerComponent("trees",{schema:{seed:{type:"number",default:1860}},init:function(){for(var t=new THREE.CanvasTexture(function(t){var e=document.createElement("canvas");e.width=1024,e.height=1024;var i=e.getContext("2d"),s=function(){var e=Math.abs(Math.sin(1e3*t)+Math.sin(2001*t)+Math.sin(3242*t)+Math.sin(883231*t))/4;return t+=e,e},o=function(t,e,r){i.beginPath(),i.lineWidth=40/Math.pow(r,1.2),i.moveTo(t,e);for(var a=[],n=0;n<30;n++){if(e-=10/Math.pow(r,.7),t+=2*(s()-.5),i.lineTo(t,e),r<7&&(s()>.8||27==n)&&n>3){var h=Math.abs(s()-.5)+.1;a.push([t,e,h]),a.push([t,e,-h])}if(s()>.8&&r>3)break}for(i.stroke(),n=0;n<a.length;n++)i.save(),i.translate(a[n][0],a[n][1]),i.rotate(a[n][2]),i.translate(-a[n][0],-a[n][1]),o(a[n][0],a[n][1],r+1),i.restore()};return o(512,1024,1),e}(this.data.seed)),e=new THREE.PlaneGeometry(40,40),i=new THREE.Mesh(e,null),s=new THREE.Geometry,o=this.data.seed+9,r=0;r<60;r++){var a=(r+20*(o=.5*(Math.sin(1e4*o)+1)))%20/20*Math.PI*2,n=r+20,h=Math.cos(a)*n,l=Math.sin(a)*n;i.position.set(h,20,l),i.lookAt(0,20,0),i.updateMatrix(),s.merge(e.clone().applyMatrix(i.matrix))}var d=new THREE.MeshStandardMaterial({color:0,alphaTest:.6,map:t,transparent:!0,depthTest:!0});i=new THREE.Mesh((new THREE.BufferGeometry).fromGeometry(s),d);this.el.setObject3D("tree",i)}}),AFRAME.registerComponent("cloud",{init:function(){var t=this.el.getObject3D("mesh"),e=function(t,e){var i=[[.5,.5],[.5,.5]],s=document.createElement("canvas");s.width=s.height=t;for(var o=s.getContext("2d"),r=o.createImageData(t,t),a=1.5,n=Math.log(t)/Math.log(2),h=0;h<n;h++){var l=[];a/=2;for(var d=2*i.length-1,u=0;u<d;u++){var c=[];l.push(c);for(var p=0;p<d;p++){var f=u/2|0,m=p/2|0,v=u/2+.5|0,g=p/2+.5|0,y=i[f][m]+i[f][g]+i[v][m]+i[v][g];if(c.push(.25*y+(J((u%(d-1)+1)*(p%(d-1)+1)*e)-.5)*a),h==n-1){var b=4*(p*t+u);r.data[b]=r.data[b+1]=r.data[b+2]=255*l[u][p]+128-64*Math.random(),r.data[b+3]=255}}}i=l}return o.putImageData(r,0,0),s}(512,411),i=new THREE.CanvasTexture(e);i.repeat.set(15,15),i.wrapS=THREE.RepeatWrapping,i.wrapT=THREE.RepeatWrapping,t.material.map=i,t.material.roughness=1}});var K=function(t,e,i){return e*(1-i)+t*i};AFRAME.registerComponent("life",{schema:{spiders:{type:"selector"}},init:function(){this.life=1,this.hitvalue=0,this.dead=!1},drain:function(t){if(this.life=Math.max(0,this.life-t),0==this.life){f(),this.dead=!0;var e=0,i=()=>{var t=++e/100*1.5;this.life=.5-t,e<100?setTimeout(i,15):(spiders.components.spiders.gameover(),e=0,setTimeout(s(),1500))};i();var s=()=>{var t=++e/150*2-1;this.life=t,e<150?setTimeout(s,15):(this.life=1,this.dead=!1)}}},hit:function(){this.dead||(this.drain(.2),this.hitvalue=1)},tick:function(t,e){var i=this.el.getObject3D("mesh").material;i.opacity=K(1,.5-.5*this.life,this.hitvalue),i.color.setRGB(K(1,0,this.hitvalue*this.hitvalue*this.hitvalue),0,0),this.hitvalue*=.98}});i(1);AFRAME.registerComponent("story",{schema:{type:{type:"string"},height:{type:"number",default:1}},init:function(){var t=(new THREE.TextureLoader).load(function(t,e){return"data:image/svg+xml;base64,"+btoa('<?xml version="1.0"?>\n<svg version="1.1" width="1176" height="1150" xmlns="http://www.w3.org/2000/svg">\n    <path\n       d="m61 1121 46-226-33 55-30-172-3-171 37-57-47 3 14-339 41-13-33-44 101-143l314 15 391 20h100l-77 126 8 210-48-32 29 68 33 276-97 106 80-71 2 323-347 56 44-76-126 81z"\n       style="fill:#f8e7ab;stroke:#000;" transform="scale(1.2,'+e+')" />\n<foreignObject x="160" y="110" width="780" height="1100">\n<div xmlns="http://www.w3.org/1999/xhtml" style="text-align:center; font-size: 30px; font-family: \'Times New Roman\', serif;">'+("fail"==t?'\n<h1 style="font-weight: 100;margin:0;font-size: 55px">Purgatory</h1>\n<h2 style="font-weight: 100;margin:0;font-size: 48px">The Kingdom Burns!</h2>\n<div style="font-size: 28px;line-height: 30px; padding-top: 10px;">\n<p style="font-size:28px; line-height: 30px">Your efforts have failed to win favour with the Gods and they refuse to intervene, leaving Jar to burn in the pits of the 13th Realm. Yet, your bravery has tempered them with mercy; they have sent you <b>back</b> to battle the evil once more for another chance to win their favour.</p>\n<p style="font-size: 42px; line-height: 50px"><b>Kill the spider with your crossbow</b><br />to battle the evil hordes.</p>':"win"==t?'<h1 style="font-weight: 100;margin:0;font-size: 55px">Ascension</h1>\n<h2 style="font-weight: 100;margin:0;font-size: 48px">The 13th Knight is Born</h2>\n<div style="font-size: 28px;line-height: 30px; padding-top: 10px;">\n<p style="font-size:28px; line-height: 30px">The Gods are pleased with your efforts and offer their favour, they will save Jar from the ancient evil, but require something in return. You must return to your life with a sacred quest. You must protect the land of Jar from the evils of the 13th Realm; you must go <b>back</b> and take your place as the 13th Knight of Jar.</p>\n<p style="font-size: 42px; line-height: 50px"><b>Kill the spider with your crossbow</b><br />the battle with evil must continue</p>':'\n<h1 style="font-weight: 100;margin:0;font-size: 55px"><b>Johnny Smiter</b>: <i><small>Episode Zero</small></i></h1>\n<h2 style="font-weight: 100;margin:0;font-size: 48px"><small><b>Back</b> to the beginning, a knight is born</small></h2>\n<div style="font-size: 28px;line-height: 30px; padding-top: 10px;">\n<p style="font-size:28px; line-height: 30px">Peace has reigned in the land of Jar for 100 generations. You are going about your business as a lowly huntsman when you hear a commotion in the distance. The young princes have been playing in the forbidden forest, and unwittingly opened a portal to the hellish 13th Realm, releasing the ancient evil that dwelled&#160;within.</p>\n<p style="font-size:28px; line-height: 30px">You stand no chance of fending off the evil alone and your death is certain. Your only chance to save the kingdom is to win the favour of the Gods. Capture the runes you will need them to petition the Gods upon your death</p>\n<p style="font-size:28px; line-height: 30px">Be warned - evil will emerge from the darkness, hungry for your blood, so remember always watch your <b>back</b>.</p>\n<p style="font-size: 42px; line-height: 50px"><b>Kill the spider with your crossbow</b><br />and begin your battle with evil.</p>\n<p style="padding-right: 100px; font-size: 24px; text-align: left; position: absolute; bottom: 160px;padding-left: 30px"><b>Created for js13kgames 2019</b><br />\n<b>Credits:</b> Three.js, A-Frame and Soundbox devs<br />\n<b>Built by:</b> Paul Brunt (@supereggbert)</p>\n')+"</div>\n</div>\n</foreignObject>"+(""==t?'\n<g transform="translate(810,950) scale(0.25,0.25)">\n<text x="10" y="-35" style="font:80px sans-serif;fill:#555">Powered by</text>\n<path d="m40 195c-3-6-39-95-39-95s-9-20 22-35c30-14 68-33 68-33v138s-22 21-30 30c-8 8-16 2-20-6z" fill="#f00"/>\n<path d="m142 196c3-8 40-96 40-96s9-20-22-35c-31-14-69-32-69-32v138s22 21 31 31c8 8 16 2 20-6z" fill="#a00"/>\n<path d="m91 33-63-31s-14-6-10 13l9 49z" fill="#b44"/>\n<path d="m91 33 64-31s14-6 10 13l-9 49z" fill="#c55"/>\n<text x="220" y="160" style="font:160px sans-serif;fill:#555">WebXR</text>\n</g>':"")+"\n</svg>")}(this.data.type,this.data.height));t.wrapS=THREE.ClampToEdgeWrapping,t.wrapT=THREE.ClampToEdgeWrapping,t.minFilter=THREE.LinearFilter,this.el.getObject3D("mesh").material.map=t}});i(2);AFRAME.registerShader("gradient",{vertexShader:"varying vec3 vWorldPosition;\n\nvoid main() {\n\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n\tvWorldPosition = worldPosition.xyz;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"varying vec3 vWorldPosition;\n\nfloat hash13(vec3 p3)\n{\n\t\tp3 = floor(p3*0.33333)*3.0;\t\t\n\t\tp3  = fract(p3 * .1031);\n    p3 += dot(p3, p3.yzx + 33.33);\n    return fract((p3.x + p3.y) * p3.z);\n}\n\nvoid main() {\n\t\tvec3 bColor = vec3(0.8,0.0,0.0);\n\t\tvec3 tColor = vec3(0.15,0.20,0.23);\n\t\tif(hash13(vWorldPosition)>0.998) tColor= vec3(1.0,1.0,1.0);\n\t\tvec3 dir=normalize(vWorldPosition);\n\t\ttColor+=smoothstep(0.99,0.991,clamp(dot(dir,normalize(vec3(0.5,0.5,-0.5))),0.0,1.0));\n    float h = dir.y+0.4;\n    gl_FragColor = vec4( mix( bColor, tColor, h ), 1.0 );\n}"}),THREE.ShaderChunk.fog_fragment=THREE.ShaderChunk.fog_fragment.replace(new RegExp("fogDepth","g"),"length(vViewPosition)"),window.localStorage.highscore||(window.localStorage.highscore=50);i(3)}]);</script></head><body><a-scene fog="type: exponential; color: #200; density:0.07" background="color: red" loading-screen="dotsColor: red; backgroundColor: black"><a-entity id="menu" position="0 3 -4" scale="4 4 4"><a-entity light="type: spot; angle: 30; intensity: 0.5; penumbra: 1;" position="0 0 1.4" angle="5.9 0 0"></a-entity><a-plane height="1.0" width="1.0" id="fail" material="alphaTest:0.5;color:#ffffff;shader:standard;fog:false;transparent:true;" story="type:fail;height: 0.6" position="0 -0.2 0" visible="false"></a-plane><a-plane height="1.0" width="1.0" id="win" material="alphaTest:0.5;color:#ffffff;shader:standard;fog:false;transparent:true;" story="type:win;height: 0.6" position="0 -0.2 0" visible="false"></a-plane><a-plane height="1.0" width="1.0" id="intro" material="alphaTest:0.5;color:#ffffff;shader:standard;fog:false;transparent:true;" story position="0 -0.2 0"></a-plane></a-entity><a-plane height="150" width="150" rotation="-90 0 0" material="color:#224450; flatShading:true;" shadow="receive: true" cloud></a-plane><a-plane height="800" width="800" rotation="-90 0 0" material="color:#555;flatShading:true;" segments-height="10" segments-width="10" terrain></a-plane><a-entity id="trees1" trees="seed:1050"></a-entity><!--<a-entity id="trees2" trees="seed:1050"></a-entity>
			<a-entity id="trees3" trees="seed:1824"></a-entity>--><a-entity><a-entity id="score" text="font: aileronsemibold; align: center; value: RUNES: 0/50" position="0 1 -15" scale="25 25 25"></a-entity></a-entity><a-entity light="type: spot; angle: 50; cast-shadow:true; penumbra:0.5;color:#555" position="0 10 0" rotation="-90 0 0"></a-entity><a-entity light="type: hemisphere; color: #123; groundColor: #311; intensity: 3"></a-entity><a-entity id="grid" material="color:green; shader: flat; fog:false;" grid position="0 4 0"></a-entity><a-entity id="spiders" spiders="life:#life;grid:#grid"></a-entity><a-sphere material="shader: gradient;side:back" radius="900"></a-sphere><a-entity bullets="grid: #grid; source: #bow; spiders:#spiders" position="0 0 0"></a-entity><a-entity id="correct" cameracorrect position="0 1.6 0"><a-entity id="camera" camera look-controls="pointerLockEnabled:true"><a-plane id="life" life="spider:#spiders" position="0 0 -0.2" width="5" height="5" material="transparent:true;opacity:0.5;depthTest:false;depthWrite:false;lights:false;fog:false;shader:flat"></a-plane><a-entity id="bow" scale="0.4 0.4 0.4" position="0 -0.2 -0.2"></a-entity></a-entity><a-entity laser-controls="hand: right" raycaster="objects: .links; far: 5" id="hand" getbow></a-entity></a-entity></a-scene></body></html>