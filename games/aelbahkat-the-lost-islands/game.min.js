class Coords{constructor(x,y){if(typeof x==="object"){y=x.y;x=x.x}this.x=x;this.y=y;this.check()}set(x,y){if(x instanceof Coords){x.check();this.x=x.x;this.y=x.y}else{this.x=x;this.y=y}}getDistance(coord){coord.check();return Math.sqrt(Math.pow(this.x-coord.x,2)+Math.pow(this.y-coord.y,2))}check(){if(typeof this.x!=="number"||isNaN(this.x)){console.error("Bad coord.x",this.x);this.x=0}if(typeof this.y!=="number"||isNaN(this.y)){console.error("Bad coord.y",this.y);this.y=0}return this}}function rand(n){return Math.random()*(n||1)}function randInt(n){return Math.floor(rand(n))+1}function randAround(n){var a=rand(n);var b=rand(n);return a-b}class GameImage extends Image{constructor(n,src){super();let o=this;if(typeof n==="string"){o.src="images/"+n+".png"}if(typeof src==="string"){o.src=src}o.data=null;o.flippedHorizontal=null;o.flippedVertical=null;o.outline=new Image;o.onload=(()=>{o.setup()})}setup(){let o=this;o.data=o.getImageData();o.flippedHorizontal=o.getFlippedImage(-1,1);o.flippedVertical=o.getFlippedImage(1,-1);o.setOutline()}getImageData(){let c=this.getCanvasContext();c.drawImage(this,0,0);return c.getImageData(0,0,this.width,this.height)}getFlippedImage(a,b){let c=this.getCanvasContext();c.save();c.scale(a,b);c.translate(a<1?-this.width:0,b<1?-this.height:0);c.drawImage(this,0,0);c.restore();let img=new Image;img.src=c._canvas.toDataURL();return img}getCanvasContext(){let canvas=document.createElement("canvas");canvas.width=this.width;canvas.height=this.height;let c=canvas.getContext("2d");c._canvas=canvas;return c}setOutline(){return;let data;let c=this.getCanvasContext();canvas.width=0;canvas.height=0;c.putImageData(data,0,0);this.outline=canvas.toDataURL()}}class SpriteSheet{constructor(n,cb){let o=this;o.sheet=new GameImage(n);o.sprites=[];o.sheet.onload=(()=>{o.parse();if(typeof cb==="function"){cb(o.sprites)}})}parse(){let o=this;let canvas=document.createElement("canvas");let w=o.sheet.height;canvas.width=w;canvas.height=w;let c=canvas.getContext("2d");let x=0;while(o.sprites.length){o.sprites.pop()}while(x<o.sheet.width){c.clearRect(0,0,w,w);c.drawImage(o.sheet,x,0,w,w,0,0,w,w);x+=w;let src=canvas.toDataURL();o.sprites.push(new GameImage(null,src))}}}class Thing{constructor(world,x,y){let o=this;o.world=world;o.loc=new Coords(x,y);o.name="Thing";o.verb="touch";o.size=16;o.half=o.size/2;o.alpha=1;o.discovered=0;o.minZoom=0;o.selected=false}draw(c,s){let o=this;let pos=s.getScreenXY(o.loc);let sz=o.size*Math.max(s.zoom,o.minZoom);let h=o.half*s.zoom;if(o.discovered<.5){c.font="10px 'Lucida Console', Monaco";c.fillStyle="rgba(255,255,255,0.5)";c.fillText("?",pos.x-5.5,pos.y)}else{if(o.label){let fontSize=Math.ceil(9*s.zoom);if(fontSize>4){c.font=fontSize+"px Verdana";c.shadowColor="#000";c.shadowOffsetX=1;c.shadowOffsetY=-1;c.fillStyle="#fff";if(o.label instanceof Array){o.label.forEach((a,i)=>{c.fillText(a,pos.x-a.length*2*s.zoom,pos.y-sz+.5-(o.label.length-i-1)*9)})}else{c.fillText(o.label,pos.x-o.label.length*2*s.zoom,pos.y-sz+.5)}}}c.globalAlpha=o.alpha;if(o.img instanceof Image){if(o.selected){c.shadowColor="rgba(0,0,0,0.25)";c.shadowOffsetX=0;c.shadowOffsetY=0;c.shadowBlur=8}else{c.shadowColor="rgba(0,0,0,0.25)";c.shadowOffsetX=0;c.shadowOffsetY=1;c.shadowBlur=4}c.imageSmoothingEnabled=false;c.drawImage(o.img,pos.x-h,pos.y-h,sz,sz)}}}}class Character extends Thing{constructor(world,x,y,f,job,trades,gossip){super(world,x,y);let o=this;o.name="Lost Person";o.job=job;o.trades=trades;o.verb="talk";o.facing=0;o.type="NPC";o.color="#fff";o.speed=3;o.sightMin=14;o.sightMultiplier=50;o.sight=20;o.walkIndex=0;o.traveled=0;o.met={};o.clarity=0;o.focus={};o.inventory={boat:true,tent:true,water:true,coat:true};o.virtues={};o.virtueCount=0;o.alpha=0;o.askIndex=-1;o.gossip=gossip instanceof Array?gossip:[];o.gossipIndex=-1;o.busyCooldown=0;f=(f||"npc")+"_sheet";o.walking=[];o.spriteSheet=new SpriteSheet(f,s=>{o.walking=[s[0],s[1],s[0],s[2]];o.setImage()});o.altSheet=new SpriteSheet("alt_sheet");o.img=null}live(t,isNight){let o=this;t/=20;if(o.isMeditating){o.meditate(t)}let cooled=o.cooldown();if(o.type=="NPC"&&cooled){if(isNight){o.cancel();o.camp()}else if(randInt(5)==1){o.wander()}else{o.move()}}}cooldown(){this.busyCooldown=Math.max(this.busyCooldown-1,0);return this.busyCooldown<=0?true:false}focusOnNearest(){let o=this;o.focus=o.world.getNearestThing(o.loc,o.getActionDistance())}wander(){if(!this.cooldown()){return}let i=randInt(4)-1;this.move(i)}move(dir){let o=this;if(!o.cooldown()){return}let l=o.loc;let s=o.getSpeed();if(typeof dir==="undefined"){dir=o.facing}o.cancel();if(dir==0){l.y-=s}else if(dir==1){l.x+=s}else if(dir==2){l.y+=s}else if(dir==3){l.x-=s}o.traveled+=s;o.world.keepInBounds(o.loc);o.facing=dir;if(Math.round(o.traveled)%5==0){o.walkIndex++;if(o.walkIndex>=o.walking.length){o.walkIndex=0}}}getSpeed(){let o=this;let s=o.speed;let tt=o.world.getTerrainTypeAt(o.loc);if(tt=="W"){if(o.has("boat")){s*=2}else{s/=7}}else if(tt=="M"){if(!o.has("coat")){s/=5}}else if(tt=="D"){if(!o.has("water")){s/=5}}return s}getFaceLoc(){let o=this;let loc=new Coords(o.loc);let d=o.half;if(o.facing==0){loc.y-=d}else if(o.facing==1){loc.x+=d}else if(o.facing==2){loc.y+=d}else if(o.facing==3){loc.x-=d}return loc}getFootLoc(){let o=this;let loc=new Coords(o.loc);loc.y+=o.half;return loc}setImage(){let o=this;let s=o.spriteSheet.sprites;if(o.isMeditating){o.img=o.altSheet.sprites[2]}else if(o.isCamping){o.img=o.altSheet.sprites[3]}else if(o.isOnWater()){o.img=o.altSheet.sprites[o.has("boat")?1:0]}else if(o.getSpeed()<o.speed){o.img=o.spriteSheet.sprites[3]}else{o.img=o.walking[o.walkIndex]}if(o.facing==1||o.facing==2){o.img=o.img.flippedHorizontal}}setSight(){let o=this;let tt=o.world.getTerrainTypeAt(o.loc);o.sight=o.sightMin+o.sightMultiplier*o.world.light;if(o.has("torch")){if(!o.isOnWater()||o.has("boat")){o.sight*=1.1}o.sight+=randInt(30)==1?.1:0}else{if(tt=="F"){o.sight*=.5}}}setRandomName(){let name="";let n=randInt(2)+randInt(2);let s=["al","aka","beth","brit","co","du","den","far","gen","la","mi","no","pre","sha"];while(n>0){name+=s[randInt(s.length-1)];n--}this.name=name.charAt(0).toUpperCase()+name.slice(1)}isOnWater(){let tt=this.world.getTerrainTypeAt(this.loc);return tt=="W"}has(thing){return this.inventory[thing]}discover(bounds){let o=this;let faceLoc=o.getFaceLoc();o.world.loopOverTerrainInBounds(t=>{let d=faceLoc.getDistance(t.loc);t.visible=d<=o.sight;if(t.visible){t.discovered+=.15;t.discovered=Math.min(t.discovered,1)}else if(d<=o.sight*1.1){if(t.discovered<.6){t.discovered+=.05}}},bounds);o.world.allThings.forEach(thing=>{let d=o.loc.getDistance(thing.loc);if(d<=o.sight){thing.discovered+=.1;thing.alpha=Math.min(thing.discovered,1)}else{if(thing.discovered>=1){thing.alpha=.3}else{thing.alpha=0}}})}getActionDistance(){return Math.min(30,this.sight)}action(){let o=this;if(o.isCamping||o.isMeditating){o.cancel();return}o.focusOnNearest();if(o.focus){if(o.focus instanceof Character){o.ask(o.focus)}else if(o.focus instanceof Shrine){o.toggleMeditate()}else if(o.focus instanceof Portal){if(o.has("moonstone")){o.focus.activateRed();o.speak("A transdimensional red moon gate!")}else{o.focus.toggle()}}}else{o.camp()}}camp(){let o=this;if(o.has("tent")&&!o.isOnWater()){o.isCamping=true;o.facing=-1;o.setImage()}}toggleMeditate(){let o=this;o.isMeditating=!o.isMeditating;if(!o.isMeditating){o.cancel()}o.setImage()}meditate(t){let o=this;let spk="∞";o.clarity+=.001*(o.virtueCount/3+1)*t;o.clarity=Math.min(1,o.clarity);let clear=o.clarity>=1;o.facing=-1;if(o.focus instanceof Shrine){spk="-"+o.focus.mantra+"-";if(clear){o.virtues[o.focus.virtue]=true;spk=["I know the wisdom","of "+o.focus.virtue]}else{spk+=" ("+Math.ceil(o.clarity*100)+"%)"}}o.virtueCount=0;for(let v in o.virtues){o.virtueCount++}if(o.virtueCount>=8){o.inventory["enlightenment"]=true;spk=["I have gained","enlightnment of","all 8 virtues."]}o.speak(spk)}cancel(){let o=this;o.isCamping=false;o.isMeditating=false;o.clarity=0;o.label="";o.setImage()}ask(char){let o=this;let maxAskIndex=char.gossip.length?3:2;o.cancel();char.cancel();o.askIndex++;if(o.askIndex>maxAskIndex){o.askIndex=0}if(o.askIndex==0){if(char.name=="Lost Person"){char.setRandomName()}char.speak(["Name?","I am "+char.name+"."]);o.met[char.name]=1}else if(o.askIndex==1){char.speak(["Job?","I am a "+char.job+"."])}else if(o.askIndex==2){let deal,demand,supply,dealSupply;for(supply in char.trades){demand=char.trades[supply];if(demand=="free"||o.has(demand)){deal=demand;dealSupply=supply}}if(deal=="free"){char.speak("Take this "+dealSupply+" for free.");char.give(dealSupply,o)}else if(deal){char.speak("Take this "+dealSupply+" for your "+demand+".");char.trade(dealSupply,demand,o)}else{char.speak("I will trade "+demand+" for "+supply+".")}}else if(o.askIndex==3){char.gossipIndex++;if(char.gossipIndex>char.gossip.length-1){char.gossipIndex=0}char.speak(char.gossip[char.gossipIndex])}char.busyCooldown=10}give(wut,whom){this.inventory[wut]=false;whom.inventory[wut]=true}trade(give,take,whom){whom.give(take,this);this.give(give,whom)}speak(wut){let m=20;if(typeof wut=="string"&&wut.length>m){let wArr=wut.split(" ");let words="";wut=[];wArr.forEach((w,i)=>{if(i==0){words=w}else{if(w.length+words.length<m){words+=" "+w}else{wut.push(words);words=w}if(i==wArr.length-1){wut.push(words)}}})}this.label=wut}}class Player extends Character{constructor(world,x,y){super(world,x,y,"stranger");let o=this;o.type="PC";o.inventory={watch:true};o.alpha=1;o.discovered=1;o.name="Stranger";o.label=""}}class Shrine extends Thing{constructor(world,x,y,v,mantra){super(world,x,y);let o=this;o.world=world;o.virtue=v;o.name="Shrine of "+o.virtue;o.mantra=mantra;o.verb="meditate";o.img=new GameImage("shrine");o.minZoom=.5}}class Portal extends Thing{constructor(world,x,y){super(world,x,y);let o=this;o.world=world;o.name="Moon Gate";o.verb="activate";o.mode=false;o.allPortals=[];o.tpRange=10;o.tpDrop=o.tpRange*1.5;o.redCallback=function(){};o.img=null;o.minZoom=.5;o.spriteSheet=new SpriteSheet("moongate_sheet",s=>{o.img=s[0]})}connect(allPortals){this.allPortals=allPortals}keepAwayFromEdge(){let h=this.world.half;let d=this.tpDrop;let loc=this.loc;if(loc.y+d>h){loc.y-=d}else if(loc.y-d<-1*h){loc.y+=d}if(loc.x+d>h){loc.x-=d}else if(loc.x-d<-1*h){loc.x+=d}}checkTeleport(who){let d=this.loc.getDistance(who.loc);if(d<this.tpRange){this.teleport(who)}}teleport(who,redCallback){let o=this;if(o.mode=="blue"){let out;o.allPortals.forEach(p=>{if(p.mode=="blue"&&p!==o){out=p}});if(!out){out=o.allPortals[randInt(o.allPortals.length-1)]}if(out){let outLoc=new Coords(out.loc);out.activate();if(who.facing==0){outLoc.y-=out.tpDrop}else if(who.facing==1){outLoc.x+=out.tpDrop}else if(who.facing==2){outLoc.y+=out.tpDrop}else if(who.facing==3){outLoc.x-=out.tpDrop}who.loc.set(outLoc.x,outLoc.y)}}else if(o.mode=="red"){o.redCallback()}}activate(){let o=this;o.img=o.spriteSheet.sprites[1];o.mode="blue";let b=0;o.allPortals.forEach(p=>{if(p.mode=="blue"){b++}});console.log("Blues:",b);o.verb="reset all"}deactivate(){let o=this;o.img=o.spriteSheet.sprites[0];o.mode=false;o.verb="activate"}deactivateAll(){this.allPortals.forEach(p=>{p.deactivate()})}toggle(){let o=this;if(!o.mode){o.activate()}else{o.deactivateAll()}}activateRed(){this.img=this.spriteSheet.sprites[2];this.mode="red"}}class World{constructor(sz){let o=this;o.size=sz;o.half=o.size/2;o.light=1;o.hue=[0,0,0];o.terrainTypes={W:[0,50,150],P:[30,180,20],F:[30,120,50],M:[120,110,120],D:[170,170,90],C:[150,150,70]};o.terrainMarkers=[];o.npcs=[];o.terrain=[];o.shrines=[];o.portals=[];o.allThings=[]}buildTerrainMarkers(){let o=this;let i=o.size/7;while(i-- >0){let xy=o.getRandomLoc(o.terrainMarkers,4);o.terrainMarkers.push(new TerrainMarker(o,xy.x,xy.y))}o.terrainMarkers.push(new TerrainMarker(o,0,0,"P"))}buildNPCs(){let o=this;let jobTrades=[{job:"farmer",trades:{grain:"free"},gossip:["The crops grow really well here.","This island is our new home."]},{job:"well-digger",trades:{water:"free"},gossip:["There are strange artifacts deep in the ground.","If you have some water you needn't fear the deserts."]},{job:"hunter",trades:{hides:"free"},gossip:["Hunting the elusive beasts of this land requires skill and patience.","If only we could move the island..."]},{job:"lumberjack",trades:{wood:"free"},gossip:["I keep cutting down trees, but the forest stays exactly the same!","The wood from these trees is great for making boats."]},{job:"bard",trades:{song:"free"},gossip:["Sadly I've forgotten my old songs.","My next song will be about you, Stranger."]},{job:"shepherd",trades:{wool:"grain"},gossip:["Good luck out there!","I can also be a doctor if need be."]},{job:"torchbearer",trades:{torch:"bread"},gossip:["The night is dark and full of terror.","I've seen monsters in the forest, but they always hide."]},{job:"baker",trades:{bread:"grain"},gossip:["There isn't a lot to eat around here, but everyone enjoys my bread.","I can't remember much about our old home."]},{job:"messenger",trades:{tent:"bread"},gossip:["I wish I knew how to use the moon gates.","I try to keep everyone informed and organized."]},{job:"knitter",trades:{coat:"wool"},gossip:["The mountains are cold; you shouldn't go unprepared.","Most of us can't remember anything of our past."]},{job:"torchmaker",trades:{torch:"wood"},gossip:["I used to be a candlestickmaker, but now we rely on torches.","Only the mystics seem to understand the moon gates."]},{job:"tentmaker",trades:{tent:"hides"},gossip:["I've heard rumors about a mystical stone that can only be used by a hero.","We are all living in tents for now."]},{job:"shipwright",trades:{boat:"wood"},gossip:["Having your own ship is essential.","I've seen what looks like a shrine out in the sea."]},{job:"mystic",trades:{moonstone:"enlightenment"},gossip:["Blue moon gates are for traveling around the world.","Legends say that red moon gates go to other dimensions.","Only virtuous people can use moonstones."]}];let i=0;while(i<40){let xy=o.getRandomLoc();let jt=i<jobTrades.length?jobTrades[i]:jobTrades[randInt(jobTrades.length)-1];let imgName=randInt(2)==1?"npc":"villager";if(jt.job=="mystic"){imgName="mystic"}o.npcs.push(new Character(o,xy.x,xy.y,imgName,jt.job,jt.trades,jt.gossip));i++}o.allThings=o.allThings.concat(o.npcs)}buildShrines(){let o=this;let virtues=["Honesty","Compassion","Valor","Justice","Honor","Sacrifice","Spirituality","Humility"];let mantras=["Ahm","Mu","Ra","Beh","Summ","Cah","Om","Lum"];let i=8;let minD=o.size/10;while(i-- >0){let xy=o.getRandomLoc(o.shrines,minD);o.shrines.push(new Shrine(o,xy.x,xy.y,virtues[i],mantras[i]))}o.allThings=o.allThings.concat(o.shrines)}buildPortals(redCallback){let o=this;let i=8;let minD=o.size/2;while(i-- >0){let xy=o.getRandomLoc(o.portals,minD);let p=new Portal(o,xy.x,xy.y);p.keepAwayFromEdge();o.portals.push(p);o.terrainMarkers.push(new TerrainMarker(o,xy.x,xy.y,"P"))}o.allThings=o.allThings.concat(o.portals);o.portals.forEach(p=>{p.connect(o.portals);p.redCallback=redCallback})}buildTerrain(){let ts=2;let o=this;o.loopOverPixels((x,y,i)=>{let k=o.getTerrainTypeAt(x,y);o.terrain.push(new TerrainPoint(o,x,y,k,ts))},ts)}getRandomLoc(notNear,minD,c){let o=this;let loc=new Coords(randInt(o.size)-o.half,randInt(o.size)-o.half);if(typeof c==="undefined"){c=1e4}if(notNear&&c>0){let tryAgain=false;notNear.forEach(w=>{let d=w.loc.getDistance(loc);if(d<minD){tryAgain=true}});if(tryAgain){return o.getRandomLoc(notNear,--minD,--c)}}return loc}getNearestThing(loc,near){let o=this;let nearThing=null;near=near||Infinity;o.allThings.forEach(thing=>{let d=loc.getDistance(thing.loc);if(d<=near){near=d;nearThing=thing}});return nearThing}loopOverPixels(fn,sz){let h=this.half;let x=h*-1;let i=0;while(x<=h){let y=h*-1;while(y<=h){fn(x,y,i);i++;y+=sz}x+=sz}}loopOverTerrainInBounds(fn,bounds){let o=this;let i=o.terrain.length-1;while(i>=0){let t=o.terrain[i];if(t.x<bounds.max.x&&t.x>bounds.min.x&&t.y<bounds.max.y&&t.y>bounds.min.y){fn(t)}i--}}getTerrainTypeAt(x,y){let at=new Coords(x,y);let dMin=Infinity;let kMin="Z";let k="Z";this.terrainMarkers.forEach(t=>{let d=t.loc.getDistance(at);d*=t.power;let diff=Math.abs(d-dMin);if(d<dMin){dMin=d;k=t.typeKey;kMin=k}if(diff<50&&kMin=="W"&&t.typeKey!="W"){dMin=d;k="C"}});return k}keepInBounds(loc){let h=this.half;loc.x=Math.min(Math.max(loc.x,h*-1),h);loc.y=Math.min(Math.max(loc.y,h*-1),h)}draw(c,s){let o=this;let bounds=s.getBoundaries();o.loopOverTerrainInBounds(t=>{t.draw(c,s)},bounds)}}class TerrainPoint{constructor(w,x,y,k,sz){let o=this;o.x=x;o.y=y;o.size=sz;o.loc=new Coords(x,y);o.typeKey=k;o.world=w;o.discovered=0;o.visible=false;o.color=w.terrainTypes[k].slice(0);o.color.forEach((c,i)=>{o.color[i]=Math.max(c-randInt(25),0)});o.hp=1}getColorStyle(light,hue){let o=this;let c=o.color.slice(0);if(o.visible){if(o.typeKey=="W"){light=light*(randInt(500)==1)?1.1:1}}else{let wa=(c[0]+c[1]+c[2])/3*2;c.forEach((co,i)=>{c[i]=(co+wa)/3});light*=.9;if(o.typeKey=="W"){light*=.8}}light*=o.hp;c.forEach((co,i)=>{c[i]=Math.round(co*light+hue[i])});return"rgba("+c.join(",")+","+o.discovered+")"}draw(c,s){let o=this;if(o.discovered){let xy=s.getScreenXY(o.loc);let sz=Math.ceil(o.size*s.zoom);c.fillStyle=o.getColorStyle(o.world.light,o.world.hue);c.fillRect(xy.x,xy.y,sz,sz)}}}class TerrainMarker extends Thing{constructor(w,x,y,k){super(w,x,y);let r=rand();if(typeof k!="string"){let d=this.loc.getDistance(new Coords(0,0));if(r<d/w.half)k="W";else{r=rand();if(r<.5)k="P";else if(r<.8)k="F";else if(r<.9)k="M";else k="D"}}this.typeKey=k;this.power=15+randInt(5)}draw(c,s){let pos=s.getScreenXY(this.loc);let color=this.world.terrainTypes[this.typeKey];let r=color[0]+40,g=color[1]+40,b=color[2];c.fillStyle="rgb("+r+","+g+","+b+")";c.fillRect(pos.x,pos.y,4*s.zoom,4*s.zoom)}}class Screen{constructor(id,multiplier,focus){var o=this;o.id=id;o.multiplier=multiplier;o.canvas=null;o.ctx=null;o.zoom=1;o.size=new Coords(0,0);o.half=new Coords(0,0);o.focus=focus}setup(){let o=this;o.canvas=document.getElementById(o.id);o.ctx=o.canvas.getContext("2d");o.ctx.imageSmoothingEnabled=false;o.canvas.style.imageRendering="pixelated";o.setSize();window.onresize=(e=>{o.setSize()})}setSize(){var o=this;var w=window,d=document,e=d.documentElement,g=d.getElementsByTagName("body")[0],x=w.innerWidth||e.clientWidth||g.clientWidth,y=w.innerHeight||e.clientHeight||g.clientHeight,v=o.canvas,m=o.multiplier;o.size.set(x*m,y*m);o.half.set(x*m/2,y*m/2);v.style.width=x+"px";v.style.height=y+"px";v.width=x*m;v.height=y*m}clear(){this.ctx.clearRect(0,0,this.size.x,this.size.y)}draw(what){if(what instanceof Array){what.forEach(w=>{this.draw(w)});return}let c=this.ctx;c.save();if(typeof what.draw==="function"){what.draw(c,this)}else if(typeof what.img==="object"){let pos=this.getScreenXY(what.loc);let sz=what.size*this.zoom;let h=what.half*this.zoom;this.ctx.drawImage(what.img,pos.x-h,pos.y-h,sz,sz)}c.restore()}getBoundaries(){let o=this;return{min:{x:Math.floor(o.focus.x-o.half.x/o.zoom),y:Math.floor(o.focus.y-o.half.y/o.zoom)},max:{x:Math.ceil(o.focus.x+o.half.x/o.zoom),y:Math.ceil(o.focus.y+o.half.y/o.zoom)}}}getFocusOffset(){let o=this;return{x:o.half.x/o.zoom-o.focus.x,y:o.half.y/o.zoom-o.focus.y}}getScreenXY(x,y){let xy=new Coords(x,y);let fo=this.getFocusOffset();return{x:Math.round((xy.x+fo.x)*this.zoom),y:Math.round((xy.y+fo.y)*this.zoom)}}getScreenXYOffset(x,y){let xy=this.getScreenXY(x,y);xy.x+=.5;xy.y+=.5;return xy}zoomIn(){if(this.zoom<3){this.zoom*=1.2}}zoomOut(){if(this.zoom>.2){this.zoom/=1.2}}}class Loop{constructor(fn,t){this.wait=t;this.timer=null;this.fn=fn}start(){this.next(new Date)}next(last){let o=this;let start=new Date;let t=start-last;o.fn(t);let took=new Date-start;let wait=Math.max(o.wait-took,1);o.timer=window.setTimeout(()=>{o.next(start)},wait)}stop(){window.clearInterval(this.timer)}}var PI2=Math.PI*2;class Game{constructor(){var o=this;o.world={};o.pc={};o.screen={};o.loop={};o.time=new Date;o.invOpen=false}gameLoop(t){let o=this;o.advanceTime(t/5);let ct=Math.round(o.time.getMinutes())==0;o.setLight();o.drawTime();o.pc.setSight();o.screen.clear();o.pc.discover(o.screen.getBoundaries());o.pc.live(t);o.pc.focusOnNearest();if(o.pc.focus){o.nameElt.innerHTML=o.pc.focus.name;o.verbElt.innerHTML="[E] "+o.pc.focus.verb;o.nameElt.style.display="block";o.verbElt.style.display="block"}else{o.nameElt.style.display="none";o.verbElt.style.display="none"}o.world.allThings.forEach(t=>{t.selected=t===o.pc.focus;if(t instanceof Portal){t.checkTeleport(o.pc)}});if(o.invOpen){o.drawInventory()}{let i=randInt(o.world.npcs.length)-1;let npc=o.world.npcs[i];npc.live(t,o.isNighttime())}let c=o.screen.ctx;o.screen.draw([o.world,o.world.shrines,o.world.portals,o.world.npcs,o.pc])}advanceTime(t){let o=this;if(o.pc.isCamping){t*=30}else if(o.pc.isMeditating){t*=10}o.time.setSeconds(o.time.getSeconds()+t)}drawTime(){let o=this;if(o.pc.has("watch")){o.timeElt.innerHTML=o.time.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}}drawInventory(){let o=this;let h="";for(let item in o.pc.inventory){if(o.pc.inventory[item]){h+="<li>"+item+"</li>"}}o.itemsElt.innerHTML=h;h="";for(let v in o.pc.virtues){h+="<li>"+v+"</li>"}o.virtuesElt.innerHTML=h?h:"<li>None</li>";o.virtueCountElt.innerHTML=Math.ceil(o.pc.virtueCount*100/8)+"% complete";let people=0;for(let p in o.pc.met){people++}o.peopleElt.innerHTML=people+"/"+o.world.npcs.length+" met"}isNighttime(){let hr=g.time.getHours();return hr>22||hr<6}setLight(){let o=this;let hr=g.time.getHours();let l;if(hr>12&&hr<24){l=(12-hr%12)/10}else{l=hr/10}if(o.pc.isMeditating){o.world.hue=[-50,-100,50]}else{o.world.hue=[0,0,0]}o.world.light=Math.min(Math.max(l,.3),1)}init(){let o=this;console.time("init/setup");console.log("%c☥","font-size: 400%; color: yellow;","\nStarting the game...");o.setupDOM();o.setupEvents();o.setupData();o.screen.setup();console.timeEnd("init/setup");setTimeout(()=>{o.intro()},200)}intro(){let o=this;o.loop.stop();o.introElt.style.display="block";o.titleElt.style.display="block";o.loadingElt.style.display="none";o.bodyElt.style.display="none"}beginAdventure(){let o=this;o.loop.start();o.introElt.style.display="none";o.titleElt.style.display="none";o.invElt.style.display="block";o.loadingElt.style.display="none";o.bodyElt.style.display="block";o.invOpen=true;o.pc.speak(["Where am I?","Lost in a foreign land..."])}setupData(){let o=this;console.time("build world");let w=o.world=new World(1200);let h=o.loadingElt.innerHTML;function fn(txt){h+=txt;o.loadingElt.innerHTML=h}fn("<br>Generating terrain...");w.buildTerrainMarkers();fn("<br>Growing NPCs...");w.buildNPCs();fn("<br>Creating Shrines...");w.buildShrines();fn("<br>Building Ancient Moon Gates...");w.buildPortals(()=>{o.win()});fn("<br>Assembling the World...<br>");w.buildTerrain();console.timeEnd("build world");console.time("setup other data");o.pc=new Player(o.world,0,0);o.screen=new Screen("g",.25,o.pc.loc);o.loop=new Loop(t=>{o.gameLoop(t)},20);console.timeEnd("setup other data")}setupDOM(){let o=this;o.nameElt=o.elt("what");o.verbElt=o.elt("verb");o.invElt=o.elt("inventory");o.timeElt=o.elt("time");o.itemsElt=o.elt("items");o.virtuesElt=o.elt("virtues");o.titleElt=o.elt("title");o.loadingElt=o.elt("loading");o.bodyElt=o.elt("body");o.winElt=o.elt("win");o.virtueCountElt=o.elt("virtueCount");o.peopleElt=o.elt("people");o.introElt=o.elt("intro")}elt(id){return document.getElementById(id)}setupEvents(){let o=this;o.elt("beginButton").onclick=(()=>{o.beginAdventure()});document.addEventListener("keydown",e=>{e.pd=e.preventDefault;switch(e.keyCode){case 80:o.intro();e.pd();break;case 13:o.beginAdventure();e.pd();break;case 37:case 65:o.pc.move(3);o.cancel();e.pd();break;case 38:case 87:o.pc.move(0);o.cancel();e.pd();break;case 39:case 68:o.pc.move(1);o.cancel();e.pd();break;case 40:case 83:o.pc.move(2);o.cancel();e.pd();break;case 187:o.screen.zoomIn();break;case 189:o.screen.zoomOut();break;case 69:case 32:o.pc.action();e.pd();break;case 73:case 9:o.toggleInventory();e.pd();break;case 77:o.pc.toggleMeditate();e.pd();break;case 27:o.cancel();e.pd();break;default:console.log(e.keyCode)}},false)}toggleInventory(){let style=this.invElt.style;this.invOpen=style.display=="none";if(this.invOpen){style.display="block"}else{style.display="none"}}cancel(){this.pc.cancel()}win(){this.bodyElt.style.display="none";this.winElt.style.display="block";this.titleElt.style.display="block"}}