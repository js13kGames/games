<!doctype html><title>Outaluq</title><script src=/socket.io.js></script><script src=keydrown.js></script><script src=store.js></script><style>table{width:1000px}td{padding:20px;color:#000;background:#ccc;text-align:center}</style><body style=background:#2b2b2b><div style=position:relative id=wrap><div style=width:1000px;height:500px;position:absolute;top:0;left:0;z-index:-1;overflow:hidden><canvas height=5000 id=canvas0 style=position:absolute width=5000></canvas></div><canvas height=500 id=canvas1 style="float:left;background:0 0" width=1000></canvas><span id=data style=font-family:courier;font-size:12px;color:#fff></span> <span id=theirdata style=font-family:courier;font-size:12px;color:#fff></span><div style=clear:both><table style=width:1000px><tr><td id=i1>?<td id=i2>?<td id=i3>?<td id=i4>?<td id=i5>?<td id=i6>?<td id=i7>?<td id=i8>?<td id=i9>?<td id=i10>?</table></div></div><script src=shape.js></script><script src=ship.js></script><script src=player.js></script><script>var canvas,ctx,playerPosX,playerPosY,triangleSideLength=20,playerColour="#ff0000",moveRate=0,moveSteps=5,moveAngle=0,angleSteps=5,keys={},player,pulses=[],mapOffsetX=0,mapOffsetY=0,playerMapPosition,friction=10,map={width:5e3,height:5e3},players={},mapArray=[],startTime=Date.now(),lastScoreDisplayedTime=0,lastScoreDisplayed,luck=100,socketId,socket=io({path:location.pathname+"io",upgrade:!1,transports:["websocket"]}),username,people,worldItems=[],colourCollisionRange=4,ded=!1,globalScoreThatJarredWillNeedToRefactor,items=[],myItems=[],temp,canvas0,ctx0;function addWorldItem(e,t){return worldItems.push({type:e,colour:t.split(",")}),worldItems.length}function removeWorldItem(e){worldItems=worldItems.splice(e,1)}function initialise(e){for(var t in socketId=e.socketId,people=e.data)if(people.hasOwnProperty(t)){var a=people[t];t==socketId&&(mapOffsetX=people[t].coords.vpx,mapOffsetY=people[t].coords.vpy,a.coords.x+=people[t].coords.vpx,a.coords.y+=people[t].coords.vpy),players[t]=new Player(a.coords.x,a.coords.y,a.colour,t,a.direction,a.username,a.luck,{})}}function update(){render(),requestAnimationFrame(update)}function findObjectICollidedWith(e){for(var t=0;t<worldItems.length;t++)if(e[0]<worldItems[t].colour[0]+colourCollisionRange&&e[0]>worldItems[t].colour[0]-colourCollisionRange&&e[1]<worldItems[t].colour[1]+colourCollisionRange&&e[1]>worldItems[t].colour[1]-colourCollisionRange&&e[2]<worldItems[t].colour[2]+colourCollisionRange&&e[2]>worldItems[t].colour[2]-colourCollisionRange)return worldItems[t];return!1}function Pulse(e,t,a,s){return{transparency:.8,lineWidth:2,myx:2,px:e,py:t,colour:a,draw:function(){var e=ctx.lineWidth,t=ctx.strokeStyle,a=ctx.fillStyle;ctx.save(),ctx.translate(this.px+mapOffsetX,this.py+mapOffsetY),ctx.beginPath(),ctx.lineWidth=this.lineWidth,ctx.strokeStyle="rgba("+this.colour+","+this.transparency+")",ctx.fillStyle="transparent",ctx.arc(0,0,1.5*this.myx,0,2*Math.PI,!1),ctx.stroke(),ctx.closePath(),ctx.lineWidth=e,ctx.strokeStyle=t,ctx.fillStyle=a,ctx.restore()},cb:s}}function moveX(e,t,a,s,o,c){return blahX=e+Math.abs(mapOffsetX),blahX-=a*Math.sin(s*Math.PI/180)+(o+1)*c,t+=Math.abs(mapOffsetY),255==ctx0.getImageData(blahX,t,1,1).data[0]?0:a*Math.sin(s*Math.PI/180)}function moveY(e,t,a,s,o,c){blahY=t+Math.abs(mapOffsetY),blahY+=a*Math.cos(s*Math.PI/180)+(o+1)*c,e+=Math.abs(mapOffsetX);var r=ctx0.getImageData(e,blahY,1,1).data;return 255==r[0]&&255==r[1]&&255==r[2]?0:a*Math.cos(s*Math.PI/180)}function displayScore(){if(!ded){var e="Score: "+(Date.now()-startTime);Date.now()-lastScoreDisplayedTime>500?lastScoreDisplayedTime=Date.now():e=lastScoreDisplayed;var t=canvas.width-10;ctx.beginPath(),ctx.fillStyle="white",ctx.fillText(e,t,20),ctx.font="20px Lucida Console",ctx.textAlign="right",ctx.closePath(),lastScoreDisplayed=e,globalScoreThatJarredWillNeedToRefactor=e}}function displayLuck(){var e=255-luck/100*255,t=luck/100*255;for(var a in ctx.fillStyle="rgba("+Math.floor(e)+","+Math.floor(t)+","+Math.floor(0)+",0.8)",ctx.fillRect(10,10,canvas.width*(luck/400),20),document.getElementById("data").innerHTML="<br> Yo luck: "+luck,players)players[a].socketId!=socketId?document.getElementById("data").innerHTML+="<br><span style=' color: rgb("+players[a].colour+"); '>"+players[a].username+" - Luck: "+players[a].luck+"</span>":document.getElementById("data").innerHTML+="<br><span style=' color: rgb("+players[a].colour+"); '>"+players[a].username+" - Luck: "+luck+"</span>"}function displayItems(){for(var e=0;e<items.length;e++)ctx.beginPath(),ctx.fillStyle="green",ctx.fillRect(items[e].x,items[e].y,items[e].width,items[e].height),ctx.closePath()}function displayPulses(){for(var e=0;e<pulses.length;e++)pulses[e].draw(),pulses[e].myx++,pulses[e].transparency-=.01,pulses[e].lineWidth+=.05,pulses[e].transparency<.02&&(void 0!==pulses[e].cb&&pulses[e].cb(),pulses.splice(0,1))}function displayItems(){for(var e=0;e<items.length;e++)ctx.beginPath(),ctx.fillStyle="green",ctx.fillRect(items[e].x,items[e].y,items[e].width,items[e].height),ctx.closePath()}function drawBlock(e,t,a,s){var o=e*a,c=t*a;ctx0.beginPath(),ctx0.fillStyle="white",ctx0.fillRect(o,c,a,a),ctx0.closePath()}function render(){for(var e in ctx.clearRect(0,0,canvas.width,canvas.height),displayPulses(),ctx.save(),ctx.translate(mapOffsetX,mapOffsetY),displayItems(),ctx.restore(),players)players.hasOwnProperty(e)&&players[e].update();displayInventory(),displayScore(),displayLuck(),canvas0.style.left=mapOffsetX+"px",canvas0.style.top=mapOffsetY+"px"}function displayInventory(){for(var e=0;e<10;e++){(t=document.getElementById("i"+(e+1))).style.backgroundColor="#cccccc",t.innerHTML="?"}for(e=0;e<myItems.length;e++){var t;(t=document.getElementById("i"+(e+1))).style.backgroundColor=myItems[e].colour,t.innerHTML=e+1,e+1==10&&(t.innerHTML=0)}}function useItem(e){socket.emit("useItem",{slot:e}),"Pulse"==myItems[e].name&&(pulses.push(new Pulse(players[socketId].mapX,players[socketId].mapY,players[socketId].colour)),playerEvent({type:"pulse",data:{mapX:players[socketId].mapX,mapY:players[socketId].mapY,colour:players[socketId].colour}})),myItems.splice(e,1)}function playerEvent(e){socket.emit("worldEvent",e)}socket.on("connect",(function(){store.get("username")?username=store.get("username"):(username=prompt("What is your username?"),store.set("username",username)),socket.emit("playerConnect",{username:username,socketId:socketId})})),socket.on("updateOtherPlayers",(function(e){switch(e.type){case"moved":players[e.socketId].updateCoords(e.data.coords.x,e.data.coords.y,e.data.direction);break;case"luckUpdate":players[e.socketId].updatePlayerState(e,!1);break;case"disconnected":case"dead":delete players[e.socketId];break;case"playerJoined":players[e.socketId]=new Player(e.data.coords.x,e.data.coords.y,e.data.colour,e.data.socketId,e.data.direction,e.data.username,e.data.luck,{})}})),socket.on("worldEvents",(function(e){if("pulse"===e.type){var t=addWorldItem(e.type,e.data.colour);pulses.push(new Pulse(e.data.mapX,e.data.mapY,e.data.colour,(function(){removeWorldItem(t)})))}})),socket.on("updateItems",(function(e){items=e})),socket.on("updatePlayer",(function(data){switch(data.type){case"initialise":initialise(data);break;case"luckUpdate":players[data.socketId].updatePlayerState(data,!0);break;case"updateInventory":myItems=data.data;break;case"dead":players[data.socketId].kill();break;case"map":data.data.map.forEach((function(e,t){e.forEach((function(e,a){e&&drawBlock(a,t,data.data.width,data.data.colour)}))}));break;case"itemUsed":var tmp="";for(key in data.data.effect)tmp=eval(key),eval(key+"= data.data.effect[key]");setTimeout((function(){eval(key+" = "+tmp)}),1e3*data.data.duration)}})),kd.LEFT.down((function(){players[socketId].lastX=players[socketId].x,players[socketId].lastDirection=players[socketId].direction,players[socketId].direction-=angleSteps,players[socketId].direction<0?players[socketId].direction=360+players[socketId].direction:players[socketId].direction>360&&(players[socketId].direction=players[socketId].direction-360),players[socketId].updateCoords(players[socketId].x,players[socketId].y,players[socketId].direction)})),kd.RIGHT.down((function(){players[socketId].lastX=players[socketId].x,players[socketId].lastDirection=players[socketId].direction,players[socketId].direction+=angleSteps,players[socketId].direction<0?players[socketId].direction=360+players[socketId].direction:players[socketId].direction>360&&(players[socketId].direction=players[socketId].direction-360),players[socketId].updateCoords(players[socketId].x,players[socketId].y,players[socketId].direction)})),kd.UP.down((function(){ded||(players[socketId].lastY=players[socketId].y,moveSteps=-1*Math.abs(moveSteps),players[socketId].updateCoords(moveSteps,players[socketId].direction))})),kd.P.up((function(){ded||(pulses.push(new Pulse(players[socketId].mapX,players[socketId].mapY,players[socketId].colour)),playerEvent({type:"pulse",data:{mapX:players[socketId].mapX,mapY:players[socketId].mapY,colour:players[socketId].colour}}))})),kd.ONE.up((function(){myItems[0]&&useItem(0)})),kd.TWO.up((function(){myItems[0]&&useItem(1)})),kd.THREE.up((function(){myItems[0]&&useItem(2)})),kd.FOUR.up((function(){myItems[0]&&useItem(3)})),kd.FIVE.up((function(){myItems[0]&&useItem(4)})),kd.SIX.up((function(){myItems[0]&&useItem(5)})),kd.SEVEN.up((function(){myItems[0]&&useItem(6)})),kd.EIGHT.up((function(){myItems[0]&&useItem(7)})),kd.NINE.up((function(){myItems[0]&&useItem(8)})),kd.ZERO.up((function(){myItems[0]&&useItem(9)})),kd.run(kd.tick.bind(kd)),window.onload=function(){canvas=document.getElementById("canvas1"),ctx=canvas.getContext("2d"),canvas0=document.getElementById("canvas0"),ctx0=canvas0.getContext("2d"),playerPosX=canvas.width/2,playerPosY=canvas.height/2,requestAnimationFrame(update)}</script>