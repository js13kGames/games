document.addEventListener("DOMContentLoaded",()=>{let e,t,n=null,o=document.querySelector("main"),s=document.querySelector("header"),d=null,r=document.querySelector("form.start input");r.value=localStorage.getItem("n")||"",document.querySelector("form.start").addEventListener("submit",a=>{a.preventDefault(),function(r){localStorage.setItem("n",r),document.body.classList.remove("initial"),(n=io({query:`name=${encodeURIComponent(r)}`})).on("connect",()=>{console.log("connected",n.id),document.body.classList.add("connected")}),n.on("disconnect",()=>{console.log("disconnected"),location.reload()}),n.on("state",r=>{console.log("state",r),document.body.dataset.state=r.state,r.cfg.squad&&(t=r.cfg.squad),r.players&&(d=r.players),r.field&&function(t,n){if(e=o.querySelector(".field"))return;(e=document.createElement("div")).classList.add("field"),e.style.setProperty("--h",t),e.style.setProperty("--w",n),o.appendChild(e)}(r.field.height,r.field.width),"pick"===r.state&&(!function(t){t.forEach(t=>{let o=document.createElement("a");o.classList.add("char"),o.id=t.id,o.href="#",o.title=t.hp+" HP",o.style.setProperty("--x",t.pos.x),o.style.setProperty("--y",t.pos.y),o.tabIndex=100*t.pos.y+t.pos.x+1,o.dataset.dir=t.dir,o.addEventListener("click",e=>{e.preventDefault(),n.emit("activate",{char:t.id})});let s=document.createElement("div");s.classList.add("hp"),o.appendChild(s);let d=document.createElement("div");d.classList.add("body"),o.appendChild(d);let r=document.createElement("div");r.classList.add("dirs"),r.innerHTML=t.directions.map((e,n)=>`<span class="${e.dir}${n===t.nextDir?" next":""}"></span>`).join(" "),o.appendChild(r),e.appendChild(o)})}(r.chars),s.innerHTML=r.players.map(e=>`<div class="name" data-owner="${e.index}" data-owner-id="${e.id}"><span>${e.name}</span><div class="hp"></div></div>`).join('<span class="vs">VS</span>'),setTimeout(()=>{e.classList.add("ok"),l("state")},100)),"game-over"===r.state&&(l("state"),"abandon"===r.data.reason?document.body.classList.add("abandon"):r.data.winner.id===n.id?document.body.classList.add("won"):document.body.classList.add("lost"))}),n.on("pick",t=>{console.log("pick",t);let o=e.querySelector("#"+t.cid);o.focus(),o.dataset.owner=t.pindex,t.pid===n.id?o.classList.add("own"):o.classList.add("nope"),t.done&&t.pid===n.id&&document.querySelector(".picking").classList.add("done"),l("pick"+(t.pid!==n.id?"2":""))}),n.on("turn",e=>{console.log("turn",e);let t=d[e.turn%d.length];document.body.dataset.turn=t.id===n.id?"me":"opp"}),n.on("remove-chars",t=>{console.log("remove-chars",t),t.chars.forEach(t=>{let n=e.querySelector("#"+t.id);n.remove()})}),n.on("new-pos",t=>{console.log("new-pos",t);let n=e.querySelector("#"+t.char.id);n.focus(),n.tabIndex=100*t.char.pos.y+t.char.pos.x+1,n.dataset.dir=t.char.dir;for(let e=0;e<t.moves.length;e++)setTimeout(()=>{l("new-pos"),n.style.setProperty("--x",t.moves[e].x),n.style.setProperty("--y",t.moves[e].y)},400*e);setTimeout(()=>{n.querySelector(".dirs .next").classList.remove("next"),n.querySelectorAll(".dirs > *")[t.char.nextDir].classList.add("next")},4e3)}),n.on("attack",n=>{console.log("attack",n);let o=document.createElement("div");o.classList.add("bullet"),o.style.setProperty("--x",n.char.pos.x),o.style.setProperty("--y",n.char.pos.y),e.appendChild(o),setTimeout(()=>{o.style.setProperty("--x",n.enemy.pos.x),o.style.setProperty("--y",n.enemy.pos.y),l("shot")},30),setTimeout(()=>{o.remove(),function(t,n,o,s){for(let d=0;d<n;d++){let n=document.createElement("div");n.classList.add("particle"),n.style.setProperty("--x",t.x),n.style.setProperty("--y",t.y),n.style.setProperty("--scale",rand(5,1)/10),n.style.background=s,e.appendChild(n),setTimeout(()=>{n.style.setProperty("--x",t.x+rand(o,-o)/100),n.style.setProperty("--y",t.y+rand(o,-o)/100),n.classList.add("go"),setTimeout(()=>{n.remove()},1e3)},10)}}(n.enemy.pos,n.fromBack?30:10,n.fromBack?200:100,n.fromBack?"#F00":"#FFF");let s=document.querySelector("#"+n.enemy.id);s.title=n.enemy.hp+" HP";let d=s.querySelector(".hp");d.style.setProperty("--hp",n.enemy.hp);let r=document.querySelector('header [data-owner-id="'+n.enemy.owner+'"] .hp'),a=n.chars.filter(e=>e.owner===n.enemy.owner).reduce((e,n)=>e+n.hp/t,0);r.title=a+" HP",r.style.setProperty("--hp",a),l("hit"+(n.fromBack?"":"0"),n.damage);let i=document.createElement("div");i.innerHTML="-"+n.damage,i.classList.add("dmg"),i.style.setProperty("--x",n.enemy.pos.x),i.style.setProperty("--y",n.enemy.pos.y),e.appendChild(i),setTimeout(()=>{i.style.setProperty("--y",n.enemy.pos.y-1),i.style.opacity=0,setTimeout(()=>{i.remove()},500),n.fromBack&&function(e){if(window.SpeechSynthesisUtterance&&window.speechSynthesis){let t=new SpeechSynthesisUtterance(e);t.pitch=.01,t.rate=.5,speechSynthesis.speak(t)}}("backshot!")},1e3)},800)}),n.on("die",t=>{console.log("die",t),setTimeout(()=>{l("die",2)},0),setTimeout(()=>{l("die",4)},300),setTimeout(()=>{l("die",6)},600),setTimeout(()=>{l("die",10)},1e3);let n=e.querySelector("#"+t.enemy.id);n.classList.add("died"),setTimeout(()=>{n.remove()},1800)}),n.on("error",e=>{console.error(e),document.body.classList.add("error")})}(r.value),function(){let e=new AudioContext,t=e.createScriptProcessor(0,0,1),n=0,o=[[0,1,,,2,1],[3,1,,,3,0],[1,3,,,2,0],[6,2,,,3,5]],s=0;t.onaudioprocess=function(t){let d=t.outputBuffer.getChannelData(0);for(let t=0;t<d.length;t++){let r=++n/e.sampleRate*2.2;n%(2*(7.27275*e.sampleRate|0))==0&&s++,d[t]=(Math.random()*((1-2*r%1)**5+(1-r/2%1)**16*8)+r*(12&r|32)*o[s%o.length][2*r&5]%1)/16}},t.connect(e.destination)}()}),document.querySelectorAll("a.ranking").forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),document.querySelector("div.ranking").classList.add("show");let t=document.querySelector("div.ranking table tbody");t.innerHTML="Loading...",fetch("/ranking").then(e=>e.json()).then(e=>{t.innerHTML="",e.forEach((e,n)=>{let o=document.createElement("tr"),s=document.createElement("td");s.innerHTML=n+1+".",o.appendChild(s);let d=document.createElement("td");d.innerHTML=e.n,o.appendChild(d);let r=document.createElement("td");r.innerHTML=e.p,o.appendChild(r);let a=document.createElement("td");a.innerHTML=e.w,o.appendChild(a);let l=document.createElement("td");l.innerHTML=e.l,o.appendChild(l),t.appendChild(o)})})})}),document.querySelector("div.ranking button").addEventListener("click",e=>{e.preventDefault(),document.querySelector("div.ranking").classList.remove("show")}),document.querySelector("a.bot").addEventListener("click",e=>{e.preventDefault(),n.emit("bot")});let a=document.querySelector(".wait small a");function l(e,t=1){let n=new Audio;n.src=jsfxr({state:[1,0,.38,.4,.41,.23,0,.49,0,0,0,0,0,0,0,.44,0,0,1,0,0,0,0,.5],pick:[0,0,.17,.4,.11,.26,0,0,0,0,0,0,0,.2,0,0,0,0,1,0,0,.1,0,.5],pick2:[2,0,.13,.4,.13,.37,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,.1,0,.8],"new-pos":[0,0,.19,.4,.19,.43,0,.2,0,0,0,0,0,.27,0,0,0,0,.66,0,0,0,0,.5],shot:[1,0,.1,.4,.2,.82,.2,-.3,0,0,0,0,0,.62,-.6,0,0,-.2,1,0,0,0,0,.8],hit:[3,0,.01*t,.6,.4,.02,0,0,0,0,0,.79,.74,0,0,0,-.02,-.25,1,0,0,0,0,.75],hit0:[3,0,.34,.69,.15,.1,0,-.2,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,.5],die:[3,0,.3,.7,.47,.03,0,.2,0,0,0,0,0,0,0,.85,.4,-.27,.1*t,0,0,0,0,.6]}[e]),n.play()}a.innerHTML=location.href,a.href=location.href});