<!doctype html><title>Line of Fire</title><style>canvas,div{margin:0;position:absolute;top:0;left:0}body{overflow-x:hidden;overflow-y:hidden;background:#000}</style><div><canvas id=c></canvas><canvas id=o></canvas></div><script src=/2018/webxr/babylon.js></script><script>function PersistentData(){this.data={soundOn:!0,musicOn:!0,keys:[90,81,83,68,32,0]},localStorage.getItem("LineOfFireData")}function Renderer(t,e,a){this.game=a,this.world=a.world,this.sceneryCanvas=t,this.overlayCanvas=e,this.overlayContext=e.getContext("2d"),this.babylonScene=0,this.windowLayout={playArea:[]},this.initBabylon(),this.resizeWindow(),this.frameCount=0,this.weaponOffset=[0,0,0,0,0],this.mainMenuText=["Start new game","Load game","Save game"],this.weaponName=["Armor piercing","Explosive","Splitter","Delay-action"],this.messageLine1="Line of Fire;;Game over;Game over;Game over;Pause;You win;You win;You win".split(";"),this.messageLine2="A WebXR game for js13k, built with Babylon.js. Press Enter or click to start;;Tank destroyed;Another player seized control of the arena;Time's out;Press P or Enter to resume;You are the only one left in the arena;You gained control of eight beacons".split(";"),this.playerColor=["#0ff","#4f4","#f0f","#f72"]}function World(t){this.controls=t,this.initialize(),this.message=this.playerId=0,this.messageTimer=-500,this.ground=[],this.loadLevel(),this.aiPlayers=[new AIPlayer(1),new AIPlayer(2),new AIPlayer(3)]}function AIPlayer(t){this.playerId=t,this.moveTargetZ=this.moveTargetX=0,this.shootTarget=(t+1)%4}function Controls(t){this.windowLayout=!1,this.persistentData=t,this.mouseY=this.mouseX=0,this.worldDX=.5,this.worldDY=0,this.totalClear()}function Game(t,e){this.controls=t,this.persistentData={},this.world=new World(t),this.state=-1}function main(){controls=new Controls(new PersistentData),"ontouchstart"in document.documentElement?(document.ontouchstart=function(t){return controls.onTouchStart(t)},document.ontouchenter=function(t){return controls.onTouchStart(t)},document.ontouchend=function(t){return controls.onTouchEnd(t)},document.ontouchleave=function(t){return controls.onTouchEnd(t)},document.ontouchmove=function(t){return controls.onTouchMove(t)}):(document.onmousedown=function(t){return controls.onMouseDown(t)},document.onmouseup=function(t){return controls.onMouseUp(t)},document.onmousemove=function(t){return controls.onMouseMove(t)}),document.onkeydown=function(t){return controls.onKeyDown(t)},document.onkeyup=function(t){return controls.onKeyUp(t)},document.oncontextmenu=function(t){return!1};var t=localStorage.getItem("LineOfFireData"),e={};t&&(e=JSON.parse(t)),game=new Game(controls,e),renderer=new Renderer(document.getElementById("c"),document.getElementById("o"),game),window.addEventListener("resize",(function(t){renderer.resizeWindow()})),game.setRenderer(renderer),game.launch()}function registerControllerEvents(t){t.onTriggerStateChangedObservable.add((function(t){controls.onVRTrigger(t)})),t.onMainButtonStateChangedObservable.add((function(t){controls.onVRMainButton(t)})),t.onSecondaryButtonStateChangedObservable.add((function(t){controls.onVRSecondaryButton(t)})),t.onPadValuesChangedObservable.add((function(t){controls.onVRThumbStick(t)}))}PersistentData.prototype={storeData:function(){localStorage.setItem("LineOfFireData",JSON.stringify(this.data))},toggleSound:function(){this.data.soundOn=!this.data.soundOn,this.storeData()},toggleMusic:function(){this.data.musicOn=!this.data.musicOn,this.storeData()},setKey:function(t,e){this.data.keys[t]=e,-1<e&&this.storeData()}},Renderer.prototype={initBabylon:function(){this.engine=new BABYLON.Engine(this.sceneryCanvas,!0),this.scene=new BABYLON.Scene(this.engine),this.camera=new BABYLON.FreeCamera("camera",new BABYLON.Vector3(128,300,128),this.scene),this.camera.attachControl(this.sceneryCanvas,!1),this.vrHelper=this.scene.createDefaultVRExperience({createDeviceOrientationCamera:!1}),this.vrHelper.onControllerMeshLoaded.add((function(t){registerControllerEvents(t)}));var t=new BABYLON.DirectionalLight("sunLight",new BABYLON.Vector3(1,-5,0),this.scene);this.expLight=new BABYLON.PointLight("pointLight",new BABYLON.Vector3(0,-5,0),this.scene),this.expLight.setEnabled(!1);for(var e=[],a=0;257>a;++a){for(var s=[],o=256;-1<o;--o)s.push(new BABYLON.Vector3(o,this.world.landscapeHeightAt(o,a),a));e.push(s)}e=BABYLON.MeshBuilder.CreateRibbon("ground",{pathArray:e},this.scene);var i=new BABYLON.StandardMaterial("groundMat",this.scene);this.groundTexture=new BABYLON.DynamicTexture("groundTex",1024,this.scene),this.groundTextureContext=this.groundTexture.getContext(),this.groundTextureContext.fillStyle="#c94",this.groundTextureContext.fillRect(0,0,1024,1024);var n=(s=this.groundTextureContext.getImageData(0,0,1024,1024)).data;for(a=0;1e6>a;++a){o=Math.floor(1022*Math.random());var r=Math.floor(1022*Math.random());o=Math.min(o,r,1023-o,1023-r,32)/32;var h=Math.floor(o*(95+60*Math.random())),l=Math.floor(o*(30+60*Math.random()));n[4096*r+4*a]=Math.floor(o*(150+60*Math.random())),n[4096*r+4*a+1]=h,n[4096*r+4*a+2]=l}for(this.groundTextureContext.putImageData(s,0,0),i.diffuseTexture=this.groundTexture,i.specularColor=new BABYLON.Color3(.3,.3,.3),e.material=i,this.groundTexture.update(),i=new BABYLON.TransformNode("tankRoot"),(s=new BABYLON.TransformNode("tankChassis")).parent=i,(o=BABYLON.MeshBuilder.CreateCylinder("wheel",{height:1.2,diameter:1.3,tesselation:16},this.scene)).position.x=-4.5,o.position.y=2.4,o.position.z=-1,o.parent=s,a=1;7>a;++a)(n=o.clone()).position.x=1.5*a-4.5,n.position.y=2.4,n.position.z=6==a?-1:0,n.parent=s;for(a=0;7>a;++a)(n=o.clone()).position.x=1.5*a-4.5,n.position.y=-2.4,n.position.z=0==a||6==a?-1:0,n.parent=s;for(r=[[-4.5,1.9,-3,1.9,3,1.9,4.5,1.75],[-4.5,.6,-3,-.5,3,-.5,4.5,.6]],h=[],n=[],o=0;o<r.length;++o){l=[];var c=[];for(a=0;a<r[0].length;a+=2)l.push(new BABYLON.Vector3(r[o][a],r[o][a+1],-2.7)),c.push(new BABYLON.Vector3(r[o][a],r[o][a+1],2.7));h.push(l),n.push(c)}for(a=BABYLON.MeshBuilder.CreateRibbon("leftWall",{pathArray:h,sideOrientation:BABYLON.Mesh.DOUBLESIDE},this.scene),o=BABYLON.MeshBuilder.CreateRibbon("rightWall",{pathArray:n,sideOrientation:BABYLON.Mesh.DOUBLESIDE},this.scene),a.parent=i,o.parent=i,n=[5.2,1,5.2,1.5,5,1.7,3,2,-4.7,2,-5.2,1.5,-5.2,1,-4.7,.5,3.5,.5,5.2,1],o=[],a=0;a<n.length;a+=2)o.push(new BABYLON.Vector3(n[a],n[a+1],0));for(n=[new BABYLON.Vector3(0,0,-1.8),new BABYLON.Vector3(0,0,1.8)],BABYLON.MeshBuilder.ExtrudeShape("body",{shape:o,path:n,sideOrientation:BABYLON.Mesh.DOUBLESIDE},this.scene).parent=i,r=[[5.2,1.5,5,1.7,3,2,-4.7,2,-5.2,1.5],[5.5,1.4,5,1.9,3,2,-4.7,2,-5.3,1.4],[5.5,1.4,5,1.9,3,2,-4.7,2,-5.3,1.4],[5.5,1.2,5,1,3,1,-4.7,1,-5.3,1.2]],h=[],n=[],o=0;o<r.length;++o){l=[],c=[];var d=[-1.8,-1.8,-3.1,-3.1][o],p=[1.8,1.8,3.1,3.1][o];for(a=0;a<r[0].length;a+=2)l.push(new BABYLON.Vector3(r[o][a],r[o][a+1],d)),c.push(new BABYLON.Vector3(r[o][a],r[o][a+1],p));h.push(l),n.push(c)}for(o=BABYLON.MeshBuilder.CreateRibbon("leftCover",{pathArray:h,sideOrientation:BABYLON.Mesh.DOUBLESIDE},this.scene),n=BABYLON.MeshBuilder.CreateRibbon("rightCover",{pathArray:n,sideOrientation:BABYLON.Mesh.DOUBLESIDE},this.scene),o.parent=i,n.parent=i,s.rotation.x=Math.PI/2,n=[1.5,2.1,2.4,2.5,2.5,2,1.2],s=[],r=[],o=0;7>o;++o)r.push(new BABYLON.Vector3(-3,2.5,0));for(s.push(r),o=0;o<n.length;++o)(r=[]).push(new BABYLON.Vector3(o-3,2.1,-n[o])),r.push(new BABYLON.Vector3(o-3,3,-n[o])),r.push(new BABYLON.Vector3(o-3,3.2,-.5*n[o])),r.push(new BABYLON.Vector3(o-3,3.2,.5*n[o])),r.push(new BABYLON.Vector3(o-3,3,n[o])),r.push(new BABYLON.Vector3(o-3,2.1,n[o])),r.push(new BABYLON.Vector3(o-3,2.1,-n[o])),s.push(r);for(n=[],o=0;7>o;++o)n.push(new BABYLON.Vector3(3,2.5,0));for(s.push(n),this.turret=[],this.turret.push(BABYLON.MeshBuilder.CreateRibbon("turret",{pathArray:s,sideOrientation:BABYLON.Mesh.DOUBLESIDE},this.scene)),this.cannon=[],n=[],r=[.2,.2,.2,.4,.4,.3,.3,.3,.3,.3],h=[0,1,2,2,3,3,4,5,6,7],l=0;16>l;++l){for(s=[],o=0;10>o;++o)s.push(new BABYLON.Vector3(h[o],r[o]*Math.sin(l*Math.PI/8),r[o]*Math.cos(l*Math.PI/8)));n.push(s)}for(this.cannon.push(BABYLON.MeshBuilder.CreateRibbon("cannon"+a,{pathArray:n,closeArray:!0,sideOrientation:BABYLON.Mesh.DOUBLESIDE},this.scene)),this.tank=[],this.tankParent=[],this.cannonParent=[],a=0;4>a;++a)this.tankParent[a]=new BABYLON.TransformNode("tankNode"+a),this.tank[a]=a?i.clone():i,this.tank[a].parent=this.tankParent[a],a&&(this.turret.push(this.turret[0].clone()),this.cannon.push(this.turret[a]._children[0]._children[0])),this.turret[a].parent=this.tankParent[a],this.cannonParent[a]=new BABYLON.TransformNode("cannonNode"+a),this.cannonParent[a].parent=this.turret[a],this.cannonParent[a].position.y=2.5,this.cannon[a].parent=this.cannonParent[a],s=(o=new BABYLON.DynamicTexture("tankTexture"+a,256,this.scene)).getContext(),this.createCamouflagePattern(s,[["#133","#277","#699","#5cc"],["#242","#472","#5b6","#3d3"],["#424","#726","#969","#d6d"],["#432","#762","#986","#e93"]][a]),(s=new BABYLON.StandardMaterial("tankMaterial"+a,this.scene)).specularColor=new BABYLON.Color3(.4,.4,.4),s.diffuseTexture=o,o.update(),this.setTreeMaterial(this.tankParent[a],s);for(this.beacon=[],this.beaconBeam=[],a=0;16>a;++a){for(this.beacon[a]=BABYLON.MeshBuilder.CreateCylinder("beacon"+a,{height:2,diameter:5,tesselation:16},this.scene),this.beacon[a].position.x=32+64*(3&a),this.beacon[a].position.z=32+64*(a>>2),this.beacon[a].position.y=this.world.landscapeHeightAt(this.beacon[a].position.x,this.beacon[a].position.z),(i=new BABYLON.StandardMaterial("beaconMat"+a,this.scene)).diffuseColor=new BABYLON.Color3(.25,.25,.25),this.beacon[a].material=i,this.beacon[a].receiveShadows=!0,i=[],o=0;5>o;++o)(s=BABYLON.MeshBuilder.CreateTorus("beacon"+a+"beam"+o,{thickness:.1},this.scene)).scaling=new BABYLON.Vector3(5+3*o,5+3*o,5+3*o),s.position.y=5*o,s.parent=this.beacon[a],n=new BABYLON.StandardMaterial("beamMat"+a+"."+o,this.scene),s.material=n,s.setEnabled(!1),i.push(s);this.beaconBeam.push(i)}for(this.shells=[],this.crates=[],this.crateMaterial=new BABYLON.StandardMaterial("crateMat",this.scene),this.crateMaterial.diffuseTexture=new BABYLON.Texture("crate.png",this.scene),this.explosions=[],this.playerColors=[new BABYLON.Color3(0,1,1),new BABYLON.Color3(.25,1,.25),new BABYLON.Color3(1,0,1),new BABYLON.Color3(1,.5,.15)],t=new BABYLON.ShadowGenerator(1024,t),a=0;4>a;++a)for(i=[],this.getAllMeshesInTree(this.tankParent[a],i),o=0;o<i.length;++o)t.addShadowCaster(i[o],!0);e.receiveShadows=!0},createCamouflagePattern:function(t,e){t.fillStyle="#000",t.fillRect(0,0,256,256);for(var a=t.getImageData(0,0,256,256).data,s=0,o=0,i=0,n=0;++n-4e5;i=13*i+.5+9*Math.cos(i)&-1){s+=[0,1,0,-1][3&i],o+=[0,1,0,-1][3-i&3];for(var r=0;++r-6;)for(var h=0;++h-6;)++a[1024*(o+h&255)+4*(s+r&255)]}for(n=0;++n-4e5;i=13*i+1.5+10*Math.cos(i)&-1)for(s+=[0,1,0,-1][3&i],o+=[0,1,0,-1][3-i&3],r=0;++r-6;)for(h=0;++h-6;)++a[1024*(o+h&255)+4*(s+r&255)+1];for(h=0;256>h;++h)for(r=0;256>r;++r)t.fillStyle=e[(128<a[1024*h+4*r]?1:0)+(128<a[1024*h+4*r+1]?2:0)],t.fillRect(r,h,1,1)},setTreeMaterial:function(t,e){if(t.material=e,t.hasOwnProperty("_children"))for(var a=0;a<t._children.length;++a)this.setTreeMaterial(t._children[a],e)},getAllMeshesInTree:function(t,e){if(t.hasOwnProperty("_children"))for(var a=0;a<t._children.length;++a)this.getAllMeshesInTree(t._children[a],e);t.hasOwnProperty("_geometry")&&e.push(t)},resetSceneGraph:function(){for(var t=0;t<this.beacon.length;++t)this.beacon[t].material.emissiveColor=new BABYLON.Color3(0,0,0);for(t=0;t<this.beaconBeam.length;++t)for(var e=0;e<this.beaconBeam[t].length;++e)this.beaconBeam[t][e].setEnabled(!1);for(t=0;t<this.shells.length;++t)this.shells[t].setEnabled(!1);for(t=0;t<this.crates.length;++t)this.crates[t].setEnabled(!1);for(t=0;t<this.explosions.length;++t)this.explosions[t].setEnabled(!1)},resizeWindow:function(){this.overlayCanvas.width=this.sceneryCanvas.width=window.innerWidth,this.overlayCanvas.height=this.sceneryCanvas.height=window.innerHeight,this.overlayCanvas.style.width=this.sceneryCanvas.style.width=window.innerWidth+"px",this.overlayCanvas.style.height=this.sceneryCanvas.style.height=window.innerHeight+"px",this.windowLayout.playArea=[window.innerWidth,window.innerHeight],this.game.layoutChanged(this.windowLayout),this.engine.resize()},drawShadedText:function(t,e,a){this.overlayContext.shadowOffsetX=-1,this.overlayContext.shadowOffsetY=-1,this.overlayContext.fillText(t,e,a),this.overlayContext.shadowOffsetX=2,this.overlayContext.shadowOffsetY=2,this.overlayContext.fillText(t,e,a)},outlineText:function(t,e,a,s){this.overlayContext.font=Math.ceil(s)+"px cursive",this.overlayContext.strokeText(t,e,a),this.overlayContext.fillText(t,e,a)},drawMessage:function(){this.overlayContext.save(),this.overlayContext.fillStyle="hsl("+[240,240,0,0,0,240,120,120,120][1+this.world.gameCondition]+","+Math.round(50+50*Math.cos(this.frameCount/20))+"%,50%)",this.overlayContext.strokeStyle="#aaa",this.overlayContext.lineWidth=6,this.overlayContext.textAlign="center",this.outlineText(this.messageLine1[1+this.world.gameCondition],this.overlayCanvas.width>>1,.45*this.overlayCanvas.height,.06*this.overlayCanvas.height),this.overlayContext.lineWidth=2,this.overlayContext.fillStyle="#ccc",this.overlayContext.strokeStyle="#666";var t="";4<this.world.gameCondition&&(t=" after "+Math.floor(this.world.timer/25)+" seconds"),this.outlineText(this.messageLine2[1+this.world.gameCondition]+t,this.overlayCanvas.width>>1,.55*this.overlayCanvas.height,.03*this.overlayCanvas.height),this.overlayContext.restore()},drawMain:function(){this.scene&&(this.updateSceneGraph(),this.scene.render()),this.overlayContext.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height),this.drawStatus(),++this.frameCount},drawPlayfield:function(){this.overlayContext.save(),this.overlayContext.translate(-64,-64),this.overlayContext.scale(.5,.5),this.overlayContext.fillStyle="#040",this.overlayContext.fillRect(128,128,512,512),this.overlayContext.lineWidth="1px";for(var t=0;t<this.world.beacons.length;++t){var e=3&t,a=t>>2;this.overlayContext.fillStyle=["#888","#0ff","#4f4","#f0f","#fa2"][1+this.world.beacons[t]],this.overlayContext.fillRect(192+128*e-6,576-128*a-6,12,12)}for(t=0;t<this.world.playerData.length;++t)e=this.world.playerData[t],this.overlayContext.save(),this.overlayContext.translate(128+2*e.x,640-2*e.z),this.overlayContext.rotate(-e.dir),this.overlayContext.strokeStyle=this.playerColor[t],this.overlayContext.strokeRect(-20,-15,40,30),this.overlayContext.rotate(-e.aimY+e.dir),this.overlayContext.beginPath(),this.overlayContext.moveTo(0,0),this.overlayContext.lineTo(25,0),this.overlayContext.stroke(),this.overlayContext.restore();for(t=0;t<this.world.shells.length;++t)a=this.world.shells[t],this.overlayContext.fillStyle="#ff7",e=1+a.y/10,this.overlayContext.fillRect(128+2*a.x-e,640-2*a.z-e,2*e,2*e);for(t=0;t<this.world.crates.length;++t)a=this.world.crates[t],this.overlayContext.fillStyle="#a52",e=2+a.y/10,this.overlayContext.fillRect(128+2*a.x-e,640-2*a.z-e,2*e,2*e);for(t=0;t<this.world.explosions.length;++t)e=this.world.explosions[t],a=this.world.timer-e.t0,this.explosions[t].material.diffuseColor=new BABYLON.Color3(1,13>a?1:2-a/13,1-a/25),this.overlayContext.fillStyle="rgb(255,"+(25>a?255:500-20*a)+","+(255-10*a)+")",this.overlayContext.beginPath(),this.overlayContext.arc(128+2*e.x,640-2*e.z,a/25*e.range,0,2*Math.PI),this.overlayContext.fill();this.overlayContext.restore()},updateSceneGraph:function(){for(var t=0;t<this.world.playerData.length;++t){var e=this.world.playerData[t];this.tankParent[t].position.x=e.x,this.tankParent[t].position.y=e.y+.5,this.tankParent[t].position.z=e.z,this.tank[t].rotation.y=-e.dir,this.turret[t].rotation.y=-e.aimY,this.cannon[t].rotation.z=e.aimH}for(t=0;t<this.world.beacons.length;++t)if(-1<(e=this.world.beacons[t])){this.beacon[t].material.emissiveColor=this.playerColors[e];for(var a=0;5>a;++a){var s=(a+this.world.timer%80/16)%5;this.beaconBeam[t][a].setEnabled(!0),this.beaconBeam[t][a].position.y=5*s,this.beaconBeam[t][a].scaling=new BABYLON.Vector3(5+3*s,5+3*s,5+3*s),this.beaconBeam[t][a].material.diffuseColor=this.playerColors[e],this.beaconBeam[t][a].material.alpha=1-s/5}}for(t=0;t<this.world.shells.length;++t)e=this.world.shells[t],t>=this.shells.length?(this.shells.push(BABYLON.MeshBuilder.CreateSphere("shell"+t,{diameter:1},this.scene)),a=new BABYLON.StandardMaterial("shellMat",this.scene),this.shells[t].material=a):this.shells[t].setEnabled(!0),this.shells[t].material.diffuseColor=16&e.timer?new BABYLON.Color3(1,0,0):new BABYLON.Color3(.2,.2,.2),this.shells[t].position.x=e.x,this.shells[t].position.y=e.y,this.shells[t].position.z=e.z;for(t=this.world.shells.length;t<this.shells.length;++t)this.shells[t].setEnabled(!1);for(t=0;t<this.world.crates.length;++t)e=this.world.crates[t],t>=this.crates.length?(this.crates.push(BABYLON.MeshBuilder.CreateBox("crate"+t,{size:4},this.scene)),this.crates[t].material=this.crateMaterial):this.crates[t].setEnabled(!0),this.crates[t].position.x=e.x,this.crates[t].position.y=e.y,this.crates[t].position.z=e.z;for(t=this.world.crates.length;t<this.crates.length;++t)this.crates[t].setEnabled(!1);for(a=!1,t=0;t<this.world.explosions.length;++t){e=this.world.explosions[t],t>=this.explosions.length?(this.explosions.push(BABYLON.MeshBuilder.CreateSphere("explosion"+t,{diameter:1},this.scene)),s=new BABYLON.StandardMaterial("explosionMat",this.scene),this.explosions[t].material=s):this.explosions[t].setEnabled(!0),this.explosions[t].position.x=e.x,this.explosions[t].position.y=e.y,this.explosions[t].position.z=e.z,s=this.world.timer-e.t0;var o=e.range*(.15+Math.sqrt(s/25));this.explosions[t].scaling=new BABYLON.Vector3(o,o,o),this.explosions[t].material.diffuseColor=new BABYLON.Color3(1,13>s?1:2-s/13,1-s/25),this.explosions[t].material.alpha=13>s?1:2-s/13;var i=e.y-this.world.landscapeHeightAtFloat(e.x,e.z);i<o&&(a=Math.sqrt(o*o-i*i),this.groundTextureContext.fillStyle="rgba(0,0,0,.05)",this.groundTextureContext.beginPath(),this.groundTextureContext.arc(4*e.x,1024-4*e.z,4*a,0,2*Math.PI),this.groundTextureContext.fill(),a=!0),this.expLight.setEnabled(!0),this.expLight.position.x=e.x,this.expLight.position.y=e.y+o+10,this.expLight.position.z=e.z,this.expLight.intensity=.5*Math.sqrt(e.range)*(1-Math.sqrt(s/25))}for(t=this.world.explosions.length;t<this.explosions.length;++t)this.explosions[t].setEnabled(!1);a&&this.groundTexture.update(),1>this.world.explosions.length&&this.expLight.setEnabled(!1),e=this.world.playerData[this.world.playerId],this.world.useDroneView?(this.camera.position.x=e.droneX,this.camera.position.y=e.droneY,this.camera.position.z=e.droneZ,this.camera.setTarget(new BABYLON.Vector3(this.camera.position.x,0,this.camera.position.z)),this.vrHelper.currentVRCamera.position.x=e.droneX,this.vrHelper.currentVRCamera.position.y=e.droneY,this.vrHelper.currentVRCamera.position.z=e.droneZ,this.vrHelper.currentVRCamera.setTarget(new BABYLON.Vector3(this.camera.position.x,0,this.camera.position.z))):(t=Math.PI/2-e.aimY,this.camera.position.x=e.x-20*Math.sin(t),this.camera.position.y=e.y+12,this.camera.position.z=e.z-20*Math.cos(t),this.camera.rotation.x=.2,this.camera.rotation.y=t,this.camera.rotation.z=0,this.vrHelper.currentVRCamera.position.x=e.x-20*Math.sin(t),this.vrHelper.currentVRCamera.position.y=e.y+12,this.vrHelper.currentVRCamera.position.z=e.z-20*Math.cos(t))},drawStatus:function(){var t=this.windowLayout.playArea[0]-220;this.overlayContext.fillStyle="rgba(0,0,0,.25)",this.overlayContext.fillRect(t-20,0,240,240);var e=this.world.playerData[this.world.playerId];this.overlayContext.strokeStyle="#fff",this.overlayContext.strokeRect(t,20,200,16),this.overlayContext.fillStyle="#08c",this.overlayContext.fillRect(t,20,2*this.world.playerData[this.world.playerId].hp,16),this.overlayContext.fillStyle="#fff",this.overlayContext.fillText("A r m o r",t+40,32),this.overlayContext.strokeRect(t,40,200,16),e.reload&&(this.overlayContext.fillStyle="#fc0",this.overlayContext.fillRect(t,40,4*this.world.playerData[this.world.playerId].reload,16),this.overlayContext.fillStyle="#fff",this.overlayContext.fillText("Reloading",t+40,52)),this.overlayContext.fillText("Q/D : Turn left/right",t,72),this.overlayContext.fillText("Z/S : Accelerate fwd/back",t,92),-1>e.droneY?(this.overlayContext.fillStyle="#777",this.overlayContext.fillText("Space : drone expended",t,112),this.overlayContext.fillStyle="#fff"):this.overlayContext.fillText("Space : "+(0==e.droneX?"Launch drone":this.world.useDroneView?"Main view":"Drone view"),t,112),this.overlayContext.fillText("RMB : Change ordnance : ",t,132);for(var a=152,s=0;s<e.weapons.length;++s)e.weapons[s]&&(this.overlayContext.fillText(this.weaponName[s]+" : "+e.weapons[s],t+20,a),e.currentWeapon==s&&this.overlayContext.strokeRect(t,a-12,200,16),a+=20);for(this.overlayContext.fillText("Beacons",t,212),this.overlayContext.strokeStyle="#fff",this.overlayContext.strokeRect(t+56,200,144,16),t+=56,s=0;s<this.world.playerData.length;++s)this.world.playerData[s].beacons&&(this.overlayContext.fillStyle=this.playerColor[s],this.overlayContext.fillRect(t,200,9*this.world.playerData[s].beacons,16),this.overlayContext.fillStyle="#000",this.overlayContext.textAlign="center",this.overlayContext.fillText(this.world.playerData[s].beacons,t+4.5*this.world.playerData[s].beacons,212),t+=9*this.world.playerData[s].beacons);this.overlayContext.textAlign="left",this.overlayContext.save(),this.overlayContext.fillStyle="#aaa",this.overlayContext.strokeStyle="#558",this.overlayContext.textAlign="center",-50>=this.world.timer?s="":0>this.world.timer?s="Get ready !":25>this.world.timer?s="Go !":(s=Math.floor((3e3-this.world.timer)/25)%60,s=Math.floor((3e3-this.world.timer)/1500)+":"+(10>s?"0":"")+s),this.outlineText(s,this.overlayCanvas.width/2,40,32),50>(s=this.world.timer-this.world.messageTimer)&&(this.overlayContext.fillStyle="rgba(205, 128, 52, "+(1-s/50)+")",this.overlayContext.strokeStyle="rgba(41, 25, 10, "+(1-s/50)+")",this.outlineText(this.world.message,this.overlayCanvas.width/2,this.overlayCanvas.height/2-50-s,32)),this.overlayContext.fillStyle="#aaa",this.overlayContext.strokeStyle="#558",this.overlayContext.restore()}},World.prototype={initialize:function(){this.playerData=[{x:44,y:0,z:44,speed:0,dir:Math.PI/4,aimH:Math.PI/4,aimY:Math.PI/4,droneX:0,droneY:0,droneZ:0,droneSX:0,droneSY:0,droneSZ:0,weapons:[20,0,0,0],currentWeapon:0,beacons:0,reload:0,hp:100},{x:212,y:0,z:44,speed:0,dir:3*Math.PI/4,aimH:Math.PI/4,aimY:3*Math.PI/4,droneX:0,droneY:0,droneZ:0,droneSX:0,droneSY:0,droneSZ:0,weapons:[20,0,0,0],currentWeapon:0,beacons:0,reload:0,hp:100},{x:212,y:0,z:212,speed:0,dir:-3*Math.PI/4,aimH:Math.PI/4,aimY:-3*Math.PI/4,droneX:0,droneY:0,droneZ:0,droneSX:0,droneSY:0,droneSZ:0,weapons:[20,0,0,0],currentWeapon:0,beacons:0,reload:0,hp:100},{x:44,y:0,z:212,speed:0,dir:-Math.PI/4,aimH:Math.PI/4,aimY:-Math.PI/4,droneX:0,droneY:0,droneZ:0,droneSX:0,droneSY:0,droneSZ:0,weapons:[20,0,0,0],currentWeapon:0,beacons:0,reload:0,hp:100}],this.timer=-50,this.shells=[],this.beacons=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.crates=[],this.explosions=[],this.useDroneView=!1,this.gameCondition=-1},loadLevel:function(){this.seed=.1,this.ground=[];for(var t=0;256>t;++t)for(var e=0;256>e;++e)this.ground.push(0);for(this.performDiamondSquareStep(0,0,256,30),t=0;256>t;++t)for(e=0;256>e;++e){var a=Math.min(e,t,256-e,256-t)+2*Math.sin((e+t)/5);16>a&&this.setLandscapeHeightAt(e,t,Math.max(this.landscapeHeightAt(e,t),10-10*Math.cos((16-a)*Math.PI/10)))}for(t=0;4>t;++t)this.playerData[t].y=this.landscapeHeightAt(this.playerData[t].x,this.playerData[t].z)},landscapeHeightAtFloat:function(t,e){var a=Math.floor(t),s=Math.floor(e),o=t-a,i=e-s;return(1-o)*((1-i)*this.landscapeHeightAt(a,s)+i*this.landscapeHeightAt(a,s+1))+o*((1-i)*this.landscapeHeightAt(a+1,s)+i*this.landscapeHeightAt(a+1,s+1))},landscapeHeightAt:function(t,e){return this.ground[((255&e)<<8)+(255&t)]},setLandscapeHeightAt:function(t,e,a){this.ground[((255&e)<<8)+(255&t)]=a},controlledRandom:function(){return this.seed=3.9*this.seed*(1-this.seed)},performDiamondSquareStep:function(t,e,a,s){var o=this.landscapeHeightAt(t,e),i=this.landscapeHeightAt(t+a,e),n=this.landscapeHeightAt(t,e+a),r=this.landscapeHeightAt(t+a,e+a);(33>t+(a>>=1)||223<t)&&(33>e+a||223<e)&&(s=0);var h=this.landscapeHeightAt(t+a,e);0==h&&this.setLandscapeHeightAt(t+a,e,h=.5*(o+i)+s*(this.controlledRandom()-.5));var l=this.landscapeHeightAt(t,e+a);0==l&&this.setLandscapeHeightAt(t,e+a,l=.5*(o+n)+s*(this.controlledRandom()-.5)),0==(o=this.landscapeHeightAt(t+2*a,e+a))&&this.setLandscapeHeightAt(t+2*a,e+a,o=.5*(i+r)+s*(this.controlledRandom()-.5)),0==(i=this.landscapeHeightAt(t+a,e+2*a))&&this.setLandscapeHeightAt(t+a,e+2*a,i=.5*(n+r)+s*(this.controlledRandom()-.5)),0==this.landscapeHeightAt(t+a,e+a)&&this.setLandscapeHeightAt(t+a,e+a,.25*(h+l+o+i)+s*(this.controlledRandom()-.5)),1<a&&(s*=.5,this.performDiamondSquareStep(t,e,a,s),this.performDiamondSquareStep(t+a,e,a,s),this.performDiamondSquareStep(t,e+a,a,s),this.performDiamondSquareStep(t+a,e+a,a,s))},startNewGame:function(){this.initialize(),this.gameCondition=0,this.loadLevel()},initiateExplosion:function(t,e,a,s,o){this.explosions.push({x:t,y:e,z:a,range:s,t0:this.timer});for(var i=0;i<this.playerData.length;++i){var n=this.playerData[i],r=Math.pow(n.x-t,2)+Math.pow(n.y+3-e,2)+Math.pow(n.z-a,2);r<s*s&&(n.hp=Math.max(0,n.hp-o*(1-Math.sqrt(r)/s)),0==i&&.01>n.hp&&(this.gameCondition=1))}},playerShoots:function(t){if(0<(t=this.playerData[t]).weapons[t.currentWeapon]&&(t.reload=50,this.shells.push({type:t.currentWeapon,timer:0,x:t.x+Math.cos(t.aimY)*Math.cos(t.aimH)*10,y:t.y+5+10*Math.sin(t.aimH),z:t.z+Math.sin(t.aimY)*Math.cos(t.aimH)*10,dx:Math.cos(t.aimY)*Math.cos(t.aimH)*3,dy:3*Math.sin(t.aimH),dz:Math.sin(t.aimY)*Math.cos(t.aimH)*3}),--t.weapons[t.currentWeapon],0==t.weapons[t.currentWeapon])){for(var e=0;4>e&&!t.weapons[e];++e);t.currentWeapon=3&e}},dropCrate:function(){for(var t=0,e=0,a=0,s=0;s<this.beacons.length;++s)-1<this.beacons[s]&&(t+=32+64*(3&s),e+=32+64*(s>>2),++a);a&&(t=Math.max(8,Math.min(248,t/a+64*this.controlledRandom()-32)),e=Math.max(8,Math.min(248,e/a+64*this.controlledRandom()-32)),a=Math.floor(4*this.controlledRandom()),this.crates.push({x:t,y:100,z:e,onGround:!1,speedY:0,shellType:a,shellCount:[20,5,5,5][a],groundY:2+Math.min(this.landscapeHeightAtFloat(t-2,e-2),this.landscapeHeightAtFloat(t+1,e-2),this.landscapeHeightAtFloat(t-2,e+2),this.landscapeHeightAtFloat(t+1,e+2))}))},detectCollisions:function(t){for(var e=this.playerData[t],a=[[2.5,3.5],[0,3.5],[-2.5,3.5],[-2.5,0],[-2.5,-3.5],[0,-3.5],[2.5,-3.5],[2.5,0]],s=["Armor piercing","Explosive","Splitter","Delay-action"],o=0;8>o;++o){var i=e.x+e.speed*Math.cos(e.dir)+a[o][0]*Math.cos(e.dir)-a[o][1]*Math.sin(e.dir),n=e.z+e.speed*Math.sin(e.dir)+a[o][0]*Math.sin(e.dir)+a[o][1]*Math.cos(e.dir),r=e.y;(10>i||246<i||10>n||246<n)&&(e.speed=0);for(var h=0;h<this.crates.length;++h){var l=this.crates[h];i>l.x-2-.5&&i<l.x+2+.5&&n>l.z-2-.5&&n<l.z+2+.5&&r>l.y-6&&(e.weapons[l.shellType]+=l.shellCount,1>e.weapons[e.currentWeapon]&&(e.currentWeapon=l.shellType),t==this.playerId&&(this.message="+"+l.shellCount+" "+s[l.shellType]+" shells",this.messageTimer=this.timer),this.crates.splice(h,1),--h)}for(h=0;4>h;++h)if(h!=t){var c=this.playerData[h];l=Math.cos(c.dir)*(i-c.x)+Math.sin(c.dir)*(n-c.z);var d=-Math.sin(c.dir)*(i-c.x)+Math.cos(c.dir)*(n-c.z);-3.5<l&&3.5>l&&-2.5<d&&2.5>d&&(e.speed=0,c.speed=0)}}for(h=0;h<this.shells.length;++h)t=this.shells[h],l=Math.cos(e.dir)*(t.x-e.x)+Math.sin(e.dir)*(t.z-e.z),d=-Math.sin(e.dir)*(t.x-e.x)+Math.cos(e.dir)*(t.z-e.z),-3.5<l&&3.5>l&&-2.5<d&&2.5>d&&r>t.y-6&&(this.initiateExplosion(t.x,t.y,t.z,[10,20,10,13][t.type],[30,60,30,40][t.type]),this.shells.splice(h,1),--h)},animateItems:function(){if(++this.timer,!(0>this.timer)){2999<this.timer&&(this.gameCondition=3);for(var t=!1,e=1;e<this.playerData.length;++e).01<this.playerData[e].hp&&(this.aiPlayers[e-1].playOneFrame(this),t=!0);for(t||(this.gameCondition=5),e=0;e<this.playerData.length;++e)this.detectCollisions(e),this.playerData[e].x+=this.playerData[e].speed*Math.cos(this.playerData[e].dir),this.playerData[e].z+=this.playerData[e].speed*Math.sin(this.playerData[e].dir),this.playerData[e].y=this.landscapeHeightAtFloat(this.playerData[e].x,this.playerData[e].z),0<this.playerData[e].droneY&&(this.playerData[e].droneX+=this.playerData[e].droneSX,this.playerData[e].droneY+=this.playerData[e].droneSY,this.playerData[e].droneZ+=this.playerData[e].droneSZ,this.playerData[e].droneSY-=0>this.playerData[e].droneSY?.001:.01,this.playerData[e].droneY<this.landscapeHeightAtFloat(this.playerData[e].droneX,this.playerData[e].droneZ)&&(this.playerData[e].droneY=-2,this.useDroneView=!1)),this.playerData[e].speed*=.95,.01>Math.abs(this.playerData[e].speed)&&(this.playerData[e].speed=0),this.playerData[e].reload=Math.max(this.playerData[e].reload-1,0);for(e=0;e<this.playerData.length;++e)if(t=(this.playerData[e].z+35)%64,6>(this.playerData[e].x+35)%64&&6>t){t=Math.floor(this.playerData[e].x/64);var a=Math.floor(this.playerData[e].z/64),s=this.beacons[t+4*a];0<=s&&--this.playerData[s].beacons,this.beacons[t+4*a]=e,++this.playerData[e].beacons,7<this.playerData[e].beacons&&(this.gameCondition=0==e?6:2)}for(e=0;e<this.shells.length;++e)if((t=this.shells[e]).timer)--t.timer,0==t.timer&&(this.initiateExplosion(t.x,t.y,t.z,[6,12,6,8][t.type],[30,60,30,40][t.type]),this.shells.splice(e,1),--e);else{if(t.x+=t.dx,t.y+=t.dy,t.z+=t.dz,t.dy-=.05,2==t.type&&-.3>t.dy){for(a=0;6>a;++a)this.shells.push({type:0,timer:0,x:t.x,y:t.y,z:t.z,dx:t.dx+Math.cos(a*Math.PI/3),dy:t.dy,dz:t.dz+Math.sin(a*Math.PI/3)});this.shells.splice(e,1),--e}t.y<this.landscapeHeightAtFloat(t.x,t.z)&&(3==t.type?(t.dx=t.dy=t.dz=0,t.y=this.landscapeHeightAtFloat(t.x,t.z),t.timer=125):(this.initiateExplosion(t.x,t.y,t.z,[5,10,5,5][t.type],[30,60,30,30][t.type]),this.shells.splice(e,1),--e))}for(e=0;e<this.shells.length;++e){for(t=this.shells[e],s=[],a=0;a<this.crates.length;++a){var o=this.crates[a];t.x>o.x-2.5&&t.x<o.x+2.5&&t.y>o.y-2.5&&t.y<o.y+2.5&&t.z>o.z-2.5&&t.z<o.z+2.5&&s.unshift(a)}if(s.length){for(a=0;a<s.length;++a)this.crates.splice(s[a],1);this.initiateExplosion(t.x,t.y,t.z,25,120),this.shells.splice(e,1),--e}}for(e=0;e<this.crates.length;++e)this.crates[e].hitGround||(this.crates[e].y<20+this.crates[e].groundY&&(this.crates[e].speedY*=.95),this.crates[e].speedY-=.01,this.crates[e].y+=this.crates[e].speedY,this.crates[e].y<this.crates[e].groundY&&(this.crates[e].hitGround=!0,this.crates[e].y=this.crates[e].groundY));for(0==this.timer%500&&this.dropCrate(),e=0;e<this.explosions.length;++e)25<this.timer-this.explosions[e].t0&&(this.explosions.splice(e,1),--e)}},processControls:function(){var t=this.playerData[this.playerId];if(t.dir+=(this.controls.customKeyStatus[1]?.1:0)+(this.controls.customKeyStatus[3]?-.1:0),t.speed=Math.min(1,Math.max(-1,t.speed+(this.controls.customKeyStatus[0]?.1:0)-(this.controls.customKeyStatus[2]?.1:0))),t.aimY=t.dir+Math.PI*(1-2*this.controls.worldDX),t.aimH=.7*(1-this.controls.worldDY),this.controls.leftMouseButton&&!t.reload&&(this.controls.acknowledgeLeftMouseClick(),this.playerShoots(this.playerId)),this.controls.rightMouseButton){if(1>t.weapons[0]+t.weapons[1]+t.weapons[2]+t.weapons[3])t.currentWeapon=0;else for(t.currentWeapon=t.currentWeapon+1&3;0==t.weapons[t.currentWeapon];)t.currentWeapon=t.currentWeapon+1&3;this.controls.acknowledgeRightMouseClick()}this.controls.customKeyStatus[4]&&-1<t.droneY&&(this.controls.customKeyStatus[4]=!1,(this.useDroneView=!this.useDroneView)&&0==t.droneX&&(t.droneX=t.x,t.droneY=t.y+5,t.droneZ=t.z,t.droneSY=3)),this.controls.controlEscape&&(this.gameCondition=4,this.controls.totalClear())}},AIPlayer.prototype={playOneFrame:function(t){var e=t.playerData[this.playerId],a=Math.sqrt(Math.pow(this.moveTargetZ-e.z,2)+Math.pow(this.moveTargetX-e.x,2));for((!this.moveTargetX||0==t.timer%50||2>a)&&this.defineTarget(t),a=Math.atan2(this.moveTargetZ-e.z,this.moveTargetX-e.x)-e.dir;a<-Math.PI;)a+=2*Math.PI;for(;a>Math.PI;)a-=2*Math.PI;for(var s=Math.atan2(-this.moveTargetZ+e.z,-this.moveTargetX+e.x)-e.dir;s<-Math.PI;)s+=2*Math.PI;for(;s>Math.PI;)s-=2*Math.PI;var o=Math.abs(a)<Math.abs(s)?a:s;if(e.dir=0<o?e.dir+Math.min(.1,o):e.dir+Math.max(-.1,o),a=.1<Math.abs(o)?0:Math.abs(a)<Math.abs(s)?1:-1,e.speed=a>e.speed?Math.min(1,a,e.speed+.1):Math.max(-1,a,e.speed-.1),a=t.playerData[this.shootTarget].x,s=t.playerData[this.shootTarget].z,o=Math.atan2(s-e.z,a-e.x),e.aimY=o>e.aimY?Math.min(e.aimY+.1,o):Math.max(e.aimY-.1,o),a=Math.sqrt(Math.pow(s-e.z,2)+Math.pow(a-e.x,2)),1>e.reload&&500>a){for(a=0;4>a;++a)0<e.weapons[a]&&(e.currentWeapon=a);t.playerShoots(this.playerId)}},timeToTarget:function(t,e,a){return e-=t.playerData[this.playerId].x,t=a-t.playerData[this.playerId].z,10*Math.min(Math.abs(Math.atan2(t,e)),Math.abs(Math.atan2(-t,-e)))+1.1*Math.sqrt(e*e+t*t)},distanceFromNearestOpponent:function(t,e,a){for(var s=9999,o=0;4>o;++o)if(o!=this.playerId){var i=e-t.playerData[o].x,n=a-t.playerData[o].z;s=Math.min(s,Math.sqrt(i*i+n*n))}return s},defineTarget:function(t){for(var e=9999,a=0;16>a;++a){var s=32+64*(3&a),o=32+64*(a>>2);if(t.beacons[a]!=this.playerId){var i=this.timeToTarget(t,s,o),n=this.distanceFromNearestOpponent(t,s,o);(i-=.5*(n*=1+1/n))<e&&(this.moveTargetX=s,this.moveTargetZ=o,e=i)}}for(a=0;a<t.crates.length;++a)i=this.timeToTarget(t,t.crates[a].x,t.crates[a].z),n=this.distanceFromNearestOpponent(t,t.crates[a].x,t.crates[a].z),(i-=.5*(n*=1+1/n))<e&&(this.moveTargetX=t.crates[a].x,this.moveTargetZ=t.crates[a].z,e=i);for(e=0,s=1==this.playerId,a=1;4>a;++a){var r=(this.playerId+a)%4;o=t.playerData[r].hp,s&&(o=120-o),o>e&&101>o&&(this.shootTarget=r,e=o)}for(e=Math.pow(t.playerData[r].x-t.playerData[this.playerId].x,2)+Math.pow(t.playerData[r].z-t.playerData[this.playerId].z,2),s=this.shootTarget,o=e,a=1;4>a;++a)r=(this.playerId+a)%4,(i=Math.pow(t.playerData[r].x-t.playerData[this.playerId].x,2)+Math.pow(t.playerData[r].z-t.playerData[this.playerId].z,2))<o&&(o=i,s=r);4*o<e&&(this.shootTarget=s)}},Controls.prototype={totalClear:function(){this.controlEscape=this.controlFire=this.controlDown=this.controlUp=this.rightMouseButton=this.leftMouseButton=!1,this.customKeyStatus=[!1,!1,!1,!1,!1]},onKeyUp:function(t){return!this.keyControl(t,!1)},onKeyDown:function(t){return!this.keyControl(t,!0)},redefineCustomKey:function(t,e){var a=this.persistentData.data.keys[t];return this.persistentData.setKey(t,e),a},keyControl:function(t,e){var a=!0,s=window.event?window.event.keyCode:t.which;switch(s){case 38:this.controlUp=e;break;case 40:this.controlDown=e;break;case 32:case 13:this.controlFire=e;break;case 27:case 80:this.controlEscape=e;break;case 87:this.customKeyStatus[0]=e;break;case 65:this.customKeyStatus[1]=e;break;default:a=!1}for(var o=0;6>o;++o)s==this.persistentData.data.keys[o]&&(this.customKeyStatus[o]=e,a=!0);return a},onMouseUp:function(t){return this.rightMouseButton=this.leftMouseButton=!1,!0},onMouseDown:function(t){return 1&t.buttons&&(this.leftMouseButton=!0),2&t.buttons&&(this.rightMouseButton=!0),!0},onTouchStart:function(t){return this.onMouseMove(t),this.onMouseDown(t)},onTouchEnd:function(t){return t.preventDefault(),this.onMouseUp(t)},onTouchMove:function(t){return t.preventDefault(),this.onMouseMove(t)},onVRTrigger:function(t){event={buttons:1},t.value?this.onMouseDown(event):this.onMouseUp(event)},onVRMainButton:function(t){event={buttons:2},t.value?this.onMouseDown(event):this.onMouseUp(event)},onVRSecondaryButton:function(t){this.customKeyStatus[4]=!!t.value},onVRThumbStick:function(t){this.customKeyStatus[0]=.1<t.y,this.customKeyStatus[1]=-.1>t.x,this.customKeyStatus[2]=-.1>t.y,this.customKeyStatus[3]=.1<t.x},acknowledgeLeftMouseClick:function(){this.leftMouseButton=!1},acknowledgeRightMouseClick:function(){this.rightMouseButton=!1},onMouseMove:function(t){var e=0,a=0;return"changedTouches"in t&&0<t.changedTouches.length&&(e=t.changedTouches[0].clientX,a=t.changedTouches[0].clientY),"clientX"in t&&"clientY"in t&&(e=t.clientX,a=t.clientY),this.windowLayout&&(this.mouseX=e,this.mouseY=a,this.worldDX=this.mouseX/this.windowLayout.playArea[0],this.worldDY=this.mouseY/this.windowLayout.playArea[1]),!0},onLayoutChange:function(t){this.windowLayout=t}},Game.prototype={launch:function(){this.changeState(0),this.intervalId=setInterval((function(){game.mainLoop()}),40),requestAnimationFrame((function(){game.renderLoop()}))},changeState:function(t){this.controls.totalClear(),this.state=t},mainLoop:function(){0==this.state&&(this.controls.controlEscape||this.controls.controlFire||this.controls.leftMouseButton)&&(this.world.startNewGame(),this.renderer.resetSceneGraph(),this.changeState(1)),1==this.state&&(this.world.processControls(),this.world.animateItems(),0<this.world.gameCondition&&this.changeState(4==this.world.gameCondition?2:3)),2==this.state&&(this.controls.controlEscape||this.controls.controlFire)&&(this.world.gameCondition=0,this.changeState(1)),3==this.state&&(this.controls.controlEscape||this.controls.controlFire||this.controls.leftMouseButton)&&this.changeState(0)},renderLoop:function(){this.renderer.drawMain(),this.renderer.drawMessage(),requestAnimationFrame((function(){game.renderLoop()}))},setRenderer:function(t){this.renderer=t},storeData:function(){localStorage.setItem("LineOfFireData",JSON.stringify(this.persistentData))},layoutChanged:function(t){this.controls.onLayoutChange(t)}},window.addEventListener("DOMContentLoaded",main)</script>