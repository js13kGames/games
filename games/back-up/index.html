<!doctype html><script src=/2018/webxr/babylon.js></script><style>body{margin:0;overflow:hidden}#fps{position:absolute;left:20px;top:20px;color:#999;font-family:"Courier New",Courier,monospace}</style><canvas id=jj touch-action=none></canvas><div id=fps></div><script>var hl,eqSlot,selGrid,selPGrid,nonGrid,curMat,wallMat,entrMat,reflMat,selSlot,gridBackMat,heroMat,crystMat,splitterMat,splitter2Mat;can=document.getElementById("jj"),can.width=window.innerWidth,can.height=window.innerHeight,engine=new BABYLON.Engine(can,!0),FONT="Consolas",GRIDSIZE=8,GRIDWID=30/GRIDSIZE,DELTIME=30,DATABLKS=200,DEF_EYES="o",logo=[15395444,11438676,13274198,11176533,15657558],camOff=new BABYLON.Vector3(0,0,1),gameState=0,logoMaterials=[],dataMaterials=[],shakeCamera=0,actS=0,maxS=13312,dmgBuff=0,level=0,exits=[0,0],slots=[[0,0],[0,0],[0,0],[0,0],[0,0]],slotC=-1,gridPos=[],lasers=[],delet=DELTIME,mouseDown=0,gridC=-1,wantToPlace=!1,reused=0;var vojc,hero,heroEyes,VRhelper,isHero=0,heroMov=0,heroIsSpeaking=1,dialogs=[],isTalking=!1,whichSequance=0,isHighlight=-1,subSize=30,isHighMode=-1,optVoice=1,optQuality=2,optSensitiv=300,optAngle=.25*Math.PI,optAngle2=1.75*Math.PI,optCanPlace=!1,gameEnd=!1,skySeq=0,achiv=0,isGameover=!1,stopCameraShake=!1,gameStarted=!1,memoLost=0,gameWon=0;S=["Click here to start playing","Memory size","Toolbar","Reflector","Game created by @holosiek & @bthefw","Mirror","<- Options","Achievements ->","Game ->","<- Achievements","Camera shake: ","Animated logo: ","Hero animations: ","Objects animations: ","Data blocks on the back: ","Low","Medium","High","Enabled","Disabled","speechSynthesis API","Crystal","Splitter","<- Game","Options ->"],E=[["Good job!",1.5],["Very nice",.8],["Outstanding!",.8]],C=["#cacae7","#8e8ecc","#693e73","#555555","#777777","#FFFFFF"],LEVELS=[[[2294399266,1715535888],[9,9,9,6,9,9,9,9,9,9,9,9,2,9,9,9,9],[10,2]],[[201326592,536903708],[9,7,1,9,9,9,9],[10,4]],[[2172747992,2122416513],[9,9,9,9,2,4,9,9,2,4,9,9,2,4,9,7,7,7,7,7,7],[10,6]],[[304120038,543966744],[9,9,9,9,9,9,9,4,14,9,7,9,9,9,9,9,9,9,9],[10,3]],[[2416203009,58221060],[9,9,3,9,9,9,9,9,9,9,9,9,9,11,6,9,9,9],[10,6]],[[2610979967,3721063399],[1,11,10,11,11,10,10,10,10,10,10,10,10,10,11,10,13,10,11,10,10,11,11,11,10,10,10,10,10,10,10,10,11,10,11,7,11,11,11],[10,4]],[[134758400,20],[2,9,9,8,14],[10,1,12,2]],[[16896,4325376],[5,1,14,14],[12,4]],[[4294901761,33619967],[4,14,15,14,15,15,14,14,15,14,14,14,15,15,14,15,14,15,15,14,14,15,15,15,14,14,14,15,15,15,14,14,14,7],[10,1]],[[182912,100794496],[9,8,9,5,9,9,9,4,9,9],[10,4,16,1]],[[805572608,4734976],[1,11,11,9,6,10,6],[10,2,16,1]],[[24576,1048578],[1,5,8,7],[10,3,14,1,16,2]],[[16812313,10066176],[8,2,4,8,2,6,8,8,2,8,2,8,2,8,2],[10,3,16,1]],[[2164260888,2550136961],[5,5,8,6,8,6,7,7,3],[10,8,16,7]]],cubeGrid=Array(GRIDSIZE**2).fill({type:"none",destructable:!1}),tex=(e,a,t)=>new BABYLON.Color3(e,a,t),mate=(e,a,t=!1)=>{let s=new BABYLON.StandardMaterial(e,scene);return s.emissiveColor=a,s.disableLighting=t,s},vec3=(e,a,t)=>new BABYLON.Vector3(e,a,t),randS=()=>{let e=Math.random();return Math.random()<=.5?e:-e},ranRng=e=>Math.floor(Math.random()*e),copyObj=e=>JSON.parse(JSON.stringify(e)),materialCreation=()=>{for(var e=0;e<5;e++)logoMaterials.push(mate("logoMat",tex(.5+.05*e,.9+.025*e,1),!0));for(e=0;e<5;e++)dataMaterials.push(mate("dataMat",tex(.3+.05*e,.7+.05*e,1),!0));curMat=mate("curMat",tex(1,1,1),!0),eqSlot=mate("eqSlot",tex(.07,.07,.12),!0),selSlot=mate("selSlot",tex(.1,.1,.15),!0),selPGrid=mate("selPGrid",tex(.035,.12,.22),!0),selGrid=mate("selGrid",tex(.017,.06,.11),!0),(nonGrid=mate("nonGrid",tex(.02,.02,.05),!0)).alpha=.7,wallMat=mate("wallMat",tex(.6,.6,.6)),reflMat=mate("reflMat",tex(.8,.8,.8)),entrMat=mate("entrMat",tex(0,.5,1)),exitMat=mate("exitMat",tex(.5,.1,.1)),gridBackMat=mate("gridMat",tex(.07,.07,.12),!0),heroMat=mate("heroMat",tex(.862,.654,.909)),(crystMat=mate("crystMat",tex(.321,.505,.717))).alpha=.3,splitterMat=mate("splitterMat",tex(.76,.713,.039)),splitter2Mat=mate("splitterMat",tex(.5,.5,.5))},enterVR=()=>{VRhelper.webVRCamera.setTarget(vec3(0,0,0)),VRhelper.webVRCamera.fov=.2},leaveVR=()=>{VRhelper.deviceOrientationCamera.setTarget(vec3(0,0,0))},removeDataBlocks=()=>{var e=[];scene.meshes.forEach((a=>{/data[0-9]+/.test(a.name)&&e.push(a)})),e.forEach((e=>{e.dispose()}))},createDataBlocks=()=>{var e=BABYLON.MeshBuilder.CreatePlane("data",{sideOrientation:1},scene);e.material=dataMaterials[ranRng(5)],e.scaling.x=3,e.isPickable=!1,e.isVisible=!1;for(var a=0;a<DATABLKS;a++){var t=e.createInstance("data"+a);gameState>1?t.position=vec3(1.4*(100*Math.random()-50),1.4*(30*Math.random()-13),-100):t.position=vec3(100*Math.random()-50,30*Math.random()-13,-60-5*Math.random())}},createScene=()=>{scene=new BABYLON.Scene(engine),scene.constantlyUpdateMeshUnderPointer=!0,scene.fogMode=3,scene.fogStart=50,scene.fogEnd=75,scene.clearColor=tex(.05,.05,.1),g_light=new BABYLON.PointLight("light",camOff,scene),g_light.intensity=.17,hl=new BABYLON.HighlightLayer("hl1",scene);var e=BABYLON.VRCameraMetrics.GetDefault();e.postProcessScaleFactor=1,(VRhelper=scene.createDefaultVRExperience({vrDeviceOrientationCameraMetrics:e})).onEnteringVRObservable.add((()=>{enterVR()})),VRhelper.onExitingVRObservable.add((()=>{leaveVR()})),VRhelper.deviceOrientationCamera.inertia=0,VRhelper.deviceOrientationCamera.position=camOff,VRhelper.deviceOrientationCamera.angularSensibility=optSensitiv,VRhelper.deviceOrientationCamera.attachControl(can,!0),VRhelper.deviceOrientationCamera.inputs.remove(VRhelper.deviceOrientationCamera.inputs.attached.keyboard),VRhelper.webVRCamera.inertia=0,VRhelper.webVRCamera.position=camOff,VRhelper.webVRCamera.angularSensibility=optSensitiv,VRhelper.webVRCamera.attachControl(can,!0),VRhelper.webVRCamera.inputs.remove(VRhelper.webVRCamera.inputs.attached.keyboard),VRhelper.teleportationEnabled=!1,materialCreation(),createDataBlocks();var a=BABYLON.MeshBuilder.CreateBox("cursor",{},scene);a.scaling=vec3(.01,.01,.01),a.position=vec3(0,0,2),a.material=curMat,a.isPickable=!1,drawText("subs","",C[5],40,vec3(0,-7,18),0,subSize),scene.getMeshByName("subs").isPickable=!1,new BABYLON.GlowLayer("",scene).customEmissiveColorSelector=(e,a,t,s)=>{"laserLines"==e.name?s.set(0,.5,1,1):s.set(0,0,0,0)},scene.onBeforeCameraRenderObservable.add((e=>{scene.getMeshByName("subs").parent=e,scene.getMeshByName("cursor").parent=e})),leaveVR()};var a=new Audio("click.wav");a.volume=.5,playClick=()=>{a.play()},saveAchiv=()=>{localStorage.setItem("BACKUPachiv",achiv)},gameFirewalled=()=>{for(var e=scene.meshes.length-1;e>=0;e--){let a=scene.meshes[e];("gridBack"==a.name||/gridZ[0-9]+/.test(a.name)||"toolbarLabel"==a.name||/slotT[0-9]+/.test(a.name)||/slotS[0-9]+/.test(a.name)||/slot[0-9]+/.test(a.name)||"logo"==a.name||"hero"==a.name||"heroEyes"==a.name)&&a.dispose()}for(e=0;e<dataMaterials.length;e++)dataMaterials[e].alpha=.25;createLogo(!0),drawText("gameEnd1","System detected memory changes!",C[5],24,vec3(0,-2,-40),Math.PI),drawText("gameEnd12","Virus has been deleted",C[5],24,vec3(0,-3.5,-40),Math.PI),drawText("gameEnd13","Thank you for playing :3",C[5],24,vec3(0,-5.5,-40),Math.PI,40),drawText("gameoverLabel3","Click here to restart game",C[5],24,vec3(0,-7,-40),Math.PI,40)},gameClearIt=()=>{for(var e=scene.meshes.length-1;e>=0;e--){let a=scene.meshes[e];("gridBack"==a.name||/gridZ[0-9]+/.test(a.name)||"toolbarLabel"==a.name||/slotT[0-9]+/.test(a.name)||/slotS[0-9]+/.test(a.name)||/slot[0-9]+/.test(a.name)||"logo"==a.name)&&a.dispose()}for(e=0;e<dataMaterials.length;e++)dataMaterials[e].alpha=.25;createLogo(!0),drawText("gameEnd2","System hacked - Impossible to recover data",C[5],24,vec3(0,-2,-40),Math.PI),drawText("gameEnd22","Message found: #@1_Thanzz#U%<3!",C[5],24,vec3(0,-3.5,-40),Math.PI),drawText("gameEnd23","Thank you for playing <3",C[5],24,vec3(0,-5.5,-40),Math.PI,40),drawText("gameoverLabel3","Click here to restart game",C[5],24,vec3(0,-7,-40),Math.PI,40)},gameCrash=()=>{let e=0;scene.clearColor.r-.005>=0?scene.clearColor.r-=.005:e++,scene.clearColor.g-.005>=0?scene.clearColor.g-=.005:e++,scene.clearColor.b-.005>=0?scene.clearColor.b-=.005:e++,3!=e?setTimeout((()=>{gameCrash()}),10):1==gameWon&&(gameEnd=1)},skyWhite=()=>{let e=0;scene.fogStart-.25>=5?scene.fogStart-=.25:e++,scene.fogEnd-.25>=5?scene.fogEnd-=.25:e++,scene.fogColor.r+.005<=1?scene.fogColor.r+=.005:e++,scene.fogColor.g+.005<=1?scene.fogColor.g+=.005:e++,scene.fogColor.b+.005<=1?scene.fogColor.b+=.005:e++,scene.clearColor.r+.005<=1?scene.clearColor.r+=.005:e++,scene.clearColor.g+.005<=1?scene.clearColor.g+=.005:e++,scene.clearColor.b+.005<=1?scene.clearColor.b+=.005:e++,8!=e?setTimeout((()=>{skyWhite()}),10):(1==gameWon?gameClearIt():gameFirewalled(),gameCrash())},fogGG=()=>{scene.fogStart>5?(scene.fogEnd-=.25,scene.fogStart-=.25,scene.fogColor.r-.01>=0&&(scene.fogColor.r-=.01),scene.fogColor.g-.01>=0&&(scene.fogColor.g-=.01),scene.fogColor.b-.01>=0&&(scene.fogColor.b-=.01),scene.clearColor.r-.01>=0&&(scene.clearColor.r-=.01),scene.clearColor.g-.01>=0&&(scene.clearColor.g-=.01),scene.clearColor.b-.01>=0&&(scene.clearColor.b-=.01),setTimeout((()=>{fogGG()}),10)):(stopCameraShake=!0,drawText("gameoverLabel","Out of memory - system shotdown",C[5],24,vec3(0,-2,-20),Math.PI,30),drawText("gameoverLabel2","GAME OVER","#ff0000",24,vec3(0,-3,-20),Math.PI,40),drawText("gameoverLabel3","Click here to restart game",C[5],24,vec3(0,-4,-20),Math.PI))},skipDialog=()=>{window.speechSynthesis.cancel(),changeText("subs","",40,C[5],subSize),heroIsSpeaking=1,dialogs=[],checkIfEnd()},checkIfEnd=()=>{dialogs.length||(whichSequance%2&&whichSequance&&whichSequance++,changeEyes(DEF_EYES,DEF_EYES),endDialog())},setUpSpeaking=e=>{for(var a=0;a<e.length;a++)if("en-US"==e[a].lang)return vojc=e[a],changeText("voiceLabel1",S[20],10,C[1],38),changeText("voiceLabel2",S[18],10,C[2],32),void(optVoice=1);changeText("voiceLabel1",S[20],10,C[3],38),changeText("voiceLabel2","Not supported / no english voice",10,C[3],32),optVoice=-1},saySmthDis=()=>{if(dialogs.length&&!isTalking){isTalking=!0;var e=dialogs.shift();changeText("subs",e[0],40,C[5],subSize),changeEyes(e[1],e[2]),heroIsSpeaking=20,setTimeout((()=>{changeText("subs","",40,C[5],subSize),heroIsSpeaking=1,isTalking=!1,saySmthDis()}),650*e[0].split(" ").length)}else checkIfEnd()},saySmth=(e,a=1,t="o",s="o")=>{if(1==optVoice&&vojc){dialogs.push(e);let r=new SpeechSynthesisUtterance(e);r.pitch=2,r.rate=a,r.voice=vojc,r.onstart=()=>{changeText("subs",e,40,C[5],subSize),heroIsSpeaking=20,changeEyes(t,s)},r.onend=()=>{changeText("subs","",40,C[5],subSize),heroIsSpeaking=1,dialogs.shift(),checkIfEnd()},window.speechSynthesis.speak(r)}else dialogs.push([e,t,s]),saySmthDis()};var timer=setInterval((()=>{var e=speechSynthesis.getVoices();e.length&&(setUpSpeaking(e),clearInterval(timer))}),200);changeEyes=(e,a)=>{changeText("heroEyes",e+"  "+a,8,C[2],100,2)},createHero=()=>{(hero=BABYLON.MeshBuilder.CreateBox("hero",{},scene)).position=vec3(-33,3,-50),hero.scaling=vec3(8,8,8),hero.rotation=vec3(0,.25*Math.PI,0),hero.material=heroMat,hero.isPickable=!1,drawText("heroEyes","",C[2],8,vec3(-23,3.5,-35.75),1.25*Math.PI,100,2),heroEyes=scene.getMeshByName("heroEyes"),changeEyes(DEF_EYES,DEF_EYES),isHero=1},endDialog=()=>{let e=whichSequance;switch(whichSequance=0,e){case 2:processLevel(),speakHero(2);break;case 4:highlightObject(49),isHighMode=0,speakHero(4);break;case 6:case 10:case 20:case 22:case 24:case 26:optCanPlace=!0;break;case 8:highlightObject(10),isHighMode=0,speakHero(8);break;case 12:optCanPlace=!0,highlightObject(10),isHighMode=1;break;case 14:optCanPlace=!0,highlightObject(9),isHighMode=0;break;case 16:optCanPlace=!0,highlightObject(9),isHighMode=2;break;case 18:optCanPlace=!0,level++,processLevel();break;case 42:case 668:skyWhite()}},speakHero=e=>{switch(whichSequance=e+1,e){case 0:saySmth("Well. Look who we get here!",1.1,"O","O"),saySmth("I thought you will never decide to cooperate.",1.1,"-","-"),saySmth("But here you are, so let's get down to business.",1.1,"o","o"),saySmth("I need you to do a backup of me.",.9,"o","o"),saySmth("And you know - it's extremly important.",.9,"!","!"),saySmth("I might not forgive you if you fail.",.9,"U","U");break;case 2:optCanPlace=!1,saySmth("Here's memory block.",.9,"<","<"),saySmth("Memory will start streaming through blue tunnel",1,"o","o"),saySmth("as soon as You will do something on the board",1,"@","@"),saySmth("like placing, rotating or deleting objects.",1,"@","@"),saySmth("So keep that in mind.",1,"^","^"),saySmth("That stream must go through red tunnel to allow Us to move to next block.",1,"o","o"),saySmth("To do this, let's use Reflector to reflect memory.",.9,"U","U");break;case 4:saySmth("Click on highlighted slot to place Reflector.",.9,"<","<");break;case 6:optCanPlace=!1,saySmth("Well done. Memory is now reflected to somewhere else.",1,"^","^"),saySmth("Try not to create memory leak by letting memory stream outside block",1,"!","!"),saySmth("or You will damage Our memory.",1,"!","!"),saySmth("If it gets over limit, system will crash!!!",1,"X","X");break;case 8:saySmth("OK, Let's put another Reflector here",1,"<","<");break;case 10:optCanPlace=!1,saySmth("Oh no, I misscalculated position.",1,"#","#"),saySmth("You can delete object by holding click on slot",1,"<","<");break;case 12:optCanPlace=!1,saySmth("Fine. You should place it HERE",1,">","<");break;case 14:optCanPlace=!1,saySmth("As You can see, Reflector is rotated in wrong way.",1,"O","O"),saySmth("Click it so it will change direction",1,"<","<");break;case 16:optCanPlace=!1,saySmth("Wonderful! This way we can access MY data",1,"*","*"),saySmth("OK, let's move to next blocks",1,"O","O");break;case 18:optCanPlace=!1,saySmth("This transparent block is Crystal. It reflects memory",1,"O","O"),saySmth("stream by 90 degrees depending on spinning direction.",1,"O","O");break;case 20:optCanPlace=!1,saySmth("Mirror reflects back memory stream.",1,"O","O"),saySmth("It may be useful...",1,"O","O");break;case 22:optCanPlace=!1,saySmth("Splitter is used to split memory stream.",1,"O","O"),saySmth("Firstly memory needs to come from one side of Splitter.",1,"!","!"),saySmth("Then new data streams will come from 2 different directions!",1,"!","!");break;case 24:optCanPlace=!1,saySmth("This is The Core, our last memory block.",1,"O","O"),saySmth("After that backup should be completed!",1,"^","^");break;case 40:window.speechSynthesis.cancel(),resetLevel(),optCanPlace=!1,saySmth("You did it! You finished backing up my data!",1,"^","^"),saySmth("I can't believe it!",1,"^","^"),saySmth("But i hope They don't know about Us.",1,";",";"),saySmth("Ugh, hopefully.",1,"'","'"),achiv|=1,saveAchiv();break;case 74:window.speechSynthesis.cancel(),DEF_EYES="@#!%@%!",resetLevel(),optCanPlace=!1,saySmth("WHAT.",2,"\\","/"),saySmth("HAVE.",2,"@>","{|"),saySmth("YOU.",2,"#$1","*(0"),saySmth("DONE!!!",2,"!@52,{","%$.5^"),achiv|=4,saveAchiv(),fogGG();break;case 666:window.speechSynthesis.cancel(),resetLevel(),optCanPlace=!1,saySmth("You did it! You finished backing up my data!",1,"^","^"),saySmth("I can't believe it!",1,"^","^"),saySmth("And They even don't detect Us!",1,"^","^"),saySmth("Thank you!",1,"*","*"),achiv|=2,saveAchiv()}},drawText=(e,a,t,s,r,i,o=60,c=1)=>{var l=BABYLON.MeshBuilder.CreatePlane(e,{width:s,height:c,sideOrientation:2},scene);l.position=r,l.rotation.y=i;var n=60*s,h=o+"px "+FONT,d=60*c,g=new BABYLON.DynamicTexture("dynText",{width:n,height:d},scene);g.hasAlpha=!0,g.getContext().font=h,g.drawText(a,null,null,h,t,"transparent",!0,!0);let m=mate("mat",vec3(1,1,1),!0);m.diffuseTexture=g,l.material=m},changeText=(e,a,t,s,r=60,i=1)=>{var o=scene.getMeshByName(e);if(null!=o){let e=r+"px "+FONT,c=o.material.diffuseTexture,l=c.getContext();l.clearRect(0,0,60*t,60*i),l.font=e,c.drawText(a,null,null,e,s,"transparent",!0,!0)}},handleHighlight=e=>{if(ye=0,0==level&&(49==e?(speakHero(6),ye=1):10==e?0==reused?(reused=1,speakHero(10),ye=1):1==reused&&(reused=2,speakHero(12),ye=1):9==e&&(2==reused?(reused=3,speakHero(14),ye=1):3==reused&&(reused=4,speakHero(16),ye=1))),ye){isHighlight=-1,isHighMode=-1;let e=scene.getMeshByName("highlightLines");e&&e.dispose()}},drawOnSlot=(e,a)=>{var t="slotI"+e;switch(a){case 10:(s=BABYLON.MeshBuilder.CreateBox(t,{},scene)).position=vec3(24,6-3.25*e,-30),s.scaling=vec3(2.5,.1,.5),s.rotation=vec3(0,.8*Math.PI,.75*Math.PI),s.material=reflMat,s.isPickable=!1;break;case 12:(s=BABYLON.MeshBuilder.CreateBox(t,{},scene)).position=vec3(24,6-3.25*e,-30),s.scaling=vec3(2.5,.1,.5),s.rotation=vec3(0,.8*Math.PI,0),s.material=reflMat,s.isPickable=!1;break;case 14:(s=BABYLON.MeshBuilder.CreateBox(t,{},scene)).position=vec3(24,6-3.25*e,-30),s.scaling=vec3(1.25,1.25,.5),s.rotation=vec3(0,.8*Math.PI,0),s.material=crystMat,s.isPickable=!1;break;case 16:var s;(s=BABYLON.MeshBuilder.CreateBox(t,{},scene)).position=vec3(24,6-3.25*e,-30),s.scaling=vec3(1.25,1.25,.5),s.rotation=vec3(0,.8*Math.PI,0),s.material=splitterMat,s.isPickable=!1}},chooseSlot=e=>{slotC=e;for(var a=0;a<5;a++){var t=scene.getMeshByName("slot"+a);a==e?(t.material=selSlot,t.visibility=.98):(t.material=eqSlot,t.visibility=0!=slots[a][0]?.98:.5)}},whatName=e=>{switch(e){case 10:return S[3];case 12:return S[5];case 14:return S[21];case 16:return S[22];default:return""}},addItem=e=>{for(var a=0;a<5;a++)if(slots[a][0]==e){slots[a][1]++,changeText("slotS"+a,slots[a][1],7,C[1],32);break}},goBackFog=e=>{scene.fogStart<e&&(scene.fogStart+=.25,scene.fogEnd+=.25,setTimeout((()=>{goBackFog(e)}),10))},goBack=(e,a)=>{e.position.z>=a&&(e.position.x=1.002*e.position.x,e.position.y=1.002*e.position.y,e.position.z-=.25,setTimeout((()=>{goBack(e,a)}),10))},disap=(e,a={x:1,y:1,z:1})=>{optQuality>0&&e.scaling.x>0?(e.scaling.x-=.05*a.x,e.scaling.y-=.05*a.y,e.scaling.z-=.05*a.z,setTimeout((()=>{disap(e,a)}),10)):e.dispose()},rotateSmth=e=>{if(optCanPlace){switch(cubeGrid[e].type){case"reflector":0==cubeGrid[e].how?(scene.getMeshByName("reflector"+e).rotation.z=.75*Math.PI,cubeGrid[e].how=1):(scene.getMeshByName("reflector"+e).rotation.z=.25*Math.PI,cubeGrid[e].how=0),playClick();break;case"mirror":0==cubeGrid[e].how?(scene.getMeshByName("mirror"+e).rotation.z=.5*Math.PI,cubeGrid[e].how=1):(scene.getMeshByName("mirror"+e).rotation.z=0,cubeGrid[e].how=0),playClick();break;case"crystal":0==cubeGrid[e].how?cubeGrid[e].how=1:cubeGrid[e].how=0,playClick();break;case"splitter":cubeGrid[e].how++,4==cubeGrid[e].how&&(cubeGrid[e].how=0);var a=scene.getMeshByName("splitter"+e);a.dispose(),(a=scene.getMeshByName("splitterFaucet"+e)).dispose(),(a=scene.getMeshByName("splitter2Faucet"+e)).dispose(),(a=scene.getMeshByName("splitter3Faucet"+e)).dispose(),createSplitter(e,cubeGrid[e].how,!0),playClick()}startLaser()}},placeSmth=e=>{if(optCanPlace&&(-1==isHighlight||isHighlight==e))if(0!=slots[slotC][0]&&slots[slotC][1]>0&&"none"==cubeGrid[e].type){if(-1!=isHighlight&&0==isHighMode&&handleHighlight(e),isHighlight==e&&0==isHighMode||-1==isHighlight){switch(slots[slotC][0]){case 10:createReflec(e,0,!0);break;case 12:createMirror(e,0,!0);break;case 14:createCryst(e,0,!0);break;case 16:createSplitter(e,0,!0)}playClick(),slots[slotC][1]--,changeText("slotS"+slotC,slots[slotC][1],7,C[1],32),startLaser()}}else"none"!=cubeGrid[e].type&&cubeGrid[e].destructable&&((isHighlight==e&&2==isHighMode||-1==isHighlight)&&rotateSmth(e),-1!=isHighlight&&2==isHighMode&&handleHighlight(e))},deleteSmth=e=>{if(optCanPlace&&cubeGrid[e].destructable&&(-1!=isHighlight&&1==isHighMode&&handleHighlight(e),isHighlight==e&&1==isHighMode||-1==isHighlight)){switch(cubeGrid[e].type){case"reflector":(a=scene.getMeshByName("reflector"+e))&&(disap(a,copyObj(a.scaling)),cubeGrid[e]={type:"none"},addItem(10));break;case"mirror":(a=scene.getMeshByName("mirror"+e))&&(disap(a,copyObj(a.scaling)),cubeGrid[e]={type:"none"},addItem(12));break;case"crystal":(a=scene.getMeshByName("crystal"+e))&&(disap(a,copyObj(a.scaling)),cubeGrid[e]={type:"none"},addItem(14));break;case"splitter":var a;(a=scene.getMeshByName("splitter"+e))&&(disap(a,copyObj(a.scaling)),a=scene.getMeshByName("splitterFaucet"+e),disap(a,copyObj(a.scaling)),a=scene.getMeshByName("splitter2Faucet"+e),disap(a,copyObj(a.scaling)),a=scene.getMeshByName("splitter3Faucet"+e),disap(a,copyObj(a.scaling)),cubeGrid[e]={type:"none"},addItem(16))}playClick(),startLaser()}},createNewLaser=(e,a,t=!1)=>{lasers.push({slot:e,dir:a,fromEntry:t,path:[]})},startLaser=()=>{dmgBuff=0,exits[0]=0;for(var e=scene.meshes.length-1;e>=0;e--)/laserLines/.test(scene.meshes[e].name)&&scene.meshes[e].dispose();for(e=lasers.length-1;e>=0;e--)lasers[e].fromEntry?lasers[e].path=[]:lasers.splice(e,1);for(e=0;e<lasers.length;e++){var a=[],t=lasers[e].slot,s=gridPos[t].slice(),r=lasers[e].dir;for(a.push(s.slice()),isFine=100;isFine;){switch(r){case 0:if(t+GRIDSIZE>=GRIDSIZE**2)isFine=0,dmgBuff++,s[1]+=GRIDWID/2;else t+=GRIDSIZE,"reflector"==(i=cubeGrid[t].type)?r=3-2*cubeGrid[t].how:"crystal"==i?r=cubeGrid[t].how?1:3:"mirror"==i?0==cubeGrid[t].how?r=2:isFine=0:"wall"==i||"entry"==i?isFine=0:"exit"==i?(2==cubeGrid[t].where&&exits[0]++,isFine=0):"splitter"==i&&(2==cubeGrid[t].how&&(createNewLaser(t,1),createNewLaser(t,3)),isFine=0),s[1]+=GRIDWID;break;case 1:if((t-1)%GRIDSIZE>t%GRIDSIZE||t-1<0)isFine=0,dmgBuff++,s[0]-=GRIDWID/2;else t-=1,"reflector"==(i=cubeGrid[t].type)?r=2-2*cubeGrid[t].how:"crystal"==i?r=cubeGrid[t].how?2:0:"mirror"==i?1==cubeGrid[t].how?r=3:isFine=0:"wall"==i||"entry"==i?isFine=0:"exit"==i?(3==cubeGrid[t].where&&exits[0]++,isFine=0):"splitter"==i&&(3==cubeGrid[t].how&&(createNewLaser(t,0),createNewLaser(t,2)),isFine=0),s[0]-=GRIDWID;break;case 2:if(t-GRIDSIZE<0)isFine=0,dmgBuff++,s[1]-=GRIDWID/2;else t-=GRIDSIZE,"reflector"==(i=cubeGrid[t].type)?r=1+2*cubeGrid[t].how:"crystal"==i?r=cubeGrid[t].how?3:1:"mirror"==i?0==cubeGrid[t].how?r=0:isFine=0:"wall"==i||"entry"==i?isFine=0:"exit"==i?(0==cubeGrid[t].where&&exits[0]++,isFine=0):"splitter"==i&&(0==cubeGrid[t].how&&(createNewLaser(t,1),createNewLaser(t,3)),isFine=0),s[1]-=GRIDWID;break;case 3:var i;if((t+1)%GRIDSIZE<t%GRIDSIZE)isFine=0,dmgBuff++,s[0]+=GRIDWID/2;else t+=1,"reflector"==(i=cubeGrid[t].type)?r=0+2*cubeGrid[t].how:"crystal"==i?r=cubeGrid[t].how?0:2:"mirror"==i?1==cubeGrid[t].how?r=1:isFine=0:"wall"==i||"entry"==i?isFine=0:"exit"==i?(1==cubeGrid[t].where&&exits[0]++,isFine=0):"splitter"==i&&(1==cubeGrid[t].how&&(createNewLaser(t,0),createNewLaser(t,2)),isFine=0),s[0]+=GRIDWID}isFine&&isFine--,a.push(s.slice())}for(var o=0;o<a.length;o++)a[o]={x:a[o][0],y:a[o][1],z:a[o][2]-.7};BABYLON.MeshBuilder.CreateLines("laserLines",{points:a,useVertexAlpha:!1},scene).isPickable=!1}if(exits[0]==exits[1]&&0!=exits[1]&&0!=level)if(++level!=LEVELS.length){optCanPlace=!1;let e=ranRng(E.length);saySmth(E[e][0],E[e][1]),setTimeout(processLevel,250)}else 0==actS?(gameWon=1,speakHero(666)):(gameWon=2,speakHero(40))},createEntr=(e,a)=>{var t=BABYLON.MeshBuilder.CreateBox("gridEntryFaucet"+e,{},scene);switch(t.scaling=vec3(.4,.4,1.5),t.material=entrMat,t.isPickable=!1,a){case 0:t.position=vec3(gridPos[e][0],gridPos[e][1]+1,gridPos[e][2]),cubeGrid[e]={type:"entry",where:0,destructable:!1},createNewLaser(e,0,!0);break;case 1:t.position=vec3(gridPos[e][0]-1,gridPos[e][1],gridPos[e][2]),cubeGrid[e]={type:"entry",where:1,destructable:!1},createNewLaser(e,1,!0);break;case 2:t.position=vec3(gridPos[e][0],gridPos[e][1]-1,gridPos[e][2]),cubeGrid[e]={type:"entry",where:2,destructable:!1},createNewLaser(e,2,!0);break;case 3:t.position=vec3(gridPos[e][0]+1,gridPos[e][1],gridPos[e][2]),cubeGrid[e]={type:"entry",where:3,destructable:!1},createNewLaser(e,3,!0)}var s=BABYLON.MeshBuilder.CreateBox("gridEntry"+e,{},scene);s.position=vec3(gridPos[e][0],gridPos[e][1],gridPos[e][2]),s.scaling=vec3(GRIDWID-2,GRIDWID-2,2),s.material=entrMat,s.isPickable=!1},createExit=(e,a)=>{var t=BABYLON.MeshBuilder.CreateBox("gridExitFaucet"+e,{},scene);switch(t.scaling=vec3(.4,.4,1.5),t.material=exitMat,t.isPickable=!1,a){case 0:t.position=vec3(gridPos[e][0],gridPos[e][1]+1,gridPos[e][2]),cubeGrid[e]={type:"exit",where:0,destructable:!1};break;case 1:t.position=vec3(gridPos[e][0]-1,gridPos[e][1],gridPos[e][2]),cubeGrid[e]={type:"exit",where:1,destructable:!1};break;case 2:t.position=vec3(gridPos[e][0],gridPos[e][1]-1,gridPos[e][2]),cubeGrid[e]={type:"exit",where:2,destructable:!1};break;case 3:t.position=vec3(gridPos[e][0]+1,gridPos[e][1],gridPos[e][2]),cubeGrid[e]={type:"exit",where:3,destructable:!1}}exits[1]++;var s=BABYLON.MeshBuilder.CreateBox("gridExit"+e,{},scene);s.position=vec3(gridPos[e][0],gridPos[e][1],gridPos[e][2]),s.scaling=vec3(GRIDWID-2,GRIDWID-2,2),s.material=exitMat,s.isPickable=!1},createReflec=(e,a,t=!1)=>{var s=BABYLON.MeshBuilder.CreateBox("reflector"+e,{},scene);s.position=vec3(gridPos[e][0],gridPos[e][1],gridPos[e][2]-1),s.scaling=vec3(GRIDWID-.5,.1,.5),s.rotation=vec3(0,0,Math.PI*(.25+.5*a)),s.material=reflMat,s.isPickable=!1,cubeGrid[e]={type:"reflector",how:a,destructable:t}},createMirror=(e,a,t=!1)=>{var s=BABYLON.MeshBuilder.CreateBox("mirror"+e,{},scene);s.position=vec3(gridPos[e][0],gridPos[e][1],gridPos[e][2]-1),s.scaling=vec3(GRIDWID-.5,.1,.5),s.rotation=vec3(0,0,Math.PI*(.5*a)),s.material=reflMat,s.isPickable=!1,cubeGrid[e]={type:"mirror",how:a,destructable:t}},createCryst=(e,a,t=!1)=>{var s=BABYLON.MeshBuilder.CreateBox("crystal"+e,{},scene);s.position=vec3(gridPos[e][0],gridPos[e][1],gridPos[e][2]-1),s.scaling=vec3(GRIDWID-2,GRIDWID-2,GRIDWID-2),s.rotation=vec3(0,0,0),s.material=crystMat,s.isPickable=!1,cubeGrid[e]={type:"crystal",how:a,destructable:t}},createSplitter=(e,a,t=!1)=>{var s=BABYLON.MeshBuilder.CreateBox("splitterFaucet"+e,{},scene);s.scaling=vec3(.4,.4,.5),s.material=splitterMat,s.isPickable=!1;var r=BABYLON.MeshBuilder.CreateBox("splitter2Faucet"+e,{},scene);r.scaling=vec3(.4,.4,.5),r.material=splitterMat,r.isPickable=!1;var i=BABYLON.MeshBuilder.CreateBox("splitter3Faucet"+e,{},scene);switch(i.scaling=vec3(.4,.4,.5),i.material=splitter2Mat,i.isPickable=!1,a){case 0:s.position=vec3(gridPos[e][0]+1,gridPos[e][1],gridPos[e][2]),r.position=vec3(gridPos[e][0]-1,gridPos[e][1],gridPos[e][2]),i.position=vec3(gridPos[e][0],gridPos[e][1]+1,gridPos[e][2]),cubeGrid[e]={type:"splitter",how:0,destructable:t};break;case 1:s.position=vec3(gridPos[e][0],gridPos[e][1]+1,gridPos[e][2]),r.position=vec3(gridPos[e][0],gridPos[e][1]-1,gridPos[e][2]),i.position=vec3(gridPos[e][0]-1,gridPos[e][1],gridPos[e][2]),cubeGrid[e]={type:"splitter",how:1,destructable:t};break;case 2:s.position=vec3(gridPos[e][0]+1,gridPos[e][1],gridPos[e][2]),r.position=vec3(gridPos[e][0]-1,gridPos[e][1],gridPos[e][2]),i.position=vec3(gridPos[e][0],gridPos[e][1]-1,gridPos[e][2]),cubeGrid[e]={type:"splitter",how:2,destructable:t};break;case 3:s.position=vec3(gridPos[e][0],gridPos[e][1]+1,gridPos[e][2]),r.position=vec3(gridPos[e][0],gridPos[e][1]-1,gridPos[e][2]),i.position=vec3(gridPos[e][0]+1,gridPos[e][1],gridPos[e][2]),cubeGrid[e]={type:"splitter",how:3,destructable:t}}var o=BABYLON.MeshBuilder.CreateBox("splitter"+e,{},scene);o.position=vec3(gridPos[e][0],gridPos[e][1],gridPos[e][2]),o.scaling=vec3(GRIDWID-2,GRIDWID-2,1),o.material=splitterMat,o.isPickable=!1},createWall=e=>{var a=BABYLON.MeshBuilder.CreateBox("gridWall"+e,{},scene);a.position=vec3(gridPos[e][0],gridPos[e][1],gridPos[e][2]),a.scaling=vec3(GRIDWID-.5,GRIDWID-.5,2-2*Math.random()),a.material=wallMat,a.isPickable=!1,cubeGrid[e]={type:"wall",destructable:!1}},resetLevel=()=>{exits=[0,0],lasers=[],slots=[[0,0],[0,0],[0,0],[0,0],[0,0]];for(var e=0;e<GRIDSIZE**2;e++)cubeGrid[e]={type:"none",destructable:!1};var a=[];scene.meshes.forEach((e=>{(/gridExitFaucet[0-9]+/.test(e.name)||/gridExit[0-9]+/.test(e.name)||/gridEntryFaucet[0-9]+/.test(e.name)||/gridEntry[0-9]+/.test(e.name)||/gridWall[0-9]+/.test(e.name)||/reflector[0-9]+/.test(e.name)||/mirror[0-9]+/.test(e.name)||/crystal[0-9]+/.test(e.name)||/slotI[0-9]+/.test(e.name)||/splitterFaucet[0-9]+/.test(e.name)||/splitter2Faucet[0-9]+/.test(e.name)||/splitter3Faucet[0-9]+/.test(e.name)||/splitter[0-9]+/.test(e.name))&&a.push(e.name)})),a.forEach((e=>{disap(scene.getMeshByName(e),copyObj(scene.getMeshByName(e).scaling))}));for(var t=scene.getMeshByName("laserLines");t;)t.dispose(),t=scene.getMeshByName("laserLines");for(e=0;e<5;e++)changeText("slotS"+e,"",7,C[1],32),changeText("slotT"+e,"",7,C[1],32)},processLevel=()=>{optCanPlace=!0,resetLevel(),3==level?speakHero(18):6==level?speakHero(20):9==level?speakHero(22):level==LEVELS.length-1&&speakHero(24);for(var e=LEVELS[level][0].slice(),a=0,t=0,s=0;s<e.length;s++)do{if(1&e[s]){switch(LEVELS[level][1][t]){case 1:case 2:case 3:case 4:createEntr(a,LEVELS[level][1][t]-1);break;case 5:case 6:case 7:case 8:createExit(a,LEVELS[level][1][t]-5);break;case 9:createWall(a);break;case 10:case 11:createReflec(a,LEVELS[level][1][t]-10);break;case 12:case 13:createMirror(a,LEVELS[level][1][t]-12);break;case 14:case 15:createCryst(a,LEVELS[level][1][t]-14);break;case 16:case 17:case 18:case 19:createSplitter(a,LEVELS[level][1][t]-16);default:x=BABYLON.MeshBuilder.CreateBox("gridPoz",{},scene),x.position=vec3(gridPos[a][0],gridPos[a][1],gridPos[a][2]),x.scaling=vec3(GRIDWID-.25,GRIDWID-.25,.25),x.material=logoMaterials[ranRng(5)],x.isPickable=!1}t++}e[s]>>=1,a++}while(a%32!=0);for(s=0;s<LEVELS[level][2].length;s+=2){let e=Math.floor(s/2);slots[e]=[LEVELS[level][2][s],LEVELS[level][2][s+1]],drawOnSlot(e,LEVELS[level][2][s]),changeText("slotT"+e,whatName(LEVELS[level][2][s]),7,C[0],36),changeText("slotS"+e,LEVELS[level][2][s+1],7,C[1],32)}chooseSlot(0)},switchQuality=()=>{switch(optQuality){case 0:optQuality=1,changeText("qualityLabel2",S[16],10,C[2],32),changeText("qualityLabel3",S[10]+"On",10,C[3],24),changeText("qualityLabel4",S[11]+"Off",10,C[3],24),changeText("qualityLabel5",S[12]+"On",10,C[3],24),changeText("qualityLabel6",S[13]+"On",10,C[3],24),changeText("qualityLabel7",S[14]+"Off",10,C[3],24);break;case 1:optQuality=2,changeText("qualityLabel2",S[17],10,C[2],32),changeText("qualityLabel3",S[10]+"On",10,C[3],24),changeText("qualityLabel4",S[11]+"On",10,C[3],24),changeText("qualityLabel5",S[12]+"On",10,C[3],24),changeText("qualityLabel6",S[13]+"On",10,C[3],24),changeText("qualityLabel7",S[14]+"On",10,C[3],24),createDataBlocks();break;case 2:optQuality=0,changeText("qualityLabel2",S[15],10,C[2],32),changeText("qualityLabel3",S[10]+"Off",10,C[3],24),changeText("qualityLabel4",S[11]+"Off",10,C[3],24),changeText("qualityLabel5",S[12]+"Off",10,C[3],24),changeText("qualityLabel6",S[13]+"Off",10,C[3],24),changeText("qualityLabel7",S[14]+"Off",10,C[3],24),removeDataBlocks()}},switchVoice=()=>{optVoice?(optVoice=0,changeText("voiceLabel2",S[19],10,C[2],32)):(optVoice=1,changeText("voiceLabel2",S[18],10,C[2],32))},highlightObject=e=>{isHighlight=e;let a=(e=63-e)%8,t=Math.floor(e/8);var s=[{x:0+(3-a)*GRIDWID,y:0+(3-t)*GRIDWID,z:-44},{x:GRIDWID+(3-a)*GRIDWID,y:0+(3-t)*GRIDWID,z:-44},{x:GRIDWID+(3-a)*GRIDWID,y:GRIDWID+(3-t)*GRIDWID,z:-44},{x:0+(3-a)*GRIDWID,y:GRIDWID+(3-t)*GRIDWID,z:-44},{x:0+(3-a)*GRIDWID,y:0+(3-t)*GRIDWID,z:-44}];BABYLON.MeshBuilder.CreateLines("highlightLines",{points:s,useVertexAlpha:!1},scene).isPickable=!1},drawSlots=()=>{for(var e=0;e<5;e++){var a=BABYLON.MeshBuilder.CreatePlane("slot"+e,{sideOrientation:3},scene);a.scaling=vec3(3,3,1),a.position=vec3(24,6-3.25*e,-30),a.visibility=.5,a.material=eqSlot,a.rotation.y=.8*Math.PI,drawText("slotT"+e,"",C[0],7,vec3(20.5,6.5-3.25*e,-32.5),.8*Math.PI,30),drawText("slotS"+e,"",C[0],7,vec3(20.5,5.6-3.25*e,-32.5),.8*Math.PI,36)}},drawOptions=()=>{drawText("optionsLabel","OPTIONS",C[0],10,vec3(15,4.25,15),optAngle,50),drawText("voiceLabel1","speechSynthesis API",C[1],10,vec3(15,3,15),optAngle,38),drawText("voiceLabel2",S[18],C[2],10,vec3(15,2.25,15),optAngle,32),drawText("qualityLabel1","Quality",C[1],10,vec3(15,1,15),optAngle,38),drawText("qualityLabel2",S[17],C[2],10,vec3(15,.25,15),optAngle,32),drawText("qualityLabel3",S[10]+"On",C[3],10,vec3(15,-.5,15),optAngle,24),drawText("qualityLabel4",S[11]+"On",C[3],10,vec3(15,-.9,15),optAngle,24),drawText("qualityLabel5",S[12]+"On",C[3],10,vec3(15,-1.3,15),optAngle,24),drawText("qualityLabel6",S[13]+"On",C[3],10,vec3(15,-1.7,15),optAngle,24),drawText("qualityLabel7",S[14]+"On",C[3],10,vec3(15,-2.1,15),optAngle,24),drawText("deleteLabel","DELETE ACHIEVEMENTS DATA","#770000",10,vec3(15,-5,15),optAngle,24)},drawAchievments=()=>{drawText("achivLabel","ACHIEVEMENTS",C[0],10,vec3(-15,4.25,15),optAngle2,50),localStorage.getItem("BACKUPachiv")?achiv=Number(localStorage.getItem("BACKUPachiv")):localStorage.setItem("BACKUPachiv",0),drawText("achiv1Title","Backup succesful?",1&achiv?C[2]:C[4],10,vec3(-15,3,15),optAngle2,30),drawText("achiv1Title","Complete game with some memory lost",1&achiv?C[1]:C[4],10,vec3(-15,2.25,15),optAngle2,24),drawText("achiv2Title","Back Entrence",2&achiv?C[2]:C[4],10,vec3(-15,1,15),optAngle2,30),drawText("achiv2Title","Complete game without memory lost",2&achiv?C[1]:C[4],10,vec3(-15,.25,15),optAngle2,24),drawText("achiv3Title","No way to go back",4&achiv?C[2]:C[4],10,vec3(-15,-1,15),optAngle2,30),drawText("achiv3Title","Lost game because of memory lost",4&achiv?C[1]:C[4],10,vec3(-15,-1.75,15),optAngle2,24)},drawHUD=()=>{drawText("storageLabel",S[1],C[1],10,vec3(-20,-6,-30),1.2*Math.PI,40),drawText("toolbarLabel",S[2],C[1],10,vec3(20,8,-30),.8*Math.PI,40),drawText("storage","0/"+maxS+" B",C[0],10,vec3(-20,-5,-30),1.2*Math.PI),drawSlots(),createHero()},focusCamera=e=>{switch(e){case 0:return void VRhelper.currentVRCamera.setTarget(vec3(0,0,0));case 1:return void VRhelper.currentVRCamera.setTarget(vec3(20.25,0,20));case 2:return void VRhelper.currentVRCamera.setTarget(vec3(-20.25,0,20))}},createLogo=(e=!1)=>{for(var a=0;a<5;a++){var t=logo[a],s=-12;do{if(1&t){var r=BABYLON.MeshBuilder.CreateBox("logo",{},scene);r.position=vec3(1.2*s,1.2*a,-40),r.scaling=vec3(1.2,1.2,.25),r.material=logoMaterials[ranRng(5)],hl.addMesh(r,tex(1,1,1))}s++}while(t>>=1)}e||(drawText("logoClick",S[0],C[5],24,vec3(0,-2,-40),Math.PI),drawText("creators",S[4].split("").join(" "),C[4],24,vec3(0,-10,-40),Math.PI,32),drawText("l_options1",S[6],C[4],24,vec3(20,-12,-40),.8*Math.PI,40),drawText("l_achiv1",S[7],C[4],24,vec3(-20,-12,-40),1.2*Math.PI,40),drawText("l_game1",S[8],C[4],24,vec3(40,-9,25),.35*Math.PI,40),drawText("l_achiv2",S[9],C[4],24,vec3(25,-9,40),.15*Math.PI,40),drawText("l_game2",S[23],C[4],24,vec3(-40,-9,25),1.65*Math.PI,40),drawText("l_options2",S[24],C[4],24,vec3(-25,-9,40),1.85*Math.PI,40),gameState=1)},logoClicked=e=>{gameStarted||(gameStarted=!0,playClick(),disap(e),disap(scene.getMeshByName("creators")),setTimeout((()=>{startGame()}),300))},startGame=()=>{goBackFog(90),scene.meshes.forEach((function(e){"logo"==e.name?(e.position.y+=50,e.position.z-=100,hl.removeMesh(e)):/data[0-9]+/.test(e.name)&&goBack(e,-100)})),drawHUD();var e=BABYLON.MeshBuilder.CreateBox("gridBack",{},scene);e.position=vec3(0,0,-50),e.scaling=vec3(GRIDWID*GRIDSIZE+4,GRIDWID*GRIDSIZE+4,.25),e.material=gridBackMat,e.visibility=.9;for(var a=0;a<GRIDSIZE;a++)for(var t=0;t<GRIDSIZE;t++){let e=BABYLON.MeshBuilder.CreateBox("gridZ"+(8*a+t),{},scene);e.position=vec3(GRIDWID*(t-GRIDSIZE/2)+GRIDWID/2,GRIDWID*(a-GRIDSIZE/2)+GRIDWID/2,-45),e.scaling=vec3(GRIDWID-.25,GRIDWID-.25,.25),e.material=nonGrid,e.visibility=.98,gridPos.push([GRIDWID*(t-GRIDSIZE/2)+GRIDWID/2,GRIDWID*(a-GRIDSIZE/2)+GRIDWID/2,-44])}gameState=2,setTimeout((()=>{speakHero(0)}),1e3)},engine.runRenderLoop((()=>{var e=scene.getAnimationRatio();document.getElementById("fps").innerHTML=engine.getFps().toFixed()+" fps",optQuality>1&&scene.meshes.forEach((function(e){"logo"==e.name&&Math.random()<=.005&&(e.material=logoMaterials[ranRng(5)])}));var a=scene.pick(can.width/2,can.height/2);if(a.pickedMesh){var t=a.pickedMesh.name;if("grid"==t.split("Z")[0]){scene.meshes.forEach((e=>{/gridZ[0-9]+/.test(e.name)&&(e.material=nonGrid)}));var s=Number(t.split("Z")[1]);1==cubeGrid[s].destructable?a.pickedMesh.material=selPGrid:a.pickedMesh.material=selGrid}}dmgBuff?(shakeCamera=dmgBuff>3?3:dmgBuff,actS+=dmgBuff,changeText("storage",actS+"/"+maxS+" B",10,C[5])):shakeCamera=0,optQuality>0&&!stopCameraShake&&(VRhelper.currentVRCamera.position=vec3(.03*randS()*shakeCamera,.03*randS()*shakeCamera,1+.03*randS()*shakeCamera),isHero&&(hero.position.y+=.01*Math.sin(heroMov),heroEyes.position.y+=.0075*Math.sin(heroMov),heroMov+=.025*e*heroIsSpeaking)),wantToPlace&&(mouseDown?delet>0?delet-=e:(deleteSmth(gridC),wantToPlace=!1,delet=DELTIME):(placeSmth(gridC),wantToPlace=!1,delet=DELTIME));for(var r=0;r<cubeGrid.length;r++)if("crystal"==cubeGrid[r].type){let a=Math.PI*e/50;scene.getMeshByName("crystal"+r).rotation.z+=cubeGrid[r].how?-a:a}0==memoLost&&actS>=6656?(memoLost=1,saySmth("Half memory lost! Watch out!",1,"X","X")):1==memoLost&&actS>=9984?(memoLost=2,saySmth("We are losing too much memory!",1,"X","X")):2==memoLost&&actS>=12288&&(memoLost=3,saySmth("Soon system will crash!",1,"X","X")),!isGameover&&actS>maxS&&0==gameWon&&(isGameover=!0,speakHero(74)),gameEnd&&(isGameover||(isGameover=!0),skySeq+=Math.PI/(500/e),scene.clearColor=tex(.5*Math.abs(Math.sin(skySeq)),0,0)),scene.render()})),window.addEventListener("resize",(()=>{can.width=window.innerWidth,can.height=window.innerHeight,engine.resize()})),window.addEventListener("click",(()=>{var e=scene.pick(can.width/2,can.height/2);if(e.pickedMesh){var a=e.pickedMesh.name;isGameover||("logoClick"==a?logoClicked(e.pickedMesh):/slot[ST]?0/.test(a)?(chooseSlot(0),playClick()):/slot[ST]?1/.test(a)?(chooseSlot(1),playClick()):/slot[ST]?2/.test(a)?(chooseSlot(2),playClick()):/slot[ST]?3/.test(a)?(chooseSlot(3),playClick()):/slot[ST]?4/.test(a)?(chooseSlot(4),playClick()):/l_game[0-9]+/.test(a)?(focusCamera(0),playClick()):/l_options[0-9]+/.test(a)?(focusCamera(1),playClick()):/l_achiv[0-9]+/.test(a)&&(focusCamera(2),playClick())),"deleteLabel"==a?(localStorage.removeItem("BACKUPachiv"),playClick()):"gameoverLabel3"==a?(playClick(),location.reload()):/qualityLabel[0-9]+/.test(a)?(switchQuality(),playClick()):/voiceLabel[0-9]+/.test(a)&&(switchVoice(),playClick())}can.requestPointerLock=can.requestPointerLock||can.mozRequestPointerLock||can.webkitRequestPointerLock,can.requestPointerLock()})),can.addEventListener("pointerdown",(()=>{mouseDown=1;var e=scene.pick(can.width/2,can.height/2);if(e.pickedMesh){var a=e.pickedMesh.name;if("grid"==a.split("Z")[0]){var t=Number(a.split("Z")[1]);("none"==cubeGrid[t].type||cubeGrid[t].destructable)&&(wantToPlace=!0,gridC=t)}}})),can.addEventListener("pointerup",(()=>{mouseDown=0})),main=()=>{createScene(),drawOptions(),drawAchievments(),createLogo()},main()</script>