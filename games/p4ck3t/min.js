const t={Backspace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Alt:18,Pause:19,CapsLock:20,Esc:27,Space:32,PageUp:33,PageDown:34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,Insert:45,Del:46,NUM_0:48,NUM_1:49,NUM_2:50,NUM_3:51,NUM_4:52,NUM_5:53,NUM_6:54,NUM_7:55,NUM_8:56,NUM_9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,LeftMeta:91,RightMeta:92,Select:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,Asterisk:106,Plus:107,Minus:109,Decimal:110,Divide:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NumLock:144,ScrollLock:145,Semicolon:186,Equal:187,Comma:188,Dash:189,Period:190,Slash:191,Backtick:192,LeftBracket:219,Backslash:220,RightBracket:221,Apostrophe:222};Tween={},Tween.activeTweens=[],Tween.idCounter=0,Tween.create=(t,e,i,s,a)=>{let h={};return h.id=++Tween.idCounter,h.obj=t,h.objStart={},h.objTarget=e,Tween.saveProperties(h.objStart,t,e),h.startTime=(new Date).getTime(),h.endTime=h.startTime+i,h.easing=s,h.completedCallback=a,Tween.activeTweens.push(h),h.id},Tween.cancel=t=>{let e=Tween.activeTweens.find(e=>t==e.id);if(e){let t=Tween.activeTweens.indexOf(e);return Tween.activeTweens.splice(t,1),e}},Tween.stop=t=>{let e=Tween.cancel(t);return e.completedCallback(),e},Tween.saveProperties=(t,e,i)=>{for(let s in i){let a=e[s];"object"!=typeof a?t[s]=a:(t[s]={},Tween.saveProperties(t[s],e[s],i[s]))}},Tween.update=()=>{let t=[];for(let e=0;e<Tween.activeTweens.length;e++){let i=Tween.activeTweens[e];1==Tween.updateSingleTween(i)&&t.push(i)}for(let e=0;e<t.length;e++){let i=t[e];i.completedCallback();let s=Tween.activeTweens.indexOf(i);-1!=s&&Tween.activeTweens.splice(s,1)}},Tween.updateSingleTween=t=>{let e=(new Date).getTime()-t.startTime,i=t.endTime-t.startTime,s=Math.min(1,e/i),a=t.easing(s);return Tween.updateProperties(t.obj,t.objStart,t.objTarget,a),s},Tween.updateProperties=(t,e,i,s)=>{for(let a in e){let h=e[a];if("object"==typeof h){Tween.updateProperties(t[a],e[a],i[a],s);continue}let r=i[a]-h;t[a]=h+r*s}},Tween.Easing={},Tween.Easing.Linear={},Tween.Easing.Linear.EaseNone=t=>t,Tween.Easing.Quadratic={},Tween.Easing.Quadratic.EaseIn=t=>t*t,Tween.Easing.Quadratic.EaseOut=t=>-t*(t-2),Tween.Easing.Quadratic.EaseInOut=t=>(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1),Tween.Easing.Cubic={},Tween.Easing.Cubic.EaseIn=t=>t*t*t,Tween.Easing.Cubic.EaseOut=t=>--t*t*t+1,Tween.Easing.Cubic.EaseInOut=t=>(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2),Tween.Easing.Quartic={},Tween.Easing.Quartic.EaseIn=t=>t*t*t*t,Tween.Easing.Quartic.EaseOut=t=>-(--t*t*t*t-1),Tween.Easing.Quartic.EaseInOut=t=>(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2),Tween.Easing.Quintic={},Tween.Easing.Quintic.EaseIn=t=>t*t*t*t*t,Tween.Easing.Quintic.EaseOut=t=>(t-=1)*t*t*t*t+1,Tween.Easing.Quintic.EaseInOut=t=>(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2),Tween.Easing.Sinusoidal={},Tween.Easing.Sinusoidal.EaseIn=t=>1-Math.cos(t*Math.PI/2),Tween.Easing.Sinusoidal.EaseOut=t=>Math.sin(t*Math.PI/2),Tween.Easing.Sinusoidal.EaseInOut=t=>-.5*(Math.cos(Math.PI*t)-1),Tween.Easing.Exponential={},Tween.Easing.Exponential.EaseIn=t=>0==t?0:Math.pow(2,10*(t-1)),Tween.Easing.Exponential.EaseOut=t=>1==t?1:1-Math.pow(2,-10*t),Tween.Easing.Exponential.EaseInOut=t=>0==t?0:1==t?1:(t*=2)<1?.5*Math.pow(2,10*(t-1)):.5*(2-Math.pow(2,-10*(t-1))),Tween.Easing.Circular={},Tween.Easing.Circular.EaseIn=t=>-(Math.sqrt(1-t*t)-1),Tween.Easing.Circular.EaseOut=t=>Math.sqrt(1- --t*t),Tween.Easing.Circular.EaseInOut=t=>(t/=.5)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1),Tween.Easing.Elastic={},Tween.Easing.Elastic.EaseIn=t=>{var e,i=.1,s=.4;return 0==t?0:1==t?1:(s||(s=.3),!i||i<1?(i=1,e=s/4):e=s/(2*Math.PI)*Math.asin(1/i),-i*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/s))},Tween.Easing.Elastic.EaseOut=t=>{var e,i=.1,s=.4;return 0==t?0:1==t?1:(s||(s=.3),!i||i<1?(i=1,e=s/4):e=s/(2*Math.PI)*Math.asin(1/i),i*Math.pow(2,-10*t)*Math.sin((t-e)*(2*Math.PI)/s)+1)},Tween.Easing.Elastic.EaseInOut=t=>{var e,i=.1,s=.4;return 0==t?0:1==t?1:(s||(s=.3),!i||i<1?(i=1,e=s/4):e=s/(2*Math.PI)*Math.asin(1/i),(t*=2)<1?i*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/s)*-.5:i*Math.pow(2,-10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/s)*.5+1)},Tween.Easing.Back={},Tween.Easing.Back.EaseIn=t=>{var e=1.70158;return t*t*((e+1)*t-e)},Tween.Easing.Back.EaseOut=t=>{var e=1.70158;return(t-=1)*t*((e+1)*t+e)+1},Tween.Easing.Back.EaseInOut=t=>{var e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)},Tween.Easing.Bounce={},Tween.Easing.Bounce.EaseIn=t=>1-Tween.Easing.Bounce.EaseOut(1-t),Tween.Easing.Bounce.EaseOut=t=>(t/=1)<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375,Tween.Easing.Bounce.EaseInOut=t=>t<.5?.5*Tween.Easing.Bounce.EaseIn(2*t):.5*Tween.Easing.Bounce.EaseOut(2*t-1)+.5;var e={LightBlue:"#7EA8DF",DarkBlue:"#3b72b9",VeryDarkBlue:"#1b5299",LightGray:"#A2A4A7",Gray:"gray",DarkGray:"#748499",VeryDarkGray:"#546479",White:"#FFFFFF",Black:"#000000",DarkestGray:"#202020",TransparentBlack:"rgba(0, 0, 0, 0.5)",DarkRed:"rgba(200, 20, 60)"};class i{constructor(){this.height=150,this.margin={left:16,bottom:16,right:16},this.padding={left:8,top:8,right:8},this.width=p.width,this.fontSize=32,this.fontSize=this.width/25,this.portrait={width:100,height:128},this.portraitFloat=16,this.side=0,this.text="",this.characters=[],this.characters.push(new s),this.characters.push(new a),this.characters.push(new h),this.character=this.characters[this.side],this.isDisplaying=!1}display(t,e,i){this.character=this.characters[t],this.side=e,this.text=i,this.isDisplaying=!0}hide(){this.isDisplaying=!1}update(t){this.portraitFloat=16+4*Math.sin((new Date).getTime()/100)}draw(t){if(!this.isDisplaying)return;t.save(),t.translate(this.margin.left,p.height-this.height),0==this.side&&(t.save(),t.translate(0,-this.portrait.height-this.portraitFloat),t.fillStyle="rgba(0, 0, 0, 0.5)",t.beginPath(),t.rect(0,0,this.portrait.width,this.portrait.height),t.fill(),this.character.draw(t),t.restore()),1==this.side&&(t.save(),t.translate(this.width-(this.margin.left+this.margin.right+this.portrait.width),-this.portrait.height-this.portraitFloat),t.fillStyle=e.TransparentBlack,t.beginPath(),t.rect(0,0,this.portrait.width,this.portrait.height),t.fill(),this.character.draw(t),t.restore()),t.fillStyle=e.TransparentBlack,t.beginPath(),t.rect(0,0,this.width-(this.margin.left+this.margin.right),this.height-this.margin.bottom),t.fill(),t.fillStyle=e.White,t.textAlign="left",t.font=this.fontSize+"px Arial";let i=1,s=this.text;for(;this.textIsTooLong(s,t);){let e=this.getShortTextIndex(s,t),a=s.substr(0,e);s=s.substr(e),this.drawTextLine(a,t,i),i++}this.drawTextLine(s,t,i),t.restore()}drawTextLine(t,e,i){let s=e.measureText(t),a=Math.max(Math.ceil(this.fontSize),s.actualBoundingBoxAscent+s.actualBoundingBoxDescent);e.fillText(t,this.padding.left,this.padding.top+i*a)}getShortTextIndex(t,e){for(;this.textIsTooLong(t,e);){let e=t.split(" ");e.pop(),t=e.join(" ")}return t.length}textIsTooLong(t,e){return e.measureText(t).width>this.width-(this.padding.left+this.padding.right+this.margin.left+this.margin.right)}onResize(){this.width=p.width,this.fontSize=Math.min(32,this.width/25)}}class s{constructor(){this.currentMood=0}setMood(t){this.currentMood=t}draw(t){switch(this.currentMood){case 0:default:t.fillStyle=e.LightBlue,t.beginPath(),t.rect(10,20,80,80),t.fill(),t.strokeStyle=e.Black,t.fillStyle=e.Black,t.lineWidth=6,t.beginPath(),t.arc(25,50,10,Math.PI,2*Math.PI),t.stroke(),t.beginPath(),t.arc(75,50,10,Math.PI,2*Math.PI),t.stroke(),t.beginPath(),t.arc(50,65,10,0,Math.PI),t.fill()}}speak(){I.playPingSequence(["C6","C7","E6","E7"],100,1)}}class a{constructor(){this.currentMood=1}setMood(t){this.currentMood=t}draw(t){switch(this.currentMood){case 1:default:t.fillStyle=e.Gray,t.beginPath(),t.arc(20,35,10,Math.PI/2,3*Math.PI/2),t.rect(20,25,60,20),t.arc(80,35,10,3*Math.PI/2,Math.PI/2),t.fill(),t.beginPath(),t.arc(20,55,10,Math.PI/2,3*Math.PI/2),t.rect(20,45,60,20),t.arc(80,55,10,3*Math.PI/2,Math.PI/2),t.fill(),t.beginPath(),t.arc(20,75,10,Math.PI/2,3*Math.PI/2),t.rect(20,65,60,20),t.arc(80,75,10,3*Math.PI/2,Math.PI/2),t.fill(),t.beginPath(),t.arc(20,95,10,Math.PI/2,3*Math.PI/2),t.rect(20,85,60,20),t.arc(80,95,10,3*Math.PI/2,Math.PI/2),t.fill(),t.fillStyle=e.Black,t.beginPath(),t.moveTo(30,40),t.lineTo(45,50),t.lineTo(25,50),t.lineTo(30,40),t.fill(),t.beginPath(),t.moveTo(70,40),t.lineTo(55,50),t.lineTo(75,50),t.lineTo(70,40),t.fill(),t.lineWidth=6,t.beginPath(),t.moveTo(40,65),t.lineTo(60,65),t.stroke()}}speak(){I.playPingSequence(["C4","F3","A3","D3"],100,1)}}class h{constructor(){}draw(t){}speak(){}}class r{constructor(t,i,s,a){this.backgroundColor=e.DarkGray,this.textColor=e.LightBlue,this.x=i,this.y=s,this.width=a&&a.width?a.width:400,this.height=a&&a.height?a.height:100,this.center={x:this.width/2,y:this.height/2},this.text=t,this.fontSize=48,this.skew=50}update(t){}draw(t){t.save(),t.translate(this.x,this.y),t.textAlign="center",t.font=this.fontSize+"px Arial";let i=t.measureText(this.text);this.width=Math.min(p.width-100,Math.max(this.width,i.width)),this.center.x=this.width/2,t.fillStyle=e.Black,t.beginPath(),t.moveTo(-this.center.x-this.skew+5,5-this.center.y),t.lineTo(+this.center.x+5,5-this.center.y),t.lineTo(+this.center.x+this.skew+5,+this.center.y+5),t.lineTo(5-this.center.x,+this.center.y+5),t.lineTo(-this.center.x-this.skew+5,5-this.center.y),t.fill(),t.fillStyle=this.backgroundColor,t.beginPath(),t.moveTo(-this.center.x-this.skew,-this.center.y),t.lineTo(+this.center.x,-this.center.y),t.lineTo(+this.center.x+this.skew,+this.center.y),t.lineTo(-this.center.x,+this.center.y),t.lineTo(-this.center.x-this.skew,-this.center.y),t.fill(),t.fillStyle=this.textColor,t.fillText(this.text,0,this.fontSize/3),t.restore()}}class n{constructor(){this.delay=(new Date).getTime()+5e3}update(t){}draw(t){}mouseHelp(t){}}class l{constructor(){this.isMuted=!1,this.frequencyLookup={C0:16.35,"C#0":17.32,Db0:17.32,D0:18.35,"D#0":19.45,Eb0:19.45,E0:20.6,F0:21.83,"F#0":23.12,Gb0:23.12,G0:24.5,"G#0":25.96,Ab0:25.96,A0:27.5,"A#0":29.14,Bb0:29.14,B0:30.87,C1:32.7,"C#1":34.65,Db1:34.65,D1:36.71,"D#1":38.89,Eb1:38.89,E1:41.2,F1:43.65,"F#1":46.25,Gb1:46.25,G1:49,"G#1":51.91,Ab1:51.91,A1:55,"A#1":58.27,Bb1:58.27,B1:61.74,C2:65.41,"C#2":69.3,Db2:69.3,D2:73.42,"D#2":77.78,Eb2:77.78,E2:82.41,F2:87.31,"F#2":92.5,Gb2:92.5,G2:98,"G#2":103.83,Ab2:103.83,A2:110,"A#2":116.54,Bb2:116.54,B2:123.47,C3:130.81,"C#3":138.59,Db3:138.59,D3:146.83,"D#3":155.56,Eb3:155.56,E3:164.81,F3:174.61,"F#3":185,Gb3:185,G3:196,"G#3":207.65,Ab3:207.65,A3:220,"A#3":233.08,Bb3:233.08,B3:246.94,C4:261.63,"C#4":277.18,Db4:277.18,D4:293.66,"D#4":311.13,Eb4:311.13,E4:329.63,F4:349.23,"F#4":369.99,Gb4:369.99,G4:392,"G#4":415.3,Ab4:415.3,A4:440,"A#4":466.16,Bb4:466.16,B4:493.88,C5:523.25,"C#5":554.37,Db5:554.37,D5:587.33,"D#5":622.25,Eb5:622.25,E5:659.26,F5:698.46,"F#5":739.99,Gb5:739.99,G5:783.99,"G#5":830.61,Ab5:830.61,A5:880,"A#5":932.33,Bb5:932.33,B5:987.77,C6:1046.5,"C#6":1108.73,Db6:1108.73,D6:1174.66,"D#6":1244.51,Eb6:1244.51,E6:1318.51,F6:1396.91,"F#6":1479.98,Gb6:1479.98,G6:1567.98,"G#6":1661.22,Ab6:1661.22,A6:1760,"A#6":1864.66,Bb6:1864.66,B6:1975.53,C7:2093,"C#7":2217.46,Db7:2217.46,D7:2349.32,"D#7":2489.02,Eb7:2489.02,E7:2637.02,F7:2793.83,"F#7":2959.96,Gb7:2959.96,G7:3135.96,"G#7":3322.44,Ab7:3322.44,A7:3520,"A#7":3729.31,Bb7:3729.31,B7:3951.07,C8:4186.01},this.audioContext=new(window.AudioContext||window.webkitAudioContext)({latencyHint:"interactive",sampleRate:48e3}),this.volume=75}playPing(t,e=0,i=.5){if(this.isMuted)return;let s=this.audioContext.createBuffer(2,3*this.audioContext.sampleRate,this.audioContext.sampleRate),a=this.audioContext.createOscillator();a.buffer=s,a.type="sine",a.frequency.value=this.frequencyLookup[t];let h=this.audioContext.createGain();h.gain.setValueAtTime(this.volume/100,this.audioContext.currentTime+e),a.connect(h),h.connect(this.audioContext.destination),a.start(this.audioContext.currentTime+e),h.gain.exponentialRampToValueAtTime(1e-5,this.audioContext.currentTime+e+i),a.stop(this.audioContext.currentTime+e+i)}playPingSequence(t,e,i=.5){let s=0;for(let a=0;a<t.length;a++)this.playPing(t[a],s,i),s+=e/1e3}}class o{constructor(){this.playButton=null,this.deleteSave=null,this.muteButton=null}init(){this.playButton=new c(p.width/2,p.height/2,"Start",()=>{U(1)}),this.deleteSave=new c(p.width/2,p.height-100,"Delete Save",()=>{confirm("Are you sure you want to delete your game save?")&&(W(),alert("Save deleted."),window.location.reload())}),this.deleteSave.width=100,this.deleteSave.height=40,this.deleteSave.fontSize=18,this.deleteSave.buttonColor=e.LightGray,this.deleteSave.buttonHoverColor="crimson",this.deleteSave.textColor=e.DarkGray,this.deleteSave.textHoverColor=e.White;let t=C.mute?"ðŸ”‡":"ðŸ”ˆ";this.muteButton=new c(p.width-50,50,t,()=>{C.mute?this.muteButton.text="ðŸ”ˆ":this.muteButton.text="ðŸ”‡",C.mute=!C.mute,I.isMuted=C.mute}),this.muteButton.width=20,this.muteButton.height=28,this.muteButton.fontSize=18,this.muteButton.buttonColor="transparent",this.muteButton.buttonHoverColor=e.LightGray,I.isMuted=C.mute}update(e){S[t.Enter]&&U(1),this.playButton.update(e),this.deleteSave.update(e),this.muteButton.update(e)}draw(t){this.drawBackground(t),t.fillStyle=e.LightBlue,t.textAlign="center",t.font="48px Trebuchet MS",t.fillText("P4ck3t",p.width/2,Math.max(70,p.height/4)),t.font="22px Trebuchet MS",t.fillText("A js13k game entry",p.width/2,Math.max(100,p.height/4+30)),t.fillText("by EyeOfMidas",p.width/2,Math.max(130,p.height/4+60)),this.playButton.draw(t),this.deleteSave.draw(t),this.muteButton.draw(t)}drawBackground(t){t.fillStyle=e.VeryDarkBlue;for(let e=0;e<p.height/128;e++)for(let i=0;i<p.width/128;i++){let s=Math.sin(45*i+(new Date).getTime()/500);t.save(),t.translate(128*i+10*s,128*e+20*s),t.rotate(Math.PI/180*45),t.beginPath(),t.rect(-s-4,-s-4,2*s+8,2*s+8),t.fill(),t.restore()}}onResize(){this.playButton.x=p.width/2,this.playButton.y=Math.max(200,p.height/2),this.deleteSave.x=p.width/2,this.deleteSave.y=Math.max(333,p.height-100),this.muteButton.x=p.width-50,this.muteButton.y=50}onMouseMove(t){this.playButton.isHovered=!1,document.body.style.cursor="default",this.playButton.isMouseOver(t)&&(this.playButton.isHovered=!0,document.body.style.cursor="pointer"),this.deleteSave.isHovered=!1,this.deleteSave.isMouseOver(t)&&(this.deleteSave.isHovered=!0,document.body.style.cursor="pointer"),this.muteButton.isHovered=!1,this.muteButton.isMouseOver(t)&&(this.muteButton.isHovered=!0,document.body.style.cursor="pointer")}onMouseUp(t){t.preventDefault(),this.playButton.isMouseOver(t)&&(this.playButton.triggerHandler(),document.body.style.cursor="default"),this.deleteSave.isMouseOver(t)&&(this.deleteSave.triggerHandler(),document.body.style.cursor="default"),this.muteButton.isMouseOver(t)&&(this.muteButton.triggerHandler(),document.body.style.cursor="default")}onTouchEnd(t){t.preventDefault(),this.playButton.isTouchOver(t)&&(this.playButton.triggerHandler(),document.body.style.cursor="default"),this.deleteSave.isTouchOver(t)&&(this.deleteSave.triggerHandler(),document.body.style.cursor="default"),this.muteButton.isTouchOver(t)&&(this.muteButton.triggerHandler(),document.body.style.cursor="default")}}class c{constructor(t,i,s,a){this.x=t,this.y=i,this.width=200,this.height=80,this.text=s,this.handler=a,this.isHovered=!1,this.buttonColor=e.DarkBlue,this.buttonHoverColor=e.LightGray,this.textColor=e.LightBlue,this.textHoverColor=e.White,this.fontSize=48,this.fontFamily="Trebuchet MS"}update(t){}draw(t){t.fillStyle=this.buttonColor,this.isHovered&&(t.fillStyle=this.buttonHoverColor),t.textAlign="center",t.font=`${this.fontSize}px ${this.fontFamily}`;let e=t.measureText(this.text);this.width=Math.max(this.width,e.width+8),t.save(),t.translate(this.x,this.y),t.beginPath(),t.rect(-this.width/2,-this.height/2,this.width,this.height),t.fill(),t.fillStyle=this.textColor,this.isHovered&&(t.fillStyle=this.textHoverColor),t.fillText(this.text,0,this.fontSize/3),t.restore()}isMouseOver(t){return t.clientX>this.x-this.width/2&&t.clientX<this.x+this.width-this.width/2&&t.clientY>this.y-this.height/2&&t.clientY<this.y+this.height-this.height/2}isTouchOver(t){let e=parseInt(t.changedTouches[0].clientX),i=parseInt(t.changedTouches[0].clientY);return e>this.x-this.width/2&&e<this.x+this.width-this.width/2&&i>this.y-this.height/2&&i<this.y+this.height-this.height/2}triggerHandler(){this.handler()}}class d{constructor(){this.camera={},this.area={},this.player={},this.rails=[],this.events=[],this.script=[],this.fadeAmount=0}init(){H(),this.camera={x:0,y:0,center:{x:0,y:0},movementSpeed:3},this.area={width:2560,height:2560};var t=[{unlocks:{isVisible:0,isActivated:0,isDamaged:9},path:[{x:896,y:1024,node:10,enter:0},{x:1024,y:1024},{x:1152,y:1152},{x:1280,y:1152,node:10,down:{width:3,height:3,successRail:1,successNode:0},enter:1},{x:1408,y:1024},{x:1536,y:1024,node:10}],pathUnlocks:[{node:5,unlock:3,up:{width:4,height:4,successRail:2,successNode:0}}]},{unlocks:{isVisible:0,isActivated:2,isDamaged:9},path:[{x:1280,y:1182,node:10,up:{width:3,height:4,successRail:0,successNode:3},enter:2},{x:1408,y:1182},{x:1536,y:1280},{x:1664,y:1280,node:10,enter:3}],pathUnlocks:[]},{unlocks:{isVisible:3,isActivated:4,isDamaged:9},path:[{x:1536,y:994,node:10,down:{width:5,height:4,successRail:0,successNode:5},enter:4},{x:1664,y:896},{x:1664,y:768},{x:1792,y:640,node:10,enter:5,up:{width:4,height:5,successRail:3,successNode:0}}],pathUnlocks:[{node:3,unlock:6,down:{width:4,height:6,successRail:4,successNode:0}}]},{unlocks:{isVisible:4,isActivated:6,isDamaged:9},path:[{x:1792,y:610,node:10,enter:6,down:{width:5,height:4,successRail:2,successNode:3}},{x:1920,y:768},{x:2048,y:768},{x:2176,y:896,node:10,enter:7}],pathUnlocks:[]},{unlocks:{isVisible:6,isActivated:8,isDamaged:9},path:[{x:1792,y:670,node:10,up:{width:5,height:4,successRail:2,successNode:3},enter:8},{x:1890,y:798},{x:2048,y:798},{x:2176,y:926},{x:2274,y:1024},{x:2432,y:1024,node:10,enter:9}],pathUnlocks:[{node:5,unlock:9,down:{width:5,height:4,successRail:2,successNode:3}}]},{unlocks:{isVisible:9,isActivated:9,isDamaged:10},path:[{x:2176,y:1152,node:10,enter:10},{x:2304,y:1054},{x:2432,y:1054,node:10}],pathUnlocks:[]},{unlocks:{isVisible:9,isActivated:9,isDamaged:11},path:[{x:1792,y:1280,node:10,down:{width:6,height:4,successRail:7,successNode:4}},{x:1920,y:1280},{x:2048,y:1152},{x:2176,y:1152,node:10}],pathUnlocks:[]},{unlocks:{isVisible:10,isActivated:11,isDamaged:13},path:[{x:1280,y:1408,node:10,enter:12,up:{width:0,height:0,successRail:8,successNode:7}},{x:1408,y:1408},{x:1536,y:1310},{x:1664,y:1310},{x:1792,y:1310,node:10,enter:11}],pathUnlocks:[]},{unlocks:{isVisible:11,isActivated:13},path:[{x:384,y:1536},{x:512,y:1536},{x:640,y:1536},{x:768,y:1536},{x:896,y:1536},{x:1024,y:1536,enter:14},{x:1152,y:1358},{x:1280,y:1358,node:20,enter:13}],pathUnlocks:[]}];this.rails=[];for(let e=0;e<t.length;e++){let i=new u;i.setPath(t[e].path),i.setPathUnlocks(t[e].pathUnlocks),i.unlocks=t[e].unlocks,this.rails.push(i)}let e=this.getRailNode(C.player.rail,C.player.railnode);this.player={x:e.x,y:e.y,width:20,height:20,center:{x:10,y:10},angle:45*Math.PI/180,rotationSpeed:3*Math.PI/180,movementSpeed:3,target:{x:e.x,y:e.y},rail:C.player.rail,railnode:C.player.railnode},this.camera.x=C.camera.x,this.camera.y=C.camera.y;var s=[{lock:0,dialog:[{c:1,s:1,t:"What are you doing here?"},{c:0,s:0,t:"Oh, uh... hello there :D"},{c:1,s:1,t:"What are you looking for?"},{c:0,s:0,t:"I'm here to... pick something up."},{c:1,s:1,t:"Ha! This place is so old you'll never find what you're looking for."}]},{lock:1,dialog:[{c:1,s:1,t:"That connection is broken."},{c:0,s:0,t:"So I can't go this way?"},{c:1,s:1,t:"Not unless you can fix the connection."}]},{lock:2,dialog:[{c:1,s:1,t:"How did you get here?"},{c:0,s:0,t:"I made the thingie light up?"},{c:1,s:1,t:"You can't be here! Stop it."}]},{lock:3,dialog:[{c:0,s:0,t:"Hey, are you there?"},{c:1,s:1,t:"You're still here? What do you want?"},{c:0,s:0,t:"I'm stuck. What do I do now?"},{c:1,s:1,t:"Go away. Go back where you came from. You're not allowed here."}]},{lock:4,dialog:[{c:1,s:1,t:"This is getting tiresome."},{c:0,s:0,t:"I want to see where this goes! ;)"},{c:1,s:1,t:"Nowhere fast."}]},{lock:5,dialog:[{c:1,s:1,t:"You are a persistent little square, aren't you?"},{c:0,s:0,t:"I have to get something. Do you know where I can get it from?"},{c:1,s:1,t:"I might have an idea..."}]},{lock:6,dialog:[]},{lock:7,dialog:[{c:1,s:1,t:"What exactly are you looking for?"},{c:0,s:0,t:"It's a kind of request. I'm not really sure ;)"},{c:1,s:1,t:"Try that other branch. But I'm not making any promises!"}]},{lock:8,dialog:[]},{lock:9,dialog:[{c:1,s:1,t:"Fine. Look. You can have this."},{c:0,s:0,t:"Woah! This is what I was looking for!"},{c:1,s:1,t:"It's not what you think. Plus, you still have to get it out of here."}],teleport:{rail:5,node:3,x:2432,y:1054}},{lock:10,dialog:[{c:1,s:1,t:"Uh oh. Things are shutting down."},{c:0,s:0,t:"Oh no! What should I do?!"},{c:1,s:1,t:"Just get out of here. I might not see you again."}],teleport:{rail:6,node:3,x:2176,y:1152}},{lock:11,dialog:[{c:1,s:1,t:"I'll miss you, you annoying little square."},{c:0,s:0,t:"..."}]},{lock:12,dialog:[{c:0,s:0,t:"I'm at the end! But this connection is much bigger than most..."},{c:0,s:0,t:""},{c:0,s:0,t:"... server?"}]},{lock:13,dialog:[]},{lock:14,dialog:[{c:0,s:0,t:"Goodbye, server!"}]}];this.events=[];for(let t=0;t<s.length;t++){let e=s[t],i=new y(this,e.lock);i.teleport=e.teleport;for(let t=0;t<e.dialog.length;t++)i.addDialog(e.dialog[t].c,e.dialog[t].s,e.dialog[t].t);this.events.push(i)}for(let t=0;t<256;t++)S[t]=!1;k=!1,M=!1,this.updateCamera(0),this.dialog=new i,this.script=[],null!=e.enter&&this.events[e.enter].run(),this.updateRailUnlocks()}updateRailUnlocks(){for(let t=0;t<this.rails.length;t++){let e=this.rails[t];for(let t in e.unlocks)e[t]=0==e.unlocks[t]||C.unlocked.includes(e.unlocks[t]);for(let t=0;t<e.pathUnlocks.length;t++){let i=e.pathUnlocks[t];C.unlocked.includes(i.unlock)&&(i.hasOwnProperty("up")&&(e.vertexes[i.node].up=i.up),i.hasOwnProperty("down")&&(e.vertexes[i.node].down=i.down))}}}getRailNode(t,e){return this.rails[t].getPath()[e]}update(e){if(S[t.Esc]&&(this.saveScene(),U(0)),this.updateBackground(e),this.script.length>0)return this.dialog.display(this.script[0].character,this.script[0].side,this.script[0].text),this.dialog.update(e),void((S[t.Space]||S[t.Enter])&&(this.advanceScript(),S[t.Space]=!1,S[t.Enter]=!1));this.dialog.hide(),C.unlocked.includes(14)&&(this.fadeAmount+=.01,this.fadeAmount>=1.5&&U(3)),this.updatePlayer(e),this.updateRails(e)}draw(t){t.save(),t.translate(-this.camera.x+E.x,-this.camera.y+E.y),this.drawBackground(t),this.drawRail(t),this.drawPlayer(t),t.restore(),t.fillStyle=`rgba(0,0,0,${this.fadeAmount})`,t.beginPath(),t.rect(0,0,p.width,p.height),t.fill(),this.dialog.draw(t)}saveScene(){C.player.rail=this.player.rail,C.player.railnode=this.player.railnode,C.camera.x=this.camera.x,C.camera.y=this.camera.y,G(),this.updateRailUnlocks()}updateCamera(t){let e=(this.player.x-this.camera.x)/p.width;e<.3&&(this.camera.x=this.player.x-.3*p.width),e>.7&&(this.camera.x=this.player.x-.7*p.width);let i=(this.player.y-this.camera.y)/p.height;i<.3&&(this.camera.y=this.player.y-.3*p.height),i>.7&&(this.camera.y=this.player.y-.7*p.height)}updateBackground(t){}drawBackground(t){t.fillStyle=e.VeryDarkBlue;for(let e=0;e<this.area.height/128;e++)for(let i=0;i<this.area.width/128;i++){let s=Math.sin(45*i+(new Date).getTime()/1e3);C.unlocked.includes(9)&&(s=Math.sin(45*i+(new Date).getTime()/200),t.fillStyle=`rgb(${140+20*s}, 20, 60)`),t.save(),t.translate(128*i+5*s,128*e+10*s),t.rotate(Math.PI/180*45),t.beginPath(),t.rect(-s-4,-s-4,2*s+8,2*s+8),t.fill(),t.restore()}}updateRails(t){for(let e=0;e<this.rails.length;e++){let i=this.rails[e];i.isVisible&&i.update(t)}}drawRail(t){t.lineWidth=4;for(let e=0;e<this.rails.length;e++){let i=this.rails[e];i.isVisible&&i.draw(t)}}updatePlayer(e){let i=!1,s=this.getRailNode(this.player.rail,this.player.railnode-1),a=this.getRailNode(this.player.rail,this.player.railnode+1);if((S[t.W]||S[t.Up])&&(this.jumpUpRail(),i=!0),(S[t.S]||S[t.Down])&&(this.jumpDownRail(),i=!0),S[t.Enter]){let t=this.getRailNode(this.player.rail,this.player.railnode);null!=t.up?this.jumpUpRail():null!=t.down&&this.jumpDownRail()}if(this.player.x==this.player.target.x&&this.player.y==this.player.target.y&&((S[t.A]||S[t.Left])&&(this.moveToPreviousNode(),i=!0),(S[t.D]||S[t.Right]&&a)&&(this.moveToNextNode(),i=!0)),Math.abs(this.player.x-this.player.target.x)<=this.player.movementSpeed&&(this.player.x=this.player.target.x),Math.abs(this.player.y-this.player.target.y)<=this.player.movementSpeed&&(this.player.y=this.player.target.y),s&&this.player.x==s.x&&this.player.y==s.y){this.player.railnode--,this.saveScene();let t=this.getRailNode(this.player.rail,this.player.railnode);t.node||this.moveToPreviousNode(),null!=t.enter&&this.events[t.enter].run()}if(a&&this.player.x==a.x&&this.player.y==a.y){this.player.railnode++,this.saveScene();let t=this.getRailNode(this.player.rail,this.player.railnode);t.node||this.moveToNextNode(),null!=t.enter&&this.events[t.enter].run()}if(this.player.target.x!=this.player.x||this.player.target.y!=this.player.y){let t=Math.atan2(this.player.target.y-this.player.y,this.player.target.x-this.player.x);this.player.x+=this.player.movementSpeed*Math.cos(t),this.player.y+=this.player.movementSpeed*Math.sin(t),i=!0}this.player.x>this.area.width-this.player.width/2&&(this.player.x=this.area.width-this.player.width/2,this.player.target.x=this.player.x),this.player.x<0+this.player.width/2&&(this.player.x=this.player.width/2,this.player.target.x=this.player.x),this.player.y>this.area.height-this.player.height/2&&(this.player.y=this.area.height-this.player.height/2,this.player.target.y=this.player.y),this.player.y<0+this.player.height/2&&(this.player.y=this.player.height/2,this.player.target.y=this.player.y),i&&this.updateCamera(e)}moveToPreviousNode(){let t=this.getRailNode(this.player.rail,this.player.railnode-1);t&&(this.player.target.x=t.x,this.player.target.y=t.y)}moveToNextNode(){let t=this.getRailNode(this.player.rail,this.player.railnode+1);t&&(this.player.target.x=t.x,this.player.target.y=t.y)}jumpUpRail(){let t=this.getRailNode(this.player.rail,this.player.railnode);if(null!=t.up){let e=t.up;A=e,this.saveScene(),U(2)}}jumpDownRail(){let t=this.getRailNode(this.player.rail,this.player.railnode);if(null!=t.down){let e=t.down;A=e,this.saveScene(),U(2)}}drawPlayer(t){t.save(),t.fillStyle=e.LightBlue,t.translate(this.player.x,this.player.y),t.rotate(this.player.angle),t.beginPath(),t.rect(-this.player.center.x,-this.player.center.y,this.player.width,this.player.height),t.fill(),t.restore()}onResize(){this.camera.center.x=p.width/2,this.camera.center.y=p.height/2,this.dialog.onResize()}onMouseUp(t){if(M&&(M=!1,k=!0,this.camera.x-=E.x,this.camera.y-=E.y),Math.abs(E.x)>0||Math.abs(E.y)>0)return E.x=0,void(E.y=0);this.script.length>0?this.advanceScript():this.player.x==this.player.target.x&&this.player.y==this.player.target.y&&(Math.abs(this.camera.x+t.clientX-this.player.x)>Math.abs(this.camera.y+t.clientY-this.player.y)?this.camera.x+t.clientX>this.player.x?this.moveToNextNode():this.camera.x+t.clientX<this.player.x&&this.moveToPreviousNode():this.camera.y+t.clientY>this.player.y?this.jumpDownRail():this.camera.y+t.clientY<this.player.y&&this.jumpUpRail())}advanceScript(){this.script.shift(),this.script.length>0?this.dialog.characters[this.script[0].character].speak():this.updateRailUnlocks()}onMouseMove(t){M&&(E.x=t.clientX-P.x,E.y=t.clientY-P.y)}onMouseDown(t){if(0==t.button)return M=!0,P.x=t.clientX,P.y=t.clientY,E.x=0,E.y=0,void(P.time=(new Date).getUTCMilliseconds());k=!1}onRightClick(t){t.preventDefault()}onTouchStart(t){P.x=parseInt(t.targetTouches[0].clientX),P.y=parseInt(t.targetTouches[0].clientY),E.x=0,E.y=0,P.time=(new Date).getUTCMilliseconds(),k=!1}onTouchMove(t){M=!0,E.x=parseInt(t.targetTouches[0].clientX)-P.x,E.y=parseInt(t.targetTouches[0].clientY)-P.y}onTouchEnd(t){if(0==t.touches.length){if(M)return M=!1,k=!0,this.camera.x-=E.x,this.camera.y-=E.y,E.x=0,void(E.y=0);if(!M&&!k){if(this.script.length>0)return;if(this.player.x!=this.player.target.x||this.player.y!=this.player.target.y)return;let e=parseInt(t.changedTouches[0].clientX),i=parseInt(t.changedTouches[0].clientY);Math.abs(this.camera.x+e-this.player.x)>Math.abs(this.camera.y+i-this.player.y)?this.camera.x+e>this.player.x?this.moveToNextNode():this.camera.x+e<this.player.x&&this.moveToPreviousNode():this.camera.y+i>this.player.y?this.jumpDownRail():this.camera.y+i<this.player.y&&this.jumpUpRail()}}}}class u{constructor(){this.vertexes=[],this.isVisible=!1,this.isActivated=!1,this.isDamaged=!1,this.activationUnlock=0,this.visibleUnlock=0,this.unlocks={isVisible:0,isActivated:0},this.pathUnlocks=[],this.damagedFade={r:200,g:20,b:60}}setPath(t){this.vertexes=t}getPath(){return this.vertexes}setPathUnlocks(t){this.pathUnlocks=t}update(t){this.damagedFade.r=200+40*Math.sin((new Date).getTime()/100)}draw(t){t.strokeStyle=e.DarkBlue,this.isActivated&&!this.isDamaged?t.strokeStyle=e.LightBlue:this.isActivated&&this.isDamaged&&(t.strokeStyle=`rgb(${this.damagedFade.r}, ${this.damagedFade.g}, ${this.damagedFade.b})`);for(let e=0;e<this.vertexes.length-1;e++){let i=this.vertexes[e],s=this.vertexes[e+1],a=i.node,h=s.node;i.node&&(t.beginPath(),this.isActivated&&(a=i.node-0),t.arc(i.x,i.y,a,0,2*Math.PI),t.stroke()),t.beginPath();let r=-Math.atan2(i.x-s.x,i.y-s.y)-90*Math.PI/180;i.node?t.moveTo(i.x+a*Math.cos(r),i.y+a*Math.sin(r)):t.moveTo(i.x,i.y),s.node?(this.isActivated&&(h=s.node-0),t.lineTo(s.x-h*Math.cos(r),s.y-h*Math.sin(r))):t.lineTo(s.x,s.y),t.stroke()}let i=this.vertexes[this.vertexes.length-1];if(i.node){let e=i.node;this.isActivated&&(e=i.node-0),t.beginPath(),t.arc(i.x,i.y,e,0,2*Math.PI),t.stroke()}}}class y{constructor(t,e){this.container=t,this.lock=e,this.script=[],this.teleport=null}addDialog(t,e,i){this.script.push({character:t,side:e,text:i})}run(){this.teleport&&(this.container.player.rail=this.teleport.rail,this.container.player.railnode=this.teleport.node,this.container.player.target.x=this.teleport.x,this.container.player.target.y=this.teleport.y),C.unlocked.includes(this.lock)||(this.container.script=this.container.script.concat(this.script),this.container.script.length>0&&this.container.dialog.characters[this.script[0].character].speak(),C.unlocked.push(this.lock))}}class g{constructor(){this.board={width:7,height:8,offset:{x:100,y:100},tileSize:{width:50,height:50}},this.tiles=[],this.pathTiles=[],this.isWon=!1,this.splashText=null,this.splashTextTweenId=-1}init(){this.isWon=!1,this.tiles=[];let t=Math.floor(p.width/(this.board.tileSize.width+3))-3,i=Math.floor(p.height/(this.board.tileSize.height+3))-3;this.board={width:Math.floor(t*Math.random())+2,height:Math.floor(i*Math.random())+2,offset:{x:100,y:100},tileSize:{width:50,height:50}},this.board.width=t,this.board.height=i,A.width>0&&(this.board.width=A.width),A.height>0&&(this.board.height=A.height),this.board.offset={x:p.width/2-this.board.width*this.board.tileSize.width/2,y:p.height/2-this.board.height*this.board.tileSize.height/2};for(let t=0;t<this.board.height;t++)for(let e=0;e<=this.board.width;e++)this.tiles.push(new b(this.board,e,t));this.buildPath(),this.splashText=new r("Connected!",-p.width-200,p.height/2),this.cancelPuzzle=new c(p.width-100,50,"Back",()=>{U(1)}),this.cancelPuzzle.width=100,this.cancelPuzzle.height=40,this.cancelPuzzle.fontSize=18,this.cancelPuzzle.buttonColor=e.LightGray,this.cancelPuzzle.buttonHoverColor=e.DarkGray,this.cancelPuzzle.textColor=e.DarkGray,this.cancelPuzzle.textHoverColor=e.White}buildPath(){this.pathTiles=[];let t=[];t=this.board.width>=this.board.height?this.tiles.filter(t=>0==t.x):this.tiles.filter(t=>0==t.y);let e=t[Math.floor(t.length*Math.random())];this.pathTiles.push(e);let i=[];for(;this.isEndingConditionMet(e);){let t=this.tiles.filter(t=>this.isValidNearby(t,e,i));if(0==t.length){this.pathTiles.splice(this.pathTiles.findIndex(t=>t==e),1),i.push(e),e=this.pathTiles[this.pathTiles.length-1];continue}let s=t[Math.floor(t.length*Math.random())];e=s,this.pathTiles.push(e)}let s=this.pathTiles[0],a=this.pathTiles[1];s.piece=T.Node,s.isPowered=!0,s.x<a.x&&s.y==a.y?s.goal=[90]:s.x==a.x&&s.y<a.y?s.goal=[180]:s.x==a.x&&s.y>a.y?s.goal=[0]:s.x>a.x&&s.y==a.y&&(s.goal=[270]),s.targetRadians=s.goal[0]*(Math.PI/180);for(let t=1;t<this.pathTiles.length-1;t++){let e=this.pathTiles[t-1],i=this.pathTiles[t],s=this.pathTiles[t+1];if(i.piece=T.Straight,e.x==s.x&&e.y!=s.y)i.goal=[0,180];else if(e.x!=s.x&&e.y==s.y)i.goal=[90,270];else if(e.x!=s.x&&e.y!=s.y){i.piece=T.Corner;let t=[e.x-i.x,e.y-i.y].join(", "),a=[s.x-i.x,s.y-i.y].join(", ");"0, -1"==t&&"-1, 0"==a||"0, -1"==a&&"-1, 0"==t?i.goal=[0]:"0, -1"==t&&"1, 0"==a||"0, -1"==a&&"1, 0"==t?i.goal=[90]:"1, 0"==t&&"0, 1"==a||"1, 0"==a&&"0, 1"==t?i.goal=[180]:("-1, 0"==t&&"0, 1"==a||"-1, 0"==a&&"0, 1"==t)&&(i.goal=[270])}}let h=this.pathTiles[this.pathTiles.length-2],r=this.pathTiles[this.pathTiles.length-1];r.piece=T.Node,r.x>h.x&&r.y==h.y?r.goal=[270]:r.x==h.x&&r.y<h.y?r.goal=[180]:r.x==h.x&&r.y>h.y?r.goal=[0]:r.x<h.x&&r.y==h.y&&(r.goal=[90])}isEndingConditionMet(t){return this.board.width>=this.board.height?t.x<=this.board.width-1:t.y<this.board.height-1}isValidNearby(t,e,i){return!i.includes(t)&&(!this.pathTiles.includes(t)&&(t.x==e.x&&t.y==e.y-1||(t.x==e.x-1&&t.y==e.y||(t.x==e.x&&t.y==e.y+1||t.x==e.x+1&&t.y==e.y))))}update(e){Tween.update();for(let t in this.tiles)this.tiles[t].update(e);if(S[t.Esc]&&U(1),this.isWon)return this.splashText.update(e),void(S[t.Enter]&&(Tween.cancel(this.splashTextTweenId),U(1)));this.clearPower(),this.calculatePower(this.pathTiles[0]),this.pathTiles[this.pathTiles.length-1].isPowered&&(this.isWon=!0,C.player.rail=A.successRail,C.player.railnode=A.successNode,G(),I.playPingSequence(["E6","C6","C6","C6","C7"],75),this.splashTextTweenId=Tween.create(this.splashText,{x:p.width/2},2e3,Tween.Easing.Elastic.EaseOut,()=>{setTimeout(()=>{U(1)},750)})),this.cancelPuzzle.update(e)}draw(t){this.drawBackground(t);for(let e in this.tiles)this.tiles[e].draw(t);this.isWon?this.splashText.draw(t):this.cancelPuzzle.draw(t)}drawBackground(t){t.fillStyle=e.VeryDarkBlue;for(let e=0;e<p.height/128;e++)for(let i=0;i<p.width/128;i++){let s=Math.sin(45*i+(new Date).getTime()/500);t.save(),t.translate(128*i+10*s,128*e+20*s),t.rotate(Math.PI/180*45),t.beginPath(),t.rect(-s-4,-s-4,2*s+8,2*s+8),t.fill(),t.restore()}}clearPower(){for(let t=0;t<this.tiles.length;t++)this.tiles[t].isPowered=!1}calculatePower(t,e){if(!t.canReceivePower(e))return;t.isPowered=!0;let i=t.getPoweringTileCoordinates();for(let e=0;e<i.length;e++){let s=this.tiles.find(s=>s.x==i[e][0]+t.x&&s.y==i[e][1]+t.y&&!s.isPowered);s&&this.calculatePower(s,t)}}onResize(){this.board.offset={x:p.width/2-this.board.width*this.board.tileSize.width/2,y:p.height/2-this.board.height*this.board.tileSize.height/2}}onKeyUp(e){S[t.W]&&this.pathTiles.forEach(t=>{t.targetRadians=t.goal[0]*(Math.PI/180),t.targetRadians%=Math.PI/180*360})}onMouseUp(t){if(this.isWon)return Tween.cancel(this.splashTextTweenId),void U(1);let e=this.tiles.find(e=>e.isMouseOver(t));e&&(this.tiles.splice(this.tiles.findIndex(t=>t==e),1),this.tiles.push(e),e.targetRadians+=Math.PI/180*90,e.targetRadians%=Math.PI/180*360,I.playPing("C6",0,.1)),this.cancelPuzzle.isMouseOver(t)&&(this.cancelPuzzle.triggerHandler(),document.body.style.cursor="default")}onMouseMove(t){if(this.isWon)return;for(let t in this.tiles)this.tiles[t].isHovered=!1;this.cancelPuzzle.isHovered=!1,document.body.style.cursor="default",this.cancelPuzzle.isMouseOver(t)&&(this.cancelPuzzle.isHovered=!0,document.body.style.cursor="pointer");let e=this.tiles.find(e=>e.isMouseOver(t));e&&(e.isHovered=!0)}onTouchEnd(t){this.cancelPuzzle.isTouchOver(t)&&(t.preventDefault(),this.cancelPuzzle.triggerHandler(),document.body.style.cursor="default")}onRightClick(t){t.preventDefault()}}var p,w,x,m,f,T={Blank:0,Straight:1,Corner:2,Tee:3,Cross:4,Node:5};class b{constructor(t,e,i){this.x=e,this.y=i,this.width=t.tileSize.width,this.height=t.tileSize.height,this.center={x:t.tileSize.width/2,y:t.tileSize.height/2},this.radians=90*Math.floor(4*Math.random())*(Math.PI/180),this.targetRadians=90*Math.floor(4*Math.random())*(Math.PI/180),this.goal=[],this.piece=Math.floor(5*Math.random()),this.board=t,this.isHovered=!1,this.isPowered=!1,this.powerPellets=[]}update(t){this.targetRadians!=this.radians&&(this.radians+=Math.PI/180*9,this.radians%=Math.PI/180*360)}draw(t){switch(t.fillStyle=e.DarkGray,t.strokeStyle=e.DarkGray,this.isHovered&&(t.strokeStyle=e.LightGray),t.save(),t.translate(this.x*this.width+this.board.offset.x+3*this.x,this.y*this.height+this.board.offset.y+3*this.y),t.rotate(this.radians),t.beginPath(),t.rect(-this.center.x,-this.center.y,this.width,this.height),t.fill(),t.stroke(),t.fillStyle=e.DarkBlue,t.strokeStyle=e.DarkBlue,t.lineWidth=4,this.isPowered&&(t.fillStyle=e.LightBlue,t.strokeStyle=e.LightBlue),this.piece){case T.Straight:t.beginPath(),t.rect(-2,-this.center.y,4,this.height),t.fill();break;case T.Corner:t.beginPath(),t.rect(-2,-this.center.y,4,2+this.height/2),t.fill(),t.beginPath(),t.rect(-this.center.x,-2,2+this.width/2,4),t.fill();break;case T.Tee:t.beginPath(),t.rect(-2,-this.center.y,4,this.height),t.fill(),t.beginPath(),t.rect(-this.center.x,-2,2+this.width/2,4),t.fill();break;case T.Cross:t.beginPath(),t.rect(-2,-this.center.y,4,this.height),t.fill(),t.beginPath(),t.rect(-this.center.x,-2,this.width,4),t.fill();break;case T.Node:t.beginPath(),t.rect(-2,-this.center.y,4,4+this.height/4),t.fill(),t.beginPath(),t.arc(0,0,8,0,2*Math.PI),t.stroke();break;case T.Blank:}t.restore()}isMouseOver(t){let e=t.clientX-this.board.offset.x-3*this.x+this.center.x,i=t.clientY-this.board.offset.y-3*this.y+this.center.y,s=Math.floor(e/this.width),a=Math.floor(i/this.height);return this.x==s&&this.y==a}getPoweringTileCoordinates(){let t=[];switch(this.piece){case T.Straight:switch(this.radians*(180/Math.PI)){case 0:case 180:t.push([0,-1]),t.push([0,1]);break;case 90:case 270:t.push([-1,0]),t.push([1,0])}break;case T.Corner:switch(this.radians*(180/Math.PI)){case 0:t.push([-1,0]),t.push([0,-1]);break;case 90:t.push([0,-1]),t.push([1,0]);break;case 180:t.push([1,0]),t.push([0,1]);break;case 270:t.push([-1,0]),t.push([0,1])}break;case T.Tee:switch(this.radians*(180/Math.PI)){case 0:t.push([0,1]),t.push([-1,0]),t.push([0,-1]);break;case 90:t.push([-1,0]),t.push([0,-1]),t.push([1,0]);break;case 180:t.push([0,-1]),t.push([1,0]),t.push([0,1]);break;case 270:t.push([1,0]),t.push([0,1]),t.push([-1,0])}break;case T.Cross:t.push([0,-1]),t.push([0,1]),t.push([-1,0]),t.push([1,0]);break;case T.Node:switch(this.radians*(180/Math.PI)){case 0:t.push([0,-1]);break;case 90:t.push([1,0]);break;case 180:t.push([0,1]);break;case 270:t.push([-1,0])}break;case T.Blank:}return t}canReceivePower(t){if(!t)return!0;let e=this.getPoweringTileCoordinates();for(let i=0;i<e.length;i++)if(t.x==e[i][0]+this.x&&t.y==e[i][1]+this.y)return!0;return!1}}var v={x:0,y:0,center:{x:0,y:0},movementSpeed:3},M=!1,k=!1,P={x:0,y:0},E={x:0,y:0},S=[],I=new l,B=[];B.push(new o),B.push(new d),B.push(new g),B.push({init:()=>{document.getElementById("game").style.display="none",document.getElementById("endgame").style.display="block",W()},update:t=>{},draw:t=>{}});var D=B[0],C={player:{rail:0,railnode:0},camera:{x:1280,y:1280},unlocked:[],mute:!1},A={width:0,height:0,successRail:0,successNode:0};function N(){w.save(),w.translate(.5,.5),F(w),w.restore(),requestAnimationFrame(N)}function R(t){t.clearRect(0,0,p.width,p.height)}function z(){x=(new Date).getUTCMilliseconds(),S=[];for(let t=0;t<256;t++)S[t]=!1;f=0,U(0)}function U(t){document.getElementById("debugger-output").innerHTML="";try{B[t].init()}catch(t){return console.error("Something went wrong while changing state:",t),void(document.getElementById("debugger-output").innerHTML=t.toString())}D=B[t],j()}function O(t){D.update(t)}function F(t){L(D,"clearFrame")?D.clearFrame(t):R(t),D.draw(t)}function L(t,e){return"function"==typeof t[e]}function G(){localStorage.setItem("eyeofmidas404",JSON.stringify(C))}function H(){let t=localStorage.getItem("eyeofmidas404");t||(G(),t=JSON.stringify(C)),C=JSON.parse(t)}function W(){localStorage.removeItem("eyeofmidas404")}function j(){let t=window.devicePixelRatio;p.width=p.clientWidth,p.height=p.clientHeight,(w=p.getContext("2d")).width=p.clientWidth/t,w.height=p.clientHeight/t,L(D,"onResize")&&D.onResize()}function V(t){S[t.keyCode]=!0,L(D,"onKeyDown")&&D.onKeyDown(t)}function _(t){L(D,"onKeyUp")&&D.onKeyUp(t),S[t.keyCode]=!1}function Y(t){L(D,"onMouseMove")&&D.onMouseMove(t)}function q(t){L(D,"onMouseDown")&&D.onMouseDown(t)}function Q(t){L(D,"onMouseUp")&&D.onMouseUp(t)}function X(t){L(D,"onRightClick")&&D.onRightClick(t)}function $(t){L(D,"onTouchStart")&&D.onTouchStart(t)}function K(t){L(D,"onTouchMove")&&D.onTouchMove(t)}function J(t){L(D,"onTouchEnd")&&D.onTouchEnd(t)}document.addEventListener("DOMContentLoaded",t=>{p=document.createElement("canvas"),document.getElementById("game").appendChild(p),z(),N(),m=setInterval(()=>{let t=(new Date).getUTCMilliseconds();O(1+(t-x)/1e3),x=t},16)}),window.addEventListener("resize",j),window.addEventListener("keydown",V),window.addEventListener("keyup",_),window.addEventListener("mousedown",q),window.addEventListener("mousemove",Y),window.addEventListener("mouseup",Q),window.addEventListener("contextmenu",X),window.addEventListener("touchstart",$),window.addEventListener("touchmove",K),window.addEventListener("touchend",J);