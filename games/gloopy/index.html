<!doctype html><title>Gloopy</title><style>body,html{margin:0;padding:0;height:100%}#gloopy{height:100%}#gloopy a{color:#fff}#gloopy .fs{width:100%;height:100%;top:0;left:0;position:absolute;display:block}#gloopy #controls{font-family:sans-serif;background-color:#123;color:#eee;text-align:center;width:22em;left:25%;padding:0 2em;overflow:auto}#gloopy #controls button{font-size:x-large}</style><div id=gloopy><canvas class=fs id=back></canvas><canvas class=fs id=front></canvas><div id=controls class=fs><h1>Gloopy</h1><fieldset><legend>Controls</legend><table style=width:100%><tr><td>Up Arrow / W<td>Forward<tr><td>Down Arrow / S<td>Backwards<tr><td>Left Arrow / Q<td>Turn Left<tr><td>Right Arrow / E<td>Turn Right<tr><td>A<td>Strafe Left<tr><td>D<td>Strafe Right</table></fieldset><fieldset><legend>Map</legend><div id=mapPreviews></div></fieldset><fieldset><legend>Options</legend><label><input id=numCPUs type=number style=width:3em value=5>Opponents (1-13)</label><br><label><input id=startPoints type=number style=width:3em value=10>Starting points (1-20)</label><br><label><input id=fastRaycast type=checkbox checked>Use fast raycaster</label></fieldset><button id=startGame>Start Game</button></div></div><script>!function(n,r){function i(t,n,r){for(var i=0,e=t[w];i<e;++i)n.call(r||this,t[i],i,t)}function e(t){return t*Math.PI/180}function o(t){return t<0?-t:t}function a(t,n,r){return function(t,n){return t>n?t:n}(function(t,n){return t<n?t:n}(t,n||0),r||0)}function s(t){return t*t}function u(t,n,r,i){return C(s(r-t)+s(i-n))}function h(t){return r.getElementById(t)}function c(t){var n={},r=[],i=t||1/0;return function(t,e){return e?(n[t]=e,r.push(e),r[w]>i&&delete n[r.shift()],e):n[t]}}function f(t,n,r,i){return this.constructor==f?(this.r=t,this.g=n,this.b=r,this.a=void 0!==i?i:1,this):new f(t,n,r,i)}function v(t){var n=S("canvas");n.width=n.height=p,n.style.width=n.style.height="50px",n.style.margin="3px";var r=n.getContext("2d");r.fillStyle="#FFFFFF",r.fillRect(0,0,p,p);var i={rect:function(t,n,i,e){r.fillStyle="#000000";for(var o=0|t;o<t+i;o++)for(var a=0|n;a<n+e;a++)r.fillRect(o,a,1,1)}};return t(i,p),n}function l(n){function r(n,r){k.push(this),this.points=[],this.clr=n,this.s=0,this.l=0,this.t=0,this.v=-D/2;var i=b,e=b/2;do{this.x=i+T()*(p-30),this.y=i+T()*(p-30)}while(void 0!==l.get(this.x,this.y)||void 0!==l.get(this.x+e,this.y+e)||void 0!==l.get(this.x+e,this.y-e)||void 0!==l.get(this.x-e,this.y+e)||void 0!==l.get(this.x-e,this.y-e));l.rect(this.x-e,this.y-e,i,i,n,this),this.points=A(this.points),this.points.transfer=function(t,n,r){for(var i=0,e=this[w];i<e;i++){var o=this[i];if(o.x==t&&o.y==n){o.c.player=r,r.points.push(this.splice(i,1)[0]);break}}},this.tick=function(){var n=(new Date).getTime();return function(i){r.call(this),t=(i-n)/40,n=i,this.playerMove(t),this.pointMove(t)}}()}function o(){var t=[];i(k,(function(n){n.points[w]>0&&t.push(n)})),1===t[w]&&(t[0]===C?alert("Yay! You won!"):alert("Oh noes! You lost."),function(){var t;G=!1,N.style.display="block";for(;t=m.pop();)clearInterval(t)}())}(n=n||{}).numCPUs=n.numCPUs||2,n.fastRaycast=void 0===n.fastRaycast||n.fastRaycast,n.map=n.map||E;var c=function(){var t=h("back");return t.width=U().width/1.5,t.height=1,t.getContext("2d")}(),v=function(){var t=h("front"),n=U().width/U().height;return t.width=100*n,t.height=100,t.getContext("2d")}(),l=function(){for(var t=p-1,r=p-1,i=[],e=0;e<=t;e++){var o=[];i.push(o);for(var a=0;a<=r;a++)0==e||e==t||0==a||a==r?o.push(null):o.push(void 0)}var s=function(){function t(t,n,r,i,e){var o=i?1:-1,a=o*r,s=i?Math.ceil(t):0|t,h=n+(s-t)*r,c=[];for(c.dist=1/0;s>=0&&s<p&&h>=0&&h<p;){var f=e[s+(i?0:-1)|0][0|h];if(null===f){c.dist=u(t,n,s,h);break}c.push({x:s,y:h,r:f}),s+=o,h+=a}return c}function n(t,n,r,i,e){var o=i?-1:1,a=o*r,s=i?0|n:Math.ceil(n),h=t+(s-n)*r,c=[];for(c.dist=1/0;h>=0&&h<p&&s>=0&&s<p;){var f=e[0|h][s+(i?-1:0)|0];if(null===f){c.dist=u(t,n,h,s);break}c.push({x:h,y:s,r:f}),h+=a,s+=o}return c}return function(r,e,o){(o%=H)<0&&(o+=H);var a=o>.75*H||o<.25*H,s=o<0||o>D,h=R(o),c=I(o),f=t(r,e,c/h,a,i),v=n(r,e,h/c,s,i),l=Math.min(f.dist,v.dist),p=f.concat(v),y=a?1:-1,d=s?1:-1;p.sort((function(t,n){return y*(n.x-t.x)-d*(n.y-t.y)}));for(var g=0;g<p[w];g++){var x=p[g];u(r,e,x.x,x.y)>l?(p.splice(g,1),g--):p[g]=x.r}return{x:r,y:e,v:o,dist:l,ray:p}}}();return{get:function(t,n){return i[t|t][n|n]},set:function(t,n,r){i[t|t][n|n]=r},width:function(){return t},height:function(){return r},rect:function(t,n,r,e,o,a){o=o||null;for(var s=0|t;s<t+r;s++)for(var u=0|n;u<n+e;u++)o&&a&&((o=o.clone()).player=a,a.points.push({x:s,y:u,c:o})),i[s][u]=o},ray:n.fastRaycast?function(t,n,r){for(var i=[],e=Math.cos(r),o=Math.sin(r),a=0,s=this.get(t,n);a<M&&null!==s;a++,s=this.get(t+=e,n+=o))i.push(s);return{x:t,y:n,v:r,dist:a,ray:i.reverse()}}:s}}();n.map(l,p);var k=[];r.prototype.playerMove=function(t){var n=e(90);this.v+=this.t/(2*H)*t,this.v%=H,this.v<0&&(this.v+=H);var r=this.x,i=this.y,o=this.s,s=this.l,u=this.v;r=a(r+(o*R(u)+s*R(u+n))*t,l.width()),i=a(i+(o*I(u)+s*I(u+n))*t,l.height()),null!==l.get(r,i)?(this.x=r,this.y=i):null!==l.get(this.x,i)?this.y=i:null!==l.get(r,this.y)&&(this.x=r)},r.prototype.pointMove=function(t){var n=this.points[w],r=this.x,i=this.y,e=this.clr,o=t*n|0;o>2*n&&(o=2*n);for(var a=!1;o>0;o-=1,a=!1){for(var s=this.points.shift(),h=u(s.x,s.y,r,i),c=A([s.x-1,s.x,s.x+1]),f=A([s.y-1,s.y,s.y+1]),v=0,l=c[v];!a&&v<3;l=c[++v])for(var p=0,y=f[p];!a&&p<3;y=f[++p])a=this.pointMoveLogic(s,r,i,l,y,h,e);this.points.push(s)}},r.prototype.pointMoveLogic=function(t,n,r,i,e,o,a){if(u(i,e,n,r)<=o){if(void 0===(px=l.get(i,e)))return l.set(i,e,l.get(t.x,t.y)),l.set(t.x,t.y,void 0),t.x=i,t.y=e,!0;if(px){var s=px.hslMix(t.c.hslMix(a,.9),.5);return px.r=s.r,px.g=s.g,px.b=s.b,px.player!==this&&px.closestTo(px.player.clr,a)===a&&px.player.points.transfer(i,e,this),!0}}return!1},r.prototype.move=function(t){this.s=a((t+this.s)/2,1,-1)},r.prototype.strafe=function(t){this.l=a((t+this.l)/2,1,-1)},r.prototype.turn=function(t){this.t=a((t+this.t)/2,1,-1)};var C=new r(f.fromArray(d),(function(){var t=F;(t.UP||t.W)&&this.move(1),(t.DOWN||t.S)&&this.move(-1),t.UP||t.DOWN||t.W||t.S||this.move(0),t.A&&this.strafe(-1),t.D&&this.strafe(1),!t.A&&!t.D&&this.strafe(0),(F.LEFT||F.Q)&&this.turn(-1),(F.RIGHT||F.E)&&this.turn(1),t.LEFT||t.RIGHT||t.Q||t.E||this.turn(0)})),S=g.slice(0,n.numCPUs);for(var W in S)S[W]=new r(f.fromArray(S[W]),function(){function t(){for(var t=A(k),i=0;i<t[w]&&!((n=t[i])!==r&&n.points[w]>0);i++);}var n,r,i=0,e=0,o=0;return m.push(setInterval((function(){(!n||0==n.points[w]||T()<.13)&&t();for(var a,u=n.points.slice(0,13),h=0,c=0,f=0;a=u.pop();)h+=a.x,c+=a.y,f++;var v=h/f-r.x,l=c/f-r.y,y=P(l,v),d=P(I(y-r.v),R(y-r.v));i=(s(v)+s(l))/p,e=T()-.5,o=d>0?1:-1}),420)),function(){r=this,this.move(i),this.strafe(e),this.turn(o)}}());var L=function(t){var n=f(.96,.98,.99,1),r=f(.04,.02,.02,1),i=c;return function(){for(var e=y/c.canvas.width,o=t.v-y/2,a=t.v+y/2,s=i.getImageData(0,0,i.canvas.width,1),u=s.data,h=0,f=0,v=o;v<=a;f++,v+=e){for(var p,d=l.ray(t.x,t.y,v),g=r.rgbMix(n,d.dist/M),x=0,m=d.ray[w];x<m;x++)(p=d.ray[x])&&(g=g.rgbMix(p,.25));g=g.toArray();for(var b=0;b<4;b++)u[4*f+b]=g[b];h=Math.max(50,h,d.dist)}i.putImageData(s,0,0),M=h+10}}(C),O=function(t){var n=v,r=n.canvas.width,i=n.canvas.height,e=r/2,o=i/2;return function(){n.clearRect(0,0,r,i),function(){n.fillStyle="white";for(var s=n.getImageData(0,0,r,i),u=s.data,h=0,c=t.y-o;c<t.y+o;c++)for(x=t.x-e;x<t.x+e;x++,h++)for(var f=l.get(a(x,l.width()),a(c,l.height())),v=!!f&&f.toArray(),p=0;p<4;p++)u[4*h+p]=null===f?255:v?v[p]:0;n.putImageData(s,0,0)}(),function(a){var s=a.x-t.x+e,u=a.y-t.y+o;s>0&&s<r&&u>0&&u<i&&(n.strokeStyle=n.fillStyle=a.clr.rgbMix(f(1,1,1),.75).toString(),n.fillRect(s-1,u-1,2,2),n.beginPath(),n.moveTo(s,u),n.lineTo(s+3*R(a.v),u+3*I(a.v)),n.stroke())}(t)}}(C),G=!0,B=0;!function(t){return function(t){return t(t)}((function(n){return function(){return t(n(n)).apply(null,arguments)}}))}((function(t){var n="equestAnimationFrame",r=window["r"+n]||window["mozR"+n]||window["webkitR"+n]||window["msR"+n]||function(t){setTimeout(t,50)};return function(){if(G){var n=(new Date).getTime();i(k,(function(t){t.tick(n)})),L(),O(),B%10==0&&o(),r(t),B++}}}))()}var p=200,y=e(75),d=[0,0,1],g=[[1,0,0],[0,1,0],[1,1,0],[1,0,1],[1,.5,0],[.5,1,0],[.5,0,0],[0,.5,0],[.5,.5,0],[.5,0,.5],[.5,.25,0],[0,.5,.5],[.5,.5,.5]],m=[],w="length",b=10,M=150,k={Box:function(t,n){for(var r=1;r<5;r++)for(var i=1;i<5;i++)t.rect(r*n/5-13,i*n/5-13,26,26)},Pillr:function(t,n){var r=n/8;t.rect(r,r,n-2*r,r),t.rect(r,n-2*r,n-2*r,r),t.rect(r,3*r,r,n-5*r),t.rect(n-2*r,2*r,r,n-5*r),t.rect(n/2-r,n/2-r,2*r,2*r)},E:function(t,n){var r=n/8;t.rect(r/1.5,r,r,n-2*r),t.rect(2.5*r,r,n-3*r,r),t.rect(2.5*r,3*r,n-2.5*r,2*r),t.rect(2.5*r,6*r,n-3*r,r)},Arena:function(t,n){var r=n/8;t.rect(n-1.25*r,.25*r,r,n-.5*r),t.rect(.25*r,n-1.25*r,n-.5*r,r),t.rect(.25*r,.25*r,r,n-.5*r),t.rect(.25*r,.25*r,n-.5*r,r)},Checkrs:function(n,r){var i=r/8;t=!1;for(var e=0;e<8;e++){for(var o=0;o<8;o++)t&&n.rect(1+e*i,1+o*i,i-2,i-2),t=!t;t=!t}}},E=k.Box,C=Math.sqrt,R=Math.cos,I=Math.sin,P=(Math.tan,Math.atan2),S=function(t){return r.createElement(t)},T=Math.random,A=function(){function t(){return T()-.5}return function(n){return n.sort(t),n}}(),D=Math.PI,H=2*D,W=function(){var t=S("A");return t.addEventListener?function(t,n,r){return n.addEventListener(t,(function(t){r(t||window.event)}),!1)}:t.attachEvent?function(t,n,r){return n.attachEvent("on"+t,(function(t){r(t||window.event)}))}:function(t,n,r){var i=n[t="on"+t];n[t]=i?function(t){t=t||window.event,i(t),r(t)}:function(t){t=t||window.event,r(t)}}}(),F=function(){var t={},r={37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"};return W("keydown",n,(function(n){var i=n.keyCode;i in r?t[r[i]]=!0:t[String.fromCharCode(i)]=!0})),W("keyup",n,(function(n){var i=n.keyCode;i in r?t[r[i]]=!1:t[String.fromCharCode(i)]=!1})),t}(),U="number"==typeof n.innerWidth?function(){return{width:n.innerWidth,height:n.innerHeight}}:r.documentElement&&(r.documentElement.clientWidth||r.documentElement.clientHeight)?function(){return{width:document.documentElement.clientWidth,height:document.documentElement.clientHeight}}:r.body&&(r.body.clientWidth||r.body.clientHeight)?function(){return{width:document.body.clientWidth,height:document.body.clientHeight}}:void 0;f.prototype.toHsla=function(){var t=c(513);return function(){var n=""+this.valueOf(),r=t(n);if(r)return r.slice(0);var i,e,o=this.r,a=this.g,s=this.b,u=Math.max(o,a,s),h=Math.min(o,a,s),c=(u+h)/2;if(u==h)i=e=0;else{var f=u-h;switch(e=c>.5?f/(2-u-h):f/(u+h),u){case o:i=(a-s)/f+(a<s?6:0);break;case a:i=(s-o)/f+2;break;case s:i=(o-a)/f+4}i/=6}return t(n,[i,e,c,this.a])}}(),f.prototype.clone=function(){return new f(this.r,this.g,this.b,this.a)},f.prototype.hue=function(){var t=c(360);return function(){var n=""+this.toString(),r=t(n);if(r)return r;var i=this.r,e=this.g,o=this.b;return t(n,i>=e?i>=o?e>=o?(e-o)/(i-o)*60:60*(6-(o-e)/(i-e)):60*(4+(i-e)/(o-e)):e>=o?o>=i?60*(2+(o-i)/(e-i)):60*(2-(i-o)/(e-o)):60*(4-(e-i)/(o-i)))}}(),f.prototype.rgbMix=function(t,n){var r=this.a+t.a*(1-this.a),i=this.clone(),e=t.clone();return i.a=1-n,e.a=n,new f((i.r*i.a+e.r*e.a*(1-i.a))/r,(i.g*i.a+e.g*e.a*(1-i.a))/r,(i.b*i.a+e.b*e.a*(1-i.a))/r,r)},f.prototype.hslMix=function(t,n){var r=1-(n=void 0===n?.5:n),i=this.toHsla(),e=t.toHsla();return L(n*i[0]+r*e[0],n*i[1]+r*e[1],n*i[2]+r*e[2],i[3]+e[3]*(1-i[3]))},f.prototype.closestTo=function(t,n){var r=this.hue(),i=t.hue(),e=n.hue();return o(r-i)<o(r-e)?t:n},f.prototype.valueOf=function(){return(65536*Math.round(255*this.r)+256*Math.round(255*this.g)+Math.round(255*this.b)).toString(16)},f.prototype.toString=function(){var t=this.valueOf();return"#"+"00000".substr(0,6-t[w])+t},f.prototype.toArray=function(){return[255*this.r,255*this.g,255*this.b,255*this.a]},f.fromArray=function(t){return new f(t[0],t[1],t[2],t[3])};var L=function(){var t=c(255);return function(n,r,i,e){var o=""+n+r+i+e,a=t(o);if(a)return a.clone();if(0==r)i;else{function s(t,n,r){return r<0?r+=1:r>1&&(r-=1),r<1/6?t+6*(n-t)*r:r<.5?n:r<2/3?t+(n-t)*(2/3-r)*6:t}var u=i<.5?i*(1+r):i+r-i*r,h=2*i-u}return t(o,new f(s(h,u,n+1/3),s(h,u,n),s(h,u,n-1/3),e))}}(),N=function(){var t=h("controls"),n=h("startGame"),r=h("mapPreviews"),e=null,o=[];for(var a in k)!function(t,n){var a=v(n);W("click",a,(function(n){i(o,(function(t){t.style.border="none"})),n.target.style.border="3px solid blue",e=t})),o.push(a),r.appendChild(a)}(a,k[a]);return W("click",n,(function(){var n=parseInt(h("numCPUs").value);n=!isNaN(n)&&n>0&&n<g[w]?n:2,b=parseInt(h("startPoints").value),b=!isNaN(b)&&b>5&&b<25?b:10;var r=h("fastRaycast").checked;t.style.display="none",l({numCPUs:n,fastRaycast:r,map:k[e]})})),t}()}(window,document)</script>