<!doctype html><title>A-Snake</title><script src=/2017/webxr/aframe.js></script><style>body{font-family:Courier,monospace}.hud-text{position:fixed;z-index:300;font-size:24px}.textOutput{left:15px;top:15px}.scoreOutput{right:15px;top:15px}.score-animation{animation:score-animation 1s}@keyframes score-animation{0%{font-size:52px}100%{font-size:24px}}.startScreen{position:fixed;height:100%;width:100%;background-color:rgba(200,200,200,.8);color:#000;text-align:center;z-index:1000}.hidden{display:none}.startScreen-container .load{opacity:1}.startScreen-container{margin:0 auto;width:450px;margin-top:100px}.startScreen__instructions{font-size:15px;margin-top:200px;transition:all 4s ease-in 2s;opacity:0}.startScreen__button{width:120px;height:50px;font-size:28px;margin-top:70px;cursor:pointer;font-family:Courier,monospace;transition:all 1s ease-in;opacity:0;animation:1.5s linear 0s infinite alternate pulse}@keyframes pulse{from{box-shadow:0 0 20px #00ff13}to{box-shadow:0 0 0 #40aa47}}.startScreen__text{font-size:62px;overflow:hidden;border-right:.15em solid transparent;white-space:nowrap;margin:0 auto;letter-spacing:.1em;animation:typing 3.5s steps(40,end),blink-caret .75s step-end 4}@keyframes typing{from{width:0}to{width:100%}}@keyframes blink-caret{from,to{border-color:#00ff13}50%{border-color:transparent}}</style><script>AFRAME.registerComponent("follow",{schema:{target:{type:"selector"},speed:{type:"number"}},init:function(){this.directionVec3=new THREE.Vector3},tick:function(t,e){let i=this.directionVec3,n=this.data.target.object3D.position,s=this.el.object3D.position;i.copy(n).sub(s);let o=i.length();if(!(5>o)){let t=this.data.speed/o;["x","y","z"].forEach((function(n){i[n]*=t*(e/1e3)})),this.el.setAttribute("position",{x:s.x+i.x,y:s.y,z:s.z+i.z})}}}),AFRAME.registerComponent("grow-add",{init:function(){this.el.setAttribute("scale","0 0 0")},tick:function(t,e){const i=this.el.getAttribute("scale").x+e/1e3;1>i?this.el.setAttribute("scale",{x:i,y:i,z:i}):(this.el.setAttribute("scale","1 1 1"),this.el.removeAttribute("grow-add"))}}),AFRAME.registerComponent("hit-handler",{schema:{emitEvent:{default:"hit"}},init:function(){this.onHit=this.onHit.bind(this),this.el.addEventListener("stateadded",(t=>{"collided"===t.detail.state&&this.onHit()}))},onHit:function(){this.el.emit(this.data.emitEvent,{el:this.el})}});const DELAYMIN=300,SPEEDUP=50,DELAYMAX=1200,FOLLOWMIN=.5,FOLLOWMAX=4,BONUSSCORE=14;AFRAME.registerComponent("initializer",{init:function(){this.score=0;const t=this.el,e=document.querySelector("#headObj");e.setAttribute("plane-collider",!0),t.speed=1200,t.setAttribute("snake-controller",{head:e}),t.setAttribute("wasd-relative",!0),t.addEventListener("bad-collision",(()=>{document.querySelector("#sky").setAttribute("color","red"),t.setAttribute("fog","type: exponential; color: #AAA; density: .00");document.querySelector("#camera").removeAttribute("follow")})),t.addEventListener("gobbled-apple",this.handleGobble.bind(this))},handleGobble(t){var e;this.el.isPlaying&&((e=t).detail.el.classList.contains("apple")&&e.detail.el.parentNode.removeChild(e.detail.el),this.score=function(t){t+=1;const e=document.querySelector("#scoreOutput");return e.innerText=t,e.classList.remove("score-animation"),e.offsetWidth,e.classList.add("score-animation"),t}(this.score),this.score>=14&&function(t){var e=document.createElement("a-entity");e.setAttribute("mixin","apple"),e.setAttribute("class","apple collidable"),e.setAttribute("random-position","fixedY: 1.25"),t.appendChild(e)}(this.el.sceneEl),this.el.speed-=50,this.el.speed<300&&(this.el.speed=300),function(t){document.querySelector("#camera").setAttribute("follow","speed",3.5*(t-1200)/-900+.5)}(this.el.speed))}}),AFRAME.registerComponent("plane-collider",{schema:{objects:{default:".collidable"},state:{default:"collided"}},init:function(){this.els=[],this.elMax=new THREE.Vector3,this.elMin=new THREE.Vector3,this.observer=null,this.tick=AFRAME.utils.throttleTick(this.throttledTick,50,this),this.handleHit=this.handleHit.bind(this)},remove:function(){this.pause()},play:function(){var t=this.el.sceneEl;this.data.watch&&(this.observer=new MutationObserver(this.update.bind(this,null)),this.observer.observe(t,{childList:!0,subtree:!0}))},pause:function(){this.observer&&(this.observer.disconnect(),this.observer=null)},update:function(){var t,e=this.data;t=e.objects?this.el.sceneEl.querySelectorAll(e.objects):this.el.sceneEl.children,this.els=Array.prototype.slice.call(t)},handleHit:function(t){t.emit("hit"),t.addState(this.data.state),this.el.emit("hit",{el:t})},throttledTick:function(){let t=new THREE.Box3;return function(){const e=()=>{t.setFromObject(i),this.elMin.copy(t.min),this.elMax.copy(t.max)};var i=this.el.getObject3D("mesh");if(i){this.update(),e(),((e,i,n)=>{let s=[];return n.forEach((n=>{if(n.isEntity){let o=n.getObject3D("mesh");if(o){t.setFromObject(o);let a=t.min,l=t.max;e.x<=l.x&&i.x>=a.x&&e.z<=l.z&&i.z>=a.z&&s.push(n)}}})),s})(this.elMin,this.elMax,this.els).forEach(this.handleHit)}}}()}),AFRAME.registerComponent("slither-once",{schema:{animDuration:{default:100,type:"number"},targetPos:{type:"vec3"}},init:function(){this.lastMoveLocation=this.el.object3D.position,this.target=new THREE.Vector3,this.update()},update:function(t){if(t&&this.data.targetPos!=t.targetPos){this.lastMoveTime=this.el.sceneEl.time,this.lastMoveLocation.copy(this.el.object3D.position);const t=this.data.targetPos;this.target.set(t.x,t.y,t.z)}},tick:function(t){if(t-this.lastMoveTime<=this.data.animDuration){const e=this.lastMoveLocation,i=((t,e)=>1-Math.pow(1-t/e,4))(t-this.lastMoveTime,this.data.animDuration);let n={};["x","y","z"].forEach((t=>{n[t]=(this.target[t]-e[t])*i})),this.el.setAttribute("position",{x:e.x+n.x,y:e.y+n.y,z:e.z+n.z})}else this.el.setAttribute("position",{x:this.target.x,y:this.target.y,z:this.target.z})}});const SLITHERFACTOR=2,calcRotationY=function(t,e){const i=Math.atan2(t.z,t.x),n=Math.atan2(e.z,e.x),s=n-i,o=-(n>i?1:-1)*Math.PI*2;return-(Math.abs(o+s)<Math.abs(s)?o+s:s)*(180/Math.PI)};AFRAME.registerComponent("snake-controller",{schema:{head:{type:"selector"},radius:{default:2.5,type:"number"},numStartingBodies:{default:2,type:"number"}},init:function(){this.beginDelay=this.el.sceneEl.time,this.notDead=!0,this.dirMomentum=new THREE.Vector3(0,0,0),this.nextMomentum=this.dirMomentum.clone(),this.headOrientation=0,this.nextOrientation=0;const t=this.data.head.object3D.position;this.balls=[{el:this.data.head,posTarget:t.clone()}];for(let t=0;t<this.data.numStartingBodies;t++)this.generateAndAddBall();this.changeNextMomentumHandler=this.changeNextMomentumHandler.bind(this),this.generateAndAddBall=this.generateAndAddBall.bind(this),this.el.addEventListener("changemomentum",this.changeNextMomentumHandler),this.el.addEventListener("gobbled-apple",(()=>{this.generateAndAddBall("collidable"),this.data.head.emit("blob")})),this.el.addEventListener("bad-collision",(()=>{this.notDead=!1,this.balls.forEach((t=>{t.el.removeAttribute("slither-once")}))}))},pause:function(){this.notDead=!1},generateAndAddBall:function(t){const e=this.balls[this.balls.length-1].el.object3D.position,i=document.createElement("a-entity");return i.setAttribute("mixin","body"),i.setAttribute("hit-handler",{emitEvent:"bad-collision"}),i.setAttribute("position",e),this.balls.push({el:i,posTarget:e.clone()}),t&&i.classList.add(t),this.el.appendChild(i),i},changeNextMomentumHandler:function(t){const e=t.detail;this.nextMomentum.set(e.x,e.y,e.z),this.nextOrientation=this.headOrientation+calcRotationY(this.dirMomentum,this.nextMomentum)},tick:function(t){if(this.notDead&&t-this.beginDelay>=this.el.sceneEl.speed){this.beginDelay=t;let e=this.balls;for(let t=e.length-1;0<t;t--)e[t].posTarget.copy(e[t-1].posTarget);const i=e[0];i.posTarget.add(this.nextMomentum),this.dirMomentum.copy(this.nextMomentum),this.nextOrientation!==this.headOrientation&&(AFRAME.utils.entity.setComponentProperty(i.el,"rotation.y",this.nextOrientation),this.headOrientation=this.nextOrientation),e.forEach((t=>{t.el.setAttribute("slither-once",{targetPos:t.posTarget,animDuration:2*this.el.sceneEl.speed})}))}}});const getRandomCoordString=(t,e,i,n)=>{var s=void 0===n?Math.floor(Math.random()*((t.y-e.y)/i))*i+e.y:n;return`${Math.floor(Math.random()*((t.x-e.x)/i))*i+e.x} ${s} ${Math.floor(Math.random()*((t.z-e.z)/i))*i+e.z}`};AFRAME.registerComponent("random-position",{schema:{min:{default:{x:-20,y:1.25,z:-20},type:"vec3"},max:{default:{x:20,y:1.25,z:20},type:"vec3"},step:{default:2.5,type:"number"},fixedY:{type:"number"}},init:function(){const t=this.data,e=getRandomCoordString(t.max,t.min,t.step,t.fixedY);this.el.setAttribute("position",e)}}),AFRAME.registerComponent("random-position-entities",{schema:{mixin:{default:""},num:{default:15},classList:{default:""},min:{default:{x:-20,y:1.25,z:-20},type:"vec3"},max:{default:{x:20,y:1.25,z:20},type:"vec3"},step:{default:2.5,type:"number"},fixedY:{type:"number"},protectedArea:{default:"0 1.25 0"}},init:function(){let t=this.getRandomUniquePositions();for(var e,i=0;i<this.data.num;i++)(e=document.createElement("a-entity")).setAttribute("mixin",this.data.mixin),e.setAttribute("class",this.data.mixin+" "+this.data.classList),e.setAttribute("position",t[i]),this.el.appendChild(e)},getRandomUniquePositions(){const t=this.data,e=e=>{const i=e.split(" ").map((t=>+t)),n=t.protectedArea.split(" ").map((t=>+t)),s=t.step;return i[0]>=n[0]-s&&i[0]<=n[0]+s&&i[1]>=n[1]-s&&i[1]<=n[1]+s&&i[2]>=n[2]-s&&i[2]<=n[2]+s};let i=[];for(let n=0;n<t.num;n++){let n="",s=!1;for(;!s;)n=getRandomCoordString(t.max,t.min,t.step,t.fixedY),i.includes(n)||e(n)||(s=!0);i.push(n)}return i}}),AFRAME.registerComponent("wasd-relative",{schema:{speed:{default:2.5,type:"number"}},dependencies:["snake-controller"],init:function(){this.newVelocity=new THREE.Vector3(this.data.speed,0,0),this.down=!1,window.addEventListener("keydown",this.onKeyDown.bind(this),!1),window.addEventListener("keyup",this.onKeyUp.bind(this),!1),this.el.sceneEl.emit("changemomentum",this.newVelocity)},onKeyDown:function(t){if(!this.down){this.down=!0;const e=function(t,e){const i=t.x*Math.cos(e)-t.z*Math.sin(e),n=t.x*Math.sin(e)+t.z*Math.cos(e);return{x:i,y:t.y,z:n}};let i={};switch(t.keyCode){case 37:case 65:i=e(this.newVelocity,-Math.PI/2);break;case 39:case 68:i=e(this.newVelocity,Math.PI/2);break;default:return}this.newVelocity.set(i.x,i.y,i.z),this.el.sceneEl.emit("changemomentum",this.newVelocity)}},onKeyUp:function(){this.down=!1}})</script><div class=startScreen id=startScreen><div class=startScreen-container><div class=startScreen__text>A-Snake</div><button class=startScreen__button id=startScreen__button>Start</button><div class=startScreen__instructions id=startScreen__instructions>Find and consume A-Snake's lost body parts. Avoid everything else.</div></div></div><div class="hud-text scoreOutput" id=scoreOutput>0</div><a-scene fog="type: exponential; color: #87d9b3; density: .1" id=scene><a-assets><a-mixin geometry="primitive: sphere; radius: 1.20" id=head material="color: #000; shader: flat"></a-mixin><a-mixin geometry="primitive: sphere; radius: 1.20" id=body material="color: #000" grow-add></a-mixin><a-mixin geometry="primitive: box; depth: 3.5; height: 2; width: 46" id=wall material="color: #00ff13" hit-handler="emitEvent: bad-collision"></a-mixin><a-mixin geometry="primitive: sphere; radius: 1.20" id=apple material="color: #fff" grow-add hit-handler="emitEvent: gobbled-apple"></a-mixin></a-assets><a-sky color=#ECECEC id=sky></a-sky><a-entity position="0 1.25 0" mixin=head id=headObj><a-entity light="type:point; intensity:1.05; color:#fff"></a-entity><a-animation attribute=scale begin=blob direction=alternate repeat=1 to="1 1.2 1"></a-animation></a-entity><a-entity random-position-entities="mixin: apple; classList: collidable; fixedY: 1.25"></a-entity><a-entity position="-23 1 0" mixin=wall class=collidable rotation="0 90 0"></a-entity><a-entity position="0 1 -23" mixin=wall class=collidable rotation="0 0 0"></a-entity><a-entity position="23 1 0" mixin=wall class=collidable rotation="0 90 0"></a-entity><a-entity position="0 1 23" mixin=wall class=collidable rotation="0 0 0"></a-entity><a-entity position="0 1.6 10" id=camera follow="target: #headObj; speed: .5"><a-camera></a-camera></a-entity><a-entity light="color:#bce4c4; type:ambient; intensity:1.05"></a-entity><a-entity position="20 24.344 20" light="type:point; intensity:3.25; color:#c8ffcd"></a-entity></a-scene><script>!function(){let e=document.querySelector("a-scene"),t=document.querySelector("#startScreen"),c=document.querySelector("#startScreen__instructions"),r=document.querySelector("#startScreen__button");c.classList.add("load"),r.classList.add("load"),r.addEventListener("click",(c=>{c.preventDefault(),t.classList.add("hidden"),e.setAttribute("initializer",!0)}))}()</script>