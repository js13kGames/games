<!doctype html><title>Johnny Smiter: 13th Knight - js13kGames 2012</title><style>html{width:100%;height:100%}body{display:none;margin:0;width:100%;height:100%;overflow:hidden}canvas{width:100%;height:100%}h1{position:absolute;color:#9d712d;text-shadow:0 0 20px #fff,0 0 30px #fff,0 0 40px #fff;left:0;top:20px;margin:0;width:100%;text-align:center;font-weight:400;font-size:42px;font-style:italic;background-color:#c8bdab;border:2px solid #9d712d}h1 span{color:#ff8a00}#health,#smote{font-size:32px;color:#fff;text-shadow:0 0 1px #000;position:absolute;bottom:20px;left:20px}#smote{left:auto;right:20px}#bar{display:block;background-color:rgba(0,255,0,.5);height:20px;width:300px}#overlay,#underlay{width:100%;height:100%;position:absolute;background-size:100% 100%;background-attachment:fixed;background-repeat:no-repeat;left:0;top:0}#underlay{background-color:#c8bdab;opacity:.5;-moz-transition-property:opacity;-moz-transition-duration:4s;-webkit-transition-property:opacity;-webkit-transition-duration:4s;-o-transition-property:opacity;-o-transition-duration:4s;transition-property:opacity;transition-duration:4s}#underlay.hide{opacity:0}#gameover{position:absolute;width:100%;text-align:center;bottom:100px;font-size:42px;color:rgba(255,255,255,0);display:block;text-shadow:0 -5px 10px #ff0,0 -10px 15px red,0 0 2px #fff,0 0 20px #000;display:none}#startgame{position:absolute;width:100%;top:150px;-moz-transition-property:opacity,top;-moz-transition-duration:4s;-webkit-transition-property:opacity,top;-webkit-transition-duration:4s;-o-transition-property:opacity,top;-o-transition-duration:4s;transition-property:opacity,top;transition-duration:4s}#intro{margin:auto;color:#fff;width:450px;font-size:20px;padding:20px;border:5px solid #9d712d;opacity:.8;text-shadow:0 0 5px #fff,0 0 10px #fff;text-align:center}#startgame.hide{top:-1000px;opacity:0}#intro a{text-decoration:none;color:#9d712d;font-size:32px;display:block;background-color:#c8bdab;border:2px solid #9d712d}#bi{width:300px;height:20px;opacity:.5;border:2px solid #9d712d}</style><canvas id=canvas width=800 height=500></canvas><div id=underlay></div><div id=overlay></div><h1><span>J</span>ohnny <span>S</span>miter: <span>13</span>th <span>K</span>night</h1><div id=health>health:<div id=bi><div id=bar></div></div></div><div id=smote>Smote:<div id=smotenum>0</div></div><div id=gameover>Your soul has burned in the firey hells of the 13th realm</div><div id=startgame><div id=intro><p>Welcome to Jar, a once peaceful land, now plauged by the evil fire creatures of the 13th realm.<p>As the 13th Knight of Jar it is your sacred duty to defend the lands of Jar from the invading hoards, banishing the evil creatures back to their fiery realm with your blessed spear.<p>But, be warned the presence of these creatures can burn the souls of even the most righteous of men.</p><a href=javascript:startGame();>Begin Quest</a><p><small><b>Controls:</b> WASD, click and drag + right click to throw spear</small></div></div><div id=debug></div><script id=particle-vs type=x-shader/x-fragment>attribute vec4 aPosition;uniform float uTime;uniform float uState;uniform mat4 uMVMatrix;uniform mat4 uPMatrix;varying vec2 vTextureCoord;varying float vTime;const float life=2000.0;float random(float x,float y){return (fract(sin(dot(vec2(x,y) ,vec2(12.9898,78.233))) * 43758.5453)-0.5)*2.0;}void main(){float i=aPosition.w;float t=mod(random(i,i+1.0)*life+uTime,life)*0.001;vec3 v=vec3(random(i,i+1.0+aPosition.x)*0.3,random(i,i+5.0)+1.0,random(i,i+6.0)*0.3)*0.8*(uState*0.1+1.0);vec3 offset=t*t*v*0.5;vec4 p1=uMVMatrix * vec4(offset,1.0);vTextureCoord=aPosition.xy+vec2(sin(t*6.28+aPosition.y*10.0)*0.1,0.0);vTime=t;gl_Position=uPMatrix * vec4(p1.xyz+(aPosition.xyz-0.5)*2.0,1.0);}</script><script id=particle-fs type=x-shader/x-fragment>precision highp float;uniform sampler2D texture1;uniform float uState;varying vec2 vTextureCoord;varying float vTime;void main(void){vec4 tx=texture2D(texture1, vTextureCoord);float t=2.0-vTime;gl_FragColor=vec4(mix(tx.rgb,vec3(0.0,0.0,1.0),uState/100.0),tx.a*t*t*(1.0-uState/100.0));}</script><script id=shader-fs type=x-shader/x-fragment>precision highp float;uniform sampler2D texture1;uniform sampler2D texture2;uniform float uUseAlpha;varying vec2 vTextureCoord;varying vec3 vVertexNormal;void main(void){vec4 tex;if(vTextureCoord.x<45.0){tex=texture2D(texture1, vTextureCoord);}else{tex=texture2D(texture2, vTextureCoord);}if(tex.a<0.4) discard;float fog=pow(min(1.0,gl_FragCoord.z/gl_FragCoord.w*0.005),1.2);vec3 n=normalize(vVertexNormal);gl_FragColor=mix(vec4(tex.rgb*(clamp(dot(n,vec3(0.9,0.4,0.0)),0.0,1.0)+0.4),1.0),vec4(0.3, 0.3, 0.32,1.0),fog);if(uUseAlpha>0.0) gl_FragColor=vec4(0.0,0.0,0.0,(0.9-tex.r)*0.5);}</script><script id=shader-fs2 type=x-shader/x-fragment>precision highp float;uniform sampler2D texture1;uniform sampler2D texture2;uniform sampler2D texture3;varying vec2 vTextureCoord;varying vec3 vVertexNormal;varying vec3 vNormal;void main(void){vec3 n=normalize(vNormal);vec4 tex=texture2D(texture1, vTextureCoord*0.05);vec4 tex2=texture2D(texture2, vTextureCoord*0.2);vec4 tex3=texture2D(texture3, vTextureCoord*0.25);tex=mix(tex,tex3,pow(dot(n,vec3(0.0,0.0,1.0)),10.0));tex=mix(tex,tex2,pow(dot(n,vec3(0.0,0.0,1.0)),80.0));n=normalize(vVertexNormal);float fog=pow(min(1.0,gl_FragCoord.z/gl_FragCoord.w*0.005),1.2);gl_FragColor=vec4(mix(tex.rgb*(clamp(dot(n,vec3(0.9,0.4,0.0)),0.0,1.0)+0.4)*0.35,vec3(0.3, 0.3, 0.32),fog),1.0);}</script><script id=shader-vs type=x-shader/x-vertex>attribute vec3 aVertexPosition;attribute vec3 aVertexNormal;attribute vec2 aTextureCoord;uniform mat4 uMVMatrix;uniform mat4 uNMatrix;uniform mat4 uPMatrix;varying vec2 vTextureCoord;varying vec3 vVertexNormal;varying vec3 vNormal;void main(void){gl_Position=uPMatrix* uMVMatrix * vec4(aVertexPosition, 1.0);vVertexNormal=(uNMatrix * vec4(aVertexNormal, 1.0)).rgb;vNormal=aVertexNormal;vTextureCoord=aTextureCoord;}</script><script>var startGame;setTimeout((function(){var t;!function(e){(t=function(t){for(q in t)null!=this.properties[q]&&(this.properties[q]=t[q]);this.properties.rseed=this.properties.seed,this.root=new r([0,this.properties.u,0]),this.root.length=this.properties.e,this.verts=[],this.faces=[],this.normals=[],this.UV=[],this.vertsTwig=[],this.normalsTwig=[],this.facesTwig=[],this.uvsTwig=[],this.root.split(null,null,this.properties),this.createForks(),this.createTwigs(),this.doFaces(),this.calcNormals()}).prototype.properties={h:.8,i:.5,f:.85,g:1,j:2,s:.6,o:1.5,p:0,n:.25,q:2,r:.95,t:13,a:6,b:3,m:0,e:.85,u:2.5,k:0,l:0,c:.2,d:2,seed:10,rseed:10,random:function(t){return t||(t=this.rseed++),Math.abs(Math.cos(t+t*t))}},t.prototype.calcNormals=function(){for(var t=this.normals,e=this.faces,r=this.verts,i=[],a=0;a<r.length;a++)i[a]=[];for(a=0;a<e.length;a++){var p=e[a],l=s(n(h(r[p[1]],r[p[2]]),h(r[p[1]],r[p[0]])));i[p[0]].push(l),i[p[1]].push(l),i[p[2]].push(l)}for(a=0;a<i.length;a++){for(var d=[0,0,0],c=i[a].length,m=0;m<c;m++)d=u(d,o(i[a][m],1/c));t[a]=d}},t.prototype.doFaces=function(t){t||(t=this.root);var e=this.properties.a,r=this.faces,o=this.verts,u=this.UV;if(!t.parent){for(f=0;f<o.length;f++)u[f]=[0,0];var p=s(n(h(t.child0.head,t.head),h(t.child1.head,t.head))),d=s(t.head),c=Math.acos(i(p,[-1,0,0]));i(n([-1,0,0],p),d)>0&&(c=2*Math.PI-c);for(var m=Math.round(c/Math.PI/2*e),f=0;f<e;f++){var g=t.ring0[f],v=t.root[(f+m+1)%e],M=t.root[(f+m)%e],A=t.ring0[(f+1)%e];r.push([g,A,M]),r.push([A,v,M]),u[(f+m)%e]=[2*Math.abs(f/e-.5),0];var y=a(h(o[t.ring0[f]],o[t.root[(f+m)%e]]))*this.properties.c;u[t.ring0[f]]=[2*Math.abs(f/e-.5),y],u[t.ring2[f]]=[2*Math.abs(f/e-.5),y]}}if(t.child0.ring0){var T,w,E,b;g=s(h(o[t.ring1[0]],t.head)),v=s(h(o[t.ring2[0]],t.head));g=l(g,s(h(t.child0.head,t.head)),0),v=l(v,s(h(t.child1.head,t.head)),0);for(f=0;f<e;f++){var x=s(h(o[t.child0.ring0[f]],t.child0.head)),R=i(x,g);(null==T||R>E)&&(E=R,T=e-f);x=s(h(o[t.child1.ring0[f]],t.child1.head)),R=i(x,v);(null==w||R>b)&&(b=R,w=e-f)}var F=this.properties.n/t.radius;for(f=0;f<e;f++){g=t.child0.ring0[f],v=t.ring1[(f+T+1)%e],M=t.ring1[(f+T)%e],A=t.child0.ring0[(f+1)%e];r.push([g,A,M]),r.push([A,v,M]),g=t.child1.ring0[f],v=t.ring2[(f+w+1)%e],M=t.ring2[(f+w)%e],A=t.child1.ring0[(f+1)%e],r.push([g,v,M]),r.push([g,A,v]);var U=a(h(o[t.child0.ring0[f]],o[t.ring1[(f+T)%e]]))*F,I=u[t.ring1[(f+T-1)%e]];u[t.child0.ring0[f]]=[I[0],I[1]+U*this.properties.c],u[t.child0.ring2[f]]=[I[0],I[1]+U*this.properties.c];var S=a(h(o[t.child1.ring0[f]],o[t.ring2[(f+w)%e]]))*F,k=u[t.ring2[(f+w-1)%e]];u[t.child1.ring0[f]]=[k[0],k[1]+S*this.properties.c],u[t.child1.ring2[f]]=[k[0],k[1]+S*this.properties.c]}this.doFaces(t.child0),this.doFaces(t.child1)}else for(f=0;f<e;f++){r.push([t.child0.end,t.ring1[(f+1)%e],t.ring1[f]]),r.push([t.child1.end,t.ring2[(f+1)%e],t.ring2[f]]);y=a(h(o[t.child0.end],o[t.ring1[f]]));u[t.child0.end]=[2*Math.abs(f/e-1-.5),y*this.properties.c];y=a(h(o[t.child1.end],o[t.ring2[f]]));u[t.child1.end]=[2*Math.abs(f/e-.5),y*this.properties.c]}},t.prototype.createTwigs=function(t){t||(t=this.root);var e=this.vertsTwig,r=this.normalsTwig,i=this.facesTwig,a=this.uvsTwig;if(t.child0)this.createTwigs(t.child0),this.createTwigs(t.child1);else{var p=s(n(h(t.parent.child0.head,t.parent.head),h(t.parent.child1.head,t.parent.head))),l=s(h(t.head,t.parent.head)),d=n(p,l),c=e.length;e.push(u(u(t.head,o(p,this.properties.d)),o(l,2*this.properties.d-t.length)));var m=e.length;e.push(u(u(t.head,o(p,-this.properties.d)),o(l,2*this.properties.d-t.length)));var f=e.length;e.push(u(u(t.head,o(p,-this.properties.d)),o(l,-t.length)));var g=e.length;e.push(u(u(t.head,o(p,this.properties.d)),o(l,-t.length)));var v=e.length;e.push(u(u(t.head,o(p,this.properties.d)),o(l,2*this.properties.d-t.length)));var M=e.length;e.push(u(u(t.head,o(p,-this.properties.d)),o(l,2*this.properties.d-t.length)));var A=e.length;e.push(u(u(t.head,o(p,-this.properties.d)),o(l,-t.length)));var y=e.length;e.push(u(u(t.head,o(p,this.properties.d)),o(l,-t.length))),i.push([c,m,f]),i.push([g,c,f]),i.push([A,M,v]),i.push([A,v,y]),d=s(n(h(e[c],e[f]),h(e[m],e[f]))),normal2=s(n(h(e[M],e[A]),h(e[v],e[A]))),r.push(d),r.push(d),r.push(d),r.push(d),r.push(normal2),r.push(normal2),r.push(normal2),r.push(normal2),a.push([0,1]),a.push([1,1]),a.push([1,0]),a.push([0,0]),a.push([0,1]),a.push([1,1]),a.push([1,0]),a.push([0,0])}},t.prototype.createForks=function(t,e){t||(t=this.root),e||(e=this.properties.n),t.radius=e,e>t.length&&(e=t.length);var r=this.verts,d=this.properties.a,c=2*Math.PI/d;if(!t.parent){t.root=[];for(var m=[0,1,0],f=0;f<d;f++){var g=p([-1,0,0],m,-c*f);t.root.push(r.length),r.push(o(g,e/this.properties.s))}}if(t.child0){if(t.parent)m=s(h(t.head,t.parent.head));else m=s(t.head);var v=s(h(t.head,t.child0.head)),M=s(h(t.head,t.child1.head)),A=s(n(v,M));t.tangent=A;var y=s(n(A,s(u(o(v,-1),o(M,-1))))),T=[M[0],0,M[2]],w=u(t.head,o(T,-this.properties.n/2)),E=t.ring0=[],b=t.ring1=[],x=t.ring2=[],R=this.properties.s;"trunk"!=t.child0.type&&"trunk"!=t.type||(R=1/this.properties.r);var F=r.length;E.push(F),x.push(F),r.push(u(w,o(A,e*R)));var U=r.length-1,I=p(A,M,1.57),S=s(n(A,m)),k=1/i(I,S);for(f=1;f<d/2;f++){g=p(A,M,c*f);E.push(U+f),x.push(U+f),g=l(g,S,k),r.push(u(w,o(g,e*R)))}var B=r.length;E.push(B),b.push(B),r.push(u(w,o(A,-e*R)));for(f=d/2+1;f<d;f++){g=p(A,v,c*f);E.push(r.length),b.push(r.length),r.push(u(w,o(g,e*R)))}b.push(F),x.push(B);for(U=r.length-1,f=1;f<d/2;f++){g=p(A,y,c*f);b.push(U+f),x.push(U+(d/2-f));var L=o(g,e*R);r.push(u(w,L))}a(h(t.head,t.child0.head)),a(h(t.head,t.child1.head));var D=1*e*this.properties.s,P=1*e*this.properties.s;"trunk"==t.child0.type&&(D=e*this.properties.r),this.createForks(t.child0,D),this.createForks(t.child1,P)}else t.end=r.length,r.push(t.head)};var r=function(t,e){this.head=t,this.parent=e};r.prototype.child0=null,r.prototype.child1=null,r.prototype.parent=null,r.prototype.head=null,r.prototype.length=1,r.prototype.mirrorBranch=function(t,e,r){var a=n(e,n(t,e)),s=r.j*i(a,t);return[t[0]-a[0]*s,t[1]-a[1]*s,t[2]-a[2]*s]},r.prototype.split=function(t,e,i,a,p){null==a&&(a=1),null==p&&(p=1),null==t&&(t=i.b),null==e&&(e=i.q);var l,d=i.b-t;this.parent?l=this.parent.head:(l=[0,0,0],this.type="trunk");var c=this.head,m=s(h(c,l)),f=n(m,[m[2],m[0],m[1]]),g=n(m,f),v=i.random(10*d+5*a+p+i.seed),M=(i.random(10*d+5*a+p+1+i.seed),i.h),A=i.i,y=u(o(f,v),o(g,1-v));v>.5&&(y=o(y,-1));var T=(M-A)*v+A,w=s(u(o(y,1-T),o(m,T))),E=this.mirrorBranch(w,m,i);if(v>.5){var b=w;w=E,E=b}if(e>0){var x=e/i.q*2*Math.PI*i.t;E=s([Math.sin(x),v,Math.cos(x)])}var R=t*t/(i.b*i.b)*i.l,F=d*i.k,U=d*i.m;w=s(u(w,[U,F+R,0])),E=s(u(E,[U,F+R,0]));var I=u(c,o(w,this.length)),S=u(c,o(E,this.length));this.child0=new r(I,this),this.child1=new r(S,this),this.child0.length=Math.pow(this.length,i.g)*i.f,this.child1.length=Math.pow(this.length,i.g)*i.f,t>0&&(e>0?(this.child0.head=u(this.head,[2*(v-.5)*i.p,i.o,2*(v-.5)*i.p]),this.child0.type="trunk",this.child0.length=this.length*i.r,this.child0.split(t,e-1,i,a+1,p)):this.child0.split(t-1,0,i,a+1,p),this.child1.split(t-1,0,i,a,p+1))};var i=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},n=function(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]},a=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},s=function(t){var e=a(t);return o(t,1/e)},o=function(t,e){return[t[0]*e,t[1]*e,t[2]*e]},h=function(t,e){return[t[0]-e[0],t[1]-e[1],t[2]-e[2]]},u=function(t,e){return[t[0]+e[0],t[1]+e[1],t[2]+e[2]]},p=function(t,e,r){var a=Math.cos(r),s=Math.sin(r);return u(u(o(t,a),o(n(e,t),s)),o(e,i(e,t)*(1-a)))},l=function(t,e,r){var n=i(t,e),a=o(e,n*r-n);return u(t,a)}}(window);var e,r=function(t){var e=document.createElement("canvas");e.height=e.width=t.size;for(var r=e.getContext("2d"),i=t.seed,n=function(){return i=++i*i*255%128/128},a=r.createImageData(t.size,t.size),s=t.size*t.size*4,o=0;o<s;o+=4){var h=255*(n()+t.minIntensity);a.data[o]=h*t.r,a.data[o+1]=h*t.g,a.data[o+2]=h*t.b,a.data[o+3]=255}r.putImageData(a,0,0),r.globalAlpha=t.lineAlpha;for(o=0;o<t.lines;o++){r.beginPath(),r.lineWidth=(n()+t.minLine)*t.lineWidth;h=255*(n()+t.minIntensity);r.strokeStyle="rgb("+h+","+h+","+h+")";var u=n()*t.size,p=n()*t.size,l=u+(n()-.5)*t.size*t.xbias,d=p+(n()-.5)*t.size*t.ybias;r.moveTo(u,p),r.lineTo(l,d),r.stroke()}r.globalAlpha=t.blurAlpha;var c=function(i){var a=.5*-(i-t.size)*n();r.drawImage(e,0,0,t.size,t.size,a*t.xbias,a*t.ybias,i*t.xbias,i*t.ybias)};for(o=2;o<t.blurb+2;o++)c(o*t.size);return e},i=function(t){for(var e,r,i,n,a=t.getContext("2d"),s=t.width,o=t.height,h=a.getImageData(0,0,s,o),u=a.createImageData(s,o),p=a.createImageData(s,o),l=0;l<2;l++)for(var d=0;d<s;d++)for(var c=0;c<o;c++)l?(e=Math.min(Math.abs(c-o),c),r=Math.sqrt(Math.min(1,e/o*2)),n=4*((c+.5*o)%o*s+d),dataDst=p.data,dataSrc=u.data):(e=Math.min(Math.abs(d-s),d),r=Math.sqrt(Math.min(1,e/s*2)),n=4*(c*s+(d+.5*s)%s),dataDst=u.data,dataSrc=h.data),i=4*(c*s+d),dataDst[i]=dataSrc[i]*r+dataSrc[n]*(1-r),dataDst[i+1]=dataSrc[i+1]*r+dataSrc[n+1]*(1-r),dataDst[i+2]=dataSrc[i+2]*r+dataSrc[n+2]*(1-r),dataDst[i+3]=255;return a.putImageData(p,0,0),t},n=function(t){var e=document.createElement("canvas");e.height=512,e.width=512;var r=e.getContext("2d"),i=13,n=512/i,a=512/i,s=512/i*.8,o=.9015853619202971,h=function(){return o=++o*o*255%128/128},u=function(e,o,p){for(var l=e;l<i;l++){var d=[p[0]+1.5*(h()-.5),p[1]+1.5*(h()-.5)],c=Math.sqrt(d[0]*d[0]+d[1]*d[1]);if(d[0]/=c,d[1]/=c,h()>.5&&l!=e)u(l,[o[0],o[1]],d);else if(l>6.5){r.beginPath(),r.fillStyle=t[Math.floor(h()*t.length)];var m=o[0]+d[0]*a,f=o[1]+d[1]*a,g=o[0]+d[0]*a*.5+d[1]*s,v=o[1]+d[1]*a*.5-d[0]*s,M=o[0]+d[0]*a*.5-d[1]*s,A=o[1]+d[1]*a*.5+d[0]*s;r.moveTo(o[0],o[1]),r.quadraticCurveTo(g,v,m,f),r.quadraticCurveTo(M,A,m,f),r.closePath(),r.fill()}r.beginPath(),r.lineWidth=.3*(i-l),r.moveTo(o[0],o[1]),o[0]+=p[0]*n,o[1]+=p[1]*n,r.lineTo(o[0],o[1]),r.stroke()}},p=[e.width/2,e.height];return u(1,p,[0,-1]),e},a=function(){return r({size:512,xbias:1,ybias:1,r:.58,g:.58,b:.5,minIntensity:.2,lineAlpha:.5,blurAlpha:.5,minLine:1,lineWidth:5,lines:100,blurb:3,seed:.31093138875439763})};!function(){var t=.9015853619202971,r=function(){return t=++t*t*255%128/128};e=function(t){for(q in t)this[q]=t[q];this.trackPoints=this.generateTrackPoints(),this.interPoints=this.generateTrackInterPoints(this.numTrackInterPoints),this.randomData=this.generateRandomData(),this.heightMap=this.generateHeightMap(),this.terrainMesh=this.generateTerrainMesh()},e.prototype.numTrackPoints=42,e.prototype.numTrackInterPoints=150,e.prototype.terrainSize=300,e.prototype.height=1,e.prototype.trackSize=220,e.prototype.trackDiv=.75,e.prototype.trackWidth=2,e.prototype.trackFalloffDistance=15,e.prototype.trackHeightMin=3.5,e.prototype.trackHeightMax=4.5,e.prototype.generateTrackPoints=function(){for(var t=[],e=this.numTrackPoints,i=this.trackHeightMax-this.trackHeightMin,n=0,a=0;a<e;a++)if(a-n>2&&r()>.5){var s=a/(.5*e)*Math.PI,o=r()*this.trackSize/2*this.trackDiv+this.trackSize/2*(1-this.trackDiv);t.push([Math.sin(s)*o+this.terrainSize/2,Math.cos(s)*o+this.terrainSize/2,r()*i+this.trackHeightMin]),n=a,o}return t},e.prototype.generateRandomData=function(){for(var t=[],e=0;e<8;e++){t[e]=[];for(var i=0;i<8;i++)t[e][i]=r()}return t},e.prototype.generateTrackInterPoints=function(t){for(var e=[],r=0;r<t;r++)e.push(this.curvePoint(r/t));return e},e.prototype.cubicInterpolate=function(t,e,r,i,n){var a,s;return(a=i-r-t+e)*n*(s=n*n)+(t-e-a)*s+(r-t)*n+e},e.prototype.curvePoint=function(t){var e=this.trackPoints,r=t*e.length,i=Math.floor(r);t=r%1;var n=(i+e.length-1)%e.length,a=i,s=(i+1)%e.length,o=(i+2)%e.length;return[this.cubicInterpolate(e[n][0],e[a][0],e[s][0],e[o][0],t),this.cubicInterpolate(e[n][1],e[a][1],e[s][1],e[o][1],t),this.cubicInterpolate(e[n][2],e[a][2],e[s][2],e[o][2],t)]},e.prototype.distanceFromSegment=function(t,e,r){var i,n,a=[t[0]-e[0],t[1]-e[1]],s=[t[0]-r[0],t[1]-r[1]],o=[r[0]-e[0],r[1]-e[1]],h=Math.sqrt(a[0]*a[0]+a[1]*a[1]),u=Math.sqrt(s[0]*s[0]+s[1]*s[1]),p=Math.sqrt(o[0]*o[0]+o[1]*o[1]),l=[o[0]/p,o[1]/p],d=l[0]*a[0]+l[1]*a[1],c=d>0;if(c&&l[0]*s[0]+l[1]*s[1]<0){i=Math.abs(l[1]*a[0]-l[0]*a[1]);var m=d/p;n=this.mix(e[2],r[2],m)}else c?(i=u,n=r[2]):(i=h,n=e[2]);return[i,n]},e.prototype.distanceFromTrack=function(t,e){for(var r=1e4,i=0,n=[t,e],a=this.interPoints,s=0;s<a.length;s++){var o=a[s],h=a[(s+1)%a.length],u=this.distanceFromSegment(n,h,o);u[0]<r&&(r=u[0],i=u[1])}return[r,i]},e.prototype.mix=function(t,e,r){return t*(1-r)+e*r},e.prototype.clamp=function(t,e,r){return Math.max(t,Math.min(e,r))},e.prototype.sampleAt=function(t,e){var r=this.randomData,i=Math.floor(t%8),n=Math.floor(e%8);try{return this.mix(this.mix(r[i][n],r[i][(n+1)%8],e%1),this.mix(r[(i+1)%8][n],r[(i+1)%8][(n+1)%8],e%1),t%1)}catch(t){return 0}},e.prototype.heightAt=function(t,e){var r=Math.min(Math.abs(t-this.terrainSize),Math.abs(e-this.terrainSize),t,e);r=Math.sqrt(5*Math.max(0,7-r));var i=this.distanceFromTrack(t,e);t/=.5*this.terrainSize,e/=.5*this.terrainSize;var n=this.sampleAt(2*t,2*e)/2+this.sampleAt(3*t,3*e)/4+this.sampleAt(5*t,5*e)/8+this.sampleAt(13*t,13*e)/16+this.sampleAt(19*t,19*e)/16;n=n*n*1.5*this.height,n=Math.min(this.height,n);var a=(this.clamp(this.trackWidth,this.trackFalloffDistance,i[0])-this.trackWidth)/(this.trackFalloffDistance-this.trackWidth);return this.mix(n,i[1],Math.pow(1-a,4))+r},e.prototype.generateHeightMap=function(){for(var t=this.terrainSize,e=[],r=0;r<t;r++){e[r]=[];for(var i=0;i<t;i++)e[r][i]=this.heightAt(r,i)}return e},e.prototype.generateTerrainMesh=function(){for(var t=this.terrainSize,e=[],r=[],i=0;i<t;i++)for(var n=0;n<t;n++)e.push(i,n,this.heightMap[i][n]),r.push(i,n);var a=[];for(i=0;i<t-1;i++)for(n=0;n<t-1;n++){var s=i*t+n,o=i*t+n+1,h=(i+1)*t+n,u=(i+1)*t+n+1;a.push(s,h,u,s,u,o)}for(var p=[],l=0;l<e.length;l++)p.push(0);for(l=0;l<a.length;l++){var d=3*a[3*l],c=3*a[3*l+1],m=3*a[3*l+2],f=e[c]-e[d],g=e[m]-e[d],v=e[c+1]-e[d+1],M=e[m+1]-e[d+1],A=e[c+2]-e[d+2],y=e[m+2]-e[d+2],T=v*y-A*M,w=A*g-f*y,E=f*M-v*g;p[d]+=T,p[c]+=T,p[m]+=T,p[d+1]+=w,p[c+1]+=w,p[m+1]+=w,p[d+2]+=E,p[c+2]+=E,p[m+2]+=E}for(l=0;l<p.length;l+=3){T=p[l],w=p[l+1],E=p[l+2];var b=Math.sqrt(T*T+w*w+E*E);p[l]/=b,p[l+1]/=b,p[l+2]/=b}return{verts:e,faces:a,uvs:r,normals:p}}}();var s=0,o=function(){var t=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);return s=(s+1)%1e5,t.unique=s,t},h=function(t,e,r,i){return d(1,0,0,t,0,1,0,e,0,0,1,r,0,0,0,1,i)},u=function(t,e,r){var i,n,a,s,o,h,u=(e=[e[0],e[1],e[2],0])[0],p=e[1],l=e[2],c=Math.cos(t),m=1-c,f=Math.sin(t);return d(m*(u*u)+c,m*(i=u*p)-(h=l*f),m*(a=l*u)+(o=p*f),0,m*i+h,m*(p*p)+c,m*(n=p*l)-(s=u*f),0,m*a-o,m*n+s,m*(l*l)+c,0,0,0,0,1,r)},p=function(){var t=o(),e=o(),r=o();return function(i,n,a,s,o,p,l,m,f){return h(i,n,a,t),u(l,m,e),c(t,e,r),c(r,function(t,e,r,i){return d(t,0,0,0,0,e,0,0,0,0,r,0,0,0,0,1,i)}(s,o,p,t),f),f}}(),l=function(t){var e=t[1];t[1]=t[4],t[4]=e;e=t[8];t[8]=t[2],t[2]=e;e=t[3];t[3]=t[12],t[12]=e;e=t[9];t[9]=t[6],t[6]=e;e=t[13];t[13]=t[7],t[7]=e;e=t[14];return t[14]=t[11],t[11]=e,s=(s+1)%1e5,t.unique=s,t},d=function(t,e,r,i,n,a,o,h,u,p,l,d,c,m,f,g,v){return v[0]=t,v[1]=e,v[2]=r,v[3]=i,v[4]=n,v[5]=a,v[6]=o,v[7]=h,v[8]=u,v[9]=p,v[10]=l,v[11]=d,v[12]=c,v[13]=m,v[14]=f,v[15]=g,s=(s+1)%1e5,v.unique=s,v},c=function(t,e,r){var i=e[0],n=e[1],a=e[2],s=e[3],o=e[4],h=e[5],u=e[6],p=e[7],l=e[8],c=e[9],m=e[10],f=e[11],g=e[12],v=e[13],M=e[14],A=e[15],y=t[0],T=t[1],w=t[2],E=t[3],b=t[4],x=t[5],R=t[6],F=t[7],U=t[8],I=t[9],S=t[10],k=t[11],B=t[12],L=t[13],D=t[14],P=t[15];return d(y*i+T*o+w*l+E*g,y*n+T*h+w*c+E*v,y*a+T*u+w*m+E*M,y*s+T*p+w*f+E*A,b*i+x*o+R*l+F*g,b*n+x*h+R*c+F*v,b*a+x*u+R*m+F*M,b*s+x*p+R*f+F*A,U*i+I*o+S*l+k*g,U*n+I*h+S*c+k*v,U*a+I*u+S*m+k*M,U*s+I*p+S*f+k*A,B*i+L*o+D*l+P*g,B*n+L*h+D*c+P*v,B*a+L*u+D*m+P*M,B*s+L*p+D*f+P*A,r)},m=function(t,e){var r=t[0],i=t[1],n=t[2],a=t[3],s=t[4],o=t[5],h=t[6],u=t[7],p=t[8],l=t[9],c=t[10],m=t[11],f=t[12],g=t[13],v=t[14],M=t[15],A=f*l*h*a-p*g*h*a-f*o*c*a+s*g*c*a+p*o*v*a-s*l*v*a-f*l*n*u+p*g*n*u+f*i*c*u-r*g*c*u-p*i*v*u+r*l*v*u+f*o*n*m-s*g*n*m-f*i*h*m+r*g*h*m+s*i*v*m-r*o*v*m-p*o*n*M+s*l*n*M+p*i*h*M-r*l*h*M-s*i*c*M+r*o*c*M;return d((l*v*u-g*c*u+g*h*m-o*v*m-l*h*M+o*c*M)/A,(g*c*a-l*v*a-g*n*m+i*v*m+l*n*M-i*c*M)/A,(o*v*a-g*h*a+g*n*u-i*v*u-o*n*M+i*h*M)/A,(l*h*a-o*c*a-l*n*u+i*c*u+o*n*m-i*h*m)/A,(f*c*u-p*v*u-f*h*m+s*v*m+p*h*M-s*c*M)/A,(p*v*a-f*c*a+f*n*m-r*v*m-p*n*M+r*c*M)/A,(f*h*a-s*v*a-f*n*u+r*v*u+s*n*M-r*h*M)/A,(s*c*a-p*h*a+p*n*u-r*c*u-s*n*m+r*h*m)/A,(p*g*u-f*l*u+f*o*m-s*g*m-p*o*M+s*l*M)/A,(f*l*a-p*g*a-f*i*m+r*g*m+p*i*M-r*l*M)/A,(s*g*a-f*o*a+f*i*u-r*g*u-s*i*M+r*o*M)/A,(p*o*a-s*l*a-p*i*u+r*l*u+s*i*m-r*o*m)/A,(f*l*h-p*g*h-f*o*c+s*g*c+p*o*v-s*l*v)/A,(p*g*n-f*l*n+f*i*c-r*g*c-p*i*v+r*l*v)/A,(f*o*n-s*g*n-f*i*h+r*g*h+s*i*v-r*o*v)/A,(s*l*n-p*o*n+p*i*h-r*l*h-s*i*c+r*o*c)/A,e)};window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)};var f=function(t,e,r){this.gl=t;var i=t.createProgram(),n=this.createShader(t,e,t.VERTEX_SHADER),a=this.createShader(t,r,t.FRAGMENT_SHADER);if(null==n||null==a)return null;t.attachShader(i,n),t.attachShader(i,a),t.deleteShader(n),t.deleteShader(a),t.linkProgram(i),this.uniforms=[],this.uniformNames={};for(var s=t.getProgramParameter(i,t.ACTIVE_UNIFORMS),o=0;o<s;o++){(p=t.getActiveUniform(i,o)).location=t.getUniformLocation(i,p.name),this.uniforms.push(p),this.uniformNames[p.name]=p}this.attributes=[];var h=t.getProgramParameter(i,t.ACTIVE_ATTRIBUTES),u=0;for(o=0;o<h;o++){var p;(p=t.getActiveAttrib(i,o)).location=t.getAttribLocation(i,p.name),p.offset=u,p.num=p.type==t.FLOAT_VEC3?3:p.type==t.FLOAT_VEC4?4:2,u+=p.num,this.attributes.push(p),t.enableVertexAttribArray(p.location)}this.totalStride=4*u,this.totalOffset=u,this.uniformCache={},this.program=i};f.prototype.createShader=function(t,e,r){var i=t.createShader(r);return t.shaderSource(i,e),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(console.log((r==t.VERTEX_SHADER?"VERTEX":"FRAGMENT")+" SHADER:\n"+t.getShaderInfoLog(i)),null)},f.prototype.setUniform=function(t,e){var r=e;r.length&&(r=e.unique),(this.uniformCache[t]!=r||isNaN(r))&&(loc=this.uniformNames[t].location,this.uniformNames[t].type==U.FLOAT_MAT4?U.uniformMatrix4fv(loc,!1,e):this.uniformNames[t].type==U.SAMPLER_2D?U.uniform1i(loc,e):this.uniformNames[t].type==U.FLOAT&&U.uniform1f(loc,e),this.uniformCache[t]=r)};var g=function(t,e,r){this.data=e;var i=t.createBuffer();t.bindBuffer(t[r],i),t.bufferData(t[r],e,t.STATIC_DRAW),this.buffer=i};g.prototype.offsets={aVertexPosition:0,aVertexNormal:12,aTextureCoord:24};var v=function(t){this.gl=t,t.clearColor(.3,.4,.5,1),t.enable(t.DEPTH_TEST),this.clear()};v.prototype.useProgram=function(t){var e=this.gl;t!=e.program&&(e.program=t,this.program=t,e.useProgram(t.program))},v.prototype.useBuffer=function(t){if(this.buffer!=t){var e=this.gl;if(e.bindBuffer(e.ARRAY_BUFFER,t.buffer),this.program)for(var r=this.program.attributes,i=r.length,n=0;n<i;n++)e.vertexAttribPointer(r[n].location,r[n].num,e.FLOAT,!1,this.program.totalStride,t.offsets[r[n].name])}},v.prototype.useElements=function(t){if(t!=this.elementsBuffer){var e=this.gl;this.elementsBuffer=t,e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.buffer)}},v.prototype.drawElements=function(){var t=this.gl;t.drawElements(t.TRIANGLES,this.elementsBuffer.data.length,t.UNSIGNED_SHORT,0)},v.prototype.setUniform=function(t,e){this.gl;this.program.setUniform(t,e)},v.prototype.clear=function(){var t=this.gl;t.viewport(0,0,t.viewportWidth,t.viewportHeight),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)},v.prototype.addTexture=function(t,e){var r=this.gl,i=r.createTexture();r.activeTexture(r["TEXTURE"+t]),r.bindTexture(r.TEXTURE_2D,i),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_LINEAR),r.generateMipmap(r.TEXTURE_2D)};var M=document.getElementById("bar"),A=document.getElementById("intro"),y=document.getElementById("startgame"),T=document.getElementById("underlay"),w=document.getElementById("smotenum"),E=document.getElementById("bi"),b=document.getElementById("gameover");E.style.backgroundImage=A.style.backgroundImage="url("+a().toDataURL()+")";var x=document.getElementById("overlay");x.style.backgroundImage="url('"+function(){var t=a(),e=document.createElement("canvas");e.width=e.height=512;var r=e.getContext("2d");r.drawImage(t,0,0);for(var i=r.getImageData(0,0,512,512),n=0;n<512;n++)for(var s=0;s<512;s++){var o=4*(512*s+n),h=n-256,u=s-320,p=Math.sqrt(h*h+u*u)/320;p=Math.pow(p,10)+.02,i.data[o+3]=Math.round(255*p)}return r.putImageData(i,0,0),e}().toDataURL()+"')";var R=function(){this.position=[125,10,-125],this.rotation=[0,0],this.transMat=o(),this.rotMat1=o(),this.rotMat2=o(),this.temp=o(),this.matrix=o(),this.invMatrix=o(),this.updateMatrix()};R.prototype.updateMatrix=function(){var t=this.position,e=this.rotation,r=this.transMat,i=this.temp,n=this.rotMat1,a=this.rotMat2;h(t[0],t[1],t[2],r),u(e[0],[1,0,0],n),u(e[1],[0,1,0],a),c(a,n,i),c(r,i,this.matrix),m(this.matrix,this.invMatrix)},R.prototype.rotateV=function(t){this.rotation[0]+=t,this.updateMatrix()},R.prototype.rotateH=function(t){this.rotation[1]+=t,this.updateMatrix()},R.prototype.move=function(t,e){this.position[0]+=this.matrix[0+t]*e,this.position[1]+=this.matrix[4+t]*e,this.position[2]+=this.matrix[8+t]*e,this.updateMatrix()};var F=document.getElementById("canvas");F.width=800,F.height=window.innerHeight/window.innerWidth*800;var U=function(t){return(U=t.getContext("experimental-webgl")).viewportWidth=t.width,U.viewportHeight=t.height,U||alert("No Webgl"),U}(F);U.cullFace(U.BACK),U.enable(U.CULL_FACE),U.blendFunc(U.SRC_ALPHA,U.ONE);for(var I=new t({seed:152,a:6,b:5,c:1.16,d:.44,e:.49,f:.85,g:.99,h:.454,i:.246,j:3.2,k:.09,l:.235,m:.01,n:.114,o:.41,p:0,q:5,r:.835,s:.73,t:2.06,u:2.5}),S=new t({seed:499,a:8,b:5,c:1,d:.48,e:.5,f:.98,g:1.08,h:.414,i:.282,j:2.2,k:.24,l:.044,m:0,n:.096,o:.39,p:0,q:5,r:.958,s:.71,t:2.97,u:1.95}),k=function(t){for(var e=[],r=t.verts.length,i=0;i<r;i++)e.push(t.verts[i][0],t.verts[i][1],t.verts[i][2],t.normals[i][0],t.normals[i][1],t.normals[i][2],t.UV[i][0],t.UV[i][1]);var n=[];for(i=0;i<t.faces.length;i++)n.push(t.faces[i][0],t.faces[i][1],t.faces[i][2]);var a=e.length/8;for(r=t.vertsTwig.length,i=0;i<r;i++)e.push(t.vertsTwig[i][0],t.vertsTwig[i][1],t.vertsTwig[i][2],t.normalsTwig[i][0],t.normalsTwig[i][1],t.normalsTwig[i][2],t.uvsTwig[i][0]+50,t.uvsTwig[i][1]);for(i=0;i<t.facesTwig.length;i++)n.push(t.facesTwig[i][0]+a,t.facesTwig[i][1]+a,t.facesTwig[i][2]+a);return[e,n]},B=k(I),L=k(S),D=new g(U,new Float32Array(B[0]),"ARRAY_BUFFER"),P=new g(U,new Uint16Array(B[1]),"ELEMENT_ARRAY_BUFFER"),_=new g(U,new Float32Array(L[0]),"ARRAY_BUFFER"),N=new g(U,new Uint16Array(L[1]),"ELEMENT_ARRAY_BUFFER"),C=new e({height:15,terrainSize:250}),z=C.terrainMesh.verts.length/3,H=[],q=0;q<z;q++)H.push(C.terrainMesh.verts[3*q]),H.push(C.terrainMesh.verts[3*q+1]),H.push(C.terrainMesh.verts[3*q+2]),H.push(C.terrainMesh.normals[3*q]),H.push(C.terrainMesh.normals[3*q+1]),H.push(C.terrainMesh.normals[3*q+2]),H.push(C.terrainMesh.uvs[2*q]),H.push(C.terrainMesh.uvs[2*q+1]);var V=new g(U,new Float32Array(H),"ARRAY_BUFFER"),O=new g(U,new Uint16Array(C.terrainMesh.faces),"ELEMENT_ARRAY_BUFFER"),W=new f(U,document.getElementById("shader-vs").innerHTML,document.getElementById("shader-fs").innerHTML),Y=new f(U,document.getElementById("shader-vs").innerHTML,document.getElementById("shader-fs2").innerHTML),X=new f(U,document.getElementById("particle-vs").innerHTML,document.getElementById("particle-fs").innerHTML),G=l(function(t,e,r,i,n){var a=r*Math.tan(.00872664625972*t),s=-a;return function(t,e,r,i,n,a,s){return d(2*n/(e-t),0,(e+t)/(e-t),0,0,2*n/(i-r),(i+r)/(i-r),0,0,0,-(a+n)/(a-n),-2*a*n/(a-n),0,0,-1,0,s)}(s*e,a*e,s,a,r,i,n)}(45,1.6,.01,1e3,o())),Q=(o(),o());p(0,0,0,1,1,1,-1.57,[1,0,0],Q);var K=new v(U),j={size:256,xbias:1,ybias:3,r:.46,g:.37,b:.32,minIntensity:-.1,lineAlpha:.5,blurAlpha:.5,minLine:1,lineWidth:5,lines:50,blurb:2,seed:.22342867101542652};K.addTexture(0,i(r(j))),K.addTexture(1,n(["rgba(0,36,0,1)","rgba(25,36,12,1)","rgba(36,36,0,1)"])),K.addTexture(2,i(r({size:512,xbias:1.2,ybias:1,r:.5,g:.7,b:.7,minIntensity:0,lineAlpha:.6,blurAlpha:.75,minLine:1,lineWidth:20,lines:50,blurb:3,seed:.8831543794367462}))),K.addTexture(3,i(r({size:512,xbias:1,ybias:1,r:.42,g:.38,b:.26,minIntensity:.2,lineAlpha:.5,blurAlpha:.5,minLine:1,lineWidth:5,lines:100,blurb:3,seed:.31093138875439763}))),K.addTexture(4,i(r({size:512,xbias:1,ybias:1,r:.14,g:.33,b:.13,minIntensity:.2,lineAlpha:.5,blurAlpha:.5,minLine:1,lineWidth:2,lines:0,blurb:3,seed:.6985204408410937}))),K.addTexture(5,n(["rgba(25,36,0,1)","rgba(50,36,12,1)","rgba(65,36,0,1)"])),j.r=.4,j.g=.4,j.b=.36,K.addTexture(6,i(r(j))),K.addTexture(7,function(){var t=document.createElement("canvas");t.height=t.width=256;for(var e=t.getContext("2d"),r=.3015853619202971,i=function(){return r=++r*r*255%128/128},n=0;n<100;n++)e.beginPath(),e.strokeStyle=i()>.8?"#f02":"#ff2",e.moveTo(100*i()+100,250-200*i()),e.lineTo(100*i()+100,250-200*i()),e.stroke();e.globalAlpha=.15;for(n=0;n<20;n++)e.drawImage(t,0,0,256,256,5*Math.cos(n)-10,-12,270,270);return t}());var J=new Image;J.onload=function(){K.addTexture(8,J)},J.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQBAMAAADt3eJSAAAAAXNSR0IArs4c6QAAABhQTFRFDA4KLS4sVldVZ2lmjY+Ms7Wy1NbT+fv4geR4pwAAAF1JREFUCNdjKIcCBiAOK4UwUlWL3UGMFEO2QiFXICNIQLyIQQXIKDFOL3d2AyuG6kpLKytLSwMyytLLQRgklZoOMafUwTkczChTdEiHWGHkCLXLOQgiVZ6aCpUCAwBYHTQLXnC3gQAAAABJRU5ErkJggg==",K.useProgram(W),K.setUniform("uPMatrix",G),K.useProgram(X),K.setUniform("uPMatrix",G),K.setUniform("texture1",7),K.useProgram(Y),K.setUniform("uPMatrix",G),K.setUniform("texture1",2),K.setUniform("texture2",3),K.setUniform("texture3",4);var Z=new R,$=o(),tt=o(),et=[],rt=[];for(q=0;q<500;q++){var it=Math.floor(250*Math.random()),nt=-Math.floor(250*Math.random()),at=C.heightAt(it,-nt),st=o(),ot=1.5*Math.random()+.9;p(it,at,nt,ot,ot,ot,Math.random()*Math.PI*2,[0,1,0],st),et.push({idx:q,mat:st}),rt.push({idx:q,mv:o(),mn:o()})}var ht=.04,ut=1.58,pt=.85,lt=.53,dt=new g(U,new Float32Array([ut,ht,-ht,-pt,-lt,0,55,1,ut,ht,ht,-pt,-lt,0,56,1,1.45,.24,-.01,-pt,-lt,0,56,0,ut,-ht,-ht,-.88,.47,0,55,1,1.45,-.27,-.01,-.88,.47,0,56,1,ut,-ht,ht,-.88,.47,0,56,0,ut,ht,ht,.09,.26,.96,55,1,2.07,0,.01,.09,.26,.96,56,1,1.45,.24,-.01,.09,.26,.96,56,0,ut,ht,ht,.07,0,1,55,1,ut,-ht,ht,.07,0,1,56,1,2.07,0,.01,.07,0,1,56,0,ut,-ht,ht,.08,-.24,.97,55,1,1.45,-.27,-.01,.08,-.24,.97,56,1,2.07,0,.01,.08,-.24,.97,56,0,ut,ht,-ht,.09,0,-1,55,1,2.07,0,.01,.09,0,-1,56,1,ut,-ht,-ht,.09,0,-1,56,0,ut,ht,-ht,.1,.21,-.97,55,1,1.45,.24,-.01,.1,.21,-.97,56,1,2.07,0,.01,.1,.21,-.97,56,0,ut,-ht,-ht,.1,-.16,-1,55,1,2.07,0,.01,.1,-.16,-1,56,1,1.45,-.27,-.01,.1,-.16,-1,56,0,ut,ht,ht,0,1,0,0,1,ut,ht,-ht,0,1,0,1,1,-ut,ht,ht,0,1,0,0,0,-ut,ht,-ht,0,1,0,1,0,-ut,-ht,-ht,-1,0,0,0,1,-ut,-ht,ht,-1,0,0,1,1,-ut,ht,ht,-1,0,0,1,0,-ut,ht,-ht,-1,0,0,0,0,ut,-ht,-ht,0,-1,0,0,1,ut,-ht,ht,0,-1,0,1,1,-ut,-ht,-ht,0,-1,0,0,0,-ut,-ht,ht,0,-1,0,1,0,ut,ht,ht,0,0,1,0,1,-ut,ht,ht,0,0,1,1,1,ut,-ht,ht,0,0,1,0,0,-ut,-ht,ht,0,0,1,1,0,ut,ht,-ht,0,0,-1,0,1,ut,-ht,-ht,0,0,-1,1,1,-ut,ht,-ht,0,0,-1,0,0,-ut,-ht,-ht,0,0,-1,1,0]),"ARRAY_BUFFER"),ct=new g(U,new Uint16Array([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,25,27,26,28,29,30,28,30,31,32,33,34,33,35,34,36,37,38,37,39,38,40,41,42,41,43,42]),"ELEMENT_ARRAY_BUFFER"),mt=(o(),o(),o(),new g(U,new Float32Array([-.3,-.3,0,0,0,1,0,0,.3,-.3,0,0,0,1,1,0,.3,.3,0,0,0,1,1,1,-.3,.3,0,0,0,1,0,1]),"ARRAY_BUFFER")),ft=new g(U,new Uint16Array([0,3,1,1,3,2]),"ELEMENT_ARRAY_BUFFER"),gt=[],vt=[];for(q=0;q<100;q++){var Mt=Math.random();gt.push(0,0,0,Mt,1,0,0,Mt,1,1,0,Mt,0,1,0,Mt);var At=4*q;vt.push(At+1,At+3,At+0,At+2,At+3,At+1)}var yt=new g(U,new Float32Array(gt),"ARRAY_BUFFER"),Tt=new g(U,new Uint16Array(vt),"ELEMENT_ARRAY_BUFFER");startGame=function(){for(var t=0;t<40;t++)Et.push(new wt);St=!1,Rt=100,Ft=0,w.innerHTML=Ft,M.style.width=3*Rt+"px",kt(),y.setAttribute("class","hide"),T.setAttribute("class","hide"),It=+new Date,b.style.display="none"};var wt=function(){this.position=[200*Math.random(),10,200*Math.random()],this.lastTime=+new Date,this.matrix=o(),p(this.position[0],8,-this.position[1],1,1,1,0,[0,1,0],this.matrix),this.transMatrix=o(),this.randomDir(),this.state=0,this.live=1,this.speed=.002};wt.prototype.randomDir=function(){var t=Math.random()-.5,e=Math.random()-.5,r=Math.sqrt(t*t+e*e);this.direction=[t/r,e/r]},wt.prototype.updatePosition=function(){var t=+new Date,e=t-this.lastTime;e=Math.min(30,e),this.lastTime=t,this.speed=3e-8*(t-It),this.position[0]+=this.direction[0]*e*this.speed,this.position[2]+=this.direction[1]*e*this.speed,(this.position[0]<10||this.position[0]>190)&&(this.direction[0]*=-.9),(this.position[2]<10||this.position[2]>190)&&(this.direction[1]*=-.9),Math.random()<.005&&this.randomDir()},wt.prototype.render=function(){1==this.live&&this.state>0&&this.state--,0==this.live&&this.state<100&&this.state++,0==this.live&&100==this.state&&(this.position=[200*Math.random(),10,200*Math.random()],this.live=1);var t=Z.position[0]-this.position[0],e=Z.position[2]+this.position[2],r=Math.sqrt(t*t+e*e);r<50&&(this.direction[0]=t/r,this.direction[1]=-e/r),r<2&&((Rt-=1)<0&&(Rt=0,St=!0,setTimeout(kt,10),y.setAttribute("class",""),T.setAttribute("class",""),b.style.display="block"),M.style.width=3*Rt+"px"),this.updatePosition(),this.position[1]=C.heightAt(this.position[0],this.position[2]),p(this.position[0],this.position[1]+1,-this.position[2],1,1,1,Math.atan2(-this.direction[0],this.direction[1]),[0,1,0],this.matrix),l(c(Z.invMatrix,this.matrix,this.transMatrix)),K.setUniform("uMVMatrix",this.transMatrix),K.setUniform("uState",this.state),K.drawElements()},wt.prototype.renderFace=function(){l(c(Z.invMatrix,this.matrix,this.transMatrix)),K.setUniform("uMVMatrix",this.transMatrix),K.drawElements()};var Et=[],bt=function(){this.lastTime=+new Date,this.smat=o(),this.smat2=o(),this.smat3=o()};bt.prototype.render=function(){var t=+new Date,e=t-this.lastTime;e=Math.min(30,e),this.lastTime=t;var r=this.smat,i=this.smat2,n=this.smat3;if(K.useBuffer(dt),K.useElements(ct),t-this.throwStarted<3e3)r[3]+=.001*e*20*r[0],r[7]+=.001*e*20*r[4],r[11]+=.001*e*20*r[8],this.checkBaddies();else{Z.matrix;p(-.6,0,.2,1,1,1,1.4,[0,1,0],i),c(u(1.57,[0,0,1],r),i,n),c(Z.matrix,n,r)}l(c(Z.invMatrix,r,i)),m(r,n),K.setUniform("uMVMatrix",i),K.setUniform("uNMatrix",n),K.drawElements()},bt.prototype.thro=function(){this.throwStarted=+new Date},bt.prototype.checkBaddies=function(){for(var t=0;t<Et.length;t++){var e=Et[t],r=e.position[0]-this.smat[3],i=e.position[1]-this.smat[7],n=-e.position[2]-this.smat[11];r*r+i*i+n*n<6&&(Ft++,w.innerHTML=Ft,e.live=0,this.throwStarted=0)}};var xt=new bt,Rt=100,Ft=0,Ut=function(t,e){return t.mv[14]<e.mv[14]?1:-1},It=+new Date,St=!0,kt=function(){St&&(Et=[],Z.position=[125,10,-125],Z.rotation=[0,0]),K.clear(),.02,Z.position[0]<7&&(Z.position[0]=7),Z.position[0]>243&&(Z.position[0]=243),Z.position[2]>-7&&(Z.position[2]=-7),Z.position[2]<-243&&(Z.position[2]=-243);var t=C.heightAt(Z.position[0],-Z.position[2]);Z.position[1]=t+1.5,K.useProgram(Y),l(c(Z.invMatrix,Q,$)),K.setUniform("uMVMatrix",$),K.setUniform("uNMatrix",m(Q,tt)),K.useBuffer(V),K.useElements(O),K.drawElements(),K.useProgram(W),K.setUniform("uUseAlpha",0);for(var e=0;e<et.length;e++)l(c(Z.invMatrix,et[e].mat,rt[e].mv)),m(et[e].mat,rt[e].mn),rt[e].idx=e;rt.sort(Ut);for(e=0;e<et.length;e++){rt[e].idx>250?(K.useBuffer(D),K.useElements(P),K.setUniform("texture1",0),K.setUniform("texture2",1)):(K.useBuffer(_),K.useElements(N),K.setUniform("texture1",6),K.setUniform("texture2",5));var r=rt[e].mv,i=Math.sqrt(r[12]*r[12]+r[14]*r[14]);(r[14]/i<-.7||i<20)&&(K.setUniform("uMVMatrix",r),K.setUniform("uNMatrix",rt[e].mn),K.drawElements())}K.setUniform("texture1",0),K.setUniform("texture2",2),xt.render(),U.enable(U.BLEND),U.depthMask(!1),U.blendFunc(U.SRC_ALPHA,U.ONE),K.useProgram(X),K.useBuffer(yt),K.useElements(Tt),K.setUniform("uTime",+new Date-It);for(e=0;e<Et.length;e++)Et[e].render();U.disable(U.CULL_FACE),U.blendFunc(U.ONE,U.ONE_MINUS_SRC_ALPHA),K.useProgram(W),K.setUniform("uUseAlpha",1),K.useBuffer(mt),K.useElements(ft),K.setUniform("texture1",8);for(e=0;e<Et.length;e++)Et[e].renderFace();U.depthMask(!0),U.disable(U.BLEND),U.enable(U.CULL_FACE),St||requestAnimFrame(kt)};kt(),function(){var t=!1;x.onmousedown=function(e){return 0===e.button?t=[e.clientX,e.clientY]:xt.thro(),e.preventDefault(),!1},x.onmousemove=function(e){t&&!St&&(dx=e.clientX-t[0],dy=e.clientY-t[1],Z.rotateH(.01*-dx),Z.rotateV(.01*-dy),t[0]=e.clientX,t[1]=e.clientY)};var e=[];document.onmouseup=function(e){0===e.button&&(t=!1)},document.addEventListener("keydown",(function(t){e[t.keyCode]=!0}),!1),document.addEventListener("keyup",(function(t){e[t.keyCode]=!1}),!1);var r=+new Date;setInterval((function(){var t=+new Date,i=t-r;i=Math.min(30,i),r=t,St||(e[87]&&Z.move(2,-.1*i*.1),e[83]&&Z.move(2,.1*i*.1),e[68]&&Z.move(0,.1*i*.1),e[65]&&Z.move(0,-.1*i*.1))}),15),document.body.oncontextmenu=function(){return!1}}(),document.body.style.display="block"}),500)</script>