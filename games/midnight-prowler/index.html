<!doctype html><title>Midnight Prowler - js13kGames 2025</title><style>body{margin:0;background:#000;overflow:hidden;font-family:monospace}canvas{display:block;width:100vw;height:100vh;position:absolute;top:0;left:0}.hint{position:fixed;left:50%;top:16px;transform:translateX(-50%);color:#9cf;font:14px/1.4 monospace;opacity:.75;user-select:none;z-index:2}.ui{position:fixed;top:16px;left:16px;color:#fff;font:14px monospace;text-shadow:1px 1px 2px #000;z-index:3}</style><canvas id=game-canvas></canvas><div class=hint>Click on the screen to start · Mouse to turn · WASD to move · Spacebar to jump</div><div class=ui id=ui></div><script>var t={width:window.innerWidth,height:window.innerHeight,player:{initialHP:200,maxHP:200,normalSpeed:1.6,runSpeed:3,initialPosition:{x:2.4,y:2.5},initialDirection:{x:.707,y:-.707},initialPlane:{x:.707,y:.707},attackRange:1.5,attackDamage:30,attackCooldown:600,fireball:{speed:10,size:.2,life:500,damage:20,spawnDistance:1,offsetX:0,offsetY:0,light:{radius:7,intensity:1.3,color:{r:255,g:165,b:0}}}},monster:{defaultHP:75,defaultSpeed:1.8,detectionRange:8,attackRange:2,attackCooldown:1500,attackDamage:20,size:1.5,teleportTrigger:[{x:31.5,y:35},{x:19,y:38.5}],teleportRange:1},miniMap:{size:150,padding:15,exploreRadius:2},rendering:{rotationSensitivity:5e-4,cameraFollowSpeed:.05}},e=["11111111111111111111111111111111111111111","1.....1...........1.....1...............1","1...........1.....1.....................1","1.....1.....1.....1...........1.........1","11111111111111.111111..111111111111....11","1....1111.1111....1.....1.....1.........1","1....1.......1....1.....1.11111.1111....1","1....1.......1..........1.1........1....1","11..11..22...111111111111.1........1.1111","1.......22........1.....1.1...33...1....1","1....1.......1....1.....1.....33........1","1....1.......1....1.......1........1....1","1111.........111111111111.1........111.11","1.....111.1111....1.....1.11111.1111....1","1...........1.....1.....1.....1.........1","1.....1.....1.....1.....1.....1.........1","11111111111.111111111.11111..111111111111","1.....1.................1.....1.........1","1.....1.................1.....1.........1","1...........1.................1.........1","1....111111111111111111.111111111.1111111","1.....1.....1.....1.....1.....1.........1","1...........1.....1.....1.....1.........1","1.....1.....1.....1.....1...............1","1....11111.111111111111111111111111.11111","1.....1.....1.....1.....1.....1.........1","1.....1.11111.11111.....1..1111.1111....1","1.......1........11.....1..1.......1....1","1111111.1........11111111111.......111111","1.....1.1........11........1..33...1....1","1.....1.1..22....11...........33........1","1.....1....22..............1.......1....1","111111111........111.1111111.......111111","1....1..1........11.....1..1.......1....1","1....1..1........11.....1..1111.1111....1","1....1..11111.11111.....1...............1","111.11..11111.11111111111...............1","1.....1.....1.....1.....................1","1.......................................1","1.....1.....1.....1.....................1","11111111111111111111111111111111111111111"],i=e[0].length,a=e.length,s=e.map(t=>[...t].map(t=>"."===t?0:+t||1)),r=[{x:11.5,y:7.5,dirX:1,dirY:0,hp:70,maxHP:70,speed:1,state:"patrol",detectionRange:8,attackRange:2,patrolTarget:{x:12,y:7},alertness:0,lastAttack:0,attackCooldown:1500,teleportDest:{x:38,y:38}},{x:32.5,y:11.5,dirX:-1,dirY:0,hp:85,maxHP:85,speed:1.2,state:"patrol",detectionRange:9,attackRange:2.5,patrolTarget:{x:27,y:11},alertness:0,lastAttack:0,attackCooldown:1700,teleportDest:{x:38,y:37}},{x:9.5,y:28.5,dirX:0,dirY:1,hp:100,maxHP:100,speed:1.4,state:"patrol",detectionRange:10,attackRange:2,patrolTarget:{x:9,y:34},alertness:0,lastAttack:0,attackCooldown:1900,teleportDest:{x:37,y:37}},{x:34.5,y:28.5,dirX:0,dirY:-1,hp:70,maxHP:70,speed:1.6,state:"patrol",detectionRange:11,attackRange:2.5,patrolTarget:{x:34,y:27},alertness:0,lastAttack:0,attackCooldown:2100,teleportDest:{x:36,y:38}},{x:20.5,y:5.5,dirX:1,dirY:0,hp:85,maxHP:85,speed:1,state:"patrol",detectionRange:12,attackRange:2,patrolTarget:{x:23,y:5},alertness:0,lastAttack:0,attackCooldown:1500,teleportDest:{x:34,y:38}},{x:20.5,y:15.5,dirX:-1,dirY:0,hp:100,maxHP:100,speed:1.2,state:"patrol",detectionRange:8,attackRange:2.5,patrolTarget:{x:19,y:15},alertness:0,lastAttack:0,attackCooldown:1700,teleportDest:{x:32,y:37}},{x:20.5,y:25.5,dirX:0,dirY:1,hp:70,maxHP:70,speed:1.4,state:"patrol",detectionRange:9,attackRange:2,patrolTarget:{x:20,y:27},alertness:0,lastAttack:0,attackCooldown:1900,teleportDest:{x:30,y:37}},{x:20.5,y:35.5,dirX:0,dirY:-1,hp:85,maxHP:85,speed:1.6,state:"patrol",detectionRange:10,attackRange:2.5,patrolTarget:{x:20,y:29},alertness:0,lastAttack:0,attackCooldown:2100,teleportDest:{x:30,y:38}},{x:4.5,y:24.5,dirX:1,dirY:0,hp:100,maxHP:100,speed:1,state:"patrol",detectionRange:11,attackRange:2,patrolTarget:{x:4,y:24},alertness:0,lastAttack:0,attackCooldown:1500,teleportDest:{x:34,y:30}},{x:10.5,y:14.5,dirX:-1,dirY:0,hp:70,maxHP:70,speed:1.2,state:"patrol",detectionRange:12,attackRange:2.5,patrolTarget:{x:4,y:14},alertness:0,lastAttack:0,attackCooldown:1700,teleportDest:{x:32,y:30}},{x:10.5,y:34.5,dirX:0,dirY:1,hp:85,maxHP:85,speed:1.4,state:"patrol",detectionRange:8,attackRange:2,patrolTarget:{x:10,y:34},alertness:0,lastAttack:0,attackCooldown:1900,teleportDest:{x:30,y:32}},{x:33.5,y:12.5,dirX:0,dirY:-1,hp:100,maxHP:100,speed:1.6,state:"patrol",detectionRange:9,attackRange:2.5,patrolTarget:{x:33,y:7},alertness:0,lastAttack:0,attackCooldown:2100,teleportDest:{x:29,y:29}},{x:35.5,y:30.5,dirX:1,dirY:0,hp:70,maxHP:70,speed:1,state:"patrol",detectionRange:10,attackRange:2,patrolTarget:{x:39,y:30},alertness:0,lastAttack:0,attackCooldown:1500,teleportDest:{x:30,y:38}},{x:4.5,y:30.5,dirX:-1,dirY:0,hp:85,maxHP:85,speed:1.2,state:"patrol",detectionRange:11,attackRange:2.5,patrolTarget:{x:1,y:30},alertness:0,lastAttack:0,attackCooldown:1700,teleportDest:{x:30,y:37}},{x:21.5,y:18.5,dirX:0,dirY:1,hp:100,maxHP:100,speed:1.4,state:"patrol",detectionRange:12,attackRange:1,patrolTarget:{x:21,y:19},alertness:0,lastAttack:0,attackCooldown:1900,teleportDest:{x:15,y:38}},{x:16.5,y:5.5,dirX:0,dirY:-1,hp:70,maxHP:70,speed:1.6,state:"patrol",detectionRange:8,attackRange:1.5,patrolTarget:{x:16,y:5},alertness:0,lastAttack:0,attackCooldown:2100,teleportDest:{x:14,y:37}},{x:32.5,y:30.5,dirX:1,dirY:0,hp:85,maxHP:85,speed:1,state:"patrol",detectionRange:9,attackRange:2,patrolTarget:{x:38,y:30},alertness:0,lastAttack:0,attackCooldown:1500,teleportDest:{x:25,y:37}},{x:2.5,y:30.5,dirX:-1,dirY:0,hp:100,maxHP:100,speed:1.2,state:"patrol",detectionRange:10,attackRange:2.5,patrolTarget:{x:1,y:30},alertness:0,lastAttack:0,attackCooldown:1700,teleportDest:{x:23,y:38.5}}],n=new class{constructor(){this.map=s,this.width=i,this.height=a,this.explored=Array(a).fill().map(()=>Array(i).fill(!1))}isEmpty(t,e){let i=Math.trunc(t),a=Math.trunc(e);return i>=0&&a>=0&&i<this.width&&a<this.height&&0===this.map[a][i]}getTile(t,e){let i=Math.trunc(t),a=Math.trunc(e);return i>=0&&a>=0&&i<this.width&&a<this.height?this.map[a][i]:1}updateExploration(t,e,i=2){let a=Math.trunc(t),s=Math.trunc(e);for(let t=-i;t<=i;t++)for(let e=-i;e<=i;e++){let r=a+Math.round(e),n=s+Math.round(t);Math.sqrt(e*e+t*t)<=i&&r>=0&&r<this.width&&n>=0&&n<this.height&&(this.explored[n][r]=!0)}}checkLineOfSight(t,e,i,a){let s=Math.abs(i-t),r=Math.abs(a-e),n=2*Math.max(s,r);for(let s=0;s<=n;s++){let r=t+(i-t)*s/n,o=e+(a-e)*s/n;if(!this.isEmpty(r,o))return!1}return!0}isExplored(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height&&this.explored[e][t]}resetExploration(){this.explored=Array(a).fill().map(()=>Array(i).fill(!1))}},o=new class{constructor(){this.audioContext=null,this.sounds={},this.isInitialized=!1}initialize(){if(!this.isInitialized&&!this.audioContext)try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.isInitialized=!0,this._createSounds(),console.log("Audio system initialized successfully.")}catch(t){console.error("Web Audio API is not supported in this browser.",t)}}_createSounds(){this.sounds.player_hit=this._createPlayerHitSound.bind(this),this.sounds.explosion=this._createExplosionSound.bind(this)}playSound(t,{volume:e=1,pitch:i=1}={}){!this.isInitialized||!this.sounds[t]||this.sounds[t]({volume:e,pitch:i})}_createPlayerHitSound({volume:t,pitch:e}){let i=this.audioContext,a=i.createOscillator(),s=i.createGain();a.type="sawtooth",a.frequency.setValueAtTime(200*e,i.currentTime),a.frequency.exponentialRampToValueAtTime(50*e,i.currentTime+.2),s.gain.setValueAtTime(.5*t,i.currentTime),s.gain.exponentialRampToValueAtTime(.001,i.currentTime+.2),a.connect(s),s.connect(i.destination),a.start(i.currentTime),a.stop(i.currentTime+.2)}_createExplosionSound({volume:t,pitch:e}){let i=this.audioContext,a=i.currentTime,s=i.createOscillator();s.type="sine",s.frequency.setValueAtTime(120*e,a),s.frequency.exponentialRampToValueAtTime(40*e,a+.25);let r=i.createGain();r.gain.setValueAtTime(1*t,a),r.gain.exponentialRampToValueAtTime(.01,a+.4),s.connect(r).connect(i.destination);let n=i.createBuffer(1,.5*i.sampleRate,i.sampleRate),o=n.getChannelData(0);for(let t=0;t<o.length;t++)o[t]=2*Math.random()-1;let l=i.createBufferSource();l.buffer=n;let h=i.createBiquadFilter();h.type="bandpass",h.frequency.setValueAtTime(1500*e,a),h.frequency.exponentialRampToValueAtTime(300*e,a+.3),h.Q.value=1;let d=i.createGain();d.gain.setValueAtTime(.6*t,a),d.gain.exponentialRampToValueAtTime(.01,a+.4),l.connect(h).connect(d).connect(i.destination),s.start(a),l.start(a),s.stop(a+.6),l.stop(a+.5)}},l=[],h=function(t,e){o.playSound("explosion",{volume:.5,pitch:.8+.4*Math.random()});for(let i=0;i<25;i++){let i=2*Math.random()*Math.PI,a=9*Math.random(),s={type:"explosion_particle",x:t,y:e,vx:Math.cos(i)*a,vy:Math.sin(i)*a,vz:9*(Math.random()-.2)*1.5,life:.5*(.7+.3*Math.random()),maxLife:.5,size:.18*(.5+.5*Math.random()),color:{start:{r:255,g:255,b:100},end:{r:255,g:69,b:0}}};l.push(s)}},d=[],c=t.player.fireball,p=function(){return d},g=new class{constructor(){this.uiElement=document.getElementById("ui"),this.showingDialog=!1,this.dialogMessage="",this.dialogCallback=null,this.redOverlayAlpha=0,this.fadeOutSpeed=.02}checkInput(t){this.showingDialog&&t.keys[" "]&&(this.dialogCallback&&this.dialogCallback(),this.showingDialog=!1,this.dialogMessage="",this.dialogCallback=null)}update(t,e,i){if(i&&this.checkInput(i),!this.uiElement)return;let a=x.hp,s=x.maxHP,r=u.getAliveCount(),n=u.getAllMonsters().length;if(this.uiElement.innerHTML=`\n      <div>HP: ${a}/${s}</div>\n      <div>Monster: ${r}/${n}</div>\n    `,this.redOverlayAlpha>0&&(t.fillStyle=`rgba(255, 0, 0, ${this.redOverlayAlpha})`,t.fillRect(0,0,e.width,e.height),this.redOverlayAlpha=Math.max(0,this.redOverlayAlpha-this.fadeOutSpeed)),this.showingDialog){let i=.6*e.width,a=.2*e.height,s=(e.width-i)/2,r=(e.height-a)/2;t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(s,r,i,a),t.strokeStyle="#ff0000",t.lineWidth=2,t.strokeRect(s,r,i,a),t.fillStyle="#ffffff",t.font="20px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(this.dialogMessage,e.width/2,e.height/2-10),t.font="16px Arial",t.fillText("Press Space to continue...",e.width/2,e.height/2+20)}if(this.showingDialog){let i=.6*e.width,a=.2*e.height,s=(e.width-i)/2,r=(e.height-a)/2;t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(s,r,i,a),t.strokeStyle="#ff0000",t.lineWidth=2,t.strokeRect(s,r,i,a),t.fillStyle="#ffffff",t.font="20px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(this.dialogMessage,e.width/2,e.height/2-10),t.font="16px Arial",t.fillText("Press Space to continue...",e.width/2,e.height/2+20)}}renderCrosshair(t,e){let i=e.width/2,a=e.height/2;t.strokeStyle="#ffffff",t.lineWidth=2,t.beginPath(),t.moveTo(i,a-10),t.lineTo(i,a+10),t.moveTo(i-10,a),t.lineTo(i+10,a),t.stroke()}renderMiniMap(e,i){let a=t.miniMap.size,s=t.miniMap.padding,r=i.width-a-s,o=s,l=a/Math.max(n.width,n.height);e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(r-2,o-2,a+4,a+4);for(let t=0;t<n.height;t++)for(let i=0;i<n.width;i++){let a=r+i*l,s=o+t*l;if(n.isExplored(i,t)){let a=n.getTile(i+.5,t+.5);0===a?e.fillStyle="rgba(200, 200, 200, 0.8)":1===a?e.fillStyle="rgba(100, 100, 100, 0.9)":2===a?e.fillStyle="rgba(120, 180, 170, 0.9)":3===a&&(e.fillStyle="rgba(200, 120, 110, 0.9)")}else e.fillStyle="rgba(0, 0, 0, 0.9)";e.fillRect(a,s,l,l)}let h=x.getPosition(),d=r+h.x*l-2,c=o+h.y*l-2;e.fillStyle="#00ff00",e.fillRect(d,c,4,4),u.getAllMonsters().forEach(t=>{if(t.hp>0){let i=r+t.x*l-2,a=o+t.y*l-2;e.fillStyle="chase"===t.state||"attack"===t.state?"#ff0000":"#ff8800",e.fillRect(i,a,4,4)}});let p=x.getDirection();e.strokeStyle="#00ff00",e.lineWidth=2,e.beginPath(),e.moveTo(d+2,c+2),e.lineTo(d+2+8*p.x,c+2+8*p.y),e.stroke()}showGameFinish(t={}){let{stats:e,isSuccess:i}=t;document.getElementById("gFin")&&document.getElementById("gFin").remove();let a=document.createElement("style");a.id="gFin",a.textContent=`\n    #gOverlay{\n      position:fixed; inset:0; z-index:1000; color:#fff; overflow:hidden;\n      display:flex; align-items:center; justify-content:center;\n      background: radial-gradient(1200px 800px at 50% 120%, #0a0d14 0%, #070a12 60%, #04060b 100%);\n      animation: go-fade .35s ease-out both;\n    }\n    /* Vignette + Scanlines */\n    #gOverlay::before{\n      content:""; position:absolute; inset:0; pointer-events:none;\n      background:\n        radial-gradient(70% 60% at 50% 50%, rgba(0,0,0,0) 0%, rgba(0,0,0,.45) 100%),\n        repeating-linear-gradient(0deg, rgba(255,255,255,.02) 0 2px, rgba(0,0,0,0) 2px 4px);\n      mix-blend-mode: normal;\n    }\n\n\n    /* Center glass card */\n    .go-card{\n      width:min(560px,86vw); padding:28px 36px 24px;\n      background: rgba(10,12,18,.55);\n      border:2px solid ${i?"rgba(62, 220, 62, 0.28)":"rgba(255,70,70,.28)"};\n      border-radius:16px;\n      text-align:center;\n      animation: go-shake .7s cubic-bezier(.36,.07,.19,.97) 1;\n      z-index: 100;\n    }\n\n    /* Title: White text + red/blue offset glitch */\n    .go-title{\n      font: 800 42px/1.1 "Noto Sans TC", system-ui, sans-serif;\n      letter-spacing:.08em;\n    }\n    \n    .go-sub{ margin-top:8px; color:#cdd3e1; opacity:.85; font-size:14px; }\n    .go-stats{\n      margin:14px auto 0; display:flex; gap:14px; justify-content:center; flex-wrap:wrap;\n      color:#dcdfe8; opacity:.9; font-size:13px;\n    }\n    .go-stat{ padding:6px 10px; border:1px solid rgba(255,255,255,.08); border-radius:10px; background:rgba(255,255,255,.04); }\n\n    .go-cta{ margin-top:16px; color:#ffd7d2; font-size:14px; opacity:.95; }\n    .key{\n      display:inline-block; min-width:1.6em; padding:.1em .55em; margin-right:.35em;\n      border-radius:8px; border:1px solid ${i?"rgba(62, 220, 62, 0.45)":"rgba(255,70,70,.45)"};\n      background:linear-gradient(180deg,   ${i?"rgba(62, 220, 62, 0.25)":"rgba(255,120,110,.22)"}, rgba(255,60,50,.12));\n      font-weight:700; color:#fff;\n    }\n\n    /* Falling cinder particles */\n    .go-cinder{\n      position:absolute; top:-8vh; width:6px; height:6px; border-radius:50%;\n      background: radial-gradient(circle at 35% 35%, ${i?"#f9f9f9 0%, #ffffff 40%, #fdfdfd 70%, rgba(255, 0, 0, 0)":"#ffd0c3 0%, #ff7a65 40%, #ff3a2a 70%, rgba(255,0,0,0)"} 100%);\n      filter:saturate(1.1);\n      animation: go-fall var(--dur) linear var(--delay) infinite;\n      opacity:.85;\n    }\n\n    @keyframes go-fade{ from{opacity:0} to{opacity:1} }\n    @keyframes go-shake{\n      10%, 90% { transform: translate3d(-1px, 0, 0) }\n      20%, 80% { transform: translate3d( 2px, 0, 0) }\n      30%, 50%, 70% { transform: translate3d(-4px, 0, 0) }\n      40%, 60% { transform: translate3d( 4px, 0, 0) }\n    }\n    @keyframes go-glitch{\n      0%{ clip-path: inset(0 0 82% 0) } 10%{ clip-path: inset(10% 0 60% 0) }\n      20%{ clip-path: inset(85% 0 0 0) } 30%{ clip-path: inset(40% 0 30% 0) }\n      40%{ clip-path: inset(0 0 65% 0) } 50%{ clip-path: inset(20% 0 40% 0) }\n      60%{ clip-path: inset(70% 0 5% 0) } 70%{ clip-path: inset(45% 0 25% 0) }\n      80%{ clip-path: inset(5% 0 75% 0) } 90%{ clip-path: inset(25% 0 35% 0) }\n      100%{ clip-path: inset(0 0 82% 0) }\n    }\n    @keyframes go-fall{\n      0%   { transform: translateY(-10vh) translateX(0) scale(.7); opacity:0 }\n      10%  { opacity:.9 }\n      100% { transform: translateY(120vh) translateX(var(--drift)) scale(1.15); opacity:0 }\n    }\n    `,document.head.appendChild(a);let s=document.createElement("div");s.id="gOverlay";let r=document.createElement("div");r.className="go-card",r.innerHTML=i?'\n    <div class="go-title">Victory</div>\n    <div class="go-sub">The night is guarded.</div>':'\n    <div class="go-title" data-text="Game Over">Game Over</div>\n    <div class="go-sub">This round failed to hold onto the night.</div>',r.innerHTML+=`\n    ${e?`<div class="go-stats">\n      ${e.time?`<div class="go-stat">Survival Time: ${e.time}</div>`:""}\n      ${null!=e.kills?`<div class="go-stat">Kills: ${e.kills}</div>`:""}\n      ${null!=e.score?`<div class="go-stat">Score: ${e.score}</div>`:""}\n    </div>`:""}\n    <div class="go-cta"><span class="key">R</span>Restart</div>\n  `,s.appendChild(r);for(let t=0;t<28;t++){let t=document.createElement("i");t.className="go-cinder";let e=100*Math.random(),i=40*Math.random()-20+"vw",a=(6+7*Math.random()).toFixed(2)+"s",r=(7*-Math.random()).toFixed(2)+"s";t.style.left=e+"vw",t.style.setProperty("--drift",i),t.style.setProperty("--dur",a),t.style.setProperty("--delay",r),s.appendChild(t)}return window.addEventListener("keydown",function t(e){("r"===e.key||"R"===e.key)&&(window.removeEventListener("keydown",t),s.remove(),"function"==typeof onRestart&&onRestart())}),document.body.appendChild(s),s}showAlertDialog(t,e){if(!document.getElementById("alert-dialog-css")){let t=document.createElement("style");t.id="alert-dialog-css",t.textContent='\n        #olay {\n          position: fixed;\n          inset: 0;\n          z-index: 1000;\n          color: #fff;\n          overflow: hidden;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          background: radial-gradient(1200px 800px at 50% 120%, #0a0d1480 0%, #070a1280 60%, #04060b80 100%);\n          animation: alert-fade-in 0.3s ease-out both;\n        }\n\n        .alert-card {\n          position: relative;\n          width: min(460px, 80vw);\n          padding: 24px 32px 20px;\n          background: rgba(10, 12, 18, 0.95);\n          border: 2px solid rgba(255, 50, 50, 0.4);\n          border-radius: 16px;\n          box-shadow: 0 24px 80px rgba(0, 0, 0, 0.6), inset 0 0 80px rgba(255, 70, 80, 0.1);\n          backdrop-filter: blur(6px);\n          text-align: center;\n          animation: alert-pulse 0.5s ease-out both;\n        }\n\n        .alert-message {\n          font: 700 20px/1.4 "Noto Sans TC", system-ui, sans-serif;\n          color: #fff;\n          text-shadow: 0 0 20px rgba(255, 80, 80, 0.4);\n          margin-bottom: 20px;\n        }\n\n        .alert-cta {\n          color: #ffd7d2;\n          font-size: 14px;\n          opacity: 0.95;\n        }\n\n        .key {\n          display: inline-block;\n          min-width: 1.6em;\n          padding: 0.1em 0.55em;\n          margin-right: 0.35em;\n          border-radius: 8px;\n          border: 1px solid rgba(255, 140, 140, 0.45);\n          background: linear-gradient(180deg, rgba(255, 120, 110, 0.25), rgba(255, 60, 50, 0.15));\n          box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.25), 0 0 12px rgba(255, 80, 60, 0.25);\n          font-weight: 700;\n          color: #fff;\n        }\n\n        @keyframes alert-fade-in {\n          from { opacity: 0; }\n          to { opacity: 1; }\n        }\n\n        @keyframes alert-pulse {\n          0% { transform: scale(0.96); opacity: 0; }\n          50% { transform: scale(1.02); }\n          100% { transform: scale(1); opacity: 1; }\n        }\n      ',document.head.appendChild(t)}let i=document.createElement("div");i.id="olay";let a=document.createElement("div");return a.className="alert-card",a.innerHTML=`\n      <div class="alert-message">${t}</div>\n      <div class="alert-cta"><span class="key">Space</span>Continue</div>\n    `,i.appendChild(a),window.addEventListener("keydown",function t(a){"Space"===a.code&&(window.removeEventListener("keydown",t),i.remove(),"function"==typeof e&&e())}),document.body.appendChild(i),i}removeOverlay(t){t&&t.parentNode&&t.parentNode.removeChild(t)}},y=null,f=null,m=class{constructor(t){this.x=t.x,this.y=t.y,this.dirX=t.dirX,this.dirY=t.dirY,this.hp=t.hp,this.maxHP=t.maxHP,this.speed=t.speed,this.state=t.state,this.detectionRange=t.detectionRange,this.attackRange=t.attackRange,this.size=t.size||1,this.patrolTarget={...t.patrolTarget},this.alertness=t.alertness,this.lastAttack=t.lastAttack,this.attackCooldown=t.attackCooldown,this.lastSeen={x:0,y:0},this.teleportDest=t.teleportDest||null,this.animationTime=0,this.isAttacking=!1,this.attackAnimationTime=0}takeDamage(t){this.hp=Math.max(0,this.hp-t),this.hp<=0&&(this.state="dead")}isAlive(){return this.hp>0}getAnimationState(){return{isAttacking:this.isAttacking,attackProgress:this.isAttacking?this.attackAnimationTime/.8:0,isMoving:"patrol"===this.state||"chase"===this.state,animationTime:this.animationTime}}update(t){if(!this.isAlive())return;let e=y.getPosition(),i=Math.sqrt((this.x-e.x)**2+(this.y-e.y)**2),a=n.checkLineOfSight(this.x,this.y,e.x,e.y),s=performance.now();switch(this.animationTime+=t,this.isAttacking&&(this.attackAnimationTime+=t,this.attackAnimationTime>.8&&(this.isAttacking=!1,this.attackAnimationTime=0)),this.state){case"patrol":this.updatePatrolState(t,e,i,a);break;case"chase":this.updateChaseState(t,e,i,a);break;case"attack":this.updateAttackState(t,e,i,s)}}updatePatrolState(t,e,i,a){if(Math.sqrt((this.x-this.patrolTarget.x)**2+(this.y-this.patrolTarget.y)**2)<.5)this.patrolTarget={x:3+Math.random()*(n.width-6),y:3+Math.random()*(n.height-6)};else{let e=this.patrolTarget.x-this.x,i=this.patrolTarget.y-this.y,a=Math.sqrt(e*e+i*i);this.dirX=e/a,this.dirY=i/a;let s=this.x+this.dirX*this.speed*.5*t,r=this.y+this.dirY*this.speed*.5*t;n.isEmpty(s,this.y)&&(this.x=s),n.isEmpty(this.x,r)&&(this.y=r)}i<this.detectionRange&&a&&(this.state="chase",this.lastSeen={x:e.x,y:e.y},this.alertness=100)}updateChaseState(t,e,i,a){if(a&&i<1.5*this.detectionRange)this.lastSeen={x:e.x,y:e.y},this.alertness=100;else if(this.alertness-=20*t,this.alertness<=0)return void(this.state="patrol");let s=this.lastSeen.x-this.x,r=this.lastSeen.y-this.y,o=Math.sqrt(s*s+r*r);if(o<this.attackRange)this.state="attack";else{this.dirX=s/o,this.dirY=r/o;let e=this.x+this.dirX*this.speed*t,i=this.y+this.dirY*this.speed*t;n.isEmpty(e,this.y)&&(this.x=e),n.isEmpty(this.x,i)&&(this.y=i)}}updateAttackState(e,i,a,s){if(a>1.2*this.attackRange)this.state="chase";else if(s-this.lastAttack>this.attackCooldown){let e=t.monster.attackDamage;y.takeDamage(e),this.lastAttack=s,this.isAttacking=!0,this.attackAnimationTime=0,o.playSound("player_hit",{volume:.6}),f&&f.triggerScreenShake(15,.3,{isAlarm:!1})}}teleport(){this.teleportDest&&(this.x=this.teleportDest.x,this.y=this.teleportDest.y,this.patrolTarget={x:this.teleportDest.x+(4*Math.random()-2),y:this.teleportDest.y+(4*Math.random()-2)},this.state="patrol",this.alertness=0)}},u=new class{constructor(){this.monsters=[],this.hasTeleported=!1,this.reset()}reset(){this.monsters=r.map(t=>new m(t)),this.hasTeleported=!1}update(t){this.monsters.forEach(e=>e.update(t))}getAllMonsters(){return this.monsters}getAliveCount(){return this.monsters.filter(t=>t.isAlive()).length}areAllDead(){return this.monsters.every(t=>!t.isAlive())}checkTeleportTrigger(e,i){if(this.hasTeleported)return;let a=t.monster.teleportTrigger,s=t.monster.teleportRange;a.some(t=>{let a=e-t.x,r=i-t.y;return Math.sqrt(a*a+r*r)<=s})&&(f.gameState="paused",g.showAlertDialog("Warning! Mass enemy teleportation detected!",()=>{f.gameState="playing",this.monsters.forEach(t=>{t.teleportDest&&t.isAlive()&&t.teleport()}),f&&f.triggerAlarmShake(3),this.hasTeleported=!0}))}attackMonstersInRange(t,e,i,a,s,r){let n=0;return this.monsters.forEach(o=>{if(!o.isAlive())return;let l=o.x-t,h=o.y-e;Math.sqrt(l*l+h*h)<=s&&l*i+h*a>0&&(o.takeDamage(r),n++)}),n}},x=new class{constructor(){this.x=t.player.initialPosition.x,this.y=t.player.initialPosition.y,this.z=0,this.velocityZ=0,this.isJumping=!1,this.jumpPower=6.5,this.gravity=18,this.dirX=t.player.initialDirection.x,this.dirY=t.player.initialDirection.y,this.planeX=t.player.initialPlane.x,this.planeY=t.player.initialPlane.y,this.hp=t.player.initialHP,this.maxHP=t.player.maxHP,this.lastAttackTime=0,this.isAttacking=!1,this.attackAnimationTime=0,this.rotate(1580)}update(e,i){let a=(i.shift?t.player.runSpeed:t.player.normalSpeed)*e,s=(i.w?1:0)-(i.s?1:0),r=(i.d?1:0)-(i.a?1:0),o=this.dirX*s+-this.dirY*r,l=this.dirY*s+this.dirX*r,h=this.x+o*a,d=this.y+l*a;n.isEmpty(h,this.y)&&(this.x=h),n.isEmpty(this.x,d)&&(this.y=d),i.jump&&!this.isJumping&&0===this.z&&this.jump(),this.isJumping&&(this.velocityZ-=this.gravity*e,this.z+=this.velocityZ*e,this.z<=0&&(this.z=0,this.velocityZ=0,this.isJumping=!1)),n.updateExploration(this.x,this.y,t.miniMap.exploreRadius),u.checkTeleportTrigger(this.x,this.y),this.isAttacking&&(this.attackAnimationTime+=e,this.attackAnimationTime>.3&&(this.isAttacking=!1,this.attackAnimationTime=0))}jump(){this.isJumping=!0,this.velocityZ=this.jumpPower}rotate(e){let i=e*t.rendering.rotationSensitivity,a=Math.cos(i),s=Math.sin(i),r=this.dirX;this.dirX=this.dirX*a-this.dirY*s,this.dirY=r*s+this.dirY*a;let n=this.planeX;this.planeX=this.planeX*a-this.planeY*s,this.planeY=n*s+this.planeY*a}attack(){let e=performance.now();return!(e-this.lastAttackTime<t.player.attackCooldown||this.isAttacking||(this.isAttacking=!0,this.attackAnimationTime=0,this.lastAttackTime=e,function(t){let e=c.spawnDistance,i=t.x+t.dirX*e,a=t.y+t.dirY*e,s=-t.dirY,r=t.dirX,n=i+s*c.offsetX+t.dirX*c.offsetY,o=a+r*c.offsetX+t.dirY*c.offsetY,l={type:"fireball",x:n,y:o,z:t.z||0,startX:n,startY:o,startZ:t.z||0,vx:t.dirX*c.speed,vy:t.dirY*c.speed,vz:0,size:c.size,life:c.life,damage:c.damage,light:c.light};d.push(l)}(this),0))}takeDamage(t){return this.hp=Math.max(0,this.hp-t),this.hp<=0}isAlive(){return this.hp>0}getPosition(){return{x:this.x,y:this.y}}getDirection(){return{x:this.dirX,y:this.dirY}}getPlane(){return{x:this.planeX,y:this.planeY}}reset(){this.x=t.player.initialPosition.x,this.y=t.player.initialPosition.y,this.z=0,this.velocityZ=0,this.isJumping=!1,this.dirX=t.player.initialDirection.x,this.dirY=t.player.initialDirection.y,this.planeX=t.player.initialPlane.x,this.planeY=t.player.initialPlane.y,this.hp=t.player.initialHP,this.isAttacking=!1,this.attackAnimationTime=0,this.lastAttackTime=0}},k=new class{constructor(){this.keys={},this.mouseEnabled=!1,this.callbacks={attack:[],mousemove:[],continue:[]},this.setupEventListeners()}setupEventListeners(){document.addEventListener("keydown",t=>{this.keys[t.key.toLowerCase()]=!0}),document.addEventListener("keyup",t=>{this.keys[t.key.toLowerCase()]=!1}),document.addEventListener("mousedown",t=>{0===t.button&&this.triggerCallbacks("attack")}),document.addEventListener("mousemove",t=>{this.mouseEnabled&&document.pointerLockElement&&this.triggerCallbacks("mousemove",{movementX:t.movementX,movementY:t.movementY})}),document.addEventListener("pointerlockchange",()=>{this.mouseEnabled=!!document.pointerLockElement})}requestPointerLock(t){t.addEventListener("click",()=>{t.requestPointerLock()})}isKeyPressed(t){return!!this.keys[t.toLowerCase()]}getMovementInput(){return{w:this.isKeyPressed("w"),s:this.isKeyPressed("s"),a:this.isKeyPressed("a"),d:this.isKeyPressed("d"),shift:this.isKeyPressed("shift"),jump:this.isKeyPressed(" "),attack:!1}}onAttack(t){this.callbacks.attack.push(t)}onMouseMove(t){this.callbacks.mousemove.push(t)}triggerCallbacks(t,e=null){this.callbacks[t]&&this.callbacks[t].forEach(t=>{try{t(e)}catch(t){console.error("Callback execution error:",t)}})}update(){let t=this.getMovementInput();return t.attack&&this.triggerCallbacks("attack"),t}},w={renderExplosionParticle:function(t,e,i,a,s,r,n,o){let l=Math.floor(i+s/2);if(l<0||l>=o.length||o[l]<n)return;let h=e.life/e.maxLife,d=e.color.start.r*h+e.color.end.r*(1-h),c=e.color.start.g*h+e.color.end.g*(1-h),p=e.color.start.b*h+e.color.end.b*(1-h),g=h,y=e.vz/n*50,f=s/2,m=t.createRadialGradient(i+f,a+f-y,0,i+f,a+f-y,f),u=`rgba(${Math.floor(d)}, ${Math.floor(c)}, ${Math.floor(p)}, ${g})`,x=`rgba(${Math.floor(d)}, ${Math.floor(c)}, ${Math.floor(p)}, 0)`;m.addColorStop(.3,u),m.addColorStop(1,x),t.fillStyle=m,t.beginPath(),t.arc(i+f,a+f-y,f,0,2*Math.PI),t.fill()}},b=new class{constructor(){this.monsterConfigs={blackCat:{bodyColor:"#000000",eyeColor:"#ff8800",chaseEyeColor:"#ff0000",noseColor:"#660000",whiskerColor:"#cccccc",earInnerColor:"#800000",mouthColor:"#330000",animations:{attack:{duration:.8,lungeIntensity:.1},move:{bobAmount:2,frequency:8}}}}}renderMonster(t,e,i,a,s,r,n,o,l={intensity:1,color:{r:255,g:255,b:255}}){let h=e.hp/e.maxHP,d=e.getAnimationState(),c=this.calculateAnimatedPosition(i,a,s,r,d,e);for(let i=Math.floor(c.x);i<Math.floor(c.x+c.width);i++)if(i>=0&&i<o.length&&n<o[i]){let a=(i-c.x)/c.width;this.drawMonsterStripe(t,i,c.y,c.x,c.width,c.height,a,e,h,d,l)}this.drawHealthBar(t,c,e,h)}applyLightToColor(t,e){let i=function(t){if(!t)return{r:0,g:0,b:0};if(t.startsWith("#")){let e=t.substring(1);return{r:parseInt(e.substring(0,2),16),g:parseInt(e.substring(2,4),16),b:parseInt(e.substring(4,6),16)}}if(t.startsWith("rgb")){let e=t.substring(t.indexOf("(")+1,t.length-1).split(",");return{r:parseInt(e[0].trim()),g:parseInt(e[1].trim()),b:parseInt(e[2].trim())}}return{r:0,g:0,b:0}}(t);return`rgb(${Math.min(255,Math.floor(i.r*e.intensity*(e.color.r/255)))}, ${Math.min(255,Math.floor(i.g*e.intensity*(e.color.g/255)))}, ${Math.min(255,Math.floor(i.b*e.intensity*(e.color.b/255)))})`}calculateAnimatedPosition(t,e,i,a,s,r){let n=t,o=e,l=i,h=a;if(s.isAttacking){let e=this.monsterConfigs.blackCat.animations.attack,d=s.attackProgress;if(d>.2){let s=Math.sin((d-.2)/.8*Math.PI)*e.lungeIntensity;n-=i*s*this.calculatePlayerDirection(r,t,i),l*=1+.08*s,h*=1+.05*s,o-=a*s*.05}n=Math.max(.3*-i,Math.min(800+.3*i,n)),l=Math.max(.8*i,l),h=Math.max(.8*a,h)}if(s.isMoving&&!s.isAttacking){let t=this.monsterConfigs.blackCat.animations.move;o+=Math.sin(s.animationTime*t.frequency)*t.bobAmount}return{x:n,y:o,width:l,height:h}}calculatePlayerDirection(t,e,i){return t.lastSeen?t.lastSeen.x>t.x?1:-1:e+i/2<400?1:-1}drawMonsterStripe(t,e,i,a,s,r,n,o,l,h,d){let c=this.monsterConfigs.blackCat,p=l>.5?c.bodyColor:"#1a0000";h.isAttacking&&(p=this.calculateAttackBodyColor(h.attackProgress));let g=c.eyeColor;("chase"===o.state||"attack"===o.state)&&(g=c.chaseEyeColor),h.isAttacking&&(g=this.calculateAttackEyeColor(h.attackProgress));let y=this.applyLightToColor(p,d),f=this.applyLightToColor(g,d),m=this.applyLightToColor(c.noseColor,d),u=this.applyLightToColor(c.whiskerColor,d),x=this.applyLightToColor("#000000",d),k=this.applyLightToColor(c.earInnerColor,d),w=this.applyLightToColor(c.mouthColor,d),b=this.applyLightToColor("#ffffff",d),S=this.applyLightToColor("#000000",d);this.drawBody(t,e,i,r,n,y),this.drawHead(t,e,i,r,n,y),this.drawEars(t,e,i,r,n,x,k),this.drawEyes(t,e,i,r,n,f,S),this.drawNose(t,e,i,r,n,m),this.drawMouth(t,e,i,r,n,o,h,w,b),this.drawWhiskers(t,e,i,r,n,u)}calculateAttackBodyColor(t){if(t>.3){let e=.3*Math.sin(10*(t-.3))+.7;return`rgb(${Math.floor(30*e)}, 0, 0)`}return"#000000"}drawBody(t,e,i,a,s,r){s>=.15&&s<=.85&&(t.fillStyle=r,t.fillRect(e,i+.6*a,1,.4*a))}drawHead(t,e,i,a,s,r){s>=.05&&s<=.95&&(t.fillStyle=r,t.fillRect(e,i,1,.6*a))}drawEars(t,e,i,a,s,r,n){let o=.25*a;s>=.15&&s<=.3&&this.drawSingleEar(t,e,i,o,s,.15,.15,r,n),s>=.7&&s<=.85&&this.drawSingleEar(t,e,i,o,s,.7,.15,r,n)}drawSingleEar(t,e,i,a,s,r,n,o,l){let h=(s-r)/n,d=Math.sin(h*Math.PI)*a;if(d>0&&(t.fillStyle=o,t.fillRect(e,i-.3*d,1,d),h>.3&&h<.7)){let a=.6*d;t.fillStyle=l,t.fillRect(e,i-.2*d,1,a)}}drawEyes(t,e,i,a,s,r,n){let o=Math.max(3,Math.floor(.18*a)),l=i+.25*a;this.drawSingleEye(t,e,l,o,s,.24,.12,.29,.32,r,n),this.drawSingleEye(t,e,l,o,s,.64,.12,.69,.72,r,n)}drawSingleEye(t,e,i,a,s,r,n,o,l,h,d){s>=r&&s<=r+n&&(t.fillStyle=h,t.fillRect(e,i,1,a),s>=o&&s<=l&&(t.fillStyle=d,t.fillRect(e,i,1,a)))}calculateAttackEyeColor(t){if(t>.3){let e=.5*Math.sin(20*(t-.3))+.5;return`rgb(${Math.floor(255*e)}, ${Math.floor(100*e)}, 0)`}return"#ff8800"}drawNose(t,e,i,a,s,r){if(s>=.45&&s<=.55){let s=i+.45*a;t.fillStyle=r,t.fillRect(e,s,1,.05*a)}}drawMouth(t,e,i,a,s,r,n,o,l){if("chase"===r.state||"attack"===r.state){let r=i+.55*a,h=.15*a,d=.4,c=.6;n.isAttacking&&n.attackProgress>.3&&(d=.38,c=.62),s>=d&&s<=c&&(t.fillStyle=o,t.fillRect(e,r,1,h)),this.drawTeeth(t,e,r,h,s,l)}}drawTeeth(t,e,i,a,s,r){let n=.8*a;(s>=.42&&s<=.44||s>=.56&&s<=.58)&&(t.fillStyle=r,t.fillRect(e,i,1,n)),s>=.48&&s<=.52&&(t.fillStyle=r,t.fillRect(e,i,1,.6*n))}drawWhiskers(t,e,i,a,s,r){let n=i+.4*a,o=i+.45*a,l=i+.5*a;(s>=.1&&s<=.24||s>=.76&&s<=.9)&&(t.fillStyle=r,t.fillRect(e,n,1,2),t.fillRect(e,o,1,2),t.fillRect(e,l,1,2))}drawHealthBar(t,e,i,a){if(i.hp<i.maxHP){let i=Math.max(2,Math.floor(.08*e.height)),s=e.y-i-5;t.fillStyle="#400",t.fillRect(e.x,s,e.width,i),t.fillStyle="#f00",t.fillRect(e.x,s,Math.floor(e.width*a),i)}}},S={renderFireball:function(t,e,i,a,s,r,n,o){let l=i+s/2;if(o[Math.floor(l)]>n){let e=s/2,r=t.createRadialGradient(i+e,a+e,.2*e,i+e,a+e,e);r.addColorStop(0,"white"),r.addColorStop(.2,"yellow"),r.addColorStop(.6,"orange"),r.addColorStop(1,"rgba(255, 0, 0, 0)"),t.fillStyle=r,t.beginPath(),t.arc(i+e,a+e,e,0,2*Math.PI),t.fill()}}},v="#05070e",M="#101829",R={r:60,g:90,b:140};function C(t){let e=parseInt(t.slice(1),16);return{r:e>>16&255,g:e>>8&255,b:255&e}}function A(t){return`rgb(${0|t.r},${0|t.g},${0|t.b})`}function T(t,e,i){return t+(e-t)*i}function P(t,e){return{r:t.r*e,g:t.g*e,b:t.b*e}}function E(t,e){let i=C("#0a101c"),a=Math.min(.75,.05*e),s=Math.min(.55,.045*e),r=function(t,e=.14){let i=R;return{r:t.r*(1-e)+i.r*e,g:t.g*(1-e)+i.g*e,b:t.b*(1-e)+i.b*e}}(t,.14);return r=P(r,1-a),r=function(t,e,i){return{r:T(t.r,e.r,i),g:T(t.g,e.g,i),b:T(t.b,e.b,i)}}(r,i,s),r}function D(t,e=.15){return{r:t.r*(1+e),g:t.g*(1+e),b:t.b*(1+e)}}var z=class{constructor(){this.raycastingRenderer=null,this.gameState="playing",this.lastTime=0,this.overlay=null,this.screenShake={intensity:0,duration:0,time:0,offsetX:0,offsetY:0,isAlarm:!1,alarmColor:!0,pulseCount:0},this.setupDependencies(),this.initRenderer(),this.setupInputHandlers(),this.setupWindowEvents()}setupDependencies(){y=x,function(t){f=t}(this),window.gameEngineRef=this}initRenderer(){let t=document.getElementById("game-canvas");if(!t)throw new Error("Required canvas element not found");this.raycastingRenderer=new class{constructor(t){this.canvas=t,this.context=t.getContext("2d"),this.width=t.width,this.height=t.height,this.zBuffer=new Array(this.width),this.spriteRenderers={monster:b.renderMonster.bind(b),fireball:S.renderFireball.bind(S),explosion_particle:w.renderExplosionParticle.bind(w)},this.setupCanvas()}resize(t,e){this.width=t,this.height=e,this.canvas.width=t,this.canvas.height=e,this.zBuffer=new Array(this.width),this.buildProceduralSky()}nextPow2(t){return 1<<Math.ceil(Math.log2(Math.max(1,t)))}buildProceduralSky(t={}){let e=window.devicePixelRatio||1,i=t.oversampleX??2,a=t.oversampleY??1.2,s=this._skyHorizonRatio??.55,r=Math.ceil(this.width*e*i),n=Math.ceil(this.height*e*s*a);r=Math.min(8192,Math.max(1024,this.nextPow2(r))),n=Math.min(1024,Math.max(256,this.nextPow2(n))),this._skyTexW=r,this._skyTexH=n,this._skyCanvas=document.createElement("canvas"),this._skyCanvas.width=r,this._skyCanvas.height=n,this._skyCtx=this._skyCanvas.getContext("2d");let o=this._skyCtx,l=o.createLinearGradient(0,0,0,n);l.addColorStop(0,v),l.addColorStop(1,M),o.fillStyle=l,o.fillRect(0,0,r,n),this._skyReady=!0}drawProceduralSkySlice(t){if(!this._skyReady||!this._skyCanvas)return!1;let e=this.context,i=this._skyCanvas,a=this._skyTexW,s=this._skyTexH,r=Math.floor(32*(t.z||0)),n=this._skyHorizonRatio??.55,o=0|Math.max(0,Math.min(this.height,Math.floor(this.height*n)+r));if(o<=0)return!0;let l=.5+Math.atan2(t.dirY||0,t.dirX||1)/Math.PI;l-=Math.floor(l);let h=Math.floor(l*a),d=a-h,c=Math.floor(this.width*(d/a));return e.drawImage(i,h,0,d,s,0,0,c,o),e.drawImage(i,0,0,h,s,c,0,this.width-c,o),!0}renderBackground(t={z:0,dirX:1,dirY:0}){if(!this.drawProceduralSkySlice(t)){let e=Math.floor(32*t.z),i=Math.floor(this.height/2+e),a=this.context.createLinearGradient(0,0,0,i);a.addColorStop(0,v),a.addColorStop(1,M),this.context.fillStyle=a,this.context.fillRect(0,0,this.width,i)}let e=Math.floor(32*(t.z||0)),i=Math.floor(this.height*(this._skyHorizonRatio??.55)),a=Math.max(0,Math.min(this.height,i+e)),s=this.context.createLinearGradient(0,a,0,this.height);s.addColorStop(0,"#202631"),s.addColorStop(1,"#141920"),this.context.fillStyle=s,this.context.fillRect(0,a,this.width,this.height-a)}setupCanvas(){this.canvas.width=this.width,this.canvas.height=this.height}render(t,e,i){this.context.clearRect(0,0,this.width,this.height),this.renderBackground(t),this.performRaycasting(t,i),this.renderSprites(t,e,i),this._skyHorizonRatio=.55,this.buildProceduralSky()}postVignette(){let t=this.width/2,e=this.height/2,i=this.context.createRadialGradient(t,1.03*e,.25*this.width,t,e,.8*this.width);i.addColorStop(0,"rgba(0,0,0,0)"),i.addColorStop(1,"rgba(0,0,0,0.35)"),this.context.fillStyle=i,this.context.fillRect(0,0,this.width,this.height)}performRaycasting(t,e){let i=t.getPosition(),a=t.getDirection(),s=t.getPlane();for(let r=0;r<this.width;r++){let o,l,h,d,c=2*r/this.width-1,p=a.x+s.x*c,g=a.y+s.y*c,y=Math.floor(i.x),f=Math.floor(i.y),m=Math.abs(1/p),u=Math.abs(1/g);p<0?(h=-1,o=(i.x-y)*m):(h=1,o=(y+1-i.x)*m),g<0?(d=-1,l=(i.y-f)*u):(d=1,l=(f+1-i.y)*u);let x,k,w=0;for(;0===w;)o<l?(o+=m,y+=h,x=0):(l+=u,f+=d,x=1),n.getTile(y,f)>0&&(w=1);k=0===x?(y-i.x+(1-h)/2)/p:(f-i.y+(1-d)/2)/g;let b=Math.floor(this.height/k),S=Math.floor(32*t.z),v=Math.floor(-b/2+this.height/2+S);v<0&&(v=0);let M,R=Math.floor(b/2+this.height/2+S);switch(R>=this.height&&(R=this.height-1),n.getTile(y,f)){case 1:default:M="#2a2f3a";break;case 2:M="#3b4150";break;case 3:M="#1e232e"}let T=C(M);T=E(T,k),1===x&&(T=P(T,.82));let z=.1,X=1-k/15,Y={r:0,g:0,b:0},L=0,H=i.x+k*(a.x+s.x*(2*r/this.width-1)),I=i.y+k*(a.y+s.y*(2*r/this.width-1));e&&e.length>0&&e.forEach(t=>{let e=H-t.x,i=I-t.y,a=e*e+i*i;if(a<t.radius*t.radius){let e=Math.pow(1-Math.sqrt(a)/t.radius,2),i=t.intensity*e;X+=i,Y.r+=t.color.r*i,Y.g+=t.color.g*i,Y.b+=t.color.b*i,L+=i}});let $={r:255,g:255,b:255};L>0&&($.r=Math.floor(Y.r/L),$.g=Math.floor(Y.g/L),$.b=Math.floor(Y.b/L)),X=Math.max(z,Math.min(2,X));let q={r:Math.floor(T.r*X*($.r/255)),g:Math.floor(T.g*X*($.g/255)),b:Math.floor(T.b*X*($.b/255))},_=A(q);if(this.context.fillStyle=_,this.context.fillRect(r,v,1,R-v),R>v){let t=A(D(q,.18));this.context.fillStyle=t,this.context.fillRect(r,v,1,1)}if(R>=0&&R<this.height){let t=Math.min(.35,.15+.02*k);this.context.fillStyle=`rgba(0,0,0,${t})`,this.context.fillRect(r,R,1,1)}this.context.fillStyle=_,this.context.fillRect(r,v,1,R-v),this.zBuffer[r]=k}}renderSprites(t,e,i){let a=t.getPosition(),s=t.getDirection(),r=t.getPlane();e.forEach(t=>{let e=t.object.x-a.x,i=t.object.y-a.y;t.distanceSq=e*e+i*i}),e.sort((t,e)=>e.distanceSq-t.distanceSq),e.forEach(e=>{let n=e.object.x-a.x,o=e.object.y-a.y,l=1/(r.x*s.y-s.x*r.y),h=l*(s.y*n-s.x*o),d=l*(-r.y*n+r.x*o);if(d>.1){let a=Math.floor(this.width/2*(1+h/d)),s=e.object.scale||1,r=Math.abs(Math.floor(this.height/(d*s))),n=r,o=Math.floor(32*t.z);"fireball"===e.type&&"number"==typeof e.object.z&&(o=Math.floor(32*(t.z-e.object.z)));let l=Math.floor((this.height-r)/2+o),c=Math.floor(a-n/2),p=15,g={intensity:Math.max(.1,1-e.distanceSq/(p*p)),color:{r:255,g:255,b:255}},y={r:0,g:0,b:0},f=0;i&&i.length>0&&(i.forEach(t=>{let i=e.object.x-t.x,a=e.object.y-t.y,s=i*i+a*a;if(s<t.radius*t.radius){let e=Math.pow(1-Math.sqrt(s)/t.radius,2),i=t.intensity*e;g.intensity+=i,y.r+=t.color.r*i,y.g+=t.color.g*i,y.b+=t.color.b*i,f+=i}}),f>0&&(g.color.r=Math.floor(y.r/f),g.color.g=Math.floor(y.g/f),g.color.b=Math.floor(y.b/f))),g.intensity=Math.min(2,g.intensity);let m=this.spriteRenderers[e.type];m&&m(this.context,e.object,c,l,n,r,d,this.zBuffer)}})}}(t),k.requestPointerLock(t);let e=()=>{o.initialize(),t.removeEventListener("click",e,{once:!0})};t.addEventListener("click",e,{once:!0}),this.handleResize()}setupInputHandlers(){k.onAttack(()=>{"playing"===this.gameState&&x.attack()&&this.triggerScreenShake(1,.1)}),k.onMouseMove(t=>{"playing"===this.gameState&&x.rotate(t.movementX)}),document.addEventListener("keydown",t=>{"r"===t.key.toLowerCase()&&("gameOver"===this.gameState||"victory"===this.gameState)&&this.restartGame()})}setupWindowEvents(){window.addEventListener("resize",()=>this.handleResize())}handleResize(){let e=window.innerWidth,i=window.innerHeight;t.width=e,t.height=i,this.raycastingRenderer.resize(e,i)}update(t){if("playing"!==this.gameState)return;let e=k.update();x.update(t,e),u.update(t),function(t,e){for(let i=d.length-1;i>=0;i--){let a=d[i];a.isDead?d.splice(i,1):(a.x+=a.vx*e,a.y+=a.vy*e,a.life-=1,t.isEmpty(a.x,a.y)?(a.life<=0||!t.isEmpty(a.x,a.y)||Math.sqrt(Math.pow(a.x-a.startX,2)+Math.pow(a.y-a.startY,2))>15)&&d.splice(i,1):(h(a.x,a.y),d.splice(i,1)))}}(n,t);let i=u.getAllMonsters(),a=p();(function(t,e,i,a){for(let t of i)if(!t.isDead)for(let i of e){if(!i.isAlive())continue;let e=i.x-t.x,s=i.y-t.y;if(Math.sqrt(e*e+s*s)<i.size+t.size){i.takeDamage(t.damage),t.isDead=!0,h(t.x,t.y),a&&a.triggerScreenShake(4,.15);break}}for(let i of e){if(!i.isAlive())continue;let e=i.x-t.x,a=i.y-t.y;Math.sqrt(e*e+a*a)<i.collisionRadius+t.collisionRadius&&t.takeDamage(i.damage)}})(x,i,a,this),function(t){for(let e=l.length-1;e>=0;e--){let i=l[e];i.life-=t,i.life<=0?l.splice(e,1):(i.x+=i.vx*t,i.y+=i.vy*t,i.vz+=-12*t,i.vx*=.98,i.vy*=.98)}}(t),this.updateScreenShake(t),this.checkGameState()}updateScreenShake(t){if(this.screenShake.duration>0){if(this.screenShake.time+=t,this.screenShake.duration-=t,this.screenShake.isAlarm){let t=2.5/this.screenShake.pulseCount,e=(Math.floor(this.screenShake.time/t),this.screenShake.time%t/t);if(e<.5){let t=this.screenShake.intensity*Math.sin(e*Math.PI);this.screenShake.offsetX=(Math.random()-.5)*t,this.screenShake.offsetY=(Math.random()-.5)*t}else this.screenShake.offsetX=0,this.screenShake.offsetY=0}else{let t=this.screenShake.time/(this.screenShake.time+this.screenShake.duration),e=this.screenShake.intensity*(1-t);this.screenShake.offsetX=(Math.random()-.5)*e,this.screenShake.offsetY=(Math.random()-.5)*e}this.screenShake.duration<=0&&(this.screenShake.intensity=0,this.screenShake.offsetX=0,this.screenShake.offsetY=0,this.screenShake.isAlarm=!1,this.screenShake.alarmColor=null)}}triggerScreenShake(t,e,i={}){this.screenShake.intensity=t,this.screenShake.duration=e,this.screenShake.time=0,this.screenShake.isAlarm=i.isAlarm||!1,this.screenShake.alarmColor=i.alarmColor||null,this.screenShake.pulseCount=i.pulseCount||0}triggerAlarmShake(t=3){this.triggerScreenShake(20,1.5,{isAlarm:!0,alarmColor:"#3201017a",pulseCount:t})}getScreenShakeOffset(){return{x:this.screenShake.offsetX,y:this.screenShake.offsetY}}getFinalState(t){return{isSuccess:t,stats:{kills:u.getAllMonsters().length-u.getAliveCount()}}}checkGameState(){return u.areAllDead()?(this.gameState="victory",void(this.overlay=g.showGameFinish(this.getFinalState(!0)))):x.isAlive()?void 0:(this.gameState="gameOver",void(this.overlay=g.showGameFinish(this.getFinalState(!1))))}render(){let t=this.raycastingRenderer.context,e=this.raycastingRenderer.canvas,i=this.getScreenShakeOffset();t.save(),t.translate(i.x,i.y);let a=[];g.update(t,e,k);let s=[];if(u.getAllMonsters().forEach(t=>{t.isAlive()&&a.push({type:"monster",object:t})}),p().forEach(t=>{a.push({type:"fireball",object:t}),t.light&&s.push({x:t.x,y:t.y,...t.light})}),l.forEach(t=>{a.push({type:"explosion_particle",object:t})}),this.raycastingRenderer.render(x,a,s),this.raycastingRenderer.context.restore(),"playing"===this.gameState&&(g.renderCrosshair(this.raycastingRenderer.context,this.raycastingRenderer.canvas),g.renderMiniMap(this.raycastingRenderer.context,this.raycastingRenderer.canvas)),this.screenShake.isAlarm&&this.screenShake.alarmColor){let t=this.raycastingRenderer.context;t.save();let e=t.createRadialGradient(this.raycastingRenderer.canvas.width/2,this.raycastingRenderer.canvas.height/2,0,this.raycastingRenderer.canvas.width/2,this.raycastingRenderer.canvas.height/2,this.raycastingRenderer.canvas.width/2);e.addColorStop(0,"rgba(84, 0, 0, 0.6)"),e.addColorStop(1,"rgba(255, 0, 0, 0.3)"),t.fillStyle=e,t.globalCompositeOperation="multiply",t.fillRect(0,0,this.raycastingRenderer.canvas.width,this.raycastingRenderer.canvas.height);let i=this.screenShake.time%.5/.5,a=.3*Math.sin(i*Math.PI);t.fillStyle=`rgba(255, 0, 0, ${a})`,t.globalCompositeOperation="screen",t.fillRect(0,0,this.raycastingRenderer.canvas.width,this.raycastingRenderer.canvas.height),t.restore()}g.update()}gameLoop(t){let e=Math.min(.05,.001*(t-this.lastTime));this.lastTime=t,this.update(e),this.render(),requestAnimationFrame(t=>this.gameLoop(t))}start(){this.gameState="playing",this.lastTime=performance.now(),requestAnimationFrame(t=>this.gameLoop(t))}restartGame(){this.overlay&&(g.removeOverlay(this.overlay),this.overlay=null),x.reset(),u.reset(),this.gameState="playing"}getGameState(){return this.gameState}};function X(){return new Promise(t=>{let e=()=>{let e=new z;setTimeout(()=>{e.start(),t(e)},100)};"complete"===document.readyState||"interactive"===document.readyState?e():window.addEventListener("load",e)})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{X()}):X()</script>