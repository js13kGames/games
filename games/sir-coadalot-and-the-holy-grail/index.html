<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="initial-scale=1,width=device-width,user-scalable=no,viewport-fit=cover,maximum-scale=1,user-scalable=no"/><title>Sir Coadalot and the Holy Grail</title><script type=module>import * as THREE from "/2023/webxr/three.module.js";window.THREE = THREE;</script><style>body{margin:0;padding:0}.tmp{color:#a390cf}.panel{position:absolute;width:70%;left:50%;top:50%;transform:translateX(-50%) translateY(-60%);z-index:1000;border-style:solid;border-color:#175230;border-width:20px;background-color:#d4d4b4;padding:40px 40px;color:#494b38;font-family:'Gill Sans','Gill Sans MT',Calibri,'Trebuchet MS',sans-serif;font-size:large;display:none}</style></head><body><div id="openingPanel" class="panel" style="display:block"><h1>Sir Coadalot and the Holy Grail</h1><p>It is the year 1213 and <strong>Sir Coadalot</strong> is 13 years into his quest to find the Holy Grail. He has reached the final hurdle, the <strong>Castle of Doom</strong>. To reach his goal he must navigate the castle with your help.</p><h3>Instructions</h3><p>To move use the right thumbstick</p><p>To turn when attacking use the left thumbstick</p><p>To use your sword press and hold the trigger button</p><p>To start press the vr button below</p></div><div id="gameoverPanel" class="panel" style="display:none"><h1>Gameover</h1><p id="details"></p></div><script type="module">(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),p:""};t.d({},{g:()=>M});const e=1,i=3,s=[new THREE.Vector3(1,0,0),new THREE.Vector3(-1,0,0),new THREE.Vector3(0,1,0),new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,1),new THREE.Vector3(0,0,-1)];class o{constructor(t=.5){this.type=e,this.radius=t}}class n{constructor(t,e){this.type=i,this.min=t,this.max=e}testSphereCollision(t,e,i,s){if(null==t||null==e||null==i||null==s)return!1;const o=function(t,e,i){let s=0;t.x<e.x&&(s+=(e.x-t.x)*(e.x-t.x));t.x>i.x&&(s+=(t.x-i.x)*(t.x-i.x));t.y<e.y&&(s+=(e.y-t.y)*(e.y-t.y));t.y>i.y&&(s+=(t.y-i.y)*(t.y-i.y));t.z<e.z&&(s+=(e.z-t.z)*(e.z-t.z));t.z>i.z&&(s+=(t.z-i.z)*(t.z-i.z));return s}(i,t,e);return o<=s*s}closestPoint(t,e,i=.5,s=!0){const o=t.clone().sub(e).clamp(this.min,this.max);return s&&o.add(e),o}whichDirection(t){let e=0,i=-1;for(let o=0;o<s.length;o++){const n=t.dot(s[o]);n>e&&(e=n,i=o)}return i}}class r{constructor(){this.bodies=[],this.substeps=1,this.gravity=new THREE.Vector3(0,-9.81,0)}addBody(t){this.bodies.push(t)}removeBody(t){const e=this.bodies.indexOf(t);e<0||this.bodies.splice(e,1)}getPointCollisions(t,s,o=.1){const n=[];return this.bodies.forEach((r=>{if(r!=s)switch(r.collider.type){case e:t.distanceTo(r.position)<r.collider.radius&&n.push(r);break;case i:const s=r.collider.min.clone().add(r.position),a=r.collider.max.clone().add(r.position);r.collider.testSphereCollision(s,a,t,o)&&n.push(r)}})),n}step(t){const s=t/this.substeps;for(let t=0;t<this.substeps;t++){let t=0,o=!1;this.bodies.forEach((n=>{if(0!=n.mass&&null!=n.collider&&n.collider.type==e){n.position.clone();n.position.add(n.velocity.clone().multiplyScalar(s)),n.position.y<n.collider.radius&&(n.position.y=n.collider.radius,n.velocity.y=-n.velocity.y*n.restitution);for(let t=0;t<this.bodies.length;t++){const s=this.bodies[t];if(n!=s&&s.active)switch(s.collider.type){case e:const t=n.position.clone().sub(s.position),o=t.length();if(o<2*n.collider.radius){t.multiplyScalar(.5*o-n.collider.radius),n.position.sub(t),t.normalize();const e=n.velocity.clone().sub(s.velocity);t.multiplyScalar(t.dot(e,t)),n.velocity.sub(t)}break;case i:const r=s.collider.min.clone().add(s.position),a=s.collider.max.clone().add(s.position),h=(n.velocity.length(),0);if(s.collider.testSphereCollision(r,a,n.position,n.collider.radius)){const t=s.collider.closestPoint(n.position,s.position),e=n.position.clone().sub(t).normalize(),i=e.clone().multiplyScalar(n.collider.radius+h);n.position=t.clone().add(i),n.onCollision&&n.onCollision(s.mesh.name);switch(s.collider.whichDirection(e.negate())){case 0:n.position.x=r.x-n.collider.radius,n.velocity.x=-n.velocity.x*n.restitution;break;case 1:n.position.x=a.x+n.collider.radius,n.velocity.x=-n.velocity.x*n.restitution;break;case 2:n.position.y=r.y-n.collider.radius,n.velocity.y=-n.velocity.y*n.restitution;break;case 3:n.position.y=a.y+n.collider.radius,n.velocity.y=-n.velocity.y*n.restitution;break;case 4:n.position.z=r.z-n.collider.radius,n.velocity.z=-n.velocity.z*n.restitution;break;case 5:n.position.z=a.z+n.collider.radius,n.velocity.z=-n.velocity.z*n.restitution}n.sfx&&n.playSfx()}}}}o||n.velocity.multiplyScalar(n.damping).add(this.gravity.clone().multiplyScalar(s)),n.mesh&&n.mesh.position.copy(n.position),t++}))}}}class a{constructor(t=null,e=null,i=0){this.mass=i,this.invMass=0!=i?1/i:0,this.position=t?t.position.clone():new THREE.Vector3,this.velocity=new THREE.Vector3,this.damping=.99,this.restitution=.9,this.collider=e,this.active=!0,this.mesh=t,i>0&&e.type,this.sfx=null,this.onCollision=null}playSfx(){const t=this.sfxPlayTime?Date.now()-this.sfxPlayTime:1e3;null==this.sfx||this.sfx.isPlaying||this.velocity.length()<.01||t<500||(this.sfx.play(),this.sfxPlayTime=Date.now())}}const h="data:image/svg+xml, %3Csvg fill='%23ffffff' width='100%' height='auto' viewBox='0 40 700 700' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M608 64H32C14.33 64 0 78.33 0 96v320c0 17.67 14.33 32 32 32h160.22c25.19 0 48.03-14.77 58.36-37.74l27.74-61.64C286.21 331.08 302.35 320 320 320s33.79 11.08 41.68 28.62l27.74 61.64C399.75 433.23 422.6 448 447.78 448H608c17.67 0 32-14.33 32-32V96c0-17.67-14.33-32-32-32zM160 304c-35.35 0-64-28.65-64-64s28.65-64 64-64 64 28.65 64 64-28.65 64-64 64zm320 0c-35.35 0-64-28.65-64-64s28.65-64 64-64 64 28.65 64 64-28.65 64-64 64z'/%3E%3C/svg%3E";class l{constructor(t,e){if(this.renderer=t,void 0!==e?(this.onSessionStart=e.onSessionStart,this.onSessionEnd=e.onSessionEnd,this.sessionInit=e.sessionInit,this.sessionMode=void 0!==e.inline&&e.inline?"inline":"immersive-vr"):this.sessionMode="immersive-vr",void 0===this.sessionInit&&(this.sessionInit={optionalFeatures:["local-floor","bounded-floor"]}),"xr"in navigator){const t=document.createElement("button");t.style.display="none",t.style.height="40px",navigator.xr.isSessionSupported(this.sessionMode).then((i=>{i?this.showEnterVR(t):this.showWebXRNotFound(t),e&&e.vrStatus&&e.vrStatus(i)})),document.body.appendChild(t)}else{const t=document.createElement("a");!1===window.isSecureContext?(t.href=document.location.href.replace(/^http:/,"https:"),t.innerHTML="WEBXR NEEDS HTTPS"):(t.href="https://immersiveweb.dev/",t.innerHTML="WEBXR NOT AVAILABLE"),t.style.left="0px",t.style.width="100%",t.style.textDecoration="none",this.stylizeElement(t,!1),t.style.bottom="0px",t.style.opacity="1",document.body.appendChild(t),e.vrStatus&&e.vrStatus(!1)}}showEnterVR(t){let e=null;const i=this;function s(s){s.addEventListener("end",o),i.renderer.xr.setSession(s),i.stylizeElement(t,!1,12,!0),t.textContent="END GAME",e=s,i.session=s,void 0!==i.onSessionStart&&i.onSessionStart()}function o(){e.removeEventListener("end",o),i.stylizeElement(t,!0,12,!0),t.style.display="",t.style.right="50%",t.style.width="100px",t.style.transform="translateX(50%)",t.style.cursor="pointer",t.innerHTML=`<img src = "${h}" alt="VR Cardboard" style="margin-left: 6px"/>`,e=null,i.session=null,void 0!==i.onSessionEnd&&i.onSessionEnd()}this.stylizeElement(t,!0,30,!0),t.style.display="",t.style.right="50%",t.style.width="100px",t.style.height="56px",t.style.bottom="30px",t.style.transform="translateX(50%)",t.style.cursor="pointer",t.innerHTML=`<img src = "${h}" alt="VR Cardboard" style="margin-left: 6px"/>`,t.onmouseenter=function(){t.style.fontSize="12px",t.textContent=null===e?"PLAY GAME":"EXIT GAME",t.style.opacity="1.0"},t.onmouseleave=function(){t.style.fontSize="30px",t.innerHTML=`<img src = "${h}" alt="VR Cardboard" style="margin-left: 6px"/>`,t.style.opacity="0.5"},t.onclick=function(){if(null===e)navigator.xr.requestSession(i.sessionMode,i.sessionInit).then(s);else try{e.end()}catch(t){console.error(t)}i.onClick&&i.onClick()}}endSession(){this.session&&(this.session.end(),this.session=null)}disableButton(t){t.style.cursor="auto",t.style.opacity="0.5",t.onmouseenter=null,t.onmouseleave=null,t.onclick=null}showWebXRNotFound(t){this.stylizeElement(t,!1),this.disableButton(t),t.style.display="",t.style.width="100%",t.style.right="0px",t.style.bottom="0px",t.style.border="",t.style.opacity="1",t.style.fontSize="13px",t.textContent="VR NOT SUPPORTED"}stylizeElement(t,e=!0,i=13,s=!1){t.style.position="absolute",t.style.bottom="20px",s||(t.style.padding="12px 6px"),t.style.border="1px solid #fff",t.style.borderRadius="4px",t.style.background=e?"rgba(20,150,80,1)":"rgba(180,20,20,1)",t.style.color="#fff",t.style.font=`normal ${i}px sans-serif`,t.style.textAlign="center",t.style.opacity="0.5",t.style.outline="none",t.style.zIndex="999"}}class c extends THREE.InstancedMesh{static STAR=0;constructor(t,e=!1,i={shape:c.STAR}){let s;if(i.shape===c.STAR){s=function(){const t=1,e=.4*t;let i=!0,s=!0;const o=new THREE.Shape;for(let n=0;n<10;n++){const r=2*Math.PI/10*n,a=i?t:e,h=Math.cos(r)*a,l=Math.sin(r)*a;s?(o.moveTo(h,l),s=!1):o.lineTo(h,l),i=!i}const n={steps:1,depth:.1*t,bevelEnabled:!1};return new THREE.ExtrudeGeometry(o,n)}();const t=.2;s.scale(t,t,t)}super(s,new THREE.MeshBasicMaterial,i.count?i.count:50),this.startColor=new THREE.Color(i.startColor?i.startColor:16777215),this.endColor=new THREE.Color(i.endColor?i.endColor:11149858),t.add(this),this.visible=e,this.config=i,this.obj=new THREE.Object3D,this.velocity=[],this.acceleration=[],this.positions=[]}random(t,e){return Math.random()*(e-t)+t}reset(t){this.obj.position.set(0,0,0),this.obj.updateMatrix();const e=.03;let i,s;this.velocity=[],this.acceleration=[],this.positions=[],this.position.copy(t);const o=2*Math.PI/this.count;for(let t=0;t<this.count;t++)this.config.velocity?(i=this.config.velocity.clone(),i.y*=this.random(.4,1.1)):i=new THREE.Vector3(this.random(-1,1)*e,this.random(-1,1)*e,this.random(-1,1)*e),this.config.radius?(s=new THREE.Vector3(Math.cos(o*t)*this.config.radius,0,Math.sin(o*t)*this.config.radius),i.add(s.clone().multiplyScalar(.02))):s=new THREE.Vector3,this.velocity.push(i),this.acceleration.push(i.clone().multiplyScalar(5)),this.positions.push(s),this.setMatrixAt(t,this.obj.matrix);this.instanceMatrix.needsUpdate=!0,this.elapsedTime=0,this.visible=!0}update(t,e){if(this.visible){const t=this.elapsedTime<.5?1:1-2*(this.elapsedTime-.5);this.material.color.lerpColors(this.startColor,this.endColor,this.elapsedTime-.2),this.material.needsUpdate=!0;for(let i=0;i<this.count;i++)this.obj.position.copy(this.positions[i].clone().add(this.velocity[i].clone().multiplyScalar(this.elapsedTime)).add(this.acceleration[i].clone().multiplyScalar(this.elapsedTime*this.elapsedTime))),this.velocity[i].multiplyScalar(.99),this.acceleration[i].multiplyScalar(.99),this.acceleration[i].y-=.05*e,this.obj.rotation.z=6*this.elapsedTime,this.obj.scale.set(t,t,t),this.obj.updateMatrix(),this.positions[i].copy(this.obj.position),this.setMatrixAt(i,this.obj.matrix);this.instanceMatrix.needsUpdate=!0,this.elapsedTime+=e,this.elapsedTime>1&&(this.visible=!1)}}}class d extends THREE.Group{constructor(t=0){if(super(),0===t)this.treeA()}treeA(){const t=new THREE.ConeGeometry(1.3,2.5,10,1,!0);t.translate(0,2.5,0);const e=new THREE.MeshPhongMaterial({color:3562675}),i=new THREE.Mesh(t,e),s=new THREE.Mesh(t,e),o=new THREE.Mesh(t,e);s.position.y=5/3;let n=(5-5/3)/5;s.scale.y=n,s.scale.x=s.scale.z=1.2*n,o.position.y=5/3*2,n=(5-5/3*2)/5,o.scale.y=n,o.scale.x=o.scale.z=1.2*n,this.add(i),this.add(s),this.add(o)}}class p extends THREE.Mesh{constructor(t=.5){const e=new THREE.IcosahedronGeometry(t,8,6);e.translate(0,t,0);const i=e.getAttribute("position");for(let t=0;t<i.array.length;t++)i.array[t]+=.35*(Math.random()-.5);i.needsUpdate=!0;super(e,new THREE.MeshPhongMaterial({color:11184810}))}}class E extends THREE.Group{constructor(t){super();const e=new THREE.LatheGeometry([{x:.3,y:0},{x:.3,y:.06},{x:.05,y:.06},{x:.05,y:.3},{x:.1,y:.32},{x:.2,y:.4},{x:.3,y:.5},{x:.35,y:.6},{x:.4,y:1},{x:.37,y:1},{x:0,y:.33}]),i=new THREE.CylinderGeometry(.5,.5,1.4,6),s=new THREE.CylinderGeometry(1,1,.3,8),o=new THREE.MeshPhongMaterial({color:15776768,emissive:5988618,specular:14277708,shininess:70}),n=new THREE.MeshStandardMaterial({color:12496044,flatShading:!0});this.grail=new THREE.Mesh(e,o);const r=new THREE.Mesh(i,n),a=new THREE.Mesh(s,n),h=new THREE.Mesh(s,n);this.grail.position.y=1.5,r.position.y=.72,a.position.y=.15,h.position.y=1.36,h.scale.set(.8,.8,.8),this.add(a),this.add(r),this.add(h),this.add(this.grail);const l=new THREE.SpotLight(16777215,1,5,Math.PI/6,.5);l.position.set(0,3,1),l.lookAt(this.grail.position),this.add(l);const d=new THREE.NumberKeyframeTrack(".position[y]",[0,.5,1.5],[1.5,2,2.2]),p=new THREE.AnimationClip(null,1.5,[d]);this.mixer=new THREE.AnimationMixer(this.grail),this.action=this.mixer.clipAction(p),this.action.loop=THREE.LoopOnce,this.action.clampWhenFinished=!0,this.mixer.addEventListener("finished",(()=>{this.grail.visible=!1,this.app&&this.app.gameOver({state:M.STATES.COMPLETE})})),t.add(this),this.effect=new c(t,!1,{shape:c.STAR,count:20,velocity:new THREE.Vector3(0,.06,0),radius:1}),this.found=!1}find(t){this.found||(this.reset(),this.effect.reset(this.position),this.action.play(),this.app=t,this.found=!0)}reset(){this.grail.visible=!0,this.action.reset()}update(t,e){this.effect.visible&&this.effect.update(t,e),this.mixer.update(e)}}class m extends THREE.Mesh{constructor(){const t=new THREE.PlaneGeometry(2e3,20,300,10),e=t.getAttribute("position");for(let t=0;t<e.array.length;t++)e.array[t]+=.95*(Math.random()-.5);e.needsUpdate=!0;super(t,new THREE.MeshPhongMaterial({color:10066329,flatShading:!0}))}}class y{constructor(t=3,e=1.5,i=3,s=.75){if(this.root=new THREE.Group,this.root.userData.bounds={width:t,height:e,depth:i},t<.25){const e=t;t=i,i=e}const o=Math.floor(t/s),n=new THREE.Shape;n.moveTo(t/2,e),n.lineTo(t/2,0),n.lineTo(-t/2,0),n.lineTo(-t/2,e);const r=t/(2*o+1);n.lineTo(r-t/2,e);for(let i=0;i<o;i++){let o=r*(1+2*i)-t/2;n.lineTo(o,e-s/2),n.lineTo(o+r,e-s/2),n.lineTo(o+r,e),n.lineTo(o+2*r,e)}n.lineTo(t/2,e);const a={steps:1,depth:i<.25?.5:.25,bevelEnabled:!1},h=new THREE.ExtrudeGeometry(n,a);this.root.userData.bounds.width<.25&&h.rotateY(Math.PI/2);const l=i<.25||t<.25,c=new THREE.MeshStandardMaterial({color:l?14540202:10066346}),d=new THREE.Mesh(h,c);if(d.position.z=-i/2-.1,this.root.add(d),!l){const o=d.clone();o.position.z=i/2-.2;const n=d.clone();n.rotateY(Math.PI/2),n.position.set(-t/2-.1,0,0);const r=n.clone();r.position.x=t/2-.2;const a=new THREE.BoxGeometry(1.15*t,.3,1.15*i),h=new THREE.Mesh(a,c);h.position.y=e-s-.15,this.root.add(h),this.root.add(o),this.root.add(o),this.root.add(n),this.root.add(r)}}}class u extends THREE.Mesh{constructor(t){let e,i;e=i=0;const s=new THREE.Shape;s.moveTo(e+25,25),s.bezierCurveTo(e+25,25,e+20,0,e,0),s.bezierCurveTo(e-30,0,e-30,35,e-30,35),s.bezierCurveTo(e-30,55,e-10,77,e+25,95),s.bezierCurveTo(e+60,77,e+80,55,e+80,35),s.bezierCurveTo(e+80,35,e+80,0,e+50,0),s.bezierCurveTo(e+35,0,e+25,25,e+25,25);const o=new THREE.ExtrudeGeometry(s,{steps:1,depth:10,bevelEnabled:!1}),n=.01;o.scale(n,n,n),o.rotateZ(Math.PI),o.translate(.27,1.5,-.05);super(o,new THREE.MeshStandardMaterial({color:16134058,emissive:1118549})),t&&this.position.copy(t)}}class w extends THREE.Mesh{constructor(t){const e=new THREE.Shape;e.moveTo(0,0),e.lineTo(.4,.3),e.lineTo(.5,1),e.lineTo(.4,1.05),e.lineTo(0,1.1),e.lineTo(-.4,1.05),e.lineTo(-.5,1),e.lineTo(-.4,.3);const i=new THREE.ExtrudeGeometry(e,{steps:1,depth:.3,bevelEnabled:!1});i.translate(0,1,-.15);super(i,new THREE.MeshStandardMaterial({color:10719439,emissive:5325169})),t&&this.position.copy(t)}}class T extends THREE.Mesh{constructor(t){const e=new THREE.Shape;e.moveTo(.4,0),e.lineTo(.6,1.3),e.lineTo(.4,2),e.lineTo(-.4,2),e.lineTo(-.6,1.3),e.lineTo(-.4,0);const i=new THREE.ExtrudeGeometry(e,{steps:1,depth:.9,bevelEnabled:!1});i.translate(0,0,-.45);super(i,new THREE.MeshStandardMaterial({color:7427626,transparent:!0}));const s={duration:1,times:[0,1],rot:[0,Math.PI],pos:[0,2],fade:[1,0]},o=new THREE.NumberKeyframeTrack(".rotation[y]",s.times,s.rot),n=new THREE.NumberKeyframeTrack(".position[y]",s.times,s.pos),r=new THREE.NumberKeyframeTrack(".material.opacity",s.times,s.fade),a=new THREE.AnimationClip("animate",s.duration,[o,n,r]);this.mixer=new THREE.AnimationMixer(this),this.action=this.mixer.clipAction(a),this.action.clampWhenFinished=!0,this.action.loop=THREE.LoopOnce,t&&this.mixer.addEventListener("finished",(()=>{t.respawn()}))}animate(){this.action.reset(),this.action.play()}update(t){this.mixer.update(t)}}class f extends THREE.Group{constructor(t,e,i=.7){super(),this.name="Gate",this.userData.bounds={width:t,height:e,depth:.2};const s=new THREE.Shape;s.moveTo(0,e-i),s.lineTo(0,0),s.lineTo(t,0),s.lineTo(t,e-i),s.ellipse(-t,0,t,i,0,Math.PI/2,!1);const o=new THREE.ExtrudeGeometry(s,{steps:1,depth:.2,bevelEnabled:!1});o.translate(-t,0,0);const n=new THREE.MeshStandardMaterial({color:7427626}),r=new THREE.Mesh(o,n);r.position.z=-.1,this.rightgate=new THREE.Group,this.rightgate.position.x=t;const a=new THREE.BoxGeometry(t+.1,.2,.3),h=new THREE.MeshStandardMaterial({color:0}),l=new THREE.Mesh(a,h);l.position.set(-t/2+.05,.4,0),this.rightgate.add(l);const c=l.clone();c.position.y=e-i-.2,this.rightgate.add(c),this.rightgate.add(r),this.leftgate=this.rightgate.clone(),this.leftgate.position.x=-t,this.leftgate.rotateY(Math.PI),this.rightgate.name="rightgate",this.leftgate.name="leftgate",this.add(this.rightgate),this.add(this.leftgate);const d={duration:.4,times:[0,.4],rot1:[0,-Math.PI/2],rot2:[0,-Math.PI/2]},p=new THREE.NumberKeyframeTrack("rightgate.rotation[y]",d.times,d.rot1),E=new THREE.NumberKeyframeTrack("leftgate.rotation[y]",d.times,d.rot2),m=new THREE.AnimationClip("opengate",d.duration,[p,E]);this.mixer=new THREE.AnimationMixer(this),this.openaction=this.mixer.clipAction(m),this.openaction.clampWhenFinished=!0,this.openaction.loop=THREE.LoopOnce,this.strength=20}reset(){this.openaction.reset(),this.openaction.stop(),this.strength=20,this.body&&(this.body.active=!0)}hit(){return this.strength--,0==this.strength&&(this.openGate(),!0)}openGate(){this.openaction.reset(),this.openaction.play()}update(t){this.mixer.update(t)}}class g{constructor(t,e,i=!1){if(this.root=new THREE.Group,this.model=this.createModel(e,i),this.root.add(this.model),!i){const t=new THREE.PointLight(16777215,2,8);t.position.set(0,3,1),this.root.add(t)}t.add(this.root),this.startPosition=new THREE.Vector3,this.time=0,this.life=1,this.rotateOnMove=!0}createModel(t,e){const i=new THREE.CylinderGeometry(.4,.6,.5,32,1,!0),s=new THREE.SphereGeometry(.4,24,10),o=[new THREE.Vector2(.5,e?-.32:0),new THREE.Vector2(.5,.2),new THREE.Vector2(.45,.2),new THREE.Vector2(.4,.3),new THREE.Vector2(.3,.4),new THREE.Vector2(0,.5)],n=new THREE.LatheGeometry(o,12),r=[new THREE.Vector2(.45,0),new THREE.Vector2(.43,.1),new THREE.Vector2(.4,.2),new THREE.Vector2(.32,.3),new THREE.Vector2(.16,.4),new THREE.Vector2(.05,.5)],a=new THREE.LatheGeometry(r,12),h=new THREE.CylinderGeometry(.45,.45,.2,32,1,!1),l=new THREE.MeshPhongMaterial({color:t[0]}),c=new THREE.MeshPhongMaterial({color:t[1]}),d=new THREE.MeshPhongMaterial({color:t[2],specular:10395294}),p=new THREE.MeshPhongMaterial({color:t[3]}),E=new THREE.MeshPhongMaterial({color:t[4]}),m=new THREE.Group,y=new THREE.Mesh(i,l);y.matrix.fromArray([1,0,0,0,0,1,0,0,0,0,1,0,0,.25,0,1]),m.add(y);const u=new THREE.Mesh(s,c);u.matrix.fromArray([1,0,0,0,0,1,0,0,0,0,1,0,0,1.3466628932086855,0,1]),m.add(u);const w=new THREE.Mesh(n,d);w.matrix.fromArray([1,0,0,0,0,1,0,0,0,0,1,0,0,1.4010108612494776,0,1]),m.add(w);const T=new THREE.Mesh(a,p);T.matrix.fromArray([1,0,0,0,0,1,0,0,0,0,1,0,0,.6106004423389476,0,1]),m.add(T);const f=new THREE.Mesh(h,E);f.matrix.fromArray([1.2,0,0,0,0,1,0,0,0,0,1,0,-.04,.5495005511829094,0,1]),m.add(f);const g=new THREE.Group;g.matrix.fromArray([-.35720565585769637,.3938782714057841,-.8469144152378472,0,.42366237124806155,.8764189006544746,.22891069386132204,0,.8324147491555773,-.27703757487025793,-.479933190661225,0,-.35543787836579954,.7856016096417388,.15829722622603848,1]),m.add(g),this.sword=this.createSword(t),g.add(this.sword),m.traverse((t=>{t.matrixAutoUpdate&&t.matrix.decompose(t.position,t.quaternion,t.scale)})),this.animactions={};const x=this.createAnim("drawsword",{duration:.4,times:[0,.1,.3],pos:[{x:0,y:0,z:0},{x:-.261,y:.522,z:.201},{x:-.293,y:.722,z:.861}],rot:[{x:0,y:0,z:0},{x:21.69,y:13.79,z:-9.18},{x:-2.23,y:4.21,z:175.94}]}),R=this.createAnim("usesword",{duration:.45,times:[0,.05,.1,.25,.3,.45],pos:[{x:-.293,y:.722,z:.861},{x:-.928,y:.556,z:-.094},{x:-.529,y:.07,z:-.026},{x:-.848,y:.733,z:-.15},{x:-1.038,y:.755,z:.72},{x:-.293,y:.722,z:.861}],rot:[{x:-2.23,y:4.21,z:175.94},{x:-111.33,y:18.07,z:-107.23},{x:29.51,y:-2.52,z:-41.79},{x:-86.1,y:6.01,z:-115.58},{x:-65.92,y:13.74,z:-39},{x:-2.23,y:4.21,z:175.94}]});return this.mixer=new THREE.AnimationMixer(this.sword),this.animactions.drawaction=this.mixer.clipAction(x),this.animactions.drawaction.clampWhenFinished=!0,this.animactions.drawaction.loop=THREE.LoopOnce,this.animactions.useaction=this.mixer.clipAction(R),m}createAnim(t,e){const i=[],s=[],o=new THREE.Vector3,n=new THREE.Quaternion,r=new THREE.Euler,a=Math.PI/180;for(let t=0;t<e.times.length;t++){const h=e.pos[t],l=e.rot[t];o.set(h.x,h.y,h.z).toArray(i,i.length),r.set(l.x*a,l.y*a,l.z*a),n.setFromEuler(r).toArray(s,s.length)}const h=new THREE.VectorKeyframeTrack(".position",e.times,i),l=new THREE.QuaternionKeyframeTrack(".quaternion",e.times,s);return new THREE.AnimationClip(t,e.duration,[h,l])}createSword(t){const e=new THREE.BoxGeometry(.22,.5,.05,2,1,1),i=e.getAttribute("position"),s=new THREE.Vector3;let o;for(let t=0;t<i.array.length;t+=3)s.set(i.array[t],i.array[t+1],i.array[t+2]),0==s.x&&s.y<0&&(i.array[t+1]-=.06,o=i.array[t+1]);i.needsUpdate=!0;const n=new THREE.CylinderGeometry(.08,.09,.28,8,1,!0),r=new THREE.CapsuleGeometry(.1,.3,4,20),a=new THREE.BoxGeometry(.28,.04,.18),h=new THREE.CapsuleGeometry(.1,.3,4,12),l=new THREE.MeshPhongMaterial({color:t[5],emissive:6381921,specular:10395294}),c=new THREE.MeshPhongMaterial({color:t[6]}),d=new THREE.MeshPhongMaterial({color:t[7],emissive:6381921,specular:13468420}),p=new THREE.Group,E=new THREE.Mesh(e,l);E.matrix.fromArray([1,0,0,0,0,1,0,0,0,0,1,0,0,-.3517202033838308,0,1]),p.add(E);const m=new THREE.Object3D;m.name="bladeEnd",m.position.y=o/2,E.add(m),this.bladeEnd=m;const y=new THREE.Mesh(n,c);y.matrix.fromArray([1,0,0,0,0,1,0,0,0,0,1,0,0,.07401843451376103,0,1]),p.add(y);const u=new THREE.Mesh(r,d);u.matrix.fromArray([1,0,0,0,0,.22,0,0,0,0,1,0,0,.14,0,1]),y.add(u);const w=new THREE.Mesh(a,d);w.matrix.fromArray([1,0,0,0,0,1,0,0,0,0,1,0,0,-.0795935848745708,0,1]),p.add(w);const T=new THREE.Mesh(h,d);T.matrix.fromArray([1.14,0,0,0,0,.12,0,0,0,0,1,0,-.12,0,0,1]),w.add(T);const f=T.clone();return f.matrix.fromArray([1.14,0,0,0,0,.12,0,0,0,0,1,0,.2,0,0,1]),w.add(f),p}setDirection(t){if(!t||t.length()<.1||this.rotateStrength&&this.rotateStrength>.1)return;const e=t.clone().multiplyScalar(10);e.y=0;const i=this.root.position.clone().add(e),s=this.model.quaternion.clone();this.model.lookAt(i),this.model.quaternion.slerp(s,.9)}playAnim(t){this.stopAnims(),this.attacking=!0,"drawaction"==t?this.mixer.addEventListener("finished",this.playAnim.bind(this,"useaction")):this.mixer.removeEventListener("finished"),this.animactions[t].play()}stopAnims(){this.attacking=!1;for(const[t,e]of Object.entries(this.animactions))e.stop(),e.reset()}update(t,e){if(this.mixer&&this.mixer.update(t),e&&this.rotateOnMove&&this.setDirection(e),this.body&&(this.time+=t,this.body.velocity.length()>.5)){const t=1-.06*(Math.sin(10*this.time)+1);this.model.scale.y=t}}}class x extends THREE.Mesh{constructor(t,e,i=128){const s=function(t,e){const i=document.createElement("canvas");return i.width=t,i.height=e,i}(i,i),o=new THREE.CanvasTexture(s),n=new THREE.MeshBasicMaterial({map:o,transparent:!0});super(new THREE.PlaneGeometry(.7,.7),n),this.context=s.getContext("2d"),this.context.save(),this.width=i,this.height=i,this.texture=o,this.position.copy(e),this.showLife(1),t.add(this)}showLife(t=.5){t>1&&(t=1),t<0&&(t=0),this.context.clearRect(0,0,this.width,this.height),this.context.fillStyle="red",this.context.beginPath(),this.context.arc(this.width/2,this.height/2,this.width/2,0,2*Math.PI),this.context.fill(),this.context.fillStyle="green",this.context.beginPath(),this.context.moveTo(this.width/2,this.height/2),this.context.lineTo(this.width,this.height/2),this.context.arc(this.width/2,this.height/2,this.width/2,0,2*Math.PI*t),this.context.fill(),this.texture.needsUpdate=!0}}class R extends THREE.Group{static radius=.8;static height=1.8;static scale=.2;static rows=5;static count=8;constructor(){super();const t=new w;this.obj=new THREE.Object3D;const e=t.geometry.clone().scale(R.scale,R.scale,R.scale);this.meshes=new THREE.InstancedMesh(e,t.material,R.count*R.rows),this.add(this.meshes),this.time=0,this.update(0),this.visible=!1}update(t){this.time+=t;const e=2*Math.PI,i=e/R.count;let s=0;for(let t=0;t<R.rows;t++){const o=t%2?1:-1,n=R.height/R.rows*t;for(let t=0;t<R.count;t++){const r=this.time*o%e,a=(this.time,Math.sin(r+t*i)*R.radius),h=Math.cos(r+t*i)*R.radius;this.obj.position.set(h,n,a),this.obj.rotation.set(0,r,0),this.obj.updateMatrix(),this.meshes.setMatrixAt(s++,this.obj.matrix)}}this.meshes.instanceMatrix.needsUpdate=!0}}class H extends g{constructor(t,e){super(t,[15991041,16373422,13092807,16777215,12615993,16777215,6458346,16774938]),this.tmpVec=new THREE.Vector3,this.lifeUI=new x(this.root,new THREE.Vector3(0,2.6,0),64),this.lifeUI.visible=!1,this.world=e,this.forceField=new R,this.root.add(this.forceField),this.invincibleDuration=0,this.rotateStrength=0}rotate(t){this.model.rotateY(.1*t),this.rotateOnMove=!1}reset(){this.root.position.copy(this.startPosition),this.body.position.copy(this.startPosition),this.body.velocity.set(0,0,0),this.life=1,this.forceField.visible=!1,this.sword.scale.y=1,this.sword.visible=!0}hit(t=.05){this.forceField.visible||(this.lifeDisplayTime=0,this.life-=t,this.lifeUI.showLife(this.life),this.lifeUI.visible=!0,this.app&&this.life<=0&&this.app.gameOver({state:M.STATES.DEAD}))}makeInvincible(t){this.invincibleTime=0,this.invincibleDuration+=t,this.forceField.visible=!0}set underAttack(t){this.skipAttack||(this.rotateOnMove=!t)}update(t,e,i){if(super.update(t,e),this.forceField.visible&&(this.invincibleTime+=t,this.invincibleTime>this.invincibleDuration&&(this.invincibleDuration=0,this.forceField.visible=!1)),Math.abs(this.rotateStrength)>.1?(this.rotate(this.rotateStrength),this.rotateStrength*=.8):this.rotateStrength=0,this.lifeUI.visible&&(this.lifeDisplayTime+=t,this.lifeDisplayTime>1&&(this.lifeUI.visible=!1),i.getWorldPosition(this.tmpVec),this.lifeUI.lookAt(this.tmpVec)),this.forceField.visible&&this.forceField.update(t),this.attacking&&this.world){this.bladeEnd.getWorldPosition(this.tmpVec);const t=this.world.getPointCollisions(this.tmpVec,this.body,.8);if(t.length>0){const e=t[0],i=e.mesh,s=t.filter((t=>"Enemy"==t.mesh.name));if(s.length>0)s.forEach((t=>t.mesh.userData.enemy.hit(.5)));else if("Gate"===i.name)i.hit()&&(e.active=!1)}}}}class b extends g{static STATES={IDLE:0,PATROL:1,HONE:2,ATTACK:3,DEAD:4};constructor(t,e,i){super(t,[657930,13151629,3881029,4341069,0,10066329,5264478,7368254],!0),this.coffin=new T(this),this.coffin.visible=!1,this.root.add(this.coffin),this.tmpVec=new THREE.Vector3,this.prevPos=new THREE.Vector3;const s=new THREE.Vector3(0,0,e);this.center=s,this.curZ=e,this.pathV=new THREE.Vector3,this.initPath(),this.world=i}initPath(){this.path=[new THREE.Vector3(-6,0,-6),new THREE.Vector3(-6,0,6),new THREE.Vector3(6,0,6),new THREE.Vector3(6,0,-6)],this.path.forEach((t=>{t.add(this.center)}))}hit(t=.1){this.state!=b.STATES.DEAD&&(this.life-=t,this.life<=0&&this.kill())}respawn(){this.path.forEach((t=>{t.z-=40})),this.model.visible=!0,this.coffin.visible=!1,this.life=1,this.curZ-=40,this.body.position.set(0,0,this.curZ),this.body.mesh.position.copy(this.body.position),this.startPatrol()}kill(){this.model.visible=!1,this.coffin.visible=!0,this.coffin.animate(),this.state=b.STATES.DEAD,this.stopAnims()}reset(){this.model.visible=!0,this.coffin.visible=!1,this.body&&this.startPosition&&(this.body.position.copy(this.startPosition),this.body.velocity.set(0,0,0),this.root.position.copy(this.startPosition)),this.curZ=this.center.z,this.life=1,this.initPath(),this.startPatrol()}startPatrol(){this.stopAnims(),this.pathIndex=0,this.state=b.STATES.PATROL,this.root.getWorldPosition(this.tmpVec),this.tmpVec.sub(this.path[this.pathIndex]).normalize().multiplyScalar(3).negate(),this.body.velocity.copy(this.tmpVec),this.pathV.copy(this.tmpVec),this.prevPos.copy(this.root.getWorldPosition(this.tmpVec))}updatePatrol(){const t=this.path[this.pathIndex].clone(),e=this.prevPos.distanceTo(t);this.root.getWorldPosition(this.tmpVec);const i=this.tmpVec.distanceTo(t);this.prevPos.copy(this.tmpVec),i>e?(this.pathIndex++,this.pathIndex>=this.path.length&&(this.pathIndex=0),t.copy(this.path[this.pathIndex]),this.tmpVec.sub(t).normalize().multiplyScalar(3).negate(),this.body.velocity.copy(this.tmpVec),this.pathV.copy(this.tmpVec)):this.body.velocity.copy(this.pathV)}startAttack(t){this.state=b.STATES.ATTACK,this.playAnim("drawaction"),t&&(t.knight.underAttack=!0)}startHone(t){if(this.state!=b.STATES.HONE){if(t){t.tmpVec.copy(t.player.position).sub(this.body.position).normalize(),t.raycaster.set(this.body.position,t.tmpVec);const e=t.raycaster.intersectObjects(t.scene.children);if(e.length>0){const i=e[0].object;let s=!1;if(t.knight.model.traverse((t=>{t==i&&(s=!0)})),!s)return}}this.stopAnims(),this.state=b.STATES.HONE}}updateAttack(){if(this.attacking&&this.world){this.bladeEnd.getWorldPosition(this.tmpVec);const t=this.world.getPointCollisions(this.tmpVec,this.body,.6);if(t.length>0){const e=t.filter((t=>"Player"==t.mesh.name));e.length>0&&e[0].mesh.userData.player.hit()}}}update(t,e){switch(super.update(t,e),this.state){case b.STATES.IDLE:break;case b.STATES.PATROL:this.updatePatrol();break;case b.STATES.ATTACK:this.updateAttack();break;case b.STATES.DEAD:this.coffin.update(t)}}}const v=t.p+"2cb652a640d2ae736300.mp3";class M{static STATES={IDLE:0,PLAYING:1,PAUSED:2,DEAD:3,COMPLETE:4};constructor(){const t=document.createElement("div");document.body.appendChild(t),this.clock=new THREE.Clock,this.camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,.1,200),this.camera.position.set(5.3,10.5,20),this.camera.quaternion.set(-.231,.126,.03,.964),this.scene=new THREE.Scene,this.scene.background=new THREE.Color(328965),this.scene.add(new THREE.HemisphereLight(16777215,4210752,1.5)),this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight);const e=new THREE.DirectionalLight(16777215,2);e.position.set(1,3,3),this.scene.add(e),t.appendChild(this.renderer.domElement),this.initScene(),this.initPhysics(),this.tmpVec=new THREE.Vector3,this.tmpEuler=new THREE.Euler,this.tmpMat4=new THREE.Matrix4,this.raycaster=new THREE.Raycaster,this.force=new THREE.Vector3,this.speed=3,this.sfxInit=!0,this.useHeadsetOrientation=!1,this.setupVR(),window.addEventListener("resize",this.resize.bind(this)),this.renderer.setAnimationLoop(this.render.bind(this))}startGame(){this.state=M.STATES.PLAYING,this.gameTime=0,this.startTime=this.clock.elapsedTime;document.getElementById("openingPanel").style.display="none",this.sfx.ball.play()}gameOver(t){if(t){const e=document.getElementById("gameoverPanel"),i=document.getElementById("details");switch(t.state){case M.STATES.DEAD:i.innerHTML=`<P>You ran out of life ${this.player.position.distanceTo(this.grail.position).toFixed(0)} metres away from the Holy Grail</p>`;break;case M.STATES.COMPLETE:const t=this.clock.elapsedTime-this.startTime;i.innerHTML=`<p>Congratulations</p><p>You found the grail in ${t.toFixed(2)} seconds</p><p>Can you do better</p>`}e.style.display="block"}this.vrButton.endSession()}random(t,e){return Math.random()*(e-t)+t}initScene(){this.scene.background=new THREE.Color(657930),this.scene.fog=new THREE.Fog(657930,50,100);const t=new THREE.Mesh(new THREE.PlaneGeometry(100,1e3),new THREE.MeshPhongMaterial({color:10061926,depthWrite:!0}));t.rotation.x=-Math.PI/2,this.scene.add(t),t.position.z=-400,this.ground=t;const e=new THREE.AudioListener;this.camera.add(e),this.sfx={},this.sfx.ball=this.loadSound(v,e,.1);let i=40;const s=new THREE.Vector3,o=new p,n=new d;for(;i>-2e3;){const t=Math.random()>.5?12:-12;let e=4*Math.random();e=t<0?t-e:t+e,i-=10*Math.random();const r=Math.random()*Math.PI*2,a=n.clone();a.position.set(e,0,i),a.rotateY(r),a.scale.set(this.random(.5,2),this.random(.5,2),this.random(.5,2)),this.scene.add(a);for(let t=0;t<6;t++){const t=o.clone();s.set(this.random(0,6),0,this.random(-3,3)),a.position.x<0&&(s.x=-s.x),t.position.copy(a.position).add(s),t.rotation.set(this.random(0,2*Math.PI),this.random(0,2*Math.PI),this.random(0,2*Math.PI)),t.scale.set(this.random(.5,2),this.random(.5,2),this.random(.5,2)),this.scene.add(t)}}const r=new m,a=r.clone();r.rotateY(Math.PI/2),r.rotateX(-Math.PI/4),r.position.set(-27,5,-200),this.scene.add(r),a.rotateY(-Math.PI/2),a.rotateX(-Math.PI/4),a.position.set(27,5,-200),this.scene.add(a)}loadSound(t,e,i=.5,s=!1){const o=new THREE.Audio(e);return(new THREE.AudioLoader).load(t,(t=>{o.setBuffer(t),o.setLoop(s),o.setVolume(i)})),o}createPlayer(){const t=new H(this.scene,this.world);t.root.position.set(0,.5,10);const e=new a(t.root,new o(.8),1);return e.mesh.userData.player=t,e.mesh.name="Player",t.app=this,this.knight=t,this.knight.body=e,this.world.addBody(e),t.startPosition.copy(t.root.position),t.game=this,this.follower=new THREE.Object3D,this.follower.position.set(0,5,8),e.mesh.add(this.follower),e}createEnemy(t,e){const i=new b(this.scene,e,this.world);i.root.position.copy(t);const s=new a(i.root,new o(.8),1);return s.mesh.userData.enemy=i,s.mesh.name="Enemy",i.body=s,i.startPosition.copy(t),i.orgZ=e,this.enemies.push(i),this.world.addBody(s),i.startPatrol(),i}createWall(t,e,i){const s=this,o=new THREE.Vector3(0,0,e);switch(t){case 1:!function(){r([-10,-6.75,-2.5,2.5,6.75,10],["tower2","wall3","tower3","tower3","wall3","tower2"]);const t=new f(1.5,5);o.set(0,0,e),t.body=h(o,t),s.gates.push(t)}();break;case 2:!function(){r([-10,-7.75,-5,-.5,2,5,7.5,10],["tower2","wall1","tower3","tower3","wall2","tower1","wall2","tower2"]);const t=new f(1.375,4.5);o.set(-2.75,0,e),t.body=h(o,t),s.scene.add(t),s.gates.push(t)}();break;case 3:!function(){r([-10,-7.5,-5,-2,.5,5,7.75,10],["tower2","wall2","tower1","wall2","tower3","tower3","wall1","tower2"]);const t=new f(1.375,4.5);o.set(2.75,0,e),t.body=h(o,t),s.gates.push(t)}()}function r(t,s){const o=new THREE.Vector3(0,0,e);for(let e=0;e<t.length;e++){o.x=t[e];h(o,i[s[e]].root.clone())}o.set(-10,0,e-10);let n=i.wall4.root.clone();h(o,n),o.x=10,h(o,n.clone())}function h(t,e){if(!e)return;e.position.copy(t),s.scene.add(e);const i=new THREE.Vector3(e.userData.bounds.width,e.userData.bounds.height,e.userData.bounds.depth).multiplyScalar(.5),o=i.clone().multiplyScalar(-1),r=new a(e,new n(o,i));return s.world.addBody(r),r}o.set(this.random(-7,7),0,e-this.random(3,13)),this.collectables.push(new u(o)),o.set(this.random(-7,7),0,e-this.random(3,13)),this.collectables.push(new w(o))}initPhysics(){this.world=new r;const t=new THREE.Vector3,e={tower1:new y(2,4,2),tower2:new y(2,5,2),tower3:new y(2,6,2),wall1:new y(3,3,.2),wall2:new y(4,3,.2),wall3:new y(7,3,.2),wall4:new y(.2,3,20)};this.enemies=[],this.collectables=[],this.gates=[];for(let i=0;i>=-1e3;i-=20)if(0==i?this.createWall(1,i,e):this.createWall(Math.floor(3*Math.random())+1,i,e),Math.random()>.3&&this.createEnemy(t.set(this.random(-8,8),.5,i-10+this.random(-5,5)),i-10),-400==i){this.grail=new E(this.scene),this.grail.position.set(0,0,i-10),this.scene.add(this.grail);const t=new THREE.Vector3(1.5,3,1.5).multiplyScalar(.5),e=t.clone().multiplyScalar(-1),s=new a(this.grail,new n(e,t));this.world.addBody(s)}this.collectables.forEach((t=>{this.scene.add(t)})),this.player=this.createPlayer(),this.player.sfx=this.sfx.ball,this.player.onCollision=t=>{const e=this.player.position.clone();e.y+=.7,this.effect.reset(e),this.knight.hit(.05),"Gate"==t&&(this.knight.rotateOnMove=!1,this.knight.skipAttack=!0,setTimeout((()=>{this.knight.rotateOnMove=!0,this.knight.skipAttack=!1}),1e3)),this.knight.life<=0&&this.gameOver({state:M.STATES.DEAD})},this.fixedStep=1/60,this.effect=new c(this.scene,!1)}resize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}playAnim(t,e=!1){this.knight&&(e?this.knight.stopAnims():this.knight.playAnim(t))}resetGame(){this.dolly.position.z=10,this.camera.position.set(5.3,10.5,20),this.camera.quaternion.set(-.231,.126,.03,.964),this.camera.fov=50,this.knight.reset(),this.force.set(0,0,0),this.resize(),this.enemies.forEach((t=>t.reset())),this.collectables.forEach((t=>t.visible=!0)),this.grail.reset(),this.gates.forEach((t=>t.reset()))}setupVR(){this.renderer.xr.enabled=!0;const t=new l(this.renderer);function e(){s.knight.playAnim("drawaction")}function i(){s.knight.stopAnims()}this.vrButton=t,t.onClick=()=>{this.sfx.ball.play()};const s=this;this.renderer.xr.addEventListener("sessionend",(function(t){s.resetGame()})),this.renderer.xr.addEventListener("sessionstart",(function(t){s.startGame()})),this.dolly=new THREE.Group,this.root=new THREE.Group,this.root.position.y=-3.4,this.dolly.add(this.root),this.controllers=[];for(let t=0;t<=1;t++){const o=this.renderer.xr.getController(t);o.addEventListener("selectstart",e),o.addEventListener("selectend",i),o.addEventListener("connected",(e=>{const i=this.buildController(e.data,t);i.scale.z=0,o.add(i),o.gamepad=e.data.gamepad,o.handedness=e.data.handedness})),o.addEventListener("disconnected",(function(){const t=this.children[0];t&&t.children&&t.children.length>0&&(t.children[0].isMesh&&t.children[0].geometry.dispose(),this.remove(t)),s.dolly.remove(this)})),this.root.add(o),this.controllers.push({controller:o})}this.dolly.position.set(0,8,10),this.dolly.add(this.camera),this.scene.add(this.dolly),this.dummyCam=new THREE.Object3D,this.camera.add(this.dummyCam)}buildController(t){let e,i;switch(t.targetRayMode){case"tracked-pointer":return e=new THREE.BufferGeometry,e.setAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,-1],3)),e.setAttribute("color",new THREE.Float32BufferAttribute([.5,.5,.5,0,0,0],3)),i=new THREE.LineBasicMaterial({vertexColors:!0,blending:THREE.AdditiveBlending}),new THREE.Line(e,i);case"gaze":return e=new THREE.RingBufferGeometry(.02,.04,32).translate(0,0,-1),i=new THREE.MeshBasicMaterial({opacity:.5,transparent:!0}),new THREE.Mesh(e,i)}}handleController(t,e){"right"==t.handedness?this.force.set(t.gamepad.axes[2],0,t.gamepad.axes[3]):"left"==t.handedness&&(this.knight.rotateStrength=-t.gamepad.axes[2])}render(t,e){const i=this.clock.getDelta();if(this.world&&(this.player.velocity.add(this.force.clone().multiplyScalar(i*this.speed)),this.world.step(this.fixedStep)),this.renderer.xr.isPresenting?(this.gameTime+=i,null==this.debugControls&&(this.useHeadsetOrientation?(this.tmpMat4.extractRotation(this.dummyCam.matrixWorld),this.tmpEuler.setFromRotationMatrix(this.tmpMat4),this.force.set(-this.tmpEuler.z,0,this.tmpEuler.x)):this.controllers.forEach((t=>this.handleController(t.controller)))),this.follower.getWorldPosition(this.tmpVec),this.dolly.position.lerp(this.tmpVec,.1),this.enemies&&(this.knight.underAttack=!1,this.enemies.forEach((t=>{if(t.state==b.STATES.DEAD)return void t.update(i);t.state==b.STATES.HONE&&t.body.velocity.copy(t.root.position).sub(this.knight.root.position).normalize().multiplyScalar(.7*this.speed).negate(),t.update(i,t.body.velocity);const e=t.root.position.distanceTo(this.knight.root.position);e<2?t.state!=b.STATES.ATTACK?t.startAttack(this):(this.tmpVec.copy(this.player.position).sub(t.body.position),t.setDirection(this.tmpVec),this.knight.underAttack=!0):e<10?t.startHone(this):t.state!=b.STATES.PATROL&&t.startPatrol()})))):this.enemies&&this.enemies.forEach((t=>{t.update(i,t.body.velocity)})),this.knight&&this.knight.update(i,this.player.velocity,this.dummyCam),this.effect&&this.effect.visible&&this.effect.update(t,i),this.collectables&&(this.tmpVec.copy(this.player.position),this.tmpVec.y-=.8,this.collectables.forEach((t=>{if(!t.visible)return;t.rotateY(.01);t.position.distanceTo(this.tmpVec)<.5&&(t instanceof w?this.knight.makeInvincible(10):t instanceof u&&this.knight.hit(-1),t.visible=!1)}))),this.gates&&this.gates.forEach((t=>t.update(i))),this.grail){this.player.position.distanceTo(this.grail.position)<2&&this.grail.find(this),this.grail.update(t,i)}this.renderer.render(this.scene,this.camera)}}window.app=new M})();</script></body></html>