<!doctype html><meta content="width=device-width" name=viewport><title>Sir Coadalot and the Holy Grail - js13kGames 2023</title><style>body{margin:0;padding:0}.tmp{color:#a390cf}.panel{position:absolute;width:70%;left:50%;top:50%;transform:translateX(-50%) translateY(-60%);z-index:1000;border-style:solid;border-color:#175230;border-width:20px;background-color:#d4d4b4;padding:40px 40px;color:#494b38;font-family:'Gill Sans','Gill Sans MT',Calibri,'Trebuchet MS',sans-serif;font-size:large;display:none}</style><div id=openingPanel class=panel style=display:block><h1>Sir Coadalot and the Holy Grail</h1><p>It is the year 1213 and <strong>Sir Coadalot</strong> is 13 years into his quest to find the Holy Grail. He has reached the final hurdle, the <strong>Castle of Doom</strong>. To reach his goal he must navigate the castle with your help.<h3>Instructions</h3><p>To move use the right thumbstick<p>To turn when attacking use the left thumbstick<p>To use your sword press and hold the trigger button<p>To start press the vr button below</div><div id=gameoverPanel class=panel style=display:none><h1>Gameover</h1><p id=details></div><script type=module>import*as m from"/2023/webxr/three.js";var s={d:(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),p:""};s.d({},{g:()=>S});const n=[new m.Vector3(1,0,0),new m.Vector3(-1,0,0),new m.Vector3(0,1,0),new m.Vector3(0,-1,0),new m.Vector3(0,0,1),new m.Vector3(0,0,-1)];class o{constructor(t=.5){this.type=1,this.radius=t}}class h{constructor(t,e){this.type=3,this.min=t,this.max=e}testSphereCollision(e,i,s,t){return null!=e&&null!=i&&null!=s&&null!=t&&function(){let t=0;return s.x<e.x&&(t+=(e.x-s.x)*(e.x-s.x)),s.x>i.x&&(t+=(s.x-i.x)*(s.x-i.x)),s.y<e.y&&(t+=(e.y-s.y)*(e.y-s.y)),i.y<s.y&&(t+=(s.y-i.y)*(s.y-i.y)),s.z<e.z&&(t+=(e.z-s.z)*(e.z-s.z)),i.z<s.z&&(t+=(s.z-i.z)*(s.z-i.z)),t}()<=t*t}closestPoint(t,e,i=0,s=!0){return t=t.clone().sub(e).clamp(this.min,this.max),s&&t.add(e),t}whichDirection(e){let i=0,s=-1;for(let t=0;t<n.length;t++){var o=e.dot(n[t]);o>i&&(i=o,s=t)}return s}}class r{constructor(){this.bodies=[],this.substeps=1,this.gravity=new m.Vector3(0,-9.81,0)}addBody(t){this.bodies.push(t)}removeBody(t){(t=this.bodies.indexOf(t))<0||this.bodies.splice(t,1)}getPointCollisions(i,s,o=.1){const n=[];return this.bodies.forEach(t=>{if(t!=s)switch(t.collider.type){case 1:i.distanceTo(t.position)<t.collider.radius&&n.push(t);break;case 3:const s=t.collider.min.clone().add(t.position),e=t.collider.max.clone().add(t.position);t.collider.testSphereCollision(s,e,i,o)&&n.push(t)}}),n}step(t){const h=t/this.substeps;for(let t=0;t<this.substeps;t++){let a=0;this.bodies.forEach(e=>{if(0!=e.mass&&null!=e.collider&&1==e.collider.type){e.position.clone(),e.position.add(e.velocity.clone().multiplyScalar(h)),e.position.y<e.collider.radius&&(e.position.y=e.collider.radius,e.velocity.y=-e.velocity.y*e.restitution);for(let t=0;t<this.bodies.length;t++){const h=this.bodies[t];if(e!=h&&h.active)switch(h.collider.type){case 1:const a=e.position.clone().sub(h.position),n=a.length();var i;n<2*e.collider.radius&&(a.multiplyScalar(.5*n-e.collider.radius),e.position.sub(a),a.normalize(),i=e.velocity.clone().sub(h.velocity),a.multiplyScalar(a.dot(i,a)),e.velocity.sub(a));break;case 3:var s=h.collider.min.clone().add(h.position),o=h.collider.max.clone().add(h.position);if(e.velocity.length(),h.collider.testSphereCollision(s,o,e.position,e.collider.radius)){const a=h.collider.closestPoint(e.position,h.position),i=e.position.clone().sub(a).normalize(),r=i.clone().multiplyScalar(e.collider.radius+0);switch(e.position=a.clone().add(r),e.onCollision&&e.onCollision(h.mesh.name),h.collider.whichDirection(i.negate())){case 0:e.position.x=s.x-e.collider.radius,e.velocity.x=-e.velocity.x*e.restitution;break;case 1:e.position.x=o.x+e.collider.radius,e.velocity.x=-e.velocity.x*e.restitution;break;case 2:e.position.y=s.y-e.collider.radius,e.velocity.y=-e.velocity.y*e.restitution;break;case 3:e.position.y=o.y+e.collider.radius,e.velocity.y=-e.velocity.y*e.restitution;break;case 4:e.position.z=s.z-e.collider.radius,e.velocity.z=-e.velocity.z*e.restitution;break;case 5:e.position.z=o.z+e.collider.radius,e.velocity.z=-e.velocity.z*e.restitution}}}}}e.velocity.multiplyScalar(e.damping).add(this.gravity.clone().multiplyScalar(h)),e.mesh&&e.mesh.position.copy(e.position),a++})}}}class l{constructor(t=null,e=null,i=0){this.mass=i,this.invMass=0!=i?1/i:0,this.position=t?t.position.clone():new m.Vector3,this.velocity=new m.Vector3,this.damping=.99,this.restitution=.9,this.collider=e,this.active=!0,this.mesh=t,0<i&&e.type,this.onCollision=null}}const a="data:image/svg+xml, %3Csvg fill='%23ffffff' width='100%' height='auto' viewBox='0 40 700 700' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M608 64H32C14.33 64 0 78.33 0 96v320c0 17.67 14.33 32 32 32h160.22c25.19 0 48.03-14.77 58.36-37.74l27.74-61.64C286.21 331.08 302.35 320 320 320s33.79 11.08 41.68 28.62l27.74 61.64C399.75 433.23 422.6 448 447.78 448H608c17.67 0 32-14.33 32-32V96c0-17.67-14.33-32-32-32zM160 304c-35.35 0-64-28.65-64-64s28.65-64 64-64 64 28.65 64 64-28.65 64-64 64zm320 0c-35.35 0-64-28.65-64-64s28.65-64 64-64 64 28.65 64 64-28.65 64-64 64z'/%3E%3C/svg%3E";class i{constructor(e,i){if(this.renderer=e,void 0!==i?(this.onSessionStart=i.onSessionStart,this.onSessionEnd=i.onSessionEnd,this.sessionInit=i.sessionInit,this.sessionMode=void 0!==i.inline&&i.inline?"inline":"immersive-vr"):this.sessionMode="immersive-vr",void 0===this.sessionInit&&(this.sessionInit={optionalFeatures:["local-floor","bounded-floor"]}),"xr"in navigator){const e=document.createElement("button");e.style.display="none",e.style.height="40px",navigator.xr.isSessionSupported(this.sessionMode).then(t=>{t?this.showEnterVR(e):this.showWebXRNotFound(e),i&&i.vrStatus&&i.vrStatus(t)}),document.body.appendChild(e)}else{const e=document.createElement("a");!1===window.isSecureContext?(e.href=document.location.href.replace(/^http:/,"https:"),e.innerHTML="WEBXR NEEDS HTTPS"):(e.href="https://immersiveweb.dev/",e.innerHTML="WEBXR NOT AVAILABLE"),e.style.left="0px",e.style.width="100%",e.style.textDecoration="none",this.stylizeElement(e,!1),e.style.bottom="0px",e.style.opacity="1",document.body.appendChild(e),i.vrStatus&&i.vrStatus(!1)}}showEnterVR(e){let i=null;const s=this;function t(t){t.addEventListener("end",o),s.renderer.xr.setSession(t),s.stylizeElement(e,!1,12,!0),e.textContent="END GAME",i=t,s.session=t,void 0!==s.onSessionStart&&s.onSessionStart()}function o(){i.removeEventListener("end",o),s.stylizeElement(e,!0,12,!0),e.style.display="",e.style.right="50%",e.style.width="100px",e.style.transform="translateX(50%)",e.style.cursor="pointer",e.innerHTML=`<img src = "${a}" alt="VR Cardboard" style="margin-left: 6px"/>`,i=null,s.session=null,void 0!==s.onSessionEnd&&s.onSessionEnd()}this.stylizeElement(e,!0,30,!0),e.style.display="",e.style.right="50%",e.style.width="100px",e.style.height="56px",e.style.bottom="30px",e.style.transform="translateX(50%)",e.style.cursor="pointer",e.innerHTML=`<img src = "${a}" alt="VR Cardboard" style="margin-left: 6px"/>`,e.onmouseenter=function(){e.style.fontSize="12px",e.textContent=null===i?"PLAY GAME":"EXIT GAME",e.style.opacity="1.0"},e.onmouseleave=function(){e.style.fontSize="30px",e.innerHTML=`<img src = "${a}" alt="VR Cardboard" style="margin-left: 6px"/>`,e.style.opacity="0.5"},e.onclick=function(){if(null===i)navigator.xr.requestSession(s.sessionMode,s.sessionInit).then(t);else try{i.end()}catch(t){}s.onClick&&s.onClick()}}endSession(){this.session&&(this.session.end(),this.session=null)}disableButton(t){t.style.cursor="auto",t.style.opacity="0.5",t.onmouseenter=null,t.onmouseleave=null,t.onclick=null}showWebXRNotFound(t){this.stylizeElement(t,!1),this.disableButton(t),t.style.display="",t.style.width="100%",t.style.right="0px",t.style.bottom="0px",t.style.border="",t.style.opacity="1",t.style.fontSize="13px",t.textContent="VR NOT SUPPORTED"}stylizeElement(t,e=!0,i=13,s=!1){t.style.position="absolute",t.style.bottom="20px",s||(t.style.padding="12px 6px"),t.style.border="1px solid #fff",t.style.borderRadius="4px",t.style.background=e?"rgba(20,150,80,1)":"rgba(180,20,20,1)",t.style.color="#fff",t.style.font=`normal ${i}px sans-serif`,t.style.textAlign="center",t.style.opacity="0.5",t.style.outline="none",t.style.zIndex="999"}}class c extends m.InstancedMesh{static STAR=0;constructor(t,e=!1,i={shape:c.STAR}){let s;i.shape===c.STAR&&(s=function(){let e=!0,i=!0,s=new m.Shape;for(let t=0;t<10;t++){var o=2*Math.PI/10*t,n=e?1:.4,r=Math.cos(o)*n,o=Math.sin(o)*n;i?(s.moveTo(r,o),i=!1):s.lineTo(r,o),e=!e}return new m.ExtrudeGeometry(s,{steps:1,depth:.1,bevelEnabled:!1})}()).scale(.2,.2,.2),super(s,new m.MeshBasicMaterial,i.count||50),this.startColor=new m.Color(i.startColor||16777215),this.endColor=new m.Color(i.endColor||11149858),t.add(this),this.visible=e,this.config=i,this.obj=new m.Object3D,this.velocity=[],this.acceleration=[],this.positions=[]}random(t,e){return Math.random()*(e-t)+t}reset(t){let e,i;this.obj.position.set(0,0,0),this.obj.updateMatrix(),this.velocity=[],this.acceleration=[],this.positions=[],this.position.copy(t);var s=2*Math.PI/this.count;for(let t=0;t<this.count;t++)this.config.velocity?(e=this.config.velocity.clone()).y*=this.random(.4,1.1):e=new m.Vector3(.03*this.random(-1,1),.03*this.random(-1,1),.03*this.random(-1,1)),this.config.radius?(i=new m.Vector3(Math.cos(s*t)*this.config.radius,0,Math.sin(s*t)*this.config.radius),e.add(i.clone().multiplyScalar(.02))):i=new m.Vector3,this.velocity.push(e),this.acceleration.push(e.clone().multiplyScalar(5)),this.positions.push(i),this.setMatrixAt(t,this.obj.matrix);this.instanceMatrix.needsUpdate=!0,this.elapsedTime=0,this.visible=!0}update(e,i){if(this.visible){const e=this.elapsedTime<.5?1:1-2*(this.elapsedTime-.5);this.material.color.lerpColors(this.startColor,this.endColor,this.elapsedTime-.2),this.material.needsUpdate=!0;for(let t=0;t<this.count;t++)this.obj.position.copy(this.positions[t].clone().add(this.velocity[t].clone().multiplyScalar(this.elapsedTime)).add(this.acceleration[t].clone().multiplyScalar(this.elapsedTime*this.elapsedTime))),this.velocity[t].multiplyScalar(.99),this.acceleration[t].multiplyScalar(.99),this.acceleration[t].y-=.05*i,this.obj.rotation.z=6*this.elapsedTime,this.obj.scale.set(e,e,e),this.obj.updateMatrix(),this.positions[t].copy(this.obj.position),this.setMatrixAt(t,this.obj.matrix);this.instanceMatrix.needsUpdate=!0,this.elapsedTime+=i,1<this.elapsedTime&&(this.visible=!1)}}}class d extends m.Group{constructor(t=0){super(),0===t&&this.treeA()}treeA(){(s=new m.ConeGeometry(1.3,2.5,10,1,!0)).translate(0,2.5,0);var t=new m.MeshPhongMaterial({color:3562675}),e=new m.Mesh(s,t),i=new m.Mesh(s,t),s=new m.Mesh(s,t);i.position.y=5/3,i.scale.y=t=(5-5/3)/5,i.scale.x=i.scale.z=1.2*t,s.position.y=5/3*2,s.scale.y=t=(5-5/3*2)/5,s.scale.x=s.scale.z=1.2*t,this.add(e),this.add(i),this.add(s)}}class p extends m.Mesh{constructor(t=.5){var e=new m.IcosahedronGeometry(t,8,6),i=(e.translate(0,t,0),e.getAttribute("position"));for(let t=0;t<i.array.length;t++)i.array[t]+=.35*(Math.random()-.5);i.needsUpdate=!0,super(e,new m.MeshPhongMaterial({color:11184810}))}}class y extends m.Group{constructor(t){super();var e=new m.LatheGeometry([{x:.3,y:0},{x:.3,y:.06},{x:.05,y:.06},{x:.05,y:.3},{x:.1,y:.32},{x:.2,y:.4},{x:.3,y:.5},{x:.35,y:.6},{x:.4,y:1},{x:.37,y:1},{x:0,y:.33}]),i=new m.CylinderGeometry(.5,.5,1.4,6),s=new m.CylinderGeometry(1,1,.3,8),o=new m.MeshPhongMaterial({color:15776768,emissive:5988618,specular:14277708,shininess:70}),n=new m.MeshStandardMaterial({color:12496044,flatShading:!0});this.grail=new m.Mesh(e,o),e=new m.Mesh(i,n),o=new m.Mesh(s,n),i=new m.Mesh(s,n),this.grail.position.y=1.5,e.position.y=.72,o.position.y=.15,i.position.y=1.36,i.scale.set(.8,.8,.8),this.add(o),this.add(e),this.add(i),this.add(this.grail),(s=new m.SpotLight(16777215,1,5,Math.PI/6,.5)).position.set(0,3,1),s.lookAt(this.grail.position),this.add(s),n=new m.NumberKeyframeTrack(".position[y]",[0,.5,1.5],[1.5,2,2.2]),o=new m.AnimationClip(null,1.5,[n]),this.mixer=new m.AnimationMixer(this.grail),this.action=this.mixer.clipAction(o),this.action.loop=m.LoopOnce,this.action.clampWhenFinished=!0,this.mixer.addEventListener("finished",()=>{this.grail.visible=!1,this.app&&this.app.gameOver({state:S.STATES.COMPLETE})}),t.add(this),this.effect=new c(t,!1,{shape:c.STAR,count:20,velocity:new m.Vector3(0,.06,0),radius:1}),this.found=!1}find(t){this.found||(this.reset(),this.effect.reset(this.position),this.action.play(),this.app=t,this.found=!0)}reset(){this.grail.visible=!0,this.action.reset()}update(t,e){this.effect.visible&&this.effect.update(t,e),this.mixer.update(e)}}class u extends m.Mesh{constructor(){var t=new m.PlaneGeometry(2e3,20,300,10),e=t.getAttribute("position");for(let t=0;t<e.array.length;t++)e.array[t]+=.95*(Math.random()-.5);e.needsUpdate=!0,super(t,new m.MeshPhongMaterial({color:10066329,flatShading:!0}))}}class t{constructor(e=3,i=1.5,t=3,s=.75){if(this.root=new m.Group,this.root.userData.bounds={width:e,height:i,depth:t},e<.25){const m=e;e=t,t=m}const o=Math.floor(e/s),n=new m.Shape,r=(n.moveTo(e/2,i),n.lineTo(e/2,0),n.lineTo(-e/2,0),n.lineTo(-e/2,i),e/(2*o+1));n.lineTo(r-e/2,i);for(let t=0;t<o;t++){var a=r*(1+2*t)-e/2;n.lineTo(a,i-s/2),n.lineTo(a+r,i-s/2),n.lineTo(a+r,i),n.lineTo(a+2*r,i)}n.lineTo(e/2,i);const h={steps:1,depth:t<.25?.5:.25,bevelEnabled:!1},l=new m.ExtrudeGeometry(n,h);this.root.userData.bounds.width<.25&&l.rotateY(Math.PI/2);var c=t<.25||e<.25,d=new m.MeshStandardMaterial({color:c?14540202:10066346}),p=new m.Mesh(l,d);if(p.position.z=-t/2-.1,this.root.add(p),!c){const o=p.clone(),n=(o.position.z=t/2-.2,p.clone()),r=(n.rotateY(Math.PI/2),n.position.set(-e/2-.1,0,0),n.clone()),a=(r.position.x=e/2-.2,new m.BoxGeometry(1.15*e,.3,1.15*t)),h=new m.Mesh(a,d);h.position.y=i-s-.15,this.root.add(h),this.root.add(o),this.root.add(o),this.root.add(n),this.root.add(r)}}}class w extends m.Mesh{constructor(t){var e=new m.Shape;e.moveTo(25,25),e.bezierCurveTo(25,25,20,0,0,0),e.bezierCurveTo(-30,0,-30,35,-30,35),e.bezierCurveTo(-30,55,-10,77,25,95),e.bezierCurveTo(60,77,80,55,80,35),e.bezierCurveTo(80,35,80,0,50,0),e.bezierCurveTo(35,0,25,25,25,25),(e=new m.ExtrudeGeometry(e,{steps:1,depth:10,bevelEnabled:!1})).scale(.01,.01,.01),e.rotateZ(Math.PI),e.translate(.27,1.5,-.05),super(e,new m.MeshStandardMaterial({color:16134058,emissive:1118549})),t&&this.position.copy(t)}}class f extends m.Mesh{constructor(t){var e=new m.Shape;e.moveTo(0,0),e.lineTo(.4,.3),e.lineTo(.5,1),e.lineTo(.4,1.05),e.lineTo(0,1.1),e.lineTo(-.4,1.05),e.lineTo(-.5,1),e.lineTo(-.4,.3),(e=new m.ExtrudeGeometry(e,{steps:1,depth:.3,bevelEnabled:!1})).translate(0,1,-.15),super(e,new m.MeshStandardMaterial({color:10719439,emissive:5325169})),t&&this.position.copy(t)}}class g extends m.Mesh{constructor(t){(e=new m.Shape).moveTo(.4,0),e.lineTo(.6,1.3),e.lineTo(.4,2),e.lineTo(-.4,2),e.lineTo(-.6,1.3),e.lineTo(-.4,0),(e=new m.ExtrudeGeometry(e,{steps:1,depth:.9,bevelEnabled:!1})).translate(0,0,-.45),super(e,new m.MeshStandardMaterial({color:7427626,transparent:!0}));var e={duration:1,times:[0,1],rot:[0,Math.PI],pos:[0,2],fade:[1,0]},i=new m.NumberKeyframeTrack(".rotation[y]",e.times,e.rot),s=new m.NumberKeyframeTrack(".position[y]",e.times,e.pos),o=new m.NumberKeyframeTrack(".material.opacity",e.times,e.fade),e=new m.AnimationClip("animate",e.duration,[i,s,o]);this.mixer=new m.AnimationMixer(this),this.action=this.mixer.clipAction(e),this.action.clampWhenFinished=!0,this.action.loop=m.LoopOnce,t&&this.mixer.addEventListener("finished",()=>{t.respawn()})}animate(){this.action.reset(),this.action.play()}update(t){this.mixer.update(t)}}class v extends m.Group{constructor(t,e,i=.7){super(),this.name="Gate",this.userData.bounds={width:t,height:e,depth:.2};var s=new m.Shape,o=(s.moveTo(0,e-i),s.lineTo(0,0),s.lineTo(t,0),s.lineTo(t,e-i),s.ellipse(-t,0,t,i,0,Math.PI/2,!1),(s=new m.ExtrudeGeometry(s,{steps:1,depth:.2,bevelEnabled:!1})).translate(-t,0,0),new m.MeshStandardMaterial({color:7427626})),n=((s=new m.Mesh(s,o)).position.z=-.1,this.rightgate=new m.Group,this.rightgate.position.x=t,o=new m.BoxGeometry(t+.1,.2,.3),new m.MeshStandardMaterial({color:0}));(o=new m.Mesh(o,n)).position.set(-t/2+.05,.4,0),this.rightgate.add(o),(n=o.clone()).position.y=e-i-.2,this.rightgate.add(n),this.rightgate.add(s),this.leftgate=this.rightgate.clone(),this.leftgate.position.x=-t,this.leftgate.rotateY(Math.PI),this.rightgate.name="rightgate",this.leftgate.name="leftgate",this.add(this.rightgate),this.add(this.leftgate),o={duration:.4,times:[0,.4],rot1:[0,-Math.PI/2],rot2:[0,-Math.PI/2]},e=new m.NumberKeyframeTrack("rightgate.rotation[y]",o.times,o.rot1),i=new m.NumberKeyframeTrack("leftgate.rotation[y]",o.times,o.rot2),n=new m.AnimationClip("opengate",o.duration,[e,i]),this.mixer=new m.AnimationMixer(this),this.openaction=this.mixer.clipAction(n),this.openaction.clampWhenFinished=!0,this.openaction.loop=m.LoopOnce,this.strength=20}reset(){this.openaction.reset(),this.openaction.stop(),this.strength=20,this.body&&(this.body.active=!0)}hit(){return this.strength--,0==this.strength&&(this.openGate(),!0)}openGate(){this.openaction.reset(),this.openaction.play()}update(t){this.mixer.update(t)}}class e{constructor(t,e,i=!1){if(this.root=new m.Group,this.model=this.createModel(e,i),this.root.add(this.model),!i){const t=new m.PointLight(16777215,2,8);t.position.set(0,3,1),this.root.add(t)}t.add(this.root),this.startPosition=new m.Vector3,this.time=0,this.life=1,this.rotateOnMove=!0}createModel(t,e){var i=new m.CylinderGeometry(.4,.6,.5,32,1,!0),s=new m.SphereGeometry(.4,24,10),o=(e=[new m.Vector2(.5,e?-.32:0),new m.Vector2(.5,.2),new m.Vector2(.45,.2),new m.Vector2(.4,.3),new m.Vector2(.3,.4),new m.Vector2(0,.5)],e=new m.LatheGeometry(e,12),[new m.Vector2(.45,0),new m.Vector2(.43,.1),new m.Vector2(.4,.2),new m.Vector2(.32,.3),new m.Vector2(.16,.4),new m.Vector2(.05,.5)]),n=(o=new m.LatheGeometry(o,12),new m.CylinderGeometry(.45,.45,.2,32,1,!1)),r=new m.MeshPhongMaterial({color:t[0]}),a=new m.MeshPhongMaterial({color:t[1]}),h=new m.MeshPhongMaterial({color:t[2],specular:10395294}),l=new m.MeshPhongMaterial({color:t[3]}),c=new m.MeshPhongMaterial({color:t[4]}),d=new m.Group;return(i=new m.Mesh(i,r)).matrix.fromArray([1,0,0,0,0,1,0,0,0,0,1,0,0,.25,0,1]),d.add(i),(r=new m.Mesh(s,a)).matrix.fromArray([1,0,0,0,0,1,0,0,0,0,1,0,0,1.3466628932086855,0,1]),d.add(r),(i=new m.Mesh(e,h)).matrix.fromArray([1,0,0,0,0,1,0,0,0,0,1,0,0,1.4010108612494776,0,1]),d.add(i),(s=new m.Mesh(o,l)).matrix.fromArray([1,0,0,0,0,1,0,0,0,0,1,0,0,.6106004423389476,0,1]),d.add(s),(a=new m.Mesh(n,c)).matrix.fromArray([1.2,0,0,0,0,1,0,0,0,0,1,0,-.04,.5495005511829094,0,1]),d.add(a),(r=new m.Group).matrix.fromArray([-.35720565585769637,.3938782714057841,-.8469144152378472,0,.42366237124806155,.8764189006544746,.22891069386132204,0,.8324147491555773,-.27703757487025793,-.479933190661225,0,-.35543787836579954,.7856016096417388,.15829722622603848,1]),d.add(r),this.sword=this.createSword(t),r.add(this.sword),d.traverse(t=>{t.matrixAutoUpdate&&t.matrix.decompose(t.position,t.quaternion,t.scale)}),this.animactions={},e=this.createAnim("drawsword",{duration:.4,times:[0,.1,.3],pos:[{x:0,y:0,z:0},{x:-.261,y:.522,z:.201},{x:-.293,y:.722,z:.861}],rot:[{x:0,y:0,z:0},{x:21.69,y:13.79,z:-9.18},{x:-2.23,y:4.21,z:175.94}]}),h=this.createAnim("usesword",{duration:.45,times:[0,.05,.1,.25,.3,.45],pos:[{x:-.293,y:.722,z:.861},{x:-.928,y:.556,z:-.094},{x:-.529,y:.07,z:-.026},{x:-.848,y:.733,z:-.15},{x:-1.038,y:.755,z:.72},{x:-.293,y:.722,z:.861}],rot:[{x:-2.23,y:4.21,z:175.94},{x:-111.33,y:18.07,z:-107.23},{x:29.51,y:-2.52,z:-41.79},{x:-86.1,y:6.01,z:-115.58},{x:-65.92,y:13.74,z:-39},{x:-2.23,y:4.21,z:175.94}]}),this.mixer=new m.AnimationMixer(this.sword),this.animactions.drawaction=this.mixer.clipAction(e),this.animactions.drawaction.clampWhenFinished=!0,this.animactions.drawaction.loop=m.LoopOnce,this.animactions.useaction=this.mixer.clipAction(h),d}createAnim(e,i){var s=[],o=[],n=new m.Vector3,r=new m.Quaternion,a=new m.Euler,h=Math.PI/180;for(let t=0;t<i.times.length;t++){const e=i.pos[t],l=i.rot[t];n.set(e.x,e.y,e.z).toArray(s,s.length),a.set(l.x*h,l.y*h,l.z*h),r.setFromEuler(a).toArray(o,o.length)}const l=new m.VectorKeyframeTrack(".position",i.times,s),t=new m.QuaternionKeyframeTrack(".quaternion",i.times,o);return new m.AnimationClip(e,i.duration,[l,t])}createSword(t){let e,i=(o=new m.BoxGeometry(.22,.5,.05,2,1,1)).getAttribute("position"),s=new m.Vector3;for(let t=0;t<i.array.length;t+=3)s.set(i.array[t],i.array[t+1],i.array[t+2]),0==s.x&&s.y<0&&(i.array[t+1]-=.06,e=i.array[t+1]);i.needsUpdate=!0;var o,n=new m.CylinderGeometry(.08,.09,.28,8,1,!0),r=new m.CapsuleGeometry(.1,.3,4,20),a=new m.BoxGeometry(.28,.04,.18),h=new m.CapsuleGeometry(.1,.3,4,12),l=new m.MeshPhongMaterial({color:t[5],emissive:6381921,specular:10395294}),c=new m.MeshPhongMaterial({color:t[6]}),d=(t=new m.MeshPhongMaterial({color:t[7],emissive:6381921,specular:13468420}),new m.Group);return(o=new m.Mesh(o,l)).matrix.fromArray([1,0,0,0,0,1,0,0,0,0,1,0,0,-.3517202033838308,0,1]),d.add(o),(l=new m.Object3D).name="bladeEnd",l.position.y=e/2,o.add(l),this.bladeEnd=l,(o=new m.Mesh(n,c)).matrix.fromArray([1,0,0,0,0,1,0,0,0,0,1,0,0,.07401843451376103,0,1]),d.add(o),(l=new m.Mesh(r,t)).matrix.fromArray([1,0,0,0,0,.22,0,0,0,0,1,0,0,.14,0,1]),o.add(l),(n=new m.Mesh(a,t)).matrix.fromArray([1,0,0,0,0,1,0,0,0,0,1,0,0,-.0795935848745708,0,1]),d.add(n),(c=new m.Mesh(h,t)).matrix.fromArray([1.14,0,0,0,0,.12,0,0,0,0,1,0,-.12,0,0,1]),n.add(c),(r=c.clone()).matrix.fromArray([1.14,0,0,0,0,.12,0,0,0,0,1,0,.2,0,0,1]),n.add(r),d}setDirection(t){var e;!t||t.length()<.1||this.rotateStrength&&.1<this.rotateStrength||((t=t.clone().multiplyScalar(10)).y=0,t=this.root.position.clone().add(t),e=this.model.quaternion.clone(),this.model.lookAt(t),this.model.quaternion.slerp(e,.9))}playAnim(t){this.stopAnims(),this.attacking=!0,"drawaction"==t?this.mixer.addEventListener("finished",this.playAnim.bind(this,"useaction")):this.mixer.removeEventListener("finished"),this.animactions[t].play()}stopAnims(){for(var[t,e]of(this.attacking=!1,Object.entries(this.animactions)))e.stop(),e.reset()}update(t,e){if(this.mixer&&this.mixer.update(t),e&&this.rotateOnMove&&this.setDirection(e),this.body&&(this.time+=t,.5<this.body.velocity.length())){const t=1-.06*(Math.sin(10*this.time)+1);this.model.scale.y=t}}}class x extends m.Mesh{constructor(t,e,i=128){o=s=i,(n=document.createElement("canvas")).width=s,n.height=o;var s=n,o=new m.CanvasTexture(s),n=new m.MeshBasicMaterial({map:o,transparent:!0});super(new m.PlaneGeometry(.7,.7),n),this.context=s.getContext("2d"),this.context.save(),this.width=i,this.height=i,this.texture=o,this.position.copy(e),this.showLife(1),t.add(this)}showLife(t=.5){(t=1<t?1:t)<0&&(t=0),this.context.clearRect(0,0,this.width,this.height),this.context.fillStyle="red",this.context.beginPath(),this.context.arc(this.width/2,this.height/2,this.width/2,0,2*Math.PI),this.context.fill(),this.context.fillStyle="green",this.context.beginPath(),this.context.moveTo(this.width/2,this.height/2),this.context.lineTo(this.width,this.height/2),this.context.arc(this.width/2,this.height/2,this.width/2,0,2*Math.PI*t),this.context.fill(),this.texture.needsUpdate=!0}}class b extends m.Group{static radius=.8;static height=1.8;static scale=.2;static rows=5;static count=8;constructor(){super();var t=new f,e=(this.obj=new m.Object3D,t.geometry.clone().scale(b.scale,b.scale,b.scale));this.meshes=new m.InstancedMesh(e,t.material,b.count*b.rows),this.add(this.meshes),this.time=0,this.update(0),this.visible=!1}update(t){this.time+=t;let e=2*Math.PI,i=e/b.count,s=0;for(let t=0;t<b.rows;t++){var o=t%2?1:-1,n=b.height/b.rows*t;for(let t=0;t<b.count;t++){var r=this.time*o%e,a=(this.time,Math.sin(r+t*i)*b.radius),h=Math.cos(r+t*i)*b.radius;this.obj.position.set(h,n,a),this.obj.rotation.set(0,r,0),this.obj.updateMatrix(),this.meshes.setMatrixAt(s++,this.obj.matrix)}}this.meshes.instanceMatrix.needsUpdate=!0}}class M extends e{constructor(t,e){super(t,[15991041,16373422,13092807,16777215,12615993,16777215,6458346,16774938]),this.tmpVec=new m.Vector3,this.lifeUI=new x(this.root,new m.Vector3(0,2.6,0),64),this.lifeUI.visible=!1,this.world=e,this.forceField=new b,this.root.add(this.forceField),this.invincibleDuration=0,this.rotateStrength=0}rotate(t){this.model.rotateY(.1*t),this.rotateOnMove=!1}reset(){this.root.position.copy(this.startPosition),this.body.position.copy(this.startPosition),this.body.velocity.set(0,0,0),this.life=1,this.forceField.visible=!1,this.sword.scale.y=1,this.sword.visible=!0}hit(t=.05){this.forceField.visible||(this.lifeDisplayTime=0,this.life-=t,this.lifeUI.showLife(this.life),this.lifeUI.visible=!0,this.app&&this.life<=0&&this.app.gameOver({state:S.STATES.DEAD}))}makeInvincible(t){this.invincibleTime=0,this.invincibleDuration+=t,this.forceField.visible=!0}set underAttack(t){this.skipAttack||(this.rotateOnMove=!t)}update(t,e,i){if(super.update(t,e),this.forceField.visible&&(this.invincibleTime+=t,this.invincibleTime>this.invincibleDuration)&&(this.invincibleDuration=0,this.forceField.visible=!1),.1<Math.abs(this.rotateStrength)?(this.rotate(this.rotateStrength),this.rotateStrength*=.8):this.rotateStrength=0,this.lifeUI.visible&&(this.lifeDisplayTime+=t,1<this.lifeDisplayTime&&(this.lifeUI.visible=!1),i.getWorldPosition(this.tmpVec),this.lifeUI.lookAt(this.tmpVec)),this.forceField.visible&&this.forceField.update(t),this.attacking&&this.world){this.bladeEnd.getWorldPosition(this.tmpVec);const t=this.world.getPointCollisions(this.tmpVec,this.body,.8);if(0<t.length){const e=t[0],i=e.mesh,s=t.filter(t=>"Enemy"==t.mesh.name);0<s.length?s.forEach(t=>t.mesh.userData.enemy.hit(.5)):"Gate"===i.name&&i.hit()&&(e.active=!1)}}}}class T extends e{static STATES={IDLE:0,PATROL:1,HONE:2,ATTACK:3,DEAD:4};constructor(t,e,i){super(t,[657930,13151629,3881029,4341069,0,10066329,5264478,7368254],!0),this.coffin=new g(this),this.coffin.visible=!1,this.root.add(this.coffin),this.tmpVec=new m.Vector3,this.prevPos=new m.Vector3,t=new m.Vector3(0,0,e),this.center=t,this.curZ=e,this.pathV=new m.Vector3,this.initPath(),this.world=i}initPath(){this.path=[new m.Vector3(-6,0,-6),new m.Vector3(-6,0,6),new m.Vector3(6,0,6),new m.Vector3(6,0,-6)],this.path.forEach(t=>{t.add(this.center)})}hit(t=.1){this.state!=T.STATES.DEAD&&(this.life-=t,this.life<=0)&&this.kill()}respawn(){this.path.forEach(t=>{t.z-=40}),this.model.visible=!0,this.coffin.visible=!1,this.life=1,this.curZ-=40,this.body.position.set(0,0,this.curZ),this.body.mesh.position.copy(this.body.position),this.startPatrol()}kill(){this.model.visible=!1,this.coffin.visible=!0,this.coffin.animate(),this.state=T.STATES.DEAD,this.stopAnims()}reset(){this.model.visible=!0,this.coffin.visible=!1,this.body&&this.startPosition&&(this.body.position.copy(this.startPosition),this.body.velocity.set(0,0,0),this.root.position.copy(this.startPosition)),this.curZ=this.center.z,this.life=1,this.initPath(),this.startPatrol()}startPatrol(){this.stopAnims(),this.pathIndex=0,this.state=T.STATES.PATROL,this.root.getWorldPosition(this.tmpVec),this.tmpVec.sub(this.path[this.pathIndex]).normalize().multiplyScalar(3).negate(),this.body.velocity.copy(this.tmpVec),this.pathV.copy(this.tmpVec),this.prevPos.copy(this.root.getWorldPosition(this.tmpVec))}updatePatrol(){var t=this.path[this.pathIndex].clone(),e=this.prevPos.distanceTo(t),i=(this.root.getWorldPosition(this.tmpVec),this.tmpVec.distanceTo(t));this.prevPos.copy(this.tmpVec),e<i?(this.pathIndex++,this.pathIndex>=this.path.length&&(this.pathIndex=0),t.copy(this.path[this.pathIndex]),this.tmpVec.sub(t).normalize().multiplyScalar(3).negate(),this.body.velocity.copy(this.tmpVec),this.pathV.copy(this.tmpVec)):this.body.velocity.copy(this.pathV)}startAttack(t){this.state=T.STATES.ATTACK,this.playAnim("drawaction"),t&&(t.knight.underAttack=!0)}startHone(t){if(this.state!=T.STATES.HONE){if(t){t.tmpVec.copy(t.player.position).sub(this.body.position).normalize(),t.raycaster.set(this.body.position,t.tmpVec);var i=t.raycaster.intersectObjects(t.scene.children);if(0<i.length){const s=i[0].object;let e=!1;if(t.knight.model.traverse(t=>{t==s&&(e=!0)}),!e)return}}this.stopAnims(),this.state=T.STATES.HONE}}updateAttack(){var t;this.attacking&&this.world&&(this.bladeEnd.getWorldPosition(this.tmpVec),0<(t=this.world.getPointCollisions(this.tmpVec,this.body,.6)).length)&&0<(t=t.filter(t=>"Player"==t.mesh.name)).length&&t[0].mesh.userData.player.hit()}update(t,e){switch(super.update(t,e),this.state){case T.STATES.IDLE:break;case T.STATES.PATROL:this.updatePatrol();break;case T.STATES.ATTACK:this.updateAttack();break;case T.STATES.DEAD:this.coffin.update(t)}}}class S{static STATES={IDLE:0,PLAYING:1,PAUSED:2,DEAD:3,COMPLETE:4};constructor(){var t=document.createElement("div"),e=(document.body.appendChild(t),this.clock=new m.Clock,this.camera=new m.PerspectiveCamera(50,window.innerWidth/window.innerHeight,.1,200),this.camera.position.set(5.3,10.5,20),this.camera.quaternion.set(-.231,.126,.03,.964),this.scene=new m.Scene,this.scene.background=new m.Color(328965),this.scene.add(new m.HemisphereLight(16777215,4210752,1.5)),this.renderer=new m.WebGLRenderer({antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),new m.DirectionalLight(16777215,2));e.position.set(1,3,3),this.scene.add(e),t.appendChild(this.renderer.domElement),this.initScene(),this.initPhysics(),this.tmpVec=new m.Vector3,this.tmpEuler=new m.Euler,this.tmpMat4=new m.Matrix4,this.raycaster=new m.Raycaster,this.force=new m.Vector3,this.speed=3,this.useHeadsetOrientation=!1,this.setupVR(),window.addEventListener("resize",this.resize.bind(this)),this.renderer.setAnimationLoop(this.render.bind(this))}startGame(){this.state=S.STATES.PLAYING,this.gameTime=0,this.startTime=this.clock.elapsedTime,document.getElementById("openingPanel").style.display="none"}gameOver(t){if(t){var e=document.getElementById("gameoverPanel"),i=document.getElementById("details");switch(t.state){case S.STATES.DEAD:i.innerHTML=`<P>You ran out of life ${this.player.position.distanceTo(this.grail.position).toFixed(0)} metres away from the Holy Grail</p>`;break;case S.STATES.COMPLETE:const t=this.clock.elapsedTime-this.startTime;i.innerHTML=`<p>Congratulations</p><p>You found the grail in ${t.toFixed(2)} seconds</p><p>Can you do better</p>`}e.style.display="block"}this.vrButton.endSession()}random(t,e){return Math.random()*(e-t)+t}initScene(){this.scene.background=new m.Color(657930),this.scene.fog=new m.Fog(657930,50,100);const t=new m.Mesh(new m.PlaneGeometry(100,1e3),new m.MeshPhongMaterial({color:10061926,depthWrite:!0}));t.rotation.x=-Math.PI/2,this.scene.add(t),t.position.z=-400,this.ground=t;var e=new m.AudioListener;this.camera.add(e);let i=40;for(var s=new m.Vector3,o=new p,n=new d;-2e3<i;){const m=.5<Math.random()?12:-12;var r=4*Math.random(),r=m<0?m-r:m+r;i-=10*Math.random();const t=Math.random()*Math.PI*2,e=n.clone();e.position.set(r,0,i),e.rotateY(t),e.scale.set(this.random(.5,2),this.random(.5,2),this.random(.5,2)),this.scene.add(e);for(let t=0;t<6;t++){const m=o.clone();s.set(this.random(0,6),0,this.random(-3,3)),e.position.x<0&&(s.x=-s.x),m.position.copy(e.position).add(s),m.rotation.set(this.random(0,2*Math.PI),this.random(0,2*Math.PI),this.random(0,2*Math.PI)),m.scale.set(this.random(.5,2),this.random(.5,2),this.random(.5,2)),this.scene.add(m)}}var e=new u,a=e.clone();e.rotateY(Math.PI/2),e.rotateX(-Math.PI/4),e.position.set(-27,5,-200),this.scene.add(e),a.rotateY(-Math.PI/2),a.rotateX(-Math.PI/4),a.position.set(27,5,-200),this.scene.add(a)}loadSound(t,e,i=.5,s=!1){const o=new m.Audio(e);return(new m.AudioLoader).load(t,t=>{o.setBuffer(t),o.setLoop(s),o.setVolume(i)}),o}createPlayer(){var t=new M(this.scene,this.world),e=(t.root.position.set(0,.5,10),new l(t.root,new o(.8),1));return e.mesh.userData.player=t,e.mesh.name="Player",(t.app=this).knight=t,this.knight.body=e,this.world.addBody(e),t.startPosition.copy(t.root.position),(t.game=this).follower=new m.Object3D,this.follower.position.set(0,5,8),e.mesh.add(this.follower),e}createEnemy(t,e){var i=new T(this.scene,e,this.world),s=(i.root.position.copy(t),new l(i.root,new o(.8),1));return s.mesh.userData.enemy=i,s.mesh.name="Enemy",i.body=s,i.startPosition.copy(t),i.orgZ=e,this.enemies.push(i),this.world.addBody(s),i.startPatrol(),i}createWall(t,o,n){const s=this,e=new m.Vector3(0,0,o);switch(t){case 1:r([-10,-6.75,-2.5,2.5,6.75,10],["tower2","wall3","tower3","tower3","wall3","tower2"]),i=new v(1.5,5),e.set(0,0,o),i.body=a(e,i),s.gates.push(i);break;case 2:r([-10,-7.75,-5,-.5,2,5,7.5,10],["tower2","wall1","tower3","tower3","wall2","tower1","wall2","tower2"]),i=new v(1.375,4.5),e.set(-2.75,0,o),i.body=a(e,i),s.scene.add(i),s.gates.push(i);break;case 3:r([-10,-7.5,-5,-2,.5,5,7.75,10],["tower2","wall2","tower1","wall2","tower3","tower3","wall1","tower2"]),i=new v(1.375,4.5),e.set(2.75,0,o),i.body=a(e,i),s.gates.push(i)}var i;function r(e,i){var s=new m.Vector3(0,0,o);for(let t=0;t<e.length;t++)s.x=e[t],a(s,n[i[t]].root.clone());s.set(-10,0,o-10);var t=n.wall4.root.clone();a(s,t),s.x=10,a(s,t.clone())}function a(t,e){var i;if(e)return e.position.copy(t),s.scene.add(e),i=(t=new m.Vector3(e.userData.bounds.width,e.userData.bounds.height,e.userData.bounds.depth).multiplyScalar(.5)).clone().multiplyScalar(-1),e=new l(e,new h(i,t)),s.world.addBody(e),e}e.set(this.random(-7,7),0,o-this.random(3,13)),this.collectables.push(new w(e)),e.set(this.random(-7,7),0,o-this.random(3,13)),this.collectables.push(new f(e))}initPhysics(){this.world=new r;const e=new m.Vector3,i={tower1:new t(2,4,2),tower2:new t(2,5,2),tower3:new t(2,6,2),wall1:new t(3,3,.2),wall2:new t(4,3,.2),wall3:new t(7,3,.2),wall4:new t(.2,3,20)};this.enemies=[],this.collectables=[],this.gates=[];for(let t=0;-1e3<=t;t-=20)if(0==t?this.createWall(1,t,i):this.createWall(Math.floor(3*Math.random())+1,t,i),.3<Math.random()&&this.createEnemy(e.set(this.random(-8,8),.5,t-10+this.random(-5,5)),t-10),-400==t){this.grail=new y(this.scene),this.grail.position.set(0,0,t-10),this.scene.add(this.grail);const e=new m.Vector3(1.5,3,1.5).multiplyScalar(.5),i=e.clone().multiplyScalar(-1),r=new l(this.grail,new h(i,e));this.world.addBody(r)}this.collectables.forEach(t=>{this.scene.add(t)}),this.player=this.createPlayer(),this.player.onCollision=t=>{var e=this.player.position.clone();e.y+=.7,this.effect.reset(e),this.knight.hit(.05),"Gate"==t&&(this.knight.rotateOnMove=!1,this.knight.skipAttack=!0,setTimeout(()=>{this.knight.rotateOnMove=!0,this.knight.skipAttack=!1},1e3)),this.knight.life<=0&&this.gameOver({state:S.STATES.DEAD})},this.fixedStep=1/60,this.effect=new c(this.scene,!1)}resize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}playAnim(t,e=!1){this.knight&&(e?this.knight.stopAnims():this.knight.playAnim(t))}resetGame(){this.dolly.position.z=10,this.camera.position.set(5.3,10.5,20),this.camera.quaternion.set(-.231,.126,.03,.964),this.camera.fov=50,this.knight.reset(),this.force.set(0,0,0),this.resize(),this.enemies.forEach(t=>t.reset()),this.collectables.forEach(t=>t.visible=!0),this.grail.reset(),this.gates.forEach(t=>t.reset())}setupVR(){this.renderer.xr.enabled=!0;var s=new i(this.renderer);function t(){o.knight.playAnim("drawaction")}function e(){o.knight.stopAnims()}this.vrButton=s;const o=this;this.renderer.xr.addEventListener("sessionend",function(t){o.resetGame()}),this.renderer.xr.addEventListener("sessionstart",function(t){o.startGame()}),this.dolly=new m.Group,this.root=new m.Group,this.root.position.y=-3.4,this.dolly.add(this.root),this.controllers=[];for(let i=0;i<=1;i++){const s=this.renderer.xr.getController(i);s.addEventListener("selectstart",t),s.addEventListener("selectend",e),s.addEventListener("connected",t=>{var e=this.buildController(t.data,i);e.scale.z=0,s.add(e),s.gamepad=t.data.gamepad,s.handedness=t.data.handedness}),s.addEventListener("disconnected",function(){var t=this.children[0];t&&t.children&&0<t.children.length&&(t.children[0].isMesh&&t.children[0].geometry.dispose(),this.remove(t)),o.dolly.remove(this)}),this.root.add(s),this.controllers.push({controller:s})}this.dolly.position.set(0,8,10),this.dolly.add(this.camera),this.scene.add(this.dolly),this.dummyCam=new m.Object3D,this.camera.add(this.dummyCam)}buildController(t){let e,i;switch(t.targetRayMode){case"tracked-pointer":return(e=new m.BufferGeometry).setAttribute("position",new m.Float32BufferAttribute([0,0,0,0,0,-1],3)),e.setAttribute("color",new m.Float32BufferAttribute([.5,.5,.5,0,0,0],3)),i=new m.LineBasicMaterial({vertexColors:!0,blending:m.AdditiveBlending}),new m.Line(e,i);case"gaze":return e=new m.RingBufferGeometry(.02,.04,32).translate(0,0,-1),i=new m.MeshBasicMaterial({opacity:.5,transparent:!0}),new m.Mesh(e,i)}}handleController(t,e){"right"==t.handedness?this.force.set(t.gamepad.axes[2],0,t.gamepad.axes[3]):"left"==t.handedness&&(this.knight.rotateStrength=-t.gamepad.axes[2])}render(t,e){const i=this.clock.getDelta();this.world&&(this.player.velocity.add(this.force.clone().multiplyScalar(i*this.speed)),this.world.step(this.fixedStep)),this.renderer.xr.isPresenting?(this.gameTime+=i,null==this.debugControls&&(this.useHeadsetOrientation?(this.tmpMat4.extractRotation(this.dummyCam.matrixWorld),this.tmpEuler.setFromRotationMatrix(this.tmpMat4),this.force.set(-this.tmpEuler.z,0,this.tmpEuler.x)):this.controllers.forEach(t=>this.handleController(t.controller))),this.follower.getWorldPosition(this.tmpVec),this.dolly.position.lerp(this.tmpVec,.1),this.enemies&&(this.knight.underAttack=!1,this.enemies.forEach(t=>{var e;t.state==T.STATES.DEAD?t.update(i):(t.state==T.STATES.HONE&&t.body.velocity.copy(t.root.position).sub(this.knight.root.position).normalize().multiplyScalar(.7*this.speed).negate(),t.update(i,t.body.velocity),(e=t.root.position.distanceTo(this.knight.root.position))<2?t.state!=T.STATES.ATTACK?t.startAttack(this):(this.tmpVec.copy(this.player.position).sub(t.body.position),t.setDirection(this.tmpVec),this.knight.underAttack=!0):e<10?t.startHone(this):t.state!=T.STATES.PATROL&&t.startPatrol())}))):this.enemies&&this.enemies.forEach(t=>{t.update(i,t.body.velocity)}),this.knight&&this.knight.update(i,this.player.velocity,this.dummyCam),this.effect&&this.effect.visible&&this.effect.update(t,i),this.collectables&&(this.tmpVec.copy(this.player.position),this.tmpVec.y-=.8,this.collectables.forEach(t=>{t.visible&&(t.rotateY(.01),t.position.distanceTo(this.tmpVec)<.5)&&(t instanceof f?this.knight.makeInvincible(10):t instanceof w&&this.knight.hit(-1),t.visible=!1)})),this.gates&&this.gates.forEach(t=>t.update(i)),this.grail&&(this.player.position.distanceTo(this.grail.position)<2&&this.grail.find(this),this.grail.update(t,i)),this.renderer.render(this.scene,this.camera)}}window.app=new S</script>