<!doctype html><meta content="width=device-width" name=viewport><title>Eugor</title><style>body,html{margin:0;padding:0;background:#000;overflow:hidden}canvas{position:fixed;left:0;right:0;top:0;bottom:0}</style><canvas id=Canvas>Sorry, your browser cannot render this content.</canvas><script>"use strict";var atlasWidth,atlas,canvas,ctx,resizeTimer,width,height,centerX,centerY,scaleFactor,cellSize,attackDistance,blockDistance,mapCols,mapRows,mapWidth,mapHeight,mapLeft,mapTop,now,factor,last,viewFirstRow,viewFirstCol,viewRows,viewCols,viewX,viewY,viewOffset,viewSkip,player,M=Math,D=document,W=window,resources={boss:{rect:{x:0,y:0,w:47,h:23}},exit:{rect:{x:32,y:23,w:16,h:16},back:!0},monster:{rect:{x:63,y:23,w:13,h:13}},monsterFightRight0:{rect:{x:48,y:23,w:15,h:14}},monsterFightRight1:{rect:{x:88,y:11,w:13,h:12}},monsterFightLeft0:{rect:{x:48,y:23,w:15,h:14},mirror:!0},monsterFightLeft1:{rect:{x:88,y:11,w:13,h:12},mirror:!0},monsterHitRight0:{rect:{x:168,y:23,w:10,h:12}},monsterHitLeft0:{rect:{x:168,y:23,w:10,h:12},mirror:!0},monsterWalkRight0:{rect:{x:131,y:23,w:11,h:13}},monsterWalkRight1:{rect:{x:102,y:0,w:12,h:13}},monsterWalkLeft0:{rect:{x:131,y:23,w:11,h:13},mirror:!0},monsterWalkLeft1:{rect:{x:102,y:0,w:12,h:13},mirror:!0},player:{rect:{x:152,y:0,w:9,h:14}},playerClimb0:{rect:{x:87,y:23,w:11,h:15}},playerClimb1:{rect:{x:143,y:0,w:9,h:14}},playerClimb2:{rect:{x:142,y:23,w:10,h:14}},playerFightRight0:{rect:{x:76,y:0,w:12,h:14}},playerFightRight1:{rect:{x:47,y:0,w:15,h:14}},playerFightLeft0:{rect:{x:76,y:0,w:12,h:14},mirror:!0},playerFightLeft1:{rect:{x:47,y:0,w:15,h:14},mirror:!0},playerHitRight0:{rect:{x:62,y:0,w:14,h:14}},playerHitRight1:{rect:{x:88,y:0,w:14,h:11}},playerHitLeft0:{rect:{x:62,y:0,w:14,h:14},mirror:!0},playerHitLeft1:{rect:{x:88,y:0,w:14,h:11},mirror:!0},playerWalkRight0:{rect:{x:110,y:23,w:11,h:14}},playerWalkRight1:{rect:{x:98,y:23,w:12,h:13}},playerWalkRight2:{rect:{x:76,y:23,w:11,h:15}},playerWalkRight3:{rect:{x:133,y:0,w:10,h:14}},playerWalkLeft0:{rect:{x:110,y:23,w:11,h:14},mirror:!0},playerWalkLeft1:{rect:{x:98,y:23,w:12,h:13},mirror:!0},playerWalkLeft2:{rect:{x:76,y:23,w:11,h:15},mirror:!0},playerWalkLeft3:{rect:{x:133,y:0,w:10,h:14},mirror:!0},rip:{rect:{x:175,y:0,w:7,h:13}},skeleton:{rect:{x:168,y:0,w:7,h:15}},skeletonFightRight0:{rect:{x:121,y:23,w:10,h:15}},skeletonFightRight1:{rect:{x:124,y:0,w:9,h:15}},skeletonFightLeft0:{rect:{x:121,y:23,w:10,h:15},mirror:!0},skeletonFightLeft1:{rect:{x:124,y:0,w:9,h:15},mirror:!0},skeletonHitRight0:{rect:{x:114,y:0,w:10,h:15}},skeletonHitLeft0:{rect:{x:114,y:0,w:10,h:15},mirror:!0},skeletonWalkRight0:{rect:{x:161,y:0,w:7,h:15}},skeletonWalkRight1:{rect:{x:160,y:23,w:8,h:14}},skeletonWalkRight2:{rect:{x:152,y:23,w:8,h:15}},skeletonWalkLeft0:{rect:{x:161,y:0,w:7,h:15},mirror:!0},skeletonWalkLeft1:{rect:{x:160,y:23,w:8,h:14},mirror:!0},skeletonWalkLeft2:{rect:{x:152,y:23,w:8,h:15},mirror:!0},stairs:{rect:{x:16,y:23,w:16,h:16},back:!0},wall:{rect:{x:0,y:23,w:16,h:16},back:!0}},skeleton={sprite:"skeleton",walk:3,fight:2,hit:1},monster={sprite:"monster",walk:2,fight:2,hit:1},level=0,levels=[function(){generate(16,8,!0)},function(){generate(24,16)},function(){generate(32,24)}],sprites={},map=[],pointersLength=0,pointersX=[],pointersY=[],keysDown=[],entitiesLength=0,entities=[],speed=.03,lastHit=0;function reveal(e,t){e|=0;for(var i=(t|=0)*mapCols,r=i;r>0&&map[r+e].sprite;r-=mapCols)i=r;for(var a=i+M.max(e-2,0),l=i+M.min(e+3,mapCols),s=mapCols-(l-a),n=(t+1)*mapCols;a<n;a+=s,l+=mapCols)for(;a<l;++a){(r=map[a]).sprite&&(r.visible=!0)}}function tile(e,t){return map[(0|t)*mapCols+(0|e)]}function addEntity(e){e.hp=e.hp||20,e.fighting=e.isHit=!1,e.frame=e.last=0,e.dx=e.dx||0,e.dy=e.dy||0,e.vx=e.vx||0,e.vy=e.vy||0,e.fightsFreq=320/e.fights|0,e.hitsFreq=320/e.hits|0,e.walksFreq=320/e.walks|0,e.climbsFreq=320/e.climbs|0,entities.push(e),entitiesLength=entities.length}function setPlayer(e,t){addEntity(player={sprite:"player",climbs:3,walks:4,fights:2,hits:2,hp:100,x:e*cellSize,y:(t+1)*cellSize-sprites.player.centerY}),reveal(e,t)}function addEnemy(e,t){var i=Math.random()>.5?skeleton:monster;addEntity({sprite:i.sprite,walks:i.walk,fights:i.fight,hits:i.hit,x:e*cellSize,y:t*cellSize+(cellSize-sprites[i.sprite].height>>1)})}function carve(e,t,i){for(var r=e.l-t,a=e.r-t,l=e.t-i,s=e.b-i,n=l*mapCols+r,o=a-r,c=mapCols-o,p=s-l;p--;n+=c)for(var h=o;h--;++n){var m=map[n];m.sprite=e.sprite,m.stairs=e.stairs}}function addSpace(e,t,i,r,a,l){var s=i?t.l-r:t.r,n=t.b-a,o=s+r,c=n+a;t.l=M.min(t.l,s),t.r=M.max(t.r,o),t.t=M.min(t.t,n),t.b=M.max(t.b,c),e.push({l:s,t:n,r:o,b:c,sprite:l})}function generate(e,t,i){for(var r=[],a=M.ceil(M.sqrt(e)),l=M.random()*a*8|0,s=0,n=0,o=0,c=0,p={l:0,t:0,r:0,b:0};;){for(var h=r.length,m=e-M.min(e,M.max(2,M.round(M.random()*a)));e>m;--e){var w=!1;r.length!=h&&addSpace(r,p,w=M.random()>.5,M.max(1,5*M.random()|0),1,sprites.wall),addSpace(r,p,w,M.max(3,9*M.random()|0),M.max(2,5*M.random()|0),sprites.wall)}if(s=M.min(s,p.l),o=M.max(o,p.r),n=M.min(n,p.t),c=M.max(c,p.b),e<1)break;var f=p.l+1,y=p.r-2;p.l=p.r=M.abs(f-l)>M.abs(y-l)?f:y,l=p.l;var g=p.t-M.max(1,3*M.random()|0);r.push({l:p.l,t:g,r:p.l+1,b:p.b,stairs:!0,sprite:sprites.stairs}),p.b=g}entities.length=map.length=0,mapLeft=width-(mapWidth=(mapCols=o-s)*cellSize)>>1,mapTop=height-(mapHeight=(mapRows=c-n)*cellSize)>>1;for(var v=mapCols*mapRows;v--;)map[v]={visible:!1};for(v=t,f=r.length;v--;){for(;(d=r[M.max(2,M.random()*f|0)]).stairs;);d.enemies=d.enemies?++d.enemies:1}v=0;for(var x=r.length-1;v<=x;++v){var d,u=(d=r[v]).enemies;if(carve(d,s,n),u>0){var k=(d.r-d.l)/u,b=d.l-s,S=d.b-n-1;for(u=d.enemies;u--;b+=k)addEnemy(b+.5,S+.5)}if(0==v){var z=(d.l+d.r>>1)-s,D=d.b-n-1;map[D*mapCols+z].sprite=sprites.exit,tile(z,D).sprite=sprites.exit,setPlayer(z,D),i&&(addEntity({sprite:"boss",x:(z+1.75)*cellSize|0,y:D*cellSize+(.5*cellSize|0),hp:-1}),i=!1)}else if(v==x){(g=tile((d.l+d.r>>1)-s,d.b-n-1)).sprite=sprites.exit,g.exit=!0}}}function hit(e){--e.hp,e.isHit=!0,e.last=now,e.frame=0,player===e&&(lastHit=now)}function drawEntities(){for(var e=0;e<entitiesLength;++e){var t=entities[e],i=t.x,r=t.y,a=mapLeft+i,l=mapTop+r;if(t==player||tile(i/cellSize,r/cellSize).visible){var s=t.sprite;if(t.hp<1){if(t===player&&(s="rip"),"boss"==s||"rip"==s){var n=sprites[s];ctx.drawImage(n,a-n.centerX|0,l-n.centerY|0)}}else{var o,c=null,p=0;if(t.isHit?(c="Hit",p=t.hits,o=t.hitsFreq):t.fighting?(c="Fight",p=t.fights,o=t.fightsFreq):0!=t.vy?(c="Climb",p=t.climbs,o=t.climbsFreq):0!=t.vx&&(c="Walk",p=t.walks,o=t.walksFreq),c){var h=t.frame;now-t.last>o&&(t===player&&"Fight"==c&&h%p==1&&(t.fighting=!1),t.frame=++h,t.last=now,t.isHit=!1),"Climb"!=c&&(c+=t.dx>0?"Right":"Left"),s+=c+h%p}n=sprites[s];if(t!==player)if(player.hp>0&&M.abs(player.y-t.y)<cellSize){t.dx=player.x-t.x,t.vx=t.dx>0?speed:-speed;var m=M.abs(t.dx);if(m<attackDistance)t.frame%t.fights==0&&(player.fighting?hit(t):hit(player));else if(m>blockDistance){var w=t.x+t.vx*cellSize*factor,f=t.y,y=n.centerX,g=w+y;blocks(w-y,f)||blocks(g,f)||(t.x=w)}}else t.fighting&&(t.fighting=!1,t.vx=0);ctx.drawImage(n,a-n.centerX|0,l-n.centerY|0)}}}}function drawMap(){for(var e=viewOffset,t=0|viewY,i=viewFirstRow;i<viewRows;++i,t+=cellSize,e+=viewSkip)for(var r=0|viewX,a=viewFirstCol;a<viewCols;++a,r+=cellSize,++e){var l=map[e];l.visible&&l.sprite&&ctx.drawImage(l.sprite,0|r,0|t)}}function draw(){var e=now-lastHit;e=e<500?148+M.round(.214*(500-e)):148,ctx.fillStyle="rgb("+e+",210,148)",ctx.fillRect(0,0,width,height),drawMap(),drawEntities()}function calculateVisibleCells(){var e,t=mapLeft+mapWidth,i=mapTop+mapHeight;(viewFirstRow=0,viewFirstCol=0,viewRows=mapRows,viewCols=mapCols,viewX=0|mapLeft,viewY=0|mapTop,viewOffset=0,viewSkip=0,i>height&&(viewRows-=(i-height)/cellSize|0),mapTop<0)&&(viewOffset+=(e=mapTop/-cellSize|0)*mapCols,viewY+=e*cellSize,viewFirstRow+=e);t>width&&(viewCols-=e=(t-width)/cellSize|0,viewSkip+=e);mapLeft<0&&(viewSkip+=e=mapLeft/-cellSize|0,viewOffset+=e,viewFirstCol=e,viewX+=e*cellSize)}function alignMap(){mapWidth>width&&(mapLeft=M.max(M.min(0,centerX-player.x),width-mapWidth)),mapHeight>height&&(mapTop=M.max(M.min(0,centerY-player.y),height-mapHeight)),calculateVisibleCells()}function fight(){player.fighting=!0,player.frame=0}function blocks(e,t){return t<0||t>=mapHeight||e<0||e>=mapWidth||!tile(e/cellSize,t/cellSize).sprite}function moveBy(e,t,i){t=M.min(1,t)*cellSize,i=M.min(1,i)*cellSize;for(var r=e.x+t,a=e.y+i,l=entitiesLength;l--;){var s=entities[l];if(s!==e){var n,o,c=s.x,p=s.y;if(s.hp>0&&(o=M.abs(p-a))<attackDistance&&(n=M.abs(c-r))<attackDistance){if(s.dx=r-c,s.vx=s.dx>0?speed:-speed,s.fighting||(s.fighting=!0,s.frame=0,s.last=now),n<blockDistance&&o<blockDistance)return}else s.isHit=s.fighting=!1}}var h=sprites[e.sprite],m=h.centerX-1,w=h.centerY-1,f=e.x,y=e.y,g=f-m,v=y-w,x=f+m,d=y+w,u=f/cellSize|0,k=y/cellSize|0,b=k+1,S=h.centerY,z=b*cellSize-S,D=(F=tile(u,k)).stairs,L=b<mapRows&&tile(u,b).stairs;if(F.exit)return++level>=levels.length?void alert("You made it!"):(levels[level](),void alignMap());if(!(blocks(g+t,v)||blocks(x+t,v)||blocks(g+t,d)||blocks(x+t,d))){for(var F,R=b;R<mapRows&&(F=tile(u,R)).sprite;++R)++b;var C=b*cellSize-S;(!D||tile((f+t)/cellSize,y/cellSize).stairs||y>=C)&&(e.dx=t,e.vx=t,e.x=f+t)}!D&&!L||blocks(g,v+i)||blocks(x,v+i)||blocks(g,d+i)||blocks(x,d+i)||(D?y+=i:y=M.max(z,y+i),e.vy=e.dy=y-e.y,e.y=y)}function input(){if(player.hp<1)(pointersLength>0||keysDown[32]||keysDown[13])&&(levels[level=0](),alignMap());else{var e=0,t=0,i=speed*factor;pointersLength?(e=pointersX[0]-mapLeft<player.x?-i:i,t=pointersY[0]-mapTop<player.y?-i:i,pointersLength>1&&fight()):(keysDown[37]?e=-i:keysDown[39]&&(e=i),keysDown[38]?t=-i:keysDown[40]&&(t=i),keysDown[32]&&fight()),e||t?(moveBy(player,e,t),reveal(player.x/cellSize,player.y/cellSize),alignMap()):player.vx=player.vy=0}}function run(){requestAnimationFrame(run),now=Date.now(),factor=(now-last)/16,last=now,input(),draw()}function setPointers(e,t){var i=e||event;if(t<1){if(pointersLength>0&&i.touches&&(t=i.touches.length))return setPointers(i,t);pointersLength=0}else if(i.touches){pointersLength=i.touches.length;for(var r=0;r<pointersLength;++r){var a=i.touches[r];pointersX[r]=a.pageX,pointersY[r]=a.pageY}}else void 0!==i.clientX?(pointersX[0]=i.clientX,pointersY[0]=i.clientY,pointersLength=1):void 0!==i.pageX&&(pointersX[0]=i.pageX,pointersY[0]=i.pageY,pointersLength=1);return i.preventDefault(),!1}function pointerUp(e){return setPointers(e,0)}function pointerMove(e){return setPointers(e,pointersLength)}function pointerDown(e){return setPointers(e,1)}function setKey(e,t){var i=e||event;return keysDown[i.keyCode]=t,i.preventDefault(),!1}function keyUp(e){return setKey(e,!1)}function keyDown(e){return setKey(e,!0)}function scaleSprite(e){var t=e.rect,i=M.max(t.w*scaleFactor|0,1),r=M.max(t.h*scaleFactor|0,1),a=D.createElement("canvas"),l=a.getContext("2d");a.width=i,a.height=r,a.centerX=i>>1,a.centerY=r>>1;var s=t.y*(atlasWidth<<2)+(t.x<<2),n=atlasWidth-t.w<<2,o=0,c=scaleFactor,p=e.back?80:255,h=M.max(scaleFactor-1,1);e.mirror&&(c=-c,o=scaleFactor*t.w+c|0);for(var m=t.h,w=0;m--;s+=n,w+=scaleFactor)for(var f=t.w,y=o;f--;y+=c){e=atlas[s++],atlas[s++],atlas[s++];0==atlas[s++]||e>200||(l.fillStyle="rgba(0,0,0,"+p/255+")",l.fillRect(y,w,h,h))}return a}function resize(){for(var e in canvas.width=width=W.innerWidth,canvas.height=height=W.innerHeight,centerX=width>>1,centerY=height>>1,cellSize=resources.wall.rect.h,scaleFactor=M.max(1,M.round(M.min(width,height)/5/cellSize)),attackDistance=.7*(cellSize*=scaleFactor)|0,blockDistance=.4*cellSize|0,resources)sprites[e]=scaleSprite(resources[e]);levels[level](),alignMap()}function scheduleResize(){resizeTimer&&clearTimeout(resizeTimer),resizeTimer=setTimeout(resize,100)}function decompressAtlas(){var e=D.createElement("canvas"),t=e.getContext("2d"),i=atlas.width,r=atlas.height;e.width=i,e.height=r,t.drawImage(atlas,0,0),atlas=t.getImageData(0,0,i,r).data,atlasWidth=i}function init(){(canvas=D.getElementById("Canvas"))&&(ctx=canvas.getContext("2d",{alpha:!1}))&&(decompressAtlas(),W.onresize=scheduleResize,resize(),D.onkeydown=keyDown,D.onkeyup=keyUp,D.onmousedown=pointerDown,D.onmousemove=pointerMove,D.onmouseup=pointerUp,D.onmouseout=pointerUp,"ontouchstart"in D&&(D.ontouchstart=pointerDown,D.ontouchmove=pointerMove,D.ontouchend=pointerUp,D.ontouchleave=pointerUp,D.ontouchcancel=pointerUp),last=Date.now()-16,run())}function load(){(atlas=new Image).src="atlas.png",atlas.onload=init}W.onload=load</script>