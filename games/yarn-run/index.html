<!doctype html><title>Yarn Run - js13kGames 2025</title><meta content="width=device-width" name=viewport><title>Yarn Run</title><style>#totalCost,.controls{position:absolute;top:10px}body,html{margin:0;padding:0;height:100%;overflow:hidden}canvas{border:1px solid #000;display:block;min-width:800px;min-height:600px}.controls{left:10px;z-index:10}.controls button{margin-right:10px;padding:10px 20px;font-size:16px}.pill{background:#eee;padding:5px 10px;border-radius:20px;font-size:14px}.row{margin-bottom:8px}.muted{opacity:.7}#totalCost{right:10px;z-index:11;background:#111;color:#fff;padding:8px 14px;border-radius:999px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;font-weight:600;box-shadow:0 2px 6px rgba(0,0,0,.15)}#levelSelect{margin-left:8px}label.pill input{vertical-align:middle;margin-right:6px}#totalCost.over{background:#8b0000;color:#fff}#levelSelect option:disabled{color:#999}.controls{pointer-events:none}.controls *{pointer-events:auto}body.dragging .controls *{pointer-events:none}body.passthrough .controls,body.passthrough .controls *{pointer-events:none}</style><div class=controls><div class=row><button id=bouncyButton>Platform</button> <button id=timerButton>Timer</button> <button id=bridgeButton>Bridge</button> <button id=deleteButton>Delete</button> <button id=targetButton>Target</button> <button id=playBtn>Play</button> <button id=clearBtn>Clear</button> <select class=pill id=levelSelect><option value=1>Level 1<option value=2>Level 2<option value=3>Level 3<option value=4>Level 4<option value=5>Level 5<option value=6>Level 6<option value=7>Level 7<option value=8>Level 8<option value=9>Level 9<option value=10>Level 10<option value=11>Level 11<option value=12>Level 12<option value=13>Level 13<option value=14>Sandbox</select> <span class=pill>[Shift] lock H/V</span> <span class=pill>[Right Click] Add Ball</span> <span class=pill>[H] Hide Menu</span> <span class=pill>[I] Show Tips</span> <label class=pill style=margin-left:8px id=budgetlbl><input id=budgetInput type=number min=0 step=10 value=0 style=width:90px;margin-left:6px></label> <label class=pill style=cursor:pointer><input id=adminToggle type=checkbox> Admin</label></div><div class=row id=bouncyRow style=display:block><label for=bounceSlider>Bounce</label> <input id=bounceSlider type=range min=0 step=0.05 value=0.9 max=1.2> <span class=pill id=bounceVal>0.90</span> <label for=tensionSlider>Tension</label> <input id=tensionSlider type=range min=0 step=0.1 value=0 max=2> <span class=pill id=tensionVal>0.0</span></div><div class=row id=timerRow style=display:none><label for=timerSlider>Timer (seconds)</label> <input id=timerSlider type=range min=0 step=0.1 value=0.1 max=20> <span class=pill id=timerVal>5.0s</span> <span class="pill muted">Click a joint to arm</span></div><div class=row><button id=saveBtn>Save</button> <button id=loadBtn>Load</button></div></div><div id=totalCost>Budget: £0</div><div id=h style="position:fixed;right:10px;top:70px;z-index:999;background:#ffff8f;border:1px solid #000;padding:8px 10px;border-radius:8px;font:12px system-ui;line-height:1.2" onclick="localStorage.h=1,this.hidden=1"><b>Build tips [Click to close]</b><br><ul><li>Use build menu to set current item<li>Click and drag to place platform / bridge<li>Shift - lock Hor and Vert<li>Right-click: ball<li>Click platform blue joint to unpin<li>Drag joint: resize<li>Timer→click to add break time</ul></div><canvas id=canvas></canvas><script>const controls=document.querySelector(".controls"),canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d");canvas.addEventListener("mousedown",()=>document.body.classList.add("dragging")),window.addEventListener("mouseup",()=>document.body.classList.remove("dragging")),window.addEventListener("keydown",e=>{"i"!=e.key&&"I"!=e.key||!h||(localStorage.removeItem("h"),h.hidden=0)}),window.addEventListener("keydown",e=>{e.altKey&&document.body.classList.add("passthrough")}),window.addEventListener("keyup",e=>{e.altKey||document.body.classList.remove("passthrough")}),window.addEventListener("keydown",e=>{"h"===e.key.toLowerCase()&&(controls.style.display="none"===controls.style.display?"":"none",resizeCanvas?.())});const VIRT_W=1600,VIRT_H=900,MIN_SCREEN_W=800,MIN_SCREEN_H=600,view={scale:1,offX:0,offY:0};function newItemFromLevelFlag(){return!!isAdmin}function resizeCanvas(){const e=Math.max(window.innerWidth,MIN_SCREEN_W),t=Math.max(window.innerHeight,MIN_SCREEN_H);canvas.width=e,canvas.height=t;const n=Math.min(e/VIRT_W,t/VIRT_H);view.scale=n,view.offX=Math.floor((e-VIRT_W*n)/2),view.offY=Math.floor((t-VIRT_H*n)/2)}function setWorldTransform(){ctx.setTransform(view.scale,0,0,view.scale,view.offX,view.offY)}function resetTransform(){ctx.setTransform(1,0,0,1,0,0)}function screenToWorld(e,t){const n=canvas.getBoundingClientRect();return{x:(e-n.left-view.offX)/view.scale,y:(t-n.top-view.offY)/view.scale}}resizeCanvas();const gravity=.5,friction=.99,ballFriction=.99,platformThickness=10,endpointRadius=7,maxSpeed=50,MIN_PLATFORM_LEN=30,SNAP_RADIUS=15,DEFAULT_TARGET_RADIUS=36,TARGET_REQUIRED_TIME=3,COST={ball:500,platformBase:10,platformPerPx:.1,bridgePerPx:.08,bouncePerUnit:40,tensionPerUnit:50,timerPerSecond:5,target:100};let balls=[],platforms=[],targets=[],selectedPlatformType="bouncy",isCreatingPlatform=!1,draggedPlatform=null,keys={shift:!1},levelBudget=0,levelCompleted=!1,overBudgetOnWin=!1;const FIXED_DT=1/120,SUBSTEPS=4;let acc=0,last=performance.now();const FX_MAX=600,fx=[];function rand(e,t){return e+Math.random()*(t-e)}function clamp(e,t,n){return Math.max(t,Math.min(n,e))}let editing={platform:null,which:null,startMx:0,startMy:0,moved:!1,otherX:0,otherY:0},timerMode=!1,timerSeconds=5,deleteMode=!1,timersRunning=!1,isPlaying=!1,levelBeaten=!1;const levelSelect=document.getElementById("levelSelect");let currentLevel=Number(levelSelect?.value||1);const adminToggle=document.getElementById("adminToggle");let isAdmin=!adminToggle||adminToggle.checked;adminToggle&&adminToggle.addEventListener("change",()=>{isAdmin=adminToggle.checked});const adminWrap=adminToggle?.closest("label")||adminToggle?.parentElement;function updateAdminToggleVisibility(){if(!adminToggle)return;const e=highestSequentialCompleted()>=MAX_LEVELS;adminToggle.disabled=!e,e||(adminToggle.checked=!1,isAdmin=!1),adminToggle.parentElement.style.opacity=e?"":"0.5",updateAdminUI?.()}let lastTs=performance.now(),dt=1/60,scale=1;balls.push({x:100,y:100,radius:20,vx:0,vy:0,mass:1,isDragging:!1,rotation:0,fromLevel:newItemFromLevelFlag()});let mouse={x:0,y:0,isDown:!1,startX:0,startY:0};const bridgeBtn=document.getElementById("bridgeButton"),bouncyBtn=document.getElementById("bouncyButton"),targetBtn=document.getElementById("targetButton"),timerBtn=document.getElementById("timerButton"),deleteBtn=document.getElementById("deleteButton"),bouncyRow=document.getElementById("bouncyRow"),bounceSlider=document.getElementById("bounceSlider"),bounceVal=document.getElementById("bounceVal"),tensionSlider=document.getElementById("tensionSlider"),tensionVal=document.getElementById("tensionVal"),timerRow=document.getElementById("timerRow"),timerSlider=document.getElementById("timerSlider"),timerVal=document.getElementById("timerVal"),saveBtn=document.getElementById("saveBtn"),loadBtn=document.getElementById("loadBtn"),clearBtn=document.getElementById("clearBtn"),playBtn=document.getElementById("playBtn"),totalCostEl=document.getElementById("totalCost"),budgetInput=document.getElementById("budgetInput"),budgetlbl=document.getElementById("budgetlbl");var LEVELS=[{budget:150,balls:[{x:231.37,y:259.71,fromLevel:!0}],targets:[{x:696.96,y:704.51,radius:36,fromLevel:!0}],platforms:[]},{budget:50,balls:[{x:454.25,y:175.66,fromLevel:!0}],targets:[{x:459.92,y:526.02,radius:36,fromLevel:!0}],platforms:[{type:"bridge",segmentLength:21.3,costLength:191.71,points:[{x:357.92,y:227.6,isFixed:!0,timer:null,costTimer:null},{x:379.22,y:227.7,isFixed:!1,timer:null,costTimer:null},{x:400.52,y:227.81,isFixed:!1,timer:null,costTimer:null},{x:421.83,y:227.91,isFixed:!1,timer:null,costTimer:null},{x:443.13,y:228.02,isFixed:!1,timer:0,costTimer:0},{x:464.43,y:228.12,isFixed:!1,timer:.7,costTimer:.7},{x:485.73,y:228.23,isFixed:!1,timer:null,costTimer:null},{x:507.03,y:228.33,isFixed:!1,timer:null,costTimer:null},{x:528.33,y:228.44,isFixed:!1,timer:null,costTimer:null},{x:549.63,y:228.54,isFixed:!0,timer:null,costTimer:null}],fromLevel:!0}]},{budget:80,balls:[{x:221.93,y:669.57,fromLevel:!0}],targets:[{x:1401.47,y:427.81,radius:36,fromLevel:!0}],platforms:[{type:"bouncy",x:203.04,y:722.46,length:70.96,angle:2.04,thickness:10,bounce:1.2,tension:2,isFixedStart:!0,isFixedEnd:!0,timerStart:.2,timerEnd:null,timerStartCost:.2,timerEndCost:null,costLength:70.96,fromLevel:!0}]},{budget:250,balls:[{x:516.6,y:186.29,fromLevel:!0},{x:672.5,y:186.29,fromLevel:!0}],targets:[{x:278.78,y:554.91,radius:36,fromLevel:!0},{x:910.32,y:553.59,radius:36,fromLevel:!0}],platforms:[{type:"bouncy",x:536.42,y:214.04,length:50.21,angle:3.14,thickness:10,bounce:0,tension:0,isFixedStart:!0,isFixedEnd:!0,timerStart:null,timerEnd:.6,timerStartCost:null,timerEndCost:.6,costLength:50.21,fromLevel:!0},{type:"bouncy",x:648.72,y:215.36,length:50.21,angle:0,thickness:10,bounce:0,tension:0,isFixedStart:!0,isFixedEnd:!0,timerStart:null,timerEnd:.6,timerStartCost:null,timerEndCost:.6,costLength:50.21,fromLevel:!0}]},{budget:100,balls:[{x:558.88,y:163.83,fromLevel:!0}],targets:[{x:914.29,y:511.31,radius:36,fromLevel:!0}],platforms:[{type:"bouncy",x:523.2,y:786.13,length:50.21,angle:0,thickness:10,bounce:0,tension:0,isFixedStart:!0,isFixedEnd:!0,timerStart:null,timerEnd:null,timerStartCost:null,timerEndCost:null,costLength:50.21,fromLevel:!0},{type:"bouncy",x:546.99,y:827.09,length:71.35,angle:-1.57,thickness:10,bounce:1.2,tension:2,isFixedStart:!0,isFixedEnd:!0,timerStart:null,timerEnd:.4,timerStartCost:null,timerEndCost:.4,costLength:71.35,fromLevel:!0},{type:"bouncy",x:858.79,y:475.64,length:79.27,angle:1.57,thickness:10,bounce:1.2,tension:0,isFixedStart:!0,isFixedEnd:!0,timerStart:null,timerEnd:null,timerStartCost:null,timerEndCost:null,costLength:79.27,fromLevel:!0}]},{budget:400,balls:[{x:1232.7,y:701.57,fromLevel:!0}],targets:[{x:138.73,y:134.76,radius:36,fromLevel:!0}],platforms:[]},{budget:500,balls:[{x:639.47,y:99.09,fromLevel:!0},{x:731.96,y:99.09,fromLevel:!0}],targets:[{x:685.71,y:227.25,radius:36,fromLevel:!0},{x:689.68,y:734.6,radius:36,fromLevel:!0}],platforms:[{type:"bouncy",x:675.14,y:142.69,length:139.29,angle:2.39,thickness:10,bounce:0,tension:0,isFixedStart:!0,isFixedEnd:!0,timerStart:null,timerEnd:null,timerStartCost:null,timerEndCost:null,costLength:139.29,fromLevel:!0},{type:"bouncy",x:801.98,y:239.14,length:140.27,angle:-2.39,thickness:10,bounce:0,tension:0,isFixedStart:!0,isFixedEnd:!0,timerStart:null,timerEnd:null,timerStartCost:null,timerEndCost:null,costLength:140.27,fromLevel:!0}]},{budget:250,balls:[{x:583.15,y:242.57,fromLevel:!0},{x:583.15,y:291.58,fromLevel:!0}],targets:[{x:1250.84,y:687.29,radius:36,fromLevel:!0}],platforms:[{type:"bouncy",x:535.38,y:204.59,length:165.8,angle:1.76,thickness:10,bounce:1.2,tension:0,isFixedStart:!0,isFixedEnd:!0,timerStart:null,timerEnd:null,timerStartCost:null,timerEndCost:null,costLength:165.8,fromLevel:!0},{type:"bouncy",x:638.28,y:200.92,length:171.39,angle:1.41,thickness:10,bounce:1.2,tension:0,isFixedStart:!0,isFixedEnd:!0,timerStart:null,timerEnd:null,timerStartCost:null,timerEndCost:null,costLength:171.39,fromLevel:!0},{type:"bouncy",x:504.75,y:367.53,length:160.99,angle:.02,thickness:10,bounce:1.2,tension:0,isFixedStart:!0,isFixedEnd:!0,timerStart:null,timerEnd:null,timerStartCost:null,timerEndCost:null,costLength:160.99,fromLevel:!0}]},{budget:400,balls:[{x:384.69,y:563.55,fromLevel:!0}],targets:[{x:938.44,y:392.04,radius:36,fromLevel:!0}],platforms:[{type:"bouncy",x:334.45,y:596.63,length:98.01,angle:0,thickness:10,bounce:0,tension:0,isFixedStart:!1,isFixedEnd:!1,timerStart:null,timerEnd:null,timerStartCost:null,timerEndCost:null,costLength:98.01,fromLevel:!0},{type:"bouncy",x:461.87,y:643.67,length:162.79,angle:3.14,thickness:10,bounce:0,tension:0,isFixedStart:!0,isFixedEnd:!0,timerStart:null,timerEnd:null,timerStartCost:null,timerEndCost:null,costLength:162.79,fromLevel:!0},{type:"bouncy",x:317.3,y:198.47,length:140.89,angle:0,thickness:10,bounce:0,tension:0,isFixedStart:!0,isFixedEnd:!0,timerStart:null,timerEnd:null,timerStartCost:null,timerEndCost:null,costLength:140.89,fromLevel:!0}]},{budget:600,balls:[{x:89.43,y:802.45,fromLevel:!0}],targets:[{x:1161.41,y:200.92,radius:36,fromLevel:!0}],platforms:[]},{budget:600,balls:[{x:381.01,y:209.49,fromLevel:!0},{x:733.84,y:439.82,fromLevel:!0},{x:1018.07,y:208.27,fromLevel:!0}],targets:[{x:139.66,y:706.89,radius:36,fromLevel:!0},{x:1308.42,y:757.12,radius:36,fromLevel:!0},{x:730.17,y:312.4,radius:36,fromLevel:!0}],platforms:[]},{budget:500,balls:[{x:536.6,y:269.53,fromLevel:!0}],targets:[{x:803.68,y:395.71,radius:36,fromLevel:!0}],platforms:[{type:"bouncy",x:398.16,y:204.59,length:185,angle:.01,thickness:10,bounce:0,tension:0,isFixedStart:!0,isFixedEnd:!0,timerStart:null,timerEnd:null,timerStartCost:null,timerEndCost:null,costLength:185,fromLevel:!0},{type:"bouncy",x:583.63,y:221.93,length:300,angle:1.57,thickness:10,bounce:0,tension:0,isFixedStart:!0,isFixedEnd:!0,timerStart:null,timerEnd:null,timerStartCost:null,timerEndCost:null,costLength:300,fromLevel:!0},{type:"bouncy",x:584.58,y:536.42,length:257.82,angle:1.56,thickness:10,bounce:0,tension:0,isFixedStart:!0,isFixedEnd:!0,timerStart:null,timerEnd:null,timerStartCost:null,timerEndCost:null,costLength:257.82,fromLevel:!0}]},{budget:13e3,balls:[{x:508.63,y:248.14,fromLevel:!0},{x:510.88,y:331.23,fromLevel:!0},{x:508.63,y:396.35,fromLevel:!0},{x:509.75,y:463.72,fromLevel:!0},{x:509.75,y:524.35,fromLevel:!0},{x:631.02,y:249.26,fromLevel:!0},{x:687.16,y:275.09,fromLevel:!0},{x:724.21,y:313.26,fromLevel:!0},{x:696.14,y:359.3,fromLevel:!0},{x:656.84,y:389.61,fromLevel:!0},{x:696.14,y:416.56,fromLevel:!0},{x:724.21,y:467.09,fromLevel:!0},{x:688.28,y:514.25,fromLevel:!0},{x:629.89,y:524.35,fromLevel:!0},{x:903.86,y:253.75,fromLevel:!0},{x:909.47,y:315.51,fromLevel:!0},{x:918.46,y:385.12,fromLevel:!0},{x:916.21,y:445.75,fromLevel:!0},{x:917.33,y:520.98,fromLevel:!0},{x:976.84,y:375.02,fromLevel:!0},{x:1013.89,y:325.61,fromLevel:!0},{x:1038.6,y:260.49,fromLevel:!0},{x:998.18,y:430.04,fromLevel:!0},{x:1064.42,y:523.23,fromLevel:!0},{x:1030.74,y:477.19,fromLevel:!0}],targets:[{x:138.11,y:525.47,radius:36,fromLevel:!0},{x:444.63,y:707.37,radius:36,fromLevel:!0},{x:781.47,y:717.47,radius:36,fromLevel:!0},{x:1107.09,y:710.74,radius:36,fromLevel:!0},{x:1302.46,y:515.37,radius:36,fromLevel:!0}],platforms:[]}];function seedLevelsIfNeeded(){const e=globalThis.LEVELS||globalThis.window?.LEVELS;if(Array.isArray(e)&&e.length&&!localStorage.getItem("seedz")){for(let t=0;t<e.length;t++){const n=e[t];if(!n)continue;const l=`physicsLevel_${t+1}`;localStorage.getItem(l)||localStorage.setItem(l,JSON.stringify(n,(e,t)=>"number"==typeof t?+t.toFixed(2):t))}localStorage.setItem("seedz","1")}}function updateAdminUI(){const e=isAdmin||currentLevel===SANDBOX_LEVEL;[targetBtn,budgetlbl,saveBtn,loadBtn].forEach(t=>t&&(t.style.display=e?"":"none")),e||"target"!==selectedPlatformType||(timerMode=!1,deleteMode=!1,setType("bouncy"),timerRow&&(timerRow.style.display="none"))}let tip;function showTip(e,t,n){tip||(tip=document.createElement("div"),tip.style.cssText="position:fixed;pointer-events:none;z-index:9999;background:rgba(0,0,0,.8);color:#fff;padding:4px 6px;border-radius:4px;font:11px system-ui;white-space:nowrap;transform:translate(-50%,-120%)",document.body.appendChild(tip)),tip.textContent=e,tip.style.left=t+"px",tip.style.top=n+"px",tip.hidden=!1}function hideTip(){tip&&(tip.hidden=!0)}seedLevelsIfNeeded(),adminToggle&&adminToggle.addEventListener("change",()=>{isAdmin=adminToggle.checked,refreshLevelLocks(),updateAdminUI()}),budgetInput&&budgetInput.addEventListener("input",()=>{levelBudget=Math.max(0,Number(budgetInput.value)||0),updateTotalCost()}),bridgeBtn.onclick=()=>setType("bridge"),bouncyBtn.onclick=()=>setType("bouncy"),targetBtn.onclick=()=>setType("target"),timerBtn.onclick=()=>toggleTimerMode(),deleteBtn.onclick=()=>toggleDeleteMode(),saveBtn.onclick=()=>{saveLevel(currentLevel),updateTotalCost()},loadBtn.onclick=()=>{loadLevel(currentLevel),updateTotalCost()},clearBtn.onclick=()=>{if(!isPlaying){if(isAdmin)platforms=[],balls=[],targets=[];else{for(const e of platforms)if("bridge"===e.type)for(const t of e.points)t.timerFromLevel||(t.timer=null,t.costTimer=null);else e.timerStartFromLevel||(e.timerStart=null,e.timerStartCost=null),e.timerEndFromLevel||(e.timerEnd=null,e.timerEndCost=null);balls=balls.filter(e=>e.fromLevel),platforms=platforms.filter(e=>e.fromLevel),targets=targets.filter(e=>e.fromLevel)}updateTotalCost()}},bounceSlider.oninput=()=>{bounceVal.textContent=Number(bounceSlider.value).toFixed(2)},tensionSlider.oninput=()=>{tensionVal.textContent=Number(tensionSlider.value).toFixed(1)},timerSlider.oninput=()=>{timerSeconds=Number(timerSlider.value),timerVal.textContent=timerSeconds.toFixed(1)+"s"},playBtn.onclick=()=>{isPlaying?(loadLevel(currentLevel),setPlayingState(!1),updateTotalCost()):(saveLevel(currentLevel),setPlayingState(!0),levelCompleted=!1,overBudgetOnWin=!1,resetTargetTimers?.())},levelSelect.addEventListener("change",()=>{isPlaying||(currentLevel=Number(levelSelect.value)||1,loadLevel(currentLevel),setPlayingState(!1),updateAdminToggleVisibility(),updateTotalCost?.())}),canvas.addEventListener("mouseleave",hideTip);const MAX_LEVELS=13,SANDBOX_LEVEL=14;function loadCompletedMap(){try{return JSON.parse(localStorage.getItem("physicsCompleted")||"{}")||{}}catch{return{}}}function saveCompletedMap(e){localStorage.setItem("physicsCompleted",JSON.stringify(e))}function isLevelCompleted(e){return!!loadCompletedMap()[e]}function setLevelCompleted(e,t=!0){const n=loadCompletedMap();t?n[e]=!0:delete n[e],saveCompletedMap(n)}function highestSequentialCompleted(){const e=loadCompletedMap();let t=0;for(let n=1;n<=MAX_LEVELS&&e[n];n++)t=n;return t}function refreshLevelLocks(){const e=highestSequentialCompleted(),t=isAdmin||e>=MAX_LEVELS,n=isAdmin?1/0:Math.min(MAX_LEVELS,e+1),l=levelSelect?.options||[];for(let e=0;e<l.length;e++){const o=Number(l[e].value),i=o===SANDBOX_LEVEL,s=i?!t:!isAdmin&&o>n;l[e].disabled=s;const r=i?"Sandbox":`Level ${o}`;l[e].textContent=s?`${r} (locked)`:r}if(!isAdmin){const e=Number(levelSelect.value);if(e===SANDBOX_LEVEL?!t:e>n){const e=Math.max(1,Math.min(MAX_LEVELS,n));levelSelect.value=String(e),currentLevel=e,loadLevel(currentLevel)}}updateAdminToggleVisibility(),updateAdminUI()}function updateAdminUI(){const e=isAdmin||currentLevel===SANDBOX_LEVEL;[targetBtn,budgetlbl,saveBtn,loadBtn].forEach(t=>t&&(t.style.display=e?"":"none")),e||"target"!==selectedPlatformType||(timerMode=!1,deleteMode=!1,setType("bouncy"),timerRow&&(timerRow.style.display="none"))}function setPlayingState(e){if(playBtn.textContent=e?"Stop":"Play",levelCompleted=!1,overBudgetOnWin=!1,budgetInput&&(budgetInput.disabled=e),isPlaying=e,timersRunning=e,[bridgeBtn,bouncyBtn,targetBtn,timerBtn,deleteBtn,saveBtn,loadBtn,clearBtn,levelSelect,adminToggle].forEach(t=>{t&&(t.disabled=e)}),[bounceSlider,tensionSlider,timerSlider].forEach(t=>{t&&(t.disabled=e)}),e?(bouncyRow.style.display="none",timerRow.style.display="none",highlightSelectedButton("playBtn")):(highlightSelectedButton(selectedPlatformType+"Button"),bouncyRow.style.display="bouncy"===selectedPlatformType?"block":"none",timerMode&&(timerRow.style.display="block")),e||refreshLevelLocks(),e){for(const e of platforms)"bridge"!==e.type&&(!((e.tension||0)>0)||e.releasing||e.isFixedStart&&e.isFixedEnd||triggerTensionRelease(e));bouncyRow.style.display="none",timerRow.style.display="none",highlightSelectedButton("playBtn")}else highlightSelectedButton(selectedPlatformType+"Button"),bouncyRow.style.display="bouncy"===selectedPlatformType?"block":"none",timerMode&&(timerRow.style.display="block");e||refreshLevelLocks()}function worldToScreen(e,t){return{x:e*view.scale+view.offX,y:t*view.scale+view.offY}}function setType(e){isPlaying||(selectedPlatformType=e,timerMode=!1,deleteMode=!1,highlightSelectedButton(e+"Button"),bouncyRow.style.display="bouncy"===e?"block":"none",timerRow.style.display="none")}function toggleTimerMode(){isPlaying||(deleteMode=!1,timerMode=!timerMode,timerMode?(highlightSelectedButton("timerButton"),bouncyRow.style.display="none",timerRow.style.display="block"):(highlightSelectedButton(selectedPlatformType+"Button"),timerRow.style.display="none",bouncyRow.style.display="bouncy"===selectedPlatformType?"block":"none"))}function toggleDeleteMode(){isPlaying||(timerMode=!1,deleteMode=!deleteMode,deleteMode?(highlightSelectedButton("deleteButton"),bouncyRow.style.display="none",timerRow.style.display="none"):(highlightSelectedButton(selectedPlatformType+"Button"),bouncyRow.style.display="bouncy"===selectedPlatformType?"block":"none"))}function highlightSelectedButton(e){document.querySelectorAll(".controls .row:first-child button, #timerRow button").forEach(e=>e.style.backgroundColor="");const t=document.getElementById(e);t&&(t.style.backgroundColor="#ccc")}function setPlatformFromEndpoints(e,t,n,l,o){const i=Math.atan2(o-n,l-t),s=clamp(Math.hypot(l-t,o-n),30,300);Object.assign(e,{x:t,y:n,length:s,angle:i,endX:t+s*Math.cos(i),endY:n+s*Math.sin(i),costLength:s})}function toggleAnchor(e,t){!isAdmin&&e?.fromLevel||("start"===t?(e.isFixedStart=!e.isFixedStart,e.isFixedStart||triggerTensionRelease(e)):(e.isFixedEnd=!e.isFixedEnd,e.isFixedEnd||triggerTensionRelease(e)),updateTotalCost())}function tryDeleteAt(e,t){for(let n=balls.length-1;n>=0;n--){const l=balls[n];if(Math.hypot(e-l.x,t-l.y)<=l.radius){if(l.fromLevel&&!isAdmin)continue;return balls.splice(n,1),!0}}for(let n=targets.length-1;n>=0;n--){const l=targets[n];if(Math.hypot(e-l.x,t-l.y)<=l.radius){if(l.fromLevel&&!isAdmin)continue;return targets.splice(n,1),!0}}for(let n=platforms.length-1;n>=0;n--){const l=platforms[n];if(!l.fromLevel||isAdmin)if("bridge"===l.type){for(let o=0;o<l.points.length;o++){const i=l.points[o];if(Math.hypot(e-i.x,t-i.y)<7)return platforms.splice(n,1),!0}for(let o=0;o<l.points.length-1;o++){const i=l.points[o],s=l.points[o+1],r=closestPointOnSegment(e,t,i.x,i.y,s.x,s.y);if(Math.hypot(e-r.x,t-r.y)<5)return platforms.splice(n,1),!0}}else{const o=l.x,i=l.y,s=l.x+l.length*Math.cos(l.angle),r=l.y+l.length*Math.sin(l.angle);if(Math.hypot(e-o,t-i)<7||Math.hypot(e-s,t-r)<7)return platforms.splice(n,1),!0;const a=pointToLineDistance(e,t,o,i,s,r),c=projectPointOntoLine(e,t,o,i,s,r),d=Math.hypot(c.x-o,c.y-i);if(a<l.thickness/2&&d>0&&d<l.length)return platforms.splice(n,1),!0}}return!1}function tryArmTimerAt(e,t,n){for(const l of platforms)if("bridge"!==l.type){const o=l.x,i=l.y,s=l.x+l.length*Math.cos(l.angle),r=l.y+l.length*Math.sin(l.angle);if(Math.hypot(e-o,t-i)<7&&l.isFixedStart)return l.timerStartFromLevel=!1,l.timerStart=n,l.timerStartCost=n,!0;if(Math.hypot(e-s,t-r)<7&&l.isFixedEnd)return l.timerEndFromLevel=!1,l.timerEnd=n,l.timerEndCost=n,!0}for(const l of platforms)if("bridge"===l.type)for(let o=0;o<l.points.length;o++){const i=l.points[o];if(Math.hypot(e-i.x,t-i.y)<7)return i.timerFromLevel=!1,i.timer=n,i.costTimer=n,!0}return!1}function triggerTensionRelease(e){if(!e||"bridge"===e.type||e.releasing)return;const t=Math.max(0,e.tension||0);if(!t)return;const n=e.costLength||e.length;e.releasing=!0,e.targetLength=n*(1+Math.min(2,t)),e.releaseSpeed=150*t}function findNearestFixedPoint(e,t,n){let l=null,o=n+1;for(const i of platforms)if("bridge"===i.type){for(const s of i.points)if(s.isFixed){const i=Math.hypot(e-s.x,t-s.y);i<=n&&i<o&&(o=i,l=s)}}else{const s=i.x,r=i.y,a=i.x+i.length*Math.cos(i.angle),c=i.y+i.length*Math.sin(i.angle);if(i.isFixedStart){const i=Math.hypot(e-s,t-r);i<=n&&i<o&&(o=i,l={x:s,y:r})}if(i.isFixedEnd){const i=Math.hypot(e-a,t-c);i<=n&&i<o&&(o=i,l={x:a,y:c})}}return l}function bounceToColor(e){const t=Math.max(0,Math.min(1,e/1.2));return`rgb(${Math.round(255*t)},0,0)`}function tensionToColor(e){return`rgba(255,165,0,${.15+.85*Math.max(0,Math.min(1,e/2))})`}function drawLockAt(e,t){isAdmin||(ctx.save(),ctx.beginPath(),ctx.rect(e-6,t-4,12,8),ctx.fillStyle="rgba(0,0,0,0.55)",ctx.fill(),ctx.beginPath(),ctx.arc(e,t-4,6,Math.PI,0),ctx.strokeStyle="rgba(0,0,0,0.55)",ctx.lineWidth=2,ctx.stroke(),ctx.restore())}function drawBalls(){for(const e of balls)drawYarnBall(e,{hue:e.yarnHue})}function drawTargets(){targets.forEach(e=>{if(ctx.beginPath(),ctx.arc(e.x,e.y,e.radius,0,2*Math.PI),ctx.fillStyle=e.done?"rgba(0,200,0,0.18)":"rgba(0,120,255,0.18)",ctx.fill(),ctx.lineWidth=2,ctx.strokeStyle=e.done?"#2fa84a":"#2e7bdc",ctx.stroke(),isPlaying&&!levelCompleted&&!e.done){const t=Math.max(0,Math.min(1,(e.insideAccum||0)/(e.required||3)));t>0&&(ctx.beginPath(),ctx.lineWidth=4,ctx.strokeStyle=e.done?"#2fa84a":"#1a5fb4",ctx.arc(e.x,e.y,e.radius+6,-Math.PI/2,-Math.PI/2+2*t*Math.PI),ctx.stroke())}e.done&&(ctx.save(),ctx.strokeStyle="#2fa84a",ctx.lineWidth=4,ctx.beginPath(),ctx.moveTo(e.x-8,e.y+2),ctx.lineTo(e.x-2,e.y+8),ctx.lineTo(e.x+10,e.y-6),ctx.stroke(),ctx.restore()),e.fromLevel&&!isAdmin&&drawLockAt(e.x,e.y-e.radius-8)})}function drawPlatforms(){platforms.forEach(e=>{if("bridge"===e.type)return void drawBridgePlatform(e);ctx.save(),ctx.translate(e.x,e.y),ctx.rotate(e.angle),ctx.fillStyle=bounceToColor(e.bounce||0),ctx.fillRect(0,-e.thickness/2,e.length,e.thickness),(e.tension||0)>0&&(ctx.lineWidth=3,ctx.strokeStyle=tensionToColor(e.tension||0),ctx.strokeRect(0,-e.thickness/2,e.length,e.thickness));const t=(e.bounce||0).toFixed(2),n=Math.cos(e.angle)<0;ctx.save(),ctx.font="12px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.translate(e.length/2,0),n&&ctx.rotate(Math.PI),ctx.lineWidth=3,ctx.strokeStyle="black",ctx.strokeText(t,0,0),ctx.fillStyle="white",ctx.fillText(t,0,0),ctx.restore(),drawEndpoint(0,0,e.isFixedStart,e.timerStart),drawEndpoint(e.length,0,e.isFixedEnd,e.timerEnd),ctx.restore(),e.fromLevel&&!isAdmin&&drawLockAt(e.x+e.length/2*Math.cos(e.angle),e.y+e.length/2*Math.sin(e.angle)-14)})}function drawEndpoint(e,t,n,l){ctx.beginPath(),ctx.arc(e,t,7,0,2*Math.PI),ctx.fillStyle=n?"blue":"green",ctx.fill(),ctx.closePath(),l&&l>0&&(ctx.beginPath(),ctx.arc(e,t,10,0,2*Math.PI),ctx.strokeStyle="orange",ctx.lineWidth=2,ctx.stroke(),ctx.font="10px Arial",ctx.fillStyle="orange",ctx.textAlign="center",ctx.textBaseline="top",ctx.fillText(l.toFixed(1),e,t+7+4))}function drawBridgePlatform(e){if(ctx.beginPath(),e.points.forEach((e,t)=>{0===t?ctx.moveTo(e.x,e.y):ctx.lineTo(e.x,e.y)}),ctx.strokeStyle="#444",ctx.lineWidth=10,ctx.lineCap="butt",ctx.stroke(),e.points.forEach((t,n)=>{ctx.beginPath(),ctx.arc(t.x,t.y,7,0,2*Math.PI);const l=0===n||n===e.points.length-1;ctx.fillStyle=l?"blue":"pink",ctx.fill(),ctx.closePath(),t.timer&&t.timer>0&&(ctx.beginPath(),ctx.arc(t.x,t.y,10,0,2*Math.PI),ctx.strokeStyle="orange",ctx.lineWidth=2,ctx.stroke(),ctx.font="10px Arial",ctx.fillStyle="orange",ctx.textAlign="center",ctx.textBaseline="top",ctx.fillText(t.timer.toFixed(1),t.x,t.y+7+4))}),e.fromLevel&&!isAdmin){const t=Math.floor(e.points.length/2);drawLockAt(e.points[t].x,e.points[t].y-18)}}function drawPlatformPreview(){if(!isCreatingPlatform||timerMode||deleteMode||isPlaying)return;const e=findNearestFixedPoint(mouse.startX,mouse.startY,15),t=e?e.x:mouse.startX,n=e?e.y:mouse.startY;let l=mouse.x,o=mouse.y,i=l-t,s=o-n;keys.shift&&(Math.abs(i)>=Math.abs(s)?(s=0,o=n):(i=0,l=t));const r=findNearestFixedPoint(l,o,15);r&&(l=r.x,o=r.y);let a=Math.hypot(l-t,o-n),c=Math.atan2(o-n,l-t);if("bridge"===selectedPlatformType){a>300&&(a=300);const e=60,l=Math.ceil(a/e),o=a/l;for(let e=0;e<l;e++){const i=t+e*o*Math.cos(c),s=n+e*o*Math.sin(c),r=i+o*Math.cos(c),a=s+o*Math.sin(c);ctx.beginPath(),ctx.moveTo(i,s),ctx.lineTo(r,a),ctx.strokeStyle="gray",ctx.lineWidth=10,ctx.stroke(),0===e?drawEndpoint(i,s,!0):(ctx.beginPath(),ctx.arc(i,s,7,0,2*Math.PI),ctx.fillStyle="pink",ctx.fill(),ctx.closePath()),e===l-1?drawEndpoint(r,a,!0):(ctx.beginPath(),ctx.arc(r,a,7,0,2*Math.PI),ctx.fillStyle="pink",ctx.fill(),ctx.closePath())}}else if("bouncy"===selectedPlatformType){a>300&&(a=300);const e=t+a*Math.cos(c),l=n+a*Math.sin(c);ctx.beginPath(),ctx.moveTo(t,n),ctx.lineTo(e,l),ctx.strokeStyle="gray",ctx.lineWidth=10,ctx.stroke(),drawEndpoint(t,n,!0),drawEndpoint(e,l,!0)}ctx.save(),ctx.lineWidth=2,ctx.strokeStyle="gold",e&&(ctx.beginPath(),ctx.arc(t,n,12,0,2*Math.PI),ctx.stroke()),r&&(ctx.beginPath(),ctx.arc(l,o,12,0,2*Math.PI),ctx.stroke()),ctx.restore(),ctx.font="12px Arial",ctx.textAlign="left",ctx.textBaseline="bottom",ctx.fillStyle=a<30&&"bouncy"===selectedPlatformType?"red":"green",ctx.fillText(`${Math.round(a)} px`,mouse.x+10,mouse.y-10)}function drawTargetPreview(){isPlaying||timerMode||deleteMode||"target"===selectedPlatformType&&(ctx.beginPath(),ctx.arc(mouse.x,mouse.y,36,0,2*Math.PI),ctx.fillStyle="rgba(0,120,255,0.12)",ctx.fill(),ctx.lineWidth=2,ctx.strokeStyle="#2e7bdc",ctx.setLineDash([6,6]),ctx.stroke(),ctx.setLineDash([]))}function drawWinOverlay(){if(!levelCompleted)return;resetTransform();const e=overBudgetOnWin?"OVER BUDGET":"COMPLETED!",t=overBudgetOnWin?"Press Stop to edit and try again":"Press Stop to reset / edit / level select",n=JSON.parse(localStorage.getItem("rc")||"{}"),l=["SCOREBOARD"];for(let e=1;e<=MAX_LEVELS;e++)l.push(`Level ${e}: `+(null!=n[e]?`£${n[e]}`:"Incomplete"));const o=canvas.width/2;let i=canvas.height/4;ctx.save(),ctx.fillStyle="rgba(0,0,0,0.4)",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle="#fff",ctx.textAlign="center",ctx.textBaseline="middle",ctx.font="bold 48px Arial",ctx.fillText(e,o,i),ctx.font="20px Arial",i+=48,ctx.fillText(t,o,i),i+=30,ctx.font="16px system-ui, Arial";for(const e of l)i+=22,ctx.fillText(e,o,i);ctx.restore(),setWorldTransform()}function updateBalls(){balls.forEach(e=>{if(e.isDragging)return;e.vy+=.5*scale,e.x+=e.vx*scale,e.y+=e.vy*scale;const t=Math.hypot(e.vx,e.vy);if(t>50){const n=50/t;e.vx*=n,e.vy*=n}const n=Math.pow(.99,scale);e.vx*=n,e.vy*=n;const l=Math.hypot(e.vx,e.vy),o=Math.sign(e.vx)||1;e.rotation+=l/e.radius*o*scale,e.y+e.radius>VIRT_H&&(e.y=VIRT_H-e.radius,e.vy*=-.7),e.x+e.radius>VIRT_W&&(e.x=VIRT_W-e.radius,e.vx*=-.7),e.x-e.radius<0&&(e.x=e.radius,e.vx*=-.7),e.y-e.radius<0&&(e.y=e.radius,e.vy*=-.7),platforms.forEach(t=>{platformCollision(e,t)&&resolveBallVsPlatform(e,t)})})}function updatePlatforms(){for(const e of platforms)"bridge"!==e.type&&(e.prevAngle=e.angle,e.prevX=e.x,e.prevY=e.y,e.prevLen=e.length);for(let e=0;e<platforms.length;e++){const t=platforms[e];if("bridge"===t.type){let n=!1;for(let l=0;l<t.points.length;l++){const o=t.points[l];if(o.timer&&o.timer>0&&(timersRunning&&(o.timer-=dt),o.timer<=0))if(o.timer=null,0===l||l===t.points.length-1)o.isFixed=!1;else{const o=t.points.slice(0,l),i=t.points.slice(l+1);o.length>=2&&(o[0].isFixed=!0,o[o.length-1].isFixed=!1,platforms.push({type:"bridge",points:o,segmentLength:t.segmentLength,costLength:t.segmentLength*(o.length-1),fromLevel:t.fromLevel||isAdmin})),i.length>=2&&(i[0].isFixed=!1,i[i.length-1].isFixed=!0,platforms.push({type:"bridge",points:i,segmentLength:t.segmentLength,costLength:t.segmentLength*(i.length-1),fromLevel:t.fromLevel||isAdmin})),platforms.splice(e,1),n=!0,emitImpactSparks(t.points[l].x,t.points[l].y,0,-1,.5)}if(n)break}if(n){e--;continue}updateBridgePlatform(t);continue}if(t.timerStart&&t.timerStart>0&&(timersRunning&&(t.timerStart-=dt),t.timerStart<=0&&(t.timerStart=null,t.isFixedStart=!1,triggerTensionRelease(t))),t.timerEnd&&t.timerEnd>0&&(timersRunning&&(t.timerEnd-=dt),t.timerEnd<=0&&(t.timerEnd=null,t.isFixedEnd=!1,triggerTensionRelease(t))),t.expansionRateFE=0,t.releasing&&(t.length,t.length+=t.releaseSpeed*dt,t.length>=t.targetLength&&(t.length=t.targetLength,t.releasing=!1),t.isFixedStart&&!t.isFixedEnd?(t.endX=t.x+t.length*Math.cos(t.angle),t.endY=t.y+t.length*Math.sin(t.angle)):!t.isFixedStart&&t.isFixedEnd?(t.x=t.endX-t.length*Math.cos(t.angle),t.y=t.endY-t.length*Math.sin(t.angle)):(t.endX=t.x+t.length*Math.cos(t.angle),t.endY=t.y+t.length*Math.sin(t.angle)),t.releaseSpeed=10*(t.tension||0)*60),!t.isFixedStart&&!t.isFixedEnd){t.y+=(t.vy||0)*scale,t.x+=(t.vx||0)*scale,t.vy=t.vy||0,t.vy+=.5*scale;continue}const n=.95,l=.005,o=Math.pow(n,scale),i=Math.cos(t.angle)*l*scale;t.angularVelocity=t.angularVelocity||0,t.isFixedStart&&!t.isFixedEnd?(t.angularVelocity+=i,t.angularVelocity*=o,t.angle+=t.angularVelocity*scale,t.endX=t.x+t.length*Math.cos(t.angle),t.endY=t.y+t.length*Math.sin(t.angle)):!t.isFixedStart&&t.isFixedEnd&&(t.angularVelocity+=i,t.angularVelocity*=o,t.angle-=t.angularVelocity*scale,t.x=t.endX-t.length*Math.cos(t.angle),t.y=t.endY-t.length*Math.sin(t.angle))}for(let e=0;e<platforms.length;e++){const t=platforms[e];if("bridge"!==t.type)for(let n=e+1;n<platforms.length;n++){const e=platforms[n];if("bridge"===e.type)continue;const l=capsuleHit(t,e);if(!l)continue;const{overlap:o,nx:i,ny:s}=l,r=!!t.isFixedStart^!!t.isFixedEnd,a=!!e.isFixedStart^!!e.isFixedEnd;if(r&&!a)t.angle=t.prevAngle,t.angularVelocity=0,t.x=t.prevX,t.y=t.prevY,t.length=t.prevLen,t.endX=t.x+t.length*Math.cos(t.angle),t.endY=t.y+t.length*Math.sin(t.angle);else if(!r&&a)e.angle=e.prevAngle,e.angularVelocity=0,e.x=e.prevX,e.y=e.prevY,e.length=e.prevLen,e.endX=e.x+e.length*Math.cos(e.angle),e.endY=e.y+e.length*Math.sin(e.angle);else if(r&&a)t.angle=t.prevAngle,t.angularVelocity=0,t.x=t.prevX,t.y=t.prevY,t.length=t.prevLen,t.endX=t.x+t.length*Math.cos(t.angle),t.endY=t.y+t.length*Math.sin(t.angle),e.angle=e.prevAngle,e.angularVelocity=0,e.x=e.prevX,e.y=e.prevY,e.length=e.prevLen,e.endX=e.x+e.length*Math.cos(e.angle),e.endY=e.y+e.length*Math.sin(e.angle);else{const n=o/2;t.x-=i*n,t.y-=s*n,t.endX-=i*n,t.endY-=s*n,t.vx=t.vy=0,t.angularVelocity=0,e.x+=i*n,e.y+=s*n,e.endX+=i*n,e.endY+=s*n,e.vx=e.vy=0,e.angularVelocity=0}}}}function updateBridgePlatform(e){const t=Math.pow(.93,scale);e.points.forEach((n,l)=>{if(n.isFixed||(n.vy+=.5*scale,n.x+=n.vx*scale,n.y+=n.vy*scale,n.vx*=t,n.vy*=t),l>0){const t=e.points[l-1],o=n.x-t.x,i=n.y-t.y,s=Math.hypot(o,i)||1,r=.8*(s-e.segmentLength),a=o/s*r,c=i/s*r;n.isFixed||(n.vx-=a*scale,n.vy-=c*scale),t.isFixed||(t.vx+=a*scale,t.vy+=c*scale)}})}function detectAndResolveBallCollisions(){for(let e=0;e<balls.length;e++)for(let t=e+1;t<balls.length;t++){const n=balls[e],l=balls[t],o=l.x-n.x,i=l.y-n.y,s=Math.hypot(o,i);if(s<n.radius+l.radius){const e=o/s,t=i/s,r=(l.vx-n.vx)*e+(l.vy-n.vy)*t;if(r>0)continue;const a=-2*r/(1/n.mass+1/l.mass),c=a*e,d=a*t;n.vx-=c/n.mass,n.vy-=d/n.mass,l.vx+=c/l.mass,l.vy+=d/l.mass;const m=(n.radius+l.radius-s)/2;n.x-=m*e,n.y-=m*t,l.x+=m*e,l.y+=m*t}}}function resetTargetTimers(){for(const e of targets)e.insideAccum=0,e.required=3,e.done=!1}function updateTargetsAndWinCheck(){if(0!==targets.length){for(const e of targets){if(e.done)continue;let t=!1;for(const n of balls)if(Math.hypot(n.x-e.x,n.y-e.y)+n.radius<=e.radius){t=!0;break}e.insideAccum=t?(e.insideAccum||0)+dt:0,e.insideAccum>=(e.required||3)&&(e.done=!0,e.insideAccum=e.required||3)}if(targets.length>0&&targets.every(e=>e.done)){const e=calcTotalCost(),t=levelBudget>0&&e>levelBudget;if(levelCompleted=!0,overBudgetOnWin=t,timersRunning=!1,t||setLevelCompleted?.(currentLevel,!0),!t){setLevelCompleted?.(currentLevel,!0);const t="rc",n=JSON.parse(localStorage.getItem(t)||"{}");(null==n[currentLevel]||e<n[currentLevel])&&(n[currentLevel]=e,localStorage.setItem(t,JSON.stringify(n)))}refreshLevelLocks?.()}}}function platformCollision(e,t){if("bridge"===t.type){for(let n=0;n<t.points.length-1;n++){const l=t.points[n],o=t.points[n+1],i=closestPointOnSegment(e.x,e.y,l.x,l.y,o.x,o.y);Math.hypot(e.x-i.x,e.y-i.y)<e.radius&&resolveCollisionWithRope(e,l,o,i)}return!1}{const n=closestPointOnPlatform(e.x,e.y,t);return Math.hypot(e.x-n.x,e.y-n.y)<e.radius}}function surfaceVelocityAt(e,t,n){let l=0,o=0;const i=Math.cos(e.angle),s=Math.sin(e.angle);if(e.releasing){const t=e.isFixedStart&&!e.isFixedEnd?1:!e.isFixedStart&&e.isFixedEnd?-1:0,n=(e.releaseSpeed||0)/60;l+=t*n*i,o+=t*n*s}if(!!e.isFixedStart^!!e.isFixedEnd){const i=t-(e.isFixedStart?e.x:e.endX),s=n-(e.isFixedStart?e.y:e.endY),r=e.angularVelocity||0;l+=-r*s,o+=r*i}return l+=e.vx||0,o+=e.vy||0,{vx:l,vy:o}}function resolveBallVsPlatform(e,t){const n=closestPointOnPlatform(e.x,e.y,t),l=e.x-n.x,o=e.y-n.y,i=Math.hypot(l,o)||1,s=l/i,r=o/i,a=surfaceVelocityAt(t,n.x,n.y);let c=e.vx-a.vx,d=e.vy-a.vy;const m=c*s+d*r,x=clamp(Math.abs(Math.min(0,m))/250,0,1.5),g=(t.bounce||0)>=.6?"spark":"dust";x>.02&&emitImpactGeneric(n.x,n.y,s,r,x,g);const u=e.radius-i;u>0&&(e.x+=s*u,e.y+=r*u);const y=Math.cos(t.angle),h=Math.sin(t.angle),f=c*y+d*h;if(!t.isFixedEnd||!t.isFixedStart){const e=.1;t.vx=(t.vx||0)+s*e*Math.sign(c),t.vy=(t.vy||0)+r*e*Math.sign(d);const n=Math.atan2(r,s)-t.angle;t.angularVelocity=(t.angularVelocity||0)-Math.sin(n)*e}if((t.expansionRateFE||0)>0){const e=Math.max(0,t.tension||0),n=Math.min(t.expansionRateFE,250),l=.004*e;c+=s*l*n,d+=r*l*n}const p=c*s+d*r;if((t.bounce||0)>0){const e=t.bounce;c-=(1+e)*p*s,d-=(1+e)*p*r}else c-=p*s,d-=p*r,c=y*f*.99,d=h*f*.99;e.vx=c+a.vx,e.vy=d+a.vy;const v=(e.vx-a.vx)*s+(e.vy-a.vy)*r;v<0&&(e.vx-=v*s,e.vy-=v*r),e.x+=.01*s,e.y+=.01*r}function resolveCollisionWithRope(e,t,n,l){const o=e.x-l.x,i=e.y-l.y,s=Math.hypot(o,i);if(!s)return;const r=o/s,a=i/s,c=e.radius-s;e.x+=r*c,e.y+=a*c;const d=e.vx*r+e.vy*a,m=clamp(Math.abs(Math.min(0,d))/220,0,1.5);m>.02&&emitImpactDust(l.x,l.y,r,a,m);const x=e.vx*r+e.vy*a;e.vx-=1.6*x*r,e.vy-=2*x*a,e.vx*=.9,e.vy*=.9;const g=.03;t.isFixed||(t.vx+=r*g,t.vy+=a*g),n.isFixed||(n.vx+=r*g,n.vy+=a*g)}highlightSelectedButton("bouncyButton"),window.addEventListener("keydown",e=>{"Shift"===e.key&&(keys.shift=!0)}),window.addEventListener("keyup",e=>{"Shift"===e.key&&(keys.shift=!1)}),canvas.addEventListener("mousedown",e=>{if(0!==e.button)return;const{x:t,y:n}=screenToWorld(e.clientX,e.clientY);if(mouse.x=t,mouse.y=n,isPlaying){for(const e of balls)if(Math.hypot(mouse.x-e.x,mouse.y-e.y)<e.radius){if(e.fromLevel&&!isAdmin)continue;return e.isDragging=!0,e.vx=0,void(e.vy=0)}return}if(!timerMode&&!deleteMode&&"target"===selectedPlatformType)return targets.push({x:mouse.x,y:mouse.y,radius:36,insideAccum:0,required:3,fromLevel:newItemFromLevelFlag()}),void updateTotalCost();if(deleteMode)return void(tryDeleteAt(mouse.x,mouse.y)&&updateTotalCost());let l=!1;for(const e of balls)if(Math.hypot(mouse.x-e.x,mouse.y-e.y)<e.radius){e.fromLevel&&!isAdmin?l=!1:(e.isDragging=!0,e.vx=0,e.vy=0,l=!0);break}if(!l)if(timerMode)tryArmTimerAt(mouse.x,mouse.y,timerSeconds)&&updateTotalCost();else{for(let e=platforms.length-1;e>=0;e--){const t=platforms[e];if(t&&"bridge"===t.type&&(!t.fromLevel||isAdmin))for(let n=1;n<t.points.length-1;n++){const l=t.points[n];if(Math.hypot(mouse.x-l.x,mouse.y-l.y)<7){const l=t.points.slice(0,n),o=t.points.slice(n+1);return l.length>=2&&(l[0].isFixed=!0,l[l.length-1].isFixed=!1,platforms.push({type:"bridge",points:l,segmentLength:t.segmentLength,costLength:t.segmentLength*(l.length-1),fromLevel:t.fromLevel||isAdmin})),o.length>=2&&(o[0].isFixed=!1,o[o.length-1].isFixed=!0,platforms.push({type:"bridge",points:o,segmentLength:t.segmentLength,costLength:t.segmentLength*(o.length-1),fromLevel:t.fromLevel||isAdmin})),platforms.splice(e,1),void updateTotalCost()}}}for(const e of platforms){if("bridge"===e.type)continue;const t=e.x,n=e.y,l=e.x+e.length*Math.cos(e.angle),o=e.y+e.length*Math.sin(e.angle),i=Math.hypot(mouse.x-t,mouse.y-n)<7,s=Math.hypot(mouse.x-l,mouse.y-o)<7;if(i||s){if(e.fromLevel&&!isAdmin)continue;return editing.platform=e,editing.which=i?"start":"end",editing.startMx=mouse.x,editing.startMy=mouse.y,editing.moved=!1,void(i?(editing.otherX=l,editing.otherY=o):(editing.otherX=t,editing.otherY=n))}}platforms.forEach(e=>{if("bridge"===e.type)return;if(e.fromLevel&&!isAdmin)return;const t=e.x,n=e.y,l=e.x+e.length*Math.cos(e.angle),o=e.y+e.length*Math.sin(e.angle),i=pointToLineDistance(mouse.x,mouse.y,t,n,l,o),s=projectPointOntoLine(mouse.x,mouse.y,t,n,l,o),r=Math.hypot(s.x-t,s.y-n);i<e.thickness/2&&r>20&&r<e.length-20&&(draggedPlatform=e,mouse.startX=mouse.x-e.x,mouse.startY=mouse.y-e.y)}),draggedPlatform||(mouse.isDown=!0,mouse.startX=mouse.x,mouse.startY=mouse.y,isCreatingPlatform=!0)}}),canvas.addEventListener("mousemove",e=>{const{x:t,y:n}=screenToWorld(e.clientX,e.clientY);mouse.x=t,mouse.y=n;let l=!1;if(!(isPlaying||timerMode||deleteMode||draggedPlatform||editing.platform))for(const e of platforms){if("bridge"===e.type)continue;const t=e.x,n=e.y,o=e.x+e.length*Math.cos(e.angle),i=e.y+e.length*Math.sin(e.angle),s=11;if(Math.hypot(mouse.x-t,mouse.y-n)<s){const o=worldToScreen(t,n);showTip("Drag to resize • Click to "+(e.isFixedStart?"unpin":"pin"),o.x,o.y),l=!0;break}if(Math.hypot(mouse.x-o,mouse.y-i)<s){const t=worldToScreen(o,i);showTip("Drag to resize • Click to "+(e.isFixedEnd?"unpin":"pin"),t.x,t.y),l=!0;break}}if(l||hideTip(),balls.forEach(e=>{e.isDragging&&(e.x=mouse.x,e.y=mouse.y)}),draggedPlatform&&(draggedPlatform.x=mouse.x-mouse.startX,draggedPlatform.y=mouse.y-mouse.startY),editing.platform){const e=editing.platform;!editing.moved&&Math.hypot(mouse.x-editing.startMx,mouse.y-editing.startMy)>3&&(editing.moved=!0);let t=mouse.x,n=mouse.y;const l=t-editing.otherX,o=n-editing.otherY;keys.shift&&(Math.abs(l)>=Math.abs(o)?n=editing.otherY:t=editing.otherX);const i=findNearestFixedPoint(t,n,15);i&&(t=i.x,n=i.y),"start"===editing.which?setPlatformFromEndpoints(e,t,n,editing.otherX,editing.otherY):setPlatformFromEndpoints(e,editing.otherX,editing.otherY,t,n),updateTotalCost()}}),canvas.addEventListener("mouseup",e=>{if(0===e.button){if(editing.platform){const e=editing.platform,t=editing.which,n=editing.moved;return editing.platform=null,editing.which=null,editing.moved=!1,n||toggleAnchor(e,t),void updateTotalCost()}if(balls.forEach(e=>e.isDragging=!1),draggedPlatform=null,!isPlaying){if(isCreatingPlatform){const e=findNearestFixedPoint(mouse.startX,mouse.startY,15),t=e?e.x:mouse.startX,n=e?e.y:mouse.startY;let l=mouse.x,o=mouse.y,i=l-t,s=o-n;keys.shift&&(Math.abs(i)>=Math.abs(s)?(s=0,o=n):(i=0,l=t));const r=findNearestFixedPoint(l,o,15);r&&(l=r.x,o=r.y);let a=Math.hypot(l-t,o-n);const c=Math.atan2(o-n,l-t);if("bridge"===selectedPlatformType){a>300&&(a=300);const e=Math.max(6,Math.ceil(a/20)),l=a/(e-1),o=[];for(let i=0;i<e;i++){const s=t+i*l*Math.cos(c),r=n+i*l*Math.sin(c);o.push({x:s,y:r,vx:0,vy:0,isFixed:0===i||i===e-1,timer:null,costTimer:null,timerFromLevel:!1})}platforms.push({type:"bridge",points:o,segmentLength:l,costLength:a,fromLevel:newItemFromLevelFlag()})}else if("bouncy"===selectedPlatformType){if(a<30)return isCreatingPlatform=!1,void(mouse.isDown=!1);a>300&&(a=300);const e={type:"bouncy",x:t,y:n,length:a,angle:c,thickness:10,bounce:Number(bounceSlider.value),tension:Number(tensionSlider.value)||0,isFixedStart:!0,isFixedEnd:!0,angularVelocity:0,endX:t+a*Math.cos(c),endY:n+a*Math.sin(c),timerStart:null,timerEnd:null,timerStartCost:null,timerEndCost:null,timerStartFromLevel:!1,timerEndFromLevel:!1,costLength:a,releasing:!1,targetLength:null,releaseSpeed:0,expansionRateFE:0,fromLevel:newItemFromLevelFlag()};platforms.push(e)}isCreatingPlatform=!1,updateTotalCost()}mouse.isDown=!1}}}),canvas.addEventListener("contextmenu",e=>{if(e.preventDefault(),isPlaying)return;const{x:t,y:n}=screenToWorld(e.clientX,e.clientY);balls.push({x:t,y:n,radius:20,vx:0,vy:0,mass:1,isDragging:!1,rotation:0,fromLevel:newItemFromLevelFlag()}),updateTotalCost()});const lineEnd=e=>[e.x,e.y,e.x+e.length*Math.cos(e.angle),e.y+e.length*Math.sin(e.angle)];function closestPointOnPlatform(e,t,n){const[l,o,i,s]=lineEnd(n);return closestPointOnSegment(e,t,l,o,i,s)}function closestPointOnSegment(e,t,n,l,o,i){const s=o-n,r=i-l,a=s*s+r*r;let c=0!==a?((e-n)*s+(t-l)*r)/a:-1;return c<0&&(c=0),c>1&&(c=1),{x:n+c*s,y:l+c*r}}function pointToLineDistance(e,t,n,l,o,i){const s=closestPointOnSegment(e,t,n,l,o,i);return Math.hypot(e-s.x,t-s.y)}function projectPointOntoLine(e,t,n,l,o,i){const s=o-n,r=i-l,a=s*s+r*r;if(0===a)return{x:n,y:l,t:0};let c=((e-n)*s+(t-l)*r)/a;return c<0?c=0:c>1&&(c=1),{x:n+c*s,y:l+c*r,t:c}}function platformsOverlap(e,t){return linesIntersect(e.x,e.y,e.x+e.length*Math.cos(e.angle),e.y+e.length*Math.sin(e.angle),t.x,t.y,t.x+t.length*Math.cos(t.angle),t.y+t.length*Math.sin(t.angle))}function linesIntersect(e,t,n,l,o,i,s,r){const a=(e-n)*(i-r)-(t-l)*(o-s);if(0===a)return!1;const c=((e-o)*(i-r)-(t-i)*(o-s))/a,d=-((e-n)*(t-i)-(t-l)*(e-o))/a;return c>=0&&c<=1&&d>=0&&d<=1}function platformEndpoints(e){return{sx:e.x,sy:e.y,ex:e.x+e.length*Math.cos(e.angle),ey:e.y+e.length*Math.sin(e.angle)}}function closestPointsBetweenSegments(e,t,n,l,o,i,s,r){const a=n-e,c=l-t,d=s-o,m=r-i,x=e-o,g=t-i,u=a*a+c*c,y=a*d+c*m,h=d*d+m*m,f=a*x+c*g,p=d*x+m*g,v=u*h-y*y;let L,b,S,M,E=v,T=v;const P=1e-6;v<P?(b=0,E=1,M=p,T=h):(b=y*p-h*f,M=u*p-y*f,b<0?(b=0,M=p,T=h):b>E&&(b=E,M=p+y,T=h)),M<0?(M=0,-f<0?b=0:-f>u?b=E:(b=-f,E=u)):M>T&&(M=T,-f+y<0?b=0:-f+y>u?b=E:(b=-f+y,E=u)),L=Math.abs(b)<P?0:b/E,S=Math.abs(M)<P?0:M/T;const w=e+L*a,F=t+L*c,C=o+S*d,k=i+S*m,B=C-w,I=k-F,A=Math.hypot(B,I);return{paX:w,paY:F,pbX:C,pbY:k,dist:A,nx:A>0?B/A:0,ny:A>0?I/A:0}}function capsuleHit(e,t){const n=platformEndpoints(e),l=platformEndpoints(t),o=closestPointsBetweenSegments(n.sx,n.sy,n.ex,n.ey,l.sx,l.sy,l.ex,l.ey),i=(e.thickness||10)/2+(t.thickness||10)/2;return o.dist<i?{overlap:i-o.dist,nx:o.nx,ny:o.ny}:null}function saveLevel(e){const t=Math.max(1,Number(e)||1),n={budget:levelBudget,balls:balls.map(e=>({x:e.x,y:e.y,fromLevel:!!e.fromLevel})),targets:(targets||[]).map(e=>({x:e.x,y:e.y,radius:e.radius,fromLevel:!!e.fromLevel})),platforms:platforms.map(e=>"bridge"===e.type?{type:e.type,segmentLength:e.segmentLength,costLength:e.costLength||e.segmentLength*(e.points.length-1),points:e.points.map(e=>({x:e.x,y:e.y,isFixed:!!e.isFixed,timer:e.timer??null,costTimer:e.costTimer??null})),fromLevel:!!e.fromLevel}:{type:"bouncy",x:e.x,y:e.y,length:e.length,angle:e.angle,thickness:e.thickness||10,bounce:e.bounce||0,tension:e.tension||0,isFixedStart:!!e.isFixedStart,isFixedEnd:!!e.isFixedEnd,timerStart:e.timerStart??null,timerEnd:e.timerEnd??null,timerStartCost:e.timerStartCost??null,timerEndCost:e.timerEndCost??null,costLength:e.costLength??e.length,fromLevel:!!e.fromLevel})};localStorage.setItem(`physicsLevel_${t}`,JSON.stringify(n,(e,t)=>"number"==typeof t?+t.toFixed(2):t))}function loadLevel(e){const t=Math.max(1,Number(e)||1),n=`physicsLevel_${t}`;let l=null;const o=localStorage.getItem(n);if(o)try{l=JSON.parse(o)}catch(e){console.warn("Bad JSON in",n,e)}if(!l&&window.LEVELS&&Array.isArray(window.LEVELS)&&window.LEVELS[t-1]&&(l=window.LEVELS[t-1]),!l){const t=localStorage.getItem("physicsLevel");if(t)try{l=JSON.parse(t)}catch(e){console.warn("Bad JSON in physicsLevel",e)}}return l?(levelBudget=Math.max(0,Number(l.budget)||0),budgetInput&&(budgetInput.value=String(levelBudget)),balls=(l.balls||[]).map(e=>({x:e.x,y:e.y,radius:20,vx:0,vy:0,mass:1,isDragging:!1,rotation:0,fromLevel:e.fromLevel??!0})),targets=(l.targets||[]).map(e=>({x:e.x,y:e.y,radius:e.radius??36,insideAccum:0,required:3,fromLevel:e.fromLevel??!0,done:!1})),platforms=(l.platforms||[]).map(e=>{if("bridge"===e.type)return{type:"bridge",points:(e.points||[]).map(e=>({x:e.x,y:e.y,vx:0,vy:0,isFixed:!!e.isFixed,timer:e.timer??null,costTimer:e.costTimer??null,timerFromLevel:null!=(e.timer??null)})),segmentLength:e.segmentLength,costLength:e.costLength??e.segmentLength*(e.points.length-1),fromLevel:e.fromLevel??!0};const t=e.length,n=e.angle,l=e.x,o=e.y;return{type:"bouncy",timerStart:e.timerStart??null,timerEnd:e.timerEnd??null,timerStartFromLevel:null!=(e.timerStart??null),timerEndFromLevel:null!=(e.timerEnd??null),x:l,y:o,length:t,angle:n,thickness:e.thickness??10,bounce:e.bounce??0,tension:e.tension??0,isFixedStart:!!e.isFixedStart,isFixedEnd:!!e.isFixedEnd,angularVelocity:0,endX:l+t*Math.cos(n),endY:o+t*Math.sin(n),timerStart:e.timerStart??null,timerEnd:e.timerEnd??null,timerStartCost:e.timerStartCost??null,timerEndCost:e.timerEndCost??null,costLength:e.costLength??t,releasing:!1,targetLength:null,releaseSpeed:0,expansionRateFE:0,fromLevel:e.fromLevel??!0}}),levelBeaten=!1,timersRunning=isPlaying,updateTotalCost?.(),!0):(balls=[{x:100,y:100,radius:20,vx:0,vy:0,mass:1,isDragging:!1,rotation:0,fromLevel:!1}],platforms=[],targets=[],levelBeaten=!1,levelCompleted=!1,overBudgetOnWin=!1,timersRunning=isPlaying,updateTotalCost?.(),!1)}function calcPlatformCost(e){if(e.fromLevel)return 0;if("bridge"===e.type){let t=(e.costLength||e.segmentLength*(e.points.length-1))*COST.bridgePerPx;for(const n of e.points)t+=(n.costTimer||0)*COST.timerPerSecond;return t}{const t=e.costLength||e.length||0;let n=COST.platformBase+t*COST.platformPerPx;return n+=(e.bounce||0)*COST.bouncePerUnit,n+=(e.tension||0)*COST.tensionPerUnit,n+=((e.timerStartCost||0)+(e.timerEndCost||0))*COST.timerPerSecond,n}}function calcTotalCost(){let e=0;e+=balls.filter(e=>!e.fromLevel).length*COST.ball,e+=targets.filter(e=>!e.fromLevel).length*COST.target;for(const t of platforms)t.fromLevel||(e+=calcPlatformCost(t));return Math.round(e)}function updateTotalCost(){const e=calcTotalCost(),t=levelBudget>0&&e>levelBudget;totalCostEl.textContent=levelBudget>0?`Budget: £${e} / £${levelBudget}`:`Budget: £${e}`,totalCostEl.classList.toggle("over",t)}function simulate(e){updateParticles(e);let t=0;for(const e of balls){const n=Math.hypot(e.vx,e.vy);n>t&&(t=n)}const n=Math.max(2,.4*(balls[0]?.radius||20)),l=Math.max(1,Math.ceil(t*e/n)),o=e/l;for(let e=0;e<l;e++)scale=60*o,updatePlatforms(),updateBalls(),detectAndResolveBallCollisions(),updateTargetsAndWinCheck()}function animate(){drawBackdrop(),drawParticles();const e=performance.now();for(acc+=Math.min(.1,(e-last)/1e3),last=e;acc>=FIXED_DT;){const e=FIXED_DT/4;for(let t=0;t<4;t++)dt=e,scale=60*e,isPlaying&&!levelCompleted&&simulate(e);acc-=FIXED_DT}resetTransform(),setWorldTransform(),drawTargets(),drawBalls(),drawPlatforms(),drawPlatformPreview(),drawTargetPreview(),drawWinOverlay(),updateTotalCost(),requestAnimationFrame(animate)}function stepPhysicsOnce(e){const t=e/4;for(let e=0;e<4;e++)dt=t,scale=60*t,isPlaying&&!levelCompleted&&(updateBalls(),updatePlatforms(),detectAndResolveBallCollisions(),updateTargetsAndWinCheck())}function drawBackdrop(){resetTransform(),ctx.clearRect(0,0,canvas.width,canvas.height);const e=view.offX,t=view.offY,n=VIRT_W*view.scale,l=VIRT_H*view.scale;ctx.save(),ctx.beginPath(),ctx.rect(e,t,n,l),ctx.clip(),ctx.fillStyle="#C7D5F2",ctx.fillRect(e,t,n,l),ctx.fillStyle="#A7BEF2";for(let o=t+20;o<t+l-40;o+=40)for(let t=e+30;t<e+n-30;t+=60)ctx.save(),ctx.translate(t,o),ctx.scale(.5,.5),ctx.beginPath(),ctx.ellipse(0,0,20,10,0,0,2*Math.PI),ctx.moveTo(-20,0),ctx.lineTo(-30,-10),ctx.lineTo(-30,10),ctx.closePath(),ctx.fill(),ctx.restore();const o=t+l-20,i=ctx.createLinearGradient(0,o,0,o+20);i.addColorStop(0,"#8b5a2b"),i.addColorStop(1,"#5c3317"),ctx.fillStyle=i,ctx.fillRect(e,o,n,20),ctx.strokeStyle="rgba(255,255,255,0.15)",ctx.lineWidth=1;for(let t=o+6;t<o+20;t+=6)ctx.beginPath(),ctx.moveTo(e,t),ctx.lineTo(e+n,t),ctx.stroke();ctx.beginPath(),ctx.moveTo(e,o),ctx.lineTo(e+n,o),ctx.strokeStyle="#3b2415",ctx.lineWidth=3,ctx.stroke(),setWorldTransform();const s=130/view.scale,r=100/view.scale,a=VIRT_W-80-.5*r,c=VIRT_H-20/view.scale-.5*s;ctx.fillStyle="#111",ctx.beginPath(),ctx.ellipse(a,c+.25*s,.35*r,.3*s,0,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.ellipse(a,c-.1*s,.3*r,.3*s,0,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.moveTo(a-.25*r,c-.25*s),ctx.lineTo(a-.15*r,c-.5*s),ctx.lineTo(a-.05*r,c-.25*s),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.moveTo(a+.25*r,c-.25*s),ctx.lineTo(a+.15*r,c-.5*s),ctx.lineTo(a+.05*r,c-.25*s),ctx.closePath(),ctx.fill(),ctx.strokeStyle="#111",ctx.lineWidth=10/view.scale,ctx.beginPath(),ctx.moveTo(a+.3*r,c+.15*s),ctx.quadraticCurveTo(a+.7*r,c,a+.4*r,c-.25*s),ctx.stroke(),ctx.fillStyle="#fff",ctx.beginPath(),ctx.arc(a-.12*r,c-.1*s,7/view.scale,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(a+.12*r,c-.1*s,7/view.scale,0,2*Math.PI),ctx.fill(),ctx.fillStyle="#000",ctx.beginPath(),ctx.arc(a-.12*r,c-.1*s,3/view.scale,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(a+.12*r,c-.1*s,3/view.scale,0,2*Math.PI),ctx.fill(),ctx.fillStyle="#ff9aa2",ctx.beginPath(),ctx.arc(a,c-.05*s,4/view.scale,0,2*Math.PI),ctx.fill(),ctx.strokeStyle="#fff",ctx.lineWidth=2/view.scale,ctx.beginPath(),ctx.moveTo(a-5/view.scale,c-.05*s),ctx.lineTo(a-.25*r,c-.1*s),ctx.moveTo(a-5/view.scale,c-.03*s),ctx.lineTo(a-.25*r,c-0*s),ctx.moveTo(a+5/view.scale,c-.05*s),ctx.lineTo(a+.25*r,c-.1*s),ctx.moveTo(a+5/view.scale,c-.03*s),ctx.lineTo(a+.25*r,c-0*s),ctx.stroke()}function drawYarnBall(e,t={}){const n=e.radius,l=t.hue??0,o=`hsl(${l}, 90%, 45%)`,i=`hsl(${l}, 95%, 25%)`,s=`hsl(${l}, 100%, 70%)`;ctx.save(),ctx.translate(e.x,e.y),ctx.rotate(e.rotation);const r=ctx.createRadialGradient(.25*-n,.25*-n,.2*n,0,0,n);r.addColorStop(0,o),r.addColorStop(1,i),ctx.fillStyle=r,ctx.beginPath(),ctx.arc(0,0,n,0,2*Math.PI),ctx.fill(),ctx.strokeStyle="rgba(255,255,255,0.25)",ctx.lineWidth=Math.max(1,.08*n);for(let e=0;e<20;e++){const t=n*(.35+e/20*.55),l=Math.PI*(.7+.6*Math.sin(1.3*e)),o=-l/2,i=l/2;ctx.save(),ctx.rotate(.6*e+.2*Math.sin(.7*e)),ctx.beginPath(),ctx.arc(0,0,t,o,i),ctx.stroke(),ctx.restore()}ctx.strokeStyle="rgba(255,255,255,0.18)",ctx.lineWidth=Math.max(1,.06*n);for(let e=0;e<5;e++){const t=n*(.35+e/4*.6);ctx.save(),ctx.rotate(1.2*e+.8),ctx.beginPath(),ctx.arc(0,0,t,-1.1,1.1),ctx.stroke(),ctx.restore()}ctx.fillStyle=s,ctx.beginPath(),ctx.ellipse(.35*-n,.35*-n,.22*n,.14*n,-.6,0,2*Math.PI),ctx.fill(),ctx.restore();const a=Math.hypot(e.vx||0,e.vy||0);if(a>.2){const t=Math.min(60,4*a),o=Math.atan2(e.vy||0,e.vx||0),i=e.x-Math.cos(o)*(n+2),s=e.y-Math.sin(o)*(n+2),r=e.x-Math.cos(o)*(n+t),c=e.y-Math.sin(o)*(n+t);ctx.save(),ctx.strokeStyle=`hsl(${l}, 65%, 40%)`,ctx.lineWidth=Math.max(1,.05*n),ctx.beginPath(),ctx.moveTo(i,s);const d=(i+r)/2+6*Math.cos(.05*performance.now()+.01*e.x),m=(s+c)/2+6*Math.sin(.06*performance.now()+.01*e.y);ctx.quadraticCurveTo(d,m,r,c),ctx.stroke(),ctx.restore()}}function updateParticles(e){for(let t=fx.length-1;t>=0;t--){const n=fx[t];n.life+=e;const l=n.life/n.ttl;"dust"===n.type&&(n.vy+=500*e),n.x+=n.vx*e,n.y+=n.vy*e,n.angle+=n.spin*e,n.alpha=1-l,"dust"===n.type&&(n.size*=1-.6*e),l>=1&&fx.splice(t,1)}}function drawParticles(){ctx.save(),fx.forEach(e=>{if("dust"===e.type){ctx.globalAlpha=.6*Math.max(0,e.alpha);const t=Math.max(.5,e.size),n=ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,t);n.addColorStop(0,"rgba(120,120,120,0.7)"),n.addColorStop(1,"rgba(120,120,120,0.0)"),ctx.fillStyle=n,ctx.beginPath(),ctx.arc(e.x,e.y,t,0,2*Math.PI),ctx.fill()}else{ctx.globalAlpha=Math.max(0,e.alpha),ctx.lineWidth=4,ctx.strokeStyle="rgba(255,200,60,0.9)";const t=e.size,n=e.x-Math.cos(e.angle)*t,l=e.y-Math.sin(e.angle)*t;ctx.beginPath(),ctx.moveTo(e.x,e.y),ctx.lineTo(n,l),ctx.stroke()}}),ctx.globalAlpha=1,ctx.restore()}function emitImpactDust(e,t,n,l,o){const i=clamp(Math.round(3+10*o),3,18);for(let s=0;s<i;s++){const i=Math.atan2(l,n)+rand(-.9,.9),s=rand(40,120)*(.3+.7*Math.min(1,o));fx.push({x:e,y:t,vx:Math.cos(i)*s,vy:Math.sin(i)*s,life:0,ttl:rand(.35,.75),size:rand(4,10),alpha:1,spin:rand(-2,2),angle:i,type:"dust"})}fx.length>600&&fx.splice(0,fx.length-600)}function emitImpactSparks(e,t,n,l,o){const i=clamp(Math.round(4+14*o),4,24);for(let s=0;s<i;s++){const i=Math.atan2(l,n)+rand(-.5,.5),s=rand(120,260)*(.3+.7*Math.min(1,o));fx.push({x:e,y:t,vx:Math.cos(i)*s,vy:Math.sin(i)*s,life:0,ttl:rand(.12,.28),size:rand(8,16),alpha:1,spin:0,angle:i,type:"spark"})}fx.length>600&&fx.splice(0,fx.length-600)}function emitImpactGeneric(e,t,n,l,o,i="auto"){return"spark"===i?emitImpactSparks(e,t,n,l,o):"dust"===i?emitImpactDust(e,t,n,l,o):(emitImpactDust(e,t,n,l,.8*o),void emitImpactSparks(e,t,n,l,.6*o))}loadLevel(currentLevel),updateAdminToggleVisibility(),animate(),window.addEventListener("resize",()=>{resizeCanvas()}),refreshLevelLocks()</script>