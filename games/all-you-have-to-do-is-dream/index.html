<title>All you have to do is Dream - js13kGames 2025</title><style>body{background-color:#000;overflow:hidden;font-family:Georgia;user-select:none;background:linear-gradient(#008,#000);overflow:hidden}#BG{position:fixed;filter:url(#_N);width:100vw;height:100vh;opacity:.3}.stats{display:grid;white-space:nowrap;grid-template-columns:auto auto auto auto}.grid3{display:grid;white-space:nowrap;grid-template-columns:auto auto auto}u{cursor:pointer}#Saves{position:fixed;right:10px;color:#fff;text-align:right}.saves{display:grid;grid-template-columns:auto auto auto auto;gap:10px}.saves>button{cursor:pointer}.entity,canvas{padding:0;margin:0;position:relative;transform-origin:0 0}.entity.current,.entity.k4{pointer-events:none}.pointer{animation:.5s blink infinite alternate-reverse}.sprite{image-rendering:pixelated;padding:0;margin:0}.sprite:hover{filter:brightness(1.2)}#Back{z-index:-100}.floor,.wall{pointer-events:all}.carpet{pointer-events:none}#Back,.carpet,.curtain,.floor,.wall,.wp{position:absolute;transform-origin:0 0}.curtain{pointer-events:none;transform:translateZ(64px)}.wall{transform:rotate3d(0,-1,0,90deg)}.wp{background-color:#008}.carpet,.floor{transform:rotate3d(1,0,0,89.9deg)}#Cam{perspective:800px;perspective-origin:50% 200%;position:absolute;top:0;left:50vw}#Scene{position:absolute;transform-style:preserve-3d}#Preview{padding:20px;pointer-events:none}@keyframes blind{0%,100%{filter:opacity(0)}20%{filter:opacity(1)}}@keyframes blink{0%{filter:brightness(.8)}100%{filter:brightness(1.2)}}@keyframes rotate{0%{transform:rotate(-10deg)}100%{transform:rotate(10deg)}}.thought{z-index:100;animation:3s flow-up forwards linear}.thoughtd{z-index:100;animation:3s flow-down forwards linear}.aspect{font-size:20}.aspect canvas{padding-right:10px;transform:scale(2) translateY(4px);transform-origin:50% 80%}.num{min-width:50px}@keyframes flow-up{0%,100%{opacity:0}100%{transform:translateY(-10px)}20%{opacity:1}}@keyframes flow-down{0%,100%{opacity:0}0%{transform:translateY(10px)}20%{opacity:1}}.ftext{position:absolute;font-size:5px;text-align:center;color:#fff;text-shadow:1px 1px 1px #000;pointer-events:none}.ftext div{animation:3s flow-up forwards linear}.etitle{color:#fff;pointer-events:none;position:absolute;top:-3px;z-index:100;left:0;font-size:4px;width:100%;text-align:center;white-space:nowrap}.right .etitle{transform:scaleX(-1)}.right>canvas{transform-origin:100% 0}.etitle,.grn,.red{text-shadow:.2px .2px .2px #000}.red{color:#f88}.grn{color:#8f8}.blink{animation:blink infinite alternate .5s}.blind{pointer-events:none;position:absolute;animation:blind 4s}.dn{display:none}i{font-size:80%;opacity:70%}.lvl{display:inline-block;min-width:40px}#Msg{position:fixed;left:50%;top:50%;width:400px;transform:translate(-200px,-200px);z-index:100;text-align:center;color:#fff;display:none}#Info{position:fixed;top:10px;left:10px;color:#fff;max-width:350px;font-size:15px}#Info,#MSg,.saves{padding:0 20px 20px 20px;background:#0003;border-radius:4px;border-right:solid 1px #fff4;border-top:solid 1px #fff4}.roomn{font-size:10px;white-space:nowrap;transform:translateX(30px)}</style><div class=dn><svg><defs id=DEFS><filter id=_N><feTurbulence baseFrequency=0.005 numOctaves=4 type=fractalNoise /></filter><filter id=_S><feColorMatrix type=matrix values="1 0 0 0 0  -1 0 0 0 1  0 0 0 0 0  0 0 0 0 1"/></filter><filter id=_T><feColorMatrix type=matrix values="1 0 0 0 0  -1 0 0 0 1  0 0 0 0 0  1 0 0 0 0"/></filter><filter id=_O><feColorMatrix type=matrix values="1 0 0 0 0  0 0 0 0 0  0 0 0 0 0  1 0 0 0 0" result=f /><feMorphology operator=dilate radius=.9 /><feColorMatrix type=matrix values="0 0 0 0 0  1 0 0 0 0  0 0 0 0 0  1 0 0 0 0"/><feBlend in2=f mode=overlay /></filter><filter id=_4><feColorMatrix type=matrix values="1 0 0 0 0  1 0 0 0 0  1 0 0 0 0  0 0 0 1 0"/></filter></defs></svg><canvas id=TC></canvas><img id=img src=""></div><div id=Debug class=dn><div id=Preview></div><div id=FPS></div></div><div id=Cam><div id=Scene><canvas id=Back></canvas></div></div><div id=Saves></div><div id=Info></div><div id=Msg></div><script>function e(e,t,n=1){return e.map((e,i)=>e+t[i]*n)}function t(t,n){return e(t,n,-1)}function n(e,n){return function(e){return e.reduce((e,t)=>e+t*t,0)**.5}(t(n,e))}var i=2**31,a=s(123);function s(e=0){0<e&&e<1&&(e=~~(e*i));let t=t=>(e=16807*e%2147483647)%t;return a=n=>-1==n?e:null==n?t(i)/i:t(n)}function o(e,t=a){return e?e[t(e.length)]:null}function r(e,t=a){let n=d(e),i=t()*n-e[0],s=0;for(;i>=0;)i-=e[++s];return s}function l(e,t,n=a){let i=e.map(t);return e[r(i)]}function c(e,t=e=>e,n=a){let i=r(Object.values(e).map(t),n);return Object.keys(e)[i]}function d(e){return e.reduce((e,t)=>e- -t,0)}function u(e=a){let t="";for(let n=0;n<e(3)+2;n++)t+=o([..."kstnhmyrw",""],e)+o([..."aiueo",""],e);return function(e){return e?e[0].toUpperCase()+e.substring(1):""}(t)}function p(e){for(let t of Object.values(e))for(let e in t){let n=Number(t[e]);!isNaN(n)&&"colors"!=e&&(t[e]=n)}return e}function h(e,t=.01){return(e=((e/=t)-Math.floor(e)>a()?1:0)+Math.floor(e))*t}function f(e,t=e=>e){return[...new Array(~~Math.max(e,0))].map((e,n)=>t(n))}var m=e=>new Promise(t=>setTimeout(t,e)),v=e=>e&&e.toFixed(2).replace(/(.00)/g,"");function g(e){Msg.innerHTML=`<p>${e}</p><p><button onclick="Msg.style.display='none'">OK</button></p>`,Msg.style.display="block"}var b=p(Object.fromEntries("Health:So called Hit Points:31\nStrength:Dealing Damage:fg\nResilience:Damage reduction:qp\nGreed:Find More:c4\nBloom:Regeneration:ba\nCourage:Cover your allies:21\nAnger:Avenge Damage:uv\nMercy:Heal Friends:lx\nKnowledge:Reading and writing Tomes:mn\nLight:Strike True:je\nDark:Evade:o8\nTime:Action Rate:lm\nPurity:Resist Poison:rq\nVenom:Poison foe:ba".split("\n").map((e,t)=>{let[n,i,a]=e.split(":"),s=n[0];return[s,{l:s,name:n,tip:i,colors:a,ind:t}]}))),y=p(Object.fromEntries("Wooden:67:H:10\nIron:lm:S:10\nStone:mn:R:10\nGolden:c4:G:2\nPlant:ba:B:5\nLeather:56:C:5\nBone:ji:A:5\nCloth:tv:M:10\nPaper:kl:K:5\nGlass:wr:L:5\nObsidian:no:D:2\nCopper:ef:T:5\nSilver:lx:PM:3\nAsbestos:kb:V:1\nAbstract:::1".split("\n").map(e=>{let[t,n,i,a]=e.split(":");return[t,{colors:n,aspects:E(i),chance:a}]}))),k=p(Object.fromEntries("Door:2::Wooden:0:1:\nBed:2:H:Wooden:20:.5:\nColumn:3:R:Stone:0:1:\nApple:1:B:Plant:10:1:\nChair:1.5:H:Wooden:5:1:\nChest:1:G:Wooden:10:1:\nShelf:2:G:Wooden:3:1:\nStand:2:S:Stone:2:1:base\nDisplay:2::Glass:3:1:\nPlaque:2:R:Iron:2:1:base\nBig Table:2:R:Stone:2:1:base\nDisplay:2::Glass:2:1:base\nTrinket:1::Glass:20:1:\nTable:2::Wooden:2:.5:base\nClock:1:T:Golden:10:1:\nPedestal:1.5::Wooden:2:1:base\nMirror:2::Glass:5:1:\nAngel:1:P:Silver:10:1:\nPress:2::Iron:0:1:\nBrush:1:::5:1:\nWine:1:A:Plant:5:1:\nExtractor:1:::5:1:\nEssense:1:::5:1:\nShirt:1:T:Cloth:10:1:armor\nRobe:1:M:Paper:10:1:armor\nChain:1:S:Iron:10:1:armor\nPlate:1:R:Iron:10:1:armor\nSword:1:S:Iron:10:1:\nAxe:1:T:Iron:10:1:\nHammer:1:S:Stone:2:1:\nSpear:1:R:Wooden:10:1:\nWand:1:M:Silver:10:1:\nShrinker:1:D::2:1:\nMagnifier:1:L::2:1:\nTome:1:::10:1:\nCactus:1:V::5:1:\nChalice:1:C::10:1:".split("\n").map((e,t)=>{let[n,i,a,s,o,r,l]=e.split(":");return[n,{use:l,type:n,scale:i,aspects:E(a),material:s,chance:o??0,ind:t,placeh:r}]}))),w=p(Object.fromEntries("Human:G\nElf:B\nCat:D\nOgre:H\nFairy:M\nBird:L\nRat:D\nRaven:A\nSkel:C\nImp:V\nDog:S\nHippo:H\nLizard:B\nDrago:P\nAlien:K\nHare:T".split("").map((e,t)=>{let[n,i]=e.split(":");return[n,{name:n,aspects:E(i),ind:t,chance:1/(10+t)}]}))),$={...w,...k},S={2:"An item that you have found in the dream. Looking at it (happens automatically when awake) can help to remember something about reality (i.e. raise aspects).",Bed:"RMB to sleep. Level up and find items in dreams. What you find in the dream is affected by the room number and the aspects of the bed and the dreamer. RMB to wake.",Brush:"Can recolor items.",Clock:"Put on the bed to sleep automatically.",Hammer:"For the deep analysis (RMB with it in hand on some disposable item).",Extractor:"Extract essense from the item. User's, extractor's and item's aspects should match for best results.",Tome:"Hold to write in",armor:"RMB to wear",base:"Can't be examined by itself, gives bonuses to items on it."},M=[["#00f","#f80"],["#88f","#00f"],["#008","#00f"]];function E(e=""){let t={};return[...e].forEach(e=>t[e]=(t[e]||0)+1),t}function x(e,t,n=1){let i={};e??={},t??={};for(let a in{...e,...t})i[a]=(e[a]||0)+(t[a]||0)*n;return i}function T(e){return d(Object.values(e))}function C(e,t,n){e[t]=(e[t]||0)+n}function B(e,t,n=1){let i=T(e),s={...e};for(let o=i;o<t;o+=n)a(Object.keys(e).length+1)?C(s,c(s),n):(C(s,c(s),1),o+=1);return s}function D(e,t){return{[c(e)]:t*T(e)}}var O="ayhiadream",P=0,j=512,L=256,A=127,R=(e,t,n)=>function(e,t){if(!t)return e;let n=e.cloneNode();return N(n).filter=function(e){if(!vt.has(e)){vt.add(e);let[t,n]=[...e].map(e=>mt[Number.parseInt(e,36)]),i=`<filter id=f${e}><feColorMatrix type=matrix values="${t[0]} ${n[0]} 0 0 0  ${t[1]} ${n[1]} 0 0 0  ${t[2]} ${n[2]} 0 0 0  0 0 0 1 0" /></filter>`;DEFS.innerHTML+=i}return`url(#f${e})`}(t),N(n).drawImage(e,0,0),n}(function(e,t,n=0){"O"==t&&(n=1);let i=G(8+2*n);return i.id=t+e,N(i).filter=`url(#_${t})`,N(i).drawImage(img,e%I*8,8*~~(e/I),8,8,n,n,8,8),i}(n,e),t),H=(e,t)=>R("S",e,t),z=(e,t)=>R("O",e,t),I=16;function N(e){return e.getContext("2d")}function G(e,t=e){let n=document.createElement("canvas");return n.classList.add("sprite"),n.width=e,n.height=t,n}var W,q,F=e=>N(e).createPattern(e,"repeat");function K(e,t,n){let i=document.createElement("div");i.classList.add("ftext"),n&&i.classList.add(n),i.innerHTML=`<div>${e}</div>`,Scene.appendChild(i),setTimeout(()=>Scene.removeChild(i),3e3),Q(i,t)}function Q(e,t,n=""){Object.assign(e.style,V(t,n))}function V(e,t=""){return{left:`${e[0]}px`,top:`${e[2]}px`,transform:`translateZ(${e[1]}px) `+t}}function X(e,t,n,i=1){let a=N(e);i&&(a.globalAlpha=i),a.fillStyle=t,a.fillRect(...n||[0,0,e.width,e.height]),i&&(a.globalAlpha=1)}function Y(e,t,n,i=1){return e.width=t*i,e.height=n*i,e.style.width=`${t}px`,e.style.height=`${n}px`,e}function J(e,t,n,i="canvas"){let a=document.createElement(i);return a.id=e,a.classList.add(...t.split(",")),Object.assign(a.style,n),Scene.appendChild(a),a}function Z(e,t,n,i,a=1){N(e).imageSmoothingEnabled=!1,N(e).drawImage(t,n,i,t.width*a,t.height*a)}var U=1,_=[-380,20];function ee(e){return e&&{...te(e,"id,name,kind,pos,scale,right,shape,colors,aspects,dream,type,material,recent,level,combat,hrz,sleeper,log"),chest:ee(e.chest),held:ee(e.held)}}function te(e,t){return Object.fromEntries(t.split(",").map(t=>[t,e[t]]))}function ne(e){if(!e)return null;let t=xe({...ft[e.kind],...e,chest:ne(e.chest)});return e.held&&Be(t,ne(e.held),e.held.pos),t}function ie(){return{cur:ct?.id,lid:P,sp:_,openRoom:U,date:Date.now(),rooms:yt.map(e=>te(e,"start,dream,aspects,level,stage,dur,drst")),all:Object.values(gt).filter(e=>!e.parent&&4!=e.kind).map(e=>ee(e))}}function ae(e){Object.values(gt).forEach(e=>Ce(e)),e.all.forEach(e=>ne(e)),bt(gt[e.cur]),function(e){P=e}(e.lid),e.sp&&(_=e.sp),U=e.openRoom,e.rooms.forEach((e,t)=>{Object.assign(yt[t],e)}),re();for(let e of yt)e.dream&&(e.tdr(!0),e.fight());tt()}var se=!0;function oe(e){if(se=void 0===e?!se:e,Saves.innerHTML="Press ESC to toggle menu",!se)return void(Msg.style.display="none");let t=JSON.parse(localStorage.getItem(O)||"[]");Saves.innerHTML+=`<div class=saves>${f(10,e=>`<div>${e||"auto"}</div><button onclick="save(${e})">Save</button>${t[e]?`<button onclick="load(${e})">Load</button><div>${new Date(t[e].date).toUTCString()}</div>`:"<div></div><div></div>"}`).join("")}</div>`}function re(){yt.forEach(e=>e.draw())}function le(e){return yt[~~(e[0]/256)+3*~~(e[2]/128-1)]}function ce(e){return le(Oe(e))||yt[0]}function de(e){return~~(10*(1+qe(e,"H")+.5*e.level))}function ue(e){return~~(1e3/(1+qe(e,"T")+.1*e.level+a()))}function pe(e,t,n=!0,i,s=0){if(!(t=h(t,1))&&!s)return;let o=Math.abs(t);n&&(e.combat.hp+=t,e.combat.hp=Math.min(Math.max(0,e.combat.hp),de(e)),i&&(i.combat.aggro+=o)),t>0&&i&&(i.dream,e.dream),t<0&&i&&e.dream;let r=n?(t>0?"+":"")+v(t):"miss",l=n?t<0?"red":"grn":"";K(r,Je(e),l);let c=`<div>${i?ze(i):t<0?"poison":"regen"}<span class=${l}>${r}</span> ${s?v(s)+" poison":""} ${ze(e)}</div>`;e.combat.poison+=s,i&&he(i,c),he(e,c),Qe(e);let d=ce(e);0==e.combat.hp&&e.dream&&(d.chars(!1).forEach(t=>function(e,t){t&&(e.level+=t,K(`${t}xp`,Je(e),"#80f"))}(t,function(e,t){return Math.max(0,h((5+t.level-e.level)/(1+e.level)/ce(e).chars(!1).length*.1))}(t,e))),function(e){let t=Xe().length;return 1==t||a()<.2/t*e.greed()}(d)&&(e.dream=!1,e.level=h(.7*e.level),e.aspects=B(e.aspects,e.level),d.wake()))}function he(e,t){e.log=e.log.slice(0).slice(-5)??[],e.log.push(`<div>${t}</div>`),Ze==e&&it(e)}function fe(e,t){return e.dream==t.dream}window.save=e=>{let t=JSON.parse(localStorage[O]||"[]");t[e]=ie(),localStorage[O]=JSON.stringify(t),oe(!1)},window.load=e=>{ae(JSON.parse(localStorage[O]||"[]")[e]),oe(!1)};var me="scaleX(-1) translateX(-100%)";function ve(i,a,s){let o=i.pos,r=Date.now(),{stopDistance:l,mode:c}=s||{};c??=1;let d=2==c?.3:.1,u=n(i.pos,a)/d,p=a[0]-i.pos[0];0!=p&&1==c&&(i.right=p>0);let h=t(a,o);return()=>{let t=Date.now(),s=Math.min(t-r,u);i.pos=e(o,h,u?s/u:1);let d=s>=u||n(i.pos,a)<(l??0);return i.transform=d?"":`rotateZ(${2==c?-10:3==c?10:5*Math.sin(t/100)}deg)`,!d}}function ge(e){return e.right?1:-1}function be(t,n,i=0){let a=ce(t),s=le(n);return s==a?[()=>ve(t,n,{stopDistance:i})]:[()=>ve(t,a.doorPos()),()=>t.pos=e(s.doorPos(),[5,0,0]),()=>ve(t,n,{stopDistance:i})]}function ye(e){let t=Date.now();return()=>Date.now()<t+e}function ke(e){return[e.size[0]*e.scale,e.size[1]*e.scale]}function we(e){!e||(Ee(e),$e(e))}function $e(n,i){if(!n)return;if(!n.animation&&n.actionsQueue){let e=n.actionsQueue.shift();if(e){let t=e();t instanceof Function&&(n.animation=t)}}delete n.aspects?.undefined,n.animation&&0==n.animation()&&delete n.animation;let a=n.div,s=t(i?e(n.pos,i):n.pos,function(e){return[ke(e)[0]/2,0,ke(e)[1]]}(n));a.style.opacity=n.opacity,a.classList.toggle("current",n==ct),a.classList.add("k"+n.kind),a.classList.toggle("right",!!n.right),a.style.display=n.dream||!ce(n).dream||1==n.kind||n.parent?"block":"none",Q(a,s,(n.right?me:"")+(n.transform??"")+(0==n.combat?.hp?"rotateZ(90deg)translateX(8px)":"")),"Door"==n.type&&Fe(n,`<div class='roomn'>Room ${ce(n).id}</div>`)}function Se(e){let t=G(1),n=document.createElement("div");return n.classList.add("entity"),n.appendChild(t),n.style.position="absolute",t.id="s"+e.id,e.canvas=t,e.div=n,(1==e.kind||"Door"==e.type)&&(e.title=document.createElement("div"),e.title.classList.add("etitle"),n.appendChild(e.title)),Ee(e),t}function Me(e){return e&&[e.shape,e.colors]}function Ee(e){e.makeBits&&(e.bits=e.makeBits(e));let t=e.canvas;if(t.width=1*e.size[0],t.height=1*e.size[1],t.style.transformOrigin=e.origin,t.style.transform=`scale(${e.scale})`,N(t).imageSmoothingEnabled=!1,e.bits)for(let n=0;e.bits[n];n++){let i=e.bits[n];if(!i||!i[0])continue;let a=z(i[1],i[0]);N(t).drawImage(a,1*e.bitPos[n][0],1*e.bitPos[n][1],1*a.width,1*a.height)}}function xe(e){e.id??=++P;let t={canvas:Se(e),floor:0,actionsQueue:[],...e},n=$[t.type];if(n&&(t.type??=n.type,n.placeh&&(t.mountPoint??=[5,0,9-8*n.placeh]),t.shape??=[0,16,64,0,0][t.kind]+n.ind,t.scale??=n.scale,t.use??=n.use,t.material??=a(2)||!n.material?c(y,e=>e.chance):n.material),t.colors=t.colors||y[t.material]?.colors,t.scale??=1,t.log=[],Ee(t),t.pos&&(e.className&&t.div.classList.add(e.className),Te(t)),!t.aspects)for(let e of[y[t.material],w[t.type],k[t.type]])t.aspects=x(t.aspects,e?.aspects);return e.addAspects&&(t.aspects=x(t.aspects,e.addAspects)),e.levelTo&&(t.aspects=B(t.aspects,e.levelTo)),t.level??=T(t.aspects),t}function Te(e){gt[e.id]||(gt[e.id]=e,Scene.appendChild(e.div),we(e))}function Ce(e){e.div.parentElement?.removeChild(e.div),delete gt[e.id]}function Be(e,t,n){2==t.kind&&(t.parent&&De(t.parent),e.div.appendChild(t.div),e.held=t,t.parent=e,t.pos=n??function(e,t=1){return e.map((e,n)=>e*t)}(e.mountPoint,e.scale),$e(t))}function De(e,t){let n=e.held;return delete e.held,n&&(n.pos=t??e.pos,Scene.appendChild(n.div),delete n.parent,we(n),we(e)),n}function Oe(e,t=!0){return t?function(e){return[e[0],e[1],128*Math.ceil(e[2]/128)]}(Pe(e).pos):Pe(e).pos}function Pe(e){return e.parent?Pe(e.parent):e}function je(e){return le(Oe(e)).dream}function Le(t,n,i=""){if(!n)return;let a=b[n];return xe({...ht,shape:144+a.ind,colors:a.colors,pos:e(t.pos,[0,0,-20]),className:"thought"+i,deadAt:Date.now()+3e3})}function Ae(e){return e.level??T(e.aspects)}function Re(e){return 1==e.kind?`${e.name} the ${e.type||"X"}`:`${e.material||""} ${e.type}`}function He(e){if("l"==e&&(e=Ze),!e||4==e.kind)return;let t="";if(t+=`<h1>${Re(e)}</h1>`,t+=`<h4>Level ${v(Ae(e))}</h4>`,nt&&(t+=`<p>${e.tip||""} ${S[e.type]??S[e.use]??""} <i>${S[e.type]?"":S[e.kind]??""}</i></p>`),"Door"==e.type){let n="";"Obsidian"==e.material&&(n=`This door lets one person escape (use RMB). But they need to have level >= ${ce(e).id}. Doing it also unlocks new room. You first character can only use the door in room 0.`),t+=`<p>${n}</p>`}e.aspects&&(t+="Aspects. ",1==e.kind&&(t+='<i>This person\'s memories, personality and knowledge. Affects their performance while dreaming. Value after "/" is with equipment bonuses/penalties.</i>'),2==e.kind&&(t+="<i>Characters automatically improve their aspects by looking at this item. The chance of learning something scales with the person's level and item's level. The chance goes down, if many people have high value in this aspect.</i>"),t+=`${function(e,t){let n="";for(let i of Object.keys(b)){let a=e[i]||0,s=t?qe(t,i):a;s&&(n+=`<div class="aspect" data-aspect=${i}></div><div class=num>${v(a)} ${s!=a?`<i>/${v(s)}</i>`:""}</div><div> ${b[i].name}</div><div> <i>${b[i].tip}</i></div>`)}return`<p><div class=stats>${n}</div></p>`}(e.aspects,e)}`);let n=ce(e);return n.dream&&(t+="<div class=grid3>"+n.chars().map(e=>`<div>${v(e.level)}</div><div>${ze(e)}</div><div>${Ke(e)} ${e.combat.poison?e.combat.poison+" poison":""}</div>`).join("")+"</div>"),e.log?.length&&(t+="<hr/>"+e.log.join("")),t}function ze(e){return`<u style='color:${e.dream?"#f88":"#8f8"}' onclick="selp(${e.id})">${Re(e)}</u>`}function Ie(e,t,n){let i=function(e){return Object.fromEntries(Object.keys(b).map(t=>[t,qe(e,t)]).filter(e=>e[1]))}(t),a=c(i);n??=Ne(e,t);let s=qe(t,a)*n*.01;if(s=h(s),s&&("Tome"==t.type&&(s*=1+.1*qe(e,"K")),C(e.aspects,a,s),e.recent&&(e.recent.unshift(t.id),e.recent.length=20),e==Ze&&it(e),Le(t,a,"d"),he(e,`Learned ${v(s)} of ${b[a].name} from ${Re(t)} `),he(t,`Taught ${v(s)} of ${b[a].name} to ${Re(e)} `),"Clock"==t.type&&"Bed"==t.parent?.type)){let n=ce(e).chars().find(e=>e.sleeper)||e;(0==n.sleeper||n.sleeper>60)&&ce(e).sleep(n,t.parent)}}function Ne(e,t){e.recent??=[];let n=e.recent.indexOf(t.id);return-1==n&&(n=1e6),1-1/(1+n)}function Ge(e){if(!function(e){return!e.actionsQueue?.length&&!e.animation}(e))return;if("Tome"==e.held?.type){let t=e.held;return void Ie(t,e,.05*(t.level+qe(e,"K")-T(t.aspects)))}let t=function(e){let t=ce(e).entities().filter(e=>"base"!=e.use),i=r(t.map(t=>{if(t==e||!function(e){return 2==e.kind||1==e.kind}(t))return 0;let i=n(e.pos,Oe(t));return Ae(t)/(10+i)*Ne(e,t)}));return t[i]}(e);!t||We(e,[...be(e,Oe(t),10),()=>Ie(e,t),()=>ye(1e3)])}function We(e,t){!e||(e.actionsQueue=t,delete e.animation)}function qe(e,t){let n=e.aspects[t]||0;return e.parent&&"base"==e.parent.use&&(n=Math.min(2*n,n+(e.parent.aspects[t]||0))),1==e.kind&&(e.held||(n*=1.3),n+=.5*(e.held?.aspects[t]||0),n+=.5*(e.chest?.aspects[t]||0)),n??0}function Fe(e,t){e.title&&(e.title.innerHTML=t)}function Ke(e){return e.combat?.hp>=0?`${v(e.combat?.hp)}/${de(e)} hp`:""}function Qe(e){Fe(e,Ke(e))}function Ve(t,n){let i=t.held;if("Shrinker"==i?.type)return n.scale*=.9,void we(n);if("Magnifier"==i?.type)return n.scale/=.9,void we(n);if("Hammer"==i?.type&&2==n.kind)return Ie(t,n,10),void Ce(n);if("Essense"==i?.type)return n.aspects=x(n.aspects,i.aspects),n.level=T(n.aspects),De(t),Ce(i),void we(t);if("Extractor"==i?.type){let s=c(function(e,t){let n={};e??={},t??={};for(let i in{...e,...t})n[i]=(e[i]||0)*(t[i]||0);return n}(t.aspects,i.aspects)),o=Math.min(qe(t,s)+i.aspects[s],n.aspects[s]);o>0?(xe({...pt,type:"Essense",material:n.material,aspects:{[s]:o},pos:n.pos}),Ce(n)):(he(t,"Extract fail."),xe({...ht,shape:58,colors:"32",pos:e(t.pos,[0,0,-20]),className:"thought",deadAt:Date.now()+3e3}),a(10)||Ce(n))}if("armor"==n.use)return t.chest.pos=n.pos,Te(t.chest),n.parent&&Be(n.parent,t.chest),Ce(n),we(t.chest),t.chest=n,void we(t);if("Brush"==i?.type)return n.colors=i.colors,void we(n);if("Bed"!=n.type)if("Door"!=n.type);else{let e=n.level;if("Obsidian"==n.material){if(t.level<e)return void g(`Need level ${e} to use`);if("Мiu"==t.name)return void g(0==e?"You win. Pretend there is an epic ending sequence here.":"You can't use this door. Maybe you can find someone else who can?");(function(e){e.material="Wooden",e.colors=y[e.material]?.colors})(n),we(n),Ce(t),bt(Xe()[0]),U++,re(),g("Walking through this door, they have left these rooms for good. Also, new room has opened.")}}else ce(t).sleep(t,n)}function Xe(){return Ye(!1).filter(e=>1==e.kind)}function Ye(e){return Object.values(gt).filter(t=>void 0===e||!t.dream==!e)}function Je(t){return e(t.pos,[-5+a(10),0,-35])}window.selp=e=>bt(gt[e]);var Ze,Ue=[],_e=600;function et(e,t){(function(e,t){t&&(e.colors=t.colors,e.shape=t.shape,e.scale=t.scale),Ee(e)})(rt,e),rt.pos=t,Scene.appendChild(rt.div),$e(rt)}function tt(){Scene.style.left=`${_[0]}px`,Scene.style.top=`${_[1]}px`}var nt=!0;function it(e){let t=He(e)||He(ct);Ze=e||ct,Info.innerHTML=t??"",requestAnimationFrame(()=>document.querySelectorAll(".aspect").forEach(e=>{let t=b[e?.dataset?.aspect];if(!t)return;delete e?.dataset?.aspect;let n=Se({...ht,shape:144+t.ind,colors:t.colors});e.prepend(n)}))}function at(){Scene.style.transform=`translateZ(${_e}px)`}function st(e){let[t,n,i]=[e.target.id,e.offsetX,e.offsetY];return[n,i,t[0],1*t.substring(1)]}var ot,rt,lt,ct,dt={bitPos:[[3,1],[2,14],[2,10],[2,13]],mountPoint:[0,0,16],size:[16,24],origin:"75% 50%",kind:1,makeBits:e=>[[e.shape,e.colors],[56,e.colors],Me(e.chest),[48,e.colors]]},ut={bitPos:[[0,0]],size:[10,10],kind:3,makeBits:e=>e&&[[e.shape,e.colors]]},pt={...ut,kind:2},ht={...ut,kind:4},ft=[,dt,pt,ut,ht],mt=[..."906j05u58zdczpdrfag867240125869i8lp8zu7zi8t94h34724i97wlfzuozzvqrrfjj68a13509d4kngtqzvuzjnq8kd3duzzxxx".matchAll(/(\w)(\w)(\w)/g)].map(e=>[...e.slice(1,4).map(e=>~~(Number.parseInt(e,36)/36*100)/100),1]),vt=new Set,gt={};function bt(e){let t=ct;ct=e,we(t),ct&&(we(ct),ct.div.appendChild(lt.div)),it(e)}onload=()=>{img.onload=kt,img.src="i.webp"};var yt=[];function kt(){yt=f(15,t=>new class{constructor(e){this.id=e,this.stage=0,this.drst=0,this.dur=0,this.col=e%3,this.row=~~(e/3),this.l=256*this.col*2,this.t=128*this.row*2,this.pos=[e%3*256,0,128*~~(e/3+1)]}md(){xe({...ut,shape:64,material:"Obsidian",type:"Door",level:this.id,scale:2,pos:this.doorPos()})}drawTrees(e){let t=[null,["a9",1],["ba",2],["a9",3],["57",16],0,["a9",7,1],["mn",9],["mn",8,1]],n=[0,4,4,4,0,4],i=N(Back);for(let s=60;s>4;s--){let o=2*s**.7,r=a(460.8)+.1;i.save(),i.translate(r,L-o-70);let l=30/(3+.6*o);i.scale(l,l),n[e]&&Z(Back,z("57",112+n[e]),5,6),t[e]&&Z(Back,z(t[e][0],112+t[e][1]),0,-8,t[e][2]??2),i.restore()}}draw(){let e=W[this.row],t=N(Back);s(99*this.id+(this.dream?this.stage+this.drst%1e3:0)),t.save(),t.translate(this.l,this.t);let n=N(e);if(n.save(),n.translate(this.l,0),this.dream){let i=t.createLinearGradient(0,0,0,100);if(M[a(3)].forEach((e,t)=>i.addColorStop(t,e)),t.fillStyle=i,t.fillRect(0,0,j,L),this.stage%2){let t=o(Object.values(y)).colors,i=o(Object.values(y)).colors,s=F(H(t,a(5)+1));X(Back,s,[0,0,j,L]),X(e,F(H(i,a(3)+1)),[0,0,j,A]),f(3,t=>{Z(Back,z("rf",118),128*(1+t)-16,89.6,4),n.globalAlpha=.2,Z(e,z("kk",123),128*(1+t)-16,44.8,4)})}else{let n=a(8)+1,i=[0,["ba",9],["ba",9],["ba",9],["ba",9],["ij",9],["ij",13],["mn",14],["mn",14]][n],s=F(H(i[0],i[1]));t.fillStyle=s,t.fillRect(0,153.6,j,105.4),this.drawTrees(n),X(e,s,[0,0,j,A]);let o=function(e){let t=e.cloneNode();return t.width*=16,t.height*=16,Z(t,e,0,0,16),t}(R("T","45",11));X(e,F(o),[0,0,j,A],.5)}}else X(Back,F(H("2f",a(3)+1)),[0,0,j,L]),X(e,F(H("rq",a(3)+1)),[0,0,j,A]);n.restore(),t.restore();let i=F(H("2g",1)),r=q[this.id];N(r).clearRect(0,0,j,L),this.open?(X(r,i,[0,0,10,L]),X(r,i,[0,246,j,10])):X(r,i,[0,0,j,L])}get open(){return this.id?1*this.id<=U:U>=13}tdr(e){this.dream=e,this.draw();for(let t of this.entities())We(t,[]),Fe(t,""),t.dream=!!t.dream,e||(t.combat={},t.dream&&Ce(t)),$e(t),Qe(t)}entities(e){return Ye(e).filter(e=>le(Oe(e))==this)}chars(e){return this.entities(e).filter(e=>1==e.kind)}doorPos(){return e(this.pos,[128,1,0])}center(){return e(this.pos,[128,32,0])}async wake(){if(!ct||ct.dream&&ce(ct)==this){let e=this.chars(!1);bt(e.find(e=>e.sleeper)||e[0])}this.blind(),await m(500),this.tdr(!1),this.stage=0,window.save(0)}greed(){return 1+.1*Math.max(...this.chars(!1).map(e=>qe(e,"G")))}async sleep(e,t){this.chars().forEach(e=>e.sleeper=0),e.sleeper=1,this.blind(),await m(400),this.dur=0,this.drst=Date.now(),this.tdr(!0);let n=x(e.aspects,t.aspects),i=T(n);n=x(n,{[Object.keys(b)[this.id]]:1});let a=Math.max(1,i-3);this.aspects=B(n,a),this.level=a,this.next()}next(){for(let e=0;e<1+~~(this.stage/4);e++)xe({...dt,levelTo:this.level,type:c(w,e=>e.chance),name:u(),chest:xe({...pt,levelTo:this.level,type:o(Object.keys(k).filter(e=>"armor"==k[e].use))}),pos:this.doorPos(),addAspects:D(this.aspects,.2),dream:!0});for(let t of[!0,!1]){let n=this.chars(t),i=e(this.pos,[256*(t?.3:.7),0,0]);n.forEach((a,s)=>{a.pos=e(i,[0,64*((s+.5)/n.length*.7+.3),0]),a.right=t,a.combat={pos:a.pos,hp:de(a),delay:ue(a),aggro:0,poison:0},Qe(a),we(a)})}this.stage%2&&this.addItems(10,.2),this.fight()}win(){this.stage++,this.entities(!0).forEach(e=>{2==e.kind&&function(e){let t=7/(10+Ye().filter(e=>2==e.kind&&!e.dream).length)*e.greed();return a()<t}(this)?(e.dream=!1,$e(e)):Ce(e)}),this.chars(!0).forEach(e=>Ce(e)),this.chars().forEach(t=>{t.combat.hp>0&&We(t,be(t,e(t.combat.pos,[-100,0,0])))}),this.blind(),this.chars()[0].actionsQueue.push(()=>this.next())}living(){return this.chars().filter(e=>e.combat.hp>0)}fight(){if(!this.dream)return;let t=this.living(),n=t.filter(e=>e.dream).length;if(0==n)return this.win();if(n==t.length)return this.wake();let i=Math.min(...t.map(e=>e.combat.delay)),s=t.find(e=>e.combat.delay==i),o=(qe(c=s,"B")-c.combat.poison)*ue(s)/1e3;var c;let d;o&&pe(s,o),1==r([qe(s,"S")+.1*s.level,qe(s,"M")/3])&&(d=l(t,e=>fe(s,e)?de(e)/e.combat.hp:0)),(!d||function(e){return e.combat.hp==de(e)}(d))&&(d=l(t,e=>fe(s,e)?0:.1*e.level+Math.max(0,qe(e,"C")-qe(e,"D")-qe(s,"L"))+qe(s,"A")*e.combat.aggro)),We(s,function(t,n,i=()=>{}){return[()=>ve(t,t==n?e(n.combat.pos,[0,0,-10]):n.combat.pos,{mode:2}),()=>{(function(t,n){let i=t.dream==n.dream;i||We(n,function(t){return[()=>ve(t,e(t.combat.pos,[-20*ge(t),0,0]),{mode:3}),()=>t.combat.hp?ve(t,t.combat.pos,{mode:3}):null]}(n));let s=function(e,t){return Math.max(0,3+3*(qe(e,"S")+.5*e.level)-qe(t,"R")/2)*function(e){let t=1+ce(e).dur/6e4;return e.dream?.5*t:1.5/t}(e)}(t,n),o=!0;i||(o=a()*(2*qe(t,"L")+t.level)*2>a()*(2*qe(n,"D")+n.level)),pe(n,i?~~(1+qe(t,"M")):-~~((a()+.5)*s),o,t,i||!o?0:h(qe(t,"V")/(1+qe(n,"P"))*.3,1))})(t,n),i()},()=>ve(t,t.combat.pos,{mode:2}),()=>{t.combat.delay=ue(t),ce(t).fight()}]}(s,d,()=>t.forEach(e=>e.combat.delay-=i)))}blind(){let t=J("","blind",V(e(this.pos,[0,64,-128])));Y(t,256,128,8),X(t,F(H("on",11))),setTimeout(()=>this.draw(),800),setTimeout(()=>Scene.removeChild(t),3900)}addItems(e,t=1){for(let n=0;n<e;n++){let e=c(k,e=>e.chance),n=xe({...pt,type:e,addAspects:this.aspects?D(this.aspects,.2):void 0,levelTo:(this.level+this.stage)*("Tome"==e?.2:1),pos:[256*this.col+10+a(236),a(59)*t+5,128*(this.row+1)]});n.level=~~(this.level+this.stage),n.dream=this.dream,$e(n)}}}(t)),function(){Scene.innerHTML+="",Y(Back,768,640,2);let e=F(H("gf",2));f(4,t=>{let n=J(`w${t}`,"wall",{left:256*t+"px"});return Y(n,64,640,2),X(n,e),n});let t=(W=f(6,e=>Y(J("f"+(e-1),"floor",{top:128*e+"px"}),768,64,2))).shift();X(t,F(H("87",2))),t.style.pointerEvents="none",q=f(15,e=>Y(J(`c${e}`,"curtain",{top:128*~~(e/3)+"px",left:e%3*256+"px"}),256,128,2)),re()}(),yt.forEach(e=>e.md()),at(),onkeydown=e=>{"Escape"==e.key&&(oe(),Msg.style.display="none")},onpointerup=e=>{Ue[e.button]=!1},onpointerdown=e=>{Ue[e.button]=!0;let t,[n,i,a,s]=st(e),o="f"==a?[n,i,128*(s+1)]:"B"==a?[n,0,i]:null;if(o&&le(o)?.dream&&2==e.button&&le(o).wake(),o&&ct&&!ct.dream&&"f"==a&&!e.shiftKey&&((2==e.button||0==e.button&&!ct.held)&&(t=be(ct,o)),0==e.button&&ct.held&&(t=[...be(ct,o),()=>De(ct)])),"s"==a&&!e.shiftKey){let e=gt[s];if(!e)return;1==e.kind&&bt(e)}if(ct&&!ct.dream&&"s"==a&&!e.shiftKey){let n=gt[s];if(n&&n!=ct){if(je(n))return void ce(n).wake();2==e.button&&(t=[...be(ct,Oe(n),15),()=>Ve(ct,n)]),0==e.button&&(1==n.kind?bt(Pe(n)):t=[...be(ct,Oe(n)),()=>{ct.held?n.held||Be(n,ct.held):Be(ct,n)}])}}t&&!je(ct)&&We(ct,[...t,()=>ye(5e3)])},oncontextmenu=e=>{e.shiftKey||e.preventDefault()},onpointermove=t=>{if(Ue[1]){let n=.5;Object.assign(_,e(_,[t.movementX,t.movementY],n)),tt()}let[n,i,a,s]=st(t),o=[n,i,128*(s+1)],r=gt[s];it("s"==a?r:ct);let l=ct?.held;l&&("f"==a&&et(l,o),"s"==a&&r&&2==r.kind)&&(et(l,e(r.pos,[0,0,.7*-ke(r)[1]])),r.div.parentElement?.appendChild(rt.div)),t.preventDefault()},onwheel=e=>{_e-=.2*e.deltaY,at()},tt(),ot=xe({...dt,shape:18,colors:"nm",type:"Cat",name:"Мiu",chest:xe({...pt,type:"Chain",material:"Plant"}),pos:[320,10,128],addAspects:{S:1}}),rt=xe({...ht,opacity:.5,shape:1,colors:"ab",pos:[0,0,0],noclick:!0}),Be(["Bed","Bed","Hammer","Brush","Shrinker","Magnifier","Tome","Extractor"].map((e,t)=>xe({...pt,type:e,pos:yt[t+1].center()}))[1],xe({...pt,type:"Clock",pos:[0,0,0]})),rt.canvas.classList.add("phantom"),lt=xe({...ht,shape:8,colors:"ab",pos:[8,0,4],className:"pointer"}),bt(ot),re(),setInterval(Et,15),it(),g("LMB to switch current character, walk around and pick/place items. RMB to use items (such as Bed). Middle buton and wheel to control the camera."),oe(localStorage[O])}var wt,$t=0,St=0,Mt=0;function Et(){let e=Date.now(),t=Math.min(1e3,e-$t||1);wt=Xe().reduce((e,t)=>x(e,t.aspects),{}),~~((Mt+t)/1e3)>~~(Mt/1e3)&&Xe().forEach(e=>{(function(e){let t=T(e.aspects),n=c(wt);if((Xe().length+3)*T(e.aspects)/(e.level+3)>a(100)){let i=.01*~~(t-e.level+1);e.aspects[n]=Math.max(0,e.aspects[n]-i),he(e,`forgot ${v(i)} of ${b[n].name} `),Le(e,n)}})(e),e.sleeper&&e.sleeper++}),Mt+=t,$t=e;let n=Date.now();St=.9*St+1e3/t*.1,FPS.innerText="FPS: "+~~St,Object.values(gt).forEach(e=>{(e.actionsQueue.length||e.animation)&&$e(e),e.deadAt&&n>e.deadAt&&Ce(e),1==e.kind&&!function(e){return ce(e).dream}(e)&&t>3e3*a()&&Ge(e)}),yt.forEach(e=>{e.dream&&(e.dur+=t)}),ct?.held||(rt.div.style.opacity="0")}</script>