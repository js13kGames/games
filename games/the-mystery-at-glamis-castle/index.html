<!doctype html><style>@font-face{font-family:emoji;src:url(https://cdn.jsdelivr.net/npm/twemoji-colr-font@14.0.2/twemoji.woff2)}#c{position:absolute;top:0;left:0;right:0;bottom:0;width:100%;height:100%;touch-action:none}#playButton{color:#fff;background:#000;border-radius:12px;padding:15px 25px;font-size:32px;border:2px solid transparent}#playButton:hover{background-color:#666;border:2px solid #000}#playButton:active{background-color:#0065bf}</style><title>JS13k Jam 2023</title><script src=/2023/webxr/babylon.js></script><div id=intro style="text-align:center;font-family:Helvetica,sans-serif;max-width:420px;margin:0 auto"><h1>The Mystery at Glamis Castle</h1><h2>Created By Alex Swan</h2><h2>For JS13KGames 2023</h2><p>It is 1290 Scotland, and following the death of Queen Margaret there was no clear successor (the Great Cause). Witches placed a spell on Glamis Castle and whoever could solve the puzzles and enter will claim the kingdom.<p>Use a WebXR Pointer or WASD/Mouse to move and interact.</p><button id=playButton>PLAY</button></div><canvas id=c style=display:none></canvas><div id=extra></div><script>(()=>{"use strict";const e="#dc3220",t="#12b212",n="#0a650a",s="#fefe62",o="#ffc20a",i="#ffffff",r="#666666",a="#000000",l="#0065BF",c=window.location.search.includes("debug"),h=e=>e[Math.floor(Math.random()*e.length)],d=(e=512)=>{const t=document.createElement("canvas");t.width=e,t.height=e;const n=t.getContext("2d");return[t,n]},{StandardMaterial:p,Texture:u}=BABYLON;let B=0;const m=(e=!0,t,n)=>{const[s,o]=d(512);o.fillStyle="#c5a296",o.fillRect(0,0,s.width,s.height);const l=16/t,c=32/t;o.save(),o.strokeStyle=a,o.lineWidth=4;const p=["#dd7d7d","#cb6b6b","#b65454","#9e3333","#842020"];for(let e=0;e*l<s.height;e++)for(let t=0;t*c<s.width;t++){o.fillStyle=h(p);const n=e%2?0:-.5*c;o.fillRect(t*c+n,e*l,c-1,l-1),0===t&&o.fillRect(t*c+s.width+n,e*l,c-1,l-1)}return o.restore(),e&&(o.fillStyle=r,o.fillRect(192,128,128,256),o.strokeStyle=i,o.lineWidth=16,o.strokeRect(192,128,128,256),o.beginPath(),o.moveTo(256,128),o.lineTo(256,384),o.moveTo(192,224),o.lineTo(320,224),o.stroke()),w(s,n)},g=(e,t)=>{const n=new p("billboardMaterial"+ ++B,t);return n.diffuseColor=BABYLON.Color3.FromHexString(e),n},w=(e,t)=>{const n=new p("material"+ ++B,t),s=u.LoadFromDataString("texture"+ ++B,e.toDataURL(),t);return s.hasAlpha=!0,n.diffuseTexture=s,n},b=e=>{const[t,n]=d(512);return n.fillStyle="#c5a296",n.fillRect(0,0,t.width,t.height),n.save(),n.strokeStyle=a,n.lineWidth=4,n.fillStyle="#30312D",n.fillRect(0,0,t.width,t.height),["#4A4B46","#484848","#4E523F","#63645F","#64655f"].forEach((e=>{n.fillStyle=e;for(let e=0;e<128;e++){const e=Math.random()*(t.width-16)+8,s=Math.random()*(t.height-16)+8;n.beginPath(),n.moveTo(e,s),n.arc(e,s,8,0,2*Math.PI),n.fill()}})),w(t,e)},v=(e,t)=>{const[n,s]=d(512);s.fillStyle=o,s.fillRect(0,0,n.width,n.height),s.fillStyle=a;const i=n.width/e.length;return s.font=`${i}px Helvetica`,s.scale(1,n.height/i),s.textBaseline="middle",s.textAlign="center",e.forEach(((e,t)=>{s.strokeStyle=r,s.strokeRect(t*i,0,(t+1)*i,i),s.fillText(`${e}`,t*i+.5*i,.5*i)})),w(n,t)},O={},f=(e,t)=>{const n=e.join("");if(O[n])return O[n];const[s,i]=d(512);if(i.fillStyle=o,i.fillRect(0,0,s.width,s.height),i.fillStyle=a,i.font="64px Helvetica",i.scale(1,3),i.textBaseline="top",i.textAlign="left",e.length>0){const t=28672/i.measureText(e[0]).width;i.font=`${t}px Helvetica`}e.forEach(((e,t)=>{i.fillText(`${e}`,32,32+72*t)}));const r=w(s,t);return O[n]=r,r},A=e=>{const[t,n]=d(512);return n.fillStyle=l,n.fillRect(128,0,256,512),n.fillStyle=o,n.fillRect(192,64,128,128),n.beginPath(),n.moveTo(256,256),n.arc(256,256,64,0,2*Math.PI),n.fill(),n.beginPath(),n.moveTo(256,320),n.lineTo(320,431),n.lineTo(192,431),n.fill(),w(t,e)},I=function(e){const t=BABYLON.Color3.FromHexString(e.color1||"#ff0000"),n=BABYLON.Color3.FromHexString(e.color2||"#0000ff"),s=e.scale||1,o=new BABYLON.NodeMaterial("node");o.mode=BABYLON.NodeMaterialModes.Material;const i=new BABYLON.InputBlock("position");i.visibleInInspector=!1,i.visibleOnFrame=!1,i.target=1,i.setAsAttribute("position");const r=new BABYLON.TransformBlock("WorldPos");r.visibleInInspector=!1,r.visibleOnFrame=!1,r.target=1,r.complementZ=0,r.complementW=1;const a=new BABYLON.InputBlock("World");a.visibleInInspector=!1,a.visibleOnFrame=!1,a.target=1,a.setAsSystemValue(BABYLON.NodeMaterialSystemValues.World);const l=new BABYLON.TransformBlock("World normal");l.visibleInInspector=!1,l.visibleOnFrame=!1,l.target=1,l.complementZ=0,l.complementW=0;const c=new BABYLON.InputBlock("normal");c.visibleInInspector=!1,c.visibleOnFrame=!1,c.target=1,c.setAsAttribute("normal");const h=new BABYLON.LightBlock("Lights");h.visibleInInspector=!1,h.visibleOnFrame=!1,h.target=3;const d=new BABYLON.InputBlock("cameraPosition");d.visibleInInspector=!1,d.visibleOnFrame=!1,d.target=1,d.setAsSystemValue(BABYLON.NodeMaterialSystemValues.CameraPosition);const p=new BABYLON.MultiplyBlock("Multiply");p.visibleInInspector=!1,p.visibleOnFrame=!1,p.target=4;const u=new BABYLON.GradientBlock("Gradient");u.visibleInInspector=!1,u.visibleOnFrame=!1,u.target=4,u.colorSteps=[],u.colorSteps.push(new BABYLON.GradientBlockColorStep(0,t)),u.colorSteps.push(new BABYLON.GradientBlockColorStep(1,n));const B=new BABYLON.SimplexPerlin3DBlock("SimplexPerlin3D");B.visibleInInspector=!1,B.visibleOnFrame=!1,B.target=4;const m=new BABYLON.ScaleBlock("Scale");m.visibleInInspector=!1,m.visibleOnFrame=!1,m.target=4;const g=new BABYLON.InputBlock("Scale");g.visibleInInspector=!1,g.visibleOnFrame=!1,g.target=1,g.value=s,g.min=0,g.max=0,g.isBoolean=!1,g.matrixMode=0,g.animationType=BABYLON.AnimatedInputBlockTypes.None,g.isConstant=!0;const w=new BABYLON.FragmentOutputBlock("FragmentOutput");w.visibleInInspector=!1,w.visibleOnFrame=!1,w.target=2,w.convertToGammaSpace=!1,w.convertToLinearSpace=!1,w.useLogarithmicDepth=!1;const b=new BABYLON.TransformBlock("WorldPos * ViewProjectionTransform");b.visibleInInspector=!1,b.visibleOnFrame=!1,b.target=1,b.complementZ=0,b.complementW=1;const v=new BABYLON.InputBlock("ViewProjection");v.visibleInInspector=!1,v.visibleOnFrame=!1,v.target=1,v.setAsSystemValue(BABYLON.NodeMaterialSystemValues.ViewProjection);const O=new BABYLON.VertexOutputBlock("VertexOutput");return O.visibleInInspector=!1,O.visibleOnFrame=!1,O.target=1,i.output.connectTo(r.vector),a.output.connectTo(r.transform),r.output.connectTo(b.vector),v.output.connectTo(b.transform),b.output.connectTo(O.vector),r.output.connectTo(h.worldPosition),c.output.connectTo(l.vector),a.output.connectTo(l.transform),l.output.connectTo(h.worldNormal),d.output.connectTo(h.cameraPosition),h.diffuseOutput.connectTo(p.left),r.xyz.connectTo(m.input),g.output.connectTo(m.factor),m.output.connectTo(B.seed),B.output.connectTo(u.gradient),u.output.connectTo(p.right),p.output.connectTo(w.rgb),o.addOutputNode(O),o.addOutputNode(w),o.build(),o},{TransformNode:T,Vector3:L}=BABYLON;class N{constructor(e){this.solved=!1,this.scene=e,this.parent=new T("Castle",this.scene),this.reset()}get model(){return this.parent}set position(e){this.parent.position=e}set scale(e){this.parent.scaling=e}isSolved(){return this.solved}reset(){[[-11.5,3,5,5,6,6],[-5.5,5,4,7,10,4],[0,5,3,4,10,6],[1.5,3,-3,9,6,6],[10.5,2.5,-4,9,5,4],[13.5,1,2,3,2,8],[14,2,7.5,4,4,3],[18.5,1.5,7.5,5,3,3],[22.5,1.5,8,3,3,4],[25,1,7.5,2,2,3],[22.5,1,1.5,3,2,9],[19.5,1,-4.5,9,2,3],[-5,12,4,8,4,2],[0,12,3,2,4,6],[6,3,7,12,6,4]].forEach(((e,t)=>{const[n,s,o,i,r,a]=e,l=BABYLON.MeshBuilder.CreateTiledBox(`castle-wall${t}`,{width:i,height:r,depth:a,tileSize:2},this.scene);l.position=new L(n,s,o),l.material=m(!0,.5,this.scene),l.checkCollisions=!0,l.setParent(this.parent);const c=BABYLON.MeshBuilder.CreateTiledBox(`castle-roof${t}`,{width:i-.01,height:.3,depth:a-.01,tileSize:2},this.scene);c.setParent(this.parent),c.position=new L(n,.5*r+s+.15,o),c.material=b(this.scene)})),[[-14,3.5,10,4,7,5],[-14,6,2,1,2,2],[-13.5,6.5,6,.5,1.5,0],[-13.5,6.5,4,.5,1.5,0],[-11.5,6.5,2.5,.5,1.5,0],[-9,10,2,2,3,4],[-9,14,4,1,2,1],[-9,10,6,2,3,4],[-6.5,11.5,2.5,1,3,3],[-3,5,2,4,10,0],[-2,12,3,2,3,1],[-2,10,0,2,3,4],[0,14,0,1,2,1],[2,10,0,2,3,4],[-3,6,-6,1,2,1],[-2.5,7,-3,.5,2,0],[0,7,-5.5,.5,2,0],[3,7,-5.5,.5,2,0],[6,3,-6,4,6,4],[15,5,-6,1,2,2],[21,3,10,1,2,2],[24,1.5,10,2,3,3]].forEach(((e,t)=>{const[n,s,o,i,r,l]=e,c=BABYLON.MeshBuilder.CreateCylinder(`turret${t}`,{height:r,diameter:i},this.scene);if(c.position=new L(n,s,o),c.material=m(!1,r/4,this.scene),c.checkCollisions=!0,c.setParent(this.parent),l){const e=BABYLON.MeshBuilder.CreateCylinder(`turret${t}`,{height:l,diameterBottom:1.1*i,diameterTop:0},this.scene);e.material=I({color1:"#043132",color2:a,scale:40}),e.position=new L(n,s+.5*(r+l),o),e.setParent(this.parent)}}))}}class M{constructor(){this.animations=[],this.scene=null}static get Instance(){return M._instance||(M._instance=new M),M._instance}initScene(e){this.scene||(this.scene=e,this.scene.registerBeforeRender((()=>{const e=Date.now();this.animations=this.animations.filter((t=>{const n=(s=(e-t.startTime)/(t.endTime-t.startTime),Math.min(Math.max(s,0),1));var s;return e>=t.endTime?(t.end.position&&(t.mesh.position=t.end.position),t.end.rotation&&(t.mesh.rotation=t.end.rotation),t.end.scaling&&(t.mesh.scaling=t.end.scaling),!1):(t.end.position&&(t.mesh.position=BABYLON.Vector3.Lerp(t.start.position,t.end.position,t.easeFunc.ease(n))),t.end.rotation&&(t.mesh.rotation=BABYLON.Vector3.Lerp(t.start.rotation,t.end.rotation,t.easeFunc.ease(n))),t.end.scaling&&(t.mesh.scaling=BABYLON.Vector3.Lerp(t.start.scaling,t.end.scaling,t.easeFunc.ease(n))),!0)}))})))}animateTransform(e){const{mesh:t,end:n}=e,s=e.duration||1e3,o=e.delay||0,i=e.ease||new BABYLON.QuadraticEase,r=Date.now();this.animations.push({mesh:t,start:{position:t.position,rotation:t.rotation,scaling:t.scaling},end:n,easeFunc:i,startTime:r+o,endTime:r+o+s})}}function y(...e){return S.play(...e)}const S={volume:.3,sampleRate:44100,x:new(window.AudioContext||webkitAudioContext),play:function(...e){return this.playSamples(this.buildSamples(...e))},playSamples:function(...e){const t=this.x.createBuffer(e.length,e[0].length,this.sampleRate),n=this.x.createBufferSource();return e.map(((e,n)=>t.getChannelData(n).set(e))),n.buffer=t,n.connect(this.x.destination),n.start(),n},buildSamples:function(e=1,t=.05,n=220,s=0,o=0,i=.1,r=0,a=1,l=0,c=0,h=0,d=0,p=0,u=0,B=0,m=0,g=0,w=1,b=0,v=0){const O=2*Math.PI;let f,A,I=this.sampleRate,T=l*=500*O/I/I,L=n*=(1+2*t*Math.random()-t)*O/I,N=[],M=0,y=0,S=0,Y=1,P=0,C=0,x=0;for(c*=500*O/I**3,B*=O/I,h*=O/I,d*=I,p=p*I|0,A=(s=s*I+9)+(b*=I)+(o*=I)+(i*=I)+(g*=I)|0;S<A;N[S++]=x)++C%(100*m|0)||(x=r?r>1?r>2?r>3?Math.sin((M%O)**3):Math.max(Math.min(Math.tan(M),1),-1):1-(2*M/O%2+2)%2:1-4*Math.abs(Math.round(M/O)-M/O):Math.sin(M),x=(p?1-v+v*Math.sin(O*S/p):1)*(x>0?1:-1)*Math.abs(x)**a*e*this.volume*(S<s?S/s:S<s+b?1-(S-s)/b*(1-w):S<s+b+o?w:S<A-g?(A-S-g)/i*w:0),x=g?x/2+(g>S?0:(S<A-g?1:(A-S)/g)*N[S-g|0]/2):x),f=(n+=l+=c)*Math.cos(B*y++),M+=f-f*u*(1-1e9*(Math.sin(S)+1)%2),Y&&++Y>d&&(n+=h,L+=h,Y=0),!p||++P%p||(n=L,l=T,Y=Y||1);return N},getNote:function(e=0,t=440){return t*2**(e/12)}},Y=()=>y(...[2.07,0,130.81,.01,.26,.47,3,1.15,,.1,,,.05,,,,.14,.26,.15,.02]),{TransformNode:P,MeshBuilder:C,Vector3:x}=BABYLON;let k=0;class E{constructor(e){this.setLines=e=>{this.billboard.material=f(e,this.scene)},this.setEndgame=()=>{this.billboard.material=f(["Thanks for playing!"],this.scene),this.billboard.rotation=x.Zero(),this.billboard.renderingGroupId=1},this.scene=e,this.parent=new P("InfoBillboard"+ ++k,e),this.billboard=C.CreatePlane("billboard",{width:3,height:1,sideOrientation:BABYLON.Mesh.DOUBLESIDE},e),this.billboard.setParent(this.parent),this.billboard.position=new x(0,.6,0),this.billboard.rotation.x=Math.PI/4}set position(e){this.parent.position=e}set rotation(e){this.billboard.rotation=e}get model(){return this.parent}}const{TransformNode:F,Vector3:z}=BABYLON;let R=0;const D=["Red cannot be next to","another Red"],V=["Number of flowers must be one","more or less than neighbor"],W=["Square must be placed","in a square shape"];class ${constructor(n,o){this.meshes=[],this.colors={R:e,G:t,B:"#1a85ff",Y:s,W:i,D:"#994f00"},this.solved=!1,this.scene=o,this.board=n.board,this.solvedEvent=n.solvedEvent,this.boardHeight=this.board.length,this.boardWidth=this.board[0].length,this.parent=new F("FlowerBoxPuzzle",this.scene),this.inventoryTransform=new F("Holding",this.scene);const r=o.getNodeByName("inventory-parent");this.inventoryTransform.setParent(r),this.inventoryTransform.position=z.Zero(),this.inventoryTransform.rotation=z.Zero(),this.selectedMesh=null,this.messageBoard=new E(this.scene),this.messageBoard.setLines([]),this.messageBoard.model.setParent(this.parent),this.messageBoard.model.position=new z(.5*this.boardWidth,0,.5),this.reset()}get model(){return this.parent}set position(e){this.parent.position=e}set scale(e){this.parent.scaling=e}cellAt(e,t,n){try{const s=this.board[t][e];return n&&(this.board[t][e]=n),s}catch{return null}}boardPos(e,t){return new z(1*e+.5,0,-1*t-.5)}groupedCellCount(e,t){const n=[`${e},${t}`],s=this.cellAt(e,t);let o=0;for(let e=0;e<n.length;e++){const[t,i]=n[e].split(","),r=parseInt(t),a=parseInt(i);if(this.cellAt(r,a)===s){o+=1;const e=[`${r+1},${a}`,`${r-1},${a}`,`${r},${a+1}`,`${r},${a-1}`];n.push(...e.filter((e=>!n.includes(e))))}}return o}isSolved(){if(this.solved)return!0;let e=!1;if(this.selectedMesh&&"D"!==this.selectedMesh.metadata.color&&(this.messageBoard.setLines([]),e=!0),e)return;let t=0;const n=[];let s=Number.MAX_SAFE_INTEGER,o=-1,i=Number.MAX_SAFE_INTEGER,r=-1;return this.board.forEach(((a,l)=>{e||a.forEach(((a,c)=>{if(e)return;const[h,d,p]=a.split(""),u=[this.cellAt(c+1,l),this.cellAt(c-1,l),this.cellAt(c,l+1),this.cellAt(c,l-1)];"R"===d&&u.some((e=>"R"===e?.split("")[1]))&&(this.messageBoard.setLines(D),e=!0),e||(parseInt(h)>0&&(u.every((e=>{if(!e)return!0;const[t,n,s]=e?.split("");return 0===parseInt(t)||parseInt(h)===parseInt(t)-1||parseInt(h)===parseInt(t)+1}))||(this.messageBoard.setLines(V),e=!0)),"C"===p&&(t+=1,s=Math.min(s,c),o=Math.max(o,c),i=Math.min(i,l),r=Math.max(r,l),n.push({x:c,y:l})))}))})),t>0&&t<4&&(e=!0),n.every(((e,t)=>!(e.x!==s&&e.x!==o||e.y!==i&&e.y!==r)))||(this.messageBoard.setLines(W),e=!0),e||(this.solved=!0),this.solved&&(Y(),this.messageBoard.setLines(["COMPLETE"]),this.solvedEvent&&this.solvedEvent()),this.solved}swapMesh(e){const t=e.metadata||{},{x:n,y:s}=t,o=this.selectedMesh?`${this.selectedMesh.metadata.count}${this.selectedMesh.metadata.color}${this.selectedMesh.metadata.shape}`:"";this.cellAt(n,s,o),this.selectedMesh&&(this.selectedMesh.metadata={...this.selectedMesh.metadata,picked:!1,x:n,y:s},this.placeFlower(this.selectedMesh),this.selectedMesh=null),e.metadata={...e.metadata,picked:!0},this.selectedMesh=e,this.placeFlower(this.selectedMesh),this.isSolved()}createFlower(e,n,s,o,i){const r=new BABYLON.Mesh("flower",this.scene);r.metadata={count:e,color:n,shape:s,x:o,y:i},r.onPointerPick=()=>{y(...[1.01,,275,.01,.01,.15,1,1.03,-3.7,,-93,.07,,,,-.1,,.5,.04,.09]),this.solved||this.swapMesh(r)};for(let o=0;o<e;o++){const i=BABYLON.MeshBuilder.CreateCylinder("stem"+ ++R,{height:.4,diameter:.1},this.scene);let a;i.setParent(r),i.position.y=.2,a="T"===s?BABYLON.MeshBuilder.CreateCylinder("head"+ ++R,{diameterBottom:0,diameterTop:.4,height:.4,tessellation:3},this.scene):"S"===s?BABYLON.MeshBuilder.CreateSphere("head"+ ++R,{diameter:.3},this.scene):BABYLON.MeshBuilder.CreateBox("head"+ ++R,{size:.25},this.scene),a.setParent(i),a.position=new z(0,.3,0),a.material=g(this.colors[n],this.scene),i.position=new z(0,.2,0),e>1&&i.rotateAround(z.Zero(),z.Right(),Math.PI/8),i.rotateAround(z.Zero(),z.Up(),2*o*Math.PI/e),i.material=g(t,this.scene)}const a=BABYLON.MeshBuilder.CreateCylinder("leaf",{diameter:.3,height:.1},this.scene);return a.setParent(r),a.position=new z(.15,.15,0),a.material=g(t,this.scene),r}createBush(){const e=new BABYLON.Mesh("bush",this.scene),s=BABYLON.MeshBuilder.CreateBox("head",{height:.2,width:.9,depth:.9},this.scene);return s.setParent(e),s.position=new z(0,.1,0),s.material=I({color1:t,color2:n,scale:100}),e}createEmpty(e,t){const n=new BABYLON.Mesh("empty",this.scene);n.onPointerPick=()=>{this.solved||this.swapMesh(n)},n.metadata={count:1,color:"D",shape:"",x:e,y:t};const s=BABYLON.MeshBuilder.CreateBox("head",{height:.2,width:.4,depth:.4},this.scene);return s.setParent(n),s.position=new z(0,.1,0),s.material=g(this.colors.D,this.scene),n}placeFlower(e){if(e.metadata.picked)return e.setParent(this.inventoryTransform),M.Instance.animateTransform({mesh:e,end:{position:z.Zero(),rotation:z.Zero(),scaling:new z(.25,.25,.25)},duration:200}),e.renderingGroupId=1,e.isPickable=!1,void e.setEnabled("D"!==e.metadata.color);const{x:t,y:n}=e.metadata;e.setParent(this.parent),M.Instance.animateTransform({mesh:e,end:{position:this.boardPos(t,n),rotation:z.Zero(),scaling:z.One()},duration:200}),e.isPickable=!0,e.setEnabled(!0),e.renderingGroupId=0}reset(){this.meshes.forEach((e=>{e.dispose()})),this.selectedMesh=null;const e=BABYLON.MeshBuilder.CreateGround("flower-puzzle-ground",{width:this.boardWidth,height:this.boardHeight});e.material=((e,t,n,s,o)=>{const[i,r]=d(512);r.imageSmoothingEnabled=!1;const a=512/n,l=512/s;r.fillStyle=e,r.fillRect(0,0,i.width,i.height),r.fillStyle=t;for(let e=0;e<s;e++)for(let t=0;t<n;t++)(t+e)%2||r.fillRect(t*a,e*l,a,l);const c=new p("material"+ ++B,o),h=u.LoadFromDataString("texture"+ ++B,i.toDataURL(),o);return c.diffuseTexture=h,c})(t,n,this.boardWidth,this.boardHeight,this.scene),e.setParent(this.parent),e.position=new z(.5*this.boardWidth,.02,-.5*this.boardHeight);for(let e=-1;e<this.boardHeight+1;e++)for(let t=-1;t<this.boardWidth+1;t++){if(e>=0&&e<this.boardHeight&&t>=0&&t<this.boardWidth)continue;const n=this.createBush();n.setParent(this.parent),n.name=`bush${t},${e}`,n.position=this.boardPos(t,e)}this.board.forEach(((e,t)=>{e.forEach(((e,n)=>{let s;const[o,i,r]=e.split("");switch(i){case"":return;case"R":case"Y":case"B":case"W":s=this.createFlower(parseInt(o),i,r,n,t),s.name=`cell${n}-${t}`,this.placeFlower(s)}}))})),this.selectedMesh=this.createEmpty(-1,-1),this.selectedMesh.metadata={...this.selectedMesh.metadata,picked:!0},this.placeFlower(this.selectedMesh),this.solved=!1}}const G=function(e){const t=e.baseColor?BABYLON.Color4.FromHexString(`${e.baseColor}FF`):BABYLON.Color4.FromHexString("#243DA6FF"),n=e.rippleColor?BABYLON.Color4.FromHexString(`${e.rippleColor}FF`):BABYLON.Color4.FromHexString("#0AD6E0FF"),s=e.frozen||!1,o=new BABYLON.NodeMaterial("node"),i=new BABYLON.InputBlock("position");i.visibleInInspector=!1,i.visibleOnFrame=!1,i.target=1,i.setAsAttribute("position");const r=new BABYLON.TransformBlock("WorldPos");r.visibleInInspector=!1,r.visibleOnFrame=!1,r.target=1,r.complementZ=0,r.complementW=1;const a=new BABYLON.InputBlock("World");a.visibleInInspector=!1,a.visibleOnFrame=!1,a.target=1,a.setAsSystemValue(BABYLON.NodeMaterialSystemValues.World);const l=new BABYLON.TransformBlock("WorldPos * ViewProjectionTransform");l.visibleInInspector=!1,l.visibleOnFrame=!1,l.target=1,l.complementZ=0,l.complementW=1;const c=new BABYLON.InputBlock("ViewProjection");c.visibleInInspector=!1,c.visibleOnFrame=!1,c.target=1,c.setAsSystemValue(BABYLON.NodeMaterialSystemValues.ViewProjection);const h=new BABYLON.VertexOutputBlock("VertexOutput");h.visibleInInspector=!1,h.visibleOnFrame=!1,h.target=1;const d=new BABYLON.InputBlock("TwirlCenter");d.visibleInInspector=!1,d.visibleOnFrame=!1,d.target=1,d.value=new BABYLON.Vector2(.5,.5),d.isConstant=!1;const p=new BABYLON.VectorSplitterBlock("VectorSplitter");p.visibleInInspector=!1,p.visibleOnFrame=!1,p.target=4;const u=new BABYLON.AddBlock("Add");u.visibleInInspector=!1,u.visibleOnFrame=!1,u.target=1;const B=new BABYLON.VectorMergerBlock("VectorMerger");B.visibleInInspector=!1,B.visibleOnFrame=!1,B.target=1,B.xSwizzle="x",B.ySwizzle="y",B.zSwizzle="z",B.wSwizzle="w";const m=new BABYLON.SubtractBlock("Subtract (x)");m.visibleInInspector=!1,m.visibleOnFrame=!1,m.target=1;const g=new BABYLON.MultiplyBlock("Multiply");g.visibleInInspector=!1,g.visibleOnFrame=!1,g.target=1;const w=new BABYLON.TrigonometryBlock("Cos");w.visibleInInspector=!1,w.visibleOnFrame=!1,w.target=4,w.operation=BABYLON.TrigonometryBlockOperations.Cos;const b=new BABYLON.MultiplyBlock("Strength x Delta Lergth");b.visibleInInspector=!1,b.visibleOnFrame=!1,b.target=1;const v=new BABYLON.InputBlock("TwirlStrength");v.visibleInInspector=!1,v.visibleOnFrame=!1,v.target=1,v.value=2,v.min=0,v.max=0,v.isBoolean=!1,v.matrixMode=0,v.animationType=BABYLON.AnimatedInputBlockTypes.None,v.isConstant=!1;const O=new BABYLON.LengthBlock("Delta (Length)");O.visibleInInspector=!1,O.visibleOnFrame=!1,O.target=1;const f=new BABYLON.SubtractBlock("Delta (Subtract)");f.visibleInInspector=!1,f.visibleOnFrame=!1,f.target=1;const A=new BABYLON.InputBlock("uv");A.visibleInInspector=!1,A.visibleOnFrame=!1,A.target=1,A.setAsAttribute("uv");const I=new BABYLON.VectorSplitterBlock("VectorSplitter");I.visibleInInspector=!1,I.visibleOnFrame=!1,I.target=1;const T=new BABYLON.MultiplyBlock("Multiply");T.visibleInInspector=!1,T.visibleOnFrame=!1,T.target=1;const L=new BABYLON.TrigonometryBlock("Sin");L.visibleInInspector=!1,L.visibleOnFrame=!1,L.target=1,L.operation=BABYLON.TrigonometryBlockOperations.Sin;const N=new BABYLON.AddBlock("Add (y)");N.visibleInInspector=!1,N.visibleOnFrame=!1,N.target=1;const M=new BABYLON.MultiplyBlock("Multiply");M.visibleInInspector=!1,M.visibleOnFrame=!1,M.target=1;const y=new BABYLON.TrigonometryBlock("Cos");y.visibleInInspector=!1,y.visibleOnFrame=!1,y.target=1,y.operation=BABYLON.TrigonometryBlockOperations.Cos;const S=new BABYLON.MultiplyBlock("Multiply");S.visibleInInspector=!1,S.visibleOnFrame=!1,S.target=1;const Y=new BABYLON.TrigonometryBlock("Sin");Y.visibleInInspector=!1,Y.visibleOnFrame=!1,Y.target=4,Y.operation=BABYLON.TrigonometryBlockOperations.Sin;const P=new BABYLON.VoronoiNoiseBlock("VoronoiNoise");P.visibleInInspector=!1,P.visibleOnFrame=!1,P.target=4;const C=new BABYLON.AddBlock("Add");C.visibleInInspector=!1,C.visibleOnFrame=!1,C.target=4;const x=new BABYLON.InputBlock("Time");x.visibleInInspector=!1,x.visibleOnFrame=!1,x.target=1,x.value=0,x.min=0,x.max=0,x.isBoolean=!1,x.matrixMode=0,x.animationType=s?BABYLON.AnimatedInputBlockTypes.None:BABYLON.AnimatedInputBlockTypes.Time,x.isConstant=s;const k=new BABYLON.InputBlock("Offset");k.visibleInInspector=!1,k.visibleOnFrame=!1,k.target=1,k.value=666,k.min=0,k.max=0,k.isBoolean=!1,k.matrixMode=0,k.animationType=BABYLON.AnimatedInputBlockTypes.None,k.isConstant=!0;const E=new BABYLON.InputBlock("Scale");E.visibleInInspector=!1,E.visibleOnFrame=!1,E.target=1,E.value=12,E.min=0,E.max=0,E.isBoolean=!1,E.matrixMode=0,E.animationType=BABYLON.AnimatedInputBlockTypes.None,E.isConstant=!1;const F=new BABYLON.ColorMergerBlock("ColorMerger");F.visibleInInspector=!1,F.visibleOnFrame=!1,F.target=4,F.rSwizzle="r",F.gSwizzle="g",F.bSwizzle="b",F.aSwizzle="a";const z=new BABYLON.InputBlock("ColorAlpha");z.visibleInInspector=!1,z.visibleOnFrame=!1,z.target=1,z.value=1,z.min=0,z.max=0,z.isBoolean=!1,z.matrixMode=0,z.animationType=BABYLON.AnimatedInputBlockTypes.None,z.isConstant=!0;const R=new BABYLON.MultiplyBlock("Multiply");R.visibleInInspector=!1,R.visibleOnFrame=!1,R.target=4;const D=new BABYLON.InputBlock("RippleColor");D.visibleInInspector=!1,D.visibleOnFrame=!1,D.target=1,D.value=n,D.isConstant=!1;const V=new BABYLON.MaxBlock("Max");V.visibleInInspector=!1,V.visibleOnFrame=!1,V.target=4;const W=new BABYLON.InputBlock("BaseColor");W.visibleInInspector=!1,W.visibleOnFrame=!1,W.target=1,W.value=t,W.isConstant=!1;const $=new BABYLON.FragmentOutputBlock("FragmentOutput");$.visibleInInspector=!1,$.visibleOnFrame=!1,$.target=2,$.convertToGammaSpace=!1,$.convertToLinearSpace=!1,$.useLogarithmicDepth=!1;const G=new BABYLON.InputBlock("Opacity");return G.visibleInInspector=!1,G.visibleOnFrame=!1,G.target=1,G.value=1,G.min=0,G.max=0,G.isBoolean=!1,G.matrixMode=0,G.animationType=BABYLON.AnimatedInputBlockTypes.None,G.isConstant=!1,i.output.connectTo(r.vector),a.output.connectTo(r.transform),r.output.connectTo(l.vector),c.output.connectTo(l.transform),l.output.connectTo(h.vector),d.output.connectTo(p.xyIn),p.xyOut.connectTo(u.left),v.output.connectTo(b.left),A.output.connectTo(f.left),p.xyOut.connectTo(f.right),f.output.connectTo(O.value),O.output.connectTo(b.right),b.output.connectTo(w.input),w.output.connectTo(g.left),f.output.connectTo(I.xyIn),I.x.connectTo(g.right),g.output.connectTo(m.left),b.output.connectTo(Y.input),Y.output.connectTo(S.left),I.y.connectTo(S.right),S.output.connectTo(m.right),m.output.connectTo(B.x),I.x.connectTo(T.left),b.output.connectTo(L.input),L.output.connectTo(T.right),T.output.connectTo(N.left),b.output.connectTo(y.input),y.output.connectTo(M.left),I.y.connectTo(M.right),M.output.connectTo(N.right),N.output.connectTo(B.y),B.xy.connectTo(u.right),u.output.connectTo(P.seed),x.output.connectTo(C.left),k.output.connectTo(C.right),C.output.connectTo(P.offset),E.output.connectTo(P.density),P.output.connectTo(F.r),P.output.connectTo(F.g),P.output.connectTo(F.b),z.output.connectTo(F.a),F.rgba.connectTo(R.left),D.output.connectTo(R.right),R.output.connectTo(V.left),W.output.connectTo(V.right),V.output.connectTo($.rgba),G.output.connectTo($.a),o.addOutputNode(h),o.addOutputNode($),o.build(),o},{TransformNode:Z,MeshBuilder:H,Vector3:U}=BABYLON;let _=0;const{TransformNode:j,Vector3:X,MeshBuilder:q}=BABYLON;class K{constructor(e){this.solved=!1,this.solvedCount=0,this.scene=e,this.puzzles=[],this.floors=[],this.parent=new j("Garden",this.scene),this.endgameSphere=null,this.reset()}get model(){return this.parent}set position(e){this.parent.position=e}set scale(e){this.parent.scaling=e}isSolved(){if(this.solved)return!0;this.solvedCount=0;for(let e=0;e<this.puzzles.length;e++)this.puzzles[e].solved&&(this.solvedCount+=1);if(this.solved=this.puzzles.length>0&&this.solvedCount===this.puzzles.length,this.solved){if(!this.endgameSphere)return;this.endgameSphere.setEnabled(!0),this.endgameSphere.scaling=X.Zero(),M.Instance.animateTransform({mesh:this.endgameSphere,end:{scaling:new X(1,1,1)},ease:new BABYLON.ExponentialEase(2),duration:1e3})}return this.solved}reset(){this.floors=[];const t=q.CreateTiledGround("Garden-ground",{xmin:-18,xmax:18,zmin:-6,zmax:10,subdivisions:{h:12,w:24}},this.scene);t.material=(e=>{const[t,n]=d(256);n.fillStyle="#6d4d41",n.fillRect(0,0,t.width,t.height),n.fillStyle="#49332b";for(let e=0;e<12;e++){const e=Math.random()*(t.width-12),s=Math.random()*(t.height-12);n.fillRect(e,s,12,12)}return w(t,e)})(this.scene),t.setParent(this.parent),t.position=new X(0,.01,0),this.floors.push(t),q.CreateTorus("fountain-edge",{diameter:4,thickness:1,tessellation:32},this.scene).setParent(this.parent);const n=q.CreateCylinder("fountain-water",{diameter:4,height:1,tessellation:32});n.material=G({}),n.checkCollisions=!0,n.setParent(this.parent);const o=q.CreateTorusKnot("fountain-statue",{tube:.1,radialSegments:128,p:5,q:2},this.scene);o.setParent(this.parent);const i=new X(0,1.5,0);o.position=i,o.rotation.x=Math.PI/2,o.scaling=new X(.5,.5,1.5),o.isPickable=!1,o.registerBeforeRender((e=>{this.solvedCount>0&&e.rotateAround(i,X.Up(),Math.PI/1700*this.scene.getEngine().getDeltaTime()),this.solvedCount>1&&e.rotateAround(i,X.Right(),Math.PI/800*this.scene.getEngine().getDeltaTime()),this.solvedCount>2&&e.rotateAround(i,X.Forward(),Math.PI/500*this.scene.getEngine().getDeltaTime())}));const r=(t=>{const n=new Z("Crown"+ ++_,t),o=[new U(.4,0,0),new U(.4,.1,0),new U(-.4,.1,0),new U(-.4,0,0)],i=[new U(3,2,0),new U(3,4,0),new U(2,5,0),new U(0,5,0),new U(-2,5,0),new U(-3,4,0),new U(-3,2,0)],r=[new U(3.4,0,0),new U(3.4,2,0),new U(3,2,0),new U(3,0,0)],l=H.ExtrudeShape("arch",{shape:o,path:i,closeShape:!0,cap:BABYLON.Mesh.CAP_ALL},t);l.material=g(s,t),l.setParent(n),l.clone("arch2").rotateAround(U.Zero(),U.Up(),Math.PI/2);const c=BABYLON.MeshBuilder.CreateLathe("cloth",{shape:i,radius:0,arc:.5,closed:!1,tessellation:12,sideOrientation:BABYLON.Mesh.DOUBLESIDE},t);c.material=I({color1:e,color2:a,scale:2}),c.setParent(n),c.scaling=new U(.95,.95,.95);const h=BABYLON.MeshBuilder.CreateSphere("crown-ball",{diameter:1},t);h.material=g(s,t),h.setParent(n),h.position.y=5.5;const d=BABYLON.MeshBuilder.CreateLathe("cloth",{shape:r,radius:0,closed:!0,tessellation:12,sideOrientation:BABYLON.Mesh.DOUBLESIDE},t);return d.material=g(s,t),d.setParent(n),n.scaling=new U(.25,.25,.25),n.getChildMeshes().forEach((e=>{e.renderingGroupId=1})),n})(this.scene);r.scaling=X.Zero(),r.setParent(this.parent);const l=new E(this.scene);this.endgameSphere=q.CreateSphere("endgame-sphere",{diameter:1,sideOrientation:BABYLON.Mesh.DOUBLESIDE},this.scene),this.endgameSphere.material=g(a,this.scene),this.endgameSphere.renderingGroupId=1,this.endgameSphere.setParent(this.parent),this.endgameSphere.position.y=1.5,this.endgameSphere.onPointerPick=()=>{Y(),M.Instance.animateTransform({mesh:this.endgameSphere,end:{scaling:new X(100,100,100)},ease:new BABYLON.ExponentialEase(2),duration:1e4}),M.Instance.animateTransform({mesh:r,end:{scaling:new X(.15,.15,.15)},duration:1e3,delay:500}),M.Instance.animateTransform({mesh:l.model,end:{scaling:X.One()},duration:1e3,delay:1e3})},c||this.endgameSphere.setEnabled(!1),r.position=this.endgameSphere.position,l.setEndgame(),l.model.setParent(this.parent),l.model.position=this.endgameSphere.position.add(new X(0,1.5,0)),l.model.scaling=X.Zero();const h=[[["1RT","1RT"],["2BT","2BT"]],[["0ET","2RC","0ET","0ET","1BS"],["2RC","0ET","1BS","0ET","0ET"],["0ET","2RC","0ET","1BS","0ET"],["2RC","0ET","1BS","0ET","1BS"],["0ET","1BS","0ET","0ET","0ET"]],[["3YT"],["1YT"],["1YT"],["2YT"],["2YT"]],[["0ET","0ET","3BS","0ET","0ET"],["0ET","2RS","3BC","3BS","0ET"],["2RS","2BS","1RC","3BC","1BS"],["0ET","1RS","3BS","1BC","0ET"],["0ET","0ET","2BS","0ET","0ET"]]],p=[new X(-15,0,6),new X(-9,0,2),new X(4,0,2),new X(9,0,5)];for(let e=0;e<h.length;e++){const t=p[e],n=new $({board:h[e],solvedEvent:()=>{this.isSolved()}},this.scene);n.model.setParent(this.parent),n.position=t,n.isSolved(),this.puzzles.push(n)}this.solved=!1}}const{TransformNode:Q,MeshBuilder:J,Vector3:ee}=BABYLON;let te=0;const{TransformNode:ne,Vector3:se}=BABYLON;class oe{constructor(e,t){this.solved=!1,this.updateDials=()=>{this.dials.forEach((e=>{const t=parseInt(e.metadata.alphabetIndex,10),n=2*Math.PI/this.alphabet.length,s=.5*Math.PI+.5*n+t*n;M.Instance.animateTransform({mesh:e,end:{rotation:new se(0,s,0)},duration:60})}))},this.scene=t,this.alphabet=e.alphabet?.split("")||Array.from("0123456789"),this.code=e.code?.split("")||Array.from("123"),this.guess=Array.from(this.alphabet[0].repeat(this.code.length)),this.parent=new ne("DialPuzzle",this.scene),this.parent.position=se.Zero(),this.dials=[],this.solvedEvent=e.solvedEvent?e.solvedEvent:()=>{},this.reset()}get model(){return this.parent}set scale(e){this.parent.scaling=e}isSolved(){return!!this.solved||(this.solved=this.code.every(((e,t)=>this.guess[t]===e)),this.solved&&(Y(),this.solvedEvent()),this.solved)}reset(){this.solved=!1,this.dials=[];const e=this.code.length,t=1*Math.sin(Math.PI/this.alphabet.length);for(let n=0;n<e;n++){const s=[];s[0]=new BABYLON.Vector4(0,0,0,0),s[1]=new BABYLON.Vector4(1,0,0,1),s[2]=new BABYLON.Vector4(0,0,0,0);const o=BABYLON.MeshBuilder.CreateCylinder(`dial-${n}`,{height:t,diameter:1,faceUV:s,tessellation:this.alphabet.length},this.scene);o.onPointerPick=()=>{if(y(...[,,76,.02,.02,.01,1,.44,,,,,,.5,,,,,.01,.57]),this.solved)return;const{index:e,alphabetIndex:t}=o.metadata,s=t+1;o.metadata={index:n,alphabetIndex:s},this.guess[e]=this.alphabet[s%this.alphabet.length],this.updateDials(),this.isSolved()},o.setParent(this.parent),o.position=new se(0,(e-n-1)*(t+.05)+.15,0),o.material=v(this.alphabet,this.scene),o.metadata={index:n,alphabetIndex:0},this.dials.push(o)}const n=BABYLON.MeshBuilder.CreateBox("dial-align",{height:(t+.05)*(e+1),width:.2,depth:.2});n.setParent(this.parent),n.position=new se(0,.15*e,-.26),n.material=g(l,this.scene);const s=BABYLON.MeshBuilder.CreatePlane("dial-banner",{},this.scene);s.setParent(this.parent),s.position=new se(0,.15*e+2,-.26),s.material=A(this.scene),this.updateDials()}}const{TransformNode:ie,MeshBuilder:re,Vector3:ae}=BABYLON;let le=0;const{TransformNode:ce,MeshBuilder:he,Vector3:de}=BABYLON;let pe=0;const ue=e=>{const t=new ce("Banner"+ ++pe,e),n=he.CreateGround("symbols",{width:4,height:4,subdivisions:12,updatable:!0},e);n.setParent(t),n.position=new de(0,2,0),n.rotation.x=3*Math.PI/2,n.material=A(e);let s=0;return n.registerBeforeRender((t=>{s+=e.getEngine().getDeltaTime();const n=t.getVerticesData(BABYLON.VertexBuffer.PositionKind);if(n){for(let e=0;e<n?.length;e+=3)n[e+1]=.1*(n[e+2]-2)*Math.sin(.8*s/100+n[e+2]);t.updateVerticesData(BABYLON.VertexBuffer.PositionKind,n)}})),t},{TransformNode:Be,MeshBuilder:me,Vector3:ge}=BABYLON;let we=0;const{MeshBuilder:be,TransformNode:ve,Vector3:Oe}=BABYLON;class fe{constructor(e){this.solved=!1,this.scene=e,this.puzzles=[],this.floors=[],this.bushes=[],this.trees=[],this.parent=new ve("Entrance",this.scene),this.reset()}get model(){return this.parent}set position(e){this.parent.position=e}set scale(e){this.parent.scaling=e}isSolved(){return!!this.solved||(this.solved=this.puzzles.length>0&&this.puzzles.every((e=>e.solved)),this.solved&&(this.bushes.forEach(((e,t)=>{e.position.z<-14||e.position.z>-12||M.Instance.animateTransform({mesh:e,end:{position:e.position.add(new Oe(0,3,0))},duration:4e3,delay:3e3})})),this.door&&M.Instance.animateTransform({mesh:this.door,end:{rotation:this.door.rotation.add(new Oe(-1*Math.PI/2,0,0))},duration:5e3})),this.solved)}reset(){this.floors=[];const e=be.CreateTiledGround("ground",{xmin:-10,xmax:12,zmin:-20,zmax:12,subdivisions:{w:11,h:16}});e.setParent(this.parent),e.material=b(this.scene),e.position.y=-.01,e.position=new Oe(0,.01,0);const t=[{shape:"box",count:3},{shape:"sphere",count:5},{shape:"triangle",count:4}];t.forEach(((e,t)=>{const n=((e,t)=>{const n=new Q("Tree"+ ++te,t),s=e.count||3,o=e.shape||"box",i=J.CreateCylinder("trunk"+ ++te,{diameter:.5,height:3,tessellation:6});i.material=I({color1:"#332211",color2:"#593b1d",scale:5}),i.setParent(n),i.position=new ee(0,1.5,0);for(let e=0;e<s;e++){let n;switch(o){case"box":n=J.CreateBox("shape"+ ++te,{size:1.5},t);break;case"triangle":n=J.CreateCylinder("shape"+ ++te,{diameterTop:0,diameterBottom:4,tessellation:3},t);break;case"sphere":n=J.CreateSphere("shape"+ ++te,{diameter:2},t)}if(!n)return;n.material=I({color1:"#00ff00",color2:"#332211",scale:25}),n.setParent(i),n.position.y=.75*e+.5,n.position.x=.25*(s-e),n.rotation=new ee(2*Math.random()*Math.PI,2*Math.random()*Math.PI,2*Math.random()*Math.PI),n.rotateAround(ee.Zero(),ee.Up(),2*Math.random()*Math.PI)}return n})(e,this.scene);n&&(n.setParent(this.parent),n.position=new Oe(0,0,-4*t+4),this.trees.push(n))}));const n=new oe({code:t.map((e=>e.count)).join(""),alphabet:"012345",solvedEvent:()=>{this.isSolved()}},this.scene);n.model.setParent(this.parent),n.model.position=new Oe(7.5,.5,11.5),n.model.rotation=new Oe(0,Math.PI/4,0),this.puzzles.push(n);const s=(e=>{const t=new ie("Door"+ ++le,e),n=[new ae(2,0,0),new ae(2,2,0),new ae(1.74,3,0),new ae(1,3.74,0),new ae(0,4,0),new ae(-1,3.74,0),new ae(-1.74,3,0),new ae(-2,2,0),new ae(-2,0,0)],s=[new ae(0,0,.5),new ae(0,0,-.5)],i=[new ae(.51,-.1,0),new ae(.51,0,0),new ae(-.51,0,0),new ae(-.51,-.1,0)],r=[new ae(0,0,0),new ae(0,4,0)],a=[new ae(.1,0,0),new ae(.2,0,0),new ae(.2,.05,0),new ae(.1,.05,0)],c=[new ae(1,.5,0),new ae(0,.5,0),new ae(0,1,0),new ae(-1,0,0),new ae(0,-1,0),new ae(0,-.5,0),new ae(1,-.5,0)],h=re.ExtrudeShape("door",{shape:n,path:s,closeShape:!0,cap:BABYLON.Mesh.CAP_ALL},e);h.material=I({color1:"#332211",color2:"#593b1d",scale:5}),h.setParent(t);const d=re.ExtrudeShape("frame",{shape:i,path:n,closeShape:!0,cap:BABYLON.Mesh.CAP_ALL},e);d.material=g("#888888",e),d.setParent(t);const p=re.ExtrudeShape("frame",{shape:i,path:r,closeShape:!0,cap:BABYLON.Mesh.CAP_ALL},e);p.material=g("#000000",e),p.setParent(t);const u=BABYLON.MeshBuilder.CreateLathe("handle",{shape:a,radius:1,closed:!0,tessellation:12,sideOrientation:BABYLON.Mesh.DOUBLESIDE},e);u.material=g("#000000",e),u.setParent(t),u.rotation.x=Math.PI/2,u.position=new ae(-.5,1,-.55),u.clone("handle2").position.x*=-1;const B=re.ExtrudeShape("door",{shape:c,path:s,closeShape:!0,cap:BABYLON.Mesh.CAP_ALL},e);return B.setParent(t),B.position=new ae(0,1,-1),B.material=G({baseColor:l,rippleColor:o}),B.rotateAround(new ae(0,0,-1),ae.Up(),Math.PI/4),B.rotateAround(new ae(0,0,1),ae.Right(),Math.PI/2),t})(this.scene);s.setParent(this.parent),s.position=new Oe(9.5,0,9.5),s.rotation=new Oe(0,Math.PI/4,0),this.door=s;const i=ue(this.scene);i.setParent(this.parent),i.position=new Oe(-5,8,11.5);const r=ue(this.scene);r.setParent(this.parent),r.position=new Oe(11.6,8,0),r.rotation=new Oe(0,Math.PI/2,0),this.floors.push(e);const a=(e=>{const t=new Be("Door"+ ++we,e),n=me.CreateBox("Bush"+ ++we,{width:.95,depth:.95,height:3},e);return n.setParent(t),n.position=new ge(0,1.5,0),n.material=I({color1:"#00ff00",color2:"#ff00ff",scale:60}),n.checkCollisions=!0,t})(this.scene);for(let e=0;e<16;e++){const t=a.clone(`Bush${e}`,this.parent,!1);t&&(t.position=new Oe(12.5,0,-19.5+e),this.bushes.push(t),c&&t.setEnabled(!1))}a.dispose(),this.solved=!1}}const{Engine:Ae,Scene:Ie,MeshBuilder:Te,HemisphericLight:Le,UniversalCamera:Ne,Vector3:Me,PointerEventTypes:ye}=BABYLON,Se=async()=>{let e=!1;document.getElementById("intro").style.display="none";const t=document.getElementById("c");t.style.display="block",t.addEventListener("click",(async()=>{document.pointerLockElement!==t&&await t.requestPointerLock({unadjustedMovement:!0})}));const n=new Ae(t,!0),s=new Ie(n);M.Instance.initScene(s),s.gravity=new Me(0,-.15,0),s.collisionsEnabled=!0,c&&s.debugLayer.show({embedMode:!0}),n.displayLoadingUI();const o=new Ne("MainCamera",new Me(-23,1.615,13.5),s);o.inertia=0,o.speed=3,o.keysUp.push(87),o.keysDown.push(83),o.keysLeft.push(65),o.keysRight.push(68),o.keysUpward.push(69),o.keysDownward.push(81),o.attachControl(t,!0),o.angularSensibility=500,o.applyGravity=!0,o.ellipsoid=new Me(.4,.8,.4),o.checkCollisions=!0,o.minZ=.1,s.onPointerObservable.add((t=>{if(t.type!==ye.POINTERDOWN)return;if(!s)return;if(!e&&0!==t.event.button)return;const o=e?t.pickInfo:s.pick(n.getRenderWidth()/2,n.getRenderHeight()/2);let i=o?.pickedMesh;for(;i&&!i.onPointerPick;)i=i.parent;i&&i.onPointerPick&&i.onPointerPick()})),n.runRenderLoop((()=>{s.render()})),window.addEventListener("resize",(()=>{n.resize()}));const r=new BABYLON.TransformNode("inventory-parent",s);r.setParent(s.activeCamera),r.position=new Me(-.5,0,2);const p=BABYLON.MeshBuilder.CreatePlane("cursor",{},s);p.isPickable=!1,p.material=(e=>{const[t,n]=d(512);n.imageSmoothingEnabled=!1,n.lineCap="round",n.beginPath(),n.moveTo(250,256),n.lineTo(262,256),n.moveTo(256,250),n.lineTo(256,262),n.lineWidth=2,n.strokeStyle=a,n.stroke(),n.lineWidth=1.5,n.strokeStyle=i,n.stroke();const s=w(t,e);return s.disableLighting=!0,s.emissiveColor=BABYLON.Color3.White(),s.diffuseTexture.hasAlpha=!0,s})(s),p.setParent(o),p.position=new Me(0,0,1.1),p.renderingGroupId=1,new Le("light",new Me(-.5,1,0),s);const u=new Le("light",new Me(.5,-1,0),s),B=BABYLON.MeshBuilder.CreateSphere("skybox",{diameter:200,sideOrientation:BABYLON.Mesh.DOUBLESIDE},s),m=I({color1:l,color2:i,scale:.1});B.material=m,B.infiniteDistance=!0,u.includedOnlyMeshes.push(B);const g=Te.CreateTiledGround("ground",{xmin:-50,xmax:100,zmin:-20,zmax:80,subdivisions:{w:20,h:10}});g.material=(e=>{const[t,n]=d(512),[s,o]=d(2*t.width),i=t.width/32;o.save();const r=["#abb348","#7ca244","#426d38","#799c45","#a7af48"],a=[];for(let e=0;e<32;e++)for(let t=0;t<32;t++)a.push({x:t,y:e});const l=(e=>{for(let t=e.length-1;t>1;t--){const n=Math.floor(Math.random()*t),s=e[t];e[t]=e[n],e[n]=s}return e})(a);return o.translate(.25*s.width,.25*s.height),l.forEach((e=>{const{x:t,y:n}=e;o.save(),o.fillStyle=h(r),o.translate(t*i,n*i);const a=1*Math.random()+1,l=Math.random()*Math.PI;o.save(),o.scale(a,a),o.rotate(l),o.fillRect(-.5*i,-.5*i,i,i),o.restore(),0==t&&(o.save(),o.translate(.5*s.width,0),o.save(),o.scale(a,a),o.rotate(l),o.fillRect(-.5*i,-.5*i,i,i),o.restore(),o.restore()),0==n&&(o.save(),o.translate(0,.5*s.height),o.save(),o.scale(a,a),o.rotate(l),o.fillRect(-.5*i,-.5*i,i,i),o.restore(),o.restore()),o.restore()})),o.restore(),n.drawImage(s,.25*s.width,.25*s.height,.5*s.width,.5*s.height,0,0,t.width,t.height),w(t,e)})(s),g.checkCollisions=!0,g.position.y=-.01;const b=new fe(s);b.position=new Me(-15,0,32);const v=new N(s);v.position=new Me(3,0,40),v.scale=new Me(2,2,2),o.setTarget(new Me(-1,10,43));const O=new K(s);O.position=new Me(15,0,18);const f=Te.CreateBox("bounds",{width:58,height:5,depth:32,sideOrientation:BABYLON.Mesh.BACKSIDE},s);f.position=new Me(4,0,28),f.checkCollisions=!0,f.visibility=0,n.hideLoadingUI();const A=await s.createDefaultXRExperienceAsync({floorMeshes:[...b.floors,...O.floors]});A.input.onControllerAddedObservable.add((e=>{e.onMotionControllerInitObservable.add((e=>{e.onModelLoadedObservable.add((e=>{r.setParent(e.rootMesh),r.position=new Me(0,.1,.1),r.rotation=Me.Zero()}))}))})),A.input.onControllerRemovedObservable.add(((e,t)=>{r.setParent(s.activeCamera),r.position=new Me(-.5,0,2),r.rotation=Me.Zero()})),A.baseExperience.onStateChangedObservable.add((t=>{e=t===BABYLON.WebXRState.IN_XR,p.isEnabled(!e),e||(r.setParent(s.activeCamera),r.position=new Me(-.5,0,2),r.rotation=Me.Zero())}))};window.addEventListener("DOMContentLoaded",(()=>{document.getElementById("playButton").onclick=Se}))})()</script>