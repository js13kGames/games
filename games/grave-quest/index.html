<title>grave.quest</title><style>*{margin:0;width:100%;height:100vh}button#StartXr{font-size:6vmax;font-weight:700;font-family:sans-serif;display:none;position:absolute;top:0;left:0;right:0;width:10em;height:2em;opacity:.5}</style><button id=StartXr>Play in XR</button><canvas id=Canvas></canvas><script>const CubeShader={},PosShader={},VelShader={},NmeMeta="\n#define Range(mn,mx,v)\t((v-mn)/(mx-mn))\n#define Range01(mn,mx,v)\tclamp(Range(mn,mx,v),0.0,1.1)\n#define Lerp(mn,mx,v)\t( mn + ((mx-mn)*v) )\n#define dataFetch(t)\ttexelFetch(t,ivec2(Cubexy),0)\n#define dataWrite(v)\tv\n#define SpriteMat(t)\tmat4(CUBESIZE,oooo,CUBESIZE,oooo,CUBESIZE,0,t,1)\nuniform vec4 WavePositions[WAVEPOSITIONCOUNT];\n#define SPRITEDIM\tvec3(SPRITEW,0,0)\n#define CHARDIM\tvec3(CHARW,CHARH,0)\n#define SpriteXyzw(si,wh)\tvec4(texelFetch(SpritePositions,ivec2(Cubexy.x,si),0).xyz-(wh/2.0),1)\n#define WaveXyz(wv)\t(WavePositions[wv%WAVEPOSITIONCOUNT].xyz*vec3(5,4,0)+vec3(0,4,-10))\n#define Nmexyz\t(SpriteMat(Dead?HeartPos0:WaveXyz(NmeIndex))*SpriteXyzw(SpriteIndex,SPRITEDIM)).xyz\n#define NmePos\tmix(Nmexyz,HeartPos0,WavePositions[NmeIndex%WAVEPOSITIONCOUNT].w)\n#define NmeIndex\tint(Sloti)\n#define NmeIndexf\tfloat(NmeIndex)\n#ifndef Cubexy\n#define Cubexy\tgl_FragCoord\n#endif\n#define\tFragIndex\t(int(Cubexy.x) + (int(Cubexy.y)*DATAWIDTH))\n\n#define\tActorCount\tMAX_ACTORS\n#define ProjectileRow\t(ActorCount+0)\n#define HeartRow\t(ActorCount+1)\n#define CharRow\t(Sloti-(ActorCount+2))\n#define WeaponRow\t(ActorCount+6)\n#define Sloti\tint(Cubexy.y)\n#define Slot_IsActor\t(Sloti<ActorCount)\n#define Slot_IsProjectile\t(Sloti==ProjectileRow)\n#define Slot_IsHeart\t(Sloti==HeartRow)\n#define Slot_IsChar\t(CharRow>=0&&CharRow<=2)\n#define Slot_IsFloor\t(FragIndex==DATALAST)\n#define Projectilei\tint(Cubexy.x)\n#define FetchProjectile(t,p)\ttexelFetch(t,ivec2(p,ProjectileRow),0)\n#define Slot_IsWeapon\t(Sloti==WeaponRow && Weaponi < MAX_WEAPONS)\n#define Weaponi\tint(Cubexy.x)\n\n#define Type\tVel4.w\n#define Typei\tint(Type)\n#define Type_IsStatic\t(Typei<=STATIC)\n#define Type_IsNull\t(Typei==NULL)\n#define Type_IsDebris\t(Typei==DEBRIS||Typei==DEBRISHEART||Typei==DEBRISBLOOD)\n#define Type_IsDebrisHeart\t(Typei==DEBRISHEART)\n#define Type_IsDebrisBlood\t(Typei==DEBRISBLOOD)\n#define Type_IsSprite\t(Typei>=SPRITE0)\n#define Type_IsAsleep\t(Typei<0)\n//#define SpriteIndex\t((abs(Typei)-SPRITE0)%SPRITECOUNT)\n#define SpriteIndex\t\t(Typei>0?0 : abs(Typei)-SPRITE0 )\n\n#define PPerChar\t20\n#define CharBuffer\t(STRINGCOUNT*16)\n#define Chari\t(int(Cubexy.x)+(CharRow*DATAWIDTH))\n#define CharP\t(Chari%PPerChar)\n#define CharN\tint(Chari/PPerChar)\n\nuniform mat4 String[STRINGCOUNT];\n#define CharLineW\t10\n#define CharOrigin\tvec3(-float(CharLineW)*0.5*0.4,1,-8)\n#define CharKern\tvec3(0.48,-0.45,1)\n#define CharPos(n)\tCharOrigin+vec3(n%CharLineW,int(n/CharLineW),0)*CharKern\n\n#define Charxyz(n,s)\t(CameraToWorld * SpriteMat(CharPos(n)) * texelFetch( SpritePositions, ivec2(CharP,s), 0 )).xyz\n#define CharS\tint(String[CharN/16][CharN%16/4][CharN%4])\n#define CharXyz\t(Charxyz(CharN,CharS))\n#define Charw\tint(texelFetch( SpritePositions, ivec2(CharP,CharS), 0 ).w)\n#define CharNull\t(Charw==0)\n\n#define HeartPos(sxyz)\t(CameraToWorld * SpriteMat(vec3(0,-0.6,-1.5)) * sxyz ).xyz\n#define HeartPos0\tHeartPos(vec4(ooo1))\n#define HeartXyz\tHeartPos(SpriteXyzw(SPRITEHEART,CHARDIM))\n\nuniform vec4 Heart;\n#define HeartCooldown\tint(Heart.y)\n#define Livesf\tmax(0.0,Heart.x)\n#define Dead\t(Livesf<1.0)\n#define FirstFrame\t(Heart.z<=0.0)\n#define NmeLiveCount\tHeart.w\n\nuniform mat4 CameraToWorld;\n\nuniform vec4 ProjectileVel[MAX_PROJECTILES];\nuniform vec4 ProjectilePos[MAX_PROJECTILES];\nuniform mat4 WeaponPoses[MAX_WEAPONS];\nuniform vec4\tRandom4;\nuniform sampler2D OldVelocitys;\nuniform sampler2D NewVelocitys;\nuniform sampler2D OldPositions;\nuniform sampler2D NewPositions;\nuniform sampler2D SpritePositions;\n\n#define RAND1\t(Pos4.w)\n#define UP\tvec3(0,1,0)\n";function Dot3(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function Subtract3(e,t){return e.map(((e,n)=>e-t[n]))}function Inc3(e,t){[0,1,2].map((n=>e[n]+=t[n]))}function Normalise3(e,t=1){let n=Math.hypot(...e);return e.map((e=>e/n*t))}function Cross3(e,t,n,a,o,r){return[t*r-n*o,n*a-e*r,e*o-t*a]}PosShader.Vert="\nout vec2 uv;\nvoid main()\n{\n#define c(n,u,v)\tcase n:uv=vec2(u,v);break;\nswitch(gl_VertexID){c(0,0,0)c(1,1,0)c(2,1,1)c(3,0,1)}\ngl_Position=vec4(uv*2.0-1.0,0,1);\n}\n",PosShader.Frag=`out vec4 xyzw;\nin vec2 uv;\n${NmeMeta}\n#define xyz\txyzw.xyz\nvoid main()\n{\nvec4 Vel4 = dataFetch(OldVelocitys);\nxyzw = dataFetch(OldPositions);\nif ( FirstFrame )\n{\n\txyz = (SpriteMat(xyz)*SpriteXyzw(SpriteIndex,SPRITEDIM)).xyz;\n\tif ( !Type_IsStatic )xyz = NmePos;\n\tif ( Slot_IsHeart )xyz = HeartXyz;\n\tif ( Slot_IsChar )xyz = CharXyz;\n}\nelse\n{\n\txyz += Vel4.xyz * TIMESTEP;\n}\nif ( Slot_IsProjectile && ProjectilePos[Projectilei].w > 0.0 )\n\txyz = ProjectilePos[Projectilei].xyz;\nxyz.y = max( xyz.y, float(FLOORY) );\nxyz = dataWrite(xyz);\n}\n`,CubeShader.Vert=`out vec2 FragCubexy;\nout vec3 FragWorldPosition;\nout vec4 Velocity;\nout float Rand1;\nuniform mat4 WorldToCameraTransform;\nuniform mat4 CameraProjectionTransform;\n\n#define Cubexy\tFragCubexy\n${NmeMeta}\n\nvec3 GetLocalPosition(int v)\n{\nint x = ivec4(915775499,923195439,642272978,49129)[v/30]>>v%30;\nreturn sign(vec3(x&1,x&2,x&4));\n}\n\n#define FloorCubeSize (FLOORSIZE/CUBESIZE)\n#define FloorTransform\tmat4(FloorCubeSize,0,ooo1,oooo,FloorCubeSize,0,0,float(FLOORY)-CUBESIZE,0,1)\n#define WEAPON_SCALE\t0.3\n#define WEAPON_SCALE_MAT\tmat4( WEAPON_SCALE,0,0,0,\t0,WEAPON_SCALE,0,0,\t0,0,WEAPON_SCALE,0,\t0,0,0,1 )\n\nmat4 GetLocalToWorldTransform()\n{\n\tif ( Slot_IsFloor )\treturn FloorTransform;\n\tif ( Slot_IsWeapon )\treturn WeaponPoses[Weaponi]*WEAPON_SCALE_MAT;\n\n\tvec4 OldPosition4 = dataFetch(OldPositions);\n\tvec4 Position4 = dataFetch(NewPositions);\n\tRand1 = Position4.w;\n\tvec3 WorldPosition = Position4.xyz;\n\n\tmat4 Transform = mat4( 1,0,ooo1,0,ooo1,0,WorldPosition,1 );\n\treturn Transform;\n}\nfloat VelocityStretch = 3.0;\n#define ENABLE_STRETCH\t(FLOAT_TARGET && !Slot_IsFloor)\nvec3 GetWorldPosition(mat4 LocalToWorldTransform,vec3 LocalPosition)\n{\n\tLocalPosition *= CUBESIZE;\n\tVelocity = dataFetch(NewVelocitys);\n\tvec3 WorldPos = (LocalToWorldTransform * vec4(LocalPosition,1.0)).xyz;\n\tvec3 TailDelta = -Velocity.xyz * VelocityStretch * TIMESTEP;\n\tif ( !ENABLE_STRETCH || length(TailDelta)<CUBESIZE)\n\t\treturn WorldPos;\n\tvec3 OriginWorldPos = (LocalToWorldTransform * vec4(ooo1)).xyz;\n\tvec3 LocalPosInWorld = WorldPos - OriginWorldPos;\n\tvec3 NextPos = WorldPos - (TailDelta*0.9);\n\tvec3 PrevPos = WorldPos + (TailDelta*0.1);\n\tfloat Scale = dot( normalize(LocalPosInWorld), normalize(-TailDelta) );\n\tScale=Scale>0.0?1.0:0.0;\n\tWorldPos = mix(PrevPos,NextPos,Scale);\n\treturn WorldPos;\n}\nvoid main()\n{\n\tint CubeIndex = gl_VertexID / (3*2*6);\n\tFragCubexy = vec2( CubeIndex%DATAWIDTH, (CubeIndex/DATAWIDTH) );\n\tint VertexOfCube = gl_VertexID % (3*2*6);\n\tvec3 LocalPosition = GetLocalPosition( VertexOfCube*3 );\n\tmat4 LocalToWorldTransform = GetLocalToWorldTransform();\n\tvec3 WorldPosition = GetWorldPosition(LocalToWorldTransform,LocalPosition-0.5);\n\tvec4 CameraPos = WorldToCameraTransform * vec4(WorldPosition,1);\t//\tworld to camera space\n\tvec4 ProjectionPos = CameraProjectionTransform * CameraPos;\n\tgl_Position = ProjectionPos;\n\tFragWorldPosition = WorldPosition.xyz;\n}\n`,CubeShader.Frag=`out vec4 FragColor;\nin vec2 FragCubexy;\nin vec3 FragWorldPosition;\nin vec4 Velocity;\nin float Rand1;\nvec4 Light = vec4(ooo,LIGHTRAD);\n\n#define DEBUG_COLOURS\t\ttrue\n#define FLOOR_TILE_SIZE\t\t0.4\n#define FLOOR_COLOUR(Odd)\tvec3(Odd?0.2:0.1)\n#define PROJECTILE_COLOUR\tvec3(0.8,0.06,0.26)\n#define WEAPON_COLOUR\t\tvec3(0,1,1)\n#define HEART_COLOUR\t\tvec3(1,0,0)\n#define Cubexy\tFragCubexy\n${NmeMeta}\n\n\n\nvoid main()\n{\n\t//if ( FLOAT_TARGET )\n\t{\n\t\tFragColor = vec4(0,1,0,1);\n//\t\treturn;\n\t}\n\tvec4 Vel4 = Velocity;\n\tvec3 rgb = vec3(1,0,1);\n\n\tivec3 xz = ivec3(mod(FragWorldPosition/FLOOR_TILE_SIZE,vec3(2)));\n\tvec3 SpookyColour = mod( vec3(FragIndex), vec3(1234,100,7777) ) / vec3(1000,100,7777) * vec3(0.1,1,0.3);\n\n\tif ( Type_IsStatic )\trgb = vec3(1);\n\tif ( Type_IsDebris )\trgb = SpookyColour;//vec3(1,0,0);\n\tif ( Type_IsDebrisBlood )\n\t{\n\t\trgb = vec3(1,0,0);\n\t\tVel4=vec4(0);\n\t}\n\tif ( Type_IsSprite )\trgb = SpookyColour;\n\t//if ( Type_IsSprite )\trgb = vec3(0,1,0);\n\tif ( Slot_IsFloor )\n\t{\n\t\trgb = FLOOR_COLOUR(xz.x==xz.z);\n\t\tVel4*=0.0;\n\t}\n\telse if ( Type_IsNull )\t\tdiscard;\n\n\tif (Slot_IsProjectile)\n\t{\n\t\trgb = PROJECTILE_COLOUR;\n\t\tVel4*=0.2;\n\t}\n\tif (Slot_IsWeapon)\n\t{\n\t\trgb = WEAPON_COLOUR;\n\t\tVel4*=0.2;\n\t}\n\tif ( Slot_IsHeart )\n\t{\n\t\trgb = HEART_COLOUR;\n\t\tVel4*=0.2;\n\n\t\tif ( Dead )discard;\n\t\tif ( HeartCooldown >= HEARTCOOLDOWNFRAMES )\n\t\t\tdiscard;//rgb = vec3(0,0,1);\n\t\telse\n\t\t\tif ( (HeartCooldown%8) >= 4 )\n\t\t\t\tdiscard;\n\t}\n\n\trgb *= mix(0.7,1.0,Rand1);\n\n\tfloat Lit = 1.0 - min(1.0,length(FragWorldPosition-Light.xyz)/Light.w);\n\t//float Lit=1.0;\n\t/*\n\t//Lit *= Lit;\n\tLit*=4.0;\n\tLit = Lit < 1.0 ? 0.2 : 1.0;\n*/\n\trgb += vec3(Lit)*0.2;\n\tLit += min(9.9,length(Vel4.xyz)/4.0);\n\n\trgb *= vec3(Lit);\n\tFragColor = vec4(rgb,1);\n}\n`,VelShader.Vert=PosShader.Vert,VelShader.Frag=`out vec4 Vel4;\nin vec2 uv;\n${NmeMeta}\n\n#define GravityY\t16.0\n#define FloorDrag\tmix(0.3,0.8,RAND1*Random4.x)\n\n//\tgr: make this bigger based on velocity so sliding projectiles dont hit so much\n#define PROJECTILE_MAX_SIZE\t(CUBESIZE*5.0)\n#define PROJECTILE_MIN_SIZE\t(CUBESIZE*1.0)\n#define PROJECTILE_MIN_VEL\t10.0\n#define PROJECTILE_MAX_VEL\t40.0\n\n\nfloat TimeAlongLine3(vec3 Position,vec3 Start,vec3 End)\n{\n\tvec3 Direction = End - Start;\n\tfloat DirectionLength = length(Direction);\n\tif ( DirectionLength < 0.0001 )\n\t\treturn 0.0;\n\tfloat Projection = dot( Position - Start, Direction) / (DirectionLength*DirectionLength);\n\t\n\treturn Projection;\n}\n\nvec3 NearestToLine3(vec3 Position,vec3 Start,vec3 End)\n{\n\tfloat Projection = TimeAlongLine3( Position, Start, End );\n\t\n\t//\tclip to start & end of line\n\tProjection = clamp( Projection, 0.0, 1.0 );\n\n\tvec3 Near = mix( Start, End, Projection );\n\treturn Near;\n}\n\nvec3 hash32(vec2 p)\n{\n\tvec3 p3 = fract(p.xyx * vec3(.1031, .1030, .0973));\n\tp3 += dot(p3, p3.yzx+33.33);\n\treturn fract((p3.xxy+p3.yzz)*p3.zyx);\n}\n\n#define MOVINGf\t(Type_IsDebris?1.0:0.0)\n\n#define Vel Vel4.xyz\n\nvoid main()\n{\n\tVel4 = dataFetch(OldVelocitys);\n\tvec4 Pos4 = dataFetch(NewPositions);\n\tvec3 xyz = Pos4.xyz;\n\n\t//\tnew projectile data\n\tif ( Slot_IsProjectile && ProjectileVel[Projectilei].w > 0.0 )\n\t{\n\t\tVel = ProjectileVel[Projectilei].xyz;\n\t\tType = float(DEBRIS);\n\t}\n\n\tif ( FirstFrame && Slot_IsHeart )\n\t\tType = float(SPRITEHEART);\n\n\t//\tunset heartdebris'\n\tif ( Type_IsDebrisHeart )\n\t\tType = float(DEBRISBLOOD);\n\n\tfloat AirDrag = 0.01;\n\n\t//\tconvert from static to nme\n\tif ( NmeIndex < int(NmeLiveCount) && Type_IsAsleep )\n\t\tType = float(SPRITE0+NmeIndex);\n\n\n\t//\tspring to sprite position\n\tif ( Slot_IsChar )\n\t{\n\t\tfloat Speed = 10.0;\n\t\tAirDrag = 0.0;\n\t\tvec3 Delta = CharXyz - xyz;\n\t\t\n\t\tif ( CharNull || Typei!=STATIC )\tDelta=vec3(0,0,0);\n\t\tType = float(CharNull?NULL:STATIC);\n\n\t\t//if ( length(Delta) > 0.0 )\n\t\t//\tDelta = normalize(Delta) * min( length(Delta), Speed );\n\t\tVel = Delta/TIMESTEP*0.2;\n\t}\n\telse if ( Slot_IsHeart )\n\t{\n\t\tAirDrag = 0.12;\n\t\tfloat Speed = 1.2;\n\t\tvec3 Target = HeartXyz;\n\t\tvec3 Delta = Target - xyz;\n\t\tif ( length(Delta) > 0.0 )\n\t\t\tDelta = normalize(Delta) * min( length(Delta), Speed );\n\t\tVel += Delta;\n\t}\n\telse if ( !Slot_IsProjectile && Type_IsSprite )\n\t{\n\t\tVel *= 0.95;\n\t\tfloat Speed = 1.1;\n\t\tvec3 Target = NmePos;\n\t\tvec3 Delta = Target - xyz;\n\t\tif ( length(Delta) > 0.0 )\n\t\t\tDelta = normalize(Delta) * min( length(Delta), Speed );\n\t\tVel += Delta;\n\t}\n\n\n\tVel *= 1.0 - AirDrag;\n\tVel.y += MOVINGf * -GravityY * TIMESTEP;\n\n\t//\tcollisions\n\tif ( !Slot_IsProjectile && !Slot_IsHeart && !Type_IsDebris )\n\tfor ( int p=Dead?0:-1;\tp<MAX_PROJECTILES;\tp++ )\n\t{\n\t\tvec3 ppp_old = FetchProjectile(OldPositions,p).xyz;\n\t\tvec3 ppp_new = FetchProjectile(NewPositions,p).xyz;\n\t\tvec3 ppv = FetchProjectile(OldVelocitys,p).xyz;\n\n\t\t//\tneed to invalidate, but not working, so sometimes projectiles can cut through randomly (old to new pos)\n\t\tif ( ProjectilePos[p].w == 1.0 )\n\t\t\tppp_old = ppp_new = ProjectilePos[p].xyz;\n\n\t\tfloat Randomness = 0.6;\n\t\tfloat pplen = min( PROJECTILE_MAX_VEL,length(ppv) );\n\t\tfloat SizeScale = mix( PROJECTILE_MIN_SIZE, PROJECTILE_MAX_SIZE, Range01(PROJECTILE_MIN_VEL,PROJECTILE_MAX_VEL,pplen) );\n\n\t\tif ( p==-1 )\n\t\t{\n\t\t\tppp_old = ppp_new = HeartPos0;\n\t\t\tppv = vec3(0,0,-1);\n\t\t\tpplen = 42.0;\n\t\t\tRandomness = 0.35;\n\t\t\tSizeScale = PROJECTILE_MAX_SIZE;\n\t\t}\n\n\t\tvec3 ppp = NearestToLine3( xyz, ppp_old, ppp_new );\n\t\tbool Hit = length(ppp-xyz) < SizeScale;\n\t\tif ( !Hit )\n\t\t\tcontinue;\n\t\t\n\t\tvec3 RandDir = (hash32(uv*777.777)-0.5);\n\t\tVel = normalize( mix(normalize(ppv),normalize(RandDir),Randomness) );\n\t\tVel *= pplen * 0.4;\n\n\t\tType = float(Type_IsSprite&&p==-1&&HeartCooldown==0?DEBRISHEART:DEBRIS);\n\t}\n\n\tif ( xyz.y <= float(FLOORY) && !Slot_IsChar && !Slot_IsHeart )\n\t{\n\t\tVel = reflect( Vel*(1.0-FloorDrag), UP );\n\t\tVel.y = abs(Vel.y);\n\n\t\t//\tstop if tiny bounce\n\t\tif ( length(Vel) < GravityY*6.0*TIMESTEP )\n\t\t{\n\t\t\tVel = vec3(0);\n\t\t\tType = float(STATIC);\n\t\t}\n\t}\n\n\tVel = dataWrite(Vel);\n}\n`;const DegToRad=Math.PI/180,RadToDeg=1/DegToRad,Near=.01,Far=1e4,FovV=40,Up=[0,1,0];class Camera_t{constructor(){this.Position=[0,2,20],this.LookAt=[0,0,0]}GetProjectionMatrix(e){let t=[0,0,e[2]/e[3],1];if(this.ProjectionMatrix)return this.ProjectionMatrix;const n=t[2]/t[3];let a=1/Math.tan(40*DegToRad/2);return[a/n,0,0,0,0,a,0,0,0,0,-1.000002000002,-1,0,0,-.02000002000002,0]}get LocalRotation4x4(){if(this.Rotation4x4)return this.Rotation4x4;const e=this.GetProjectionMatrix([0,0,1,1])[11]<0;let t=e?this.LookAt:this.Position,n=Normalise3(Subtract3(e?this.Position:this.LookAt,t)),a=Normalise3(Cross3(...Up,...n)),o=Normalise3(Cross3(...n,...a));return[a[0],o[0],n[0],0,a[1],o[1],n[1],0,a[2],o[2],n[2],0,0,0,0,1]}get WorldToLocal(){let e=this.Position.map((e=>-e)),t=(new DOMMatrix).translate(...e);return new DOMMatrix(this.LocalRotation4x4).multiply(t)}get LocalToWorld(){return this.WorldToLocal.inverse()}GetWorldTransform(e){return this.LocalToWorld.translate(...e)}GetForward(e=1){let t=this.LookAt;this.Rotation4x4&&(t=this.LocalToWorld.transformPoint(new DOMPoint(0,0,-1)));let n=Subtract3(t,this.Position);return e?Normalise3(n,e):n}MovePositionAndLookAt(e){Inc3(this.Position,e),Inc3(this.LookAt,e)}GetLookAtRotation(){let e=this.GetForward(!1),t=Math.hypot(...e);e=Normalise3(e);let n=RadToDeg*Math.atan2(e[0],e[2]);return[RadToDeg*Math.asin(-e[1]),n,0,t]}SetLookAtRotation(e,t,n,a){e*=DegToRad;let o=Math.cos(e);t*=DegToRad;let r=[Math.sin(t)*o,-Math.sin(e),Math.cos(t)*o];this.LookAt=this.Position.map(((e,t)=>e+r[t]*a))}OnCameraFirstPersonRotate(e,t,n,a){let o=[t,e,n];!a&&this.LastyFpsPos||(this.StartPyrd=this.GetLookAtRotation(),this.LastyFpsPos=o);let r=this.LastyFpsPos.map(((e,t)=>.1*(e-o[t])));r[3]=0;let i=this.StartPyrd.map(((e,t)=>e+r[t]));this.SetLookAtRotation(...i)}}function GetTime(){return Math.floor(performance.now())}let Camera=new Camera_t;Camera.Position=[0,1.8,8],Camera.LookAt=[0,1.8,0];let CameraButton=2,InputState={0:{},1:{},2:{}},WeaponOffset=[0,-.5,-3.5],ButtonMasks=[1,4,2],MouseLastPos=null;function OnMouse(e){if(e.button==CameraButton&&"mousedown"==e.type&&(MouseLastPos=null),e.buttons&ButtonMasks[CameraButton]||document.pointerLockElement){let t=e.currentTarget.getBoundingClientRect(),n=e.pageX||e.clientX,a=e.pageY||e.clientY,o=n-t.left,r=a-t.top,i=null==MouseLastPos;MouseLastPos&&void 0!==e.movementX&&([o,r]=MouseLastPos),o-=e.movementX||0,r-=e.movementY||0,Camera.OnCameraFirstPersonRotate(-o,r,0,i),MouseLastPos=[o,r]}[1].forEach(((t,n)=>InputState[n].Down=!!(e.buttons&t)&&GetTime()))}function OnMouseWheel(e){let t=-.06*e.deltaY,n=Camera.GetForward(t);Camera.MovePositionAndLookAt(n)}function OnLockMouse(){Canvas.requestPointerLock&&(MouseLastPos=null,Canvas.requestPointerLock())}class DesktopXr{constructor(e){this.Camera=Camera,e.addEventListener("mousedown",OnMouse,!0),e.addEventListener("mousemove",OnMouse,!0),e.addEventListener("mouseup",OnMouse,!0),e.addEventListener("wheel",OnMouseWheel,!0),e.addEventListener("contextmenu",(e=>e.preventDefault()),!0),e.addEventListener("click",OnLockMouse)}GetInput(){for(let e in InputState)InputState[e].Transform=Camera.GetWorldTransform(WeaponOffset);return InputState}}let HeartHitCooldown,Lives,rc,gl,FloatTarget,MIN_GUI_MS=2e3,NmePixelCount=0,NmeLiveCount=0,NmeCount=0,NmeDeadCount=0,MAXLIVES=3,DRAWFLOOR=1;function GetTime(){return Math.floor(performance.now())}function ResetGame(){Lives=MAXLIVES,HeartHitCooldown=0,NmeLiveCount=0,NmeCount=0,NmeDeadCount=0}let XrSession,xr=navigator.xr;const OLD=0,NEW=1;let TextureTarget,PositionTextures=[],VelocityTextures=[],SpriteTextures=[];const Sprites=["a13b1a1b1a1b1a1b1a1b1a2b1a1b1a1b1a1b1a1b1a1b10a1b10a1b4a1b1a1b16a3b2a3b3a3b2a3b3a2b3a2b2a1b9a3b7a2","a15b3a8b3a8b3a8b3a8b3a8b3a4b22a4b3a8b3a4","a11b12a4b1a4b13a1b1a2b2a2b14a3b2a4b14a3b2a2b2a1b9a3b7a5b5a3","a16b1a9b3a5b2a1b1a1b2a6b1a1b2a1b2a3b1a2b1a1b1a5b1a2b1a2b2a6b1a16","a12b1a3b1a3b1a1b11a1b1a3b1a3b1a2b1a3b1a3b1a2b1a3b1a3b1a2b1a3b1a3b1a2b1a3b1a3b1a2b9a2b1a3b1a3b1a1b3a1b3a1b3a1b1a3b1a3b1a12","a12b4a6b2a2b2a5b2a2b2a5b2a2b2a6b4a6","a11b6a7b2a9b2a7b4a9b2a7","a12b5a6b2a11b2a10b2a6b4a6","a12b4a10b2a7b3a10b2a6b4a6","a15b1a6b6a6b1a2b1a8b1a1b1a9b2a6","a12b4a10b2a6b4a7b1a10b5a5","a12b4a6b2a2b2a5b5a7b2a10b3a6","a12b2a10b2a10b2a10b2a5b6a5","a12b4a6b2a2b2a6b4a6b2a2b2a6b4a6","a12b3a10b2a7b5a5b2a2b2a6b4a6","a22","a13b1a21b2a9b2a10b2a6","a14b1a9b3a7b5a5b7a5b2a1b2a5","a13b2a9b2a40","a12b5a16b1a1b1a1b1a1b1a5b1a3b1a5b1a1b1a1b1a1b1a4","a14b2a2b1a6b2a2b1a6b2a2b1a7b4a8b3a3","a11b1a2b1a7b1a2b1a7b1a2b1a7b3a8b2a9","a49b1a1b1a8b1a1b1a7b4a7b4a6b5a3","a45b1a1b1a8b1a1b1a7b4a7b4a7b4a7","a11b4a10b2a7b3a7b2a10b4a6","a13b2a9b2a9b2a9b2a7b6a5","a11b2a2b1a6b5a6b2a2b1a6b2a2b1a7b3a7","a11b2a2b1a6b4a7b2a2b1a6b2a2b1a6b4a7","a11b2a9b4a7b2a2b1a6b2a2b1a6b4a7","a11b5a6b2a9b4a7b2a10b4a6","a11b2a2b1a6b2a1b2a6b3a1b1a6b2a2b1a6b2a2b1a6","a11b2a10b2a10b2a8b2a1b1a6b2a2b1a6","a11b2a2b1a6b2a1b1a7b3a8b2a1b1a7b2a2b1a6","a12b4a6b2a2b1a6b2a1b2a6b2a10b4a6","a11b2a3b1a5b2a1b1a1b1a5b2a1b1a1b1a5b2a1b1a1b1a5b5a6","a12b3a7b2a2b1a6b2a2b1a6b2a2b1a7b3a7","a13b2a8b2a1b1a7b2a1b1a6b2a2b1a6b2a2b1a6","a11b4a7b2a2b1a6b4a7b2a2b1a7b3a7","a12b3a7b2a2b1a6b2a2b1a6b2a2b1a6b2a2b1a6","a14b2a7b3a7b2a2b1a6b2a2b1a6b2a2b1a7b3a7"],SpriteMap={" ":15,"!":16,"@":17,".":18,"~":19,"&":20,$:21,"*":22,">":23,S:24,T:25,A:26,R:27,P:28,E:29,N:30,Y:31,K:32,G:33,M:34,O:35,V:36,B:37,U:38,Q:39};function CharToSprite(e){return SpriteMap[e]||parseInt(e,36)+SPRITEZERO}const Alphabet="_abcdefghijklmnopqrstuvwzyz0123456789ABCDEFGHIJKLKMNOPQRSTUVWXYZ!@Â£$%^&*()-=+#~?";function CharToInt(e){return Alphabet.indexOf(e)}function IntToChar(e){return Alphabet.charAt(e)}function DecodeCoord(e){return e.split``.map(CharToInt)}function DecodeWave(e){return(e=e.match(/.{3}/g).map(DecodeCoord))[-1]=e[0],e}function findLastIndex(e,t){let n=[...e].reverse().findIndex(t);return n<0?n:e.length-1-n}function GetWavexy(e,t){t/=1e3,t-=2,t*=1.5;let n=findLastIndex(e,(e=>e[0]<=t)),a=n+1>=e.length?1:0,o=n+(1-a),r=e[n],i=e[o];if(!i)throw"out of sequence";t=Math.max(0,t-r[0]);let l=[1,2,0,0].map((e=>lerp(r[e],i[e],t))).map((e=>lerp(1,-1,e/10)));return l[3]=a,l}const Macros={ooo:[0,0,0],oooo:[0,0,0,0],ooo1:[0,0,0,1],FLOORSIZE:200.001,LIGHTRAD:30.01,WORLDSIZE:13.01,PI:3.1415926538,SPRITEW:11,SPRITEH:10,CHARW:6,CHARH:5,SPRITECOUNT:Sprites.length,DATAWIDTH:128,DATAHEIGHT:128,DATALAST:16130,MAX_PROJECTILES:30,MAX_WEAPONS:30,MAX_ACTORS:50,WAVEPOSITIONCOUNT:50,TIMESTEP:.016666,FLOORY:0,CUBESIZE:.06,STATIC:0,NULL:1,DEBRIS:2,DEBRISHEART:3,DEBRISBLOOD:3,SPRITE0:4,MAPSPRITE0:5,SPRITESPACE:SpriteMap[" "],SPRITEHEART:SpriteMap["@"],SPRITEZERO:5,STRINGCOUNT:2,HEARTCOOLDOWNFRAMES:240,ENTROPY_MIN:0,ENTROPY_MAX:1};function PadArray(e,t,n){for(;e.length<t;)e.push(n);return e.slice(0,t)}function PadPixels(e,t,n,a=DATAWIDTH){for(e=e||[oooo];e.length<a;)e.push(...e);return e.slice(0,a)}function InitArray(e,t){return Array(e).fill().map(t)}Object.assign(window,Macros);let Desktop,ForcedString,Waves=["__ia_dbdbciddifecffcdgfchfe","ciidieei_fhbgg_hfbie_jdbkc_lbbma_n_boda"].map(DecodeWave),ProjectileIndex=0,ProjectilePos=InitArray(MAX_PROJECTILES,(e=>oooo)),ProjectileVel=InitArray(MAX_PROJECTILES,(e=>oooo)),WeaponPoses={},FiredWeaponThisFrame=0,WEAPON_SOUND_DELAY_FRAMES=4,WeaponLastFired={},ClearColour=[.03,.13,.03],FireRepeatMs=40,WORLDW=.7*WORLDSIZE,WorldMin=[-WORLDW,FLOORY,3*-WORLDSIZE,0],WorldMax=[WORLDW,FLOORY,.4*WORLDSIZE,1],MapPositions=InitArray(DATAHEIGHT,RandomWorldPos);function lerp(e=0,t=1,n=Math.random()){return e+(t-e)*n}const plerp=()=>lerp();function CompileShader(e,t){const n=Object.entries(Macros).map((e=>`#define ${e[0]} ${e[1]}`)).join("\n"),a=gl.createShader(e);if(t=`#version 300 es\nprecision highp float;\n${n}\n${t}`,gl.shaderSource(a,t),gl.compileShader(a),!gl.getShaderParameter(a,gl.COMPILE_STATUS))throw`Failed to compile: ${gl.getShaderInfoLog(a)}`;return a}class RenderContext_t{constructor(e){gl=e.getContext("webgl2",{antialias:!0,xrCompatible:!0,premultipliedAlpha:!1,alpha:!0}),FloatTarget=gl.getExtension("EXT_color_buffer_float"),Macros.FLOAT_TARGET=!!FloatTarget,this.CubeShader=this.CreateShader(CubeShader),this.PosShader=this.CreateShader(PosShader),this.VelShader=this.CreateShader(VelShader),TextureTarget=gl.createFramebuffer()}CreateShader(e){const t=CompileShader(gl.FRAGMENT_SHADER,e.Frag),n=CompileShader(gl.VERTEX_SHADER,e.Vert);let a=gl.createProgram();if(gl.attachShader(a,n),gl.attachShader(a,t),gl.linkProgram(a),!gl.getProgramParameter(a,gl.LINK_STATUS))throw`Failed to link shader ${gl.getProgramInfoLog(a)}`;return a}}function RleToRgba(e,t,n,a=SPRITEW){return e=(e=e.replace(/(\w)(\d+)/g,((e,t,n)=>t.repeat(n)))).split``.map(((e,t)=>[t%a,t/a>>0,0,parseInt(e,36)-10])).filter((e=>!!e[3])),e.length?e:null}function ArrayFromTo(e,t){let n=[];for(;e!=t;e+=Math.sign(t-e))n.push(e);return n}function InitVelocityPixel(e,t){let n=ArrayFromTo(-MAPSPRITE0,-MAPSPRITE0-4);return n[Math.floor(Math.random()*n.length)],DATAWIDTH,[0,0,0,n[(t/DATAWIDTH>>0)%n.length]]}function RandomWorldPos(){return WorldMin.map(((e,t)=>lerp(e*ENTROPY_MAX,WorldMax[t]*ENTROPY_MAX)))}function InitPositionPixel(e,t){DATAWIDTH;let n=t/DATAWIDTH>>0;return MapPositions[n].slice(0,3).concat([Math.random()])}class State_Click{constructor(e){zzfx(...[,,446,,.07,,,.1,-8.5,-1,,,,,,,,.49,.09]),this.NextState=e,this.WasDown={}}async Update(){return this.Started?new this.NextState:this}UpdateInput(e,t){this.Time<MIN_GUI_MS||(this.Started|=this.WasDown[e]&&!t.Down,this.WasDown[e]=t.Down)}}class State_Start extends State_Click{constructor(){zzfx(...[,,446,,.07,,,.1,-8.5,-1,,,,,,,,.49,.09]),super(State_Game),this.Time=0,ForcedString="&$GRAVE   *>.QUEST!",ResetGame()}async Update(){return this.Time>MIN_GUI_MS&&(ForcedString="PRESS ANY  BUTTON!"),super.Update()}}class State_Game{constructor(){this.InGame=!0,this.Time=0,ForcedString=null,ResetGame(),this.LastSec=0}async Update(){Math.floor(GetTime()/1e3)>Math.floor(this.LastTime/1e3)&&zzfx(...[.9,.8,100,.01,.01,.12,,1.46,,-.5,-250,,,,,,,.59,.02]),this.LastTime=GetTime();let e=NmeLiveCount;return NmeLiveCount=Math.floor(this.Time/2e3),e!=NmeLiveCount&&zzfx(...[1.78,,322,.05,.16,.32,1,.52,,-6.5,4,.03,.03,.1,4.7,.2,.12,.64,.13]),Lives>0?this:new State_End}UpdateInput(e,t){}}class State_End extends State_Click{constructor(){super(State_Start),this.Time=1,ForcedString="  GAME      OVER"}}let State,BoundShader,ReadBuffer,ReadPxBuffer,zzfx,zzfxV,zzfxX;function OnInput(e){Object.entries(e).forEach((e=>{UpdateWeapon(...e),State.UpdateInput(...e)}))}function RenderCameras(e){let t=e[0].LocalToWorld;Update(),0==State.Time?(AllocTextures(PositionTextures,InitPositionPixel),AllocTextures(VelocityTextures,InitVelocityPixel)):Blit(VelocityTextures,rc.VelShader,t,ReadGpuState),Blit(PositionTextures,rc.PosShader,t),e.forEach(Render),PostFrame(),0==State.Time&&State.Time++}async function Bootup(e,t){rc=new RenderContext_t(e),Desktop=new DesktopXr(e);let n=PadArray(Sprites,DATAHEIGHT,"b1").map(RleToRgba).map(PadPixels).flat(2);for(AllocTextures(SpriteTextures,new Float32Array(n)),async function(){for(;t;){let e=await CreateXr(t);await e.WaitForEnd}}().catch(console.warn),State=new State_Start,function t(){window.requestAnimationFrame(t);let n=e.getBoundingClientRect(),a=Desktop.Camera,o=n.width,r=n.height;a.Viewport=[0,0,o,r],a.Alpha=1,a.FrameBuffer=null,e.width=o,e.height=r,RenderCameras([a])}();;)State=(await Promise.all([State.Update(),Yield(30)]))[0],State.Time>0&&(State.Time+=30)}function FireWeapon(e,t){function n(e,n,a,o=1){let r=t.transformPoint(new DOMPoint(e,n,a,o));return[r.x,r.y,r.z,1]}WeaponLastFired[e]=GetTime(),ProjectilePos[ProjectileIndex%MAX_PROJECTILES]=n(0,0,lerp(0,-1)),ProjectileVel[ProjectileIndex%MAX_PROJECTILES]=n(lerp(-1,1),lerp(0,0),lerp(-80,-90),0),ProjectileIndex++,FiredWeaponThisFrame<=0&&(zzfx(...[1.35,,172,.01,.06,.01,3,.2,-4.1,,,,,1.5,,,.01,.83,.02,.35]),FiredWeaponThisFrame=WEAPON_SOUND_DELAY_FRAMES)}function UpdateWeapon(e,t){WeaponPoses[e]=Array.from(t.Transform.toFloat32Array()),t.Down&&GetTime()-(WeaponLastFired[e]||0)>FireRepeatMs&&FireWeapon(e,t.Transform)}function Update(){OnInput(Desktop.GetInput()),HeartHitCooldown=Math.max(0,HeartHitCooldown-1)}function PostFrame(){ProjectilePos.forEach((e=>e[3]=0)),ProjectileVel.forEach((e=>e[3]=0)),FiredWeaponThisFrame--}function InitTexture(){let e=(e,t)=>gl.texParameteri(gl.TEXTURE_2D,e,t);e(gl.TEXTURE_MIN_FILTER,gl.NEAREST),e(gl.TEXTURE_MAG_FILTER,gl.NEAREST),e(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),e(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)}function AllocTextures(e,t){0==e.length&&e.push(null,null);const n=DATAWIDTH,a=DATAHEIGHT;t="function"!=typeof t?t:new Float32Array(InitArray(n*a,t).flat(2));const o=gl.RGBA,r=FloatTarget?gl.FLOAT:gl.UNSIGNED_BYTE,i=FloatTarget?gl.RGBA32F:gl.RGBA;FloatTarget||(t=new Uint8Array(t));for(let l of[0,1])e[l]=e[l]||gl.createTexture(),e[l].Size=[n,a],e[l].Type=r,gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,e[l]),gl.texImage2D(gl.TEXTURE_2D,0,i,n,a,0,o,r,t),InitTexture()}function BindShader(e){gl.useProgram(BoundShader=e)}function ul(e){return BoundShader[e]=BoundShader[e]||gl.getUniformLocation(BoundShader,e)}function SetUniformMat4(e,t){gl.uniformMatrix4fv(ul(e),0,t)}function SetUniformVector(e,t){let n=Math.min(4,t.length);gl[`uniform${n}fv`](ul(e),t)}function SetUniformTexture(e,t,n){gl.activeTexture(gl.TEXTURE0+t),gl.bindTexture(gl.TEXTURE_2D,n),gl.uniform1i(ul(e),t)}function Pass(e){gl.viewport(...e),gl.disable(gl.CULL_FACE),gl.scissor(...e),gl.enable(gl.SCISSOR_TEST)}function SetUniformStr(e,t){SetUniformMat4(e,PadArray(t.toString().split``.map((e=>CharToSprite(e))),16*STRINGCOUNT,SPRITESPACE))}function UpdateUniforms(){let e=NmeLiveCount-NmeCount,t="@@@@@     ".substr(5-Lives).substr(0,5);t+=` ~${e}`,HeartHitCooldown>0&&(t="~ ~ ~ ~ ~  ~ ~ ~ ~ "),SetUniformStr("String",ForcedString||t),SetUniformVector("Random4",oooo.map(plerp)),SetUniformVector("Heart",[Lives,HeartHitCooldown,State.Time,NmeLiveCount]),SetUniformVector("ProjectilePos",ProjectilePos.flat(4)),SetUniformVector("ProjectileVel",ProjectileVel.flat(4)),SetUniformMat4("WeaponPoses",Object.values(WeaponPoses).flat(4)),SetUniformTexture("OldPositions",0,PositionTextures[0]),SetUniformTexture("OldVelocitys",1,VelocityTextures[0]),SetUniformTexture("SpritePositions",2,SpriteTextures[0]),SetUniformVector("WavePositions",Array(WAVEPOSITIONCOUNT).fill().map(((e,t)=>GetWavexy(Waves[t%Waves.length],State.Time-2e3*t))).flat(2))}function Render(e){gl.bindFramebuffer(gl.FRAMEBUFFER,e.FrameBuffer),Pass(e.Viewport),gl.clearColor(...ClearColour,e.Alpha),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.enable(gl.DEPTH_TEST),BindShader(rc.CubeShader),UpdateUniforms(),SetUniformMat4("WorldToCameraTransform",e.WorldToLocal.toFloat32Array()),SetUniformMat4("CameraProjectionTransform",e.GetProjectionMatrix(e.Viewport)),SetUniformTexture("NewPositions",3,PositionTextures[1]),SetUniformTexture("NewVelocitys",4,VelocityTextures[1]),gl.drawArrays(gl.TRIANGLES,0,36*(DATALAST+DRAWFLOOR))}function Blit(e,t,n,a){n=n||Desktop.Camera.LocalToWorld,e.reverse();const o=e[1];gl.bindFramebuffer(gl.FRAMEBUFFER,TextureTarget),gl.bindTexture(gl.TEXTURE_2D,null),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,o,0),Pass([0,0,...o.Size]),gl.disable(gl.BLEND),gl.disable(gl.SCISSOR_TEST),BindShader(t),UpdateUniforms(),SetUniformVector("NmeLiveCount",[NmeLiveCount]),SetUniformTexture("NewPositions",3,PositionTextures[o!=PositionTextures[1]?1:0]),SetUniformMat4("CameraToWorld",n.toFloat32Array()),gl.drawArrays(gl.TRIANGLE_FAN,0,4),a&&a(e)}function CreatePromise(){let e,t,n=new Promise(((n,a)=>{e=n,t=a}));return n.Resolve=e,n.Reject=t,n}function Yield(e){let t=CreatePromise();return setTimeout(t.Resolve,e),t}async function ReadGpuState(e){const t=(await ReadTexture(e[1])).filter(((e,t)=>t%4==3));let n=NmeLiveCount-NmeCount;const a={};t.filter((e=>e>=SPRITE0)).forEach((e=>a[e]=(a[e]||0)+1)),NmePixelCount=t.filter((e=>e>=SPRITE0)).length,NmeCount=Object.keys(a).length,NmeDeadCount=Object.values(a).filter((e=>0==e)).length;let o=!1;t.filter((e=>e==DEBRISHEART)).length>0&&0==HeartHitCooldown&&(Lives--,State.InGame&&zzfx(...[2.07,,89,.01,.1,.6,3,3.76,.9,,,,,1.6,29,.4,.27,.41,.04,.36]),o=!0,HeartHitCooldown=HEARTCOOLDOWNFRAMES+1),!o&&NmeLiveCount-NmeCount>n&&HeartHitCooldown<=0&&State.InGame&&zzfx(...[2.7,,780,.02,.07,.15,1,2.1,-3.4,,-50,.17,,-.1,,,.06,.83,.15])}async function ReadTexture(e){return ReadBuffer=ReadBuffer||gl.createBuffer(),ReadPxBuffer=ReadPxBuffer||new(e.Type==gl.FLOAT?Float32Array:Uint8Array)(DATAWIDTH*DATAHEIGHT*4),gl.readPixels(0,0,DATAWIDTH,DATAHEIGHT,gl.RGBA,e.Type,ReadPxBuffer),ReadPxBuffer}async function GetSupportedSessionMode(){if(!xr)return!1;if(!xr.isSessionSupported&&!xr.supportsSession)throw"XR platform missing isSessionSupported and supportsSession";xr.isSessionSupported||(xr.isSessionSupported=async function(e){try{return await xr.supportsSession(e),!0}catch(e){return!1}});for(let e of"immersive-ar,immersive-vr,inline".split`,`)try{const t=await xr.isSessionSupported(e);if(!t)throw`XR SessionType ${e} not supported (${t})`;return e}catch(e){console.warn(e)}return!1}function GetXrAlpha(e){switch(e){case"additive":case"alpha-blend":return 0;default:return 1}}function GetStraightnessOfPoints(e){if(e.length<2)return 0;let t=[];for(let n=1;n<e.length;n++){const a=Normalise3(Subtract3(e[n-1],e[n-0]));t.push(a)}let n=[];for(let e=1;e<t.length;e++){const a=Dot3(t[e-1],t[e-0]);n.push(a)}let a=1;for(let e of n)a*=e;return a}function ExtractHandInputs(e,t,n,a){const o=Object.fromEntries(e.entries());let r=[];return["thumb","index-finger","middle-finger","ring-finger","pinky-finger"].forEach((function(e){let n=[`${i=e}-tip`,`${i}-phalanx-distal`,`${i}-phalanx-proximal`];var i;let l=!1;"index-finger"==e&&(l=GetStraightnessOfPoints(n.map((e=>a(o[e]))).filter((e=>null!=e)))>.87);for(let a of n){let i={};i.Name=`${t}_${e}_${a}`,i.Down=l&&a==n[0],i.XrSpace=o[a],r.push(i)}})),r}class XrDev{constructor(e){this.ReferenceSpace=e,this.WaitForEnd=CreatePromise(),this.Inputs={},XrSession.addEventListener("end",this.WaitForEnd.Resolve)}async InitLayer(){this.Layer=new XRWebGLLayer(XrSession,gl,{framebufferScaleFactor:1,antialias:!0}),XrSession.updateRenderState({baseLayer:this.Layer}),this.OnFrame(0,null)}OnFrame(e,t){XrSession.requestAnimationFrame(this.OnFrame.bind(this));const n=t?t.getViewerPose(this.ReferenceSpace):null;n&&(this.FrameUpdate_Input(t,n),RenderCameras(n.views.map((e=>this.GetViewCamera(t,n,e,this.Layer.framebuffer)))))}GetViewCamera(e,t,n,a){let o=this.Layer.getViewport(n),r={};return r.Alpha=GetXrAlpha(e.session.environmentBlendMode),r.FrameBuffer=a,r.Viewport=[o.x,o.y,o.width,o.height],r.LocalToWorld=new DOMMatrix(t.transform.matrix),r.WorldToLocal=new DOMMatrix(t.transform.inverse.matrix),r.GetProjectionMatrix=()=>n.projectionMatrix,r}FrameUpdate_Input(e,t){let n=this.ReferenceSpace;function a(t){let a=t?e.getPose(t,n):null;return a?new DOMMatrix(a.transform.matrix):null}function o(t){let a=t?e.getPose(t,n):null;if(!a)return null;let o=a.transform.position;return[o.x,o.y,o.z]}Object.entries(this.Inputs).forEach((e=>e[1].Active=!1));let r=(e,t,n)=>{let o=a(n),r=this.Inputs[e];(o||r)&&(r=r||{},r.Transform=o||r.Transform,r.Active=null!=o,r.Down=t&&r.Active,this.Inputs[e]=r)};Array.from(e.session.inputSources).forEach(function(e,t){const n=e.handedness;if(e.hand){const t=ExtractHandInputs(e.hand,n,a,o);for(let e of t)r(e.Name,e.Down,e.XrSpace)}else if(e.gamepad){if(!e.gamepad.connected)return;const t=(e.gamepad.buttons||[]).some((e=>e.pressed));r(n,t,e.targetRaySpace)}else console.warn(`Ignoring input ${n} #${t}`)}.bind(this)),OnInput(this.Inputs)}}async function CreateXr(e){const t=await GetSupportedSessionMode();if(0==t)throw"No XR support";const n=CreatePromise();e((function(){try{let e={optionalFeatures:"local,local-floor,bounded-floor,hand-tracking,high-fixed-foveation-level".split`,`};xr.requestSession(t,e).then((e=>n.Resolve(e))).catch((e=>n.Reject(e)))}catch(e){n.Reject(e)}})),XrSession=await n;let a="bounded-floor,local-floor,local,unbounded,viewer".split`,`,o=await async function(){for(let e of a)try{return await XrSession.requestReferenceSpace(e)}catch{}throw"No XR reference space"}(),r=new XrDev(o);return await r.InitLayer(),r}function StartXrCallback(e){const t=document.querySelector("#StartXr");t.style.display="block",t.onclick=function(){t.style.display=null,e()}}zzfxV=.3,zzfx=(e=1,t=.05,n=220,a=0,o=0,r=.1,i=0,l=1,s=0,c=0,d=0,f=0,u=0,b=0,T=0,S=0,p=0,m=1,P=0,h=0)=>{let E,C,I=Math,g=44100,R=2*I.PI,x=s*=500*R/g/g,A=n*=(1-t+2*t*I.random(t=[]))*R/g,y=0,v=0,L=0,O=1,D=0,_=0,M=0;for(c*=500*R/g**3,T*=R/g,d*=R/g,f*=g,u=g*u|0,C=(a=g*a+9)+(P*=g)+(o*=g)+(r*=g)+(p*=g)|0;L<C;t[L++]=M)++_%(100*S|0)||(M=i?1<i?2<i?3<i?I.sin((y%R)**3):I.max(I.min(I.tan(y),1),-1):1-(2*y/R%2+2)%2:1-4*I.abs(I.round(y/R)-y/R):I.sin(y),M=(u?1-h+h*I.sin(R*L/u):1)*(0<M?1:-1)*I.abs(M)**l*e*zzfxV*(L<a?L/a:L<a+P?1-(L-a)/P*(1-m):L<a+P+o?m:L<C-p?(C-L-p)/r*m:0),M=p?M/2+(p>L?0:(L<C-p?1:(C-L)/p)*t[L-p|0]/2):M),E=(n+=s+=c)*I.cos(T*v++),y+=E-E*b*(1-1e9*(I.sin(L)+1)%2),O&&++O>f&&(n+=d,A+=d,O=0),!u||++D%u||(n=A,s=x,O=O||1);return(e=zzfxX.createBuffer(1,C,g)).getChannelData(0).set(t),(n=zzfxX.createBufferSource()).buffer=e,n.connect(zzfxX.destination),n.start(),n},zzfxX=new(window.AudioContext||webkitAudioContext),Bootup(Canvas,StartXrCallback)</script>