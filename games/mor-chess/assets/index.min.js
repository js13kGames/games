const e=""+new URL("sprites_with_bg_alpha_working-Dg1GmqR1.png",import.meta.url).href;function t(e,t,o){return e<t?Math.min(e+o,t):e>t?Math.max(e-o,t):e}function o(e,t){let[o,i,n,s]=e,[r,a,l,h]=t;return o<r+l&&o+n>r&&i<a+h&&i+s>a}function i(e){let o,i,n,s,r,a=!1,l=0;function h(t){return[t[0]*e.width,t[1]*e.height]}return function(e,t){const o=e=>{let[t,o]=(e=>{if(e.clientX||0===e.clientX)return[e.clientX,e.clientY]})(e)??[0,0];return[(t-i.left)/i.width,(o-i.top)/i.height]};let i,n=e.getContext("2d");function s(){i=e.getBoundingClientRect(),n.imageSmoothingEnabled=!1}function r(){s()}s(),e.addEventListener("pointerdown",function(i){e.setPointerCapture(i.pointerId);let n=o(i);t.on_down(n)},{passive:!1}),e.addEventListener("pointermove",function(e){let i=o(e);t.on_move(i)},{passive:!1}),document.addEventListener("pointerup",function(e){let i=o(e);t.on_up(i)}),new ResizeObserver(s).observe(e),document.addEventListener("scroll",r,{capture:!0,passive:!0}),window.addEventListener("resize",r,{passive:!0})}(e,{on_down(e){e=h(e),n=void 0,i=e,s=e,a=!1},on_up(e){e=h(e),i=void 0,o=void 0,n=e},on_move(e){e=h(e),o=e,a=!0}}),{get is_hovering(){return o},get is_down(){return i},get is_up(){return n},get is_just_down(){return s},get is_double_click(){return r},get has_moved_after_last_down(){return a},update(e){r=void 0,s&&l>0&&(r=s,l=0),l=t(l,0,e),s=void 0,n=void 0}}}let n=440*Math.pow(Math.pow(2,1/12),-9),s=/^[0-9.]+$/,r=/\s+/,a=/(\d+)/,l={};"B#-C|C#-Db|D|D#-Eb|E-Fb|E#-F|F#-Gb|G|G#-Ab|A|A#-Bb|B-Cb".split("|").forEach(function(e,t){e.split("-").forEach(function(e){l[e]=t})});class h{frequency;duration;constructor(e){let t=e.split(r);var o;this.frequency=function(e){var t=e.split(a),o=l[t[0]],i=(parseInt(t[1])||4)-4;return n*Math.pow(Math.pow(2,1/12),o)*Math.pow(2,i)}(t[0])||0,this.duration=(o=t[1],(s.test(o)?parseFloat(o):o.toLowerCase().split("").reduce(function(e,t){return e+("w"===t?4:"h"===t?2:"q"===t?1:"e"===t?.5:"s"===t?.25:0)},0))||0)}}class c{cx;tempo;notes;loop;smoothing;staccato;eqs;gain;osc;wave_type;constructor(e,t=120,o=[],i=!0){this.cx=e,this.tempo=t,this.osc=null,this.create_fx_nodes(),this.loop=i,this.smoothing=0,this.staccato=0,this.notes=[],this.push(o)}push(e){this.notes.push(...e.map(e=>new h(e)))}create_fx_nodes(){var e=this.gain=this.cx.createGain();return this.eqs={bass:void 0,mid:void 0,treble:void 0},[["bass",100],["mid",1e3],["treble",2500]].forEach(t=>{let o=this.eqs[t[0]]=this.cx.createBiquadFilter();o.type="peaking",o.frequency.value=t[1],e.connect(e=o)}),e.connect(this.cx.destination),this}create_oscillator(){return this.stop(),this.osc=this.cx.createOscillator(),this.osc.type=this.wave_type||"square",this.osc.connect(this.gain),this}schedule_note(e,t){var o=60/this.tempo*this.notes[e].duration,i=o*(1-(this.staccato||0));return this.set_frequency(this.notes[e].frequency,t),this.smoothing&&this.notes[e].frequency&&this.slide(e,t,i),this.set_frequency(0,t+i),t+o}get_next_note(e){return this.notes[e<this.notes.length-1?e+1:0]}get_slide_start_delay(e){return e-Math.min(e,60/this.tempo*this.smoothing)}slide(e,t,o){var i=this.get_next_note(e),n=this.get_slide_start_delay(o);return this.set_frequency(this.notes[e].frequency,t+n),this.ramp_frequency(i.frequency,t+o),this}set_frequency(e,t){return this.osc.frequency.setValueAtTime(e,t),this}ramp_frequency(e,t){return this.osc.frequency.linearRampToValueAtTime(e,t),this}play(e){return e="number"==typeof e?e:this.cx.currentTime,this.create_oscillator(),this.osc.start(e),this.notes.forEach((t,o)=>{e=this.schedule_note(o,e)}),this.osc.stop(e),this.osc.onended=this.loop?()=>this.play(e):null,this}stop(){return this.osc&&(this.osc.onended=null,this.osc.disconnect(),this.osc=null),this}}let u=new AudioContext,p=96,f=[],d=[],q=["C4 q","E4 q","G4 q","C5 q","E5 q","D5 q","C5 q","G4 q","A4 q","G4 q","F4 q","E4 q","C4 h","G4 h","C4 e","D4 e","E4 q","G4 q","D5 q","E5 q","D5 q","C5 e","B4 e","A4 q","A4 q","G4 q","F4 q","E4 q","C4 w"],w=["C2 h","G3 h","C2 h","E2 h","F3 h","C3 h","C2 w","C2 q","E3 q","G3 q","G3 q","G3 q","G3 q","E3 q","C2 q","C2 q","E3 q","G3 q","G3 q","C2 w"];f=[...q,"E4 q","G4 q","A4 q","C5 q","B4 h","A4 q","G4 q","F4 q","E4 q","D4 q","E4 q","A4 w",...q],d=[...w,"A3 h","E3 h","E3 h","A3 h","F3 h","E3 h","A3 w",...w];let m=new c(u,p,f),b=new c(u,p,[]),_=new c(u,p,d);m.staccato=.55,_.staccato=.6,_.smoothing=.01,m.gain.gain.value=.07,b.gain.gain.value=.07,_.gain.gain.value=.024,m.eqs.mid.frequency.value=800,m.eqs.mid.gain.value=3,_.eqs.bass.gain.value=6,_.eqs.bass.frequency.value=80,_.eqs.mid.gain.value=-6,_.eqs.mid.frequency.value=500,_.eqs.treble.gain.value=-2,_.eqs.treble.frequency.value=1400;let k=["G4 q","A4 q","B4 h","B4 h","A4 q","F#4 q","F#4 h","F#4 h","A4 h","G4 q","F#4 q","E4 q","D4 q","C4 q","F#4 q","G4 h","A4 q","B4 q","B4 q","B4 q","A4 h","B4 q","B4 q","F#4 h"],g=["G3 h","D3 h","G3 h","D3 h","B3 h","D3 h","D3 h","G3 h","C3 h","D3 h","G3 h","E3 h","A3 h","D3 h","G3 h","D3 q"],v=[...k,...k,"E4 q","F#4 q","G4 h","G4 h","A4 q","B4 q","C5 q","B4 q","A4 h","A4 h","F#4 q","G4 q","E4 q","F#4 q","A4 q","G4 q","F#4 h","G4 q","B4 q","C5 h","A4 h","D5 q","C4 q","B3 h",...k],y=[...g,...g,"E3 h","D3 h","G3 h","C3 h","A3 h","C3 h","B3 h","D3 h","D3 h","B3 h","D3 h","B3 h","C3 h","G3 h","E3 h","G3 q",...g],C=new c(u,p,v),E=new c(u,p,y);function A(){C.stop(),E.stop(),x.stop(),$.stop(),m.stop(),b.stop(),_.stop()}C.staccato=.55,E.staccato=.6,E.smoothing=.01,C.gain.gain.value=.07,E.gain.gain.value=.024,C.eqs.mid.frequency.value=800,C.eqs.mid.gain.value=3,E.eqs.bass.gain.value=6,E.eqs.bass.frequency.value=80,E.eqs.mid.gain.value=-6,E.eqs.mid.frequency.value=500,E.eqs.treble.gain.value=-2,E.eqs.treble.frequency.value=1400;let M=[],B=[],G=["A4 q","B4 q","C4 h","D4 q","D#4 q","E4 h","G4 q","F#4 q","E4 h","C4 q","D4 q","B4 h","E4 q","F#4 q","G#4 h","A4 hs","- q","C4 q","B4 q","G4 h","A4 w"];M=[...G,...G,"E4 q","F#4 q","G#4 h","A4 h","B4 q","A4 q","C4 qs","D4 e","F#4 q","E4 q","G4 h","A4 h","B4 q","A4 q","G#4 q","E4 q","F4 h","D#4 q","E4 q","C4 hs","- q","A4 q","- q","- h",...G];let P=["A3 q","E3 q","A3 q","C3 q","E3 q","G#3 q","B3 q","D3 q","D3 q","A3 q","F#3 h","B3 q","F3 q","D3 h","F3 q","C3 q","F3 h","A3 q","C#3 q","E3 h","G3 q","D3 q","G3 h","A3 q","E3 q","A3 q","C3 q"];B=[...P,...P,"C3 q","B3 q","F3 q","D3 q","E3 q","G#3 q","B3 q","D3 q","A3 q","C3 q","E3 h","F3 q","A3 q","C3 h","D3 q","A3 q","F3 h","E3 q","G#3 q","B3 h","A3 q","E3 q","A3 q","C3 q","A3 h","A3 h",...P];let x=new c(u,p,M),$=new c(u,p,B);x.gain.gain.value=.07,$.gain.gain.value=.024,x.staccato=.55,$.staccato=.6,$.smoothing=.01;const F=e=>Math.sin(e),D=e=>(e%6.28-3.14)/6.28,L=e=>{return t=1e3*Math.sin(e),o=-1,i=1,Math.max(Math.min(t,i),o);var t,o,i};async function T(e,t){let o=u.sampleRate,i=u.createBuffer(1,o*e,o),n=i.getChannelData(0),s=i.length;for(let r=0;r<s;r++)n[r]=t(44100*r/o)*(1-r/s)*.4;return await async function(){return new Promise(e=>setTimeout(e,0))}(),i}function R(e){let t=u.createBufferSource();t.buffer=e,t.connect(u.destination),t.start()}const K=()=>Math.random();let I=await T(.3,e=>.1*F(e/44100*2*Math.PI*440*D(e/44100*2*Math.PI*440)*.1)),j=await T(.2,e=>.1*L(e/44100*2*Math.PI*440*D(e/44100*2*Math.PI*440*e/100)*.1)),S=await T(3,e=>e/44100%.2<.1?.5*F(.05*K()+2*e*Math.PI*140/44100):e/44100<.6?.2*F(2*D(e/44100*2*Math.PI*840)*Math.PI*340/44100):.1*F(2*e*Math.PI*840/44100)),z=await T(4,e=>e/44100%.04<.02?.1*L(2*e*Math.PI*(840*e/.4)/44100):e/44100<.6?.2*L(2*D(e/44100*2*Math.PI*(e/500+340))*Math.PI*340/44100):.1*L(2*e*Math.PI*(e/10500+660)/44100));const O={drop:await T(.12,e=>e/44100%.2<.1?.5*F(.05*K()+2*e*Math.PI*140/44100):e/44100<.6?.2*F(e/44100*2*Math.PI*(100+.1*e)):.1*F(2*e*Math.PI*840/44100)),correct:S,next:j,chapter:I,done_chapter:z},N=e=>(e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24),Q=e=>(e=e>>>8&16711935|(16711935&e)<<8)>>>16&65535|(65535&e)<<16,W=e=>Q(e=(e=(e=e>>>1&1431655765|(1431655765&e)<<1)>>>2&858993459|(858993459&e)<<2)>>>4&252645135|(252645135&e)<<4);class X{lo;hi;constructor(e,t){this.lo=0|e,this.hi=0|t}static fromSquare(e){return e>=32?new X(0,1<<e-32):new X(1<<e,0)}static fromRank(e){return new X(255,0).shl64(8*e)}static fromFile(e){return new X(16843009<<e,16843009<<e)}static empty(){return new X(0,0)}static full(){return new X(4294967295,4294967295)}static corners(){return new X(129,2164260864)}static center(){return new X(402653184,24)}static backranks(){return new X(255,4278190080)}static backrank(e){return"white"===e?new X(255,0):new X(0,4278190080)}static lightSquares(){return new X(1437226410,1437226410)}static darkSquares(){return new X(2857740885,2857740885)}complement(){return new X(~this.lo,~this.hi)}xor(e){return new X(this.lo^e.lo,this.hi^e.hi)}union(e){return new X(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new X(this.lo&e.lo,this.hi&e.hi)}diff(e){return new X(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?X.empty():e>=32?new X(this.hi>>>e-32,0):e>0?new X(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?X.empty():e>=32?new X(0,this.lo<<e-32):e>0?new X(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new X(Q(this.hi),Q(this.lo))}rbit64(){return new X(W(this.hi),W(this.lo))}minus64(e){const t=this.lo-e.lo,o=(t&e.lo&1)+(e.lo>>>1)+(t>>>1)>>>31;return new X(t,this.hi-(e.hi+o))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return N(this.lo)+N(this.hi)}isEmpty(){return 0===this.lo&&0===this.hi}nonEmpty(){return 0!==this.lo||0!==this.hi}has(e){return 0!=(e>=32?this.hi&1<<e-32:this.lo&1<<e)}set(e,t){return t?this.with(e):this.without(e)}with(e){return e>=32?new X(this.lo,this.hi|1<<e-32):new X(this.lo|1<<e,this.hi)}without(e){return e>=32?new X(this.lo,this.hi&~(1<<e-32)):new X(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new X(this.lo,this.hi^1<<e-32):new X(this.lo^1<<e,this.hi)}last(){return 0!==this.hi?63-Math.clz32(this.hi):0!==this.lo?31-Math.clz32(this.lo):void 0}first(){return 0!==this.lo?31-Math.clz32(this.lo&-this.lo):0!==this.hi?63-Math.clz32(this.hi&-this.hi):void 0}withoutFirst(){return 0!==this.lo?new X(this.lo&this.lo-1,this.hi):new X(0,this.hi&this.hi-1)}moreThanOne(){return 0!==this.hi&&0!==this.lo||!!(this.lo&this.lo-1)||!!(this.hi&this.hi-1)}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let e=this.lo,t=this.hi;for(;0!==e;){const t=31-Math.clz32(e&-e);e^=1<<t,yield t}for(;0!==t;){const e=31-Math.clz32(t&-t);t^=1<<e,yield 32+e}}*reversed(){let e=this.lo,t=this.hi;for(;0!==t;){const e=31-Math.clz32(t);t^=1<<e,yield 32+e}for(;0!==e;){const t=31-Math.clz32(e);e^=1<<t,yield t}}}const U=e=>e>>3,V=e=>7&e,Y=(e,t)=>0<=e&&e<8&&0<=t&&t<8?e+8*t:void 0,Z=(e,t)=>{let o=X.empty();for(const i of t){const t=e+i;0<=t&&t<64&&Math.abs(V(e)-V(t))<=2&&(o=o.with(t))}return o},H=e=>{const t=[];for(let o=0;o<64;o++)t[o]=e(o);return t},J=H(e=>Z(e,[-9,-8,-7,-1,1,7,8,9])),ee=H(e=>Z(e,[-17,-15,-10,-6,6,10,15,17])),te={white:H(e=>Z(e,[7,9])),black:H(e=>Z(e,[-7,-9]))},oe=H(e=>X.fromFile(V(e)).without(e)),ie=H(e=>X.fromRank(U(e)).without(e)),ne=H(e=>{const t=new X(134480385,2151686160),o=8*(U(e)-V(e));return(o>=0?t.shl64(o):t.shr64(-o)).without(e)}),se=H(e=>{const t=new X(270549120,16909320),o=8*(U(e)+V(e)-7);return(o>=0?t.shl64(o):t.shr64(-o)).without(e)}),re=(e,t,o)=>{let i=o.intersect(t),n=i.bswap64();return i=i.minus64(e),n=n.minus64(e.bswap64()),i.xor(n.bswap64()).intersect(t)},ae=(e,t)=>{const o=X.fromSquare(e);return re(o,ne[e],t).xor(re(o,se[e],t))},le=(e,t)=>((e,t)=>re(X.fromSquare(e),oe[e],t))(e,t).xor(((e,t)=>{const o=ie[e];let i=t.intersect(o),n=i.rbit64();return i=i.minus64(X.fromSquare(e)),n=n.minus64(X.fromSquare(63-e)),i.xor(n.rbit64()).intersect(o)})(e,t)),he=(e,t,o)=>{switch(e.role){case"pawn":return((e,t)=>te[e][t])(e.color,t);case"knight":return(e=>ee[e])(t);case"bishop":return ae(t,o);case"rook":return le(t,o);case"queen":return((e,t)=>ae(e,t).xor(le(e,t)))(t,o);case"king":return(e=>J[e])(t)}};function ce(e){return function(e){let t=[],o=function(e){let t=[],o=function(e){let t=X.empty();for(let o of Object.keys(e))t=t.set(e[o],!0);return t}(e);for(let i of Object.keys(e)){let n=me(i),s=e[i],r=he(n,s,o);for(let a of r)for(let l of Object.keys(e))if(e[l]===a){let a,h=e[l],c=o.without(h),u=he(n,s,c).diff(r);for(let t of u)for(let o of Object.keys(e))e[o]===t&&(a=o);void 0!==a?t.push([i,l,a]):t.push([i,l])}}return t.sort((e,t)=>e.join(" ").localeCompare(t.join(" "))),t}(e);for(let i of Object.keys(e)){let e=[],n=[],s=[],r=[],a=[];for(let t of o)t[0]===i?2===t.length?e.push(t[1]):r.push([t[1],t[2]]):t[1]===i?2===t.length?n.push(t[0]):s.push([t[0],t[2]]):t[2]===i&&a.push([t[0],t[1]]);t.push({p1:i,attacks:e,attacked_by:n,blocks:s,blocked_attacks:r,blocked_attacked_by:a})}return t}(de(e))}const ue=e=>!e.attacked_by.find(e=>e.toLowerCase()===e)&&!e.blocked_attacked_by.find(e=>e[0].toLowerCase()===e[0])&&!e.blocks.find(e=>e[0].toLowerCase()===e[0]),pe=e=>!e.attacked_by.find(e=>e.toLowerCase()!==e)&&!e.blocked_attacked_by.find(e=>e[0].toLowerCase()!==e[0])&&!e.blocks.find(e=>e[0].toLowerCase()!==e[0]);function fe(e){let t=e.p1,o=e.attacks.map(e=>`+${e}`).join(" "),i=e.attacked_by.map(e=>`${e}+`).join(" "),n=e.blocks.map(e=>`${e[0]}+|${e[1]}`).join(" "),s=e.blocked_attacks.map(e=>`+${e[0]}/${e[1]}`).join(" "),r=e.blocked_attacked_by.map(e=>`${e[0]}+/${e[1]}`).join(" "),a=[t];return ue(e)&&a.push("z+"),pe(e)&&a.push("Z+"),""!==o&&a.push(o),""!==i&&a.push(i),""!==n&&a.push(n),""!==s&&a.push(s),""!==r&&a.push(r),a.join(" ")}function de(e){e=e.split(" ")[0];let t={},o=7;for(let i of e.split("/")){let e=0;for(let n of i)if(we(n)){let i=Y(e,o);if(void 0!==i){let e=n,o=2;for(;void 0!==t[e];)e=n+o,o++;t[e]=i}e+=1}else e+=parseInt(n);o-=1}return t}const qe={r:"rook",n:"knight",b:"bishop",p:"pawn",q:"queen",k:"king"};function we(e){return void 0!==qe[e.toLowerCase()]}function me(e){var t;return{color:(t=e).toLowerCase()===t?"black":"white",role:qe[e.toLowerCase().replace(/[2345678]/,"")]}}let be,_e;console.log(ce("8/8/4r3/r1n5/1k1B4/6Np/1PP1n3/2KRR3 w - - 0 1").map(fe));const ke=(e=!1)=>{let{chapter:t}=qt[dt];(e||_e!==t)&&(A(),clearTimeout(be),be=setTimeout(()=>{0===t?function(){let e=u.currentTime;C.play(e),E.play(e)}():1===t?function(){let e=u.currentTime;x.play(e),$.play(e)}():2===t&&function(){let e=u.currentTime;m.play(e),_.play(e)}(),_e=t},1e3))};let ge,ve,ye,Ce,Ee=await function(e){let t=new Image;return new Promise(o=>{t.onload=()=>o(t),t.src=e})}(e);function Ae(e,t,o,i=1,n=i){let s,r,a;t=Math.floor(t),o=Math.floor(o),e<4?(s=32,r=32*e,a=0):e<28?(s=16,r=(e-=4)%8*16,a=32+16*Math.floor(e/8)):(s=8,r=(e-=28)%16*8,a=80+8*Math.floor(e/16)),ve.drawImage(Ee,r,a,s,s,t,o,s*i,s*n)}function Me(e){Ce.font="42px Arial",Ce.shadowColor="black",Ce.shadowBlur=4;let t=1308,o=803.25;Be(e[0],t,o,600,60),Ce.font="28px Arial",t=1308,o=1039.5,Be(e[1],t,o,600,60)}function Be(e,t,o,i,n){const s=e.split(" ");let r="",a=o;for(let l=0;l<s.length;l++){const e=r+s[l]+" ";Ce.measureText(e).width>i&&l>0?(Ce.fillText(r,t,a),r=s[l]+" ",a+=n):r=e}Ce.fillText(r,t,a)}function Ge(){if(Ce.clearRect(0,0,1920,1080),ve.fillStyle="black",ve.fillRect(0,0,480,270),bt)return function(){if(-1===_t&&(Ce.strokeStyle=Ct%1e3<500?"white":"gray",Ce.lineWidth=3,Ce.font="80px Arial",Ce.strokeText("click to begin",100,1e3)),_t>5500)Ae(0,200,50,2.5),Ae(98,300,100,5);else if(_t>4e3)Ae(1,280,90,3);else if(_t>1800)Ae(4,280,90,6);else if(_t>800)Ae(10,290,90,6);else if(-1===_t){let e=Ct%4e3;Ae(e<500||e>800&&e<1300?100:99,300,100,5),Ae(101,180,150,6)}}(),void Ae(28,...ft);Ae(110,0,0,320);let e=10,t=24;for(let i=0;i<8;i++)for(let o=0;o<8;o++){Ae(108+((i+o)%2==1?1:0),e+3.5*i*8,t+3.5*o*8,3.5)}e=10,t=0,Ae(111,e,t,28,3),t=248,Ae(111,e,t,28,3);for(let i of ut)Ae(Ze(i.piece),...i.pos,3),i.piece.match(/2/)&&Ae(82,...i.pos,3),i.is_hovering&&Ae(112,...i.pos,3);Ae(111,318,188,20,10),Me(yt||(gt||(vt||kt))),Ae(111,238,2,30,23);let o=ht.find(e=>e.is_hovering);if(o){let[e,t,i,n]=o.bb;ve.strokeRect(e,t,i,n);for(let s of o.circles)Ae(112,...s,3);for(let s of o.no_arrows)Se(s[0],s[1],"red");for(let s of o.yes_arrows)Se(s[0],s[1],"green")}for(let i of lt)Ae(i[0],i[1],i[2]);if(ct&&Ae(Ze(ct.piece),...ct.pos,3),void 0!==gt){!function(e,t,o,i){for(let n=0;n<t;n++)Ae(e+n,o+8*n*2,i,2)}(119,5,400,246+(At&&Ct%500<200?2:0))}!function(){let e=Ie,t=je;Ae(111,238,188,9.8,10);let o=qt[dt];Ce.font="bold 64px Arial",Ce.fillText(`${o.chapter}-${o.level}`,265*e,204*t);let i=Ct%500<250?3:0,n=Bt?i:0;Ae(117,242-(Mt?i:0),190,2),Ae(118,296+n,190,2),Ae($e+(qt[dt].is_revealed?16:qt[dt].is_solved?8:0),250,214,3),Ae(void 0===xt||xt?116:115,298,214,2)}();for(let i of Ft)Ae(Ze(i.piece),...i.pos,4),i.piece.match(/2/)&&Ae(82,...i.pos,4);if($t>0&&Ae(2,60,60,4),Ae(28,...ft),Gt){let e=80*Math.sin(.008*Ct),t=80*Math.sin(.008*Ct),o=80*Math.sin(.003*Ct);Ce.font="bold 180px Arial",Ce.shadowColor="purple",Ce.shadowBlur=10,Ce.lineWidth=4,Ce.strokeStyle="purple",Ce.strokeText("Mor",200+e,400+t),Ce.strokeText("Chess",1e3-e,400+t),Ce.fillStyle="white",Ce.shadowBlur=0,Ce.fillText("Mor",200+e,400+t),Ce.fillText("Chess",1e3-e,400+t),Ce.fillStyle="black",Ce.fillText("Black",200,800-.1*o),Ce.fillText("Cat",800,800-.1*o)}}let Pe,xe,$e,Fe,De=[250,214,48,48],Le=[298,214,16,16];const Te={neutral:4,happy:5,sad:6,angry:7,surprised:8,sleepy:9,playful:10},Re=[242,190,16,16],Ke=[296,190,16,16],Ie=4,je=4;function Se(e,t,o){Ce.lineWidth=10,Ce.strokeStyle=o,Ce.lineCap="round",Ce.beginPath(),Ce.moveTo(e[0]*Ie,e[1]*je),Ce.lineTo(t[0]*Ie,t[1]*je),Ce.stroke()}const ze=[400,246,80,16];function Oe(e,t){return fe(e)===fe(t)}const Ne=(e,t,o)=>lt.push([e,t,o,0]),Qe=(e,t,o,i,n,s,r,a)=>ht.push({info:e,bb:[t,o,i,n],is_hovering:!1,circles:s,yes_arrows:r,no_arrows:a});function We(e,t,o){const i=e=>ut.filter(t=>t.piece===e&&void 0!==tt(t.pos)).map(e=>e.pos),n=(e,t)=>{let o=ut.filter(t=>t.piece===e&&void 0!==tt(t.pos)).map(e=>e.pos)[0],i=ut.filter(e=>e.piece===t&&void 0!==tt(e.pos)).map(e=>e.pos)[0];if(o&&i){return[[[o[0]+12,o[1]+12],[i[0]+12,i[1]+12]]]}return[]};let s=[],r=[],a=[];const l=(e,t,o,i,n)=>{Qe(e,t,o,i,n,s,r,a),s=[],r=[],a=[]},h=Ne;h(Ze(e.p1),t+4,o+4),e.p1.match(/2/)&&h(82,t+4,o+4),s=i(e.p1),l(Xe.yes_piece(e.p1),t+2,o+2,12,12),h(39,(t+=8)+4,o+4),t+=8;let c=it();if(ue(e)){let r=c.find(t=>t.p1===e.p1),u=r?.attacked_by.filter(e=>e.toLowerCase()===e)??[];u=u.concat(r?.blocks.map(e=>e[0]).filter(e=>e.toLowerCase()===e)??[]),a=[...u.flatMap(t=>n(e.p1,t))],e.p1.toLowerCase()===e.p1?h(33,t+4,o+4):h(32,t+4,o+4),s=i(e.p1),l(Xe.zero_attacked_by_lower(e.p1),t+2,o+2,12,12),t+=12}if(pe(e)){let r=c.find(t=>t.p1===e.p1),u=r?.attacked_by.filter(e=>e.toLowerCase()!==e)??[];u=u.concat(r?.blocks.map(e=>e[0]).filter(e=>e.toLowerCase()!==e)??[]),a=[...u.flatMap(t=>n(e.p1,t))],e.p1.toLowerCase()===e.p1?h(32,t+4,o+4):h(33,t+4,o+4),s=i(e.p1),l(Xe.zero_attacked_by_upper(e.p1),t+2,o+2,12,12),t+=12}for(let u of e.attacks){h(35,t+2,o+4);let i=c.find(t=>t.p1===e.p1);0===(i?.attacks.filter(e=>e===u)??[]).length?a=[...n(e.p1,u)]:r=[...n(e.p1,u)],l(Xe.attacks(e.p1,u),t+4,o+2,14,12),t+=5,h(Ze(u),t+4,o+4),u.match(/2/)&&h(82,t+4,o+4),t+=9}for(let u of e.attacked_by){h(Ze(u),t+4,o+4),u.match(/2/)&&h(82,t+4,o+4);let p=c.find(t=>t.p1===e.p1);0===(p?.attacked_by.filter(e=>e===u)??[]).length?a=[...n(e.p1,u)]:r=[...n(e.p1,u)],s=i(e.p1),l(Xe.attacked_by(e.p1,u),t+4,o+2,14,12),h(34,(t+=9)+2,o+4),t+=5}for(let u of e.blocks){h(Ze(u[1]),t+4,o+4),u[1].match(/2/)&&h(82,t+4,o+4);let i=c.find(t=>t.p1===e.p1);0===(i?.blocks.filter(e=>e[0]===u[0]&&e[1]===u[1])??[]).length?a=[...n(u[0],u[1]),...n(e.p1,u[1])]:r=[...n(u[0],u[1])],l(Xe.blocks(e.p1,...u),t+4,o+2,24,12),h(36,(t+=9)+2,o+4),t+=5,h(Ze(u[0]),t+4,o+4),u[0].match(/2/)&&h(82,t+4,o+4),t+=9}for(let u of e.blocked_attacks){h(Ze(u[1]),t+4,o+4),u[0].match(/2/)&&h(82,t+4,o+4);let i=c.find(t=>t.p1===e.p1);0===(i?.blocked_attacks.filter(e=>e[0]===u[0]&&e[1]===u[1])??[]).length?a=[...n(u[0],u[1]),...n(e.p1,u[1])]:r=[...n(e.p1,u[1])],l(Xe.blocked_attacks(e.p1,u[1],u[0]),t+4,o+2,24,12),h(37,(t+=9)+2,o+4),t+=5,h(Ze(u[0]),t+4,o+4),u[0].match(/2/)&&h(82,t+4,o+4),t+=9}for(let u of e.blocked_attacked_by){h(Ze(u[1]),t+4,o+4),u[1].match(/2/)&&h(82,t+4,o+4);let i=c.find(t=>t.p1===e.p1),s=i?.blocked_attacked_by.filter(e=>e[0]===u[0]&&e[1]===u[1])??[];0===s.length?a=[...n(u[0],u[1]),...n(e.p1,u[0])]:r=[...n(e.p1,u[0])],s=i?.attacked_by.filter(e=>e===u[0]).map(e=>[e,e])??[],s=s.concat(i?.blocks.filter(e=>e[0]===u[0])??[]),s.length>0&&(a=[...n(e.p1,u[0])]),l(Xe.blocked_attacked_by(e.p1,u[0],u[1]),t+4,o+2,24,12),h(38,(t+=9)+2,o+4),t+=5,h(Ze(u[0]),t+4,o+4),u[0].match(/2/)&&h(82,t+4,o+4),t+=9}return[t,o]}const Xe={welcome0:["welcome to mor chess; drag pieces onto the board, but there are some rules above. hover over them for details.","drag a piece off the board to remove it."],welcome1:["each chapter; proressively reveals more pieces of a single position.","call out the cat 3 times, if you get in a mess ;)"],welcome2:["chess tactics; are born out of relationships.","our job is to entangle them."],welcome3:["rules are tools to an end.","look here, just enough to keep the cats happy."],well_done:["Congratulations, you satisfied all rules. Time to go deeper.","Click Next to continue."],well_end:["the end; chess is fascinating isn't it, go play some chess.","Thank's for playing"],equals:e=>["left side is the goal, right side is the board; your goal is to match them equal.",`this rule ${e?"has matched correctly.":"has not been matched yet."}`],no_piece:e=>[`${Ye(e)} hasn't been placed yet.`,""],yes_piece:e=>[`A ${Ye(e)} on the board.`,""],zero_attacked_by_lower(e){let t=e.toLowerCase()===e?"defenders":"attackers";return[`${Ye(e)} has zero ${t}.`,""]},zero_attacked_by_upper(e){let t=e.toLowerCase()===e?"attackers":"defenders";return[`${Ye(e)} has zero ${t}.`,""]},attacks(e,t){let o=Ye(e),i=Ye(t);return[`${o} is ${Ue(e,t)} ${i}.`,`${i} shouldn't be blocking an attack of ${o}.`]},attacked_by(e,t){let o=Ye(e),i=Ye(t);return[`${o} is ${Ve(e,t)} by ${i}.`,`${o} shouldn't be blocking an attack of ${i}.`]},blocks(e,t,o){let i=Ye(e),n=Ye(t),s=Ye(o);return[`${i} blocks ${n} ${Ue(t,o)} ${s}.`,""]},blocked_attacks(e,t,o){let i=Ye(e),n=Ye(t),s=Ye(o);return[`${i} is ${Ue(e,t)} ${n}, but that's blocked by ${s}.`,""]},blocked_attacked_by(e,t,o){let i=Ye(e),n=Ye(t),s=Ye(o);return[`${i} is ${Ve(e,t)} by ${n}, but that's blocked by ${s}.`,""]}},Ue=(e,t)=>e.toLowerCase()===e==(t.toLowerCase()===t)?"defending":"attacking",Ve=(e,t)=>e.toLowerCase()===e==(t.toLowerCase()===t)?"defended":"attacked";function Ye(e){let t=me(e),o=e.match(/2/)?"2":"";return t.role[0].toUpperCase()+t.role.slice(1)+o}function Ze(e){let t=me(e);return 76+{pawn:0,rook:1,bishop:2,knight:3,queen:4,king:5}[t.role]+("white"===t.color?16:0)}function He(e){if($t-=e,_t>0&&(_t-=e,_t<=0&&(bt=!1)),Fe-=e,Fe<0&&(Fe=0),Fe>1e3&&(Fe=0,qt[dt].is_revealed||(qt[dt].is_revealed=!0,function(){Dt();let e=de(qt[dt].fen);for(let t of Object.keys(e)){let o=V(e[t]),i=U(e[t]);ut.push(rt(t,et([o,7-i])))}at=!0}())),xe-=e,Ct+=e,xe<0&&($e=Ct%1e4<2e3?Te.sleepy:Te.neutral),pt.is_hovering){ft=pt.is_hovering;for(let e of ut)e.is_hovering=!1;for(let e of ut)if(o(st(e),nt(ft))){e.is_hovering=!0;break}if(void 0!==ct)ct.pos=[ft[0]-4,ft[1]-4];else{for(let e of ht)e.is_hovering=!1;for(let e of ht)o(e.bb,nt(ft))&&(e.is_hovering=!0)}Et=o(De,nt(ft)),At=void 0!==gt&&o(ze,nt(ft)),Mt=o(Re,nt(ft)),Bt=o(Ke,nt(ft)),Et&&xe<0&&($e=Te.playful,xe=260)}if(pt.is_just_down){let e=ut.find(e=>e.is_hovering);if(e){e.is_dragging=!0,ct=rt(e.piece,e.pos),tt(e.pos)&&(ct.orig=e)}}if(pt.is_up){if(-1===_t&&bt&&(_t=6e3,R(O.done_chapter)),void 0!==xt||Pt||(xt=!1,ke()),ct){if(ct.orig){let e=ct.orig.pos;ut=ut.filter(t=>!(t.pos[0]===e[0]&&t.pos[1]===e[1]))}let e=tt(pt.is_up);if(e){let t=et(e);ut=ut.filter(e=>!(e.pos[0]===t[0]&&e.pos[1]===t[1])),ut.push(rt(ct.piece,t))}!function(){for(let e of ut){let t=tt(e.pos);if(!t)continue;let o=ut.find(o=>{if(o!==e&&o.piece[0]===e.piece[0]){let e=tt(o.pos);if(e){let o=Y(...t);if(Y(...e)<o)return!0}}})?"2":"";e.piece=e.piece[0]+o}}(),ct=void 0,at=!0,$e=Te.surprised,xe=3e3,R(O.drop)}At&&(dt===qt.length-1?Je(0):Je(1)),Mt&&Je(-1),Bt&&Je(1),o(Le,nt(pt.is_up))&&(xt=!xt,xt?A():ke(!0)),Et&&($e=Te.sad,xe=1e3,Fe+=540)}if(at){at=!1,lt=[],ht=[];let e=mt(),t=it(),o=0,i=!0,n=2;for(let s of e){let e=238;[e,n]=We(s,e,n);let r=t.find(e=>e.p1===s.p1),a=void 0!==r&&Oe(s,r)?30:29;30===a&&o++,i=i&&30===a,Ne(a,e+4,n+4),Qe(Xe.equals(30===a),e+2,n+2,12,12,[],[],[]),e+=10,void 0===r?(Ne(31,e+4,n+4),Qe(Xe.no_piece(s.p1),e+2,n+2,12,12,[],[],[])):[e,n]=We(r,e,n),n+=14,e=182}Pe>o&&($e=Te[Math.random()<.8?"angry":"sad"],xe=1500),Pe=o,i?function(){qt[dt].is_solved=!0,qt.filter(e=>e.chapter===qt[dt].chapter).every(e=>e.is_solved)?R(O.done_chapter):R(O.correct);$e=Te.playful,xe=5e3,dt<qt.length-1?-1===qt.findIndex(e=>!e.is_solved)?Gt=!0:gt=Xe.well_done:-1===qt.findIndex(e=>!e.is_solved)?Gt=!0:gt=Xe.well_end}():gt=void 0}if(vt=ht.find(e=>e.is_hovering)?.info,pt.update(e),Gt){for(let t of ut)t.pos[1]-=.1*e*Math.random(),t.pos[1]<-20&&(t.pos[1]=400);Ct%500<17&&(dt+=1,dt>qt.length-1&&(dt=0),at=!0)}let i=[];for(let o of Ft)Ct%300<120&&(o.pos[0]=t(o.pos[0],o.t_pos[0],8),o.pos[1]=t(o.pos[1],o.t_pos[1],8)),o.pos[0]<0||o.pos[1]<0||o.pos[0]>400||o.pos[1]>300||i.push(o);Ft=i}function Je(e){ke(),qt[dt].is_revealed&&(Dt(),qt[dt].is_revealed=!1,qt[dt].is_solved=!1);let t=dt+e;if(0===e&&(t=qt.findIndex(e=>!e.is_solved)),t<0||t>=qt.length)return;let o=qt[t].chapter!==qt[dt].chapter;o?(R(O.chapter),Dt()):R(O.next),at=!0,dt=t,o&&(kt=Xe[`welcome${qt[dt].chapter}`],$e=Te.surprised,xe=5e3)}function et(e){return[10+3.5*e[0]*8+2,24+3.5*e[1]*8+4]}function tt(e){let[t,o]=e;if(t-=10,o-=24,!(t<0||t>=224||o<0||o>=224))return t=Math.floor(t/28),o=Math.floor(o/28),[t,o]}function ot(e){return ce(e)}function it(){return ot(function(){let e={};for(let o of ut){let t=tt(o.pos);if(t){let i=o.piece;e[Y(...t)]=i}}let t="";for(let o=0;o<8;o++){let i=0;for(let n=0;n<8;n++){let s=Y(n,o);e[s]?(i>0&&(t+=i),t+=e[s][0],i=0):i++}i>0&&(t+=i),t+="/"}return t}())}function nt(e){return[e[0]+1,e[1]+1,6,6]}function st(e){let[t,o]=e.pos;return[t,o,24,24]}function rt(e,t){return{piece:e,pos:t,is_hovering:!1,is_dragging:!1,t_pos:[0,0]}}let at,lt,ht,ct,ut,pt,ft,dt,qt=[wt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",0,0),wt("6k1/8/8/8/8/8/5P2/6K1 w - - 0 1",0,1),wt("6k1/8/8/8/8/8/6PP/6K1 w - - 0 1",0,2),wt("6k1/8/8/3r4/8/5B2/5P2/6K1 w - - 0 1",0,3),wt("6k1/b7/8/3r4/8/5B2/5P2/6K1 w - - 0 1",0,4),wt("1r4k1/bP6/8/8/8/5B2/5P2/6K1 w - - 0 1",0,5),wt("1r4k1/bP6/4p3/3r4/8/5B2/5P2/6K1 w - - 0 1",0,6),wt("1r4k1/bP6/4p3/p2r4/8/5B2/5P2/R5K1 w - - 0 1",0,7),wt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",1,0),wt("8/1K6/4b3/8/3r4/4k3/8/8 w - - 0 1",1,1),wt("8/1K6/4b3/4R3/3rP3/4k3/8/8 w - - 0 1",1,2),wt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",2,0),wt("8/5k2/8/8/8/8/6PP/6K1 w - - 0 1",2,1),wt("8/5k2/4rn2/8/8/8/6PP/6K1 w - - 0 1",2,2),wt("8/5k2/8/8/8/8/8/R2R2K1 w - - 0 1",2,3),wt("3r4/5k2/8/8/3n4/8/8/3R2K1 w - - 0 1",2,4),wt("3r4/6k1/5rn1/8/3n4/8/6PP/3R2K1 w - - 0 1",2,5),wt("3r4/6k1/5rn1/1p6/2Nn4/8/6PP/R2R2K1 w - - 0 1",2,6),wt("3r4/5k2/4rn2/1p6/2N5/3n4/1B4PP/R2R2K1",2,7),wt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",3,0),wt("6k1/8/8/8/8/8/7q/1K1Q4 w - - 0 1",3,1),wt("6k1/7p/8/8/8/8/2Pr3q/1K1QR3 w - - 0 1",3,2),wt("6k1/7p/8/6p1/8/8/1PPr3q/1K1QR3 w - - 0 1",3,3)];function wt(e,t,o){return{chapter:t,level:o,fen:e,is_solved:!1,is_revealed:!1}}const mt=()=>ot(qt[dt].fen);let bt,_t,kt,gt,vt,yt,Ct,Et,At,Mt,Bt,Gt,Pt,xt,$t,Ft;function Dt(){$t=1300,Ft=ut.filter(e=>void 0!==tt(e.pos));for(let e of Ft)e.t_pos=[Math.random()<.5?-100:500,600*Math.random()-300];ut=[rt("p",[20,0]),rt("n",[52,0]),rt("b",[84,0]),rt("r",[116,0]),rt("q",[148,0]),rt("k",[180,0]),rt("P",[20,248]),rt("N",[52,248]),rt("B",[84,248]),rt("R",[116,248]),rt("Q",[148,248]),rt("K",[180,248])]}!function(e){ge=document.createElement("canvas"),ge.width=480,ge.height=270,ge.classList.add("pixelated"),ve=ge.getContext("2d"),ve.imageSmoothingEnabled=!1,ve.fillStyle="black",ye=document.createElement("canvas"),ye.width=1920,ye.height=1080,Ce=ye.getContext("2d");let t=document.createElement("div");t.classList.add("content"),t.appendChild(ge),t.appendChild(ye),e.appendChild(t),bt=!0,_t=-1,Fe=0,Pt&&A(),Pt=!1,Pe=0,$e=Te.happy,xe=5e3,Gt=!1,Mt=!1,Bt=!1,At=!1,Ct=0,yt=void 0,gt=void 0,vt=void 0,kt=Xe.welcome0,at=!0,lt=[],ht=[],dt=0,ct=void 0,ut=[],Ft=[],Dt(),pt=i(ge),ft=[0,0],$t=0,function(e,t){const o=1e3/60;let i=performance.now(),n=0;requestAnimationFrame(function s(r){requestAnimationFrame(s);let a=Math.min(r-i,250);for(i=r,n+=a;n>=o;)e(o),n-=o;t(n/o)})}(He,Ge)}(document.getElementById("app"));
