<!doctype html><meta name=viewport content="width=device-width"><title>Mor Chess - js13kGames 2025</title><style>body,html{margin:0;padding:0;background:#472d3c;width:100vw;height:100vh}#app,body{display:flex;justify-content:center;align-items:center}#app .content{position:relative;box-shadow:0 0 2px 2px #472d3c;width:min(100vw,calc(100vh * 16/9));aspect-ratio:16/9;cursor:pointer;cursor:none}#app canvas{position:absolute;top:0;left:0;width:100%;height:100%;background-color:transparent;touch-action:none;pointer-events:none}#app .pixelated{image-rendering:pixelated;pointer-events:all;cursor:none}</style><div id=app></div><script type=module>function e(e,t,o){return e<t?Math.min(e+o,t):e>t?Math.max(e-o,t):e}function t(e,t){let[o,i,n,s]=e,[r,a,l,h]=t;return o<r+l&&o+n>r&&i<a+h&&i+s>a}function o(t){let o,i,n,s,r,a=!1,l=0;function h(e){return[e[0]*t.width,e[1]*t.height]}return function(e,t){const o=e=>{let[t,o]=(e=>{if(e.clientX||0===e.clientX)return[e.clientX,e.clientY]})(e)??[0,0];return[(t-i.left)/i.width,(o-i.top)/i.height]};let i,n=e.getContext("2d");function s(){i=e.getBoundingClientRect(),n.imageSmoothingEnabled=!1}function r(){s()}s(),e.addEventListener("pointerdown",function(i){e.setPointerCapture(i.pointerId);let n=o(i);t.on_down(n)},{passive:!1}),e.addEventListener("pointermove",function(e){let i=o(e);t.on_move(i)},{passive:!1}),document.addEventListener("pointerup",function(e){let i=o(e);t.on_up(i)}),new ResizeObserver(s).observe(e),document.addEventListener("scroll",r,{capture:!0,passive:!0}),window.addEventListener("resize",r,{passive:!0})}(t,{on_down(e){e=h(e),n=void 0,i=e,s=e,a=!1},on_up(e){e=h(e),i=void 0,o=void 0,n=e},on_move(e){e=h(e),o=e,a=!0}}),{get is_hovering(){return o},get is_down(){return i},get is_up(){return n},get is_just_down(){return s},get is_double_click(){return r},get has_moved_after_last_down(){return a},update(t){r=void 0,s&&l>0&&(r=s,l=0),l=e(l,0,t),s=void 0,n=void 0}}}let i=440*Math.pow(Math.pow(2,1/12),-9),n=/^[0-9.]+$/,s=/\s+/,r=/(\d+)/,a={};"B#-C|C#-Db|D|D#-Eb|E-Fb|E#-F|F#-Gb|G|G#-Ab|A|A#-Bb|B-Cb".split("|").forEach(function(e,t){e.split("-").forEach(function(e){a[e]=t})});class l{frequency;duration;constructor(e){let t=e.split(s);var o;this.frequency=function(e){var t=e.split(r),o=a[t[0]],n=(parseInt(t[1])||4)-4;return i*Math.pow(Math.pow(2,1/12),o)*Math.pow(2,n)}(t[0])||0,this.duration=(o=t[1],(n.test(o)?parseFloat(o):o.toLowerCase().split("").reduce(function(e,t){return e+("w"===t?4:"h"===t?2:"q"===t?1:"e"===t?.5:"s"===t?.25:0)},0))||0)}}class h{cx;tempo;notes;loop;smoothing;staccato;eqs;gain;osc;wave_type;constructor(e,t=120,o=[],i=!0){this.cx=e,this.tempo=t,this.osc=null,this.create_fx_nodes(),this.loop=i,this.smoothing=0,this.staccato=0,this.notes=[],this.push(o)}push(e){this.notes.push(...e.map(e=>new l(e)))}create_fx_nodes(){var e=this.gain=this.cx.createGain();return this.eqs={bass:void 0,mid:void 0,treble:void 0},[["bass",100],["mid",1e3],["treble",2500]].forEach(t=>{let o=this.eqs[t[0]]=this.cx.createBiquadFilter();o.type="peaking",o.frequency.value=t[1],e.connect(e=o)}),e.connect(this.cx.destination),this}create_oscillator(){return this.stop(),this.osc=this.cx.createOscillator(),this.osc.type=this.wave_type||"square",this.osc.connect(this.gain),this}schedule_note(e,t){var o=60/this.tempo*this.notes[e].duration,i=o*(1-(this.staccato||0));return this.set_frequency(this.notes[e].frequency,t),this.smoothing&&this.notes[e].frequency&&this.slide(e,t,i),this.set_frequency(0,t+i),t+o}get_next_note(e){return this.notes[e<this.notes.length-1?e+1:0]}get_slide_start_delay(e){return e-Math.min(e,60/this.tempo*this.smoothing)}slide(e,t,o){var i=this.get_next_note(e),n=this.get_slide_start_delay(o);return this.set_frequency(this.notes[e].frequency,t+n),this.ramp_frequency(i.frequency,t+o),this}set_frequency(e,t){return this.osc.frequency.setValueAtTime(e,t),this}ramp_frequency(e,t){return this.osc.frequency.linearRampToValueAtTime(e,t),this}play(e){return e="number"==typeof e?e:this.cx.currentTime,this.create_oscillator(),this.osc.start(e),this.notes.forEach((t,o)=>{e=this.schedule_note(o,e)}),this.osc.stop(e),this.osc.onended=this.loop?()=>this.play(e):null,this}stop(){return this.osc&&(this.osc.onended=null,this.osc.disconnect(),this.osc=null),this}}let c=new AudioContext,u=96,p=[],f=[],d=["C4 q","E4 q","G4 q","C5 q","E5 q","D5 q","C5 q","G4 q","A4 q","G4 q","F4 q","E4 q","C4 h","G4 h","C4 e","D4 e","E4 q","G4 q","D5 q","E5 q","D5 q","C5 e","B4 e","A4 q","A4 q","G4 q","F4 q","E4 q","C4 w"],q=["C2 h","G3 h","C2 h","E2 h","F3 h","C3 h","C2 w","C2 q","E3 q","G3 q","G3 q","G3 q","G3 q","E3 q","C2 q","C2 q","E3 q","G3 q","G3 q","C2 w"];p=[...d,"E4 q","G4 q","A4 q","C5 q","B4 h","A4 q","G4 q","F4 q","E4 q","D4 q","E4 q","A4 w",...d],f=[...q,"A3 h","E3 h","E3 h","A3 h","F3 h","E3 h","A3 w",...q];let w=new h(c,u,p),m=new h(c,u,[]),b=new h(c,u,f);w.staccato=.55,b.staccato=.6,b.smoothing=.01,w.gain.gain.value=.07,m.gain.gain.value=.07,b.gain.gain.value=.024,w.eqs.mid.frequency.value=800,w.eqs.mid.gain.value=3,b.eqs.bass.gain.value=6,b.eqs.bass.frequency.value=80,b.eqs.mid.gain.value=-6,b.eqs.mid.frequency.value=500,b.eqs.treble.gain.value=-2,b.eqs.treble.frequency.value=1400;let k=["G4 q","A4 q","B4 h","B4 h","A4 q","F#4 q","F#4 h","F#4 h","A4 h","G4 q","F#4 q","E4 q","D4 q","C4 q","F#4 q","G4 h","A4 q","B4 q","B4 q","B4 q","A4 h","B4 q","B4 q","F#4 h"],_=["G3 h","D3 h","G3 h","D3 h","B3 h","D3 h","D3 h","G3 h","C3 h","D3 h","G3 h","E3 h","A3 h","D3 h","G3 h","D3 q"],g=[...k,...k,"E4 q","F#4 q","G4 h","G4 h","A4 q","B4 q","C5 q","B4 q","A4 h","A4 h","F#4 q","G4 q","E4 q","F#4 q","A4 q","G4 q","F#4 h","G4 q","B4 q","C5 h","A4 h","D5 q","C4 q","B3 h",...k],v=[..._,..._,"E3 h","D3 h","G3 h","C3 h","A3 h","C3 h","B3 h","D3 h","D3 h","B3 h","D3 h","B3 h","C3 h","G3 h","E3 h","G3 q",..._],y=new h(c,u,g),C=new h(c,u,v);function E(){y.stop(),C.stop(),x.stop(),G.stop(),w.stop(),m.stop(),b.stop()}y.staccato=.55,C.staccato=.6,C.smoothing=.01,y.gain.gain.value=.07,C.gain.gain.value=.024,y.eqs.mid.frequency.value=800,y.eqs.mid.gain.value=3,C.eqs.bass.gain.value=6,C.eqs.bass.frequency.value=80,C.eqs.mid.gain.value=-6,C.eqs.mid.frequency.value=500,C.eqs.treble.gain.value=-2,C.eqs.treble.frequency.value=1400;let A=[],M=[],B=["A4 q","B4 q","C4 h","D4 q","D#4 q","E4 h","G4 q","F#4 q","E4 h","C4 q","D4 q","B4 h","E4 q","F#4 q","G#4 h","A4 hs","- q","C4 q","B4 q","G4 h","A4 w"];A=[...B,...B,"E4 q","F#4 q","G#4 h","A4 h","B4 q","A4 q","C4 qs","D4 e","F#4 q","E4 q","G4 h","A4 h","B4 q","A4 q","G#4 q","E4 q","F4 h","D#4 q","E4 q","C4 hs","- q","A4 q","- q","- h",...B];let P=["A3 q","E3 q","A3 q","C3 q","E3 q","G#3 q","B3 q","D3 q","D3 q","A3 q","F#3 h","B3 q","F3 q","D3 h","F3 q","C3 q","F3 h","A3 q","C#3 q","E3 h","G3 q","D3 q","G3 h","A3 q","E3 q","A3 q","C3 q"];M=[...P,...P,"C3 q","B3 q","F3 q","D3 q","E3 q","G#3 q","B3 q","D3 q","A3 q","C3 q","E3 h","F3 q","A3 q","C3 h","D3 q","A3 q","F3 h","E3 q","G#3 q","B3 h","A3 q","E3 q","A3 q","C3 q","A3 h","A3 h",...P];let x=new h(c,u,A),G=new h(c,u,M);x.gain.gain.value=.07,G.gain.gain.value=.024,x.staccato=.55,G.staccato=.6,G.smoothing=.01;const $=e=>Math.sin(e),F=e=>(e%6.28-3.14)/6.28,D=e=>{return t=1e3*Math.sin(e),Math.max(Math.min(t,1),-1);var t};async function L(e,t){let o=c.sampleRate,i=c.createBuffer(1,o*e,o),n=i.getChannelData(0),s=i.length;for(let e=0;e<s;e++)n[e]=t(44100*e/o)*(1-e/s)*.4;return await async function(){return new Promise(e=>setTimeout(e,0))}(),i}function T(e){let t=c.createBufferSource();t.buffer=e,t.connect(c.destination),t.start()}const K=()=>Math.random();let I=await L(.3,e=>.1*$(e/44100*2*Math.PI*440*F(e/44100*2*Math.PI*440)*.1)),R=await L(.2,e=>.1*D(e/44100*2*Math.PI*440*F(e/44100*2*Math.PI*440*e/100)*.1)),j=await L(3,e=>e/44100%.2<.1?.5*$(.05*K()+2*e*Math.PI*140/44100):e/44100<.6?.2*$(2*F(e/44100*2*Math.PI*840)*Math.PI*340/44100):.1*$(2*e*Math.PI*840/44100)),S=await L(4,e=>e/44100%.04<.02?.1*D(2*e*Math.PI*(840*e/.4)/44100):e/44100<.6?.2*D(2*F(e/44100*2*Math.PI*(e/500+340))*Math.PI*340/44100):.1*D(2*e*Math.PI*(e/10500+660)/44100));const z={drop:await L(.12,e=>e/44100%.2<.1?.5*$(.05*K()+2*e*Math.PI*140/44100):e/44100<.6?.2*$(e/44100*2*Math.PI*(100+.1*e)):.1*$(2*e*Math.PI*840/44100)),correct:j,next:R,chapter:I,done_chapter:S},O=e=>(e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24),N=e=>(e=e>>>8&16711935|(16711935&e)<<8)>>>16&65535|(65535&e)<<16,Q=e=>N(e=(e=(e=e>>>1&1431655765|(1431655765&e)<<1)>>>2&858993459|(858993459&e)<<2)>>>4&252645135|(252645135&e)<<4);class W{lo;hi;constructor(e,t){this.lo=0|e,this.hi=0|t}static fromSquare(e){return e>=32?new W(0,1<<e-32):new W(1<<e,0)}static fromRank(e){return new W(255,0).shl64(8*e)}static fromFile(e){return new W(16843009<<e,16843009<<e)}static empty(){return new W(0,0)}static full(){return new W(4294967295,4294967295)}static corners(){return new W(129,2164260864)}static center(){return new W(402653184,24)}static backranks(){return new W(255,4278190080)}static backrank(e){return"white"===e?new W(255,0):new W(0,4278190080)}static lightSquares(){return new W(1437226410,1437226410)}static darkSquares(){return new W(2857740885,2857740885)}complement(){return new W(~this.lo,~this.hi)}xor(e){return new W(this.lo^e.lo,this.hi^e.hi)}union(e){return new W(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new W(this.lo&e.lo,this.hi&e.hi)}diff(e){return new W(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?W.empty():e>=32?new W(this.hi>>>e-32,0):e>0?new W(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?W.empty():e>=32?new W(0,this.lo<<e-32):e>0?new W(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new W(N(this.hi),N(this.lo))}rbit64(){return new W(Q(this.hi),Q(this.lo))}minus64(e){const t=this.lo-e.lo,o=(t&e.lo&1)+(e.lo>>>1)+(t>>>1)>>>31;return new W(t,this.hi-(e.hi+o))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return O(this.lo)+O(this.hi)}isEmpty(){return 0===this.lo&&0===this.hi}nonEmpty(){return 0!==this.lo||0!==this.hi}has(e){return 0!=(e>=32?this.hi&1<<e-32:this.lo&1<<e)}set(e,t){return t?this.with(e):this.without(e)}with(e){return e>=32?new W(this.lo,this.hi|1<<e-32):new W(this.lo|1<<e,this.hi)}without(e){return e>=32?new W(this.lo,this.hi&~(1<<e-32)):new W(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new W(this.lo,this.hi^1<<e-32):new W(this.lo^1<<e,this.hi)}last(){return 0!==this.hi?63-Math.clz32(this.hi):0!==this.lo?31-Math.clz32(this.lo):void 0}first(){return 0!==this.lo?31-Math.clz32(this.lo&-this.lo):0!==this.hi?63-Math.clz32(this.hi&-this.hi):void 0}withoutFirst(){return 0!==this.lo?new W(this.lo&this.lo-1,this.hi):new W(0,this.hi&this.hi-1)}moreThanOne(){return 0!==this.hi&&0!==this.lo||!!(this.lo&this.lo-1)||!!(this.hi&this.hi-1)}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let e=this.lo,t=this.hi;for(;0!==e;){const t=31-Math.clz32(e&-e);e^=1<<t,yield t}for(;0!==t;){const e=31-Math.clz32(t&-t);t^=1<<e,yield 32+e}}*reversed(){let e=this.lo,t=this.hi;for(;0!==t;){const e=31-Math.clz32(t);t^=1<<e,yield 32+e}for(;0!==e;){const t=31-Math.clz32(e);e^=1<<t,yield t}}}const X=e=>e>>3,V=e=>7&e,U=(e,t)=>0<=e&&e<8&&0<=t&&t<8?e+8*t:void 0,Y=(e,t)=>{let o=W.empty();for(const i of t){const t=e+i;0<=t&&t<64&&Math.abs(V(e)-V(t))<=2&&(o=o.with(t))}return o},Z=e=>{const t=[];for(let o=0;o<64;o++)t[o]=e(o);return t},H=Z(e=>Y(e,[-9,-8,-7,-1,1,7,8,9])),J=Z(e=>Y(e,[-17,-15,-10,-6,6,10,15,17])),ee={white:Z(e=>Y(e,[7,9])),black:Z(e=>Y(e,[-7,-9]))},te=Z(e=>W.fromFile(V(e)).without(e)),oe=Z(e=>W.fromRank(X(e)).without(e)),ie=Z(e=>{const t=new W(134480385,2151686160),o=8*(X(e)-V(e));return(o>=0?t.shl64(o):t.shr64(-o)).without(e)}),ne=Z(e=>{const t=new W(270549120,16909320),o=8*(X(e)+V(e)-7);return(o>=0?t.shl64(o):t.shr64(-o)).without(e)}),se=(e,t,o)=>{let i=o.intersect(t),n=i.bswap64();return i=i.minus64(e),n=n.minus64(e.bswap64()),i.xor(n.bswap64()).intersect(t)},re=(e,t)=>{const o=W.fromSquare(e);return se(o,ie[e],t).xor(se(o,ne[e],t))},ae=(e,t)=>((e,t)=>se(W.fromSquare(e),te[e],t))(e,t).xor(((e,t)=>{const o=oe[e];let i=t.intersect(o),n=i.rbit64();return i=i.minus64(W.fromSquare(e)),n=n.minus64(W.fromSquare(63-e)),i.xor(n.rbit64()).intersect(o)})(e,t)),le=(e,t,o)=>{switch(e.role){case"pawn":return((e,t)=>ee[e][t])(e.color,t);case"knight":return(e=>J[e])(t);case"bishop":return re(t,o);case"rook":return ae(t,o);case"queen":return((e,t)=>re(e,t).xor(ae(e,t)))(t,o);case"king":return(e=>H[e])(t)}};function he(e){return function(e){let t=[],o=function(e){let t=[],o=function(e){let t=W.empty();for(let o of Object.keys(e))t=t.set(e[o],!0);return t}(e);for(let i of Object.keys(e)){let n=we(i),s=e[i],r=le(n,s,o);for(let a of r)for(let l of Object.keys(e))if(e[l]===a){let a,h=e[l],c=o.without(h),u=le(n,s,c).diff(r);for(let t of u)for(let o of Object.keys(e))e[o]===t&&(a=o);void 0!==a?t.push([i,l,a]):t.push([i,l])}}return t.sort((e,t)=>e.join(" ").localeCompare(t.join(" "))),t}(e);for(let i of Object.keys(e)){let e=[],n=[],s=[],r=[],a=[];for(let t of o)t[0]===i?2===t.length?e.push(t[1]):r.push([t[1],t[2]]):t[1]===i?2===t.length?n.push(t[0]):s.push([t[0],t[2]]):t[2]===i&&a.push([t[0],t[1]]);t.push({p1:i,attacks:e,attacked_by:n,blocks:s,blocked_attacks:r,blocked_attacked_by:a})}return t}(fe(e))}const ce=e=>!e.attacked_by.find(e=>e.toLowerCase()===e)&&!e.blocked_attacked_by.find(e=>e[0].toLowerCase()===e[0])&&!e.blocks.find(e=>e[0].toLowerCase()===e[0]),ue=e=>!e.attacked_by.find(e=>e.toLowerCase()!==e)&&!e.blocked_attacked_by.find(e=>e[0].toLowerCase()!==e[0])&&!e.blocks.find(e=>e[0].toLowerCase()!==e[0]);function pe(e){let t=e.p1,o=e.attacks.map(e=>`+${e}`).join(" "),i=e.attacked_by.map(e=>`${e}+`).join(" "),n=e.blocks.map(e=>`${e[0]}+|${e[1]}`).join(" "),s=e.blocked_attacks.map(e=>`+${e[0]}/${e[1]}`).join(" "),r=e.blocked_attacked_by.map(e=>`${e[0]}+/${e[1]}`).join(" "),a=[t];return ce(e)&&a.push("z+"),ue(e)&&a.push("Z+"),""!==o&&a.push(o),""!==i&&a.push(i),""!==n&&a.push(n),""!==s&&a.push(s),""!==r&&a.push(r),a.join(" ")}function fe(e){e=e.split(" ")[0];let t={},o=7;for(let i of e.split("/")){let e=0;for(let n of i)if(qe(n)){let i=U(e,o);if(void 0!==i){let e=n,o=2;for(;void 0!==t[e];)e=n+o,o++;t[e]=i}e+=1}else e+=parseInt(n);o-=1}return t}const de={r:"rook",n:"knight",b:"bishop",p:"pawn",q:"queen",k:"king"};function qe(e){return void 0!==de[e.toLowerCase()]}function we(e){var t;return{color:(t=e).toLowerCase()===t?"black":"white",role:de[e.toLowerCase().replace(/[2345678]/,"")]}}let me,be;console.log(he("8/8/4r3/r1n5/1k1B4/6Np/1PP1n3/2KRR3 w - - 0 1").map(pe));const ke=(e=!1)=>{let{chapter:t}=ft[pt];(e||be!==t)&&(E(),clearTimeout(me),me=setTimeout(()=>{0===t?function(){let e=c.currentTime;y.play(e),C.play(e)}():1===t?function(){let e=c.currentTime;x.play(e),G.play(e)}():2===t&&function(){let e=c.currentTime;w.play(e),b.play(e)}(),be=t},1e3))};let _e,ge,ve,ye,Ce=await function(){let e=new Image;return new Promise(t=>{e.onload=()=>t(e),e.src="s.png"})}();function Ee(e,t,o,i=1,n=i){let s,r,a;t=Math.floor(t),o=Math.floor(o),e<4?(s=32,r=32*e,a=0):e<28?(s=16,r=(e-=4)%8*16,a=32+16*Math.floor(e/8)):(s=8,r=(e-=28)%16*8,a=80+8*Math.floor(e/16)),ge.drawImage(Ce,r,a,s,s,t,o,s*i,s*n)}function Ae(e,t,o,i,n){const s=e.split(" ");let r="",a=o;for(let e=0;e<s.length;e++){const o=r+s[e]+" ";ye.measureText(o).width>i&&e>0?(ye.fillText(r,t,a),r=s[e]+" ",a+=n):r=o}ye.fillText(r,t,a)}function Me(){if(ye.clearRect(0,0,1920,1080),ge.fillStyle="black",ge.fillRect(0,0,480,270),wt)return function(){if(-1===mt&&(ye.strokeStyle=vt%1e3<500?"white":"gray",ye.lineWidth=3,ye.font="80px Arial",ye.strokeText("click to begin",100,1e3)),mt>5500)Ee(0,200,50,2.5),Ee(98,300,100,5);else if(mt>4e3)Ee(1,280,90,3);else if(mt>1800)Ee(4,280,90,6);else if(mt>800)Ee(10,290,90,6);else if(-1===mt){let e=vt%4e3;Ee(e<500||e>800&&e<1300?100:99,300,100,5),Ee(101,180,150,6)}}(),void Ee(28,...ut);Ee(110,0,0,320);let e=10,t=24;for(let o=0;o<8;o++)for(let i=0;i<8;i++)Ee(108+((o+i)%2==1?1:0),e+3.5*o*8,t+3.5*i*8,3.5);e=10,t=0,Ee(111,e,t,28,3),t=248,Ee(111,e,t,28,3);for(let e of ht)Ee(Ue(e.piece),...e.pos,3),e.piece.match(/2/)&&Ee(82,...e.pos,3),e.is_hovering&&Ee(112,...e.pos,3);Ee(111,318,188,20,10),function(e){ye.font="42px Arial",ye.shadowColor="black",ye.shadowBlur=4;let t=1308,o=803.25;Ae(e[0],t,o,600,60),ye.font="28px Arial",t=1308,o=1039.5,Ae(e[1],t,o,600,60)}(gt||kt||_t||bt),Ee(111,238,2,30,23);let o=at.find(e=>e.is_hovering);if(o){let[e,t,i,n]=o.bb;ge.strokeRect(e,t,i,n);for(let e of o.circles)Ee(112,...e,3);for(let e of o.no_arrows)Re(e[0],e[1],"red");for(let e of o.yes_arrows)Re(e[0],e[1],"green")}for(let e of rt)Ee(e[0],e[1],e[2]);lt&&Ee(Ue(lt.piece),...lt.pos,3),void 0!==kt&&function(e,t,o,i){for(let e=0;e<5;e++)Ee(119+e,400+8*e*2,i,2)}(0,0,0,246+(Ct&&vt%500<200?2:0)),function(){let e=Ke,t=Ie;Ee(111,238,188,9.8,10);let o=ft[pt];ye.font="bold 64px Arial",ye.fillText(`${o.chapter}-${o.level}`,265*e,204*t);let i=vt%500<250?3:0,n=At?i:0;Ee(117,242-(Et?i:0),190,2),Ee(118,296+n,190,2),Ee(xe+(ft[pt].is_revealed?16:ft[pt].is_solved?8:0),250,214,3),Ee(void 0===Pt||Pt?116:115,298,214,2)}();for(let e of Gt)Ee(Ue(e.piece),...e.pos,4),e.piece.match(/2/)&&Ee(82,...e.pos,4);if(xt>0&&Ee(2,60,60,4),Ee(28,...ut),Mt){let e=80*Math.sin(.008*vt),t=80*Math.sin(.008*vt),o=80*Math.sin(.003*vt);ye.font="bold 180px Arial",ye.shadowColor="purple",ye.shadowBlur=10,ye.lineWidth=4,ye.strokeStyle="purple",ye.strokeText("Mor",200+e,400+t),ye.strokeText("Chess",1e3-e,400+t),ye.fillStyle="white",ye.shadowBlur=0,ye.fillText("Mor",200+e,400+t),ye.fillText("Chess",1e3-e,400+t),ye.fillStyle="black",ye.fillText("Black",200,800-.1*o),ye.fillText("Cat",800,800-.1*o)}}let Be,Pe,xe,Ge,$e=[250,214,48,48],Fe=[298,214,16,16];const De={neutral:4,happy:5,sad:6,angry:7,surprised:8,sleepy:9,playful:10},Le=[242,190,16,16],Te=[296,190,16,16],Ke=4,Ie=4;function Re(e,t,o){ye.lineWidth=10,ye.strokeStyle=o,ye.lineCap="round",ye.beginPath(),ye.moveTo(e[0]*Ke,e[1]*Ie),ye.lineTo(t[0]*Ke,t[1]*Ie),ye.stroke()}const je=[400,246,80,16];function Se(e,t){return pe(e)===pe(t)}const ze=(e,t,o)=>rt.push([e,t,o,0]),Oe=(e,t,o,i,n,s,r,a)=>at.push({info:e,bb:[t,o,i,n],is_hovering:!1,circles:s,yes_arrows:r,no_arrows:a});function Ne(e,t,o){const i=e=>ht.filter(t=>t.piece===e&&void 0!==Je(t.pos)).map(e=>e.pos),n=(e,t)=>{let o=ht.filter(t=>t.piece===e&&void 0!==Je(t.pos)).map(e=>e.pos)[0],i=ht.filter(e=>e.piece===t&&void 0!==Je(e.pos)).map(e=>e.pos)[0];return o&&i?[[[o[0]+12,o[1]+12],[i[0]+12,i[1]+12]]]:[]};let s=[],r=[],a=[];const l=(e,t,o,i,n)=>{Oe(e,t,o,i,n,s,r,a),s=[],r=[],a=[]},h=ze;h(Ue(e.p1),t+4,o+4),e.p1.match(/2/)&&h(82,t+4,o+4),s=i(e.p1),l(Qe.yes_piece(e.p1),t+2,o+2,12,12),h(39,(t+=8)+4,o+4),t+=8;let c=tt();if(ce(e)){let r=c.find(t=>t.p1===e.p1),u=r?.attacked_by.filter(e=>e.toLowerCase()===e)??[];u=u.concat(r?.blocks.map(e=>e[0]).filter(e=>e.toLowerCase()===e)??[]),a=[...u.flatMap(t=>n(e.p1,t))],e.p1.toLowerCase()===e.p1?h(33,t+4,o+4):h(32,t+4,o+4),s=i(e.p1),l(Qe.zero_attacked_by_lower(e.p1),t+2,o+2,12,12),t+=12}if(ue(e)){let r=c.find(t=>t.p1===e.p1),u=r?.attacked_by.filter(e=>e.toLowerCase()!==e)??[];u=u.concat(r?.blocks.map(e=>e[0]).filter(e=>e.toLowerCase()!==e)??[]),a=[...u.flatMap(t=>n(e.p1,t))],e.p1.toLowerCase()===e.p1?h(32,t+4,o+4):h(33,t+4,o+4),s=i(e.p1),l(Qe.zero_attacked_by_upper(e.p1),t+2,o+2,12,12),t+=12}for(let i of e.attacks){h(35,t+2,o+4);let s=c.find(t=>t.p1===e.p1);0===(s?.attacks.filter(e=>e===i)??[]).length?a=[...n(e.p1,i)]:r=[...n(e.p1,i)],l(Qe.attacks(e.p1,i),t+4,o+2,14,12),t+=5,h(Ue(i),t+4,o+4),i.match(/2/)&&h(82,t+4,o+4),t+=9}for(let u of e.attacked_by){h(Ue(u),t+4,o+4),u.match(/2/)&&h(82,t+4,o+4);let p=c.find(t=>t.p1===e.p1);0===(p?.attacked_by.filter(e=>e===u)??[]).length?a=[...n(e.p1,u)]:r=[...n(e.p1,u)],s=i(e.p1),l(Qe.attacked_by(e.p1,u),t+4,o+2,14,12),h(34,(t+=9)+2,o+4),t+=5}for(let i of e.blocks){h(Ue(i[1]),t+4,o+4),i[1].match(/2/)&&h(82,t+4,o+4);let s=c.find(t=>t.p1===e.p1);0===(s?.blocks.filter(e=>e[0]===i[0]&&e[1]===i[1])??[]).length?a=[...n(i[0],i[1]),...n(e.p1,i[1])]:r=[...n(i[0],i[1])],l(Qe.blocks(e.p1,...i),t+4,o+2,24,12),h(36,(t+=9)+2,o+4),t+=5,h(Ue(i[0]),t+4,o+4),i[0].match(/2/)&&h(82,t+4,o+4),t+=9}for(let i of e.blocked_attacks){h(Ue(i[1]),t+4,o+4),i[0].match(/2/)&&h(82,t+4,o+4);let s=c.find(t=>t.p1===e.p1);0===(s?.blocked_attacks.filter(e=>e[0]===i[0]&&e[1]===i[1])??[]).length?a=[...n(i[0],i[1]),...n(e.p1,i[1])]:r=[...n(e.p1,i[1])],l(Qe.blocked_attacks(e.p1,i[1],i[0]),t+4,o+2,24,12),h(37,(t+=9)+2,o+4),t+=5,h(Ue(i[0]),t+4,o+4),i[0].match(/2/)&&h(82,t+4,o+4),t+=9}for(let i of e.blocked_attacked_by){h(Ue(i[1]),t+4,o+4),i[1].match(/2/)&&h(82,t+4,o+4);let s=c.find(t=>t.p1===e.p1),u=s?.blocked_attacked_by.filter(e=>e[0]===i[0]&&e[1]===i[1])??[];0===u.length?a=[...n(i[0],i[1]),...n(e.p1,i[0])]:r=[...n(e.p1,i[0])],u=s?.attacked_by.filter(e=>e===i[0]).map(e=>[e,e])??[],u=u.concat(s?.blocks.filter(e=>e[0]===i[0])??[]),u.length>0&&(a=[...n(e.p1,i[0])]),l(Qe.blocked_attacked_by(e.p1,i[0],i[1]),t+4,o+2,24,12),h(38,(t+=9)+2,o+4),t+=5,h(Ue(i[0]),t+4,o+4),i[0].match(/2/)&&h(82,t+4,o+4),t+=9}return[t,o]}const Qe={welcome0:["welcome to mor chess; drag pieces onto the board, but there are some rules above. hover over them for details.","drag a piece off the board to remove it."],welcome1:["each chapter; proressively reveals more pieces of a single position.","call out the cat 3 times, if you get in a mess ;)"],welcome2:["chess tactics; are born out of relationships.","our job is to entangle them."],welcome3:["rules are tools to an end.","look here, just enough to keep the cats happy."],well_done:["Congratulations, you satisfied all rules. Time to go deeper.","Click Next to continue."],well_end:["the end; chess is fascinating isn't it, go play some chess.","Thank's for playing"],equals:e=>["left side is the goal, right side is the board; your goal is to match them equal.","this rule "+(e?"has matched correctly.":"has not been matched yet.")],no_piece:e=>[`${Ve(e)} hasn't been placed yet.`,""],yes_piece:e=>[`A ${Ve(e)} on the board.`,""],zero_attacked_by_lower(e){let t=e.toLowerCase()===e?"defenders":"attackers";return[`${Ve(e)} has zero ${t}.`,""]},zero_attacked_by_upper(e){let t=e.toLowerCase()===e?"attackers":"defenders";return[`${Ve(e)} has zero ${t}.`,""]},attacks(e,t){let o=Ve(e),i=Ve(t);return[`${o} is ${We(e,t)} ${i}.`,`${i} shouldn't be blocking an attack of ${o}.`]},attacked_by(e,t){let o=Ve(e),i=Ve(t);return[`${o} is ${Xe(e,t)} by ${i}.`,`${o} shouldn't be blocking an attack of ${i}.`]},blocks(e,t,o){let i=Ve(e),n=Ve(t),s=Ve(o);return[`${i} blocks ${n} ${We(t,o)} ${s}.`,""]},blocked_attacks(e,t,o){let i=Ve(e),n=Ve(t),s=Ve(o);return[`${i} is ${We(e,t)} ${n}, but that's blocked by ${s}.`,""]},blocked_attacked_by(e,t,o){let i=Ve(e),n=Ve(t),s=Ve(o);return[`${i} is ${Xe(e,t)} by ${n}, but that's blocked by ${s}.`,""]}},We=(e,t)=>e.toLowerCase()===e==(t.toLowerCase()===t)?"defending":"attacking",Xe=(e,t)=>e.toLowerCase()===e==(t.toLowerCase()===t)?"defended":"attacked";function Ve(e){let t=we(e),o=e.match(/2/)?"2":"";return t.role[0].toUpperCase()+t.role.slice(1)+o}function Ue(e){let t=we(e);return 76+{pawn:0,rook:1,bishop:2,knight:3,queen:4,king:5}[t.role]+("white"===t.color?16:0)}function Ye(o){if(xt-=o,mt>0&&(mt-=o,mt<=0&&(wt=!1)),Ge-=o,Ge<0&&(Ge=0),Ge>1e3&&(Ge=0,ft[pt].is_revealed||(ft[pt].is_revealed=!0,function(){$t();let e=fe(ft[pt].fen);for(let t of Object.keys(e)){let o=V(e[t]),i=X(e[t]);ht.push(nt(t,He([o,7-i])))}st=!0}())),Pe-=o,vt+=o,Pe<0&&(xe=vt%1e4<2e3?De.sleepy:De.neutral),ct.is_hovering){ut=ct.is_hovering;for(let e of ht)e.is_hovering=!1;for(let e of ht)if(t(it(e),ot(ut))){e.is_hovering=!0;break}if(void 0!==lt)lt.pos=[ut[0]-4,ut[1]-4];else{for(let e of at)e.is_hovering=!1;for(let e of at)t(e.bb,ot(ut))&&(e.is_hovering=!0)}yt=t($e,ot(ut)),Ct=void 0!==kt&&t(je,ot(ut)),Et=t(Le,ot(ut)),At=t(Te,ot(ut)),yt&&Pe<0&&(xe=De.playful,Pe=260)}if(ct.is_just_down){let e=ht.find(e=>e.is_hovering);e&&(e.is_dragging=!0,lt=nt(e.piece,e.pos),Je(e.pos)&&(lt.orig=e))}if(ct.is_up){if(-1===mt&&wt&&(mt=6e3,T(z.done_chapter)),void 0!==Pt||Bt||(Pt=!1,ke()),lt){if(lt.orig){let e=lt.orig.pos;ht=ht.filter(t=>!(t.pos[0]===e[0]&&t.pos[1]===e[1]))}let e=Je(ct.is_up);if(e){let t=He(e);ht=ht.filter(e=>!(e.pos[0]===t[0]&&e.pos[1]===t[1])),ht.push(nt(lt.piece,t))}!function(){for(let e of ht){let t=Je(e.pos);if(!t)continue;let o=ht.find(o=>{if(o!==e&&o.piece[0]===e.piece[0]){let e=Je(o.pos);if(e){let o=U(...t);if(U(...e)<o)return!0}}})?"2":"";e.piece=e.piece[0]+o}}(),lt=void 0,st=!0,xe=De.surprised,Pe=3e3,T(z.drop)}Ct&&(pt===ft.length-1?Ze(0):Ze(1)),Et&&Ze(-1),At&&Ze(1),t(Fe,ot(ct.is_up))&&(Pt=!Pt,Pt?E():ke(!0)),yt&&(xe=De.sad,Pe=1e3,Ge+=540)}if(st){st=!1,rt=[],at=[];let e=qt(),t=tt(),o=0,i=!0,n=2;for(let s of e){let e=238;[e,n]=Ne(s,e,n);let r=t.find(e=>e.p1===s.p1),a=void 0!==r&&Se(s,r)?30:29;30===a&&o++,i=i&&30===a,ze(a,e+4,n+4),Oe(Qe.equals(30===a),e+2,n+2,12,12,[],[],[]),e+=10,void 0===r?(ze(31,e+4,n+4),Oe(Qe.no_piece(s.p1),e+2,n+2,12,12,[],[],[])):[e,n]=Ne(r,e,n),n+=14,e=182}Be>o&&(xe=De[Math.random()<.8?"angry":"sad"],Pe=1500),Be=o,i?(ft[pt].is_solved=!0,ft.filter(e=>e.chapter===ft[pt].chapter).every(e=>e.is_solved)?T(z.done_chapter):T(z.correct),xe=De.playful,Pe=5e3,pt<ft.length-1?-1===ft.findIndex(e=>!e.is_solved)?Mt=!0:kt=Qe.well_done:-1===ft.findIndex(e=>!e.is_solved)?Mt=!0:kt=Qe.well_end):kt=void 0}if(_t=at.find(e=>e.is_hovering)?.info,ct.update(o),Mt){for(let e of ht)e.pos[1]-=.1*o*Math.random(),e.pos[1]<-20&&(e.pos[1]=400);vt%500<17&&(pt+=1,pt>ft.length-1&&(pt=0),st=!0)}let i=[];for(let t of Gt)vt%300<120&&(t.pos[0]=e(t.pos[0],t.t_pos[0],8),t.pos[1]=e(t.pos[1],t.t_pos[1],8)),t.pos[0]<0||t.pos[1]<0||t.pos[0]>400||t.pos[1]>300||i.push(t);Gt=i}function Ze(e){ke(),ft[pt].is_revealed&&($t(),ft[pt].is_revealed=!1,ft[pt].is_solved=!1);let t=pt+e;if(0===e&&(t=ft.findIndex(e=>!e.is_solved)),t<0||t>=ft.length)return;let o=ft[t].chapter!==ft[pt].chapter;o?(T(z.chapter),$t()):T(z.next),st=!0,pt=t,o&&(bt=Qe[`welcome${ft[pt].chapter}`],xe=De.surprised,Pe=5e3)}function He(e){return[10+3.5*e[0]*8+2,24+3.5*e[1]*8+4]}function Je(e){let[t,o]=e;if(t-=10,o-=24,!(t<0||t>=224||o<0||o>=224))return t=Math.floor(t/28),o=Math.floor(o/28),[t,o]}function et(e){return he(e)}function tt(){return et(function(){let e={};for(let t of ht){let o=Je(t.pos);if(o){let i=t.piece;e[U(...o)]=i}}let t="";for(let o=0;o<8;o++){let i=0;for(let n=0;n<8;n++){let s=U(n,o);e[s]?(i>0&&(t+=i),t+=e[s][0],i=0):i++}i>0&&(t+=i),t+="/"}return t}())}function ot(e){return[e[0]+1,e[1]+1,6,6]}function it(e){let[t,o]=e.pos;return[t,o,24,24]}function nt(e,t){return{piece:e,pos:t,is_hovering:!1,is_dragging:!1,t_pos:[0,0]}}let st,rt,at,lt,ht,ct,ut,pt,ft=[dt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",0,0),dt("6k1/8/8/8/8/8/5P2/6K1 w - - 0 1",0,1),dt("6k1/8/8/8/8/8/6PP/6K1 w - - 0 1",0,2),dt("6k1/8/8/3r4/8/5B2/5P2/6K1 w - - 0 1",0,3),dt("6k1/b7/8/3r4/8/5B2/5P2/6K1 w - - 0 1",0,4),dt("1r4k1/bP6/8/8/8/5B2/5P2/6K1 w - - 0 1",0,5),dt("1r4k1/bP6/4p3/3r4/8/5B2/5P2/6K1 w - - 0 1",0,6),dt("1r4k1/bP6/4p3/p2r4/8/5B2/5P2/R5K1 w - - 0 1",0,7),dt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",1,0),dt("8/1K6/4b3/8/3r4/4k3/8/8 w - - 0 1",1,1),dt("8/1K6/4b3/4R3/3rP3/4k3/8/8 w - - 0 1",1,2),dt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",2,0),dt("8/5k2/8/8/8/8/6PP/6K1 w - - 0 1",2,1),dt("8/5k2/4rn2/8/8/8/6PP/6K1 w - - 0 1",2,2),dt("8/5k2/8/8/8/8/8/R2R2K1 w - - 0 1",2,3),dt("3r4/5k2/8/8/3n4/8/8/3R2K1 w - - 0 1",2,4),dt("3r4/6k1/5rn1/8/3n4/8/6PP/3R2K1 w - - 0 1",2,5),dt("3r4/6k1/5rn1/1p6/2Nn4/8/6PP/R2R2K1 w - - 0 1",2,6),dt("3r4/5k2/4rn2/1p6/2N5/3n4/1B4PP/R2R2K1",2,7),dt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",3,0),dt("6k1/8/8/8/8/8/7q/1K1Q4 w - - 0 1",3,1),dt("6k1/7p/8/8/8/8/2Pr3q/1K1QR3 w - - 0 1",3,2),dt("6k1/7p/8/6p1/8/8/1PPr3q/1K1QR3 w - - 0 1",3,3)];function dt(e,t,o){return{chapter:t,level:o,fen:e,is_solved:!1,is_revealed:!1}}const qt=()=>et(ft[pt].fen);let wt,mt,bt,kt,_t,gt,vt,yt,Ct,Et,At,Mt,Bt,Pt,xt,Gt;function $t(){xt=1300,Gt=ht.filter(e=>void 0!==Je(e.pos));for(let e of Gt)e.t_pos=[Math.random()<.5?-100:500,600*Math.random()-300];ht=[nt("p",[20,0]),nt("n",[52,0]),nt("b",[84,0]),nt("r",[116,0]),nt("q",[148,0]),nt("k",[180,0]),nt("P",[20,248]),nt("N",[52,248]),nt("B",[84,248]),nt("R",[116,248]),nt("Q",[148,248]),nt("K",[180,248])]}!function(e){_e=document.createElement("canvas"),_e.width=480,_e.height=270,_e.classList.add("pixelated"),ge=_e.getContext("2d"),ge.imageSmoothingEnabled=!1,ge.fillStyle="black",ve=document.createElement("canvas"),ve.width=1920,ve.height=1080,ye=ve.getContext("2d");let t=document.createElement("div");t.classList.add("content"),t.appendChild(_e),t.appendChild(ve),e.appendChild(t),wt=!0,mt=-1,Ge=0,Bt&&E(),Bt=!1,Be=0,xe=De.happy,Pe=5e3,Mt=!1,Et=!1,At=!1,Ct=!1,vt=0,gt=void 0,kt=void 0,_t=void 0,bt=Qe.welcome0,st=!0,rt=[],at=[],pt=0,lt=void 0,ht=[],Gt=[],$t(),ct=o(_e),ut=[0,0],xt=0,function(e,t){const o=1e3/60;let i=performance.now(),n=0;requestAnimationFrame(function s(r){requestAnimationFrame(s);let a=Math.min(r-i,250);for(i=r,n+=a;n>=o;)e(o),n-=o;t(n/o)})}(Ye,Me)}(document.getElementById("app"))</script>