<title>Pacific Black Cats - js13kGames 2025</title><style>body,canvas,html{width:100%;height:100%;margin:0;padding:0;overflow:hidden}</style><canvas id=C></canvas><script>for(var i in KEYS={},MOUSE={pos:[0,0],delta:[0,0],wheel:0,buttons:0},gl=0,DOC=document,BODY=DOC.body,F=0,BODY.onkeydown=BODY.onkeyup=function(e){var t="d"==e.type[3],o="Key"==e.code.substr(0,3)?e.code.substr(3):e.code;KEYS[o]=t?1:0,t&&!0!==window.ONKEY?.(e,e.keyCode)&&e.preventDefault()},D2R=.0174532925,maths=Object.getOwnPropertyNames(Math),maths)window[maths[i].toUpperCase()]=Math[maths[i]];CLAMP=(e,t,o)=>MIN(MAX(e,t),o),SAT=e=>CLAMP(e,0,1),F32=Float32Array,UINT8=Uint8Array,IDM4=new F32([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),ARP=Array.prototype,V3=e=>new F32(e||3),M4=e=>V3(e||IDM4),VP_DATA=V3(4),ZERO=V3(),UP=V3([0,1,0]),TIME=()=>.001*performance.now(),LERP=(e,t,o)=>e*(1-o)+t*o,ILERP=(e,t,o)=>(o-e)/(t-e),REMAP=(e,t,o,a,r)=>LERP(a,r,ILERP(t,o,e)),RAND=(e=1,t=0)=>RANDOM()*e+t,ADD=(e,t,o,a=1)=>(e[0]=t[0]+o[0]*a,e[1]=t[1]+o[1]*a,e[2]=t[2]+o[2]*a,e),SUB=(e,t,o)=>(e[0]=t[0]-o[0],e[1]=t[1]-o[1],e[2]=t[2]-o[2],e),SCALE=(e,t,o)=>(e=e||V3(),o.length?(e[0]=t[0]*o[0],e[1]=t[1]*o[1],e[2]=t[2]*o[2]):(e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o),e),DOT=(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],CROSS=(e,t,o)=>{var a=t[0],r=t[1],l=t[2],i=o[0],E=o[1],s=o[2];return e[0]=r*s-l*E,e[1]=l*i-a*s,e[2]=a*E-r*i,e},ROTY=(e,t,o)=>{e=e||V3();var a=COS(o),r=SIN(o),l=t[0],i=t[2];return e[0]=a*l-r*i,e[1]=t[1],e[2]=r*l+a*i,e},LERPV3=(e,t,o,a)=>{for(var r=0;r<e.length;++r)e[r]=t[r]*(1-a)+o[r]*a;return e},LEN=e=>SQRT(DOT(e,e)),DIST=(e,t)=>LEN(SUB(V3(),e,t)),NORM=(e,t,o=1)=>(t=t||e,SCALE(e,t,o/(LEN(t)||1))),TMAT4=(e,t)=>(e.set(IDM4),e[12]=t[0],e[13]=t[1],e[14]=t[2],e),RMAT4=(e,t,o)=>{e.set(IDM4);var a,r,l,i=o[0],E=o[1],s=o[2],n=SQRT(i*i+E*E+s*s);return n<1e-4?null:(i*=n=1/n,E*=n,s*=n,a=SIN(t),l=1-(r=COS(t)),e[0]=i*i*l+r,e[1]=E*i*l+s*a,e[2]=s*i*l-E*a,e[4]=i*E*l-s*a,e[5]=E*E*l+r,e[6]=s*E*l+i*a,e[8]=i*s*l+E*a,e[9]=E*s*l-i*a,e[10]=s*s*l+r,e)},SMAT4=(e,t)=>(e.set(IDM4),t.toFixed&&(t=[t,t,t]),e[0]=t[0],e[5]=t[1],e[10]=t[2],e),APPLYTRANS=(e,t,o,a)=>{var r=TMAT4(M4(),o);return MULTMAT4(e||r,a?r:t,a?t:r)},APPLYROT=(e,t,o,a)=>{var r=RMAT4(M4(),o,a);return MULTMAT4(e||r,t,r)},APPLYSCALE=(e,t,o)=>{var a=SMAT4(M4(),o);return MULTMAT4(e||a,t,a)},TRS=(e,t,o,a=1,r=0)=>{e=e||M4();var l=TMAT4(M4(),t),i=M4();o&&(o[0]&&APPLYROT(i,i,o[0],[1,0,0]),o[1]&&APPLYROT(i,i,o[1],[0,1,0]),o[2]&&APPLYROT(i,i,o[2],[0,0,1]));var E=SMAT4(M4(),a);return MULTMAT4(e,r||M4(),l),MULTMAT4(e,e,i),MULTMAT4(e,e,E)},MULTMAT4=(e,t,o)=>{var a=t[0],r=t[1],l=t[2],i=t[3],E=t[4],s=t[5],n=t[6],A=t[7],T=t[8],S=t[9],M=t[10],f=t[11],R=t[12],C=t[13],p=t[14],L=t[15],O=o[0],I=o[1],c=o[2],P=o[3];return e[0]=O*a+I*E+c*T+P*R,e[1]=O*r+I*s+c*S+P*C,e[2]=O*l+I*n+c*M+P*p,e[3]=O*i+I*A+c*f+P*L,O=o[4],I=o[5],c=o[6],P=o[7],e[4]=O*a+I*E+c*T+P*R,e[5]=O*r+I*s+c*S+P*C,e[6]=O*l+I*n+c*M+P*p,e[7]=O*i+I*A+c*f+P*L,O=o[8],I=o[9],c=o[10],P=o[11],e[8]=O*a+I*E+c*T+P*R,e[9]=O*r+I*s+c*S+P*C,e[10]=O*l+I*n+c*M+P*p,e[11]=O*i+I*A+c*f+P*L,O=o[12],I=o[13],c=o[14],P=o[15],e[12]=O*a+I*E+c*T+P*R,e[13]=O*r+I*s+c*S+P*C,e[14]=O*l+I*n+c*M+P*p,e[15]=O*i+I*A+c*f+P*L,e},LOOKAT=(e,t,o,a)=>{e.set(IDM4);var r=0,l=0,i=0,E=0,s=0,n=0,A=0,T=0,S=0,M=0,f=t[0],R=t[1],C=t[2],p=a[0],L=a[1],O=a[2],I=o[0],c=o[1],P=o[2];return ABS(f-I)<1e-4&&ABS(R-c)<1e-4&&ABS(C-P)<1e-4||(A=f-I,T=R-c,S=C-P,r=L*(S*=M=1/SQRT(A*A+T*T+S*S))-O*(T*=M),l=O*(A*=M)-p*S,i=p*T-L*A,(M=SQRT(r*r+l*l+i*i))?(r*=M=1/M,l*=M,i*=M):(r=0,l=0,i=0),E=T*i-S*l,s=S*r-A*i,n=A*l-T*r,(M=SQRT(E*E+s*s+n*n))?(E*=M=1/M,s*=M,n*=M):(E=0,s=0,n=0),e[0]=r,e[1]=E,e[2]=A,e[4]=l,e[5]=s,e[6]=T,e[8]=i,e[9]=n,e[10]=S,e[12]=-(r*f+l*R+i*C),e[13]=-(E*f+s*R+n*C),e[14]=-(A*f+T*R+S*C)),e},PERSP=(e,t,o,a,r)=>{var l=1/TAN(t*D2R/2),i=0;return e[0]=l/o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==1/0?(i=1/(a-r),e[10]=(r+a)*i,e[14]=2*r*a*i):(e[10]=-1,e[14]=-2*a),e},ORTHO=(e,t,o,a,r,l,i)=>{var E=1/(t-o),s=1/(a-r),n=1/(l-i);return e[0]=-2*E,e[5]=-2*s,e[10]=2*n,e[12]=(t+o)*E,e[13]=(r+a)*s,e[14]=(i+l)*n,e},MAT4xV3=(e,t,o,a=1)=>{var r=o[0],l=o[1],i=o[2];return e[0]=t[0]*r+t[4]*l+t[8]*i+t[12]*a,e[1]=t[1]*r+t[5]*l+t[9]*i+t[13]*a,e[2]=t[2]*r+t[6]*l+t[10]*i+t[14]*a,e};var VIEW_M4=M4(),PROJ_M4=M4(),VP_M4=M4(),MVP_M4=M4(),CAM_EYE=V3(),CAM_CENTER=V3(),CAM_FRONT=V3(),CAM_RIGHT=V3(),CAM_TOP=V3(),EXTRACTPLANES;function _INITGL(){gl.ext={},gl.getSupportedExtensions().map(e=>gl.ext[e]=gl.getExtension(e)),QUAD=MESH(PLANEG),QUADSHADER=PROGRAM(quad_vs,"in vec2 _uv;IN sampler2D tex;void main(){fC=texture(tex,_uv);;}"),FLATSHADER=PROGRAM(_vs,_fs).uniforms({psize:1})}CAMERA=(e,t,o,a,r,l=.1,i=1e3,E=0)=>{CAM_EYE.set(e),CAM_CENTER.set(t),SUB(CAM_FRONT,CAM_CENTER,CAM_EYE),NORM(CAM_FRONT,CAM_FRONT),CROSS(CAM_RIGHT,CAM_FRONT,o),NORM(CAM_RIGHT,CAM_RIGHT),LOOKAT(VIEW_M4,e,t,o),E?ORTHO(PROJ_M4,-a*r,a*r,-a,a,l,i):PERSP(PROJ_M4,a,r,l,i),MULTMAT4(VP_M4,PROJ_M4,VIEW_M4),EXTRACTPLANES?.(VP_M4)},INIT=e=>{gl||(gl=e.getContext("webgl2",{}),_INITGL()),VIEWPORT(0,0,e.width,e.height)},INPUT=e=>{e.oncontextmenu=e=>!1,e.onmousedown=e.onmouseup=e.onmousemove=e=>{e.preventDefault(),MOUSE.delta[0]=e.pageX-MOUSE.pos[0]+e.movementX,MOUSE.delta[1]=e.pageY-MOUSE.pos[1]+e.movementY,MOUSE.pos[0]=e.pageX,MOUSE.pos[1]=e.pageY,MOUSE.buttons=e.buttons,window.ONMOUSE?.(e)},BODY.onwheel=e=>MOUSE.wheel=e.deltaY},END=()=>{MOUSE.delta.fill(0),MOUSE.wheel=0},VIEWPORT=(e,t,o,a)=>{VP_DATA.set([e,t,o,a]),gl.viewport(e,t,o,a)},SHADER=(e,t=0)=>{var o=gl.createShader(35632+t);return gl.shaderSource(o,"#version 300 es\nprecision highp float;\n#define IN uniform\nin vec3 pos;uniform mat4 model;\n"+(t?"":"out vec4 fC;\n")+e),gl.compileShader(o),o},_vs="in vec2 uv;out vec2 _uv;IN float psize;IN mat4 viewp;void main(){_uv=uv;gl_Position = viewp*model*vec4(pos,1.0);gl_PointSize=psize;;}",_fs="IN vec4 color;void main(){fC=color;;}",_texfs="IN sampler2D tex;IN vec4 color;void main(){fC=color*texture(tex,_uv);;}",quad_vs="out vec2 _uv;void main(){ _uv=pos.xy*0.5+vec2(0.5);gl_Position=vec4(pos,1.0);;}",PROGRAM=(e=_vs,t=_fs,o=[])=>{let a,r,l=o.map(e=>"#define "+e).join("\n"),i=gl.createProgram(),E=gl.getProgramParameter.bind(gl);for(gl.attachShader(i,SHADER(l+e,1)),gl.attachShader(i,SHADER(l+t)),gl.linkProgram(i),i.unif={},i.attr={},a=0,r=E(i,35718);a<r;++a){var s=(n=gl.getActiveUniform(i,a)).name;s=s.substr(0,s.length-(n.size>1?3:0)),(i.unif[s]=n).loc=gl.getUniformLocation(i,s),n.func=gl["uniform"+{5124:"1i",5125:"1ui",5126:"1f",35664:"2fv",35665:"3fv",35666:"4fv",35676:"Matrix4fv",35678:"1i"}[n.type]].bind(gl),n.set=35676==n.type?function(e){this.func(this.loc,!1,e)}:function(e){this.func(this.loc,e)}}for(a=0,r=E(i,35721);a<r;++a){var n=gl.getActiveAttrib(i,a);(i.attr[n.name]=n).loc=a}return i.bind=()=>gl.useProgram(i),i.uniforms=e=>{if(i.bind(),e)for(var t in e)i.unif[t]?.set(e[t]);return i},i.set=(e,t)=>i.unif[e]?.set(t),i},BUFFER=(e,t=3,o=35044)=>{let a=gl.createBuffer(),r=34962+(t?0:1);return e.constructor==Array&&(e=t?V3(e):new Uint16Array(e)),a.b=()=>gl.bindBuffer(r,a),a.update=e=>(e&&a.d.set(e),a.b(),gl.bufferData(r,a.d,o),a),a.bind=(e,o=0)=>{a.b(),null!=e&&(gl.vertexAttribPointer(e,t,5126,!1,0,0),gl.enableVertexAttribArray(e),gl.vertexAttribDivisor(e,o))},a.map=function(e){this.update(this.d.map(e))},a.size=e.length,a.num=t,a.d=e,a.b(),gl.bufferData(r,a.d,o),a},MESH=e=>{let t,o={};for(t in e)e[t]&&(o[t]=BUFFER(e[t],"tris"==t?0:t.length));return o[0]=o.tris?o.tris.size:o.pos.size/3,o},TEX=(e,t,o=null,a=0)=>{var r,l=gl.createTexture();for(l.w=0|e,l.h=0|t,l.bind=(e=0)=>(gl.activeTexture(33984+e),gl.bindTexture(3553,l),l),l.p=(e,t)=>(l.bind(),gl.texParameteri(3553,10240+e,t),l),l.toVP=(e,t)=>{l.bind(),DRAW(QUAD,e||QUADSHADER,t||{tex:0})},l.mips=()=>{l.bind(),gl.generateMipmap(3553)},(l.update=o=>(l.bind(),gl.texImage2D(3553,0,a?33190:6408,0|e,0|t,0,a?6402:6408,a?5125:5121,o)))(o),r=0;r<4;++r)l.p(r,[9729,33071][r/2|0]);return l},FBO=(e,t)=>{var o=gl.createFramebuffer();o.tex=e;var a=o.w=e.w,r=o.h=e.h;return gl.bindFramebuffer(36160,o),gl.framebufferTexture2D(36009,36064,3553,e,0),o.depth=t||TEX(a,r,null,1),gl.framebufferTexture2D(36009,36096,3553,o.depth,0),o.bind=e=>(gl.bindFramebuffer(36160,e?o:null),VIEWPORT(0,0,e?a:C.width,e?r:C.height),o),o.bind(0),o},GLSET=(e,t=1)=>t?gl.enable(e):gl.disable(e),CLEAR=(e,t)=>{e&&gl.clearColor(e[0],e[1],e[2],e[3]),gl.clear((e?16384:0)|(t?256:0))},CULL=2884,ZTEST=2929,BLEND=3042,NEAREST=9728,LINEAR=9729,BLENDFUNC=e=>{var t={A:[770,771],B:[770,1]}[e];gl.blendFunc(t[0],t[1]),GLSET(BLEND,1)},DEPTHW=(e=1)=>gl.depthMask(e),PLANE=(e=1)=>MESH({pos:[-e,0,-e,e,0,e,e,0,-e,e,0,e,-e,0,-e,-e,0,e],uv:[0,0,1,1,1,0,1,1,0,0,0,1]}),PLANEG={pos:[-1,-1,0,1,-1,0,1,1,0,-1,1,0],tris:[0,1,2,0,2,3]},CUBE=(e=1,t=0)=>MESH({pos:[-e,t-e,-e,-e,t-e,e,-e,e+t,-e,-e,e+t,e,e,t-e,-e,e,t-e,e,e,e+t,-e,e,e+t,e],tris:[0,5,1,0,4,5,2,3,7,2,7,6,5,6,7,5,4,6,0,1,3,0,3,2,1,7,3,1,5,7,0,2,4,2,6,4]}),QUAD=0,QUADSHADER=0,FLATSHADER=0,$={},DRAW=(e,t,o,a=4,r=1,l=0,i=-1)=>{if(e&&e.at&&(e=$[e]),(t=t||FLATSHADER).bind(),t.uniforms({viewp:VP_M4,ceye:CAM_EYE,cfront:CAM_FRONT}),t.uniforms(o),!e||!e[0])return;for(var E in e)e[E].bind?.(t.attr[E]?.loc);if(l)for(var E in l)l[E].bind(t.attr[E].loc,1);let s=0,n=e[0];-1!=i&&e.G&&(s=e.G[i-1]||0,n=e.G[i]-s),e.tris?gl.drawElementsInstanced(a,n,5123,2*s,r):gl.drawArraysInstanced(a,s,n,r)},SIM=(e,t,o)=>{let a=[...e],r=[...t],l=0;for(;l<a.length;l+=3)for(j=0;j<6;j++)e[2*l+j]=a[l+j%3]*(j<3?1:o[j%3]);for(l=0;l<r.length;l+=3)for(j=0;j<6;j++)t[2*l+j]=2*r[l+[0,1,2,2,1,0][j]]+j/3|0},FETCH=(e,t)=>fetch(e).then(e=>e.arrayBuffer()).then(e=>t(new UINT8(e))),LOAD=(e,t)=>FETCH(e,o=>{let a,r=o[0],l=[...o.slice(12,12+3*r)],i=o.slice(2,8),E=[...o.slice(3*r+12)];l=l.map((e,t)=>e/255*i[t%3]/16),t&&SIM(l,E,[-1,1,1]),a=$[e]=MESH({pos:l,tris:E}),a.G=Array.from(o.slice(8,12)).map(e=>3*e*(t?2:1))}),LAZO=(e,t=24,o=0,a)=>{var r=[],l=[],E=2*PI/t,s=e.length,n=o||t,A=s/3;for(let t=0;t<n;t++)for(i=0;i<s;i+=3){let o=ROTY(0,[e[i],e[i+1],e[i+2]],E*t);r.p(...a?.(o,i)||o),i<s-3&&l.p(t*A+i/3,(t+1)*A+i/3,t*A+i/3+1,t*A+i/3+1,(t+1)*A+i/3,(t+1)*A+i/3+1)}return MESH({pos:r,tris:l.map(e=>e%(s*n/3))})};var vs=`\nIN mat4 viewp;IN vec3 ceye;IN float time;IN vec4 color;IN float mat;IN float proj;\n#ifdef INST\nIN float scale;in vec4 offs;\n#endif\nout vec3 wpos;out vec3 lpos;out vec4 vcol;\nfloat PI=${PI};\nvoid main(){\nwpos=pos;vcol=color;\n#ifdef INST\nwpos*=offs.w*scale;wpos+=offs.xyz;\n#endif\nwpos=(model*vec4(lpos=wpos,1.0)).xyz;\nif(mat==2.){wpos.y=.01;vcol.xyz*=.0;}\nif(mat==5.)wpos.y=.2;\ngl_Position=viewp*vec4(wpos,1.0);\ngl_PointSize=proj/gl_Position.w;\n}\n`,fs="\nin vec3 wpos;in vec3 lpos;in vec4 vcol;IN vec3 ceye;IN float mat;IN float f;IN float time;IN vec4 emis;IN vec4 bgcolor;IN vec4 color2;IN vec3 SUN;\n#ifdef TEX\nIN sampler2D tex;\n#endif\nvoid main(){\nvec3 E=wpos-ceye;float dist=length(E);E/=dist;vec4 C=vcol;vec3 N=-E;\nif(mat==3.)N=normalize((model*vec4(normalize(cross(dFdx(lpos),dFdy(lpos))),.0)).xyz);\n#ifdef TEX\nC*=texture(tex,lpos.xz*.5+.5);if(C.a<.1)discard;\n#endif\nif(mat==1.){\nC=E.y<.0?color2*(max(.15,SUN.y)):mix(emis,vcol,pow(clamp(E.y*10.,.0,1.),.4));C+=max(.0,E.y*4.)*vec4(dot(SUN,E)>.9995?1.:.0);C+=max(.0,E.y*4.)*vec4(dot(-SUN,E)>.9997?1.:.0);\n}else{\nif(mat==3.){C.xyz*=vec3((dot(SUN,N)*.8+.2)+bgcolor.xyz*.2+color2.xyz*max(0.,-N.y))*max(.0,SUN.y);C.xyz*=gl_FrontFacing?1.:.1;}\nif(mat==5.)C.a*=(1.-(dist-f)/f)*abs(sin(lpos.y*1e3+time));\nif(wpos.y<.0||(lpos.y<.0&&mat==4.))discard;\n}\nfC=C;\n}\n",fx_fs="in vec2 _uv;IN sampler2D tex;void main(){ fC=vec4(floor(texture(tex,_uv).xyz*32.0)/32.0,1.0); }",CX=0,i,j,k,f,x,y,z,ox,oy,oz,s,u,v,tt;ARP.p=ARP.push,NSIN=e=>SIN(2*e*PI),FOR=(e,t)=>{for(i=0;i<e;i++)t(i)};let FCOLOR=e=>e?CX.strokeStyle=CX.fillStyle=e:0,RECT=(e,t,o,a,r)=>{FCOLOR(r),CX.fillRect(e,t,o,a)},CIRCLE=(e,t,o,a,r=1)=>{FCOLOR(a),CX.beginPath(),CX.arc(e,t,o,0,2*PI),r&&CX.fill()},SHAPE=(e,t)=>{CX.moveTo(e[0]*t,e[1]*t),e.map((o,a)=>a%2?0:CX.lineTo(e[a]*t,e[a+1]*t)),CX.fill()};TEXT=(e,t,o,a)=>{FCOLOR(a),CX.fillText(e,t,o)};var SKY=[[.01,.01,.2],[.01,.01,.2],[.13,.25,.49],[.25,.4,.65],[.3,.5,.86]],SUN=V3(),bgcolor=V3(4),hcolor=[1,1,1,1],seacolor=[0,.4,.53,1],fbo,PLT=[[.5,.5,.5,1],[1,1,1,1],[0,0,0,1],[0,.4,.53,1],[.5,.4,.3,1],[.2,.6,.2,1],[.8,.8,.4,1],bgcolor,[1,.1,.1,.8]],NOW=0,PREV=0,HTIME=0,NTIME=0,GTIME=0,V4=[0,0,0,0],FTIME=72,DT=0,PMESH,model=M4(),UItex=0;INPUT(C),INIT(C);var sh=PROGRAM(vs,fs).uniforms({emis:V4}),shI=PROGRAM(vs,fs,["INST"]).uniforms({scale:1}),shT=PROGRAM(vs,fs,["TEX"]),shFX=PROGRAM(quad_vs,fx_fs);$.plane=PLANE(),$.cube=CUBE(),$.point=MESH({pos:V3()}),LOAD("pby",1),LOAD("boat",1);let XZY=e=>[e[0],e[2],e[1]];$.engine=LAZO([0,2,0,2,2,0,3,5,0,3.5,10,0,3,15,0,2,16,0,2,15,0,.5,16,0,.5,17,0,0,17.5,0],16,0,XZY),$.circle=LAZO([0,0,0,-1,0,0],24,0,XZY),$.tpd=LAZO([.25,-1.5,0,.25,1.5,0,.2,1.6,0,0,1.7,0],24,0,XZY),V=[],FOR(16,e=>V.p(NSIN(e/16),NSIN(e/16+.25),0)),$.hx=MESH({pos:V}),$.rnd=MESH({pos:V3(3072).map(e=>RAND(1,-.5))}),PMESH=MESH({pos:V3(49152)});var PLY,PBYS,SCORE=0,GOALS=9,raft,OBJS,VIEWM=0,SUS=1,ZOOM=0,SHK=0,IMP=0,MODE=0,UI,CANVAS=(e,t)=>{let o=document.createElement("canvas");return o.width=e,o.height=t,o.getContext("2d")};let WORLD={},SC=2048,MPOS=[0,0],ORIG=[1480,0,590],BLTS,PARTS,BIRDS;ADDZONE=(e,t,o)=>{CX=CANVAS(512,512),FCOLOR("#586"),SHAPE($[o].slice(2),2);let a=WORLD[e+":"+t]={map:CX.canvas,x:e,z:t,tex:TEX(512,512,CX.canvas).p(0,NEAREST).p(1,NEAREST),px:CX.getImageData(0,0,512,512).data};V=[],FOR(2048,e=>{j=0|RAND(a.px.length/4),a.px[4*j+1]>100&&V.p(j%512/512,0,(j/512|0)/512,.001*RAND(.5,1))}),a.inst=BUFFER(V,4)},GENWORLD=()=>{ADDZONE(0,0,0)},FETCH("hon",e=>{$[0]=e,GENWORLD()}),PBY=()=>[["tpd",[-4.2,1.5,0,1],0,0],["tpd",[4.2,1.5,0,1],0,0],["pby",[0,-1,-10,1],0,0],["pby",[0,-1,-10,1],7,1,4],["engine",[2,2.8,-1,.2]],["engine",[-2,2.8,-1,.2,0]],["hx",[2,2.8,2,1.2],0,0,1],["hx",[-2,2.8,2,1.2],0,0,1]],BOAT=()=>[["boat",[0,-5,-80,80],0,0],["cube",[0,15,-20,10],0,0],["cube",[0,12,-20,10.1],8,0,0]],SUBM=()=>[["tpd",[0,-14,-40,40],0,0],["cube",[0,2,0,[.2,4,.2]],0,0]],TPD=()=>[["tpd",[0,-1,0,1],0,0]],RFT=()=>[["cube",[0,-.8,0,1],6,0]],BLD=()=>[["cube",[0,0,0,[2,10,2]],0,0],["cube",[0,11,0,.1],8,0,0]],SPDS=[20,.5,.2,1,.1,0],ITEM=(e=M4(),t=0)=>({s:[5,80,20,1,1,1][t],t:t,m:e,pos:e.subarray(12,15),c:[PBY,BOAT,SUBM,TPD,RFT,BLD][t](),life:100,ang:0,spd:0,eng:t?.5:0,fuel:10,aim:[0,0,0],vel:V3(),f:V3(),r:V3(),u:V3(),cd:0,ammo:500,w:2}),RESET=()=>{GTIME=0,HTIME=1e4,BLTS=[],PARTS=[],PLY=ITEM(),TRS(PLY.m,[ORIG[0]+200,0,ORIG[2]-120],[0,4.7,0]),OBJS=[PLY],FOR(3,e=>OBJS.p(ITEM(TRS(0,[PLY.pos[0]+50*(e+1)-200,RAND(),PLY.pos[2]+30],[0,4,0]),0))),PBYS=[...OBJS],FOR(4,e=>OBJS.p(ITEM(TRS(0,[RAND(1e3,-8e3),0,RAND(6e3,-8e3)]),1),ITEM(TRS(0,[RAND(1e4,100),0,RAND(2e3,5e3)]),2))),OBJS.p(raft=ITEM(TRS(0,[7e3,0,2e3-3e3*RAND()]),4),ITEM(TRS(0,ORIG),5))},RESET(),SHOOT=(e,t,o)=>{BLTS.length>=16384&&BLTS.shift(),BLTS.p({a:o,pos:V3(e),pos2:V3(e),t:10,vel:V3(t)}),IMP=1,o.ammo--},ADDP=(e,t,o=10)=>{PARTS.length>=16384&&PARTS.shift(),PARTS.p({pos:V3(e),t:o,vel:V3(t)})},HIT=(e,t,o)=>{for(e.life-=o,e==PLY?SHK=.4:SCORE+=10,i=0;i<o;i++)ADDP(t.pos,NORM([RAND(10,-5),RAND(10),RAND(10,-5)],0,100));e.life<=0&&CRASH(e)},KILL=e=>{OBJS=OBJS.filter(t=>t!=e)},CRASH=e=>{e.c.map(e=>e[2]=2),e.eng=e.life=e.fuel=0,SCORE+=e.t?1e3:-100,e.cd=4,GOALS-=1==e.t||2==e.t?1:0},TORP=e=>{(i=ITEM(APPLYTRANS(M4(),e.m,e.c[--e.w][1]),3)).vel.set(e.vel),i.eng=1,i.a=e,OBJS.p(i)},NEXT=()=>{PLY=PBYS.find(e=>PLY!=e&&e.life>0)};var ACX,ADEST,AVOL,ABUF,abeep,aeng,ashoot,ahit,CHANNEL=(e,t)=>{var o=ACX.createOscillator(),a=ACX.createBufferSource(),r=ACX.createBiquadFilter(),l=ACX.createGain();o.frequency.value=0,a.buffer=ABUF,a.loop=!0,r.frequency.value=1e4,l.gain.value=0,o.connect(r),a.connect(r),r.connect(l),l.connect(AVOL);var i={osc:o,noise:a,filter:r,gain:l,vol:e=>l.gain.linearRampToValueAtTime(SAT(e),ACX.currentTime+.1)};return e&&o.start(),t&&a.start(),i};AUDIO=()=>{ACX=new AudioContext,ADEST=ACX.destination,AVOL=ACX.createGain(),AVOL.gain.value=.5,AVOL.connect(ADEST);var s=ACX.sampleRate;with(ABUF=ACX.createBuffer(1,2*s,s),ABUF.getChannelData(0).set(V3(2*s).map(RANDOM)),aeng=CHANNEL(1,0),aeng)vol(.1),osc.frequency.value=60,osc.detune.value=80,filter.frequency.value=200,osc.type="sawtooth";with(ashoot=CHANNEL(1,0),ashoot)osc.frequency.value=60;with(ahit=CHANNEL(1,1),abeep=CHANNEL(1,0),abeep)osc.frequency.value=1e3};var eye,target,up,MX=0,MY=0,cell;function loop(){requestAnimationFrame(loop),NOW=TIME();var e=MIN(.1,NOW-PREV)*(KEYS.T?10:1);PREV=NOW,GTIME+=e,NTIME=(HTIME+=e*FTIME)/86400%1,DT+=e;var t=C.width=BODY.offsetWidth,o=C.height=BODY.offsetHeight,a=t>>1,r=o>>1;if(fbo&&fbo.h==r&&fbo.w==a||(fbo=FBO(TEX(a,r).p(0,NEAREST)),UI=CANVAS(a,r),UItex=TEX(a,r)),f=.499*NSIN(NTIME-.25)+.5,i=4*f|0,f=4*f%1,LERPV3(bgcolor,SKY[i],SKY[i+1],f),bgcolor[3]=1,SCALE(hcolor,bgcolor,2),SUN.set([0,NSIN(NTIME-.25),NSIN(NTIME)]),PLT[8][3]=-SUN[1],ACX&&(aeng.vol(.2*(PLY?.eng??0)),aeng.osc.frequency.value=30+40*(PLY?.eng??1),ashoot.vol(IMP/2),IMP*=.9,ahit.filter.frequency,value=ahit.osc.frequency.value=60+RAND(200),ahit.vol(.7*SAT(SHK)),abeep.vol(PLY?PLY.pos[1]<20&&PLY.spd>30&&(2*GTIME%1>.5?.1:0):0)),[sh,shT,shI].map(e=>e.uniforms({SUN:SUN,proj:0,time:GTIME})),INIT(C),fbo.bind(1),CLEAR(bgcolor,1),up=[0,1,0],MODE)if(PLY){if(PLY.life<1)target=V3(PLY.pos),eye[1]+=e;else if(VIEWM>9);else if(VIEWM>6)MAT4xV3(eye,PLY.m,[0,4,-17]),MAT4xV3(target,PLY.m,[0,2,5]),MAT4xV3(up,PLY.m,[0,1,0],0),7==VIEWM&&LERPV3(eye,CAM_EYE,eye,.1),eye[1]=MAX(eye[1],1),target[1]=MAX(target[1],.5);else if(PLY){let e=[.3,1.44,3.8],t=[0,1.3,-3],o=[e,e,e,t,t,[0,1,5.2],[.1,0,10]][VIEWM],l=V3([[0,-.22,1],[1,.1,-.2],[-1,.1,-.2],[-1,0,0],[1,0,0],[0,0,1],[0,0,1]][VIEWM]);MAT4xV3(eye,PLY.m,o),(ZOOM||VIEWM>2)&&6!=VIEWM&&(l[1]+=-.001*(MY-r/1.6),ROTY(l,l,.002*(MX-a/2))),MAT4xV3(target,PLY.m,ADD(l,o,l)),MAT4xV3(up,PLY.m,[0,1,0],0)}}else eye[1]+=e;else TRS(PLY.m,[1e3-10*GTIME,100,100+10*GTIME],[1e-4*MY,1e-4*MX-1.8,.02*SIN(1.2*GTIME+i)]),target=ADD(V3(),PLY?.pos??ORIG,[0,2,0]),eye=ADD(V3(),target,[-10,-3.3,-10]);for(ZOOM=2&MOUSE.buttons&&/*!DEBUG&&*/MODE,target[1]+=SIN(100*GTIME)*SAT(SHK)*.1,SHK*=.9,CAMERA(eye,target,up,ZOOM?20:65,a/r,.1,1e5),GLSET(ZTEST,0),GLSET(CULL,0),DRAW("cube",sh,{color:bgcolor,color2:seacolor,emis:hcolor,mat:1,model:TRS(model,eye,0,1e3)}),(NTIME<.2||NTIME>.7)&&DRAW("rnd",sh,{color:[.6,.6,.5,1],mat:4},0),BLENDFUNC("A"),FOR(4,e=>{ox=FLOOR(eye[0]/(2*SC)),oz=FLOOR(2*eye[2]/(2*SC)),DRAW("rnd",sh,{color:[1,1,1,.5*MAX(SUN[1],0)],f:SC,proj:1,mat:5,model:TRS(model,[(ox+e%2)*SC*2,0,(oz+FLOOR(e/2))*SC*2],0,2*SC)},0),ox=FLOOR(eye[0]/1e3),oz=FLOOR(eye[2]/1e3),DRAW("rnd",sh,{color:[1,1,1,.3*MAX(SUN[1],0)],proj:1,mat:5,f:500,model:TRS(model,[1e3*(ox+e%2),0,1e3*(oz+FLOOR(e/2))],0,1e3)},0)}),GLSET(BLEND,0),(cell=WORLD[(ox=0)+":"+(oz=0)])&&(u={color:PLT[1],bgcolor:[1,1,1,1],mat:3,tex:cell.tex.bind(0),model:TRS(model,[(ox+.5)*SC,0,(oz+.5)*SC],0,SC/2)},DRAW("plane",shT,u),SUN[1]<.2&&DRAW("point",shI,{model:TRS(0,[ox*SC,0,oz*SC],0,SC),color:[.8,.6,.3,1],proj:1,mat:5},0,cell.inst.size/4,{offs:cell.inst})),GLSET(ZTEST),BLENDFUNC("A"),i=0;i<OBJS.length;i++){let e=OBJS[i];for(j=0;j<e.c.length;j++){let t=e.c[j],o=t[1],a=t[4]??4;model=TRS(model,o,o[4],o[3],e.m),t[2]<0||(GLSET(CULL,7==t[2]),DRAW(t[0],sh,{color:PLT[t[2]||0],color2:seacolor,mat:4!=a?0:3,model:model},a,1,0,t[3]??-1),DRAW(t[0],sh,{mat:2}))}}if(DEPTHW(0),PMESH.pos.update(BLTS.flatMap(e=>[...e.pos,...e.pos2])),PMESH[0]=2*BLTS.length,DRAW(PMESH,sh,{mat:0,color:[10,10,0,1],model:IDM4},1),DRAW(PMESH,sh,{proj:1},0),DRAW(PMESH,sh,{mat:2},1),PARTS.map((t,o)=>{ADD(t.pos,t.pos,t.vel,e),ADD(t.vel,t.vel,[.1*RAND(1,-.5),1,.1*RAND(1,-.5)],e),SCALE(t.vel,t.vel,.999),t.t-=e}),PARTS.filter(e=>e.t>0&&e.pos[1]>0),PMESH.pos.update(PARTS.flatMap(e=>[Array.from(e.pos)].flat())),PMESH[0]=PARTS.length,DRAW(PMESH,sh,{mat:6,proj:2e3*PROJ_M4[5],color:[0,0,0,.1]},0),DEPTHW(1),UI.canvas.width=a,CX=UI,DIAL=(e,t,o,a,r=20,l=5,E=0,s=0)=>{for(CX.save(),CX.translate(t,o),i=0;i<4;i++)CIRCLE(.8*a*[-1,-1,1,1][i],.8*a*[-1,1,1,-1][i],.1*a,"#111");for(CIRCLE(0,0,a+2,"#555"),TEXT(e,0,1.2*-a),CIRCLE(0,0,a,"#000"),CX.rotate(E),FCOLOR("#0A4"),i=0;i<r;++i)RECT(-1,.8*a,i%l?.5:2,4),CX.rotate(2*PI/r);for(i=0;i<r;i+=l)TEXT(2==s?"NESW"[i/l]:3!=s||i?i:12,NSIN(i/r)*a/1.7,-NSIN(i/r+.25)*a/1.7+3);CX.restore()},COMPASS=(e,t)=>{DIAL("COMPASS",e,t,30,20,5,(PLY?.ang??0)+.1*SIN(GTIME),2),NEEDLE(e,t,20,0)},NEEDLE=(e,t,o,a,r=1,l=0)=>{CX.save(),CX.translate(e,t),l&&2*GTIME%1<.5&&CIRCLE(0,8,4,"#E33"),FCOLOR("#0A4"),CX.rotate(2*SAT(a+.002*SIN(GTIME+e))*PI),RECT(-r,.3*o,2*r,1.1*-o),CIRCLE(0,0,2,"#4C8"),CX.restore()},CX.scale(1,-1),CX.translate(0,-r),CX.textAlign="center",MODE)if(PLY)if(12==VIEWM)x=a/2-320,y=20,CX.textAlign="left",RECT(0,0,a,r,"#222"),RECT(x,0,640,480,"#765"),CX.font="20px Courier New",["BRIEFING","**********","Sink Submarines (North)","Sink Transports (South East)","Rescue Pilots (Red Area)"].map((e,t)=>TEXT(e,x+30,y+20*t,"#000"));else if(11==VIEWM&&PLY)s=64,RECT(0,0,a,r,"#222"),COMPASS(50,50),CX.save(),CX.translate(a/2,r/2),CX.rotate(PI),CIRCLE(0,0,200,"#000"),CX.clip(),RECT(-200,0,400,1,"#333"),RECT(0,-200,1,400),CX.rotate(PLY.ang),OBJS.map(e=>1==e.t||2==e.t&&RAND()<.001?CIRCLE(e.pos[0]/s-PLY.pos[0]/s,e.pos[2]/s-PLY.pos[2]/s,3,"#3F3"):0),CX.rotate(2*GTIME),FOR(9,e=>{CX.globalAlpha=1-e/9,RECT(0,0,200,1,"#3F3"),CX.rotate(-.01)}),CX.restore();else if(10==VIEWM&&PLY){let e=64,t=SC/e;for(MOUSE.buttons&&(MPOS[0]-=MOUSE.delta[0]/2,MPOS[1]-=MOUSE.delta[1]/2),RECT(0,0,a,r,"#146"),FCOLOR("#669"),CX.save(),CX.translate(a/2-MPOS[0]+.5,r/2-MPOS[1]+.5),CX.rotate(PI),i=0;i<=10;i++)for(j=0;j<=10;j++){let t=i-5,o=j-5;CX.strokeRect(t*e,o*e,e,e);let a=WORLD[FLOOR(t)+":"+FLOOR(o)];a&&CX.drawImage(a.map,t*e,o*e,e,e)}for(var l of OBJS)!l.t&&CIRCLE(l.pos[0]/t,l.pos[2]/t,2,l==PLY?"#FFF":"#888");CIRCLE(200,20,50,"red",0),CX.stroke(),CX.restore(),COMPASS(50,50)}else ZOOM||6==VIEWM?(RECT(0,0,a,r,"#000"),i=6==VIEWM?0:.1,CX.save(),CX.globalCompositeOperation="destination-out",CIRCLE(a*(.5-i),r/2,.4*r),CIRCLE(a*(.5+i),r/2,.4*r),CX.restore(),i||(RECT(a/2,0,1,r),RECT(0,r/2,a,1))):VIEWM<3&&PLY.life>0&&(VIEWM||(l=PLY,CX.translate(a/2-320,0),y=r-60+20*SHK,TEXT(l.ammo,40,y-80,"#AAA"),DIAL("ALT",40,y,30,10,1),NEEDLE(40,y,30,l.pos[1]/1e3%1,1,l.spd>30&&l.pos[1]<20),NEEDLE(40,y,20,l.pos[1]/1e4),COMPASS(120,y),DIAL("FUEL",200,y,30,10,1),NEEDLE(200,y,30,.09*l.fuel,1,l.fuel<.1),DIAL("HORIZON",280,y,30,0,0),CX.save(),CX.translate(280,y),CIRCLE(0,0,24,"#146"),CX.clip(),CX.rotate(-l.r[1]*PI/2),RECT(-40,100*l.f[1],80,100,"#543"),CX.restore(),RECT(260,y-1,40,2,"#666"),DIAL("HULL",360,y,30,100,10),NEEDLE(360,y,30,.009*PLY.life),DIAL("AIR SPEED",440,y,30,100,25),NEEDLE(440,y,30,.01*l.spd),y-=70,DIAL("THROTTLE",400,y,26,10,1),NEEDLE(400,y,30,.9*l.eng),DIAL("TIME",480,y,26,12,3,0,3),NEEDLE(480,y,28,HTIME/3600%1),NEEDLE(480,y,20,HTIME/43200%1)));else CX.font="40px Courier New",TEXT(GOALS?"Mission Failed":"Mission Done",a/2,r/2,"#aaa");else CX.font="50px ARIAL",FOR(6,e=>TEXT("WWII PACIFIC",a/2+e,r/8,"#335")),CX.font="100px ARIAL",CX.scale(.5,1),FOR(6,e=>TEXT("BLACK CATS",2*(a/2-e),r/8-e+100,e?"#000":"#333")),CX.font="20px Courier New",CX.scale(2,1),CX.globalAlpha=SAT(GTIME-5),TEXT("click to start",a/2,r-100,"#aaa");for(UI.textAlign="left",TEXT(MODE?"SCORE: "+SCORE:"by tamat",20,30,"#FFF"),UItex.update(UI.canvas),BLENDFUNC("A"),GLSET(ZTEST,0),UItex.p(1,LINEAR).toVP(),fbo.bind(0),GLSET(BLEND,0),MX=MOUSE.pos[0]/2,MY=MOUSE.pos[1]/2,fbo.tex.toVP(shFX),MOUSE.buttons&&(ACX||AUDIO(),MODE||(RESET(),MODE=1,HTIME=5e4,VIEWM=12)),PLY&&(KEYS.C&&PLY.cd<0&&PLY.ammo&&(SHOOT(MAT4xV3(V3(),PLY.m,[0,.2,8]),SCALE(0,PLY.f,5e3),PLY),PLY.cd=.25,SHK+=.02),"QEWSAD".split("").map((t,o)=>PLY.aim[o/2|0]+=(KEYS[t]?1:0)*e*(o%2?-1:1)),PLY.eng=SAT(PLY.eng+.2*e*((KEYS.R?1:0)+(KEYS.F?-1:0)-.05*MOUSE.wheel)),(KEYS.Space||KEYS.T)&&(PLY.aim[1]+=.1*PLY.f[1],PLY.aim[2]+=.1*PLY.r[1]),raft&&PLY.spd<.1&&DIST(raft.pos,PLY.pos)<70&&(raft=KILL(raft),SCORE+=1e3,GOALS--)),GOALS||(PLY=0),ONKEY=(e,t)=>{if(12==VIEWM&&(VIEWM=0),t>=49&&t<=59&&(VIEWM=t-49),t>111&&t<116&&PBYS[t-112].life>0&&(PLY=PBYS[t-112]),90==t&&PLY.w&&(TORP(PLY),SHK=.1),66==t&&(VIEWM=12==VIEWM?0:12),77==t&&(VIEWM=10==VIEWM?0:10),78==t&&(VIEWM=11==VIEWM?0:11),27!=t&&PLY||(RESET(),MODE=0),t>115&&t<124)return!0},j=DT/(e=.01)|0,DT%=e;j;j--)OBJS.map(t=>{if(t.t>4)return;t.spd=LEN(t.vel);let o=t.m,a=t.eng*SPDS[t.t]*(t.fuel&&t.life>0?1:0)*40,r=NORM(V3(),t.vel),l=V3(),i=e*t.spd*.01,E=.2*(t.pos[1]<2?2:1);NORM(MAT4xV3(t.f,o,[0,0,1],0)),MAT4xV3(t.u,o,[0,1,0],0),MAT4xV3(t.r,o,[1,0,0],0);let s=t.t?1:POW(DOT(r,t.f),9);ADD(t.pos,t.pos,t.vel,e),ADD(l,l,t.f,MAX(t.pos[1]>2?200*s:0,a)),3!=t.t&&ADD(l,l,r,-E*s*t.spd*t.spd),t.t||(t.c[0][2]=t.w>0?0:-1,t.c[1][2]=t.w>1?0:-1,ADD(l,l,t.u,.6*t.spd*s),t.life<1?t.aim[1]=.1*t.f[1]+.3:t.pos[1]<-.1&&((t.vel[1]<-10||t.f[1]<-.3)&&CRASH(t),t.vel[1]*=.1)),ADD(l,l,[0,t.pos[1]>1?-50:.01,0]),ADD(t.vel,t.vel,l,e),APPLYROT(t.m,t.m,t.aim[0]*i/4,[0,1,0]),APPLYROT(t.m,t.m,t.aim[1]*i,[1,0,0]),APPLYROT(t.m,t.m,t.aim[2]*-i,[0,0,1]),t.aim.map((e,o)=>t.aim[o]=.98*e),t.fuel=MAX(0,t.fuel-1e-6*a*e),t.pos[1]=MAX(-.1,t.pos[1]),t.ang=ATAN2(t.f[0],t.f[2]),RAND()>.9&&t.life<20&&3!=t.t&&ADDP(t.pos,[RAND(4,-1),1,RAND(4,-1)]),PLY&&PLY.life>0&&(u=DIST(t.pos,PLY.pos),1==t.t&&t.cd<0&&u<1500&&t.life>0&&(v=ADD(V3(),t.pos,[0,20,0]),tt=ADD(V3(),PLY.pos,PLY.vel,.001*u),ADD(tt,tt,[.5*RAND(1,-.5),5,.5*RAND(1,-.5)]),SUB(tt,tt,v),tt[1]>.2&&t.ammo&&SUN[1]>0&&SHOOT(v,tt,t),t.ammo||(t.ammo=100,t.cd=10),t.cd=.3)),3==t.t&&OBJS.map(e=>{t.a!=e&&3!=e.t&&DIST(t.pos,e.pos)<e.s&&(HIT(e,t,100),KILL(t))}),t.c.map(e=>"hx"==e[0]?e[1][4]=[0,0,5*GTIME]:0),!t.t&&t.spd<1&&DIST(t.pos,ORIG)<1e3&&t.pos[1]<1&&(t.fuel=MIN(t.fuel+.2*e,10),t.w<2&&t.cd<0&&(t.cd=5,t.w++)),t.cd-=e}),BLTS.map((t,o)=>{t.pos2.set(t.pos),ADD(t.pos,t.pos,t.vel,e),ADD(t.vel,t.vel,[0,-10,0],e),t.t-=e,OBJS.map(e=>e!=t.a&&e.life>0&&DIST(t.pos,e.pos)<e.s?(HIT(e,t,2),t.t=0):0)}),BLTS=BLTS.filter(e=>e.t>0&&e.pos[1]>0);PLY&&PLY.life<1&&PLY.cd<0&&PLY.pos[1]<1&&NEXT(),END()}loop()</script>
