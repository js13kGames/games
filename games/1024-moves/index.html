<title>CUBE</title><script src=lost.js></script><style>body{margin:0}#HUD{position:absolute;top:0;left:0}</style><script id=shader-fs type=x-shader/x-fragment>precision mediump float;varying vec2 vtc;varying float vlw;varying vec3 wp;uniform sampler2D uSampler;uniform vec4 lights[48];uniform int nbLights;uniform vec3 ac;uniform int cubeFace,isPlayer,isCurrentPlayer;uniform float it;varying vec3 vp;void main(){vec4 tc=texture2D(uSampler,vec2(vtc.r,vtc.g));vec3 totalLight=vec3(0.,0.,0.);totalLight+=ac;for(int i=0;i<48;i++){if(i==nbLights){break;}vec3 light;float d=distance(wp,lights[i].rgb);if(lights[i].a<=1.)light=vec3(sin(it/100.)/2.+.5,sin(it/150.)/2.+.5,cos(it/100.)/2.+.5),light*=max(0.,4.4-.8*d),totalLight+=light*.15;}float profondeur=wp.b/15.;profondeur+=wp.r/50.;if(cubeFace==6)profondeur*=.6;else if(cubeFace==5)profondeur*=.4;if(isPlayer==1){float distanceS=abs(vtc.r-.5)*2.,distanceT=abs(vtc.g-.5)*2.,distance=max(distanceS,distanceT),alpha=0.;if(distance<.8)tc.rgb=vec3(.2,.2,.2);else alpha=1.-(1.-distance)*3.,tc.rgb=vec3(.2,.2,.2);if(isCurrentPlayer==0)tc.rgb+=vec3(.2,.2,.2)*alpha;else tc.rgb+=vec3(1,.8,.6)*alpha;gl_FragColor=vec4(tc.rgb,1.);}else{if(isCurrentPlayer==1){vec3 c=tc.rgb*vlw*profondeur,cible=vec3(.1058,.647,.827);c*=cible+vec3(.7,.7,.7);gl_FragColor=vec4(c,tc.a)+vec4(totalLight,tc.a);}else gl_FragColor=vec4(tc.rgb*vlw*profondeur,tc.a)+vec4(totalLight,tc.a);}}</script><script id=lava-fs type=x-shader/x-fragment>precision mediump float;varying vec2 vtc;varying float vlw;uniform vec2 res;varying vec3 wp;uniform sampler2D uSampler;uniform vec4 lights[48];uniform int nbLights;uniform vec3 ac;uniform int cubeFace;uniform float it;varying vec3 vp;mat2 mm2(in float a){float c=cos(a),s=sin(a);return mat2(c,-s,s,c);}float noise(in float x){return texture2D(uSampler,vec2(x*.01,1.),0.).r;}float hash(float n){return fract(sin(n)*43758.5);}float noise(in vec3 p){vec3 ip=floor(p),f=fract(p);f=f*f*(3.-2.*f);vec2 uv=ip.rg+vec2(37.,17.)*ip.b+f.rg,rg=texture2D(uSampler,(uv+.5)/256.,0.).gr;return mix(rg.r,rg.g,f.b);}mat3 m3=mat3(0.,.8,.6,-.8,.36,-.48,-.6,-.48,.64);float flow(in vec3 p,in float t){float time=it/100.0,z=2.,rz=0.;vec3 bp=p;for(float i=1.;i<5.;i++)p+=time*.1,rz+=(sin(noise(p+t*.8)*6.)*.5+.5)/z,p=mix(bp,p,.6),z*=2.,p*=2.01*m3;return rz;}float sins(in float x){float time=it/100.0,rz=0.,z=2.;for(float i=0.;i<3.;i++)rz+=abs(fract(x*1.4)-.5)/z,x*=1.3,z*=1.15,x-=time*.65*z;return rz;}vec2 iSphere2(in vec3 ro,in vec3 rd){vec3 oc=ro;float b=dot(oc,rd),c=dot(oc,oc)-1.,h=b*b-c;if(h<0.)return vec2(-1.);return vec2(-b-sqrt(h),-b+sqrt(h));}void main(){vec4 tc=texture2D(uSampler,vec2(vtc.r,vtc.g));gl_FragColor=vec4(tc.rgb,tc.a);float time=it/100.0;float it=time/80.;vec2 p=vp.rg,um=vec2(10.,10.)-.5;vec3 ro=vec3(0.,0.,5.),rd=normalize(vec3(p*.7,-1.5));mat2 mx=mm2(time*.4+um.r*6.),my=mm2(time*.3+um.g*6.);ro.rb*=mx;rd.rb*=mx;ro.rg*=my;rd.rg*=my;vec3 bro=ro,brd=rd,col=vec3(.0125,0.,.025);ro=bro;rd=brd;vec2 sph=iSphere2(ro,rd);float alpha=1.;if(sph.r>0.){vec3 pos=ro+rd*sph.r,pos2=ro+rd*sph.g,rf=reflect(rd,pos),rf2=reflect(rd,pos2);float nz=-log(abs(flow(rf*1.2,time)-.01)),nz2=-log(abs(flow(rf2*1.2,-time)-.01));col+=(.1*nz*nz*vec3(.12,.12,.5)+.05*nz2*nz2*vec3(.55,.2,.55))*.8;}else alpha=0.,col=vec3(1,0,0);gl_FragColor=vec4(col*8.,alpha);}</script><script id=shader-vs type=x-shader/x-vertex>attribute vec3 avp;attribute vec2 aTextureCoord;uniform mat4 uMVMatrix,uPMatrix;uniform vec3 cp;varying vec2 vtc;varying float vlw;varying vec3 vp,wp;varying vec2 frag_uv;void main(){gl_Position=uPMatrix*uMVMatrix*vec4(avp,1.),vp=normalize(avp),vtc=aTextureCoord,vlw=1.-gl_Position.b/10.,vlw=1.,wp=cp.rgb+avp;}</script><body onload=webGLStart() onresize=resize()><canvas id=game></canvas><canvas id=HUD></canvas><script>function SfxrP(){this.set=function(e){for(var t=0;24>t;t++)this[String.fromCharCode(97+t)]=e[t]||0;this.c<.01&&(this.c=.01);var r=this.b+this.c+this.e;if(.18>r){var a=.18/r;this.b*=a,this.c*=a,this.e*=a}}}function sy(){var e,t,r,a,o,i,n,l,s,g,d,h;this._p=new SfxrP,this.reset=function(){var e=this._p;a=100/(e.f*e.f+.001),o=100/(e.g*e.g+.001),i=1-e.h*e.h*e.h*.01,n=-e.i*e.i*e.i*1e-6,e.a||(d=.5-e.n/2,h=5e-5*-e.o),l=1+e.l*e.l*(e.l>0?-.9:10),s=0,g=1==e.m?0:(1-e.m)*(1-e.m)*2e4+32},this.totalReset=function(){this.reset();var a=this._p;return e=a.b*a.b*1e5,t=a.c*a.c*1e5,r=a.e*a.e*1e5+12,3*((e+t+r)/3|0)},this.sW=function(c,f){var v=this._p,u=1!=v.s||v.v,x=v.v*v.v*.1,y=1+3e-4*v.w,m=v.s*v.s*v.s*.1,p=1+1e-4*v.t,M=1!=v.s,b=v.x*v.x,T=v.g,w=v.q||v.r,E=v.r*v.r*v.r*.2,R=v.q*v.q*(v.q<0?-1020:1020),S=v.p?32+((1-v.p)*(1-v.p)*2e4|0):0,U=v.d,A=v.j/2,D=v.k*v.k*.01,z=v.a,C=e,L=1/e,I=1/t,F=1/r,_=5/(1+v.u*v.u*20)*(.01+m);_>.8&&(_=.8),_=1-_;for(var B,P,N,H,k,Z,W=!1,X=0,Y=0,G=0,O=0,V=0,j=0,q=0,K=0,J=0,Q=0,$=new Array(1024),ee=new Array(32),te=$.length;te--;)$[te]=0;for(te=ee.length;te--;)ee[te]=2*Math.random()-1;for(te=0;f>te;te++){if(W)return te;if(S&&++J>=S&&(J=0,this.reset()),g&&++s>=g&&(g=0,a*=l),(a*=i+=n)>o&&(a=o,T>0&&(W=!0)),P=a,A>0&&(Q+=D,P*=1+Math.sin(Q)*A),8>(P|=0)&&(P=8),z||(0>(d+=h)?d=0:d>.5&&(d=.5)),++Y>C)switch(Y=0,++X){case 1:C=t;break;case 2:C=r}switch(X){case 0:G=Y*L;break;case 1:G=1+2*(1-Y*I)*U;break;case 2:G=1-Y*F;break;case 3:G=0,W=!0}w&&(0>(N=0|(R+=E))?N=-N:N>1023&&(N=1023)),u&&y&&(1e-5>(x*=y)?x=1e-5:x>.1&&(x=.1)),Z=0;for(var re=8;re--;){if(++q>=P&&(q%=P,3==z))for(var ae=ee.length;ae--;)ee[ae]=2*Math.random()-1;switch(z){case 0:k=d>q/P?.5:-.5;break;case 1:k=1-q/P*2;break;case 2:k=.225*((0>(k=1.27323954*(H=6.28318531*((H=q/P)>.5?H-1:H))+.405284735*H*H*(0>H?1:-1))?-1:1)*k*k-k)+k;break;case 3:k=ee[Math.abs(32*q/P|0)]}u&&(B=j,0>(m*=p)?m=0:m>.1&&(m=.1),M?(V+=(k-j)*m,V*=_):(j=k,V=0),O+=(j+=V)-B,k=O*=1-x),w&&($[K%1024]=k,k+=$[(K-N+1024)%1024],K++),Z+=k}Z*=.125*G*b,c[te]=Z>=1?1:-1>=Z?-1:Z}return f}}function drawText(e,t,r,a){var o=["#000","#FFF"];a/=2;for(var i=0;i<o.length;i++){ctx.fillStyle=o[i],0!=i&&(e-=2),0!=i&&(t-=2),ctx.lineWidth=.5,ctx.strokeStyle="#000";for(var n=e,l=t,s=0;s<r.length;s++){var g=0;if("&"!=r[s]){for(y=0;7>y;y++)for(x=0;5>x;x++)decalY=waitingKeyStart?5*Math.cos((frame+y+x+t)/32):0," "!=r[s]&&("0"!=font[r[s]][g]&&ctx.fillRect(n+2*x*a,l+2*y*a+decalY,3*a,3*a),g++);n+=12*a}else n=e,l+=2*a*12}}}function getShader(e,t){for(var r=document.getElementById(t),a="",o=r.firstChild;o;)3==o.nodeType&&(a+=o.textContent),o=o.nextSibling;var i;return"x-shader/x-fragment"==r.type?i=e.createShader(e.FRAGMENT_SHADER):"x-shader/x-vertex"==r.type&&(i=e.createShader(e.VERTEX_SHADER)),e.shaderSource(i,a),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)?i:(alert(r.type+e.getShaderInfoLog(i)),null)}function initShaders(){for(var e=getShader(gl,"shader-vs"),t=[["shaderProgram",getShader(gl,"shader-fs")],["shaderProgramLava",getShader(gl,"lava-fs")]],r=0;r<t.length;r++)s=gl.createProgram(),gl.attachShader(s,e),gl.attachShader(s,t[r][1]),gl.linkProgram(s),gl.useProgram(s),s.vertexPositionAttribute=gl.getAttribLocation(s,"avp"),gl.enableVertexAttribArray(s.vertexPositionAttribute),s.textureCoordAttribute=gl.getAttribLocation(s,"aTextureCoord"),gl.enableVertexAttribArray(s.textureCoordAttribute),s.it=gl.getUniformLocation(s,"it"),s.res=gl.getUniformLocation(s,"res"),s.pMatrixUniform=gl.getUniformLocation(s,"uPMatrix"),s.mvMatrixUniform=gl.getUniformLocation(s,"uMVMatrix"),s.samplerUniform=gl.getUniformLocation(s,"uSampler"),s.cp=gl.getUniformLocation(s,"cp"),s.lights=gl.getUniformLocation(s,"lights"),s.nbLights=gl.getUniformLocation(s,"nbLights"),s.cubeFace=gl.getUniformLocation(s,"cubeFace"),s.isPlayer=gl.getUniformLocation(s,"isPlayer"),s.isCurrentPlayer=gl.getUniformLocation(s,"isCurrentPlayer"),s.ac=gl.getUniformLocation(s,"ac"),window[t[r][0]]=s;initBuffers()}function setTextureParams(e){gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST),gl.generateMipmap(gl.TEXTURE_2D)}function handleLoadedTexture(e){gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.bindTexture(gl.TEXTURE_2D,e),setTextureParams(e.image)}function handleLoadedTextureFromCanvas(e,t){texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,texture),setTextureParams(t),window[e]=texture}function handleLoadedTextureFromCanvasTiles(e,t){texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,texture),setTextureParams(t),tilesColors[e]=texture,tilesColors.length++}function initTexture(){crate=gl.createTexture(),crate.image=new Image,crate.image.onload=function(){handleLoadedTexture(crate)},crate.image.src="crate.png"}function degToRad(e){return e*Math.PI/180}function initBuffers(){cubeVertexIndexBuffer=gl.createBuffer(),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,cubeVertexIndexBuffer);for(var e=[0,1,2,0,2,3],t=6;36>t;t++)e.push(e[t-6]+4);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),gl.STATIC_DRAW),cubeVertexIndexBuffer.itemSize=1,cubeVertexIndexBuffer.numItems=e.length}function drawScene(){gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),mat4.perspective(fov,gl.viewportWidth/gl.viewportHeight,.001,100,pMatrix),mat4.identity(mvMatrix),blocksInMove=!1,levelExplode&&levelExplodeSince--,(t=players[selectedPlayer])&&((1==t.inMoveX||-1==t.inMoveX)&&(t.inMoveX=0),(1==t.inMoveY||-1==t.inMoveY)&&(t.inMoveY=0),moveF&&move(0,1,t)&&(t.rotation.xD=(t.rotation.xD+1)%4),moveB&&move(0,-1,t)&&(t.rotation.xD--,-1==t.rotation.xD&&(t.rotation.xD=3)),moveR&&move(1,0,t),moveL&&move(-1,0,t),t.inMoveY>0?(t.y+=-1/(vitesseRotation/2),t.inMoveY--):t.inMoveY<0&&(t.y-=-1/(vitesseRotation/2),t.inMoveY++),t.inMoveX>0?(t.x+=1/(vitesseRotation/2),t.inMoveX--):t.inMoveX<0&&(t.x-=1/(vitesseRotation/2),t.inMoveX++)),zoomOn?(camera.x-=(camera.x- -zoomOn.x)/10,camera.y-=(camera.y-(zoomOn.y+10))/10,camera.z-=(camera.z-(zoomOn.z+20))/10):t&&(camera.x-=(camera.x- -t.x)/10,camera.y-=(camera.y-(10-t.y))/10,camera.z-=(camera.z-(t.z+20))/10);for(var e=0;e<players.length;e++){for(var t=players[e],r=2*((n=level[t.tile.x][t.tile.y]).h+n.o.length),a=0;a<n.p.length&&n.p[a]!=players[e];a++)r+=2;n.h||(r=-1e3),t.z>r?(0==t.inMoveZ&&(t.inMoveZ=.1),t.z-=t.inMoveZ,t.inMoveZ*=1.1,0==t.z&&gameOver(),t.z<=r&&(t.z=r,t.inMoveZ=0)):(-1e3==r&&gameOver(),r>t.z?t.z=r+n.inMoveZ/vitesseRotation:(t.inMoveZ=0,t.z=r)),drawCube({x:players[e].x,y:players[e].y,z:players[e].z,h:1,type:"player",player:t,selectedPlayer:e==selectedPlayer})}for(var o=0;o<levels[levelEnCours].width;o++)for(var i=0;i<levels[levelEnCours].height;i++){var n,l=(n=level[o][i]).h+n.o.length;if(n.h||(l=-10),n.o.length)for(e=0;e<n.o.length;e++){var s=n.o[e],g={x:0,y:0,z:0};if(s.inMoveX>0&&(g.x=- --s.inMoveX/vitesseRotation*2),s.inMoveX<0&&(g.x=-++s.inMoveX/vitesseRotation*2),s.inMoveY>0&&(g.y=--s.inMoveY/vitesseRotation*2),s.inMoveY<0&&(g.y=++s.inMoveY/vitesseRotation*2),l<s.z+s.inMoveZ){if(0==s.speedZ&&(s.speedZ=.1,s.inMoveZ=2*(s.z-l)),s.speedZ>0?s.speedZ*=1.1:s.speedZ<-.04?s.speedZ*=.9:s.speedZ=.05,s.inMoveZ-=s.speedZ,g.z=s.inMoveZ,l>s.z+s.inMoveZ)if(s.inMoveZ>-.1)g.z=0;else{if(!n.h){console.log(l,s.z),n.o=[];continue}s.speedZ=.2*s.inMoveZ,s.inMoveZ=-s.inMoveZ,g.z=s.inMoveZ}s.z=n.h+e+1}else l>s.z&&n.inMoveZ<0?(g.z=n.inMoveZ/vitesseRotation,s.z=n.h+e):s.z=n.h+e+1,s.inMoveZ=0,s.speedZ=0;drawCube({x:2*o,y:2*-i,z:2*(l-n.o.length+e),h:1,type:"block"+(2==n.o[e].type?"2":""),decal:g})}if(l=n.h){g={x:0,y:0,z:0};var d={x:0,y:0,z:0};if(levelExplode){if(0==levelExplodeSince)return void nextLevel();blocksInMove=!0,n.inMoveZ+=n.speedZ,g.z=n.inMoveZ/vitesseRotation,n.speedZ-=.2,n.decalX+=n.speedX,n.decalY+=n.speedY,g.x=n.decalX,g.y=n.decalY,n.speedX*=.9999,n.speedY*=.9999,n.rotation.x+=n.rotationSpeed.x,n.rotation.y+=n.rotationSpeed.y,n.rotation.z+=n.rotationSpeed.z,d=n.rotation}else n.inMoveZ&&(blocksInMove=!0,n.inMoveZ>0&&(g.z=--n.inMoveZ/vitesseRotation),n.inMoveZ<0&&(g.z=++n.inMoveZ/vitesseRotation));drawCube({x:2*o,y:2*-i,z:0,h:l-.2,type:"normal",trigger:n.t,decal:g,rotation:d,triggered:n.triggered}),drawCube({x:2*o,y:2*-i,z:2*l-.4,h:.2,type:"normal2",trigger:n.t,decal:g,rotation:d}),n.t&&!n.finish&&drawCube({x:2*o,y:2*-i,z:2*l,h:1,type:"trigger",trigger:n.t,decal:g})}}for(levelDrawing&&!blocksInMove&&(levelDrawing=!1,startTuto(),vitesseRotation=10),lightsDisplayed=[],e=0;e<lights.length;e+=4){var h=Math.abs(camera.x-lights[e]/2);100>(h+=Math.abs(camera.y+lights[e+1]/2))&&(lightsDisplayed.push(lights[e]),lightsDisplayed.push(lights[e+1]),lightsDisplayed.push(lights[e+2]),lightsDisplayed.push(lights[e+3]))}var c=levels[levelEnCours];drawCube({x:2*c.end.x,y:2*-c.end.y,z:2*level[c.end.x][c.end.y].h,h:.1,type:"ball",decal:{x:0,y:0,z:level[c.end.x][c.end.y].inMoveZ/vitesseRotation}})}function drawHUDEnd(){frame++,ctx.clearRect(0,0,window.innerWidth,window.innerHeight),ctx.fillStyle="#7F40D9",ctx.fillRect(0,0,canvasHUD.width,canvasHUD.height),t="1024 MOVES",drawText(window.innerWidth/2-t.length/2*90,100,t,15),t="     CONGRATULATIONS !&YOU MADE IT IN "+nbMoves+" MOVES !&  (BEST POSSIBLE IS 1024)",drawText(window.innerWidth/2-567,500+10*Math.sin(frame/64),t,7),rafHUD=requestAnimationFrame(drawHUDEnd)}function drawHUDHome(){frame++,ctx.clearRect(0,0,window.innerWidth,window.innerHeight),ctx.fillStyle="#7F40D9",ctx.fillRect(0,0,canvasHUD.width,canvasHUD.height),t="1024 MOVES",drawText(window.innerWidth/2-t.length/2*90,100,t,15),t="PRESS A KEY TO START",drawText(window.innerWidth/2-t.length/2*42,500+10*Math.sin(frame/64),t,7),rafHUD=requestAnimationFrame(drawHUDHome)}function drawHUD(){if(ctx.clearRect(0,0,window.innerWidth,window.innerHeight),tutoText)drawText(window.innerWidth/2-tutoText.length/2*18,window.innerHeight/2+144,tutoText.toUpperCase(),3);else{drawText(10,10,nbMoves+" MOVE"+(nbMoves>1?"S":""),3);var e="STAGE "+levelEnCours;drawText(window.innerWidth/2-e.length/2*27,20,e,4.5),drawText(10,100,"M - MUTE&R - RETRY",3)}}function tick(){frame++,drawScene(),drawHUD(),rafTick=requestAnimationFrame(tick)}function resize(){var e=document.getElementById("game");e.width=window.innerWidth,e.height=window.innerHeight,(gl=e.getContext("webgl")).viewportWidth=e.width,gl.viewportHeight=e.height,canvasHUD.width=e.width,canvasHUD.height=e.height}function webGLStart(){canvasHUD=document.getElementById("HUD"),ctx=canvasHUD.getContext("2d"),resize(),gl||alert("Could not load WebGL sorry"),initShaders(),initTexture(),gl.clearColor(.5,.25,.85,1),gl.enable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);var e=document.createElement("canvas");e.width=512,e.height=512;var t=(c=e.getContext("2d")).getImageData(0,0,e.width,e.height);c.clearRect(0,0,512,512);for(var r=0;r<t.data.length;r+=4){var a=Math.floor(255*Math.random());t.data[r]=193*(255-(255-a)/1200)/255,t.data[r+1]=171*(255-(255-a)/1200)/255,t.data[r+2]=146*(255-(255-a)/1200)/255,t.data[r+3]=255}c.putImageData(t,0,0),handleLoadedTextureFromCanvas("mur",e);var o=50;c.clearRect(0,0,512,512);for(r=0;r<t.data.length;r+=4){var i=r/4%512,n=o>(h=Math.floor(r/2048))||h>512-o||o>i||i>512-o;Math.hypot(256-i,256-h)<150&&(n=!0),t.data[r+0]=n?196:54,t.data[r+1]=n?221:64,t.data[r+2]=n?55:216,t.data[r+3]=255}c.putImageData(t,0,0),handleLoadedTextureFromCanvas("red",e),c.clearRect(0,0,512,512);for(r=0;r<t.data.length;r+=4){i=r/4%512,n=o>(h=Math.floor(r/2048))||h>512-o||o>i||i>512-o;i>=206&&306>=i&&h>=206&&306>=h&&(n=!0),t.data[r+0]=n?255:54,t.data[r+1]=n?121:64,t.data[r+2]=n?0:216,t.data[r+3]=255}c.putImageData(t,0,0),handleLoadedTextureFromCanvas("blue",e);for(var l=0;23>l;l++){var g=10+3*Math.random(),d={r:27-60*(a=Math.random()),g:165-10*a,b:211-7.5*a};delta={r:0,g:0,b:0},c.clearRect(0,0,512,512);for(r=0;r<t.data.length;r+=4){i=r/4%512;var h=Math.floor(r/2048);if(o=21==l?30:g,22==l){n=(o=30)>h||h>512-o||o>i||i>512-o;x2=Math.abs(i-256),y2=Math.abs(h-256),(Math.hypot(x2,y2)<128||Math.hypot(128-x2,128-y2)<64||Math.hypot(192-x2,192-y2)<32)&&(n=!0),n?delta.r=delta.g=delta.b=Math.hypot(256-i,256-h)>32?Math.hypot(256-i,256-h):255:delta={r:0,g:0,b:0}}else n=o>h||h>512-o||o>i||i>512-o;t.data[r+0]=n?d.r/2+delta.r:d.r,t.data[r+1]=n?d.g/2+delta.g:d.g,t.data[r+2]=n?d.b/2+delta.b:d.b,t.data[r+3]=255}c.putImageData(t,0,0),handleLoadedTextureFromCanvasTiles(l,e)}s=256,e.width=s,e.height=s;var c;t=(c=e.getContext("2d")).getImageData(0,0,e.width,e.height);c.clearRect(0,0,s,s);for(r=0;r<t.data.length;r+=4){a=Math.floor(255*Math.random());t.data[r]=Math.floor(255*Math.random()),t.data[r+1]=Math.floor(255*Math.random()),t.data[r+2]=Math.floor(255*Math.random()),t.data[r+3]=Math.floor(255*Math.random())}c.putImageData(t,0,0),handleLoadedTextureFromCanvas("sphereTexture",e),initLevels(),initGame(),drawHUDHome()}var synth=new sy;window.jsfxr=function(e){window._audioContext=window._audioContext||new AudioContext;var t=window._audioContext;synth._p.set(e);var r=synth.totalReset(),a=r+1>>1<<1,o=t.createBuffer(1,a,t.sampleRate),i=o.getChannelData(0);return synth.sW(i,r),o},window.playSound=function(e){if(sound){jsfxr(e);var t=window._audioContext,r=t.createBufferSource();return r.buffer=jsfxr(e),r.loop=!1,r.connect(t.destination),r.start(t.currentTime),[r.buffer,t,r]}},glMatrixArrayType="undefined"!=typeof Float32Array?Float32Array:"undefined"!=typeof WebGLFloatArray?WebGLFloatArray:Array;var mat3={create:function(e){var t=new glMatrixArrayType(9);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9]),t},transpose:function(e,t){if(!t||e==t){var r=e[1],a=e[2],o=e[5];return e[1]=e[3],e[2]=e[6],e[3]=r,e[5]=e[7],e[6]=a,e[7]=o,e}return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],t}},mat4={create:function(e){var t=new glMatrixArrayType(16);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},toInverseMat3:function(e,t){var r=e[0],a=e[1],o=e[2],i=e[4],n=e[5],l=e[6],s=e[8],g=e[9],d=e[10],h=d*n-l*g,c=-d*i+l*s,f=g*i-n*s,v=r*h+a*c+o*f;return v?(v=1/v,t||(t=mat3.create()),t[0]=h*v,t[1]=(-d*a+o*g)*v,t[2]=(l*a-o*n)*v,t[3]=c*v,t[4]=(d*r-o*s)*v,t[5]=(-l*r+o*i)*v,t[6]=f*v,t[7]=(-g*r+a*s)*v,t[8]=(n*r-a*i)*v,t):null},translate:function(e,t,r){var a=t[0],o=t[1];if(t=t[2],!r||e==r)return e[12]=e[0]*a+e[4]*o+e[8]*t+e[12],e[13]=e[1]*a+e[5]*o+e[9]*t+e[13],e[14]=e[2]*a+e[6]*o+e[10]*t+e[14],e[15]=e[3]*a+e[7]*o+e[11]*t+e[15],e;var i=e[0],n=e[1],l=e[2],s=e[3],g=e[4],d=e[5],h=e[6],c=e[7],f=e[8],v=e[9],u=e[10],x=e[11];return r[0]=i,r[1]=n,r[2]=l,r[3]=s,r[4]=g,r[5]=d,r[6]=h,r[7]=c,r[8]=f,r[9]=v,r[10]=u,r[11]=x,r[12]=i*a+g*o+f*t+e[12],r[13]=n*a+d*o+v*t+e[13],r[14]=l*a+h*o+u*t+e[14],r[15]=s*a+c*o+x*t+e[15],r},rotate:function(e,t,r,a){var o=r[0],i=r[1];r=r[2];var n=Math.sqrt(o*o+i*i+r*r);if(!n)return null;1!=n&&(o*=n=1/n,i*=n,r*=n);var l=Math.sin(t),s=Math.cos(t),g=1-s;t=e[0],n=e[1];var d=e[2],h=e[3],c=e[4],f=e[5],v=e[6],u=e[7],x=e[8],y=e[9],m=e[10],p=e[11],M=o*o*g+s,b=i*o*g+r*l,T=r*o*g-i*l,w=o*i*g-r*l,E=i*i*g+s,R=r*i*g+o*l,S=o*r*g+i*l;return o=i*r*g-o*l,i=r*r*g+s,a?e!=a&&(a[12]=e[12],a[13]=e[13],a[14]=e[14],a[15]=e[15]):a=e,a[0]=t*M+c*b+x*T,a[1]=n*M+f*b+y*T,a[2]=d*M+v*b+m*T,a[3]=h*M+u*b+p*T,a[4]=t*w+c*E+x*R,a[5]=n*w+f*E+y*R,a[6]=d*w+v*E+m*R,a[7]=h*w+u*E+p*R,a[8]=t*S+c*o+x*i,a[9]=n*S+f*o+y*i,a[10]=d*S+v*o+m*i,a[11]=h*S+u*o+p*i,a},frustum:function(e,t,r,a,o,i,n){n||(n=mat4.create());var l=t-e,s=a-r,g=i-o;return n[0]=2*o/l,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2*o/s,n[6]=0,n[7]=0,n[8]=(t+e)/l,n[9]=(a+r)/s,n[10]=-(i+o)/g,n[11]=-1,n[12]=0,n[13]=0,n[14]=-i*o*2/g,n[15]=0,n},perspective:function(e,t,r,a,o){return t*=e=r*Math.tan(e*Math.PI/360),mat4.frustum(-t,t,-e,e,r,a,o)}},sound=1,font=[];font[0]="01110100011001110101110011000101110",font[1]="00100011000010000100001000010001110",font[2]="01110100010000100110010001000011111",font[3]="01110100010000100110000011000101110",font[4]="00010001100101010010111110001000010",font[5]="11111100001111000001000011000101110",font[6]="00110010001000011110100011000101110",font[7]="11111000010001000100010000100001000",font[8]="01110100011000101110100011000101110",font[9]="01110100011000101111000010001001100",font.A="00100010101000110001111111000110001",font.B="11110010010100101110010010100111110",font.C="01110100011000010000100001000101110",font.D="11110010010100101001010010100111110",font.E="11111100001000011110100001000011111",font.F="11111100001000011110100001000010000",font.G="01110100011000010011100011000101111",font.H="10001100011000111111100011000110001",font.I="01110001000010000100001000010001110",font.J="00111000100010000100001001001001100",font.K="10001100101010011000101001001010001",font.L="10000100001000010000100001000011111",font.M="10001110111010110101100011000110001",font.N="10001100011100110101100111000110001",font.O="01110100011000110001100011000101110",font.P="11110100011000111110100001000010000",font.Q="01110100011000110001101011001001101",font.R="11110100011000111110101001001010001",font.S="01110100011000001110000011000101110",font.T="11111001000010000100001000010000100",font.U="10001100011000110001100011000101110",font.V="10001100011000110001100010101000100",font.W="10001100011000110101101011010101010",font.X="10001100010101000100010101000110001",font.Y="10001100011000101010001000010000100",font.Z="11111000010001000100010001000011111",font["-"]="00000000000000011111000000000000000",font["."]="00000000000000000000000000011000110",font[","]="00000000000000000000000110000100010",font["!"]="00100001000010000100001000000000100",font["("]="00010001000100001000010000010000010",font[")"]="00100000100000100001000010001000100";var gl,shaderProgram,shaderProgramLava,ctx,mur,red,portal,textureDoor,textureKey,cubeVertexIndexBuffer,sphereVertexIndexBuffer,canvas2,canvasHUD,GAME,camera,triggers,level,levels,speedZ=frame=totalMove=0,moveF=moveB=moveL=moveR=!1,UVW=[],mvMatrix=mat4.create(),pMatrix=mat4.create(),lights=new Float32Array([0,0,0,0,5,-5,2,2]),lightsDisplayed=[],nbMoves=nbMovesAtStart=0,tilesColors={length:0},coordBuffer=[],UVWBuffer=[],players=[],selectedPlayer=0,vitesseRotation=10,fov=45,levelEnCours=1,levelDrawing=!1,levelExplode=!1,zoomOn=!1;getP=function(e,t,r){return[-(e/=2),-(t/=2),2*r,e,-t,2*r,e,t,2*r,-e,t,2*r,-e,-t,0,-e,t,0,e,t,0,e,-t,0,-e,t,0,-e,t,2*r,e,t,2*r,e,t,0,-e,-t,0,e,-t,0,e,-t,2*r,-e,-t,2*r,e,-t,0,e,t,0,e,t,2*r,e,-t,2*r,-e,-t,0,-e,-t,2*r,-e,t,2*r,-e,t,0]},getCube=function(e){return getP(2,2,e)},getUVW=function(e,t){if(UVW[e]&&UVW[e][t])return UVW[e][t];UVW[e]||(UVW[e]=[]);var r=[0,0,1,0,1,1,0,1,0,1,0,0,1,0,1,1,0,t,0,0,1,0,1,t,0,0,1,0,1,t,0,t,0,0,1,0,1,t,0,t,1,0,1,t,0,t,0,0];return UVW[e][t]=r,r},getCoord=function(e,t,r){return coordBuffer[e]||(coordBuffer[e]=[]),coordBuffer[e][t]||(coordBuffer[e][t]=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,coordBuffer[e][t]),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(r),gl.STATIC_DRAW),coordBuffer[e][t].itemSize=3,coordBuffer[e][t].numItems=r.length/3),coordBuffer[e][t]},getUVWBuffer=function(e,t){if(UVWBuffer[e]||(UVWBuffer[e]=[]),!UVWBuffer[e][t]){var r=new Float32Array(getUVW(e,t));UVWBuffer[e][t]=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,UVWBuffer[e][t]),gl.bufferData(gl.ARRAY_BUFFER,r,gl.STATIC_DRAW),UVWBuffer[e][t].itemSize=2,UVWBuffer[e][t].numItems=r.length/2}return UVWBuffer[e][t]},drawCube=function(e){var t=e.x,r=e.y,a=e.z,o=e.h,i=e.type,n=e.trigger,l=e.decal,s=e.rotation,g=e.player,d=e.selectedPlayer,h=e.triggered;switch(i){case"trigger":o=.2;for(var c=getCube(o),f=0;f<c.length;f++)c[f]/=2;break;case"player":for(c=getCube(o),f=0;f<c.length;f+=3)c[f+2]--;break;default:c=getCube(o)}if(e.geometry)c=getP(e.geometry.x,e.geometry.y,e.geometry.z);if(cam={x:t+camera.x,y:r+camera.y,z:a+-1.2-camera.z},l&&(cam.x+=l.x,cam.y+=l.y,cam.z+=l.z),mat4.identity(mvMatrix),mat4.rotate(mvMatrix,degToRad(camera.rotation.z),[1,0,0]),mat4.rotate(mvMatrix,degToRad(camera.rotation.y),[0,1,0]),mat4.rotate(mvMatrix,degToRad(-90),[1,0,0]),mat4.translate(mvMatrix,[cam.x,cam.y,cam.z]),"ball"==i&&(mat4.rotate(mvMatrix,-Math.atan(cam.x/cam.y),[0,0,1]),mat4.rotate(mvMatrix,Math.atan((r-cam.y)/(cam.z-a)),[1,0,0]),mat4.translate(mvMatrix,[0,.5,Math.sin(frame/50)/4+.7]),lights[0]=t,lights[1]=r,lights[2]=a+l.z),"player"===i)switch(mat4.translate(mvMatrix,[0,0,1]),g.inMoveY>0?g.rotation.x+=degToRad(90/vitesseRotation):g.inMoveY<0&&(g.rotation.x-=degToRad(90/vitesseRotation)),g.inMoveX>0?g.rotation.y+=degToRad(90/vitesseRotation):g.inMoveX<0&&(g.rotation.y-=degToRad(90/vitesseRotation)),mat4.rotate(mvMatrix,g.rotation.x,[1,0,0]),g.rotation.xD){case 0:mat4.rotate(mvMatrix,g.rotation.y,[0,1,0]);break;case 1:mat4.rotate(mvMatrix,-g.rotation.y,[0,0,1]);break;case 2:mat4.rotate(mvMatrix,-g.rotation.y,[0,1,0]);break;case 3:mat4.rotate(mvMatrix,g.rotation.y,[0,0,1])}if(s&&(mat4.rotate(mvMatrix,s.x,[1,0,0]),mat4.rotate(mvMatrix,s.y,[0,1,0]),mat4.rotate(mvMatrix,s.z,[0,0,1])),v="ball"==i?shaderProgramLava:shaderProgram,e.geometry)var v=shaderProgramLava;gl.useProgram(v),gl.uniform3f(v.cp,t,r,a);var u=getUVWBuffer(i,o);gl.bindBuffer(gl.ARRAY_BUFFER,u),gl.vertexAttribPointer(v.textureCoordAttribute,u.itemSize,gl.FLOAT,!1,0,0),u=getCoord(i,o,c),gl.bindBuffer(gl.ARRAY_BUFFER,u),gl.vertexAttribPointer(v.vertexPositionAttribute,u.itemSize,gl.FLOAT,!1,0,0),lightsDisplayed.length&&gl.uniform4fv(v.lights,lightsDisplayed),gl.uniform1i(v.nbLights,lightsDisplayed.length/4),gl.uniform3f(v.ac,.1,.1,.1),gl.uniform2f(v.res,1920,1e3),gl.uniform1i(v.samplerUniform,0),gl.uniform1f(v.it,frame),gl.uniformMatrix4fv(v.pMatrixUniform,!1,pMatrix),gl.uniformMatrix4fv(v.mvMatrixUniform,!1,mvMatrix),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,cubeVertexIndexBuffer),gl.activeTexture(gl.TEXTURE0),gl.uniform1i(v.isPlayer,0),gl.uniform1i(v.cubeFace,1),gl.uniform1i(v.isCurrentPlayer,0),"ball"==i?(gl.bindTexture(gl.TEXTURE_2D,sphereTexture),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)):"block"==i||"block2"==i?("block2"==i?gl.bindTexture(gl.TEXTURE_2D,tilesColors[22]):gl.bindTexture(gl.TEXTURE_2D,crate),gl.uniform1i(v.isCurrentPlayer,"block2"==i?1:0),gl.uniform1i(v.cubeFace,1),gl.drawElements(gl.TRIANGLES,36,gl.UNSIGNED_SHORT,0),gl.uniform1i(v.cubeFace,5),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,36),gl.uniform1i(v.cubeFace,6),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,48),gl.uniform1i(v.isCurrentPlayer,0)):"player"==i?(gl.uniform1i(v.isPlayer,1),gl.uniform1i(v.isCurrentPlayer,d?1:0),gl.uniform1i(v.cubeFace,1),gl.drawElements(gl.TRIANGLES,36,gl.UNSIGNED_SHORT,0),gl.uniform1i(v.cubeFace,5),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,36),gl.uniform1i(v.cubeFace,6),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,48)):("trigger"==i?gl.bindTexture(gl.TEXTURE_2D,n.color):gl.bindTexture(gl.TEXTURE_2D,h?tilesColors[21]:tilesColors[(t/2+-r/2*10)%21]),gl.uniform1i(v.cubeFace,0),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0),"normal2"!=i&&gl.bindTexture(gl.TEXTURE_2D,mur),gl.drawElements(gl.TRIANGLES,30,gl.UNSIGNED_SHORT,12),gl.uniform1i(v.cubeFace,5),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,36),gl.uniform1i(v.cubeFace,6),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,48))},move=function(e,t,r){if(0==r.inMoveX&&0==r.inMoveY&&0==r.inMoveZ&&r.haveControl){var a=level[r.tile.x][r.tile.y];if(!level[r.tile.x+e]||!level[r.tile.x+e][r.tile.y+t])return!1;for(var o=level[r.tile.x+e][r.tile.y+t],i=!1,n=0,l=2*o.h,s=0;s<players.length;s++)players[s].tile.x==r.tile.x+e&&players[s].tile.y==r.tile.y+t&&l++;if(l>r.z)n=0;else{if(a.p.length>1&&a.p[a.p.length-1].z>players[selectedPlayer].z)return 0;if((l+=2*o.o.length)-r.z>2)n=0;else if(l>r.z){if(l==r.z+2&&2==o.o[0].type&&1==o.o.length&&(n=1),!n){if(!level[r.tile.x+e+e]||!level[r.tile.x+e+e][r.tile.y+t+t])return!1;2*(i=level[r.tile.x+e+e][r.tile.y+t+t]).h+2*i.o.length>r.z?n=0:(n=1,i.o.push(o.o[o.o.length-1]),o.o.pop(),i.o[i.o.length-1].inMoveX=e*vitesseRotation,i.o[i.o.length-1].inMoveY=t*vitesseRotation)}}else n=1}return n&&(level[r.tile.x][r.tile.y].p.pop(),r.inMoveX=e*vitesseRotation+(e?e>0?1:-1:0),r.inMoveY=t*vitesseRotation+(t?t>0?1:-1:0),r.tile.x+=e,r.tile.y+=t,level[r.tile.x][r.tile.y].p.push(r)),n&&i&&i.t&&actionTrigger(i.t,!0),n&&a.t&&!a.o.length&&actionTrigger(a.t,!1),n&&o.t&&!o.o.length&&actionTrigger(o.t,!0),nbMoves+=n,n&&playSound([0,,.047,.5711,.1329,.8391,,,,,,,,,,,,,1,,,,,.5]),n}},actionTrigger=function(e,t){if(e.state!=t)switch(e.state=t,e.action&&e.action(),e.type){case 1:if(!t)return;case 2:for(var r=0;r<e.on.length;r++){var a=e.on[r];level[a[0]][a[1]].nb+=t?1:-1,!1===t&&level[a[0]][a[1]].nb>0||switchTileHeight(a[0],a[1],a[2],a[3],t)}break;case 3:for(r=0;r<e.on.length;r++){a=e.on[r];switchTileHeight(a[0],a[1],t?a[2]:-a[2],null,t)}}},gameOver=function(){initGame()},nextLevel=function(){nbMovesAtStart=nbMoves,levelExplode=!1,18==++levelEnCours?(cancelAnimationFrame(tick),drawHUDEnd()):initGame()},explodeLevel=function(){players=[],vitesseRotation=10,levelExplode=!0,levelExplodeSince=200;for(var e=levels[levelEnCours],t=0;t<e.width;t++)for(var r=0;r<e.height;r++)level[t][r].speedZ=3*Math.random(),level[t][r].o=[],f=t>e.width/2?1:t<e.width/2?-1:0,level[t][r].speedX=Math.random()*f,f=r>e.height/2?-1:r<e.height/2?1:0,level[t][r].speedY=Math.random()*f,level[t][r].decalX=0,level[t][r].decalY=0,level[t][r].rotation={x:0,y:0,z:0},level[t][r].rotationSpeed={x:.1*Math.random(),y:.1*Math.random(),z:.1*Math.random()}},rafTick=null,rafHUD=null,waitingKeyStart=!0,initGame=function(){nbMoves=nbMovesAtStart,camera={x:-8,y:16,z:23,rotation:{x:-1.3,y:0,z:63}};var e=levels[levelEnCours];e.triggers.push({x:e.end.x,y:e.end.y,action:function(){explodeLevel()},type:"finish"}),selectedPlayer=0,level=[],vitesseRotation=1,levelDrawing=!0,levelTmp=e.data.join("");for(var t=0;t<e.width;t++){level[t]=[];for(var r=0;r<e.height;r++)level[t][r]={h:!!levelTmp[t+r*e.width]&&parseInt(levelTmp[t+r*e.width]),o:[],p:[],t:!1,z:0,inMoveZ:-Math.round(50*Math.random()),nb:0}}for(var a=0;a<e.starts.length;a++)players[a]={x:2*e.starts[a].x,y:2*-e.starts[a].y,z:22,rotation:{x:0,y:0,z:0,xD:0},tile:{x:e.starts[a].x,y:e.starts[a].y},inMoveY:0,inMoveX:0,inMoveZ:0,haveControl:!1},level[e.starts[a].x][e.starts[a].y].p=[players[a]];for(a=0;a<e.objects.length;a++)t=e.objects[a][0],r=e.objects[a][1],type=e.objects[a][2]?e.objects[a][2]:0,level[t][r].o=[{x:t,y:r,z:level[t][r].h,type:type}];for(a=0;a<e.triggers.length;a++)if(t=e.triggers[a].x,r=e.triggers[a].y,level[t][r].t={type:e.triggers[a].type,on:e.triggers[a].on,action:e.triggers[a].action,color:2==e.triggers[a].type?red:blue},e.triggers[a].on)for(var o=0;o<e.triggers[a].on.length;o++)level[e.triggers[a].on[o][0]][e.triggers[a].on[o][1]].triggered=!0;level[e.end.x][e.end.y].finish=!0},addPlayerControl=function(){if(!1===tutoNumber)for(var e=0;e<players.length;e++)players[e].haveControl=!0};var tutoNumber=!1,tutoText=!1;startTuto=function(){tuto[levelEnCours]?(tutoNumber=-1,nextTuto()):addPlayerControl()},nextTuto=function(){if(tutoNumber++,tuto[levelEnCours][tutoNumber]){var e=tuto[levelEnCours][tutoNumber];zoomOn=e[0],tutoText=e[1],setTimeout(nextTuto,e[2])}else zoomOn=!1,tutoNumber=!1,tutoText=!1,addPlayerControl()},switchTileHeight=function(e,t,r,a,o){null==a&&(a=o?level[e][t].h+r:level[e][t].h,r=o?level[e][t].h:level[e][t].h+r),o?level[e][t].h==r&&(level[e][t].inMoveZ=vitesseRotation*(r>a?2:-2),playSound([2,.1,.20875772806897386,.4,.3995907182891785,.6,.20781957085118677,-.15,0,0,0,0,0,.8997235718602934,-.19289283657523948,0,0,0,1,0,0,.0583846933342502,0,.55])):level[e][t].h==a&&(level[e][t].inMoveZ=vitesseRotation*(r>a?-2:2),playSound([2,.1,.20875772806897386,.4,.3995907182891785,.6,.20781957085118677,.15,0,0,0,0,0,.8997235718602934,-.19289283657523948,0,0,0,1,0,0,.0583846933342502,0,.6])),level[e][t].h=o?a:r},document.onkeydown=function(e){switch(waitingKeyStart&&(waitingKeyStart=!1,tick(),cancelAnimationFrame(rafHUD)),e.keyCode){case 90:case 87:case 38:moveB=!0;break;case 81:case 65:case 37:moveL=!0;break;case 40:case 83:moveF=!0;break;case 68:case 39:moveR=!0}},document.onkeyup=function(e){switch(e.keyCode){case 90:case 87:case 38:moveB=!1;break;case 81:case 65:case 37:moveL=!1;break;case 40:case 83:moveF=!1;break;case 68:case 39:moveR=!1;break;case 82:gameOver();break;case 77:sound=1-sound;break;case 32:selectedPlayer=(selectedPlayer+1)%levels[levelEnCours].starts.length}};var tuto={1:[[{x:2,y:2,z:-8},"this is you. Move with arrow keys",4e3],[{x:14,y:2,z:-8},"Watch out for holes",3e3],[{x:22,y:2,z:-8},"this is your goal, get the orb",4e3]],2:[[{x:12,y:2,z:0},"You can push the crates",3e3]],5:[[{x:2,y:-2,z:-6},"this is a switch, which modifies something in the stage",3e3]],6:[[{x:2,y:-2,z:-6},"this is another sort of trigger, have to keep it pressed",3e3]],7:[[{x:8,y:6,z:0},"this is another player. Switch between players with space key",4e3]],12:[[{x:8,y:-2,z:-8},"this block cannot be moved, but it is climbable",4e3]]};initLevels=function(){levels={1:{width:14,height:8,starts:[{x:1,y:4}],end:{x:11,y:4},data:["00000000000000","33333333333300","32222222222300","32222220222300","32222200222200","32222220222300","32222222222300","33333333333300"],objects:[],triggers:[]},2:{width:9,height:6,starts:[{x:1,y:1}],end:{x:6,y:5},data:["333333333","322222223","333333233","000003230","000003230","000003230"],objects:[[6,1]],triggers:[]},3:{width:14,height:8,starts:[{x:1,y:4}],end:{x:11,y:4},data:["00000000000000","33333333333300","33333333333300","33322222333300","32223322221200","33322222333300","33333333333300","33333333333300"],objects:[[7,4]],triggers:[]},4:{width:14,height:8,starts:[{x:1,y:4}],end:{x:11,y:4},data:["00000000000000","33333333333300","33333333333300","33322222333300","32222222211200","33322232333300","33333333333300","33333333333300"],objects:[[4,4],[6,4],[7,4]],triggers:[]},5:{width:14,height:8,starts:[{x:1,y:4}],end:{x:11,y:4},data:["00000000000000","33333333333300","32222233333300","33333222333300","32223222221200","32223333233300","33322222233300","33333333333300"],objects:[],triggers:[{x:1,y:2,type:1,on:[[10,4,1,2]]}]},6:{width:14,height:8,starts:[{x:1,y:4}],end:{x:11,y:4},data:["00000000000000","33333333333300","32222222233300","33323232333300","32222232322200","32223232333300","33322233333300","33333333333300"],objects:[[2,5],[5,5]],triggers:[{x:1,y:2,type:2,on:[[8,4,3,2]]}]},7:{width:9,height:7,starts:[{x:1,y:1},{x:4,y:3}],end:{x:1,y:5},data:["222222222","211111122","222222122","211112122","222222122","211111112","222222222"],triggers:[{x:1,y:3,type:2,on:[[7,1,2,1]]}],objects:[[6,1]]},8:{width:14,height:8,starts:[{x:1,y:3}],end:{x:9,y:4},data:["00000000000000","55544044433300","55504043333300","55504043333300","54444133333300","54444043333300","55544043333300","55554044433300"],objects:[[4,2],[1,6]],triggers:[]},9:{width:14,height:8,starts:[{x:1,y:1},{x:1,y:3}],end:{x:8,y:2},data:["33333333333300","33333333333300","33333435533300","33333333333300","33333333333300","00000000000000","00000000000000","00000000000000"],objects:[[1,2]],triggers:[{x:4,y:2,type:2,on:[[6,2,3,4]]}]},10:{width:14,height:8,starts:[{x:2,y:6},{x:10,y:2}],end:{x:5,y:4},data:["00000000000000","33323332333000","33323332333000","33323332333000","33323532333000","33323332333000","33323332333000","33323332333000"],objects:[[1,4],[9,4]],triggers:[{x:1,y:6,type:2,on:[[3,4,2,3],[7,4,2,3]]},{x:9,y:6,type:2,on:[[3,4,2,3],[7,4,2,3]]},{x:4,y:6,type:3,on:[[5,3,1]]},{x:6,y:6,type:3,on:[[5,3,1]]}]},11:{width:17,height:12,best:204,starts:[{x:4,y:6}],end:{x:16,y:6},data:["41111111111133333","33333333333332223","22222222222222323","22222333333322223","33333344444322233","00000345554332220","55555555554332225","00000055554322220","33333344444323233","32222333333322223","32322222222222223","33333333333333333"],objects:[[9,5],[9,6],[9,7]],triggers:[{x:15,y:10,type:3,on:[[16,6,-1]]},{x:15,y:9,type:3,on:[[16,6,-1]]},{x:14,y:9,type:3,on:[[16,6,-1]]}]},12:{width:9,height:7,starts:[{x:5,y:3}],end:{x:7,y:3},data:["111111111","111111112","111111012","111111020","111111012","111111112","111111111"],objects:[[4,1,2],[1,2],[1,3],[1,4],[4,5,2]],triggers:[{x:5,y:5,type:2,on:[[5,5,1,2]]},{x:5,y:1,type:2,on:[[5,1,1,2]]}]},13:{width:8,height:7,starts:[{x:3,y:4}],end:{x:7,y:2},data:["12222200","22221100","21111102","12222101","21111101","22222122","12222222"],objects:[[2,2],[2,4]],triggers:[{x:5,y:5,type:2,on:[[5,5,1,2]]},{x:4,y:1,type:2,on:[[4,1,1,2]]},{x:1,y:4,type:2,on:[[1,4,1,2]]}]},14:{width:16,height:7,starts:[{x:1,y:3}],end:{x:13,y:3},data:["022222220000200","0021111122202220","0221222111222222","0211111111222212","0211121112222222","0221121112002220","0022222222000200"],objects:[[2,2],[4,3],[7,3],[6,4]],triggers:[{x:2,y:5,type:2,on:[[9,3,2,1]]},{x:3,y:5,type:2,on:[[10,3,2,1]]},{x:2,y:4,type:2,on:[[11,3,2,1]]},{x:3,y:4,type:2,on:[[12,3,2,1]]}]},15:{width:15,height:15,starts:[{x:0,y:3}],end:{x:7,y:10},data:["222222000000000","222222222022230","332333222322230","222222222022230","333333222000100","222222223000200","333332223000200","000000000002200","000000333302200","000000322333230","000000322222230","000000322333330","000000333300000","000000000000000","000000000000000"],objects:[[2,2,2],[5,3,2],[6,3],[7,3],[12,6]],triggers:[{x:2,y:5,type:2,on:[[2,2,2,1]]},{x:0,y:2,type:2,on:[[9,2,3,2]]}]},16:{width:16,height:16,starts:[{x:8,y:7}],end:{x:7,y:10},data:["0000000000000000","0004444444000000","0004323334444400","0004222223333400","0004222222223400","0004222222223400","0004222333222400","0004222323323400","0004222322333400","0004222222444400","0004444344400000","0000000000000000","0000000000000000","0000000000000000","2222222222222222","2222222222222222"],objects:[[5,3,2],[5,4],[6,4],[7,3],[8,4]],triggers:[]},17:{width:10,height:10,starts:[{x:1,y:5},{x:1,y:6},{x:1,y:7}],end:{x:7,y:8},data:["0000000000","0000000000","0000000000","3333233300","2111111300","2111111100","2111111300","2111133330","2111113330","2222133330"],objects:[[4,8]],triggers:[{x:6,y:5,type:2,on:[[6,5,1,2]]},{x:4,y:3,type:2,on:[[4,3,2,3]]}]}}}</script>