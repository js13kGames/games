<!doctype html><meta content="width=device-width" name=viewport><title>Marco...? - js13kGames 2023</title><style>*{margin:0;padding:0}body,html{overflow:hidden}body,button{font-family:"Times New Roman",Times,serif}#info{position:absolute;bottom:10%;left:0;width:100%;height:10%;display:flex;align-items:center;justify-content:flex-end;flex-direction:column;background:rgba(11,11,11,.001)}#info2{position:absolute;bottom:0;left:0;width:100%;height:8%;display:flex;align-items:center;text-align:center;flex-direction:column;background:rgba(11,11,11,.001);line-height:150%}#gui{position:absolute;top:2px;right:2px}h5{color:#111118}.button{border:none;padding:8px 32px;text-align:center;font-size:30px;transition-duration:.4s;cursor:pointer}.startButton{background-color:#fff;color:#000;border:2px solid #111118}.startButton:hover{background-color:#111118;color:#fff}.blackout{width:100%;height:100%;background:#000;position:fixed;top:0;left:0;z-index:1;display:flex;justify-content:center;align-items:center}.loadingspinner{pointer-events:none;width:2.5em;height:2.5em;border:.4em solid transparent;border-color:#000;border-top-color:#3b2535;border-radius:50%;animation:loadingspin 1s linear infinite}@keyframes loadingspin{100%{transform:rotate(360deg)}}</style><audio id=song preload=auto style=display:none><source src=marco.opus></audio><audio id=song2 preload=auto style=display:none><source src=polo.opus></audio><div class=blackout><div class=loadingspinner></div></div><div id=info><button class="button startButton" id=startButton>start</button></div><div id=info2><h5 class=landtext>game by Shauna Lynch<br><a href=https://www.lynchbyte.com/16_Marco/license_Marco.html rel=noopener target=_blank>license MIT and CC BY-SA 4.0</a></h5><br></div><script type=module>function addAudio(){var e=new TZ.AudioListener,t=(camera.add(e),new TZ.SphereGeometry(2,32,16)),n=new TZ.MeshPhongMaterial({color:16755200,flatShading:!0,shininess:0});(n=new TZ.Mesh(t,n)).visible=!1;const r=[new TZ.Vector3(9.5,1.5,7.5),new TZ.Vector3(9.5,1.5,19.36),new TZ.Vector3(9.5,1.5,31.2),new TZ.Vector3(9.5,1.5,-7.5),new TZ.Vector3(9.5,1.5,-19.36),new TZ.Vector3(9.5,1.5,-31.2),new TZ.Vector3(-9.5,1.5,7.5),new TZ.Vector3(-9.5,1.5,19.36),new TZ.Vector3(-9.5,1.5,31.2),new TZ.Vector3(-9.5,1.5,-7.5),new TZ.Vector3(-9.5,1.5,-19.36),new TZ.Vector3(-9.5,1.5,-31.2)],o=Math.floor(11*Math.random());n.position.set(r[o].x,r[o].y,r[o].z),castleGroupParent.add(n),n.geometry.computeBoundingBox(),(a=new TZ.Box3).setFromObject(n),poloArr.push(a);var a=txLoader.load("mp2.webp"),s=(a=new TZ.MeshStandardMaterial({map:a,side:TZ.DoubleSide,alphaTest:.05}),new TZ.PlaneGeometry(.75,.75,32,32)),i=(s=new TZ.Mesh(s,a),poloArr.push(s),a=r.filter(e=>e!==r[o]),s=Math.floor(10*Math.random()),new TZ.MeshPhongMaterial({color:"green"}));(t=new TZ.Mesh(t,i)).visible=!1,t.name="Dungeon",t.position.set(a[s].x,a[s].y,a[s].z),castleGroupParent.add(t),t.geometry.computeBoundingBox(),(i=new TZ.Box3).setFromObject(t),dungeonArr.push(i),a=new TZ.PositionalAudio(e),s=document.getElementById("song"),a.setMediaElementSource(s),a.setRefDistance(50),s_MarcoArr.push(s),camera.add(a),t=new TZ.PositionalAudio(e),i=document.getElementById("song2"),t.setMediaElementSource(i),t.setRefDistance(50),s_PoloArr.push(i),n.add(t)}function qq(e,t,n){e.lineTo(t,n)}function addCastle(){(n=new TZ.Shape).moveTo(-8,-2),qq(n,-7.5,-2),qq(n,-7.5,2),qq(n,-8,2),(r=new TZ.Shape).moveTo(8,12.43),qq(r,7.5,12.43),qq(r,7.5,8.535),qq(r,8,8.535),qq(r,9.464,10),qq(r,11.535,10),qq(r,13,8.535),qq(r,13,6.464),qq(r,11.535,5),qq(r,9.464,5),qq(r,8,6.464),qq(r,7.5,6.4645),qq(r,7.5,2),qq(r,8,2),qq(r,8,4.5),qq(r,11.742,4.5),qq(r,13.5,6.257),qq(r,13.5,8.742),qq(r,11.742,10.5),qq(r,8,10.5),(o=new TZ.Shape).moveTo(1.969,30.5),qq(o,1.969,30),qq(o,0,30),qq(o,0,30.5),(a=new TZ.Shape).moveTo(6,30.524),qq(a,5.939,30.5),qq(a,3.969,30.5),qq(a,3.969,30),qq(a,6.035,30),qq(a,6.5,30.185),qq(a,6.5,32.256),qq(a,7.964,33.72),qq(a,10.035,33.72),qq(a,11.5,32.256),qq(a,11.5,30.185),qq(a,10.035,28.72),qq(a,7.964,28.72),qq(a,7.5,28.535),qq(a,7.5,26.278),qq(a,8,26.278),qq(a,8,28.1966),qq(a,8.06,28.22),qq(a,10.242,28.22),qq(a,12,29.978),qq(a,12,32.463),qq(a,10.242,34.22),qq(a,7.757,34.22),qq(a,6,32.463),(s=new TZ.Shape).moveTo(11.742,22.36),qq(s,8,22.36),qq(s,8,24.278),qq(s,7.5,24.278),qq(s,7.5,20.395),qq(s,8,20.395),qq(s,9.4645,21.86),qq(s,11.5355,21.86),qq(s,13,20.395),qq(s,13,18.324),qq(s,11.535,16.86),qq(s,9.464,16.86),qq(s,8,18.324),qq(s,7.5,18.324),qq(s,7.5,14.43),qq(s,8,14.43),qq(s,8,16.36),qq(s,11.742,16.36),qq(s,13.5,18.117),qq(s,13.5,20.603),(i=new TZ.Shape).moveTo(6.5,30.19),qq(i,6.04,30),qq(i,7.5,28.54),qq(i,7.96,28.72),(d=new TZ.Shape).moveTo(7.5,20.4),qq(d,8,20.4),qq(d,8,18.32),qq(d,7.5,18.32),(c=new TZ.Shape).moveTo(8,8.54),qq(c,7.5,8.54),qq(c,7.5,6.46),qq(c,8,6.46),(l=new TZ.Shape).moveTo(3.969,30.5),qq(l,1.969,30.5),qq(l,1.969,30),qq(l,3.969,30),(T=new TZ.Shape).moveTo(8,26.278),qq(T,7.5,26.278),qq(T,7.5,24.278),qq(T,8,24.278),(p=new TZ.Shape).moveTo(8,14.43),qq(p,7.5,14.43),qq(p,7.5,12.43),qq(p,8,12.43),(m=new TZ.Shape).moveTo(13.328,9.621),qq(m,12.621,10.328),qq(m,11.914,9.621),qq(m,12.621,8.914),(q=new TZ.Shape).moveTo(8.379,4.672),qq(q,9.086,5.379),qq(q,8.379,6.086),qq(q,7.672,5.379),(u=new TZ.Shape).moveTo(7,8),qq(u,7,7),qq(u,8,7),qq(u,8,8),(w=new TZ.Shape).moveTo(11,10),qq(w,11,11),qq(w,10,11),qq(w,10,10),(h=new TZ.Shape).moveTo(14,7),qq(h,14,8),qq(h,13,8),qq(h,13,7),(Z=new TZ.Shape).moveTo(12.621,4.672),qq(Z,13.328,5.379),qq(Z,12.621,6.086),qq(Z,11.914,5.379),(x=new TZ.Shape).moveTo(7.672,9.621),qq(x,8.379,8.914),qq(x,9.086,9.621),qq(x,8.379,10.328),(v=new TZ.Shape).moveTo(10,4),qq(v,11,4),qq(v,11,5),qq(v,10,5);var e={depth:4,bevelEnabled:!1},t={depth:1.2,bevelEnabled:!1},n=new TZ.ExtrudeGeometry(n,e),r=new TZ.ExtrudeGeometry(r,e),o=new TZ.ExtrudeGeometry(o,e),a=new TZ.ExtrudeGeometry(a,e),s=new TZ.ExtrudeGeometry(s,e),i=new TZ.ExtrudeGeometry(i,e),d=new TZ.ExtrudeGeometry(d,e),c=new TZ.ExtrudeGeometry(c,e),l=(i.clone().scale.z=-1,(e=d.clone()).scale.z=-1,c.clone(),e.scale.z=-1,e=new TZ.ExtrudeGeometry(l,t),new TZ.ExtrudeGeometry(T,t)),T=new TZ.ExtrudeGeometry(p,t),p=new TZ.ExtrudeGeometry(m,t),m=new TZ.ExtrudeGeometry(q,t),q=new TZ.ExtrudeGeometry(u,t),u=new TZ.ExtrudeGeometry(w,t),w=new TZ.ExtrudeGeometry(h,t),h=new TZ.ExtrudeGeometry(Z,t),Z=new TZ.ExtrudeGeometry(x,t),x=new TZ.ExtrudeGeometry(v,t),v=new TZ.MeshStandardMaterial({color:castleColVal}),y=(t=new TZ.Group,n=new TZ.Mesh(n,v),r=new TZ.Mesh(r,v),o=new TZ.Mesh(o,v),a=new TZ.Mesh(a,v),s=new TZ.Mesh(s,v),(i=new TZ.Mesh(i,v)).userData.type="Door",(d=new TZ.Mesh(d,v)).userData.type="Door",(c=new TZ.Mesh(c,v)).userData.type="Door",e=new TZ.Mesh(e,v),l=new TZ.Mesh(l,v),T=new TZ.Mesh(T,v),e.clone()),M=(y.translateZ(2.8),l.clone()),f=(M.translateZ(2.8),T.clone());f.translateZ(2.8),p=new TZ.Mesh(p,v),m=new TZ.Mesh(m,v),q=new TZ.Mesh(q,v),u=new TZ.Mesh(u,v),w=new TZ.Mesh(w,v),h=new TZ.Mesh(h,v),Z=new TZ.Mesh(Z,v),x=new TZ.Mesh(x,v),(v=new TZ.Group).add(p,m,q,u,w,h,Z,x),v.translateZ(4),(p=v.clone()).translateY(11.86),(m=p.clone()).translateY(11.86),m.translateX(-1.45),q=new TZ.MeshStandardMaterial({color:5066061}),(u=new TZ.Mesh(new TZ.BoxGeometry(.5,4,4),q)).rotateY(Math.PI/180*90),u.translateZ(9.5),t.add(r,o,a,s,i,d,c,e,l,T,y,M,f),t.add(v,p,m),t.rotation.set(Math.PI/180*-90,0,0),castleGroupParent.add(t),w=t.clone(),t.scale.x=-1,castleGroupParent.add(w),(h=t.clone()).rotateZ(Math.PI/180*180),castleGroupParent.add(h),t.add(n),t.add(u),(Z=w.clone()).rotateZ(Math.PI/180*180),castleGroupParent.add(Z),castleGroupParent.traverse(e=>{"Door"==e.userData.type&&(e.material=new TZ.MeshStandardMaterial({color:65535,side:TZ.DoubleSide}),clickable.push(e))}),castleGroupParent.position.set(0,groundLevel,0),castleGroupParent.rotation.set(0,Math.PI/180*180,0),castleGroupParent.castShadow=!0,castleGroupParent.receiveShadow=!0,(x=createText("üñºÔ∏è",2,"Arial")).position.set(0,2,29.9),castleGroupParent.add(x),(r=createText("üî•",1,"Arial")).position.set(0,.6,-29.9),castleGroupParent.add(r),(o=createText("üü™",2,"Arial")).position.set(0,.8,-29.95),castleGroupParent.add(o),(a=createText("üï∞Ô∏è",1,"Arial")).position.set(0,2,-29.9),castleGroupParent.add(a),s=new TZ.Group,i=makeButtonMesh(1.25,.65,.001,"orange"),(c=(d=createText("‚Ä†13‚Ä†",.4,"Times New Roman")).clone()).rotateY(3.14),i.add(d,c),d.position.set(.05,-.025,.1),c.position.set(.05,-.025,-.1),s.add(i),(e=new TZ.Mesh(new TZ.CylinderGeometry(.1,.02,2,32),new TZ.MeshBasicMaterial({color:"Black"}))).position.set(-.58,-.7,0),s.add(e),s.rotateY(3.14),s.position.set(-11,10,8),s.scale.set(3,3,3),(l=s.clone()).translateZ(26),castleGroupParent.add(s,l),T=new TZ.Group,y=new TZ.Mesh(new TZ.BoxGeometry(1.5,1,2.5),q),M=new TZ.Group,f=createText("üçΩÔ∏è",.5,"Arial"),(v=createText("üçó",.25,"Arial")).translateZ(-.01),(p=createText("üç∑",.5,"Arial")).position.set(.3,.8,-.25),p.rotation.set(-1.57,1.57,0),M.add(f,v,p),M.rotateX(1.57),M.rotateZ(3.14),M.position.set(0,.55,.85),(m=M.clone()).rotateZ(3.14),m.translateY(-2),T.add(y,M,m),T.position.set(6.7,.4,0),castleGroupParent.add(T),scene.add(castleGroupParent),castleGroupParent.matrixWorldNeedsUpdate=!1,chapters.one_title=!0}let controllerGrip1,controllerGrip2;function addControllersVR(){scene.add(ctr1),scene.add(ctr2);var e=new TZ.LineBasicMaterial({color:15094391}),t=(new TZ.BufferGeometry).setFromPoints([new TZ.Vector3(0,0,0),new TZ.Vector3(0,0,-1)]);(t=new TZ.Line(t,e)).scale.z=10,ctr1.add(t.clone()),ctr2.add(t.clone()),ctr1.addEventListener("selectstart",onSelectStart),ctr1.addEventListener("selectend",onSelectEnd),ctr1.addEventListener("connected",function(e){controllerGrip1=renderer.xr.getControllerGrip(0),scene.add(controllerGrip1)}),ctr1.addEventListener("disconnected",function(){this.remove(this.children[0])}),ctr2.addEventListener("selectstart",onSelectStart),ctr2.addEventListener("selectend",onSelectEnd),ctr2.addEventListener("connected",function(e){controllerGrip2=renderer.xr.getControllerGrip(1),scene.add(controllerGrip2)}),ctr2.addEventListener("disconnected",function(){this.remove(this.children[0])})}function addFloor(){var e=(new TZ.Shape).moveTo(0,1).lineTo(1,1).lineTo(1,0).lineTo(1.5,0).lineTo(1.5,1).lineTo(2.5,1).lineTo(2.5,1.5).lineTo(1.5,1.5).lineTo(1.5,2.5).lineTo(1,2.5).lineTo(1,1.5).lineTo(0,1.5),n=new TZ.ExtrudeGeometry(e,{depth:.01,bevelEnabled:!1}),r=(n.center(),new TZ.Group);for(let t=0;t<5;t++)for(let e=0;e<20;e++){var o=new TZ.Mesh(n,new TZ.MeshPhongMaterial);o.rotation.set(Math.PI/180*90,Math.PI/180*0,Math.PI/180*45),o.position.set(3*t-6,.1,3*e-28.5),o.name="Cross"+(t+1)+(e+1),o.userData.type="cross",r.add(o),clickable.push(o)}castleGroupParent.add(r)}async function loadShaders(){var e=await(await fetch("vert.glsl")).text(),t=await(await fetch("frag.glsl")).text(),e=new TZ.ShaderMaterial({vertexShader:e,fragmentShader:t,side:2,transparent:!0});skyShaderArr.push(e),removeFadeOut(document.querySelector(".blackout"),3e3)}function addSky(){var e=new TZ.CylinderGeometry(60,60,20,32,1,!0);(e=new TZ.Mesh(e,skyShaderArr[0])).position.set(0,5,0),scene.add(e)}let zzfxV=.3;const zzfx=(e=1,t=.05,n=220,r=0,o=0,a=.1,s=0,i=1,d=0,c=0,l=0,T=0,p=0,m=0,q=0,u=0,w=0,h=1,Z=0,x=0,v=Math,y=44100,M=2*v.PI,f=d*=500*M/y/y,S=n*=(1-t+2*t*v.random(t=[]))*M/y,g=0,b=0,G=0,P=1,E=0,R=0,I=0,z,A)=>{for(c*=500*M/y**3,q*=M/y,l*=M/y,T*=y,p=y*p|0,A=(r=y*r+9)+(Z*=y)+(o*=y)+(a*=y)+(w*=y)|0;G<A;t[G++]=I)++R%(100*u|0)||(I=s?1<s?2<s?3<s?v.sin((g%M)**3):v.max(v.min(v.tan(g),1),-1):1-(2*g/M%2+2)%2:1-4*v.abs(v.round(g/M)-g/M):v.sin(g),I=(p?1-x+x*v.sin(M*G/p):1)*(0<I?1:-1)*v.abs(I)**i*zzfxV*e*(G<r?G/r:G<r+Z?1-(G-r)/Z*(1-h):G<r+Z+o?h:G<A-w?(A-G-w)/a*h:0),I=w?I/2+(G<w?0:(G<A-w?1:(A-G)/w)*t[G-w|0]/2):I),g+=(z=(n+=d+=c)*v.cos(q*b++))-z*m*(1-1e9*(v.sin(G)+1)%2),P&&++P>T&&(n+=l,S+=l,P=0),!p||++E%p||(n=S,d=f,P||=1);return(e=zzfxX.createBuffer(1,A,y)).getChannelData(0).set(t),(n=zzfxX.createBufferSource()).buffer=e,n.connect(zzfxX.destination),n.start(),n},zzfxX=new AudioContext;function getClicked(e){if(0!=e.length&&0<e.length)switch(e[0].object.userData.type){case"enterVR":startSession("immersive-vr"),addControllersVR(),removeOb("VR OK Button",camera),addEx(),(t=createText("üì¢",.25,"Arial",!0)).position.set(.75,0,-1.5),t.userData.type="Clue",t.name="clue",camera.add(t);break;case"cross":null!==renderer.xr.getSession()&&(zzfx(1.01,void 0,629,.05,.17,.41,1,1.83,void 0,.2,148,.16,.19,void 0,void 0,.5,.01,.82,.28,.47),dummyOb.position.set(camera.position.x,camera.position.y,camera.position.z),chapters.three_setRef=!0,t=new TZ.Vector3(e[0].point.x,0,e[0].point.z),newSpotArr.push(t),slp(1e3).then(()=>{chapters.three_setRef=!1,newSpotArr.length=0}));break;case"Clue":null!==renderer.xr.getSession()&&(s_MarcoArr[0].play(),slp(2500).then(()=>{s_PoloArr[0].play()}));break;case"Door":if(zzfx(void 0,void 0,471,void 0,.09,.47,4,1.06,-6.7,void 0,void 0,void 0,void 0,.9,61,.1,void 0,.82,.09,.13),null!==renderer.xr.getSession()){var t=e[0].object,n=(new TZ.Box3).setFromObject(t);if(1==n.intersectsBox(dungeonArr[0])){zzfx(void 0,void 0,662,.82,.11,.33,1,0,void 0,-.2,void 0,void 0,void 0,1.2,void 0,.26,.01);const e=createText("üßü",.25);e.position.set(0,0,-.75),e.userData.type="Zombie",camera.add(e),slp(250).then(()=>{e.translateZ(.05),slp(250).then(()=>{e.translateZ(.05),slp(250).then(()=>{e.translateZ(.05),slp(250).then(()=>{e.translateZ(.05),slp(250).then(()=>{e.translateZ(.05)})})})})}),gameOver()}1==n.intersectsBox(poloArr[0])&&(camera.add(poloArr[1]),poloArr[1].translateZ(-1.5),zzfx(void 0,void 0,80,.3,.4,.7,2,.1,-.73,3.42,-430,.09,.17,void 0,void 0,void 0,.19),gameOver()),t.parent.remove(t)}break;case"Exit":location.reload()}}function gameOver(){clickable.length=0;var e=sgobn("exit");camera.remove(e),e=sgobn("clue"),camera.remove(e),slp(1e3).then(()=>{addEx()})}function addEx(){var e=createText("‚Üª",.25,"Arial",!0),t=(e.position.set(-.7,0,-1.5),e.userData.type="Exit",e.name="exit",camera.add(e),createText("reload",.05,"Times New Roman "));t.position.clone(e),t.translateY(-.15),e.add(t)}function createText(e,t,n,r=!1){(a=(s=document.createElement("canvas")).getContext("2d")).font="normal 100px "+n;var o=a.measureText(e).width,a=(s.width=o,s.height=100,s.border="10px solid blue",a.font="normal 75px "+n,a.textAlign="center",a.textBaseline="middle",a.fillText(e,o/2,50),(n=new TZ.Texture(s)).needsUpdate=!0,new TZ.MeshStandardMaterial({side:TZ.DoubleSide,map:n,transparent:!0})),s=(e=new TZ.PlaneGeometry(t*o/100,t),new TZ.Mesh(e,a));return 1==r&&clickable.push(s),s}function makeButtonMesh(e,t,n,r){return e=new TZ.BoxGeometry(e,t,n),t=new TZ.MeshStandardMaterial({color:r}),new TZ.Mesh(e,t)}function removeOb(e,t){e=sgobn(e),t.remove(e)}function sgobn(e){return scene.getObjectByName(e)}function slp(t){return new Promise(e=>setTimeout(e,t))}function addMarkers(){var e=new TZ.BoxGeometry(.2,.2,.2),t=new TZ.MeshPhongMaterial;(e=new TZ.Mesh(e,t)).position.set(0,0,0),scene.add(e),(t=e.clone()).position.set(0,1,0),scene.add(t),(t=e.clone()).position.set(0,2,0),scene.add(t),e=new TZ.SphereGeometry(.035,32,16),t=new TZ.MeshPhongMaterial({color:"blue"}),e=new TZ.Mesh(e,t),scene.add(e),t=new TZ.ConeGeometry(.1,.3,16),e=new TZ.MeshPhongMaterial({color:"pink"}),(t=new TZ.Mesh(t,e)).rotation.set(Math.PI/180*90,Math.PI/180*0,Math.PI/180*0),t.translateY(-.15),scene.add(t)}function addVRFloor(){let t=new TZ.CylinderGeometry(8.5,8.5,.02,32),n=[void 0,void 0,void 0,void 0,void 0,void 0,void 0],r=new TZ.Group,e=new TZ.Color,o=(new TZ.Color(11573187).getHSL(e),360*e.h),a=100*e.s,s=100*e.l;s-=20;var i=20/n.length;for(let e=0;e<n.length;e++){s+=i;var d=new TZ.Color(`hsl(${o}, ${a}%, ${s}%)`);n[e]=new TZ.MeshBasicMaterial({color:d}),(d=new TZ.Mesh(t,n[e])).position.set(0,-.1*e,0),d.scale.set(e+1,e+1,e+1),r.add(d)}castleGroupParent.add(r)}const raycasterXR=new TZ.Raycaster,tempMatrix=new TZ.Matrix4;let INT2;function intersectObjects(e){void 0===e.userData.selected&&0!=(e=getIntersections(e)).length&&(INT2!=e[0].object?(INT2&&INT2.material.emissive.setHex(INT2.currentHex),(INT2=e[0].object).currentHex=INT2.material.emissive.getHex(),INT2.material.emissive.setHex(16711680)):(INT2&&INT2.material.emissive.setHex(INT2.currentHex),INT2=null))}function getIntersections(e){return e.updateMatrixWorld(),tempMatrix.identity().extractRotation(e.matrixWorld),raycasterXR.ray.origin.setFromMatrixPosition(e.matrixWorld),raycasterXR.ray.direction.set(0,0,-1).applyMatrix4(tempMatrix),raycasterXR.intersectObjects(clickable)}function onSelectStart(e){0<(e=getIntersections(e.target)).length&&(e[0].object,getClicked(e))}function onSelectEnd(e){}const pointer=new TZ.Vector2(1,1),raycaster_Pointer=new TZ.Raycaster;let INT;function onPointerMove(e){e.preventDefault(),pointer.x=e.clientX/window.innerWidth*2-1,pointer.y=-e.clientY/window.innerHeight*2+1,raycaster_Pointer.setFromCamera(pointer,camera),0<(e=raycaster_Pointer.intersectObjects(clickable)).length?INT!=e[0].object&&(INT&&INT.material.emissive.setHex(INT.currentHex),(INT=e[0].object).currentHex=INT.material.emissive.getHex(),"enterVR"==INT.userData.type)&&INT.material.emissive.setHex(16711680):(INT&&INT.material.emissive.setHex(INT.currentHex),INT=null)}function onPointerClick(e){e.preventDefault(),pointer.x=e.clientX/window.innerWidth*2-1,pointer.y=-e.clientY/window.innerHeight*2+1,raycaster_Pointer.setFromCamera(pointer,camera),getClicked(raycaster_Pointer.intersectObjects(scene.children))}async function XRSuppQry(){var e,t;"xr"in navigator&&((t=await navigator.xr.isSessionSupported("immersive-vr"))&&((e=createText("Enter VR",.25,"Times New Roman",!0)).userData.type="enterVR",e.position.set(0,0,zVal),e.name="VR OK Button",e.userData.type="enterVR",clickable.push(e),camera.add(e),slp(5e3).then(()=>{chapters.two_start=!1,addAudio()})),t||((e=createText("VR Not Found :(",.2,"Times New Roman")).position.set(0,.25,.01),e.position.set(0,0,zVal),t=makeButtonMesh(1.5,.3,.01,12272462,!1),e.add(t),t.translateZ(-.01),camera.add(e)))}async function startSession(e){try{onSessionStarted(await navigator.xr.requestSession(e,{optionalFeatures:["hand-tracking"]}))}catch(e){alert("Failed to start Web XR session.",e)}}async function onSessionStarted(e){e.addEventListener("end",onSessionEnded),renderer.xr.setReferenceSpaceType("local"),await renderer.xr.setSession(e)}function onSessionEnded(){}import*as TZ from"/2023/webxr/three.js";const skyShaderArr=[],txLoader=new TZ.TextureLoader,clickable=(loadShaders(),[]),chapters={one_title:!1,two_start:!1,three_setRef:!1},newSpotArr=[],castleGroupParent=new TZ.Group,backgroundColVal=13879779,castleColVal=8553953,zVal=-1.5,groundLevel=-2,s_MarcoArr=[],s_PoloArr=[],poloArr=[],dungeonArr=[],scene=new TZ.Scene,dummyOb=(scene.background=new TZ.Color(13879779),new TZ.Mesh(new TZ.BoxGeometry(.1,.1,.1),new TZ.MeshNormalMaterial)),clock=(dummyOb.position.set(0,0,0),dummyOb.visible=!1,scene.add(dummyOb),new TZ.Clock),camera=new TZ.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.01,500),light=(camera.position.set(-20,20,45),camera.lookAt(0,0,zVal),scene.add(camera),new TZ.AmbientLight(4210752,12)),dirLight=(scene.add(light),new TZ.DirectionalLight(16777215,1.2)),renderer=(dirLight.position.set(0,2,1),scene.add(dirLight),new TZ.WebGLRenderer({antialias:!0})),ctr1=(renderer.setPixelRatio(Math.max(window.devicePixelRatio,1.5)),renderer.setSize(window.innerWidth,window.innerHeight),renderer.xr.enabled=!0,document.body.appendChild(renderer.domElement),renderer.xr.getController(0)),ctr2=renderer.xr.getController(1),baseReferenceSpaceArr=(window.addEventListener("resize",onWindowResize),document.addEventListener("click",onPointerClick),document.addEventListener("mousemove",onPointerMove),[]),startButton=(renderer.xr.addEventListener("sessionstart",xrSessionStarted),renderer.xr.addEventListener("sessionend",xrSessionEnded),document.getElementById("startButton")),titleText=(startButton.addEventListener("click",startFunction),createText("Marco...?",.4,"Times New Roman"));function removeFadeOut(e,t){e.style.transition="opacity "+t/1e3+"s ease",e.style.opacity=0,setTimeout(function(){e.remove()},t)}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function startFunction(){slp(250).then(()=>{document.getElementById("info").remove(),document.getElementById("info2").remove(),removeOb("Title",camera),chapters.one_title=!1,chapters.two_start=!0,slp(7500).then(()=>{XRSuppQry()})})}let baseReferenceSpace;function xrSessionStarted(e){baseReferenceSpace=renderer.xr.getReferenceSpace(),addVRFloor()}function xrSessionEnded(e){}function animate(){renderer.setAnimationLoop(render)}titleText.position.set(0,.75,zVal),titleText.name="Title",camera.add(titleText),addVRFloor(),slp(1e3).then(()=>{addCastle(),addFloor(),addSky()}),animate();let alpha=0;function render(e,t){var n=clock.getDelta();clock.getElapsedTime();let r=renderer.xr.getSession();if(null!==r&&(intersectObjects(ctr1),1<r.inputSources.length)&&intersectObjects(ctr2),!0===chapters.one_title&&(castleGroupParent.rotation.y+=.1*n),1==chapters.two_start&&(alpha+=n,camera.position.lerp(new TZ.Vector3(0,0,0),.005*alpha)),1==chapters.three_setRef){alpha+=n,dummyOb.position.lerp(newSpotArr[0],.001*alpha);const e={x:-dummyOb.position.x,y:-dummyOb.position.y,z:-dummyOb.position.z,w:1},t=new TZ.Quaternion,r=new XRRigidTransform(e,t),o=baseReferenceSpace.getOffsetReferenceSpace(r);renderer.xr.setReferenceSpace(o)}renderer.render(scene,camera)}</script>