function addAudio(){const e=new TZ.AudioListener;camera.add(e);const t=new TZ.SphereGeometry(2,32,16),n=new TZ.MeshPhongMaterial({color:16755200,flatShading:!0,shininess:0}),o=new TZ.Mesh(t,n);o.visible=!1;const r=[new TZ.Vector3(9.5,1.5,7.5),new TZ.Vector3(9.5,1.5,19.36),new TZ.Vector3(9.5,1.5,31.2),new TZ.Vector3(9.5,1.5,-7.5),new TZ.Vector3(9.5,1.5,-19.36),new TZ.Vector3(9.5,1.5,-31.2),new TZ.Vector3(-9.5,1.5,7.5),new TZ.Vector3(-9.5,1.5,19.36),new TZ.Vector3(-9.5,1.5,31.2),new TZ.Vector3(-9.5,1.5,-7.5),new TZ.Vector3(-9.5,1.5,-19.36),new TZ.Vector3(-9.5,1.5,-31.2)],a=Math.floor(11*Math.random());o.position.set(r[a].x,r[a].y,r[a].z),castleGroupParent.add(o),o.geometry.computeBoundingBox();const s=new TZ.Box3;s.setFromObject(o),poloArr.push(s);const i=txLoader.load("media/mp2.webp"),c=new TZ.MeshStandardMaterial({map:i,side:TZ.DoubleSide,alphaTest:.05}),d=new TZ.PlaneGeometry(.75,.75,32,32),l=new TZ.Mesh(d,c);poloArr.push(l);const T=r.filter((e=>e!==r[a])),u=Math.floor(10*Math.random()),m=new TZ.MeshPhongMaterial({color:"green"}),p=new TZ.Mesh(t,m);p.visible=!1,p.name="Dungeon",p.position.set(T[u].x,T[u].y,T[u].z),castleGroupParent.add(p),p.geometry.computeBoundingBox();const q=new TZ.Box3;q.setFromObject(p),dungeonArr.push(q);const w=new TZ.PositionalAudio(e),h=document.getElementById("song");w.setMediaElementSource(h),w.setRefDistance(50),s_MarcoArr.push(h),camera.add(w);const Z=new TZ.PositionalAudio(e),x=document.getElementById("song2");Z.setMediaElementSource(x),Z.setRefDistance(50),s_PoloArr.push(x),o.add(Z)}function qq(e,t,n){e.lineTo(t,n)}function addCastle(){const e=new TZ.Shape;e.moveTo(-8,-2),qq(e,-7.5,-2),qq(e,-7.5,2),qq(e,-8,2);const t=new TZ.Shape;t.moveTo(8,12.43),qq(t,7.5,12.43),qq(t,7.5,8.535),qq(t,8,8.535),qq(t,9.464,10),qq(t,11.535,10),qq(t,13,8.535),qq(t,13,6.464),qq(t,11.535,5),qq(t,9.464,5),qq(t,8,6.464),qq(t,7.5,6.4645),qq(t,7.5,2),qq(t,8,2),qq(t,8,4.5),qq(t,11.742,4.5),qq(t,13.5,6.257),qq(t,13.5,8.742),qq(t,11.742,10.5),qq(t,8,10.5);const n=new TZ.Shape;n.moveTo(1.969,30.5),qq(n,1.969,30),qq(n,0,30),qq(n,0,30.5);const o=new TZ.Shape;o.moveTo(6,30.524),qq(o,5.939,30.5),qq(o,3.969,30.5),qq(o,3.969,30),qq(o,6.035,30),qq(o,6.5,30.185),qq(o,6.5,32.256),qq(o,7.964,33.72),qq(o,10.035,33.72),qq(o,11.5,32.256),qq(o,11.5,30.185),qq(o,10.035,28.72),qq(o,7.964,28.72),qq(o,7.5,28.535),qq(o,7.5,26.278),qq(o,8,26.278),qq(o,8,28.1966),qq(o,8.06,28.22),qq(o,10.242,28.22),qq(o,12,29.978),qq(o,12,32.463),qq(o,10.242,34.22),qq(o,7.757,34.22),qq(o,6,32.463);const r=new TZ.Shape;r.moveTo(11.742,22.36),qq(r,8,22.36),qq(r,8,24.278),qq(r,7.5,24.278),qq(r,7.5,20.395),qq(r,8,20.395),qq(r,9.4645,21.86),qq(r,11.5355,21.86),qq(r,13,20.395),qq(r,13,18.324),qq(r,11.535,16.86),qq(r,9.464,16.86),qq(r,8,18.324),qq(r,7.5,18.324),qq(r,7.5,14.43),qq(r,8,14.43),qq(r,8,16.36),qq(r,11.742,16.36),qq(r,13.5,18.117),qq(r,13.5,20.603);const a=new TZ.Shape;a.moveTo(6.5,30.19),qq(a,6.04,30),qq(a,7.5,28.54),qq(a,7.96,28.72);const s=new TZ.Shape;s.moveTo(7.5,20.4),qq(s,8,20.4),qq(s,8,18.32),qq(s,7.5,18.32);const i=new TZ.Shape;i.moveTo(8,8.54),qq(i,7.5,8.54),qq(i,7.5,6.46),qq(i,8,6.46);const c=new TZ.Shape;c.moveTo(3.969,30.5),qq(c,1.969,30.5),qq(c,1.969,30),qq(c,3.969,30);const d=new TZ.Shape;d.moveTo(8,26.278),qq(d,7.5,26.278),qq(d,7.5,24.278),qq(d,8,24.278);const l=new TZ.Shape;l.moveTo(8,14.43),qq(l,7.5,14.43),qq(l,7.5,12.43),qq(l,8,12.43);const T=new TZ.Shape;T.moveTo(13.328,9.621),qq(T,12.621,10.328),qq(T,11.914,9.621),qq(T,12.621,8.914);const u=new TZ.Shape;u.moveTo(8.379,4.672),qq(u,9.086,5.379),qq(u,8.379,6.086),qq(u,7.672,5.379);const m=new TZ.Shape;m.moveTo(7,8),qq(m,7,7),qq(m,8,7),qq(m,8,8);const p=new TZ.Shape;p.moveTo(11,10),qq(p,11,11),qq(p,10,11),qq(p,10,10);const q=new TZ.Shape;q.moveTo(14,7),qq(q,14,8),qq(q,13,8),qq(q,13,7);const w=new TZ.Shape;w.moveTo(12.621,4.672),qq(w,13.328,5.379),qq(w,12.621,6.086),qq(w,11.914,5.379);const h=new TZ.Shape;h.moveTo(7.672,9.621),qq(h,8.379,8.914),qq(h,9.086,9.621),qq(h,8.379,10.328);const Z=new TZ.Shape;Z.moveTo(10,4),qq(Z,11,4),qq(Z,11,5),qq(Z,10,5);const x={depth:4,bevelEnabled:!1},f={depth:1.2,bevelEnabled:!1},y=new TZ.ExtrudeGeometry(e,x),M=new TZ.ExtrudeGeometry(t,x),g=new TZ.ExtrudeGeometry(n,x),S=new TZ.ExtrudeGeometry(o,x),v=new TZ.ExtrudeGeometry(r,x),b=new TZ.ExtrudeGeometry(a,x),G=new TZ.ExtrudeGeometry(s,x),P=new TZ.ExtrudeGeometry(i,x),E=b.clone();E.scale.z=-1;const R=G.clone();R.scale.z=-1;P.clone();R.scale.z=-1;const I=new TZ.ExtrudeGeometry(c,f),k=new TZ.ExtrudeGeometry(d,f),z=new TZ.ExtrudeGeometry(l,f),A=new TZ.ExtrudeGeometry(T,f),V=new TZ.ExtrudeGeometry(u,f),B=new TZ.ExtrudeGeometry(m,f),N=new TZ.ExtrudeGeometry(p,f),C=new TZ.ExtrudeGeometry(q,f),L=new TZ.ExtrudeGeometry(w,f),O=new TZ.ExtrudeGeometry(h,f),D=new TZ.ExtrudeGeometry(Z,f),_=new TZ.MeshStandardMaterial({color:castleColVal}),H=new TZ.Group,F=new TZ.Mesh(y,_),j=new TZ.Mesh(M,_),X=new TZ.Mesh(g,_),W=new TZ.Mesh(S,_),Y=new TZ.Mesh(v,_),$=new TZ.Mesh(b,_);$.userData.type="Door";const Q=new TZ.Mesh(G,_);Q.userData.type="Door";const K=new TZ.Mesh(P,_);K.userData.type="Door";const U=new TZ.Mesh(I,_),J=new TZ.Mesh(k,_),ee=new TZ.Mesh(z,_),te=U.clone();te.translateZ(2.8);const ne=J.clone();ne.translateZ(2.8);const oe=ee.clone();oe.translateZ(2.8);const re=new TZ.Mesh(A,_),ae=new TZ.Mesh(V,_),se=new TZ.Mesh(B,_),ie=new TZ.Mesh(N,_),ce=new TZ.Mesh(C,_),de=new TZ.Mesh(L,_),le=new TZ.Mesh(O,_),Te=new TZ.Mesh(D,_),ue=new TZ.Group;ue.add(re,ae,se,ie,ce,de,le,Te),ue.translateZ(4);const me=ue.clone();me.translateY(11.86);const pe=me.clone();pe.translateY(11.86),pe.translateX(-1.45);const qe=new TZ.MeshStandardMaterial({color:5066061}),we=new TZ.Mesh(new TZ.BoxGeometry(.5,4,4),qe);we.rotateY(Math.PI/180*90),we.translateZ(9.5),H.add(j,X,W,Y,$,Q,K,U,J,ee,te,ne,oe),H.add(ue,me,pe),H.rotation.set(Math.PI/180*-90,0,0),castleGroupParent.add(H);const he=H.clone();H.scale.x=-1,castleGroupParent.add(he);const Ze=H.clone();Ze.rotateZ(Math.PI/180*180),castleGroupParent.add(Ze),H.add(F),H.add(we);const xe=he.clone();xe.rotateZ(Math.PI/180*180),castleGroupParent.add(xe),castleGroupParent.traverse((e=>{"Door"==e.userData.type&&(e.material=new TZ.MeshStandardMaterial({color:65535,side:TZ.DoubleSide}),clickable.push(e))})),castleGroupParent.position.set(0,groundLevel,0),castleGroupParent.rotation.set(0,Math.PI/180*180,0),castleGroupParent.castShadow=!0,castleGroupParent.receiveShadow=!0;const fe=createText("üñºÔ∏è",2,"Arial");fe.position.set(0,2,29.9),castleGroupParent.add(fe);const ye=createText("üî•",1,"Arial");ye.position.set(0,.6,-29.9),castleGroupParent.add(ye);const Me=createText("üü™",2,"Arial");Me.position.set(0,.8,-29.95),castleGroupParent.add(Me);const ge=createText("üï∞Ô∏è",1,"Arial");ge.position.set(0,2,-29.9),castleGroupParent.add(ge);const Se=new TZ.Group,ve=makeButtonMesh(1.25,.65,.001,"orange"),be=createText("‚Ä†13‚Ä†",.4,"Times New Roman"),Ge=be.clone();Ge.rotateY(3.14),ve.add(be,Ge),be.position.set(.05,-.025,.1),Ge.position.set(.05,-.025,-.1),Se.add(ve);const Pe=new TZ.Mesh(new TZ.CylinderGeometry(.1,.02,2,32),new TZ.MeshBasicMaterial({color:"Black"}));Pe.position.set(-.58,-.7,0),Se.add(Pe),Se.rotateY(3.14),Se.position.set(-11,10,8),Se.scale.set(3,3,3);const Ee=Se.clone();Ee.translateZ(26),castleGroupParent.add(Se,Ee);const Re=new TZ.Group,Ie=new TZ.Mesh(new TZ.BoxGeometry(1.5,1,2.5),qe),ke=new TZ.Group,ze=createText("üçΩÔ∏è",.5,"Arial"),Ae=createText("üçó",.25,"Arial");Ae.translateZ(-.01);const Ve=createText("üç∑",.5,"Arial");Ve.position.set(.3,.8,-.25),Ve.rotation.set(-1.57,1.57,0),ke.add(ze,Ae,Ve),ke.rotateX(1.57),ke.rotateZ(3.14),ke.position.set(0,.55,.85);const Be=ke.clone();Be.rotateZ(3.14),Be.translateY(-2),Re.add(Ie,ke,Be),Re.position.set(6.7,.4,0),castleGroupParent.add(Re),scene.add(castleGroupParent),castleGroupParent.matrixWorldNeedsUpdate=!1,chapters.one_title=!0}let controllerGrip1,controllerGrip2;function addControllersVR(){scene.add(ctr1),scene.add(ctr2);let e=new TZ.LineBasicMaterial({color:15094391}),t=(new TZ.BufferGeometry).setFromPoints([new TZ.Vector3(0,0,0),new TZ.Vector3(0,0,-1)]),n=new TZ.Line(t,e);n.scale.z=10,ctr1.add(n.clone()),ctr2.add(n.clone()),ctr1.addEventListener("selectstart",onSelectStart),ctr1.addEventListener("selectend",onSelectEnd),ctr1.addEventListener("connected",(function(e){controllerGrip1=renderer.xr.getControllerGrip(0),scene.add(controllerGrip1)})),ctr1.addEventListener("disconnected",(function(){this.remove(this.children[0])})),ctr2.addEventListener("selectstart",onSelectStart),ctr2.addEventListener("selectend",onSelectEnd),ctr2.addEventListener("connected",(function(e){controllerGrip2=renderer.xr.getControllerGrip(1),scene.add(controllerGrip2)})),ctr2.addEventListener("disconnected",(function(){this.remove(this.children[0])}))}function addFloor(){const e=(new TZ.Shape).moveTo(0,1).lineTo(1,1).lineTo(1,0).lineTo(1.5,0).lineTo(1.5,1).lineTo(2.5,1).lineTo(2.5,1.5).lineTo(1.5,1.5).lineTo(1.5,2.5).lineTo(1,2.5).lineTo(1,1.5).lineTo(0,1.5),t=new TZ.ExtrudeGeometry(e,{depth:.01,bevelEnabled:!1});t.center();const n=new TZ.Group;for(let e=0;e<5;e++)for(let o=0;o<20;o++){const r=new TZ.Mesh(t,new TZ.MeshPhongMaterial);r.rotation.set(Math.PI/180*90,Math.PI/180*0,Math.PI/180*45),r.position.set(3*e-6,.1,3*o-28.5),r.name=`Cross${e+1}${o+1}`,r.userData.type="cross",n.add(r),clickable.push(r)}castleGroupParent.add(n)}async function loadShaders(){const e=await fetch("media/sh/sky/vert.glsl"),t=await e.text(),n=await fetch("media/sh/sky/frag.glsl"),o=await n.text(),r=new TZ.ShaderMaterial({vertexShader:t,fragmentShader:o,side:2,transparent:!0});skyShaderArr.push(r);removeFadeOut(document.querySelector(".blackout"),3e3)}function addSky(){const e=new TZ.CylinderGeometry(60,60,20,32,1,!0),t=new TZ.Mesh(e,skyShaderArr[0]);t.position.set(0,5,0),scene.add(t)}let zzfxV=.3;const zzfx=(e=1,t=.05,n=220,o=0,r=0,a=.1,s=0,i=1,c=0,d=0,l=0,T=0,u=0,m=0,p=0,q=0,w=0,h=1,Z=0,x=0,f=Math,y=44100,M=2*f.PI,g=(c*=500*M/y/y),S=(n*=(1-t+2*t*f.random(t=[]))*M/y),v=0,b=0,G=0,P=1,E=0,R=0,I=0,k,z)=>{for(d*=500*M/y**3,p*=M/y,l*=M/y,T*=y,u=y*u|0,z=(o=y*o+9)+(Z*=y)+(r*=y)+(a*=y)+(w*=y)|0;G<z;t[G++]=I)++R%(100*q|0)||(I=s?1<s?2<s?3<s?f.sin((v%M)**3):f.max(f.min(f.tan(v),1),-1):1-(2*v/M%2+2)%2:1-4*f.abs(f.round(v/M)-v/M):f.sin(v),I=(u?1-x+x*f.sin(M*G/u):1)*(0<I?1:-1)*f.abs(I)**i*zzfxV*e*(G<o?G/o:G<o+Z?1-(G-o)/Z*(1-h):G<o+Z+r?h:G<z-w?(z-G-w)/a*h:0),I=w?I/2+(w>G?0:(G<z-w?1:(z-G)/w)*t[G-w|0]/2):I),v+=(k=(n+=c+=d)*f.cos(p*b++))-k*m*(1-1e9*(f.sin(G)+1)%2),P&&++P>T&&(n+=l,S+=l,P=0),!u||++E%u||(n=S,c=g,P||=1);return(e=zzfxX.createBuffer(1,z,y)).getChannelData(0).set(t),(n=zzfxX.createBufferSource()).buffer=e,n.connect(zzfxX.destination),n.start(),n},zzfxX=new AudioContext;function getClicked(e){if(0!=e.length&&e.length>0){switch(e[0].object.userData.type){case"enterVR":startSession("immersive-vr"),addControllersVR(),removeOb("VR OK Button",camera),addEx();const t=createText("üì¢",.25,"Arial",!0);t.position.set(.75,0,-1.5),t.userData.type="Clue",t.name="clue",camera.add(t);break;case"cross":if(null!==renderer.xr.getSession()){zzfx(...[1.01,,629,.05,.17,.41,1,1.83,,.2,148,.16,.19,,,.5,.01,.82,.28,.47]),dummyOb.position.set(camera.position.x,camera.position.y,camera.position.z),chapters.three_setRef=!0;const t=new TZ.Vector3(e[0].point.x,0,e[0].point.z);newSpotArr.push(t),slp(1e3).then((()=>{chapters.three_setRef=!1,newSpotArr.length=0}))}break;case"Clue":null!==renderer.xr.getSession()&&(s_MarcoArr[0].play(),slp(2500).then((()=>{s_PoloArr[0].play()})));break;case"Door":if(zzfx(...[,,471,,.09,.47,4,1.06,-6.7,,,,,.9,61,.1,,.82,.09,.13]),null!==renderer.xr.getSession()){let t=e[0].object,n=(new TZ.Box3).setFromObject(t);if(1==n.intersectsBox(dungeonArr[0])){zzfx(...[,,662,.82,.11,.33,1,0,,-.2,,,,1.2,,.26,.01]);const e=createText("üßü",.25);e.position.set(0,0,-.75),e.userData.type="Zombie",camera.add(e),slp(250).then((()=>{e.translateZ(.05),slp(250).then((()=>{e.translateZ(.05),slp(250).then((()=>{e.translateZ(.05),slp(250).then((()=>{e.translateZ(.05),slp(250).then((()=>{e.translateZ(.05)}))}))}))}))})),gameOver()}1==n.intersectsBox(poloArr[0])&&(camera.add(poloArr[1]),poloArr[1].translateZ(-1.5),zzfx(...[,,80,.3,.4,.7,2,.1,-.73,3.42,-430,.09,.17,,,,.19]),gameOver()),t.parent.remove(t)}break;case"Exit":location.reload();break;default:console.log("switch default")}}}function gameOver(){clickable.length=0;let e=sgobn("exit");camera.remove(e);let t=sgobn("clue");camera.remove(t),slp(1e3).then((()=>{addEx()}))}function addEx(){const e=createText("‚Üª",.25,"Arial",!0);e.position.set(-.7,0,-1.5),e.userData.type="Exit",e.name="exit",camera.add(e);const t=createText("reload",.05,"Times New Roman ");t.position.clone(e),t.translateY(-.15),e.add(t)}function createText(e,t,n,o=!1){const r=document.createElement("canvas"),a=r.getContext("2d");let s=null;const i=100;a.font="normal 100px "+n,s=a.measureText(e);const c=s.width;r.width=c,r.height=i,r.border="10px solid blue",a.font="normal 75px "+n,a.textAlign="center",a.textBaseline="middle",a.fillText(e,c/2,50);const d=new TZ.Texture(r);d.needsUpdate=!0;const l=new TZ.MeshStandardMaterial({side:TZ.DoubleSide,map:d,transparent:!0}),T=new TZ.PlaneGeometry(t*c/i,t),u=new TZ.Mesh(T,l);return 1==o&&clickable.push(u),u}function makeButtonMesh(e,t,n,o){const r=new TZ.BoxGeometry(e,t,n),a=new TZ.MeshStandardMaterial({color:o});return new TZ.Mesh(r,a)}function removeOb(e,t){let n=sgobn(e);t.remove(n)}function sgobn(e){return scene.getObjectByName(e)}function slp(e){return new Promise((t=>setTimeout(t,e)))}function addMarkers(){const e=new TZ.BoxGeometry(.2,.2,.2),t=new TZ.MeshPhongMaterial,n=new TZ.Mesh(e,t);n.position.set(0,0,0),scene.add(n);const o=n.clone();o.position.set(0,1,0),scene.add(o);const r=n.clone();r.position.set(0,2,0),scene.add(r);const a=new TZ.SphereGeometry(.035,32,16),s=new TZ.MeshPhongMaterial({color:"blue"}),i=new TZ.Mesh(a,s);scene.add(i);const c=new TZ.ConeGeometry(.1,.3,16),d=new TZ.MeshPhongMaterial({color:"pink"}),l=new TZ.Mesh(c,d);l.rotation.set(Math.PI/180*90,Math.PI/180*0,Math.PI/180*0),l.translateY(-.15),scene.add(l)}function addVRFloor(){const e=new TZ.CylinderGeometry(8.5,8.5,.02,32);const t=[undefined,undefined,undefined,undefined,undefined,undefined,undefined],n=new TZ.Group;let o=new TZ.Color;new TZ.Color(11573187).getHSL(o);const r=360*o.h/1,a=100*o.s;let s=100*o.l;s-=20;const i=20/t.length;for(let o=0;o<t.length;o++){s+=i;const c=new TZ.Color(`hsl(${r}, ${a}%, ${s}%)`);t[o]=new TZ.MeshBasicMaterial({color:c});const d=new TZ.Mesh(e,t[o]);d.position.set(0,-.1*o,0),d.scale.set(o+1,o+1,o+1),n.add(d)}castleGroupParent.add(n)}const raycasterXR=new TZ.Raycaster,tempMatrix=new TZ.Matrix4;let INT2;function intersectObjects(e){if(void 0!==e.userData.selected)return;const t=getIntersections(e);0!=t.length&&(INT2!=t[0].object?(INT2&&INT2.material.emissive.setHex(INT2.currentHex),INT2=t[0].object,INT2.currentHex=INT2.material.emissive.getHex(),INT2.material.emissive.setHex(16711680)):(INT2&&INT2.material.emissive.setHex(INT2.currentHex),INT2=null))}function getIntersections(e){return e.updateMatrixWorld(),tempMatrix.identity().extractRotation(e.matrixWorld),raycasterXR.ray.origin.setFromMatrixPosition(e.matrixWorld),raycasterXR.ray.direction.set(0,0,-1).applyMatrix4(tempMatrix),raycasterXR.intersectObjects(clickable)}function onSelectStart(e){const t=getIntersections(e.target);if(t.length>0){t[0].object;getClicked(t)}}function onSelectEnd(e){}const pointer=new TZ.Vector2(1,1),raycaster_Pointer=new TZ.Raycaster;let INT;function onPointerMove(e){e.preventDefault(),pointer.x=e.clientX/window.innerWidth*2-1,pointer.y=-e.clientY/window.innerHeight*2+1,raycaster_Pointer.setFromCamera(pointer,camera);const t=raycaster_Pointer.intersectObjects(clickable);t.length>0?INT!=t[0].object&&(INT&&INT.material.emissive.setHex(INT.currentHex),INT=t[0].object,INT.currentHex=INT.material.emissive.getHex(),"enterVR"==INT.userData.type&&INT.material.emissive.setHex(16711680)):(INT&&INT.material.emissive.setHex(INT.currentHex),INT=null)}function onPointerClick(e){e.preventDefault(),pointer.x=e.clientX/window.innerWidth*2-1,pointer.y=-e.clientY/window.innerHeight*2+1,raycaster_Pointer.setFromCamera(pointer,camera);getClicked(raycaster_Pointer.intersectObjects(scene.children))}async function XRSuppQry(){if("xr"in navigator){const e=await navigator.xr.isSessionSupported("immersive-vr");if(e){const e=createText("Enter VR",.25,"Times New Roman",!0);e.userData.type="enterVR",e.position.set(0,0,zVal),e.name="VR OK Button",e.userData.type="enterVR",clickable.push(e),camera.add(e),slp(5e3).then((()=>{chapters.two_start=!1,addAudio()}))}if(!e){const e=createText("VR Not Found :(",.2,"Times New Roman");e.position.set(0,.25,.01),e.position.set(0,0,zVal);const t=makeButtonMesh(1.5,.3,.01,12272462,!1);e.add(t),t.translateZ(-.01),camera.add(e)}}}async function startSession(e){try{onSessionStarted(await navigator.xr.requestSession(e,{optionalFeatures:["hand-tracking"]}))}catch(e){alert("Failed to start Web XR session.",e)}}async function onSessionStarted(e){console.log("onSeesion started"),e.addEventListener("end",onSessionEnded),renderer.xr.setReferenceSpaceType("local"),await renderer.xr.setSession(e)}function onSessionEnded(){console.log("xr End")}import*as TZ from"three";const skyShaderArr=[],txLoader=new TZ.TextureLoader;loadShaders();const clickable=[],chapters={one_title:!1,two_start:!1,three_setRef:!1},newSpotArr=[],castleGroupParent=new TZ.Group,backgroundColVal=13879779,castleColVal=8553953,zVal=-1.5,groundLevel=-2,s_MarcoArr=[],s_PoloArr=[],poloArr=[],dungeonArr=[],scene=new TZ.Scene;scene.background=new TZ.Color(13879779);const dummyOb=new TZ.Mesh(new TZ.BoxGeometry(.1,.1,.1),new TZ.MeshNormalMaterial);dummyOb.position.set(0,0,0),dummyOb.visible=!1,scene.add(dummyOb);const clock=new TZ.Clock,camera=new TZ.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.01,500);camera.position.set(-20,20,45),camera.lookAt(0,0,zVal),scene.add(camera);const light=new TZ.AmbientLight(4210752,12);scene.add(light);const dirLight=new TZ.DirectionalLight(16777215,1.2);dirLight.position.set(0,2,1),scene.add(dirLight);const renderer=new TZ.WebGLRenderer({antialias:!0});renderer.setPixelRatio(Math.max(window.devicePixelRatio,1.5)),renderer.setSize(window.innerWidth,window.innerHeight),renderer.xr.enabled=!0,document.body.appendChild(renderer.domElement);const ctr1=renderer.xr.getController(0),ctr2=renderer.xr.getController(1);window.addEventListener("resize",onWindowResize),document.addEventListener("click",onPointerClick),document.addEventListener("mousemove",onPointerMove);const baseReferenceSpaceArr=[];renderer.xr.addEventListener("sessionstart",xrSessionStarted),renderer.xr.addEventListener("sessionend",xrSessionEnded);const startButton=document.getElementById("startButton");startButton.addEventListener("click",startFunction);const titleText=createText("Marco...?",.4,"Times New Roman");function removeFadeOut(e,t){var n=t/1e3;e.style.transition="opacity "+n+"s ease",e.style.opacity=0,setTimeout((function(){e.remove()}),t)}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function startFunction(){console.log("start game here"),slp(250).then((()=>{document.getElementById("info").remove(),document.getElementById("info2").remove(),removeOb("Title",camera),chapters.one_title=!1,chapters.two_start=!0,slp(7500).then((()=>{XRSuppQry()}))}))}let baseReferenceSpace;function xrSessionStarted(e){console.log("XR sess start"),baseReferenceSpace=renderer.xr.getReferenceSpace(),addVRFloor()}function xrSessionEnded(e){console.log("XR sess end")}function animate(){renderer.setAnimationLoop(render)}titleText.position.set(0,.75,zVal),titleText.name="Title",camera.add(titleText),addVRFloor(),slp(1e3).then((()=>{addCastle(),addFloor(),addSky()})),animate();let alpha=0;function render(e,t){const n=clock.getDelta();clock.getElapsedTime();let o=renderer.xr.getSession();if(null!==o&&(intersectObjects(ctr1),o.inputSources.length>1&&intersectObjects(ctr2)),!0===chapters.one_title&&(castleGroupParent.rotation.y+=.1*n),1==chapters.two_start&&(alpha+=n,camera.position.lerp(new TZ.Vector3(0,0,0),.005*alpha)),1==chapters.three_setRef){alpha+=n,dummyOb.position.lerp(newSpotArr[0],.001*alpha);const e={x:-dummyOb.position.x,y:-dummyOb.position.y,z:-dummyOb.position.z,w:1},t=new TZ.Quaternion,o=new XRRigidTransform(e,t),r=baseReferenceSpace.getOffsetReferenceSpace(o);renderer.xr.setReferenceSpace(r)}renderer.render(scene,camera)}