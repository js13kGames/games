<title>The Terror of Mongolia - js13kGames 2023</title><style>body{color:silver}canvas{margin:auto;box-shadow:inset 0 0 20px 10px #000;transition:opacity 8s,background-color .5s}h3{color:"#f77";transition:opacity 8s}.gameview{width:100%;display:flex;flex-direction:column;align-items:center}</style><div class=gameview><h3>The Terror of Mongolia</h3><canvas style=opacity:0></canvas></div><script>function q1(t){const n=t.pop(),o=[];for(let e=0;e<n;e++){const n=t.pop()+(t.pop()<<4);o.push(String.fromCharCode(n))}return o.join("")}function t(){function q(e){return Math.sin(6.283184*e)}function H(e){return.003959503758*2**((e-128)/12)}var R,j,B,D,W,Y=[q,function(e){return e%1<.5?1:-1},function(e){return e%1*2-1},function(e){return(e=e%1*4)<2?e-1:3-e}];this.init=function(e){j=(R=e).endPattern,B=0,D=e.rowLen*e.patternLen*(j+1)*2,W=new Int32Array(D)},this.generate=function(){for(var e,t,n,o,r,i,a,s=new Int32Array(D),l=R.songData[B],A=R.rowLen,d=R.patternLen,h=0,c=0,f=!1,u=[],p=0;p<=j;++p)for(n=l.p[p],e=0;e<d;++e){for(var y=n?l.c[n-1].f[e]:0,m=(y&&(l.i[y-1]=l.c[n-1].f[e+d]||0,y<17)&&(u=[]),Y[l.i[16]]),g=l.i[17]/512,x=2**(l.i[18]-9)/A,v=l.i[19],b=l.i[20],w=43.23529*l.i[21]*3.141592/44100,M=1-l.i[22]/255,k=1e-5*l.i[23],S=l.i[24]/32,C=l.i[25]/512,$=6.283184*2**(l.i[26]-9)/A,T=l.i[27]/255,E=l.i[28]*A&-2,L=(p*d+e)*A,O=0;O<4;++O)if(t=n?l.c[n-1].n[e+O*d]:0){u[t]||(u[t]=function(e,t){for(var n,o,r,i,a=Y[e.i[0]],s=e.i[1],l=e.i[3]/32,d=Y[e.i[4]],h=e.i[5],c=e.i[8]/32,f=e.i[9],u=e.i[10]*e.i[10]*4,p=e.i[11]*e.i[11]*4,y=e.i[12]*e.i[12]*4,m=1/y,g=-e.i[13]/16,x=e.i[14],v=A*2**(2-e.i[15]),b=new Int32Array(u+p+y),w=0,M=0,k=0,S=0;k<u+p+y;k++,S++)0<=S&&(S-=v,r=H(t+(15&(x=x>>8|(255&x)<<4))+e.i[2]-128),i=H(t+(15&x)+e.i[6]-128)*(1+8e-4*e.i[7])),n=1,k<u?n=k/u:u+p<=k&&(n=(1-(n=(k-u-p)*m))*3**(g*n)),o=a(w+=r*n**l)*s,o+=d(M+=i*n**c)*h,f&&(o+=(2*Math.random()-1)*f),b[k]=80*o*n|0;return b}(l,t));for(var P=u[t],I=0,F=2*L;I<P.length;I++,F+=2)s[F]+=P[I]}for(I=0;I<A;I++)(r=s[o=2*(L+I)])||f?(i=w,v&&(i*=m(x*o)*g+.5),c+=(i=1.5*Math.sin(i))*(i=M*(r-c)-(h+=i*c)),r=3==b?c:1==b?i:h,k&&(r=(r*=k)<1?-1<r?q(.25*r):-1:1,r/=k),f=1e-5<(r*=S)*r,a=r*(1-(i=Math.sin($*o)*C+.5)),r*=i):a=0,E<=o&&(a+=s[o-E+1]*T,r+=s[o-E]*T),s[o]=0|a,s[1+o]=0|r,W[o]+=0|a,W[1+o]+=0|r}return++B/R.numChannels},this.createWave=function(){var e=44+2*D-8,t=e-36,n=new Uint8Array(44+2*D);n.set([82,73,70,70,255&e,e>>8&255,e>>16&255,e>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&t,t>>8&255,t>>16&255,t>>24&255]);for(var o=0,r=44;o<D;++o){var i=W[o];n[r++]=255&(i=i<-32767?-32767:32767<i?32767:i),n[r++]=i>>8&255}return n}}var H1={songData:[{i:[3,194,128,0,2,198,128,6,0,0,12,12,33,0,0,0,0,61,4,1,2,109,86,7,32,112,3,67,2],p:[1,1,2,3,4,5,1,2,3,4,5,5,1,1,7,8,9],c:[{n:[132,,135,132,,135,134,132,132,,135,132,,135,134,132,132,,135,132,,135,134,132,132,,135,132,,135,134,132],f:[]},{n:[132,,135,132,,135,134,132,132,,135,132,,135,134,132,130,,134,130,,134,132,130,130,,134,130,,134,132,130],f:[]},{n:[132,,135,132,,135,134,132,132,,135,132,,135,134,132,127,,130,127,,130,129,127,127,,130,127,,130,129,127],f:[]},{n:[125,,128,125,,128,127,125,125,,128,125,,128,127,125,122,,125,122,,125,123,122,123,,127,123,,127,125,123],f:[]},{n:[125,,123,122,,125,123,122,125,,123,122,,125,123,122,118,,115,118,,122,120,122,118,,115,118,,122,120,118],f:[]},{n:[],f:[]},{n:[135,,139,135,,139,137,135,135,,139,135,,139,137,135,135,,139,135,,139,137,135,135,,137,135,,135,134,132],f:[]},{n:[128,,132,128,,132,130,128,128,,132,128,,132,130,128,128,,132,128,,132,130,128,130,,134,130,,134,132,130],f:[]},{n:[130,,134,130,,134,132,130,130,,134,130,,134,132,130,130,,134,130,,134,132,130,130,,134,130,,134,132,130],f:[]}]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[,,2,3,4,5,,2,3,4,5,,,6,7,8,9],c:[{n:[],f:[]},{n:[139,,,144,,,146,,147,,,146,,,144,,142,,,144,,,146,,139],f:[]},{n:[139,,,144,,,146,,147,,,146,,,147,,149,,,147,,,149,,151,,,,,,151],f:[]},{n:[152,,,154,,,151,,149,,,151,,,147,,146,,,142,,,146,,147],f:[]},{n:[149,,,146,,,149,,147,,,144,,,147,,146,,,142,,,144,,144],f:[]},{n:[,,,,139,,,,144,,139,,147,,,,144,,,,147,,144,,151,,,,147],f:[]},{n:[151,,147,,154,,,,142,,,,147,,142,,151,,,,,,142,,144,,140,,147],f:[]},{n:[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,142,,144,,140,,147,,,,,,142,,144,,140,,149,,,,142,,,,147,,142],f:[]},{n:[151],f:[]}]},{i:[2,29,116,0,2,138,128,4,0,0,47,48,162,63,124,3,0,139,4,1,3,64,160,3,32,147,4,121,5],p:[,,2,3,4,5,,2,3,4,5,5,1,1,7,8,9],c:[{n:[132,,,,,,,,,,,,,,,,132],f:[]},{n:[132,,,,,,,,,,,,,,,,130],f:[]},{n:[132,,,,,,,,,,,,,,,,135],f:[]},{n:[140,,,,,,,,,,,,,,,,137],f:[]},{n:[134,,,,,,,,,,,,,,,,132],f:[]},{n:[],f:[]},{n:[135,,,,,,,,,,,,,,,,135],f:[]},{n:[135,,,,,,,,,,,,,,,,135],f:[]},{n:[134,,,,,,,,,,,,,,,,130],f:[]}]},{i:[0,255,117,64,0,255,110,0,64,0,4,6,35,0,0,0,0,0,0,0,2,14,0,1,39,76,5,0,0],p:[,1,1,1,1,1,1,1,1,1,1,,1,1,1,1,1],c:[{n:[135,,,,144,,,,135,,,,144,,,,135,,,,144,,,,135,,,,144,,144],f:[]}]},{i:[0,89,152,0,0,255,152,12,0,0,2,0,60,0,0,0,0,0,0,0,2,255,0,0,32,47,3,157,2],p:[,,,,,,,2,3,4,,5],c:[{n:[],f:[]},{n:[,,,,,,,,135,,,,,,,,134,,,,,,,,132,,,,130],f:[]},{n:[127,,,,,,,,,,,,135,,,,134,,,,132,,,,130],f:[]},{n:[132],f:[]},{n:[137,,,134,,,137,,135,,,132,,,135,,134,,,130,,,132,,132],f:[]}]}],rowLen:5513,patternLen:32,endPattern:16,numChannels:5},R1={songData:[{i:[2,24,128,0,3,27,128,0,0,0,0,6,29,0,0,0,0,195,4,1,3,50,184,119,244,147,6,84,6],p:[1,1,4,5,6,3,4,5,6,2,1,1,1,3,1,3],c:[{n:[132,,135,134,,135,134,132,132,,135,134,,135,134,132,132,,135,134,,135,134,132,132,,135,134,,135,134,132],f:[]},{n:[140,,135,140,,139,137,135,140,,135,140,,139,137,135,132,,135,134,,135,134,132,132,,135,134,,135,134,132],f:[]},{n:[140,,139,140,,139,137,135,140,,139,140,,139,137,135,134,,130,134,,132,127,127,134,,127,134,,132,130,127],f:[]},{n:[132,,135,134,,135,134,132,132,,135,134,,135,134,132,127,,130,129,,130,129,127,127,,130,130,,130,129,127],f:[]},{n:[132,,135,134,,135,134,132,132,,135,134,,135,134,132,137,,135,137,,140,139,137,137,,135,137,,140,139,137],f:[]},{n:[135,,139,137,,139,137,135,135,,139,137,,139,137,135,140,,135,140,,139,137,135,140,,135,140,,139,137,135],f:[]}]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[,,2,3,6,7,2,3,6,1,,4,5,8,9,10],c:[{n:[140,,139,,137,,135,,134,,,,,,132,,132],f:[]},{n:[132,134,135,134,132,,,,,,,,134,,,,130,,,,127],f:[]},{n:[132,134,135,134,132,,,,,,134,,,,135,,137],f:[]},{n:[,,,,,,,,,,,,,,,,132,,,,,,,,135],f:[]},{n:[139,,,,,,,,137,,,,,,,,135,,,,,,,,137],f:[]},{n:[135,137,139,137,135,,,,,,137,,,,139,,140,,,,135,,,,,,,,135],f:[]},{n:[140,,139,,137,,135,,137,,,,,,132,,134],f:[]},{n:[,,,,,,,,,,,,,,,,132,,,,,,,,135],f:[]},{n:[142,,,,,,,,140,,,,,,,,135,,,,,,,,137],f:[]},{n:[139],f:[]}]},{i:[1,192,128,0,1,191,116,9,0,0,6,22,34,0,0,0,0,69,3,1,1,23,167,0,32,77,6,25,6],p:[,,1,2,3,4,1,2,3,5,1,1,2,3,1,4],c:[{n:[120,,,,120,,,,120,,,,120,,,,115,,,,115,,,,115,,,,115],f:[]},{n:[120,,,,120,,,,120,,,,120,,,,125,,,,125,,,,125,,,,125],f:[]},{n:[123,,,,123,,,,123,,,,123,,,,128,,,,128,,,,123,,,,123],f:[]},{n:[128,,,,123,,,,125,,,,123,,,,122,,,,115,,,,122,,,,115],f:[]},{n:[128,,,,123,,,,122,,,,115,,,,120,,,,120,,,,120,,,,120],f:[]}]},{i:[0,160,128,64,0,160,128,0,64,210,4,7,52,85,0,0,0,60,4,1,2,255,0,0,32,61,5,32,6],p:[,1,2,2,2,1,2,2,2,1,2,2,2,2,2,1],c:[{n:[118,,,,118,,,,118,,,,118,,,,118,,,,118,,,,118,,,,118,118,118,,,,,,,,119,,,,,,,,119,,,,,,,,119,,,,119],f:[]},{n:[111,,,,132,,,,111,,,,132,,,,111,,,,132,,,,111,,,,132,,132],f:[]}]},{i:[2,138,116,0,2,138,128,4,0,0,47,48,162,63,124,3,0,139,4,1,3,64,160,3,32,147,4,121,5],p:[,,,,,,1,2,3,4,5,6],c:[{n:[120,,,,,,,,120,,,,,,,,115,,,,,,,,115],f:[]},{n:[120,,,,,,,,120,,,,,,,,125,,,,,,,,125],f:[]},{n:[123,,,,,,,,123,,,,,,,,128,,,,,,,,123],f:[]},{n:[125,,,,,,,,,,,,,,,,132,,,,,,,,132,,,,,,134],f:[]},{n:[119,,,,,,,,,,,,,,,,120,,,,,,,,120,,,,,,122],f:[]},{n:[119,,,,,,,,,,,,,,,,120],f:[]}]}],rowLen:4725,patternLen:32,endPattern:15,numChannels:5};class j1{constructor(e){this.player=new t,this.player.init(e),this.prepare(),this.playing=!1}prepare(){const t=setInterval(()=>{var e;1<=this.player.generate()&&(clearInterval(t),e=this.player.createWave(),this.audio=document.createElement("audio"),this.audio.src=URL.createObjectURL(new Blob([e],{type:"audio/wav"})),this.audio.loop=!0)},0)}play(){this.audio?.play(),this.playing=!0}pause(){this.audio?.pause()}resume(){this.playing&&this.play()}stop(){this.audio&&(this.pause(),this.audio.currentTime=0)}}let B1=document.querySelector.bind(document);dadd=document.addEventListener;const D1=Math.random,W1=(e,t)=>Math.sqrt(e*e+t*t);dadd("DOMContentLoaded",()=>{B1("body").style.backgroundColor="#100",setTimeout(()=>{let b,e=B1("canvas"),w=e.getContext("2d"),c=e.style,M=e.width=2e3,k=(c.width=M/2+"px",e.height=1200);c.height=k/2+"px",c.border="1px solid black",c.backgroundColor="#efd",setTimeout(()=>c.opacity=1,1e3);const h=200,r={};function R(){var e=F;return u?o=m:o+=m-F.enteredHut,P.x=e.x,P.y=e.y+200,P.dx=0,P.dy=0,(e=q(F)).closed=!0,e.onFire=!0,F=null,u=!1,l1?.(),l1=null,$(),s.style.display="none",n(""),a.play(),!0}dadd("keyup",e=>{delete r[e.code]}),dadd("mousemove",()=>{c.cursor=""}),dadd("keydown",o=>{if(r[o.code]=!0,c.cursor="none",""===s.style.display){let e=v1,t=!1,n=!A.bow;if((r.KeyW||r.ArrowUp)&&(d=Math.max(0,d-1)),(r.KeyS||r.ArrowDown)&&(d=Math.min(e.length-(n?1:0),d+1)),r.Space)if(d===e.length)t=R();else if(!l[d]){const o=v1[d];o&&(l[d]=!0,C-=o.cost[0]*h,$(),o?.buy(o),n)&&(t=R())}delete r[o.code],t||b1(!0)}o.preventDefault()});const j=[],S=[0,0];let u=!0,a=new j1(H1);const B=new j1(R1);let D,o=0;function t(e){A[e.name]++,e.cost.shift()}function W(e,t){return new Array(t).fill(e).join("")}const Y=[D={name:"bow",title:"bow and arrows",description:"(Recommended) Press Space to shoot down enemies and collect üèµÔ∏è",cost:[0],buy:t},{name:"speed",title:"speed",description:()=>`Change hoof for faster horse (${W("‚≠ê",A.speed+1)})`,cost:[0,2,3],buy:t},{name:"speedWhileShooting",title:"stable aim",description:"Stabilize bow to shoot without slow down the horse",cost:[2],req:"bow",buy:t},{name:"maxHealth",title:"max health",description:"Eat foot to increases the maximum health by one ‚ù§Ô∏è",cost:[2,3,4],buy:e=>{t(e),p=Math.min(i+2*A.maxHealth,p+2)}},{name:"shield",title:"shield",description:()=>`This shield blocks one hit. Re-usable after ${20/(A.shield+1)}s`,cost:[1.5,3],buy:t},{name:"quickShot",title:"quickshot",description:"Learn skill. Shoot immediately after one hit",cost:[2],req:"bow",buy:t},{name:"money",title:"pillage",description:()=>`Earn knowledge of finding loot. Each kill provides more üèµÔ∏è (x${2+A.money})`,cost:[1,2,3],req:"bow",buy:t},{name:"rickoShot",title:"rickoshot",description:()=>`Learn skill. Arrow aimed properly has +${30*(A.rickoShot+1)}% chance to rickochet after hitting.`,cost:[1,2,3],req:"bow",buy:t},{name:"giantPiercing",title:"giant piercing",description:()=>`Sharpened arrows increases chance of killing a giant to ${5+20*(A.giantPiercing+1)}%`,cost:[1,2,3],req:"bow",buy:t},{name:"treeNav",title:"forest navigation",description:()=>`A compass to help navigate in the forest (${W("‚≠ê",A.treeNav+1)})`,cost:[1,2,3],buy:t},{name:"control",title:"horse control",description:()=>`Improved saddle for better control (${W("‚≠ê",A.control+1)})`,cost:[1,2,3],buy:t},{name:"time",title:"extra time",description:"In exchange of üèµÔ∏è, I will delay the boat (+15s)",cost:[.5,1,2,4,6,8,10],buy:()=>{o+=15e3,$(),n("This will give you a bit more time.")}},{name:"health",title:"rejuvinate",description:"Drink kumis, restore ‚ù§Ô∏è to max",cost:[1,2,4,6,8,10],buy:()=>{p=i+2*A.maxHealth,$()}},{name:"gamble",title:"gamble",description:e=>"Play a game of Shagai. (30% chance to double your üèµÔ∏è)",cost:[.5,1,2,3,4,5],buy:()=>{D1()<=.35?(C=2*(C+h),$(),n("Lucky!")):n("You lost, my friend")}}];let A={...Object.fromEntries(Y.map(e=>[e.name,0])),borte:0};function n(e){Q.style.display=e.length?"":"none",Q.innerText=e}const K="B√∂rte is in another hut.",U=()=>{v+=10,f+=.25,n(K)},N=[()=>{},()=>{v=20,n("Spare my life, Khan! I'll help you find B√∂rte.\nYou should hurry! Jamukha plans to send her away on a boat.\nTake one item, then follow the sign.")},()=>{v=40,f+=.1,n(K)},U,U,U,()=>{v=100,f+=.3;const e=a;return S1(),n("B√∂rte is found, alive and well.\nB√∂rte: \"Took you long enough! Jamukha escaped. Let's go after him, I'll ride with you.\""),()=>e.stop()},()=>{X=!0,n(`Level ${C1}\n\nB√∂rte found Jamukha and took her revenge.\n\nCongratulations! You beat the game. Feel free keep going, see how far you go.`),v=Math.min(v+50,400),f+=.3}];let f=.7,X=!1;const i=6;let p=i,J=300,G=0,C=0;const _=document.body.appendChild(document.createElement("div")),z=_.style;z.position="absolute",z.top=e.offsetTop+25,z.left=e.offsetLeft+20,z.color="#880";let V=()=>G||Math.max(F?F.enteredHut:y||m);function $(){let t=i+2*A.maxHealth,n="";for(let e=0;e<Math.floor(p/2);e++)n+="‚ù§Ô∏è";p%2&&(n+="‚ù§Ô∏è‚Äçü©π");for(let e=Math.ceil(p/2);e<t/2;e++)n+="ü©∂";var e=Math.max(0,J-Math.floor((V()-o)/1e3));_.innerText=u?"":`Level ${C1}\n${n}\nüèµÔ∏è ${C}\n${e?"‚è≥":"‚åõ"} ${Math.floor(e/60)}:`+(100+e%60).toString().substring(1),p&&e<=0&&(p=0,p1())}setInterval($,1e3);const Q=document.body.appendChild(document.createElement("div")),Z=Q.style;Z.position="absolute",Z.top=e.offsetTop+50,Z.left=e.offsetLeft+150,n("");let e1,y=0;function t1(n,o,r,i,e,a,s,t,l,d){const h=i/1600,c=e/1e3;n.fillStyle=t??"black",e1.shapes.forEach(e=>{if(!e.hidden&&e.anim===s){var t=e.lines[a%e.lines.length];if(t){n.beginPath(),n1(n,o,r,t[0]*h,t[1]*c,!1,i,0,l,d);for(let e=2;e<t.length;e+=2)n1(n,o,r,t[e]*h,t[e+1]*c,!0,i,0,l,d);n.closePath()}n.fill()}})}function n1(e,t,n,o,r,i,a,s,l,d){i?e.lineTo(t+o,n+r+5*(o/a-.5)*l+d*(D1()-.5)):e.moveTo(t+o,n+r+5*(o/a-.5)*l+d*(D1()-.5))}function o1(e){e=E[e];var t=E[T-1];e.x=t.x,e.y=t.y,e.dx=t.dx,e.dy=t.dy,e.born=t.born,T--}function r1(e){return A.shield&&b-(e.lastBlock??-2e4)>(2===A.shield?1e4:2e4)}window.addEventListener("blur",function(e){y||(y=m,a.pause())},!1),window.addEventListener("focus",function(e){y&&(o+=m-y,y=0,F||P.dead||a.resume())},!1);let T=0;const E=[];function i1(e){var{x:t,y:n,dx:o,dy:r,archerOrientation:i}=e,a=(T>=E.length&&E.push({}),E[T]);a.dx=120*O(i,e)+2*o,a.dy=10*r-5,a.x=t+a.dx,a.y=n-60,a.born=b,T++}function a1(t,n){var o=Math.min(6,Math.max(L1/8,1));for(let e=0;e<o;e++)t(n)}function s1(e){var t=O(e.ax,e),n=O(e.ay,e),o=W1(t,n),r=(0!==t&&(e.orientation=t),O(e.speed,e)*(e.dead?1.5:1)*(e.superSoldier&&e.soldier?.8:1)),i=O(e.control,e)??0,a=O(e.brake,e)-.01*i;o?(e.dx=(e.dx+t/o*r*(1+i))*a,e.dy=(e.dy+n/o*r/2*(1+i))*a):(e.dx=e.dx*a,e.dy=e.dy*a),O(e.moving,e)&&(e.x+=.7*e.dx,e.y+=.7*e.dy),t=W1(e.dx,e.dy),e.horseFrame+=.7*Math.max(.08,t/50)}let l1=null;function d1(){return!X&&Object.keys(A).filter(e=>A[e]).length}const L={parent:!0,active:()=>!0,time:0,nextShot:0,process:t=>{if(t.parent){if(!p&&r.Escape&&d1()){C=0,P.dead=0,o=Math.max(o,V()-1e3*J+6e4),a.play();const t=Object.keys(A).filter(e=>A[e]).sort(()=>D1()-.5)[0];A[t]--,n("You lost "+Y.filter(e=>e.name===t)[0].title.toUpperCase()),p=i+2*A.maxHealth,"bow"===t&&D.cost.push(0),$()}!p&&t.hero||(a1(s1,t),u&&(t.x=Math.max(-M/2,Math.min(t.x,M/2)),t.y=Math.max(-k/2,Math.min(t.y,k/2))),O(t.shooting,t)?A.bow&&b>t.nextShot&&(i1(t),t.nextShot=b+O(t.shootPeriod,t)):t.archerOrientation=t.orientation)}},shootPeriod:300,archerOrientation:1,orientation:1,brake:.99,speed:e=>(.08+.03*A.speed)*(O(e.shooting,e)&&!A.speedWhileShooting?.5:1),x:300,y:500,moving:e=>.5<Math.abs(e.dx)||.5<Math.abs(e.dy),shooting:()=>r.Space,ax:()=>(r.KeyA||r.ArrowLeft?-1:0)+(r.KeyD||r.ArrowRight?1:0),ay:()=>(r.KeyW||r.ArrowUp?-1:0)+(r.KeyS||r.ArrowDown?1:0),dx:0,dy:0,width:187.5,height:150,born:0,horseFrame:0,random:0,riderAnimation:"archer",layer:0,control:()=>A.control,sprites:[e=>O({...e,y:e=>O(e.y,e)-.1,parent:!1,sprites:void 0,animation:e=>O(e.riderAnimation,e),range:e=>O(e.rangeOverride,e)??(O(e.shooting,e)?[0,3]:[0]),hotspot:[e=>O(e.moving,e)?.5-e.orientation*O(e.archerOrientation,e)*.05:.53,e=>O(e.moving,e)?.65+Math.sin(.7*e.horseFrame)/100:.7],color:e=>O(e.foeColor,e)??(e.corpse?e.color:e.hut?"#af8":e.tree?"#270":"black"),direction:e=>Math.sign(O(e.archerOrientation,e)),frame:e=>O(e.horseFrame,e),random:4,hidden:e=>e.dead},e),e=>O({...e,process:void 0,parent:!1,sprites:void 0,animation:e=>e.hut?"hut":"horse",range:e=>e.hut?[0]:O(e.moving,e)?[0,10]:[11],hotspot:[.47,.72],color:e=>e.borte?"#f98":e.hut&&q(e).closed?"#ba6":e.superSoldier?"#a08":e.foe?"#004":"#630",direction:e=>Math.sign(e.orientation),frame:e=>O(e.horseFrame,e),random:e=>e.superSoldier?100:4,hidden:e=>e.tree&&!e.hut||e.corpse||e.soldier},e),e=>O({...e,process:void 0,y:e=>O(e.y,e)+1,parent:!1,sprites:void 0,animation:"shield",range:[0],hotspot:[.47,.72],color:e=>r1(e)&&1<A.shield?"gold":"#69f",direction:e=>Math.sign(e.orientation),frame:()=>0,hidden:e=>!r1(e)||e.borte||e.foe||e.corpse||e.soldier},e),e=>O({...e,process:void 0,layer:-2,parent:!1,sprites:void 0,animation:e=>e.soldier?"soldier":e.corpse?"dead":e.hut?"hut":e.tree?"tree":"horse",range:e=>e.corpse?O(e.rangeOverride,e):e.tree?[0]:O(e.moving,e)?[0,10]:[11],hotspot:e=>e.tree?[.53,1]:[.47,.72],color:"#999",direction:e=>Math.sign(e.orientation),height:-50,frame:e=>O(e.horseFrame,e),hidden:e=>e.dead&&e.soldier},e),...new Array(5).fill(e=>O({...e,process:void 0,cache:!1,parent:!1,sprites:void 0,animation:"shield",random:150,range:[0],hotspot:[.47+D1()-.5,5],width:200,height:30,color:()=>D1()<.5?"gold":"red",direction:e=>Math.sign(e.orientation),frame:()=>0,active:e=>e.hut&&q(e).onFire},e))]};function O(e,t){if("object"!=typeof e)return"function"==typeof e?e(t):e;if(Array.isArray(e))return e.map(e=>O(e,t));var n,o={};for(n in e)o[n]=O(e[n],t);return o}const h1={};let m=0,c1=0;function g(t){if("object"!=typeof t)return t;if(Array.isArray(t)){var n=[...t];for(let e=0;e<n.length;e++)n[e]=g(t[e]);return n}var e,o={...t};for(e in o)o[e]=g(t[e]);return o}const P={...g(L),hero:!0};let I=0,x=0;const f1=[];function u1(e,o,t){t={...g(L),corpse:!0,horseFrame:0,x:e.x,y:e.y,rangeOverride:[0,4],range:void 0,archerOrientation:o<0?1:-1,cache:!0,riderAnimation:"dead",born:b,color:t,process:e=>{var t=b-e.born,n=(t=Math.floor(t/50),O(e.rangeOverride[1],e));e.horseFrame=Math.min(t,n),e.horseFrame<n&&(e.x+=o*L1/1e3)},width:e.width,height:e.height},200<f1.length&&f1.shift(),f1.push(t)}function p1(){x=40,setTimeout(()=>{c.backgroundColor="#efd"},150),p||(u1(P,2*(P.x-L.x),P.color),P.dead=b,a.stop(),n("GAME OVER, KHAN"+(d1()?"\nESC to revive. You will lose your money and one upgrade.":"")),a.stop())}let v=0;const y1=new Array(400).fill(0).map((e,t)=>{const n=D1()*Math.PI*2,o=Math.cos(n),r=Math.sin(n),i=t%20==0&&30<t,a=t%3<=1,s=o*(2e3+1e3*D1()),l=r*(2e3+1e3*D1()),d=a?Math.max(.01,D1()/20):Math.max(.03,D1()/10),h={...g(L),active:()=>t<=v,superSoldier:i,foeIndex:t,foeColor:i?a?"blue":"#a00":a?"#75f":"#f0a",horseFrame:Math.floor(100*D1()),goal:[s,l],gdist:0,ax:e=>(e.goal[0]-h.x)/2e3,ay:e=>(e.goal[1]-h.y)/2e3,x:s,y:l,rangeOverride:e=>O(e.moving,e)?a?[0,4]:[0,3]:[0],speed:()=>d*f,archerOrientation:e=>Math.sign(O(e.dx,e)),cache:!0,soldier:a,process:e=>{if(e.parent&&O(e.active,e)){e.dead&&5e3<b-e.dead&&(e.dead=0,e.speed=e.soldier?Math.max(.025,D1()/30):Math.max(.03,D1()/20)),a1(s1,e);var t,n=e.x-e.goal[0],o=e.y-e.goal[1];if(e.gdist=W1(n,o),n=e.x-P.x,o=e.y-P.y,(n=W1(n,o))<50&&!e.dead&&p&&(r1(P)?P.lastBlock=b:(c.backgroundColor="#a00",p=Math.max(0,p-(i?2:1)),$()),x=40,setTimeout(()=>{c.backgroundColor="#efd"},150),p1(),o=D1()*Math.PI*2,t=Math.cos(o),o=Math.sin(o),e.x=P.x+2e3*t,e.y=P.y+2e3*o,P.dx=0,P.dy=0,P.hitTime=b),w1||!p){if(!e.pausing){e.pausing=!0;const b=e.x-(w1??P).x,t=e.y-(w1??P).y,n=2e3/W1(b,t);e.goal[0]=P.x+b*n,e.goal[1]=P.y+t*n}}else{if(e.pausing&&(e.pausing=!1),2500<n){if(D1()<.6||!P.dx&&!P.dy){const b=D1()*Math.PI*2,t=Math.cos(b),n=Math.sin(b);e.x=P.x+1500*t,e.y=P.y+1500*n}else{const b=W1(P.dx,P.dy);e.x=P.x+P.dx*(1e3+500*D1())/b+300*(D1()-.5),e.y=P.y+P.dy*(1e3+500*D1())/b+300*(D1()-.5)}e.dead&&(e.dead=0,e.speed=e.soldier?Math.max(.025,D1()/30):Math.max(.03,D1()/20)),e.gdist=0}(e.gdist<100||(e.soldier?500:3e3)<n)&&(e.goal[0]=P.x+(P.x-e.x)+(D1()-.5)*(e.soldier?200:300),e.goal[1]=P.y+(P.y-e.y)+(D1()-.5)*(e.soldier?200:300))}}},foe:!0,width:(a?150:165)*(i?a?2:1.5:1),height:135*(i?a?2:1.5:1),riderAnimation:a?"soldier":"sword"};return h});function m1(e){return e.cost?.length&&C>=e.cost[0]*h}const s=document.body.appendChild(document.createElement("div")),g1=s.style,x1=(g1.position="absolute",g1.left="200px",g1.top="200px",g1.display="none",new Array(5).fill(null).map(()=>{var e=s.appendChild(document.createElement("div")),t=e.style;return t.backgroundColor="#444",t.margin="10px",t.padding="20px 10px",e})),l=x1.map(()=>null);let d=0,v1=[];function b1(t){t||(d=0,Y.sort((e,t)=>"bow"===e.name?-1:"bow"===t.name?1:D1()-.5),v1=[...Y].filter(m1).slice(0,x1.length-1));var n=v1;s.style.display="";for(let e=0;e<x1.length;e++){t||(l[e]=!1);var o=x1[e];o.style.backgroundColor=l[e]?"#6F6":e===d?"#480":"#222",o.style.padding="10px",o.style.width="500px",o.style.outline=e===d?"4px solid green":"",o.style.display=e>n.length-(A.bow?0:1)?"none":"",o.style.opacity=e===n.length||n[e]&&m1(n[e])||l[e]?1:.5,o.style.color=l[e]?"green":"",o.innerText=e===n.length?"Exit":n[e]?`${n[e].title.toUpperCase()} ${l[e]?"‚úîÔ∏è":n[e].cost[0]?`(Cost: ${n[e].cost[0]*h} üèµÔ∏è)`:""}\n`+O(n[e].description,n[e]):""}}let w1=null,F=null;const M1={},k1=new Array(200).fill(0).map((e,t)=>{const o=t<=1,r=o?18e3:4e3,i=r/2+500,n={...g(L),cache:!0,x:o?t*r:1e3+4e3*D1(),y:o?t*r/2:4e3*D1(),cellX:0,cellY:0,index:t,process:e=>{var t,n;e.parent&&O(e.active,e)&&(t=e.x-P.x,n=e.y-P.y,W1(t,n)<(o?80:50)&&(o&&!q(e).closed?F||((F=e).enteredHut=b,q(F).level||(q(F).level=C1++,l1=N[Math.min(C1,N.length-1)]?.()),$(),a.stop(),b1()):(x=20,P.x-=t,P.y-=n,P.dx*=.3*A.treeNav,P.dy*=.3*A.treeNav)),t>2*i?(e.x-=2*r,e.cellX--):t<2*-i&&(e.x+=2*r,e.cellX++),n>i?(e.y-=r,e.cellY--):n<-i&&(e.y+=r,e.cellY++))},foe:!0,width:.75*(o?600:500),height:.75*(o?400:350+200*D1()),riderAnimation:o?"hut":"tree",foeColor:o?`rgb(200, ${100+55*t}, ${50+50*t})`:`rgb(${30*D1()}, ${150*D1()}, ${20*D1()})`,tree:!0,hut:o,rangeOverride:o?[1]:void 0};return n});function S1(){G=V(),A1.x=P.x,A1.y=P.y,a=B}window.findBorte=S1;let A1={...L,borte:!0,foeColor:"red",active:()=>G,shootPeriod:1e3,process:e=>{var t,n;e.parent&&O(e.active,e)&&(t=P.x-e.x,n=P.y-e.y,300<W1(t,n)?(e.ax=.01*t,e.ay=.01*n):(e.ax=0,e.ay=0),b>e.nextShot&&(i1(e),e.nextShot=b+O(e.shootPeriod,e)),a1(s1,e),e.orientation=2*Math.sign(e.dx??1))},archerOrientation:e=>Math.sign(e.dx||1)},C1=0;function q(e){return e=e.cellX+`_${e.cellY}_`+e.index,M1[e]??(M1[e]={})}function $1(e,t){var n=e.x-t.x;return n*n+(e=e.y-t.y)*e}const T1=new Set,E1=[[P,A1],y1,f1,k1];let L1,H=null;function O1(t){for(let e=0;e<T;e++){var n=t[e],o=W1(n.dx,n.dy)+1;n.dy+=.3,n.x+=n.dx*(o=20/o),n.y+=n.dy*o}}var P1,I1=function(){var t=[],n=new XMLHttpRequest;if(n.open("GET","rider.13k",!1),n.overrideMimeType("text/plain; charset=x-user-defined"),n.send(null),200===n.status)for(let e=0;e<n.responseText.length;++e)t.push(255&n.responseText.charCodeAt(e));return t}(),F1={};(I1=function(t){var n=new Array(Math.ceil(2*t.length));for(let e=0;e<t.length;e++)n[2*e]=t[e]%16,n[2*e+1]=(t[e]>>4)%16;return n}(I1)).reverse(),P1=I1.pop(),F1.animations=function(t){var n=new Array(t.pop());for(let e=0;e<n.length;e++)n[e]=q1(t);return n}(I1),F1.shapes=function(t,n){var o=new Array(t.pop());for(let e=0;e<o.length;e++){var r=o[e]={},i=(r.name=q1(t),r.lines=function(t,n){var o=new Array(t.pop());for(let e=0;e<o.length;e++)o[e]=function(e){let t,n,o=[0,0],r=0,i=0;for(;r=e.pop()-7,i=e.pop()-7,o[0]+=r,o[1]+=i,r||i;);do{if(r=e.pop()-7,i=e.pop()-7,r||i){const e=t*i,a=n*r;Math.abs(e-a)<5?(o[o.length-2]+=r,o[o.length-1]+=i):o.push(o[o.length-2]+r,o[o.length-1]+i),t=r,n=i}}while(r||i);return o}(t).map(e=>e*n);return o}(t,n),r.anim=t.pop(),t.pop());r.hidden=1===i}return o}(I1,P1),e1=F1,function e(t){if(requestAnimationFrame(e),m=Math.max(m,t-100),b=t,!y){L1=t-m,m=t,x&&(I=D1()*x,(x*=.5)<.1)&&(x=0),w.clearRect(0,0,M,k),a1(O1,E),w.beginPath(),w.strokeStyle="#038",w.lineWidth=6;for(let e=0;e<T;e++){const b=E[e],t=W1(b.dx,b.dy);w.moveTo(b.x-S[0],b.y-S[1]+I),w.lineTo(b.x-S[0]-b.dx/t*50,b.y-S[1]+I-b.dy/t*50)}w.stroke();for(let e=T-1;0<=e;e--)1500<t-E[e].born&&o1(e);w.strokeStyle="#380",w.lineWidth=2,j.length=0,w.beginPath();var n,o=[Math.round(S[0]/200),Math.round(S[1]/200)];for(let t=-15;t<15;t++)for(let e=-20;e<20;e++){var r=e+o[0],i=t+o[1],a=Math.sin(123*r+9991*i)+Math.sin(123*r/10+9991*i/100)+Math.sin(123*r/10+9991*i/100),s=Math.cos(12331*r+2221*i)+Math.cos(12331*r/10+2221*i/10)+Math.cos(12331*r/100+2221*i/100),l=500*a,d=200*s,r=200*r-S[0]+l,l=200*i-S[1]+d;w.moveTo(r,l+I),w.lineTo(r+100*a,l+I+3),w.lineTo(r+100*a+100*s,l+I)}w.stroke(),E1.forEach(e=>e.forEach(e=>{var v=j;O(e.sprites,e).forEach(t=>{let{x:n,y:o,width:r,height:e,hotspot:i,foeIndex:a,dead:s,color:l,foeColor:d,superSoldier:h,hidden:c,tree:f,active:u}=t;if(u&&!c&&(!F||f)){var p=n-i[0]*r-S[0],y=o-i[1]*e-S[1],m=p+r,g=y+e;if(!(m<0||g<0||p>M||y>k)){if(void 0!==a&&!s)for(let e=T-1;0<=e;e--){const v=E[e];if(v.x-S[0]>p&&v.x-S[0]<m&&v.y-S[1]>y&&v.y-S[1]<g){const n=!h||D1()<.05+.2*A.giantPiercing,o=y1[a];if(n){o.dead=b,u1(o,v.dx,d??l);const t=P.x-o.x,n=P.y-o.y;var x=2e3/W1(t,n);o.dx=0,o.dy=0,o.goal[0]=o.x+-t*x,o.goal[1]=o.y+-n*x;const r=(h?40:8)*(1+A.money);T1.add({born:b,bonus:r,x:o.x,y:o.y}),C+=r,$()}else o.hitTime=b;D1()<.3*A.rickoShot?(v.dx*=D1()-.5,v.dy=.8*-Math.abs(v.dy)):o1(e),A.quickShot&&(P.nextShot=b+50)}}v.push(t)}}})})),j.sort((e,t)=>e.layer!==t.layer?e.layer-t.layer:Math.sign(e.y-t.y)),w1=null,j.forEach(m=>{{var g=m;let{x:t,y:n,width:o,height:r,animation:i,horseFrame:e,range:a,hotspot:s,color:l,hitTime:d,direction:h,dy:c,random:f,cache:u,hero:p,hut:y}=g;y&&!q(g).closed&&(w1=g),d&&b-d<100&&(l=p?"red":"white"),m=a[0]+(a.length<=1?0:Math.floor(e)%(a[1]-a[0]+1));var x=O(h,L),g=O(c,L);if(u){const b=e1.animations.indexOf(i),g=`${i}-${m}-${l}-${x}-${o}-`+r;let e;h1[g]||(e=document.createElement("canvas"),h1[g]={canvas:e},e.width=o,e.height=r,e.getContext("2d").lineWidth=6,e.getContext("2d").strokeStyle="black",t1(e.getContext("2d"),x<0?o:0,r<0?-r:0,o*x,r,m,b,l,0,0)),e=h1[g].canvas,w.drawImage(e,t-s[0]*o-S[0],n-(r<0?0:s[1]*r)-S[1]+I)}else{var v=e1.animations.indexOf(i);t1(w,t-s[0]*o*x-S[0],n-s[1]*r-S[1]+I,o*x,r,m,v,l,g,f)}}});var h,c=function(){let t=k1.filter(e=>e.hut&&!q(e).closed),n=t[0];for(let e=1;e<t.length;e++)$1(t[e],P)<$1(n,P)&&(n=t[e]);return n}();if(c){const e=c.x-P.x,b=c.y-P.y,t=W1(e,b);2e3<t&&(H=H||[P.x,P.y],w.beginPath(),c=P.x+e/t*2e3-S[0],h=P.y+b/t*2e3-S[1],H[0]+=.1*(c-H[0]),H[1]+=.1*(h-H[1]),w.arc(Math.min(M-80,Math.max(80,H[0])),Math.min(k-80,Math.max(80,H[1])),15,0,2*Math.PI),w.fill())}for(n of(w.font="28px serif",T1)){var f=t-n.born;w.fillText(`+${n.bonus}üèµÔ∏è`,n.x-S[0],n.y-S[1]-f/50),2e3<f&&T1.delete(n)}if(p)if(F){const e=Math.min(1,(t-F.enteredHut)/500);w.fillStyle=`rgb(0,0,0,${e})`,w.fillRect(0,0,M,k),w.fill()}else u?(S[0]=-M/2,S[1]=-k/2):(c1+=.05*((P.dx*P.archerOrientation<0?0:P.dx)/2+P.archerOrientation-c1),S[0]+=.1*(P.x-M/2-S[0]+80*c1),S[1]+=.1*(P.y-k/2-S[1]+50*P.dy));else{const e=Math.min(.7,(t-P.dead)/3e3);w.fillStyle=`rgb(200,0,0,${e})`,w.fillRect(0,0,M,k),w.fill()}}}(0)},3e3)})</script>