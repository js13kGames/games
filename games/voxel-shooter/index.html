<title>Voxel Shooter - js13kGames 2012</title><script id=shader-fs type=x-shader/x-fragment>precision mediump float;varying vec4 vColor;void main(void){gl_FragColor=vColor;}</script><script id=shader-vs type=x-shader/x-vertex>attribute vec3 aVertexPosition;attribute vec4 aVertexColor;attribute vec3 aVertexNormal; attribute vec3 aWorldPosition; attribute vec3 aVelocity; attribute float aStartTime; uniform mat4 uPMatrix; uniform mat4 uCMatrix; uniform mat4 uRMatrix; uniform float uTime; uniform bool uUseLighting; uniform bool uUseFog; uniform vec3 uAmbientColor; uniform vec3 uLightingDirection; uniform vec3 uDirectionalColor; varying vec4 vColor; void main(void) { vec3 position = aVelocity * (uTime - aStartTime); mat4 modelMatrix = mat4(vec4(1,0,0,0), vec4(0,1,0,0), vec4(0,0,1,0), vec4(aWorldPosition + position, 1)); gl_Position = uPMatrix * uRMatrix * uCMatrix * modelMatrix * vec4(aVertexPosition, 1.0); vec4 transformedNormal = modelMatrix * vec4(aVertexNormal, 0.0); float vLightWeighting = max(dot(transformedNormal.xyz, uLightingDirection), 0.0); if (uUseLighting) {vColor = vec4((aVertexColor.xyz * (uAmbientColor + uDirectionalColor * vLightWeighting), aVertexColor.a));} else { vColor = aVertexColor; } if (uUseFog) {float dist = length(gl_Position.xyz) / 1000.0;float density = 0.5; float fogFactor = exp2(-density * density * dist * dist);vColor = vColor + vec4(1.0, 1.0, 1.0, 0.0) * (1.0 - fogFactor);}clamp(vColor, vec4(0, 0, 0, 0), vec4(1.0, 1.0, 1.0, 1.0));}</script><body style=margin:0><canvas id=canvas style=border:none;margin:0;position:absolute;top:0;left:0></canvas><canvas id=minimap style=position:absolute;left:5px;top:5px;margin:0></canvas><div id=fps style=position:absolute;color:red;left:0;top:0></div><div id=crashed style=position:absolute;color:red;left:35%;top:35%;font-size:600%></div><div id=score style=position:absolute;color:#000;left:75%;top:0;font-size:300%>Score: 0</div><script>var gl,vec3={create:function(r){var e=new Float32Array(3);return r&&(e[0]=r[0],e[1]=r[1],e[2]=r[2]),e},subtract:function(r,e,t){return t&&r!=t?(t[0]=r[0]-e[0],t[1]=r[1]-e[1],t[2]=r[2]-e[2],t):(r[0]-=e[0],r[1]-=e[1],r[2]-=e[2],r)},add:function(r,e,t){return t&&r!=t?(t[0]=r[0]+e[0],t[1]=r[1]+e[1],t[2]=r[2]+e[2],t):(r[0]+=e[0],r[1]+=e[1],r[2]+=e[2],r)},normalize:function(r,e){e||(e=r);var t=r[0],a=r[1],i=r[2],n=Math.sqrt(t*t+a*a+i*i);return n?1==n?(e[0]=t,e[1]=a,e[2]=i,e):(n=1/n,e[0]=t*n,e[1]=a*n,e[2]=i*n,e):(e[0]=0,e[1]=0,e[2]=0,e)}},mat4={};mat4.create=function(r){var e=new Float32Array(16);return r&&(e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15]),e},mat4.frustum=function(r,e,t,a,i,n,o){o||(o=mat4.create());var l=e-r,u=a-t,m=n-i;return o[0]=2*i/l,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2*i/u,o[6]=0,o[7]=0,o[8]=(e+r)/l,o[9]=(a+t)/u,o[10]=-(n+i)/m,o[11]=-1,o[12]=0,o[13]=0,o[14]=-n*i*2/m,o[15]=0,o},mat4.perspective=function(r,e,t,a,i){var n=t*Math.tan(r*Math.PI/360),o=n*e;return mat4.frustum(-o,o,-n,n,t,a,i)},mat4.identity=function(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},mat4.translate=function(r,e,t){var a=e[0],i=e[1],n=e[2];if(!t||r==t)return r[12]=r[0]*a+r[4]*i+r[8]*n+r[12],r[13]=r[1]*a+r[5]*i+r[9]*n+r[13],r[14]=r[2]*a+r[6]*i+r[10]*n+r[14],r[15]=r[3]*a+r[7]*i+r[11]*n+r[15],r;var o=r[0],l=r[1],u=r[2],m=r[3],s=r[4],c=r[5],g=r[6],h=r[7],f=r[8],d=r[9],M=r[10],A=r[11];return t[0]=o,t[1]=l,t[2]=u,t[3]=m,t[4]=s,t[5]=c,t[6]=g,t[7]=h,t[8]=f,t[9]=d,t[10]=M,t[11]=A,t[12]=o*a+s*i+f*n+r[12],t[13]=l*a+c*i+d*n+r[13],t[14]=u*a+g*i+M*n+r[14],t[15]=m*a+h*i+A*n+r[15],t},mat4.rotate=function(r,e,t,a){var i=t[0],n=t[1],o=t[2],l=Math.sqrt(i*i+n*n+o*o);if(!l)return null;1!=l&&(i*=l=1/l,n*=l,o*=l);var u=Math.sin(e),m=Math.cos(e),s=1-m,c=r[0],g=r[1],h=r[2],f=r[3],d=r[4],M=r[5],A=r[6],v=r[7],R=r[8],p=r[9],b=r[10],I=r[11],E=i*i*s+m,C=n*i*s+o*u,P=o*i*s-n*u,S=i*n*s-o*u,k=n*n*s+m,T=o*n*s+i*u,X=i*o*s+n*u,F=n*o*s-i*u,Z=o*o*s+m;return a?r!=a&&(a[12]=r[12],a[13]=r[13],a[14]=r[14],a[15]=r[15]):a=r,a[0]=c*E+d*C+R*P,a[1]=g*E+M*C+p*P,a[2]=h*E+A*C+b*P,a[3]=f*E+v*C+I*P,a[4]=c*S+d*k+R*T,a[5]=g*S+M*k+p*T,a[6]=h*S+A*k+b*T,a[7]=f*S+v*k+I*T,a[8]=c*X+d*F+R*Z,a[9]=g*X+M*F+p*Z,a[10]=h*X+A*F+b*Z,a[11]=f*X+v*F+I*Z,a},mat4.rotateZ=function(r,e,t){var a=Math.sin(e),i=Math.cos(e),n=r[0],o=r[1],l=r[2],u=r[3],m=r[4],s=r[5],c=r[6],g=r[7];return t?r!=t&&(t[8]=r[8],t[9]=r[9],t[10]=r[10],t[11]=r[11],t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15]):t=r,t[0]=n*i+m*a,t[1]=o*i+s*a,t[2]=l*i+c*a,t[3]=u*i+g*a,t[4]=n*-a+m*i,t[5]=o*-a+s*i,t[6]=l*-a+c*i,t[7]=u*-a+g*i,t},mat4.lookAt=function(r,e,t,a){a||(a=mat4.create());var i,n,o,l,u,m,s,c,g,h,f=r[0],d=r[1],M=r[2],A=t[0],v=t[1],R=t[2],p=e[0],b=e[1],I=e[2];return f==p&&d==b&&M==I?mat4.identity(a):(i=f-e[0],n=d-e[1],o=M-e[2],l=v*(o*=h=1/Math.sqrt(i*i+n*n+o*o))-R*(n*=h),u=R*(i*=h)-A*o,m=A*n-v*i,(h=Math.sqrt(l*l+u*u+m*m))?(l*=h=1/h,u*=h,m*=h):(l=0,u=0,m=0),s=n*m-o*u,c=o*l-i*m,g=i*u-n*l,(h=Math.sqrt(s*s+c*c+g*g))?(s*=h=1/h,c*=h,g*=h):(s=0,c=0,g=0),a[0]=l,a[1]=s,a[2]=i,a[3]=0,a[4]=u,a[5]=c,a[6]=n,a[7]=0,a[8]=m,a[9]=g,a[10]=o,a[11]=0,a[12]=-(l*f+u*d+m*M),a[13]=-(s*f+c*d+g*M),a[14]=-(i*f+n*d+o*M),a[15]=1,a)},mat4.scale=function(r,e,t){var a=e[0],i=e[1],n=e[2];return t&&r!=t?(t[0]=r[0]*a,t[1]=r[1]*a,t[2]=r[2]*a,t[3]=r[3]*a,t[4]=r[4]*i,t[5]=r[5]*i,t[6]=r[6]*i,t[7]=r[7]*i,t[8]=r[8]*n,t[9]=r[9]*n,t[10]=r[10]*n,t[11]=r[11]*n,t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15],t):(r[0]*=a,r[1]*=a,r[2]*=a,r[3]*=a,r[4]*=i,r[5]*=i,r[6]*=i,r[7]*=i,r[8]*=n,r[9]*=n,r[10]*=n,r[11]*=n,r)};var mini,rot=0;function initGL(r){r.width=window.innerWidth,r.height=window.innerHeight;try{(gl=r.getContext("webgl")||r.getContext("experimental-webgl"))&&(gl.viewportWidth=r.width,gl.viewportHeight=r.height)}catch(r){}gl||alert("Could not initialise WebGL, sorry :-(")}var shaderProgram,MAPSCALE=4;function initMinimap(r){r.width=2*(MAXX-MINX)/MAPSCALE,r.height=2*(MAXZ-MINZ)/MAPSCALE,(mini=r.getContext("2d"))||alert("Could not initialise Canvas, sorry :-(")}function getShader(r,e){var t=document.getElementById(e);if(!t)return null;for(var a,i="",n=t.firstChild;n;)3==n.nodeType&&(i+=n.textContent),n=n.nextSibling;if("x-shader/x-fragment"==t.type)a=r.createShader(r.FRAGMENT_SHADER);else{if("x-shader/x-vertex"!=t.type)return null;a=r.createShader(r.VERTEX_SHADER)}return r.shaderSource(a,i),r.compileShader(a),r.getShaderParameter(a,r.COMPILE_STATUS)?a:(alert(r.getShaderInfoLog(a)),null)}function initShaders(){var r=getShader(gl,"shader-fs"),e=getShader(gl,"shader-vs");shaderProgram=gl.createProgram(),gl.attachShader(shaderProgram,e),gl.attachShader(shaderProgram,r),gl.linkProgram(shaderProgram),gl.getProgramParameter(shaderProgram,gl.LINK_STATUS)||alert("Could not initialise shaders"),gl.useProgram(shaderProgram),shaderProgram.vertexPositionAttribute=gl.getAttribLocation(shaderProgram,"aVertexPosition"),gl.enableVertexAttribArray(shaderProgram.vertexPositionAttribute),shaderProgram.vertexColorAttribute=gl.getAttribLocation(shaderProgram,"aVertexColor"),gl.enableVertexAttribArray(shaderProgram.vertexColorAttribute),shaderProgram.vertexNormalAttribute=gl.getAttribLocation(shaderProgram,"aVertexNormal"),gl.enableVertexAttribArray(shaderProgram.vertexNormalAttribute),shaderProgram.worldPositionAttribute=gl.getAttribLocation(shaderProgram,"aWorldPosition"),gl.enableVertexAttribArray(shaderProgram.worldPositionAttribute),shaderProgram.velocityAttribute=gl.getAttribLocation(shaderProgram,"aVelocity"),gl.enableVertexAttribArray(shaderProgram.velocityAttribute),shaderProgram.startTimeAttribute=gl.getAttribLocation(shaderProgram,"aStartTime"),gl.enableVertexAttribArray(shaderProgram.startTimeAttribute),shaderProgram.pMatrixUniform=gl.getUniformLocation(shaderProgram,"uPMatrix"),shaderProgram.rMatrixUniform=gl.getUniformLocation(shaderProgram,"uRMatrix"),shaderProgram.cMatrixUniform=gl.getUniformLocation(shaderProgram,"uCMatrix"),shaderProgram.timeUniform=gl.getUniformLocation(shaderProgram,"uTime"),shaderProgram.useLightingUniform=gl.getUniformLocation(shaderProgram,"uUseLighting"),shaderProgram.useFogUniform=gl.getUniformLocation(shaderProgram,"uUseFog"),shaderProgram.ambientColorUniform=gl.getUniformLocation(shaderProgram,"uAmbientColor"),shaderProgram.lightingDirectionUniform=gl.getUniformLocation(shaderProgram,"uLightingDirection"),shaderProgram.directionalColorUniform=gl.getUniformLocation(shaderProgram,"uDirectionalColor")}var cMatrix=mat4.create(),rMatrix=mat4.create(),pMatrix=mat4.create();function degToRad(r){return r*Math.PI/180}var vertices,groundColors,cloudColors,waterColors,enemyColors,bulletColors,normals,topIndices,leftIndices,rightIndices,frontIndices,backIndices,bottomIndices,SIZE=32,R=SIZE/2;function initArrays(){vertices=[-R,-R,R,R,-R,R,R,R,R,-R,R,R,-R,-R,-R,-R,R,-R,R,R,-R,R,-R,-R,-R,R,-R,-R,R,R,R,R,R,R,R,-R,R,-R,-R,R,R,-R,R,R,R,R,-R,R,-R,-R,-R,-R,-R,R,-R,R,R,-R,R,-R,-R,-R,-R,R,-R,-R,R,-R,R,-R,-R,R];var r=function(r){for(var e=[],t=0;t<6;t++)e.push(r);return e},e=r([.9,.9,.9,1]),t=r([.4,.4,.9,1]),a=r([1,0,0,1]),i=r([0,0,1,1]),n=function(r){var e=[];for(var t in r)for(var a=r[t],i=0;i<4;i++)e=e.concat(a);return e};groundColors=n([[.8,.52,.24,1],[.8,.52,.24,1],[0,.8,0,1],[.8,.52,.24,1],[.8,.52,.24,1],[.8,.52,.24,1]]),cloudColors=n(e),waterColors=n(t),enemyColors=n(a),bulletColors=n(i),normals=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],topIndices=[8,9,10,8,10,11],leftIndices=[16,17,18,16,18,19],rightIndices=[12,13,14,12,14,15],frontIndices=[0,1,2,0,2,3],backIndices=[4,5,6,4,6,7],bottomIndices=[20,21,22,20,22,23]}var GROUND=0,CLOUD=1,WATER=2,ENEMY=3,BULLET=4;function addCube(r,e,t,a,n,o,l,u,m,s,c,g,h,f,d,M,A,v){var R=topIndices,p=groundColors;for(v==CLOUD?p=cloudColors:v==WATER?p=waterColors:v==ENEMY?p=enemyColors:v==BULLET&&(p=bulletColors),(A&LEFT)==LEFT&&(R=R.concat(leftIndices)),(A&RIGHT)==RIGHT&&(R=R.concat(rightIndices)),(A&FRONT)==FRONT&&(R=R.concat(frontIndices)),(A&BACK)==BACK&&(R=R.concat(backIndices)),(A&BOTTOM)==BOTTOM&&(R=R.concat(bottomIndices)),i=0;i<R.length;i++){var b=R[i],I=3*b,E=4*b;r.push(vertices[I]*s,vertices[I+1]*c,vertices[I+2]*g),e.push(p[E],p[E+1],p[E+2],p[E+3]),t.push(normals[I],normals[I+1],normals[I+2]),a.push(l,u,m),n.push(h,f,d),o.push(M)}}function createChunk(r,e,t,a,i,n,o){return chunk={},chunk.vbuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,chunk.vbuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(r),gl.STATIC_DRAW),chunk.vbuffer.itemSize=3,chunk.vbuffer.numItems=r.length/chunk.vbuffer.itemSize,chunk.cbuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,chunk.cbuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(e),gl.STATIC_DRAW),chunk.cbuffer.itemSize=4,chunk.cbuffer.numItems=e.length/chunk.cbuffer.itemSize,chunk.nbuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,chunk.nbuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(t),gl.STATIC_DRAW),chunk.nbuffer.itemSize=3,chunk.nbuffer.numItems=t.length/chunk.nbuffer.itemSize,chunk.pbuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,chunk.pbuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(a),gl.STATIC_DRAW),chunk.pbuffer.itemSize=3,chunk.pbuffer.numItems=a.length/chunk.pbuffer.itemSize,chunk.velbuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,chunk.velbuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(i),gl.STATIC_DRAW),chunk.pbuffer.itemSize=3,chunk.pbuffer.numItems=i.length/chunk.velbuffer.itemSize,chunk.tbuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,chunk.tbuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(n),gl.STATIC_DRAW),chunk.tbuffer.itemSize=1,chunk.tbuffer.numItems=n.length,chunk.lighting=o.lighting||!1,chunk.fog=o.fog||!1,chunk}function createGroundChunk(r,e,t,a){for(var i=[],n=[],o=[],l=[],u=[],m=[],s=t;s<a;s++)for(var c=r;c<e;c++){var g=c-MINX,h=s-MINZ,f=h*(MAXX-MINX)+g,d=terrain[f],M=0,A=1;if(g>0){var v=terrain[f-1];v<d&&(M|=LEFT,A=Math.max(A,d-v))}else A=6,M|=LEFT;if(g<MAXX-MINX-1){var R=terrain[f+1];R<d&&(M|=RIGHT,A=Math.max(A,d-R))}else A=6,M|=RIGHT;if(h>0){var p=terrain[f-(MAXX-MINX)];p<d&&(M|=BACK,A=Math.max(A,d-p))}else A=6,M|=BACK;if(h<MAXZ-MINZ-1){var b=terrain[f+(MAXX-MINX)];b<d&&(M|=FRONT,A=Math.max(A,d-b))}else A=6,M|=FRONT;for(var I=0;I<A;I++)addCube(i,n,o,l,u,m,c*SIZE,(d-I)*SIZE,s*SIZE,1,1,1,0,0,0,startTime,M,GROUND)}return createChunk(i,n,o,l,u,m,{lighting:!0,fog:!0})}var ground=[];function initGroundChunks(){for(var r=MINZ;r<MAXZ;r+=50)for(var e=MINX;e<MAXX;e+=50)ground.push(createGroundChunk(e,Math.min(e+50,MAXX),r,Math.min(r+50,MAXZ)))}var clouds=[],NUMCLOUDS=40;function initCloudChunks(){for(var r=[],e=[],t=[],a=[],i=[],n=[],o=0;o<NUMCLOUDS;o++)for(var l=MINX+Math.floor(Math.random()*(MAXX-MINX)),u=MINZ+Math.floor(Math.random()*(MAXZ-MINZ)),m=10*Math.random()*SIZE-5*SIZE,s=LEFT|RIGHT|BACK|FRONT|BOTTOM,c=0;c<=5;c++)for(var g=0;g<=5;g++)for(var h=Math.floor(Math.sin(c/5*Math.PI)+Math.sin(g/5*Math.PI)/1.5),f=-h;f<=h;f++)addCube(r,e,t,a,i,n,l*SIZE+g*SIZE*4,(16+f)*SIZE+m,u*SIZE+c*SIZE*4,4,1,4,0,0,0,startTime,s,CLOUD);clouds.push(createChunk(r,e,t,a,i,n,{ligting:!1,fog:!0}))}var water=[];function initWaterChunks(){for(var r=[],e=[],t=[],a=[],i=[],n=[],o=(MAXZ-MINZ)*SIZE,l=(MAXX-MINX)*SIZE,u=-(MAXZ-MINZ)*SIZE,m=0;m<3;m++){for(var s=-(MAXX-MINX)*SIZE,c=0;c<3;c++)1==m&&1==c||addCube(r,e,t,a,i,n,s,0,u,MAXX-MINX,1,MAXZ-MINZ,0,0,0,startTime,0,WATER),s+=l;u+=o}water.push(createChunk(r,e,t,a,i,n,{lighting:!1,fog:!1}))}var enemyChunks=[];function updateEnemyChunks(){enemyChunks=[];for(var r=[],e=[],t=[],a=[],i=[],n=[],o=LEFT|RIGHT|FRONT|BACK,l=0;l<enemies.length;l++){var u=enemies[l];addCube(r,e,t,a,i,n,u.x*SIZE,u.y*SIZE,u.z*SIZE,4,4,4,0,0,0,startTime,o,ENEMY)}enemyChunks.push(createChunk(r,e,t,a,i,n,{lighting:!0,fog:!0}))}var pBulletChunks=[];function updatePBulletChunks(){pBulletChunks=[];for(var r=[],e=[],t=[],a=[],i=[],n=[],o=LEFT|RIGHT|FRONT|BACK|BOTTOM,l=0;l<pbullets.length;l++){var u=pbullets[l];addCube(r,e,t,a,i,n,u.x,u.y,u.z,.25,.25,.25,2*u.dir[0],2*u.dir[1],2*u.dir[2],u.startTime,o,BULLET)}pBulletChunks.push(createChunk(r,e,t,a,i,n,{lighting:!0,fog:!0}))}var eBulletChunks=[];function updateEBulletChunks(){eBulletChunks=[];for(var r=[],e=[],t=[],a=[],i=[],n=[],o=LEFT|RIGHT|FRONT|BACK|BOTTOM,l=0;l<ebullets.length;l++){var u=ebullets[l];addCube(r,e,t,a,i,n,u.x,u.y,u.z,.25,.25,.25,2*u.dir[0],2*u.dir[1],2*u.dir[2],startTime,o,ENEMY)}eBulletChunks.push(createChunk(r,e,t,a,i,n,{lighting:!0,fog:!0}))}function updateView(){camera.view[0]=Math.cos(camera.lrot)*Math.cos(camera.drot),camera.view[1]=Math.sin(camera.drot),camera.view[2]=Math.sin(camera.lrot)*Math.cos(camera.drot),vec3.normalize(camera.view),vec3.add(camera.pos,camera.view,camera.lookAt)}function initCamera(){camera.pos=vec3.create([300,200,10]),camera.lrot=0,camera.drot=0,camera.roll=0,camera.view=vec3.create(),camera.lookAt=vec3.create(),camera.up=vec3.create([0,1,0]),updateView()}var terrain,MINX=-128,MAXX=128,MINZ=-128,MAXZ=128;function initTerrain(){terrain=new Int32Array((MAXX-MINX)*(MAXZ-MINZ));for(var r=0,e=MINZ;e<MAXZ;e++)for(var t=MINX;t<MAXX;t++)terrain[r]=Math.floor(2.9*(Math.sin(t/32*Math.PI)+Math.cos(e/32*Math.PI))),t!=MINX&&t!=MAXX-1&&e!=MINZ&&e!=MAXZ-1||terrain[r]<1&&(terrain[r]=1),r++}var enemies=[],NUMENEMIES=26;function initEnemies(){for(var r=0;r<NUMENEMIES;r++){var e={};e.x=MINX+Math.floor(Math.random()*(MAXX-MINX)),e.z=MINZ+Math.floor(Math.random()*(MAXZ-MINZ));var t=(e.z-MINZ)*(MAXX-MINX)+(e.x-MINX);e.y=terrain[t]+2,enemies.push(e)}}function setupCommonUniforms(){gl.uniform3f(shaderProgram.ambientColorUniform,.2,.2,.2);var r=Math.sqrt(1.5);gl.uniform3f(shaderProgram.lightingDirectionUniform,.5/r,1/r,.5/r),gl.uniform3f(shaderProgram.directionalColorUniform,.5,.5,.5),gl.uniformMatrix4fv(shaderProgram.pMatrixUniform,!1,pMatrix),gl.uniformMatrix4fv(shaderProgram.rMatrixUniform,!1,rMatrix),gl.uniformMatrix4fv(shaderProgram.cMatrixUniform,!1,cMatrix),gl.uniform1f(shaderProgram.timeUniform,1*startTime)}function drawChunk(r){gl.bindBuffer(gl.ARRAY_BUFFER,r.vbuffer),gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute,r.vbuffer.itemSize,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,r.cbuffer),gl.vertexAttribPointer(shaderProgram.vertexColorAttribute,r.cbuffer.itemSize,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,r.nbuffer),gl.vertexAttribPointer(shaderProgram.vertexNormalAttribute,r.nbuffer.itemSize,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,r.pbuffer),gl.vertexAttribPointer(shaderProgram.worldPositionAttribute,r.pbuffer.itemSize,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,r.velbuffer),gl.vertexAttribPointer(shaderProgram.velocityAttribute,r.pbuffer.itemSize,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,r.tbuffer),gl.vertexAttribPointer(shaderProgram.startTimeAttribute,r.tbuffer.itemSize,gl.FLOAT,!1,0,0),gl.uniform1i(shaderProgram.useLightingUniform,r.lighting),gl.uniform1i(shaderProgram.useFogUniform,r.fog),gl.drawArrays(gl.TRIANGLES,0,r.vbuffer.numItems)}function drawChunks(r){for(var e=0;e<r.length;e++)drawChunk(r[e])}var camera={},LEFT=1,RIGHT=2,FRONT=4,BACK=8,BOTTOM=16;function drawScene(){gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),mat4.identity(rMatrix),mat4.rotateZ(rMatrix,camera.roll,rMatrix),mat4.lookAt(camera.pos,camera.lookAt,camera.up,cMatrix),setupCommonUniforms(),drawChunks(ground),drawChunks(enemyChunks),drawChunks(clouds),drawChunks(water),drawChunks(pBulletChunks)}var current=0,fps=60,numFrames=0,fpsText=null;function updateFps(r){numFrames++,(current+=r)>1e3&&(fps=Math.floor(1e3*numFrames/current),current=0,numFrames=0,fpsText.innerHTML=fps)}function drawMinimap(){mini.clearRect(0,0,minimap.width,minimap.height),mini.strokeStyle="rgb(0, 0, 0)",mini.strokeRect(0,0,minimap.width,minimap.height),mini.save();var r=(MAXX-MINX)/MAPSCALE,e=(MAXZ-MINZ)/MAPSCALE;mini.translate(r,e),mini.strokeStyle="rgb(0, 256, 0)",mini.strokeRect(MINX/MAPSCALE,MINZ/MAPSCALE,(MAXX-MINX)/MAPSCALE,(MAXZ-MINZ)/MAPSCALE),mini.fillStyle="rgb(0, 0, 256)",mini.fillRect(camera.pos[0]/(SIZE*MAPSCALE),camera.pos[2]/(SIZE*MAPSCALE),4,4);for(var t=0;t<enemies.length;t++){var a=enemies[t];mini.fillStyle="rgb(256, 0, 0)",mini.fillRect(a.x/MAPSCALE,a.z/MAPSCALE,2,2)}mini.restore()}var lastTime=0,crashed=!1;function updateAndDraw(){if(crashed){document.getElementById("crashed").innerHTML="Crashed!"}else{var r=(new Date).getTime();if(0!=lastTime){var e=r-lastTime;startTime=r,e<160&&(updateCamera(e),updateBullets(e),drawScene(),drawMinimap())}lastTime=r}}var view=vec3.create(),lastShoot=0,Score=0,BASESPEED=1;function updateCamera(r){var e=!1,t=degToRad(30*r/1e3);(keys[37]||keys[38]||keys[39]||keys[40])&&(keys[37]&&(camera.lrot-=t,camera.lrot<0&&(camera.lrot+=2*Math.PI),camera.roll-=t/4,camera.roll<-Math.PI/4&&(camera.roll=-Math.PI/4),e=!0),keys[39]&&(camera.lrot+=t,camera.lrot>2*Math.PI&&(camera.lrot-=2*Math.PI),camera.roll+=t/4,camera.roll>Math.PI/4&&(camera.roll=Math.PI/4),e=!0),keys[38]&&(camera.drot+=t,camera.drot>Math.PI/4&&(camera.drot=Math.PI/4)),keys[40]&&(camera.drot-=t,camera.drot<-Math.PI/4&&(camera.drot=-Math.PI/4)),updateView()),lastShoot+=r,keys[32]&&lastShoot>100&&(lastShoot=0,pbullets.length<MAXPBULLETS&&(pbullet={},pbullet.dir=new Float32Array(3),pbullet.dir[0]=camera.view[0],pbullet.dir[1]=camera.view[1],pbullet.dir[2]=camera.view[2],pbullet.startTime=1*startTime,pbullet.x=camera.pos[0]+pbullet.dir[0]*r*2,pbullet.y=camera.pos[1]+pbullet.dir[1]*r*2,pbullet.z=camera.pos[2]+pbullet.dir[2]*r*2,pbullets.push(pbullet),updatePBulletChunks())),e||(camera.roll>0?(camera.roll-=t,camera.roll<0&&(camera.roll=0)):camera.roll<0&&(camera.roll+=t,camera.roll>0&&(camera.roll=0)));var a=.5;keys[87]&&(a=1);var i=BASESPEED*r*a,n=[camera.view[0]*i,camera.view[1]*i,camera.view[2]*i];vec3.add(camera.pos,n);var o=camera.pos[1];camera.pos[1]>18*SIZE&&(camera.pos[1]=18*SIZE);var l=camera.pos[0],u=camera.pos[2];camera.pos[0]>(MAXX-MINX)*SIZE&&(camera.pos[0]=-(MAXX-MINX)*SIZE),camera.pos[0]<-(MAXX-MINX)*SIZE&&(camera.pos[0]=(MAXX-MINX)*SIZE),camera.pos[2]>(MAXZ-MINZ)*SIZE&&(camera.pos[2]=-(MAXZ-MINZ)*SIZE),camera.pos[2]<-(MAXZ-MINZ)*SIZE&&(camera.pos[2]=(MAXZ-MINZ)*SIZE),vec3.add(camera.lookAt,n),camera.lookAt[0]-=l-camera.pos[0],camera.lookAt[1]-=o-camera.pos[1],camera.lookAt[2]-=u-camera.pos[2];var m=camera.pos[0]/SIZE,s=camera.pos[2]/SIZE;if(m>=MINX&&m<MAXX&&s>=MINZ&&s<MAXZ){var c=Math.floor(s-MINZ)*(MAXX-MINX)+Math.floor(m-MINX);camera.pos[1]<terrain[c]*SIZE&&(crashed=!0,camera.pos[1]=(terrain[c]+1)*SIZE);for(var g=-1,h=0;h<enemies.length;h++){var f=enemies[h],d=Math.floor(m),M=Math.floor(s);if(d>=f.x-4&&d<=f.x+4&&M>=f.z-4&&M<=f.z+4&&camera.pos[1]<f.y*SIZE+4*R){g=h;break}}if(-1!=g)enemies.splice(g,1),document.getElementById("score").innerHTML="Score: "+ ++Score,0==enemies.length&&(BASESPEED+=.2,initEnemies()),updateEnemyChunks()}else camera.pos[1]<0&&(crashed=!0,camera.pos[1]=SIZE)}var pbullets=[],MAXPBULLETS=30;function updateBullets(r){for(var e=[],t=0;t<pbullets.length;t++)pbullet.elapsed+=r,pbullet.elapsed>5e3?e.push(t):(pbullet.x=pbullet.x+pbullet.dir[0]*r*2,pbullet.y=pbullet.y+pbullet.dir[1]*r*2,pbullet.z=pbullet.z+pbullet.dir[2]*r*2);if(e.length>0){for(t=0;t<e.length;t++){console.log("Removing bullet");var a=e[t]-t;pbullets.splice(a,1)}updatePBulletChunks()}}var canvas,minimap,startTime=0;function tick(){requestAnimationFrame(tick),updateAndDraw()}function setPerspective(){mat4.perspective(60,gl.viewportWidth/gl.viewportHeight,.1,4096,pMatrix)}var keys={};function handleKeyDown(r){keys[r.keyCode]=!0}function handleKeyUp(r){delete keys[r.keyCode]}document.onkeydown=handleKeyDown,document.onkeyup=handleKeyUp,window.onresize=function(){canvas.width=window.innerWidth,canvas.height=window.innerHeight,gl.viewportWidth=canvas.width,gl.viewportHeight=canvas.height,setPerspective()},canvas=document.getElementById("canvas"),minimap=document.getElementById("minimap"),initGL(canvas),initMinimap(minimap),initShaders(),initArrays(),initTerrain(),initEnemies(),initGroundChunks(),initCloudChunks(),initWaterChunks(),updateEnemyChunks(),initCamera(),gl.clearColor(.8,.8,1,1),gl.enable(gl.DEPTH_TEST),gl.cullFace(gl.BACK),gl.enable(gl.CULL_FACE),setPerspective(),fpsText=document.getElementById("fps"),tick()</script>