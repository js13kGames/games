"use strict";const chars={};chars[PAWN]="♟",chars[PAWN|WHITE]="♙",chars[KING]="♚",chars[KING|WHITE]="♔",chars[KNIGHT]="♞",chars[KNIGHT|WHITE]="♘",chars[ROOK]="♜",chars[ROOK|WHITE]="♖",chars[BISHOP]="♝",chars[BISHOP|WHITE]="♗",chars[QUEEN]="♛",chars[QUEEN|WHITE]="♕",chars[0]="&nbsp;";const clks=["🕐","🕑","🕒","🕓","🕔","🕕","🕖","🕗","🕘","🕙","🕚","🕛"];let i,j,selected,sck,U,pseudo,cl,gId=e=>document.getElementById(e+""),div=gId("m"),inf=gId("i"),clk=gId("clk"),prompt=gId("p"),W=[],user={},ofT=0,WIN=0,clkFn=()=>{clk.textContent=clks[0],clks.push(clks.shift()),user.nextM&&user.nextM<Date.now()+ofT&&(display(),user.nextM=0)};for(setInterval(clkFn,500),i=0;i<8;i++){for(t+="<p>",j=0;j<8;j++)t+='<span id="'+(1+j+20+10*i)+'" class="c"> </span>';t+="</p>"}div.innerHTML=t;let display=(e,s,t,n)=>{for(rClass("s"),rClass("f"),s=0;s<B.length;s++)((t=B[s])||0===t)&&(gId(s).innerHTML=chars[t&~NO_MOVE_OR_PROMOTED]);if(user.c)if((t=gId(user.c)).classList.add("f"),t.appendChild(clk),user.nextM>Date.now()+ofT)rClass("h");else{clk.classList.add("h"),n=getM(user.c);for(let e=0;e<n.length;e++)gId(n[e]).classList.add("s")}else if(user.p)for(s=0;s<startB.length;s++)(t=startB[s])==user.p&&(0===B[s]||B[s]&WHITE^user.p&WHITE)&&gId(s).classList.add("s")},form=e=>{inf.innerHTML=(e||"")+'<p>CHESS ARENA</p><p>Each player move one piece. There is no turn, it\'s realtime!</p><p>BUT you have to wait until each move, few time for pawns, more time for rooks, bishops and knights, even more time for queens.</p><p>Coil members have to wait for half a second less. It\'s not much, but it can be decisive! </p><label>Choose a name : </label> <input type="text" id="pseudo" maxlength="8">';let s=gId("pseudo");s.addEventListener("keydown",(e,t)=>{t=s.value.trim(),"Enter"==e.key&&sck.emit("name",t)})},iOn=()=>{inf.style.visibility=""},iOff=()=>{inf.style.visibility="hidden"},rClass=e=>{[...document.querySelectorAll("."+e)].map(s=>s.classList.remove(e))};window.addEventListener("load",()=>{sck=io({path:location.pathname+"io",upgrade:!1,transports:["websocket"]}),div.onclick=e=>{let s=e.target;s.classList.contains("s")&&sck.emit("move",parseInt(s.id))},sck.on("name",e=>{pseudo=e}),sck.on("board",e=>{B=e.B,W=e.W,e.T&&(ofT=Date.now()-e.T),display()}),sck.on("users",(e,s)=>{for(U=e,s=0;s<U.length;s++)U[s].n==pseudo&&(user=U[s]);display()}),sck.on("msg",(e,s)=>{(s=document.createElement("p")).textContent=e,prompt.appendChild(s)}),sck.on("choose",e=>{cl=e,selPiece()}),sck.on("promote",e=>{selPiece(1)}),sck.on("win",e=>{iOn(),inf.innerHTML="<p>"+e+"</p>",inf.onclick=()=>{selPiece(0,WIN)}}),sck.on("new",()=>{WIN=0}),document.monetization&&document.monetization.addEventListener("monetizationstart",()=>{sck.emit("monetization")}),sck.on("disconnect",()=>{form("<p>Oh no, you have been disconnected!</p>")}),display(),form()},!1);let selPiece=(e,s,t,n,i,o,a)=>{for(n in iOn(),o="<p>"+(e?"Promotion":"You are "+(cl?"WHITE":"BLACK"))+', choose a piece :</p><p id="choose">',t=getFreeP(cl),(e||s)&&(t=Object.assign({},PIECES),e&&(t[PAWN]=0)),t[KING]=0,t)t[n]&&(o+='<span id="'+n+'"'+(e?' data-pr="1"':"")+">"+chars[n|cl]+"</span>");inf.innerHTML=o+"</p>",inf.onclick=(e,s)=>{"SPAN"==(s=e.target).tagName&&("pr"in s.dataset?sck.emit("promote",parseInt(s.id)):sck.emit("piece",parseInt(s.id)),iOff(),inf.onclick=()=>{})}};