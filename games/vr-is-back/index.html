<!doctype html><title>VR is back - js13kGames 2019</title><style>body{overflow:hidden;margin:0}</style><body><script type=module>import*as a from"/2019/webxr/three.js";function D(){this.setSettings=function(e){for(var t=0;t<24;t++)this[String.fromCharCode(97+t)]=e[t]||0;this.c<.01&&(this.c=.01);var i=this.b+this.c+this.e;i<.18&&(this.b*=i=.18/i,this.c*=i,this.e*=i)}}var j=new function(){var N,X,_,Z,J,K,Q,$,ee,te,ie,ne;this._params=new D,this.reset=function(){var e=this._params;Z=100/(e.f*e.f+.001),J=100/(e.g*e.g+.001),K=1-e.h*e.h*e.h*.01,Q=-e.i*e.i*e.i*1e-6,e.a||(ie=.5-e.n/2,ne=5e-5*-e.o),$=1+e.l*e.l*(0<e.l?-.9:10),ee=0,te=1==e.m?0:(1-e.m)*(1-e.m)*2e4+32},this.totalReset=function(){this.reset();var e=this._params;return 3*(((N=e.b*e.b*1e5)+(X=e.c*e.c*1e5)+(_=e.e*e.e*1e5+12))/3|0)},this.synthWave=function(e,t){for(var i,n,o,r,s,a=this._params,l=1!=a.s||a.v,d=a.v*a.v*.1,c=1+3e-4*a.w,f=a.s*a.s*a.s*.1,p=1+1e-4*a.t,u=1!=a.s,D=a.x*a.x,j=a.g,h=a.q||a.r,O=a.r*a.r*a.r*.2,W=a.q*a.q*(a.q<0?-1020:1020),v=a.p?32+((1-a.p)*(1-a.p)*2e4|0):0,U=a.d,w=a.j/2,q=a.k*a.k*.01,y=a.a,x=N,F=1/N,I=1/X,Y=1/_,b=1-(.8<(b=5/(1+a.u*a.u*20)*(.01+f))?.8:b),m=!1,g=0,M=0,k=0,C=0,S=0,L=0,E=0,B=0,z=0,A=0,V=new Array(1024),G=new Array(32),R=V.length;R--;)V[R]=0;for(R=G.length;R--;)G[R]=2*Math.random()-1;for(R=0;R<t;R++){if(m)return R;if(v&&++z>=v&&(z=0,this.reset()),te&&++ee>=te&&(te=0,Z*=$),(Z*=K+=Q)>J&&(Z=J,0<j)&&(m=!0),n=Z,0<w&&(A+=q,n*=1+Math.sin(A)*w),(n|=0)<8&&(n=8),y||((ie+=ne)<0?ie=0:.5<ie&&(ie=.5)),++M>x)switch(M=0,++g){case 1:x=X;break;case 2:x=_}switch(g){case 0:k=M*F;break;case 1:k=1+2*(1-M*I)*U;break;case 2:k=1-M*Y;break;case 3:m=!(k=0)}h&&((o=0|(W+=O))<0?o=-o:1023<o&&(o=1023)),l&&c&&((d*=c)<1e-5?d=1e-5:.1<d&&(d=.1));for(var P=0,H=8;H--;){if(++E>=n&&(E%=n,3==y))for(var T=G.length;T--;)G[T]=2*Math.random()-1;switch(y){case 0:s=E/n<ie?.5:-.5;break;case 1:s=1-E/n*2;break;case 2:s=.225*(((s=1.27323954*(r=6.28318531*(.5<(r=E/n)?r-1:r))+.405284735*r*r*(r<0?1:-1))<0?-1:1)*s*s-s)+s;break;case 3:s=G[Math.abs(32*E/n|0)]}l&&(i=L,(f*=p)<0?f=0:.1<f&&(f=.1),S=u?(S+(s-L)*f)*b:(L=s,0),s=C=(C+((L+=S)-i))*(1-d)),h&&(V[B%1024]=s,s+=V[(B-o+1024)%1024],B++),P+=s}P*=.125*k*D,e[R]=1<=P?32767:P<=-1?-32768:32767*P|0}return t}};window.jsfxr=function(e){j._params.setSettings(e);var e=j.totalReset(),t=new Uint8Array(4*((e+1)/2|0)+44),i=2*j.synthWave(new Uint16Array(t.buffer,44),e);(e=new Uint32Array(t.buffer,0,44))[0]=1179011410,e[1]=36+i,e[2]=1163280727,e[3]=544501094,e[4]=16,e[5]=65537,e[6]=44100,e[7]=88200,e[8]=1048578,e[9]=1635017060,e[10]=i,i+=44;for(var n=0,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r="data:audio/wav;base64,";n<i;n+=3){var s=t[n]<<16|t[n+1]<<8|t[n+2];r+=o[s>>18]+o[s>>12&63]+o[s>>6&63]+o[63&s]}return r};var n,o,O,l,d,r,s,c,f,p,W,u,h,U,i,q,v,e,F,t,w=document.createElement("div"),y=new a.WebGLRenderer({antialias:!0}),I=y.domElement,x=Math.sin,Y=Math.cos,H=Math.floor,b=Math.min,N=Math.max,X=Math.sqrt,_=Math.abs,Z=Math.pow,J=(y.setPixelRatio(window.devicePixelRatio),y.setSize(window.innerWidth,window.innerHeight),y.vr.enabled=!0,w.appendChild(I),document.body.appendChild(w),window.addEventListener("resize",()=>{we.aspect=window.innerWidth/window.innerHeight,we.updateProjectionMatrix(),y.setSize(window.innerWidth,window.innerHeight)},!1),window.addEventListener("vrdisplaypointerrestricted",()=>{I&&"function"==typeof I.requestPointerLock&&I.requestPointerLock()},!1),window.addEventListener("vrdisplaypointerunrestricted",()=>{(c=document.pointerLockElement)&&c===I&&"function"==typeof document.exitPointerLock&&document.exitPointerLock()},!1),document.body.appendChild((F=y,E&&E.referenceSpaceType&&F.vr.setReferenceSpaceType(E.referenceSpaceType),"getVRDisplays"in navigator?((t=document.createElement("button")).style.display="none",oe(t),window.addEventListener("vrdisplayconnect",function(e){ie(e.display)},!1),window.addEventListener("vrdisplaydisconnect",function(){ne()},!1),window.addEventListener("vrdisplaypresentchange",function(e){t.textContent=e.display.isPresenting?"EXIT":"VR"},!1),window.addEventListener("vrdisplayactivate",function(e){e.display.requestPresent([{source:F.domElement}])},!1),navigator.getVRDisplays().then(function(e){0<e.length?ie(e[0]):ne()}).catch(ne),t):((E=document.createElement("a")).href="https://webvr.info",E.innerHTML="NO WEBVR",E.style.left="calc(50% - 90px)",E.style.width="180px",E.style.textDecoration="none",oe(E),E))),jsfxr([0,,.097,.536,.467,.528,,,,,,.543,.641,,,,,,1,,,,,.3])),K=jsfxr([3,,.368,.203,.184,.133,,-.397,,,,,,,,,.426,-.116,1,,,,,.3]),Q=jsfxr([3,,.385,.505,.329,.116,,-.241,,,,,,,,,,,1,,,,,.3]),$=jsfxr([3,,.311,.798,.399,.126,,.215,,,,,,,,,,,1,,,,,.3]),ee=jsfxr([1,,.086,.4,.312,.466,,.484,,,,,,,,.659,,,1,,,,,.4]),te=jsfxr([3,.9,.2,.163,.223,.5,0,.8,.55,.1,0,-.7,-.65,.5,.4,.4,-.75,.4,.8,-.5,.8,.45,-.35,.4]);function ie(e){t.style.display="",t.style.cursor="pointer",t.style.left="calc(50% - 50px)",t.style.width="100px",t.textContent="ENTER VR",t.onmouseenter=function(){t.style.opacity="1.0"},t.onmouseleave=function(){t.style.opacity="0.5"},t.onclick=function(){e.isPresenting?e.exitPresent():e.requestPresent([{source:F.domElement}])},F.vr.setDevice(e)}function ne(){t.style.display="",t.style.cursor="auto",t.style.left="calc(50% - 75px)",t.style.width="150px",t.onmouseenter=null,t.onmouseleave=null,t.onclick=null,t.textContent="NO VR",F.vr.setDevice(null)}function oe(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="rgba(0,0,0,0.1)",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}function re(e){var t=new Audio;t.src=e,t.play(),t.addEventListener("ended",function(e){url.revokeObjectURL(t.src)},!1)}function m(e,t){return g(Math.random(),e,t)}function g(e,t,i){return(i-t)*b(N(e,0),1)+t}function se(e,t,i,n){var o=Y(O),r=x(O);return new a.Vector3(o*t-r*n,i,r*t+o*n)}function ae(e,t){return t.c?(r=new a.MeshPhongMaterial({color:t.c,flatShading:!0,polygonOffset:!1,polygonOffsetFactor:.1,polygonOffsetUnits:.1}),s=new a.Mesh(e,r),t.w&&(s.wire=new a.LineSegments(new a.EdgesGeometry(e),new a.LineBasicMaterial({color:t.w,linewidth:2})),s.add(s.wire))):s=new a.LineSegments(new a.EdgesGeometry(e),new a.LineBasicMaterial({color:t.w,linewidth:2})),void 0!==t.x&&s.position.set(t.x,t.y,t.z),void 0!==t.i&&s.rotation.set(t.i,t.j,t.k),s}function le(e,t){return ae(new a.CubeGeometry(e,e,e),t)}function de(e,t,i,n){var o=document.createElement("canvas"),r=o.getContext("2d");return o.width=e,o.height=t,r.font=n,r.strokeStyle="black",r.textAlign="center",r.fillStyle="white",r.shadowBlur=5,r.shadowColor="black",r.shadowOffsetX=1,r.shadowOffsetY=1,p=new a.Texture(o),(s=new a.Mesh(new a.PlaneGeometry(e/128,t/128,1,1),new a.MeshBasicMaterial({map:p,transparent:!0}))).can=o,s.ctx=r,s.tex=p,s.siz=i,s}function M(e,t){e.ctx.clearRect(0,0,e.can.width,e.can.height),e.ctx.fillText(t,e.can.width/2,.8*e.can.height),e.tex.needsUpdate=!0}function ce(){var e=new a.Object3D;return(s=ae(new a.CylinderBufferGeometry(.01,.01,.5,7,4),{c:2139305,w:4232345})).position.set(0,.06,0),s.updateMatrix(),e.add(s),(s=ae(function(e){var t=[],i=[],n=[];for(C=0;C<e.faces.length;C++){L=i.length,d=e.faces[C];var o=e.vertices[d.a],r=e.vertices[d.b],s=e.vertices[d.c],o=(i.push(o.clone(),r.clone(),s.clone(),function(e,t){for(c of(l=new a.Vector3(0,0,0),e))l.x+=c.x,l.y+=c.y,l.z+=c.z;return l.x*=t/=e.length,l.y*=t,l.z*=t,l}([o,r,s],3*C%4==0?2.5:1)),d.a=L,d.b=L+1,d.c=L+2,(new a.Face3).copy(d)),r=(new a.Face3).copy(d),s=(new a.Face3).copy(d);o.a=L+3,r.b=L+3,s.c=L+3,t.push(o,r,s),h=[e.faceVertexUvs[0][C][0],e.faceVertexUvs[0][C][1],e.faceVertexUvs[0][C][2]],n.push(h,h,h)}return e.vertices=i,e.vertices[i.length-1]=new a.Vector3(0,0,0),e.faces=t,e.faceVertexUvs[0]=n,e}(new a.IcosahedronGeometry(.08,1)),{c:2139305,w:4232345})).position.set(0,.35,0),s.updateMatrix(),s.geometry.computeVertexNormals(),e.add(s),e.rotation.set(-.8,0,0),e.pivot=s,e}function fe(e,t){return U=e.x-t.x,X(U*U+(i=e.y-t.y)*i+(q=e.z-t.z)*q)}function pe(){var i={v:[],i:0};for(C=0;C<20;C++)i.v.push(0);return i.add=e=>{var t=0;for(i.old?t=_(i.old.set(e.x-i.old.x,e.y-i.old.y,e.z-i.old.z).length()):i.old=new a.Vector3,i.old.set(e.x,e.y,e.z),i.v[i.i]=t,i.i=(i.i+1)%20,C=i.vel=0;C<20;C++)i.vel+=i.v[C];i.vel*=5},i}function ue(){this.userData.isSelecting=!0}function he(){this.userData.isSelecting=!1}var ve=new a.Clock,k=new a.Scene,we=new a.PerspectiveCamera(90,window.innerWidth/window.innerHeight,.1,1e4),ye=(k.background=new a.Color(3089227),k.add(we),(w=new a.HemisphereLight(16777215,2036539,1.5)).position.set(0,.2,-1).normalize(),k.add(w),(w=new a.IcosahedronBufferGeometry(200,3)).attributes),xe=ye.position;for(w.addAttribute("color",new a.BufferAttribute(new Float32Array(3*xe.count),3)),C=0;C<xe.count;C++)ye.color.setXYZ(C,1,xe.getY(C)/200+.7,.5);for((s=new a.Mesh(w,new a.MeshBasicMaterial({vertexColors:a.VertexColors}))).position.set(0,150,-1e3),k.add(s),xe=(ye=(w=new a.BoxBufferGeometry(5e3,300,5)).attributes).position,w.addAttribute("color",new a.BufferAttribute(new Float32Array(3*xe.count),3)),C=0;C<xe.count;C++)i=xe.getY(C)/300+.7,ye.color.setXYZ(C,g(i,1,.18),g(i,.04,.14),g(i,.5,.3));(s=new a.Mesh(w,new a.MeshBasicMaterial({vertexColors:a.VertexColors}))).position.set(0,100,-1e3),k.add(s);for(var be=[],me=[],ge=[],Me=[],C=0;C<=100;C++)for(v=0;v<100;v++)Me.push(m(0,2)-20+30*Y(C/20+.6)+(100-v)/2+1.5*Y(C/4.7)+2*Y(v/3.5));for(C=30;C<70;C++)for(v=20;v<60;v++)i=Me[e=v+100*C],f=Me[e+1],p=Me[e+100],W=Me[e+101],L=15*C-750,h=(1-(r=15*v-750))/400+.3,be.push(L,i,r),be.push(L,f,r+15),me.push(h,.1,.8-h/4),me.push(h,.1,.8-h/4),be.push(L,i,r),be.push(L+15,p,r),me.push(h,.1,.8-h/4),me.push(h,.1,.8-h/4),ge.push(L,i-.1,r),ge.push(L,f-.1,r+15),ge.push(L+15,W-.1,r+15),ge.push(L,i-.1,r),ge.push(L+15,W-.1,r+15),ge.push(L+15,p-.1,r);function ke(e,t){return Ce=1e4*x(Ce),(.5*x(Ce)+.5)*(t-e)+e}(w=new a.BufferGeometry).addAttribute("position",new a.Float32BufferAttribute(be,3)),w.addAttribute("color",new a.Float32BufferAttribute(me,3)),w.v=be,w.c=me,s=new a.LineSegments(w,new a.LineBasicMaterial({vertexColors:a.VertexColors})),k.add(s),(w=new a.BufferGeometry).addAttribute("position",new a.Float32BufferAttribute(ge,3)),s=new a.Mesh(w,new a.MeshLambertMaterial({flatShading:!0})),k.add(s);for(var Ce,S=new a.Geometry,L=(Ce=5,150),C=0;C<L;C++)v=_(e=C*(h=500)*2/L-h),f=ke(25,35+_(e)/10),q=ke(-400,-650)+v/2,(s=new a.Mesh(new a.CubeGeometry(f,f,f))).position.set(e,ke(0,40)+v/4-q/5-160,q),s.rotation.set(0,ke(.2,5),ke(2,2.5)),s.updateMatrix(),S.merge(s.geometry,s.matrix);for(k.add(ae((new a.BufferGeometry).fromGeometry(S),{c:3089227,w:15875210})),w=new a.Geometry,C=0;C<4e3;C++)var Se=1e3;O=m(0,6.28),E=m(0,6.28),u=new a.Vector3(Se*Y(O)*x(E),Se*x(O)*x(E),Se*Y(E)),w.vertices.push(u),S=new a.Points(w,new a.PointsMaterial({size:.1,color:13421772})),k.add(S),E=ce(),B=ce(),(n=y.vr.getController(0)).userData.id=0,n.pivot=E.pivot,n.pos=new a.Vector3,n.avgvel=pe(),n.addEventListener("selectstart",ue),n.addEventListener("selectend",he),n.add(E),k.add(n),(o=y.vr.getController(1)).userData.id=1,o.pivot=B.pivot,o.pos=new a.Vector3,o.avgvel=pe(),o.addEventListener("selectstart",ue),o.addEventListener("selectend",he),o.add(B),k.add(o),B=(E=document.createElement("canvas")).getContext("2d"),E.width=1024,E.height=256,B.shadowBlur=10,B.shadowColor="black",B.shadowOffsetX=3,B.shadowOffsetY=3,(w=B.createLinearGradient(0,0,0,E.height)).addColorStop(.09,"#40c4c9"),w.addColorStop(.16,"#ffffff"),w.addColorStop(.17,"#444444"),w.addColorStop(.25,"#f157cb"),w.addColorStop(.27,"#fbc3ff"),B.font="Bold 72px Verdana",B.strokeStyle="white",B.fillStyle=w,B.lineWidth=3,p="VIRTUAL REALITY",B.strokeText(p,135,70),B.fillText(p,135,70),B.rotate(-.25),(w=B.createLinearGradient(0,0,2.2*E.width,3*E.height)).addColorStop(.51,"#ffffff"),w.addColorStop(.62,"#ffffff"),B.font="64px Courier New",B.fillStyle=w,B.strokeStyle="black",B.lineWidth=3,B.textDecoration="underline overline",B.strokeText("is back",640,300),B.fillText("is back",640,300),(p=new a.Texture(E)).needsUpdate=!0;var E,B,Le=s=new a.Mesh(new a.PlaneGeometry(7,1.75,1,1),new a.MeshBasicMaterial({map:p,transparent:!0})),Ee=(Le.position.set(0,3.7,-6),k.add(Le),de(512,64,40,"20px Courier New")),z=(Ee.position.set(0,.2,-6),k.add(Ee),M(Ee,"A 8k WebVR game by @jordi_ros"),de(512,64,40,"40px Tahoma")),Be=(z.position.set(0,2.2,-6),k.add(z),M(z,"Press trigger to start"),de(512,64,40,"Bold 40px Tahoma")),ze=(Be.position.set(-3,2.7,-6),Be.rotation.set(0,.6,0),k.add(Be),de(512,64,48,"Bold 48px Tahoma")),A=(ze.position.set(0,2.7,-6),k.add(ze),de(512,64,32,"32px Tahoma")),V=(A.position.set(-3,2.4,-5.9),A.rotation.set(0,.6,0),k.add(A),de(512,64,40,"Bold 40px Tahoma"));V.position.set(3,2.7,-6),V.rotation.set(0,-.6,0),k.add(V),M(V,"MISS!");var Ae,G,Ve,R,Ge,Re,Pe,P,Te=[],De=[],je=[],T=0,Oe=0;for(C=0;C<80;C++)S=le(.3,{c:2139305,w:2139305}),De.push(S),k.add(S),S.visible=!1;for(C=0;C<300;C++)S=le(1,{c:1,w:1}),je.push(S),k.add(S),S.visible=!1;function We(e){1==Oe&&(Ae-=.15,Re=T,Ge=2<=R?T:-1,R=1,re(te)),Ue(e)}function Ue(e){Te.splice(Te.indexOf(e),1),e.visible=!1}function qe(){for(s of Te){var e,t,i;s.tposy+=2*P,void 0===s.sx?(s.rotation.z+=1.26*P,s.rotation.x+=.78*P,s.rotation.y+=1.92*P,s.position.x+=P*s.vel.x,s.position.y=g(Math.pow(1.5*s.tposy,2),-1,s.posy),s.position.z+=P*s.vel.z,1==Oe&&(e=0,n&&o?(fe(s.position,n.pos)<.6&&(e=b(n.avgvel.vel,10)/10),fe(s.position,o.pos)<.6&&(e=b(o.avgvel.vel,10)/10)):-3<s.position.z&&(m(0,1)<g(G,.95,.3)?e=m(.05,1):We(s)),0<e)&&function(e,t){for(1==Oe&&(Ae=b(1,Ae+(.8<t?.05:.5<t?.02:.01)),Ve+=H(.8<t?150*t:100*t)*H(R)*10,r=b(8,R+.25*t),H(r)>H(R)&&(Ge=T,re(ee)),R=r,re(.8<t?$:.5<t?Q:K)),c=e.position,L=H(.8<t?15:.5<t?8:3),Ue(e),v=0;v<L;v++){for(e=null,C=0;C<je.length;C++)if(!je[C].visible){(e=je[C]).visile=!0;break}if(!e)return;f=m(g(t,.35,.08),g(t,.4,.13)),e.position.set(c.x,c.y,c.z),e.scale.set(f,f,f),e.sc=f,e.sd=m(.7,1.3),e.sx=m(-4,4)*g(t,.2,1),e.sz=m(-12,-4)*g(t,.4,1),e.sy=m(-3,5)*g(t,.2,1),e.vel=t,e.visible=!0,Te.push(e)}}(s,e),1<s.position.z&&We(s)):(f=s.sd*s.sc,s.rotation.z+=1.76*P,s.rotation.x+=2.18*P,s.rotation.y+=2.42*P,s.position.x+=P*s.sx,s.position.y+=P*s.sy,s.position.z+=P*s.sz,s.scale.set(f,f,f),f=Z(s.sd,4),e=.8<s.vel?1:.14,t=.8<s.vel?1:.74,i=.8<s.vel?1:.76,d=.8<s.vel?1.2:.7,u=.8<s.vel?1.2:1,s.material.color.setRGB(g(f,1,e)*d,g(f,.05,t)*d,g(f,.5,i)*d),s.wire.material.color.setRGB(g(f,1,e)*u,g(f,.05,t)*u,g(f,.5,i)*u),s.sy-=9.8*P,s.sd-=P,s.sd<.1&&Ue(s))}}y.setAnimationLoop(function(){switch(P=b(ve.getDelta(),.05),T+=P,Oe){case 0:Le.visible=!0,z.visible=!0,Ee.visible=!0,ze.visible=!1,Be.visible=!1,A.visible=!1,V.visible=!1,z.material.opacity=.6+.4*x(.005*(new Date).getTime()),(n&&n.userData.isSelecting||o&&o.userData.isSelecting||!n&&!o&&5<T)&&(Ae=.5,Ve=G=T=0,Re=Ge=-(R=Oe=1),Pe=1,Le.visible=!1,z.visible=!1,Ee.visible=!1,re(J));break;case 1:if(Be.visible=!0,M(Be,Ve),A.visible=!0,M(A,"x"+H(R)),f=g(3*(T-Ge),1.5,1),A.scale.set(f,f,f),V.visible=T-Re<1,V.material.opacity=g(2*(T-Re-.5),1,0),f=g(3*(T-Re),1.5,1),V.scale.set(f,f,f),Pe+=P,G=b(1,T/120),0<Pe){for(S=null,C=0;C<De.length;C++)if(!De[C].visible){(S=De[C]).visible=!0;break}S&&(O=m(-.4,.4),u=se(0,m(-1,1)*g(G,.9,1.2),m(1,2.2),g(G,-30,-18)),S.position.set(u.x,u.y,u.z),S.vel=se(0,0,0,g(G,12,25)),S.tposy=0,S.posy=u.y,k.add(S),Te.push(S)),Pe=m(g(G,-.4,-.2),g(G,-1,-.35))}n&&o&&(n.pivot.getWorldPosition(n.pos)&&n.avgvel.add(n.pos),o.pivot.getWorldPosition(o.pos))&&o.avgvel.add(o.pos),qe(),Ae<0&&(Oe=2,T=0);break;case 2:Le.visible=!1,z.visible=!0,ze.visible=!0,Be.visible=!1,A.visible=!1,V.visible=!1,z.material.opacity=1,M(z,"GAME OVER"),M(ze,Ve),qe(),(n&&n.userData.isSelecting||o&&o.userData.isSelecting||!n&&!o&&5<T)&&(Oe=0)}y.render(k,we)})</script>