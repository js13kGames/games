<!doctype html><meta name=viewport content="width=device-width"><title>Canon Defense - js13kGames 2012</title><style>body{background:silver;margin:0;padding:0;width:100%;height:100%}canvas{background:#000;margin:0 auto;display:block}</style><body><script>function t(t,i){var s=this;this.canvas=t,this.ctx=i,this.width=t.width,this.height=t.height,this.mouse={x:this.width/2,y:0},this.bullets=[],this.enemies=[],this.currentLevel=0,this.levels=[{bulletsTimeout:400,enemiesTimeout:600,startEnemies:30,enemies:30}],this.tower=new e(this.width/2,this.height,10,20,"rgb(0,0,0)"),this.viewfinder=new h(0,0,20,20,"rgb(0,0,0)"),this.enemiesToClean=this.toClean=0,this.addEnemy=1,this.score=0,this.lifes=3,this.beforeStart=!0,this.tweetHandler=!1,this.bulletsTimeout=400,function t(){s.addBullet=!0,s.bulletsTimeout-=.1,setTimeout(t,s.bulletsTimeout)}(),this.enemiesTimeout=600,function t(){s.addEnemy=!0,s.enemiesTimeout-=.9,setTimeout(t,s.enemiesTimeout)}()}function e(t,e,i,s,h){this.x=t||0,this.y=e||0,this.w=i||1,this.h=s||1,this.fill=h||"#AAAAAA"}function i(t,e,i,s,h,l){this.x=t||0,this.y=e||0,this.w=i||1,this.dx=s||.5,this.dy=h||.5,this.speed=5,this.fill=l||"#AAAAAA"}function s(t,e,i,s,h){this.x=t||0,this.y=e||0,this.w=i||1,this.h=s||1,this.live=!0,this.opacity=1,this.toRemove=!1,this.fill=h||"rgba(0,245,245, 0.1 )",this.spriteX=0;var l=this;setInterval(function(){l.spriteX=l.spriteX?0:16},560)}function h(t,e,i,s,h){this.x=t||0,this.y=e||0,this.w=i||1,this.h=s||1,this.fill=h||"#AAAAAA"}var l,o,n;function r(t){t.preventDefault(),n.mouse=n.getMouse(t),n.addBullet=!0}t.prototype.startFactories=function(){},(t.prototype.image=new Image).src="data:image/  png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QAAAAAAAD5Q7t/AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3AkLDSMPVfdqJwAAAWRJREFUOMttk79rwlAQxz9B5UEEFwmCZigGMhQydyiEjkKhf1P/HbeOmfo3FC2CgpkMFDIIAVOC2nSwl96L3vbuvbv7/rjnHA5v9XZXkaU5k6lH4Btcd4BEWRZsdxWBb9juqiYvZ2exntf6UjeSQmkozbI0B2Ay9ei8PD+9njqGwDfsizOPD3eMhn2Ox4p9cebz44vvHxgN+/R6htGwz3hsOHUMWZrj1PV7LZ11BL4BuJnXlJzFel5naU4c+xY8gDj2AXDdAUmyas6SA+gKF4Ao9Kzp+uFsdm8hKcsCwKYgha47sAQTUdt3AI7YKNNvqa1RiivyxrIxS3MLqsDU6DSthkKSrJop7YUqy6IpWG5ya6Gi0Ls0WG7yK+v0Qz29bauzWM/rKPSsSRq+LrxlcTfwDf8ILsKIoHqaXl+txdVfaG+bjraFzSK14YH3d/Zaol2aRCEN5W4bnqgvumgK4pA4UJYFvxvMELAqKY7sAAAAAElFTkSuQmCC",t.prototype.clear=function(){this.ctx.fillStyle="rgb(245,245,245)",this.ctx.fillRect(0,0,255,255)},t.prototype.tile=function(){for(x=0;x<=this.width;x+=16)for(y=0;y<=this.width;y+=16)this.ctx.drawImage(this.image,x,y)},t.prototype.draw=function(){var t=this;if(this.beforeStart)this.clear(),this.drawSplash(this.ctx),this.canvas.addEventListener("click",function(){t.blockClick||(t.beforeStart=!1)});else if(this.lifes<1)this.clear(),this.drawResult(this.ctx),this.tweetHandler||(this.canvas.addEventListener("click",function(){window.open("https://twitter.com/share?url="+encodeURIComponent(location.href)+"&text="+encodeURIComponent("Just ended canon defense! My score is: "+t.score+". Try the game at: "),"_blank")}),this.tweetHandler=!0);else{this.addBullet&&(e=n.tower.getDiffs(this.mouse),n.bullets.push(new i(n.tower.x+20*e.dx,n.tower.y+20*e.dy,5,e.dx,e.dy,"rgba(0, 0, 0, 1)")),this.addBullet=!1),(e=this.levels[this.currentLevel]).enemies&&this.addEnemy&&(h=Math.floor(Math.random()*(this.width-26))+2,n.enemies.push(new s(h,0,26,32,"rgba(125, 50, 50, 1)")),this.addEnemy=!1,e.enemies--);var e,h,l=(h=this.enemies)&&h.length?h.length:0,o=this.bullets,r=o&&o.length?o.length:0,a=!1;if(l&&r)for(var f=0;f<l;f++){var c=h[f];if(c&&c.live)for(var A=0;A<r;A++)if(p=o[A]){a=!1;var u=c.y+c.h,d=p.y-p.w,y=(c.y<p.y+p.w&&d<u&&(a=!0),u=c.x,d=c.x+c.w,p.x-p.w),p=p.x+p.w;if(a&&u<p&&y<d){h[f].kill(),o[A]=!1,this.enemiesToClean++,this.toClean++,this.score++;break}}}for(this.tile(),f=0;f<l;f++)!(c=h[f])||c.y>this.height?(c&&this.lifes--,h[f]=!1,this.enemiesToClean++):(h[f].draw(this.ctx,f),c.toRemove&&(h[f]=!1,this.enemiesToClean++));for(f=0;f<r;f++)!(l=o[f])||l.x>this.width||l.y>this.height||l.x+l.w<0||l.y+l.h<0||l.offset>this.height?(o[f]=!1,this.toClean++):o[f].draw(this.ctx,f);this.drawInfo(this.ctx),this.tower.draw(this.ctx,this.mouse),this.viewfinder.draw(this.ctx,this.mouse),2<this.toClean&&(this.bullets=o.filter(function(t){return t}),this.toClean=0),0<this.enemiesToClean&&(this.enemies=h.filter(function(t){return t}),this.enemiesToClean=0),e.enemies||this.enemies.length||this.changeLevel()}},t.prototype.changeLevel=function(){var t=this,e=(this.enemies=[],this.bullets=[],this.currentLevel++,this.beforeStart=!0,this.levels[this.currentLevel]||(this.levels[this.currentLevel]=this.levels[this.currentLevel-1],this.levels[this.currentLevel].enemiesTimeout-=50,this.levels[this.currentLevel].bulletsTimeout-=25,this.levels[this.currentLevel].enemies=this.levels[this.currentLevel].startEnemies+=10),this.levels[this.currentLevel]);this.bulletsTimeout=e.bulletsTimeout,this.enemiesTimeout=e.enemiesTimeout,this.blockClick=!0,setTimeout(function(){t.blockClick=!1},200)},t.prototype.drawInfo=function(t){t.fillStyle="red",t.font="bold 30pt Calibri",t.fillText(Array(this.lifes+1).join("â™¥"),20,this.height-10),t.fillStyle="rgba(0,0,0, 0.9)",t.font="bold 14pt Calibri",t.fillText("SCORE: "+this.score,this.width/2+20,this.height-10),t.fillStyle="rgba(0,0,0, 0.6)",t.font="bold 12pt Calibri",t.fillText("Level: "+(this.currentLevel+1)+" wave:"+this.levels[this.currentLevel].enemies,10,14)},t.prototype.drawResult=function(t){t.fillStyle="red",t.font="italic 30pt Calibri",t.fillText("GAME OVER!",10,90),t.font="italic 20pt Calibri",t.fillText("Killed: "+this.score,70,140),t.fillStyle="blue",t.font="italic 15pt Calibri",t.fillText("Click to tweet your score!",20,180),t.font="italic 10pt Calibri",t.fillText("Refresh to play again :)",60,200)},t.prototype.drawSplash=function(t){0==this.currentLevel?(t.fillStyle="black",t.font="bold 20pt Calibri",t.fillText("Click or tap to start!",10,100)):(t.fillStyle="black",t.font="bold 18pt Calibri",t.fillText("Click or start level: "+(this.currentLevel+1),10,100)),t.font="13pt Calibri",t.fillText("Tip: click or tap for instant fire",10,200)},t.prototype.getMouse=function(t){var e=l,i=0,s=0;if(void 0!==e.offsetParent)for(;i+=e.offsetLeft,s+=e.offsetTop,e=e.offsetParent;);return t=t.targetTouches&&t.targetTouches[0]?(e=t.targetTouches[0].pageX-i,t.targetTouches[0].pageY-s):(e=t.pageX-i,t.pageY-s),{x:e,y:t}},e.prototype.getRotate=function(t){return t=Math.atan((t.x-this.x)/(t.y-this.y)),2*-Math.PI-t},e.prototype.getDiffs=function(t){var e=t.x-this.x,i=(t=t.y-this.y,Math.sqrt(e*e+t*t));return{dx:e/i,dy:t/i}},e.prototype.draw=function(t,e){t.save(),t.fillStyle=this.fill,o.beginPath(),o.arc(this.x,this.y,10,0,2*Math.PI,!0),o.closePath(),o.fill(),void 0!==e&&(e=this.getRotate(e),t.translate(this.x,this.y),t.rotate(e),t.fillRect(0-this.w/2,0-this.h,this.w,this.h)),t.restore()},i.prototype.draw=function(t){t.fillStyle=this.fill,t.beginPath(),t.arc(this.x,this.y,this.w,0,2*Math.PI,!0),t.closePath(),t.fill(),this.updatePosition(t)},i.prototype.updatePosition=function(){this.x+=this.dx*this.speed,this.y+=this.dy*this.speed},(s.prototype.image=new Image).src="data:image/  png;base64,iVBORw0KGgoAAAANSUhEUgAAAB0AAAAQCAYAAADqDXTRAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3AkLCTIxwEb8QAAAAmBJREFUOMudlE1IVFEUx3+j06uwGcZx4lWKTPjRCANJECK4yaIx2rdwE1SMtXUR4iIkQVy1VikhhAJX7lJR2wjuaoSBKe3j+dCmIedpyjA61rwWcq9vxvdy9L963Ht+53/PPeddF0UKBlrN4jVtfcFFiSqFdxcDzbX3AFC99aS2vogtsxTjUnn50XSpw7xyISIBIQF+/jlF4seko/FxeFlpNvcbgBevJwH4/nWTy3U+ALrvd8h9J52IDwZazdmJFtPoD5iq32fefXrdVP0+0+gPmLMTLaZdr07KuwQQCffybuMB7Y+vAlDTUMXqchqAuaFFrpX3EtPHbYdK9PLD3wFH/k7lKFPxAbT1BVdZAbzTydzQIgAfp79JILjTWdAnO6ne+v/yVrnEKY2Mhr8iiJHR0M68KTiIvyIoE4vTWquMhHvlwDjxIn9MH983ffUyT9/gElW5ZxIUEoE9PVvcjtTQfmPrkOncey/TU6sMDnoRBVh5gLTynL6eRh4+KsOthHTGkk2sZN1UlRcGWrXaHGY0BUooDvMH60pIZzTVBs0+QHfkV7JuxpIelFDi4JfZW1ExVM0ROqlE1XsplYLpbWyrNrfjlTSoN+X9AzRdvCV7FdPHUUI6S/Nrh6a3sa3azH2qxfoaJZIzsgAjo7GcmsUT3mBpfm1/eq2JrP1IJGdQvfVycu0MresiVhgW5xNx8nqTm/EuYBjgtNsjA8+dest5j0I+nwaIAiM2vtF8PsbO7hN+befQ03VyY/fPtjV/wdsbdepJrf/sMIBuZLssy1bj6BGxxRpx2cFHyLbS47D/AIU9UjYGM5rlAAAAAElFTkSuQmCC",s.prototype.kill=function(){this.live=!1;var t=this;setTimeout(function(){t.toRemove=!0},500)},s.prototype.draw=function(t){this.live?(t.fillStyle=this.fill,t.drawImage(this.image,this.spriteX,0,13,16,this.x,this.y,this.w,this.h),this.y+=1):(t.save(),t.scale(2,1),0<this.opacity&&(this.opacity-=.01),t.fillStyle="rgba(255,100,100,"+this.opacity+" )",t.beginPath(),t.arc((this.x+this.w/2)/2,this.y+this.h,this.w/4,0,2*Math.PI,!0),t.closePath(),t.fill(),t.restore())},h.prototype.draw=function(t,e){void 0!==e&&(t.strokeStyle=this.fill,o.beginPath(),o.arc(e.x,e.y,this.w,0,2*Math.PI,!0),o.closePath(),o.stroke())},(l=document.createElement("canvas")).width=256,l.height=256,o=l.getContext("2d"),n=new t(l,o),document.body.appendChild(l),l.addEventListener("click",r,!0),l.addEventListener("touchstart",r,!0),l.addEventListener("mousemove",function(t){t.preventDefault(),n.mouse=n.getMouse(t)},!0),l.addEventListener("touchmove",function(t){t.preventDefault(),n.mouse=n.getMouse(t)},!0),function t(e){window.requestAnimationFrame(t),n.draw(e)}()</script>