<!doctype html><title>Deathkeeper</title><script src=/2022/webxr/babylon.js></script><style>body,html{overflow:hidden;width:100%;height:100%;margin:0;padding:0}#c{width:100%;height:100%;touch-action:none}</style><canvas id=c></canvas><script>var MR=Math.random,BC3=BABYLON.Color3;class Ambience{outputGain;context;started=!1;initialized=!1;resume(){this.initialized&&this.context.resume()}pause(){this.initialized&&this.context.suspend()}async start(){if(this.initialized)return void this.resume();this.initialized=!0,this.context=new AudioContext;const e=this.context.createScriptProcessor(1024,1,1);e.addEventListener("audioprocess",(e=>e.outputBuffer.getChannelData(0).forEach(((e,t,s)=>s[t]=2*MR()-1))));const t=this.context.createIIRFilter([.049922035,-.095993537,.050612699,-.004408786],[1,-2.494956002,2.017265875,-.5221894]);this.outputGain=this.context.createGain();const s=this.context.createBiquadFilter();e.connect(t),t.connect(s),s.connect(this.outputGain),s.frequency.value=50,s.type="lowpass",s.Q.value=5,setInterval((()=>{s.frequency.exponentialRampToValueAtTime(400*MR()+50,this.context.currentTime+2)}),2e3),s.frequency.exponentialRampToValueAtTime(250,this.context.currentTime+2),this.outputGain.gain.value=.8,this.outputGain.connect(this.context.destination)}}var ambience=new Ambience;class Soundfx{InitAudio(){if(this.init)return;this.init=!0;let e=BABYLON.Engine.audioEngine.audioContext.createBuffer(1,96e3,48e3);const t=e.getChannelData(0);for(let e=96e3;e--;)t[e]=this.hit(e);this.hitSound=new BABYLON.Sound("hit",e)}hit(e){let t=3e4;if(e>t)return null;let s=Math.pow((t-e)/t,3.1),a=Math.atan(e/1e3-Math.sin(e/331)*Math.sin(e/61)+66*Math.sin(Math.sin(e/59)/39))*(t-e)/t,i=Math.sin(Math.tan(.001*e)*(MR()/2))*Math.sin(9e-4*e)*s*a;return Math.cos(3e-4*e+Math.PI/2)*i*3}}var sfx=new Soundfx;class Level{}class Entity{constructor(e,t){this.id=e,this.secs=t}get(e){return this.secs.entitiesToComponents[this.id][e.name]}add(e){var t=e.constructor.name;this.secs.componentsToEntities[t]||(this.secs.componentsToEntities[t]=[]),this.secs.entitiesToComponents[this.id][t]=e,this.secs.componentsToEntities[t][this.id]=!0}kill(){for(var e in delete this.secs.entities[this.id],delete this.secs.entitiesToComponents[this.id],this.secs.componentsToEntities)delete this.secs.componentsToEntities[e][this.id]}}class Secs{nextID=0;entities=[];entitiesToComponents=[];componentsToEntities={};system={};registerSystems(e){e.forEach((e=>{var t=e.constructor.name;this.system[t]=e}))}createEntity(e){var t=this.nextID++,s=new Entity(t,this);return this.entities[t]=s,this.entitiesToComponents[t]={},e&&e.forEach((e=>{s.add(e)})),s}match(e){return Object.keys(this.componentsToEntities[e.name]||[]).map((e=>this.entities[e]))}}let secs=new Secs;class Sk{}class Spawner{isSpawning;interval;constructor(e,t,s,a=0){this.scene=e,this.basemesh=t,this.interval=s,this.prestartDelay=a,this.basemesh.setEnabled(!1)}start(){this.isSpawning=!0,this._timeout=setTimeout((()=>{this._t=setTimeout((()=>this.spawn(!0)),this.interval)}),this.prestartDelay)}spawn(e=!1){let t=secs.match(Grave).map((e=>e.get(Grave))).filter((e=>e.occupied));if(e&&(window.app.totalSks=t.length),0==t.length)return void this.stop();let s=t[Math.floor(MR()*t.length)];if(s){s.occupied=!1;var a=this.basemesh.createInstance("sk"+ +new Date);a.parent=window.app.enemyP;let e=a.getAnimationByName("Rise"),t=a.getAnimationByName("Walk");this.scene.beginDirectAnimation(a,[e],0,100,!1),setTimeout((()=>{this.scene.beginDirectAnimation(a,[t],0,100,!0,.97+.6*MR())}),1e3),a.position.copyFrom(s.grave.position),a.position.z-=1.7,a.lookAt(new BABYLON.Vector3(0,0,0)),a.setEnabled(!0),a.billboardMode=BABYLON.Mesh.BILLBOARDMODE_Y,a.entity=secs.createEntity([new MeshEntity(a),new AIController(MR()/50+.15),new EnemyEntity]),secs.system.ShadowSystem.add(a)}if(this.isSpawning){var i=50*t.length+-Math.log(MR())*t.length*40;setTimeout((()=>this.spawn()),i)}}stop(){this.isSpawning=!1,clearTimeout(this._timeout),clearInterval(this._t)}}class AIController{constructor(e){this.speed=e}update(e,t){let s=t.get(MeshEntity).mesh;s.lookAt(window.app.camera.position);const a=s.position.subtract(window.app.camera.position).normalize();s.translate(new BABYLON.Vector3(a.x,0,a.z),-this.speed/e,BABYLON.Space.LOCAL),s.position.y=0,s.intersectsMesh(window.app.camCol)&&window.app.changeState(3)}}class CollisionCheck{constructor(e){this.ray=e}check(e){var t=secs.match(EnemyEntity).map((e=>e.get(MeshEntity))).map((e=>e.mesh)),s=this.ray.intersectsMeshes(t);if(s.length){s[0].pickedMesh.entity.kill(),s[0].pickedMesh.dispose(),sfx.hitSound.play(),window.app.score++;const t=BABYLON.ParticleHelper.CreateDefault(s[0].pickedPoint,500);t.createDirectedCylinderEmitter(.32,.64,1,new BABYLON.Vector3(.5*e.direction.x,.5*e.direction.y,.5*e.direction.z),new BABYLON.Vector3(1.5*e.direction.x,1.5*e.direction.y,1.5*e.direction.z));const i=new BABYLON.DynamicTexture("name",{width:5,height:5});var a=i.getContext();return a.fillStyle="#fff",a.fillRect(0,0,5,5),i.update(),t.particleTexture=i,t.emitRate=2500,t.targetStopDuration=.1,t.disposeOnStop=!0,t.minEmitPower=.1,t.maxEmitPower=4e3*e.speed,t.color1=BABYLON.Color4.FromHexString("#d2d1b4"),t.color2=BABYLON.Color4.FromHexString("#acb38c"),t.colorDead=BABYLON.Color4.FromHexString("#41452e"),t.minSize=1/16/2,t.maxSize=1/16,t.gravity=new BABYLON.Vector3(0,-9.81,0),t.blendMode=BABYLON.ParticleSystem.BLENDMODE_STANDARD,t.start(),window.app.nextLevel(),!0}}}class ControllerInput{constructor(e){this.handedness=e}}class EnemyEntity{}class Grave{occupied=!0;constructor(e){this.grave=e}}class MeshEntity{constructor(e){this.mesh=e}}class ShadowCaster{constructor(e){}}class InputSystem{xrControllers=[];lastPosition={};data={};controllers(e,t){this.xrControllers&&this.xrControllers.forEach((s=>{this.handleController(e,s),this.trackDirection(e,s,t)}))}handleController(e,t){var s=e.get(ControllerInput);if(t.inputSource.handedness==s.handedness){var a=e.get(MeshEntity).mesh;a.position.copyFrom(t.grip.position),a.rotationQuaternion=t.grip.rotationQuaternion,a.rotate(BABYLON.Vector3.Right(),Math.PI/2);var i=e.get(CollisionCheck);if(i&&i.check(this.data[s.handedness]))try{let e=t.inputSource.gamepad.hapticActuators[0];e&&e.pulse(1,100)}catch(e){}1!=t.inputSource.gamepad.buttons[0].value||this.triggerPressed?.5>t.inputSource.gamepad.buttons[0].value&&this.triggerPressed&&(this.triggerPressed=!1):(this.triggerPressed=!0,window.app.gotTrigger())}}trackDirection(e,t,s){var a=e.get(ControllerInput);if(t.inputSource.handedness==a.handedness)if(this.lastPosition[a.handedness]){var i=BABYLON.Vector3.Distance(this.lastPosition[a.handedness],t.grip.position),n=t.grip.position.subtract(this.lastPosition[a.handedness]).normalize(),r=i/s;this.data[a.handedness]={speed:r,direction:n},this.lastPosition[a.handedness].copyFrom(t.grip.position)}else this.lastPosition[a.handedness]=new BABYLON.Vector3(0,0,0)}}class ShadowSystem{constructor(e){this._shadowGenerator=new BABYLON.ShadowGenerator(1024,e)}add(e){this._shadowGenerator.addShadowCaster(e)}}var BV3=BABYLON.Vector3;const maps=['0II03 !3!!3"!3#!3$!3%!3&!3\'!3(!3)!3*!3+!3,!3-!3.!3/!30!31!32!33!2 !2!!2"!2#!2$!2%!2&!2\'!2(!2)!2*!2-!2.!2/!20!21!22!23!43!42!41!40!4/!4.!4-!4,!4+!4*!4)!4\'!4&!4"!4!!4 !1+!24!25!26!36!46!45!44!34!35!16!17!07!29!58!.*!-*!7%!,1",2",3",4",5",6",7",8",9":1#:2#:3#:4#:5#:6#:7#:8#:9#,0":0#27!28!39!38!48!47!37!09!1;!4=!6:!->$.>$/>$0>$1>$2>$3>$4>$5>$6>$7>$8>$9>$,:",;",<",="::#:;#:<#:=#,>":>#.(&+(&0&&.&&+&&0$&.$&,$&7$&;$&8&&9&&;&&6(&7(&9(&:(&8*&6,&8-&/.&**&\'%&-!&9!&;+&6&&2,!1,!0,!/,!.,!-,!,,!5\'!6\'!7\'!8\'!9\'!:\'!;\'!<\'!=\'!>\'!?\'!+,!*,!),!(,!9$&/(&5"&',"0II03 !3!!3\"!3#!3$!3%!3&!3'!3(!3)!3*!3+!3,!3-!3.!3/!30!31!32!33!2 !2!!2\"!2#!2$!2%!2&!2'!2(!2)!2*!2.!2/!20!21!22!23!43!42!41!40!4/!4.!4-!4,!4+!4*!4)!4'!4&!4\"!4!!4 !24!25!26!36!46!45!44!34!35!:1#:2#:3#:4#:5#:6#:7#:8#:9#:0#48!47!37!->$.>$/>$0>$1>$2>$3>$4>$5>$6>$7>$8>$9>$::#:;#:<#:=#:>#2,!5'!,>$+>$27!17!07!/7!.7!-7!,7!+7!*7!)7!(7!&7!%7!$7!#7!\"7!!7!%9!&9!'9!(9!)9!*9!+9!,9!-9!.9!/9!09!19!29!39!38!28!18!08!/8!.8!-8!,8!+8!*8!)8!(8!'8!&8!%8!#8!\"8!!8!!9!\"9!$8!2;!78!05!%5!&:!(6!(5!(4!)4!)3!)2!)1!)0!(0!(/!$:!$;!$<!#<!#=!#>!$>!$?!$@!%@!%A!5.!6.!7.!7-!8-!9-!9,!:,!1,!0,!0+!/+!/*!.*!'3&'0&'-&%2&%.&\"0&\"3&!;&!?&&;&(<&(=&'?&#B&!=&2-&.+&/'&1%&/%&0\"&.&&<)&<&&9$&8'&7)&7%&;*&8+&-(&$,&","0II03 !3!!3\"!3#!3$!3%!3&!3'!3(!3)!3*!3+!3,!3-!3.!3/!30!32!33!2 !2!!2\"!2#!2$!2%!2&!2'!2(!2)!2*!2.!2/!20!21!22!23!43!42!41!40!4/!4.!4-!4,!4+!4*!4)!4'!4&!4\"!4!!4 !24!25!26!46!45!44!34!35!2,!5'!17!/7!.7!-7!,7!+7!*7!)7!(7!&7!%7!$7!#7!\"7!!7!%9!&9!'9!(9!)9!*9!+9!,9!-9!.9!/9!09!19!18!08!/8!.8!-8!,8!+8!*8!)8!(8!'8!&8!%8!#8!\"8!!8!!9!\"9!$8!05!%5!&:!(6!(5!(4!)4!)3!)2!)1!)0!(0!(/!$:!$;!$<!#<!#=!#>!$>!$?!$@!%@!%A!5.!6.!7.!7-!8-!9-!9,!:,!1,!0,!0+!/+!/*!.*!'3&'0&'-&%2&%.&\"0&\"3&!;&!?&&;&(<&(=&'?&#B&!=&2-&.+&/'&1%&/%&0\"&.&&<)&<&&9$&8'&7)&7%&;*&8+&-(&$,&80&?0&?2&>4&?5&B3&B1&;3&:>&@>&?A&<B&:B&<=&9<&8A&<@&?D&:E&8E&*@&'C&$C&'(&('&;6!<6!<5!<4!<3!=3!=2!=1!=0!=/!A:!A;!B;!B<!C=!C>!C?!C@!CA!CB!CC!1@!1A!0A!/B!.C!-C!-D!,D!,E!38!39!3:!3;!3<!3=!3>!3?!3@!3A!3F!3G!3H!2H!2G!2F!2E!2D!2C!2B!2A!2@!2?!2>!2=!2<!2:!28!27!37!36!56!57!4>!4?!4@!3B!3C!3D!3E!4G!4F!4E!4D!4C!4B!4A!5@!5?!48!47!5=!69!59!5:!5;!5<!4=!4<!4;!4:!49!58!78!:8!<8!=8!>8!?8!@8!B8!A8!@9!?9!>9!=9!<9!;9!:9!99!98!88!89!79!68!67!77!87!97!:7!;7!<7!=7!>7!?7!@7!A7!B7!C7!D7!G7!F7!E7!E8!C8!A9!D8!D9!C9!1;!7;!6?!7?!:?!;>!<>!1<!8?!9@!<C!=C!$)&AE&+>&"],ldText=["You've entered the graveyard\nThe dead are rising...","Moving forward into the darkness\nStanding in a corner...","You're in the middle\nSurrounded by graves..."],SPRITESTEXTURE="data:image/webp;base64,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";class App{sce;controllers=[];fl;inputS=new InputSystem;shadowS;state;inXR=!1;titleP;gameOverP;titleNotVRP;controllerP;scoreScreen;scorePlane;enemyP;light;score;spritectx;currenLevel=0;tmL;tmR;tmC;currentFade=0;totalSks;leveldesc;constructor(){this.eng=new BABYLON.Engine(document.querySelector("#c"),!0),this.createScene().then((()=>{this.sysReg||(secs.registerSystems([this.inputS,this.shadowS]),this.sysReg=!0),this.eng.runRenderLoop((()=>{let e=this.eng.getDeltaTime();secs.match(ControllerInput).map((t=>this.inputS.controllers(t,e))),2===this.state&&secs.match(AIController).map((t=>t.get(AIController).update(e,t))),this.sce.render()}))}))}loadLevel(e){let t={};t.t=e.codePointAt(0)-32,t.w=e.codePointAt(1)-32,t.h=e.codePointAt(2)-32,t.z=+e[3],t.m=[],t.M=[];for(let s=4;s<e.length;s+=3)t.m.push([e.codePointAt(s)-32,e.codePointAt(s+1)-32,e.codePointAt(s+2)-32]);return t}async changeState(e){switch(this.state=e,e){case 2:this.score=0,this.currenLevel=-1,this.totalSks=0,this.nextLevel();break;case 1:this.scoreScreen.setEnabled(!1),this.titleP.setEnabled(this.inXR),this.titleNotVRP.setEnabled(!this.inXR),this.spawner?.stop(),this.clear();break;case 3:this.spawner.stop(),this.clear(),this.gameOverP.setEnabled(!0),this.createText(this.scorePlane,"score","bold 18px monospace",this.score+" SKELETONS KILLED!","#c0a48c"),this.scoreScreen.setEnabled(!0)}}clear(e=200){setTimeout((()=>{secs.match(Grave).forEach((e=>e.kill())),secs.match(EnemyEntity).forEach((e=>e.kill())),this.enemyP.getChildren().forEach((e=>e.dispose()))}),e)}createText(e,t,s,a,i){const n=new BABYLON.DynamicTexture("dt"+t,{width:240,height:40}),r=new BABYLON.StandardMaterial("mat"+t);n.updateSamplingMode(BABYLON.Texture.NEAREST_SAMPLINGMODE),r.diffuseTexture=n,r.emissiveTexture=n,r.specularColor=BC3.Black(),e.material=r;let o=a.split("\n");n.drawText(o[0],null,18,s,i,"rgba(0,0,0,0)",!0,!0),o[1]&&n.drawText(o[1],null,38,s,i,"rgba(0,0,0,0)",!0,!0),n.hasAlpha=!0}gotTrigger(){2!==this.state&&this.changeState(2)}triggerPressed=!1;createCanvasTexture(){const e=document.createElement("Canvas");this.spritectx=e.getContext("2d");const t=new Image;return new Promise((e=>{t.onload=()=>{this.spritectx.drawImage(t,0,0),e()},t.src=SPRITESTEXTURE}))}createMesh(e,t,s,a,i=[1,1,1]){let n=new BABYLON.Mesh(e),r=[],o=new BABYLON.VertexData;return BABYLON.VertexData.ComputeNormals(t,s,r),o.positions=t,o.indices=s,o.uvs=a,o.normals=r,o.applyToMesh(n),n.material=this.spriteMat,n.receiveShadows=!0,n.scaling=BV3.FromArray(i),n.setEnabled(!1),n}nextLevel(){this.totalSks--,this.totalSks>0||(this.fadeState=-1,setTimeout((()=>{this.currenLevel=(this.currenLevel+1)%3,this.scoreScreen.setEnabled(!1),this.titleP.setEnabled(!1),this.gameOverP.setEnabled(!1),this.titleNotVRP.setEnabled(!1),this.createText(this.leveldesc,"ld","12px monospace",ldText[this.currenLevel],"#7c8898"),setTimeout((()=>{this.leveldesc.setEnabled(!1)}),6e3),this.createMap(),this.spawner.start(),this.fadeState=1,this.leveldesc.setEnabled(!0)}),2500),this.clear(0))}async createScene(){this.sce=new BABYLON.Scene(this.eng),this.sce.clearColor=BABYLON.Color4.FromHexString("#040010"),this.sce.fogMode=BABYLON.Scene.FOGMODE_EXP,this.sce.fogColor=BC3.FromHexString("#000000"),this.sce.fogDensity=.2,this.createBackground(),this.nonVRCam=new BABYLON.FreeCamera("cam1",new BV3(0,1.7,0)),this.enemyP=new BABYLON.Node("enemyP"),this.camCol=BABYLON.CreateSphere("camCol",{diameter:.2}),this.light=new BABYLON.PointLight("light1",new BV3(0,4,-3),this.sce),this.controllerP=new BABYLON.Node("controllerParent");const e=[new BV3(.025,-.1),new BV3(.025,-.09,0),new BV3(.013,-.08,0),new BV3(.03,.54,0),new BV3(.031,.73,0),new BV3(.01,.74,0)];this.spriteMat=new BABYLON.StandardMaterial("spriteMat",this.sce);const t=BABYLON.Texture.CreateFromBase64String(SPRITESTEXTURE,"SpritesTexture",this.sce,!1,!0,4);this.spriteMat.diffuseTexture=t,this.spriteMat.diffuseTexture.hasAlpha=!0,this.spriteMat.specularColor=BC3.Black(),await this.createCanvasTexture(),this.bat=BABYLON.MeshBuilder.CreateLathe("bat",{shape:e,cap:3,tessellation:5,sideOrientation:BABYLON.Mesh.DOUBLESIDE,frontUVs:new BABYLON.Vector4(.4375,0,.5,.375)}),this.bat.material=this.spriteMat,this.bat.parent=this.controllerP,this.ray=new BABYLON.Ray(BV3.Zero(),new BV3(0,1,0)),new BABYLON.RayHelper(this.ray).attachToMesh(this.bat,new BV3(0,1,0),new BV3(0,0,0),.8),secs.createEntity([new ControllerInput("right"),new MeshEntity(this.bat),new CollisionCheck(this.ray)]),this.fl=new BABYLON.SpotLight("light",new BV3(0,0,0),new BV3(0,1,0),Math.PI/3,.5,this.sce),this.fl.diffuse=new BC3(1,1,1),this.fl.specular=new BC3(1,1,1),this.fl.range=50,this.fl.shadowEnabled=!0,this.shadowS=new ShadowSystem(this.fl);var s=BABYLON.CreateCylinder("fl",{height:.15,diameterTop:.03,diameterBottom:.02});this.fl.parent=s,s.parent=this.controllerP,secs.createEntity([new ControllerInput("left"),new MeshEntity(s)]);const a=BABYLON.MeshBuilder.CreateTiledGround("gr",{xmin:-16,zmin:-16,xmax:16,zmax:16,subdivisions:{w:1,h:1}});a.receiveShadows=!0;var i=new BABYLON.StandardMaterial("grM"),n=new BABYLON.DynamicTexture("grt",{width:16,height:16},this.sce,!1,BABYLON.Texture.NEAREST_SAMPLINGMODE);n.getContext().putImageData(this.spritectx.getImageData(32,0,16,16),0,0),n.update(),n.uScale=n.vScale=50,n.wrapU=n.wrapV=1,i.diffuseTexture=n,i.specularColor=BC3.Black(),a.material=i,this.path=BABYLON.CreatePlane("path",{size:.64}),this.path.rotation.x=Math.PI/2,this.path.position.y=-10,this.path.receiveShadows=!0;var r=new BABYLON.StandardMaterial("path"),o=new BABYLON.DynamicTexture("path texture",{width:16,height:16},this.sce,!1,BABYLON.Texture.NEAREST_SAMPLINGMODE);const h=o.getContext();var c=this.spritectx.getImageData(32,0,16,16);for(let e=0;e<c.data.length;e+=4)c.data[e]=(c.data[e]+139)/2,c.data[e+1]=(c.data[e+1]+69)/2,c.data[e+2]=(c.data[e+2]+19)/2;h.putImageData(c,0,0),o.update(),r.diffuseTexture=o,r.specularColor=BC3.Black(),this.path.material=r,this.titleNotVRP=await this.createTitle("DEATHKEEPER",!1),this.titleP=await this.createTitle("DEATHKEEPER",!0),this.gameOverP=await this.createTitle(" GAME OVER",!0),this.scoreScreen=new BABYLON.Node("scoreScreen",this.sce),this.scorePlane=BABYLON.MeshBuilder.CreatePlane("scoreScreen",{width:3,height:.5}),this.scorePlane.parent=this.scoreScreen,this.leveldesc=BABYLON.MeshBuilder.CreatePlane("leveldesc",{width:3,height:.5}),this.leveldesc.position=new BV3(0,1.7,3),this.leveldesc.setEnabled(!1),this.shadowS.add(this.scorePlane),this.scorePlane.position=new BV3(0,1.25,1.5),this.notInXR(),BABYLON.Animation.AllowMatricesInterpolation=!0;let l=this.createMesh("sk",[-.08,.3224,-.0418,-.24,.64,-.0161,-.24,.3224,-.0417,-.4391,1.2006,-.2456,-.2362,1.1178,-.0355,-.2329,1.2352,-.0601,0,1.2771,-.0432,-.24,1.7897,-.1267,-.24,1.2771,-.0432,-.2381,.9577,-.0202,0,1.2771,-.0432,-.2398,1.277,-.0438,0,.6402,.0026,-.2381,.9577,-.0202,-.2398,.64,-8e-4,-.5732,1.0382,-.4617,-.4391,1.2006,-.2456,-.5741,1.1563,-.483,-.08,.005,.0014,-.24,.3224,-.0417,-.24,.005,.0014,.24,.6401,-.0124,.08,.3223,-.0413,.24,.3223,-.0412,.2419,1.2387,-.0426,.3084,1.1173,-.3124,.3086,1.2373,-.313,.24,1.7897,-.1264,0,1.2771,-.0432,.24,1.2771,-.0432,.2392,.9573,-.0306,0,1.2771,-.0432,0,.9571,-.0415,.2392,.9573,-.0306,0,.6402,.0026,.2399,.6397,-.0043,.3086,1.2373,-.313,.3635,1.1159,-.5868,.3634,1.2359,-.5875,.24,.3223,-.0412,.08,.0043,-.0092,.24,.0043,-.0057,-.08,.3224,-.0418,-.08,.64,-.0149,-.24,.64,-.0161,-.4391,1.2006,-.2456,-.4389,1.0828,-.2229,-.2362,1.1178,-.0355,0,1.2771,-.0432,0,1.789,-.1348,-.24,1.7897,-.1267,-.2381,.9577,-.0202,0,.9571,-.0415,0,1.2771,-.0432,0,.6402,.0026,0,.9571,-.0415,-.2381,.9577,-.0202,-.5732,1.0382,-.4617,-.4389,1.0828,-.2229,-.4391,1.2006,-.2456,-.08,.3224,-.0418,-.24,.3224,-.0417,.24,.6401,-.0124,.08,.64,-.0087,.08,.3223,-.0413,.2419,1.2387,-.0426,.2398,1.1187,-.0418,.3084,1.1173,-.3124,.24,1.7897,-.1264,0,1.789,-.1348,0,1.2771,-.0432,.2392,.9573,-.0306,.24,1.2771,-.0432,0,1.2771,-.0432,.2392,.9573,-.0306,0,.9571,-.0415,0,.6402,.0026,.3086,1.2373,-.313,.3084,1.1173,-.3124,.3635,1.1159,-.5868,.24,.3223,-.0412,.08,.3223,-.0413,.08,.0043,-.0092],[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,18,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82],[.023,.47,.007,.941,.007,.47,.07,.468,.082,.932,.07,.932,.062,.001,.039,.875,.039,.001,.102,.499,.125,1,.102,.998,.125,0,.102,.499,.102,0,.082,.004,.07,.468,.07,.004,.023,-.001,.007,.47,.007,-.001,.007,.941,.023,.47,.007,.47,.07,.932,.082,.468,.07,.468,.039,.875,.062,.001,.039,.001,.102,.499,.125,1,.125,.5,.102,.499,.125,0,.102,0,.07,.468,.082,.004,.07,.004,.007,.47,.023,-.001,.007,-.001,.023,.47,.023,.941,.007,.941,.07,.468,.082,.468,.082,.932,.062,.001,.062,.875,.039,.875,.102,.499,.125,.5,.125,1,.125,0,.125,.5,.102,.499,.082,.004,.082,.468,.07,.468,.023,.47,.007,.47,.007,.941,.023,.941,.023,.47,.07,.932,.082,.932,.082,.468,.039,.875,.062,.875,.062,.001,.102,.499,.102,.998,.125,1,.102,.499,.125,.5,.125,0,.07,.468,.082,.468,.082,.004,.007,.47,.023,.47,.023,-.001]);l.translate(BV3.Up(),.8);let d=BABYLON.Animation.Parse({name:"Walk",property:"rotation",framePerSecond:60,dataType:1,loopBehavior:1,blendingSpeed:.01,keys:[{frame:0,values:[0,-.2,0,[0,0,0],[0,0,0]]},{frame:25,values:[.1,0,.03,[0,0,0],[0,0,0]]},{frame:50,values:[0,.2,0,[0,0,0],[0,0,0]]},{frame:75,values:[.1,0,-.03,[0,0,0],[0,0,0]]},{frame:100,values:[0,-.2,0,[0,0,0],[0,0,0]]}]}),p=BABYLON.Animation.Parse({name:"Rise",property:"rotation",framePerSecond:60,dataType:1,loopBehavior:1,blendingSpeed:.01,keys:[{frame:0,values:[2.14,0,0,[0,0,0],[-.07,0,0]]},{frame:100,values:[0,0,0,[0,0,0],[0,0,0]]}]});l.animations.push(d,p),this.spawner=new Spawner(this.sce,l,5e3);let B=[.32,.64,0,-.32,1.28,0,-.32,.64,0,.32,0,0,-.32,.64,0,-.32,0,0,.32,1.28,0,.32,.64,0,-.32,.64,0],m=[0,1,2,3,4,5,0,6,1,3,7,8];this.tombstone=[this.createMesh("ts1",B,m,[.312,0,.25,1,.25,0,.25,.001,.188,1,.188,0,.312,1,.25,1.001,.188,1]),this.createMesh("ts2",B,m,[.375,0,.313,1,.313,0,.25,.001,.188,1,.188,0,.375,1,.25,1.001,.188,1]),this.createMesh("ts3",B,m,[.437,0,.375,1,.375,0,.25,.001,.188,1,.188,0,.437,1,.25,1.001,.188,1])],this.wall=this.createMesh("wall",[.32,.64,0,-.32,1.28,0,-.32,.64,0,.32,0,0,-.32,.64,0,-.32,0,0,.32,1.28,0,-.32,1.92,0,-.32,1.28,0,.32,1.28,0,.32,.64,0,-.32,.64,0,.32,1.92,0],[0,1,2,3,4,5,6,7,8,0,9,1,3,10,11,6,12,7],[.625,0,.563,1,.563,0,.562,.001,.5,1,.5,0,.687,0,.625,1,.625,0,.625,1,.562,1.001,.5,1,.687,1]),this.createMap(),this.generateRandomTree();const u=await this.sce.createDefaultXRExperienceAsync({disableNearInteraction:!0,disablePointerSelection:!0,disableTeleportation:!0,inputOptions:{doNotLoadControllerMeshes:!0}});return u.baseExperience.onStateChangedObservable.add((e=>{switch(e){case BABYLON.WebXRState.IN_XR:this.inXR=!0,this.changeState(1),sfx.InitAudio(),ambience.start(),this.camera=u.baseExperience.camera.leftCamera,this.camCol.parent=this.camera,u.baseExperience.camera.position=new BV3(0,1.7,0),this.tmL||(this.tmL=new BABYLON.TonemapPostProcess("tonemap",BABYLON.TonemappingOperator.Reinhard,0,u.baseExperience.camera.leftCamera),this.tmR=new BABYLON.TonemapPostProcess("tonemap",BABYLON.TonemappingOperator.Reinhard,0,u.baseExperience.camera.rightCamera)),this.currentFade=0,this.fadeState=1,this.light.diffuse=BC3.FromHexString("#100080"),this.controllerP.setEnabled(!0);break;case BABYLON.WebXRState.NOT_IN_XR:this.notInXR();case BABYLON.WebXRState.EXITING_XR:case BABYLON.WebXRState.ENTERING_XR:}})),u.input.onControllerAddedObservable.add((e=>{this.inputS.xrControllers.push(e)})),this.sce.onBeforeRenderObservable.add((()=>{this.currentFade+=.01*this.fadeState,this.tmL&&(this.tmL.exposureAdjustment=this.currentFade),this.tmC&&(this.tmC.exposureAdjustment=this.currentFade),this.tmR&&(this.tmR.exposureAdjustment=this.currentFade),1.2>this.currentFade&&this.currentFade>=0||(this.fadeState=0)})),this.sce}notInXR(){this.inXR=!1,this.changeState(1),ambience.pause(),this.controllerP.setEnabled(!1),this.camera=this.nonVRCam,this.tmC||(this.tmC=new BABYLON.TonemapPostProcess("tonemap",BABYLON.TonemappingOperator.Reinhard,0,this.camera)),this.currentFade=1,this.fadeState=0,this.light.diffuse=BC3.FromHexString("#a0a0FF")}createBackground(){var e=new BABYLON.PhotoDome("dome","",{},this.sce);e._mesh.applyFog=!1;let t=new BABYLON.DynamicTexture("background",{width:500,height:500});const s=t.getContext();t.updateSamplingMode(BABYLON.Texture.NEAREST_SAMPLINGMODE);let a=s.createLinearGradient(0,0,0,500);a.addColorStop(1,"#100020"),a.addColorStop(.55,"#100020"),a.addColorStop(.5,"black"),a.addColorStop(0,"black"),s.fillStyle=a,s.fillRect(0,0,500,500),t.update(),e.photoTexture=t}createMap(){this.map&&this.map.dispose(),this.map=new BABYLON.TransformNode("map");var e=this.loadLevel(maps[this.currenLevel]);for(let t=0;t<e.m.length;t++){let s;const a=.64*e.m[t][0]-12.2,i=.64*-e.m[t][1]+15;switch(e.m[t][2]){case 1:s=this.path.createInstance("path"+ +new Date);break;case 2:s=this.wall.createInstance("wall"+ +new Date),s.rotation=BV3.FromArray([0,-1.5708,0]);break;case 3:s=this.wall.createInstance("wall"+ +new Date),s.rotation=BV3.FromArray([0,1.5708,0]);break;case 4:s=this.wall.createInstance("wall"+ +new Date),s.rotation=BV3.FromArray([0,Math.PI,0]);break;case 5:s=this.wall.createInstance("wall"+ +new Date),s.rotation=BV3.FromArray([0,0,0]);break;case 6:s=this.tombstone[Math.floor(3*MR())].createInstance("tombstone"+t),s.position=new BV3(a,0,i),s.lookAt(new BV3(0,0,0)),s.rotation.y+=.5*MR()-.25-Math.PI,s.rotation.z+=.5*MR()-.25,s.rotation.x+=.5*MR()-.25,s.entity=secs.createEntity([new MeshEntity(s),new Grave(s)]),this.shadowS.add(s);break;default:continue}s.position=new BV3(a,.001,i),s.parent=this.map}}curve=60;curve2=5;drawTree(e,t,s,a,i,n){e.beginPath(),e.save(),e.lineWidth=n,e.translate(t,s),e.rotate(i*Math.PI/180),e.moveTo(0,0),i>0?e.bezierCurveTo(this.curve2,-a/2,this.curve2,-a/2,0,-a):e.bezierCurveTo(this.curve2,-a/2,-this.curve2,-a/2,0,-a),e.stroke(),a>10&&(this.drawTree(e,0,-a,.7*a,i+this.curve*MR(),.6*n),this.drawTree(e,0,-a,.7*a,i-this.curve*MR(),.6*n)),e.restore()}generateRandomTree(){const e=BABYLON.MeshBuilder.CreatePlane("Tree",{width:6,height:6});e.position=new BV3(0,-10,0);const t=new BABYLON.DynamicTexture("tree texture",{width:64,height:64});t.hasAlpha=!0;const s=t.getContext(),a=new BABYLON.StandardMaterial("Tree Mat");t.updateSamplingMode(BABYLON.Texture.NEAREST_SAMPLINGMODE),this.drawTree(s,32,64,24,0,6),a.diffuseTexture=t,a.diffuseTexture.hasAlpha=!0,t.update(),e.material=a;for(let t=0;2*Math.PI>t;t+=.1){let s=e.createInstance("tree");s.rotation=BV3.FromArray([0,t+1.57,0]),s.position=new BV3(3*MR()+25*Math.cos(t),2,3*MR()-25*Math.sin(t)),s.scaling=new BV3(.75+MR(),1+2*MR(),1)}}createTitle(e,t){var s=new BABYLON.Node("titleParent"+e,this.sce);const a=BABYLON.MeshBuilder.CreatePlane("PressTrigger"+e,{width:3,height:.75});a.parent=s,a.position=new BV3(0,1.75,2),this.shadowS.add(a);const i=new BABYLON.DynamicTexture("dynamic texture"+e,{width:1200,height:300}),n=i.getContext(),r=new BABYLON.StandardMaterial("Mat"+e);r.diffuseTexture=i,r.emissiveTexture=i,r.specularColor=BC3.Black(),a.material=r,i.drawText(t?"Press trigger to start":" Switch to VR to play",300,215,"bold 44px monospace","#7c8898","rgba(0,0,0,0)",!0,!0),i.hasAlpha=!0;const o=document.createElement("Canvas");o.width=2048;const h=o.getContext("2d");return new Promise((t=>{h.font="150px 'Montserrat', Arial, sans-serif",h.strokeStyle="#222",h.lineWidth=12,h.strokeText(e,20,128),h.fillStyle="#FFF",h.fillText(e,25,123),h.shadowColor="#888",h.shadowBlur=6,h.shadowOffsetX=-2,h.shadowOffsetY=3,h.lineWidth=4,h.strokeStyle="#FFF",h.strokeText(e,25,123);for(let e=0;300>e;e+=8)for(let t=0;1200>t;t+=8){const s=h.getImageData(t,e,1,1),a=Math.floor(s.data[0]/16);if(0!=a){const e=this.spritectx.getImageData(Math.floor(16*MR())+48,17-a,1,1);n.fillStyle=`rgb(${e.data[0]},${e.data[1]},${e.data[2]})`}else n.fillStyle="rgba(0,0,0,0)";n.fillRect(t,e,8,8)}i.update(),s.setEnabled(!1),t(s)}))}}window.app=new App</script>