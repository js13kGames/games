<!doctype html><meta name=viewport content="width=device-width,viewport-fit=cover"><title>Night Dealer - js13kGames 2025</title><style>:root{--dark:#0c0c0f;--dark2:#141418;--text:#d8dbff;--hl:#b5c3ff;--accent:#e2c044;--line:rgba(255, 255, 255, .15);--iris:#f6c257;--rim:#d52c24;--glow:rgba(255, 167, 0, .25)}body,html{height:100%}body{margin:0;background:radial-gradient(1200px 600px at 80% 70%,rgba(226,192,68,.25),transparent 60%),linear-gradient(#0a0a0d,#0c0c10 40%,#0a0a0d);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;user-select:none}.scene{position:relative;width:min(1100px,94vw);height:min(680px,92vh);margin:2vh auto;overflow:hidden}.board-wrap{position:absolute;left:50%;top:50%;width:420px;height:280px;transform:translate(-50%,-40%)}#iso{width:100%;height:100%;display:block;background:0 0}.bubble{margin:auto;width:360px;max-width:38vw;background:linear-gradient(180deg,rgba(30,36,60,.6),rgba(15,18,30,.55));border:1px solid var(--line);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.45);padding:10px 12px 12px 12px;backdrop-filter:blur(4px)}.bubble-header{display:flex;justify-content:flex-end;margin-bottom:2px}.icon-btn{width:24px;height:24px;border:1px solid var(--line);border-radius:6px;background:0 0;color:var(--hl)}.icon-btn:hover{border-color:var(--hl)}.bubble-text{color:#cfd4ff;font-size:13px;white-space:pre-wrap}.bubble-choices{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}.bubble-choices .choice{font-size:12px;padding:6px 10px;border:1px solid var(--line);background:#141827;color:#e6e9ff;border-radius:8px}.bubble-choices .choice:hover{border-color:var(--hl);color:#fff}.ankidu-avatar{position:absolute;left:8px;top:-8px;width:64px;height:64px;pointer-events:none;filter:drop-shadow(0 1px 2px rgba(0,0,0,.5));pointer-events:none;user-select:none;z-index:-1}.ankidu-avatar svg{width:100%;height:100%;display:block}.hud{position:absolute;left:50%;bottom:0;transform:translateX(-50%);display:none;gap:10px;justify-items:center}.wheels{display:flex;gap:10px}.wheel{width:54px;height:54px;display:grid;place-items:center;border:1px solid var(--line);border-radius:6px;background:#1a1e2a;color:#fff;font-size:26px}.wheel.used{opacity:.35;filter:saturate(.2)}.wheel.selected{outline:2px solid var(--hl)}.controls{display:flex;gap:8px;justify-content:center;margin:10px 0}.btn{padding:6px 10px;background:#1a1e2a;color:#e8ecff;border:1px solid var(--line);border-radius:8px}.btn:disabled{opacity:.4}.btn:not(:disabled):hover{border-color:var(--hl)}.scorebar{display:flex;justify-content:center;align-items:center;gap:.5rem;font:600 18px/1.2 system-ui,ui-sans-serif,Segoe UI,Roboto,sans-serif;letter-spacing:.2px;padding:.4rem .8rem;border-radius:999px;background:#0b0e12;color:#dfe6ee;margin:.5rem auto 0;width:fit-content;box-shadow:0 0 0 1px rgba(255,255,255,.05) inset}.scorebar .name{opacity:.85}.scorebar .score{min-width:1.2ch;text-align:center}.scorebar .dash{opacity:.5;margin:0 .2rem}.scorebar.turn-p1{box-shadow:0 0 0 1px rgba(77,163,255,.25) inset,0 0 12px rgba(77,163,255,.15)}.scorebar.turn-p2{box-shadow:0 0 0 1px rgba(255,77,77,.25) inset,0 0 12px rgba(255,77,77,.12)}.scorebar .name.active{padding:.1rem .4rem;border-radius:6px;color:#fff;font-weight:700}.scorebar .name.active.p1{background:#4da3ff}.scorebar .name.active.p2{background:#ff4d4d}</style><div class=scene><div id=ankidu class=bubble><div class=bubble-header><button id=btnHelp class=icon-btn title=Règles>?</button></div><div id=bubbleText class=bubble-text>Select a wheel, then select a cell to place tile.</div><div id=bubbleChoices class=bubble-choices></div><div class=ankidu-avatar><svg id=ankiduCat viewBox="0 0 64 64" role=img aria-label="Black cat head"><path d="M12 28 L22 10 L30 20 L34 20 L42 10 L52 28 C54 32 54 40 50 46 C45 54 38 58 32 58 C26 58 19 54 14 4 C10 40 10 32 12 28 Z" fill=#111 /><ellipse cx=24 cy=36 rx=7 ry=3 fill=#ff8c00 transform="rotate(20 24 36)"/><ellipse cx=40 cy=36 rx=7 ry=3 fill=#ff8c00 transform="rotate(-20 40 36)"/><rect x=23 y=30 width=2 height=12 rx=1 fill=#000 /><rect x=39 y=30 width=2 height=12 rx=1 fill=#000 /><path d="M30 42 L34 42 L32 44 Z" fill=#222 /></svg></div></div><div class=board-wrap><canvas id=iso width=640 height=480></canvas></div><div id=hud class=hud><div class=controls><button class=btn id=rerollBtn onclick=rerollAction()>Reroll</button> <button class=btn id=validateBtn onclick=validateAction() disabled=disabled>Validate</button> <button class=btn id=cancelBtn onclick=cancelAction()>Cancel</button> <button class=btn id=resetBtn onclick=resetAction()>Reset</button></div><div id=player1Wheels class=wheels></div><div id=scoreBar class=scorebar><span id=p1Name class=name>Stray</span> <span class=sep>:</span> <span id=p1Score class=score>0</span> <span class=dash>–</span> <span id=p2Score class=score>0</span> <span class=sep>:</span> <span id=p2Name class=name>Ankidu</span></div></div></div><script>const T={ATK:0,HEX:1,WARD:2,ECLIPSE:3},ICON=["⚔️","👁️","🛡️","🌙"],BEATS=[T.HEX,T.WARD,T.ATK],OWN_COL={1:"#4da3ff",2:"#ff4d4d"},ISO_COL={dark:"#040404ff",dark2:"#4E2A1B",hl:"#ffffff"},COL_TRAP="#E2C044",COL_CURSE="#9b59ff",P1_LABEL="Stray",P2_LABEL="Ankidu";function isAdj(e,t){return ADJ[e]?.includes(t)}function ankiduHint(e){if(!Ankidu.elText)return void console.warn("[hint]",e);const t=Ankidu.elText.textContent;Ankidu.elText.textContent=e,setTimeout(()=>{Ankidu.elText&&Ankidu.elText.textContent===e&&(Ankidu.elText.textContent=t)},1400)}const MSG={start:{body:"Good night. How can I help you?",choices:[{label:"I seek time before dawn.",action:()=>startGame()}]},rules:{body:["Goal: Win 2 out of 3 rounds by controlling the most tiles","Types: ATK ⚔️ > HEX 👁️ > WARD 🛡️ > ATK ⚔️.","Place up to 2 tiles on T1–T2 (adjacent), 1 tile on T3.","🛡️ WARD shields itself (+1) and one adjacent ally.","👁️ HEX: curse an adjacent enemy (delayed flip) or place a trap on an empty adjacent cell (immediate flip on entry).","A curse can be countered by WARD shields","🌙 ECLIPSE: choose type on placement (once per round).","Omen: defender may cancel one flip at start of their turn."].join("\n")},end:e=>({body:e+"\nWant to play again?",choices:[{label:"Rematch",action:()=>rematchAction()}]})};let iso,ictx,DPR=1;const TILE_W=128,TILE_H=64;let ORIGIN_X=160,ORIGIN_Y=110;const POS=Array(9),PATH=Array(9);let hoverCell=-1,needsRedraw=!0,trapByCell=new Uint8Array(9),WHEEL_EL=[];const SCR={atk:Array.from({length:9},()=>({p1:0,p2:0}))};function initIsoCanvas(){iso=document.getElementById("iso"),iso?(ictx=iso.getContext("2d",{alpha:!0}),ictx.imageSmoothingEnabled=!1,fitIsoDPI(),window.addEventListener("resize",fitIsoDPI,{passive:!0}),iso.addEventListener("pointerdown",handleIsoPointer),iso.addEventListener("pointermove",handleIsoHover),iso.addEventListener("pointerleave",()=>{hoverCell=-1,invalidate()}),requestAnimationFrame(renderLoop)):console.warn("Canvas #iso not found")}function fitIsoDPI(){DPR=Math.max(1,window.devicePixelRatio||1);const e=iso.clientWidth||320,t=iso.clientHeight||240;iso.width=Math.round(e*DPR),iso.height=Math.round(t*DPR),ictx.setTransform(DPR,0,0,DPR,0,0),ORIGIN_X=e/2|0,ORIGIN_Y=t/2-20|0;for(let e=0;e<9;e++){const t=e%3,a=e/3|0;POS[e]=isoPos(t,a);const n=new Path2D,{x:l,y:i}=POS[e],s=128,o=64;n.moveTo(l,i-o/2),n.lineTo(l+s/2,i),n.lineTo(l,i+o/2),n.lineTo(l-s/2,i),n.closePath(),PATH[e]=n}ictx.font="16px system-ui, sans-serif",ictx.textAlign="center",ictx.textBaseline="middle",invalidate()}function isoPos(e,t){return{x:ORIGIN_X+64*(e-t),y:ORIGIN_Y+32*(e+t)}}function diamondPath(e,t,a,n=128,l=64){e.beginPath(),e.moveTo(t,a-l/2),e.lineTo(t+n/2,a),e.lineTo(t,a+l/2),e.lineTo(t-n/2,a),e.closePath()}function pointInDiamond(e,t,a,n,l=128,i=64){return Math.abs(e-a)/(l/2)+Math.abs(t-n)/(i/2)<=1}function rematchAction(){gameState.gameOver=!1,gameState.currentRound=1,gameState.roundWins={1:0,2:0},gameState.roundResults=[],gameState.lastFlips=[],gameState.omen={1:0,2:0},document.querySelectorAll(".btn").forEach(e=>e.disabled=!1);const e=document.getElementById("hud");e&&(e.style.display="block"),"function"==typeof Ankidu.clear&&Ankidu.clear(),startGame()}const ADJ=[[1,3],[0,2,4],[1,5],[0,4,6],[1,3,5,7],[2,4,8],[3,7],[4,6,8],[5,7]];function isRoundComplete(){return gameState.turnsTaken[1]>=3&&gameState.turnsTaken[2]>=3||gameState.gameOver}function canUseOmenNow(){const e=gameState.currentPlayer;return!isRoundComplete()&&gameState.omen[e]&&gameState.lastFlips&&gameState.lastFlips.length>0}function invalidate(){needsRedraw=!0}function renderLoop(){needsRedraw&&(drawBoardIso(),needsRedraw=!1),requestAnimationFrame(renderLoop)}let gameState={currentPlayer:1,currentRound:1,currentTurn:1,roundWins:{1:0,2:0},roundResults:[],board:Array(9).fill(null),turnsTaken:{1:0,2:0},players:[{wheels:[T.ATK,T.HEX,T.WARD,T.ATK,T.HEX],usedWheels:[],rerollsUsed:0,eclipseUsed:!1,isHuman:!0},{wheels:[T.ATK,T.HEX,T.WARD,T.ATK,T.HEX],usedWheels:[],rerollsUsed:0,eclipseUsed:!1,isHuman:!1}],placementState:{selectedWheel:null,pendingPlacements:[],adjacentHighlighted:[],awaitingWardTarget:null,awaitingHexChoice:null,awaitingEclipseChoice:null},phase:"place",traps:[],gameOver:!1};function armCurse(e,t){const a=gameState.board[e];a&&(a.cu={by:t,triggerOn:gameState.turnSerial+1})}gameState.lastFlips=[],gameState.omen={1:0,2:1},gameState.rerollsLeft={1:2,2:2},gameState.rerollUsedThisTurn=!1,gameState.turnSerial=0,gameState.firstMoveDone={1:!1,2:!1};let messages=[];function initializeUI(){createBoard(),createWheels(),gameState.currentRound=1,gameState.roundWins={1:0,2:0},gameState.roundResults=[],Ankidu.init();const e=document.getElementById("p1Name");e&&(e.textContent="Stray");const t=document.getElementById("p2Name");t&&(t.textContent="Ankidu"),Ankidu.say(MSG.start.body,MSG.start.choices.map(e=>({label:e.label,onClick:e.action})))}function startGame(){seedRound()}const Ankidu={elText:null,elChoices:null,_stack:[],_rulesOpen:!1,init(){this.elText=document.getElementById("bubbleText"),this.elChoices=document.getElementById("bubbleChoices"),document.getElementById("btnHelp")?.addEventListener("click",()=>this.toggleRules())},say(e,t=[]){if(this.elText&&this.elChoices||this.init(),this.elText&&this.elChoices){this.elText.textContent=e,this.elChoices.innerHTML="";for(const e of t){const t=document.createElement("button");t.className="choice",t.textContent=e.label,t.onclick=e.onClick,this.elChoices.appendChild(t)}}},_snapshot(){return{text:this.elText?.textContent||"",choices:Array.from(this.elChoices?.querySelectorAll("button")||[]).map(e=>({label:e.textContent,onClick:e.onclick}))}},toggleRules(){if(this._rulesOpen){const e=this._stack.pop();e?this.say(e.text,e.choices):this.say(MSG.start.body,MSG.start.choices.map(e=>({label:e.label,onClick:e.action}))),this._rulesOpen=!1}else this._stack.push(this._snapshot()),this.say(MSG.rules.body,[]),this._rulesOpen=!0},clear(){this._stack=[],this.elText&&this.elChoices||this.init(),this.elText&&(this.elText.textContent=""),this.elChoices&&(this.elChoices.innerHTML="")}};function applyOmenOn(e){const t=gameState.currentPlayer;if(!canUseOmenNow())return!1;const a=gameState.lastFlips.find(t=>t.idx===e);return!!a&&(gameState.board[e].p=a.from,gameState.omen[t]=0,!0)}function createBoard(){initIsoCanvas()}function createWheels(){const e=document.getElementById("player1Wheels");e.innerHTML="",WHEEL_EL=new Array(5);for(let t=0;t<5;t++){const a=document.createElement("div");a.className="wheel",a.id=`p1-wheel-${t}`,a.onclick=()=>wheelClick(0,t),e.appendChild(a),WHEEL_EL[t]=a}}function updateUI(){updateGameInfo(),updateBoard(),updateWheels(),updateControls(),updateSpecialEffects()}function updateGameInfo(){const e=document.getElementById("p1Score"),t=document.getElementById("p2Score");e&&(e.textContent=gameState.roundWins[1]),t&&(t.textContent=gameState.roundWins[2]);const a=document.getElementById("scoreBar");a&&(a.classList.toggle("turn-p1",1===gameState.currentPlayer),a.classList.toggle("turn-p2",2===gameState.currentPlayer));const n=document.getElementById("p1Name"),l=document.getElementById("p2Name");n&&l&&(n.classList.remove("active","p1"),l.classList.remove("active","p2"),1===gameState.currentPlayer?n.classList.add("active","p1"):l.classList.add("active","p2"))}function drawBoardIso(){ictx.clearRect(0,0,iso.width/DPR,iso.height/DPR);for(let e=0;e<9;e++){const t=e%3,a=e/3|0;ictx.fillStyle=t+a&1?ISO_COL.dark2:ISO_COL.dark,ictx.fill(PATH[e])}if(gameState.placementState.adjacentHighlighted?.length)for(const e of gameState.placementState.adjacentHighlighted)ictx.lineWidth=2,ictx.setLineDash([4,3]),ictx.strokeStyle=ISO_COL.hl,ictx.stroke(PATH[e]),ictx.setLineDash([]);for(let e=0;e<9;e++){const t=gameState.board[e];if(!t)continue;const{x:a,y:n}=POS[e];ictx.fillStyle="#e6e6e6",ictx.fillText(ICON[t.t],a,n-2),t.sh>0&&(ictx.fillStyle="#3BA7A9",ictx.beginPath(),ictx.arc(a+16,n-16,5,0,2*Math.PI),ictx.fill()),ictx.lineWidth=2,ictx.strokeStyle=OWN_COL[t.p],ictx.stroke(PATH[e]),t.cu&&(ictx.save(),ictx.lineWidth=2,ictx.setLineDash([2,2]),ictx.strokeStyle="#9b59ff",ictx.stroke(PATH[e]),ictx.restore())}for(let e=0;e<9;e++)trapByCell[e]&&(gameState.board[e]||(ictx.save(),ictx.lineWidth=2,ictx.setLineDash([4,2]),ictx.strokeStyle=COL_TRAP,ictx.stroke(PATH[e]),ictx.restore()));if(gameState.lastFlips?.length)for(const e of gameState.lastFlips){const t=e.idx;ictx.lineWidth=3,ictx.globalAlpha=.7,ictx.strokeStyle=OWN_COL[e.to],ictx.stroke(PATH[t]),ictx.globalAlpha=1}if(hoverCell>=0){const e=hoverCell;ictx.lineWidth=2,ictx.setLineDash([3,3]),ictx.strokeStyle=ISO_COL.hl,ictx.stroke(PATH[e]),ictx.setLineDash([])}}function updateBoard(){invalidate()}function handleIsoPointer(e){const t=iso.getBoundingClientRect(),a=e.clientX-t.left,n=e.clientY-t.top;for(let e=0;e<9;e++){const t=POS[e];if(pointInDiamond(a,n,t.x,t.y))return cellClick(e),void invalidate()}}function handleIsoHover(e){const t=iso.getBoundingClientRect(),a=e.clientX-t.left,n=e.clientY-t.top;let l=-1;for(let e=0;e<9;e++){const t=POS[e];if(pointInDiamond(a,n,t.x,t.y)){l=e;break}}const i=l>=0&&isCellEmpty(l)&&1===gameState.currentPlayer&&"place"===gameState.phase&&null!==gameState.placementState.selectedWheel&&(0===gameState.placementState.pendingPlacements.length||gameState.placementState.adjacentHighlighted.includes(l)||1===maxTilesAllowedForPlayer(gameState.currentPlayer));iso.style.cursor=i?"pointer":"default",hoverCell!==(i?l:-1)&&(hoverCell=i?l:-1,invalidate())}function updateWheels(){for(let e=0;e<5;e++){const t=WHEEL_EL[e],a=gameState.players[0].wheels[e],n=gameState.players[0].usedWheels.includes(e)||wheelPendingUsed(e),l=gameState.placementState.selectedWheel===e;t.textContent=ICON[a]||"?",t.className="wheel",n?t.classList.add("used"):l&&t.classList.add("selected")}}function updateControls(){if(gameState.gameOver)return void["rerollBtn","validateBtn","cancelBtn","resetBtn"].forEach(e=>{const t=document.getElementById(e);t&&(t.disabled=!0)});const e=gameState.players[gameState.currentPlayer-1].isHuman,t=gameState.currentPlayer,a=1===t&&!0===gameState.firstMoveDone?.[t]&&!gameState.rerollUsedThisTurn&&gameState.rerollsLeft[t]>0&&"place"===gameState.phase&&0===gameState.placementState.pendingPlacements.length,n=gameState.placementState.pendingPlacements.length>0&&!gameState.placementState.awaitingWardTarget&&!gameState.placementState.awaitingHexChoice&&!gameState.placementState.awaitingEclipseChoice,l=document.getElementById("rerollBtn");l&&(l.disabled=!e||!a);const i=document.getElementById("skipRerollBtn");i&&(i.disabled=!0,i.style.display="none");const s=document.getElementById("validateBtn");s&&(s.disabled=!e||!n);const o=document.getElementById("cancelBtn");o&&(o.disabled=!e||0===gameState.placementState.pendingPlacements.length);const c=document.getElementById("resetBtn");c&&(c.disabled=!e||0===gameState.placementState.pendingPlacements.length)}function updateSpecialEffects(){if(gameState.gameOver)return;const e=document.getElementById("hud");if(e&&"none"===e.style.display)return;if(!("place"===gameState.phase||gameState.placementState.awaitingWardTarget||gameState.placementState.awaitingHexChoice||gameState.placementState.awaitingEclipseChoice||canUseOmenNow()))return;if(1===gameState.currentPlayer&&canUseOmenNow()){const e=gameState.lastFlips.map(e=>({label:`Cancel flip at cell ${e.idx}`,onClick:()=>{applyOmenOn(e.idx)?(Ankidu.say("Omen used. The flip was undone."),updateUI()):Ankidu.say("Omen unavailable for that cell.")}}));return e.push({label:"Keep all flips",onClick:()=>{gameState.omen[1]=0,updateUI()}}),void Ankidu.say("🜂 Omen: you may cancel **one** flip that just happened.",e)}if(gameState.placementState.awaitingWardTarget){const{availableTargets:e}=gameState.placementState.awaitingWardTarget;return void Ankidu.say("🛡️ WARD: click an ADJACENT ALLY to shield.")}if(gameState.placementState.awaitingHexChoice){const{curseTargets:e,trapTargets:t,tileCell:a}=gameState.placementState.awaitingHexChoice,n=[];return e.forEach(e=>n.push({label:"Curse "+e,onClick:()=>handleHexChoice(a,e,"curse")})),t.forEach(e=>n.push({label:"Trap "+e,onClick:()=>handleHexChoice(a,e,"trap")})),void Ankidu.say("🔮 HEX: click an ADJACENT cell — empty=TRAP (yellow outline), enemy=CURSE (purple outline).")}if(gameState.placementState.awaitingEclipseChoice){const{tileCell:e}=gameState.placementState.awaitingEclipseChoice;return void Ankidu.say("🌙 ECLIPSE: choose an affinity.",[{label:`${ICON[T.ATK]} ATK`,onClick:()=>handleEclipseChoice(e,T.ATK)},{label:`${ICON[T.HEX]} HEX`,onClick:()=>handleEclipseChoice(e,T.HEX)},{label:`${ICON[T.WARD]} WARD`,onClick:()=>handleEclipseChoice(e,T.WARD)}])}const t=gameState.currentPlayer,a=1===t&&!0===gameState.firstMoveDone?.[t]&&!gameState.rerollUsedThisTurn&&gameState.rerollsLeft[t]>0&&0===gameState.placementState.pendingPlacements.length;Ankidu.say(a?"Select a wheel, then a cell. (You can reroll once before placing.)":"Select a wheel, then click a cell to place the tile.")}function wheelPendingUsed(e){return gameState.placementState.pendingPlacements.some(t=>t.wheelIndex===e)}function wheelClick(e,t){0===e&&1===gameState.currentPlayer&&"place"===gameState.phase&&(gameState.players[0].usedWheels.includes(t)||wheelPendingUsed(t)||(gameState.placementState.selectedWheel=t,updateAdjacentHighlights(),updateUI()))}function cellClick(e){if(1===gameState.currentPlayer&&"place"===gameState.phase)if(gameState.placementState.awaitingWardTarget){const{tileCell:t,availableTargets:a}=gameState.placementState.awaitingWardTarget;isAdj(t,e)&&a.includes(e)&&1===gameState.board[e]?.p?(handleWardTarget(t,e),gameState.placementState.adjacentHighlighted=[],updateUI()):ankiduHint("🛡️ Choisis un ALLIÉ adjacent.")}else if(gameState.placementState.awaitingHexChoice){const{tileCell:t}=gameState.placementState.awaitingHexChoice;if(!isAdj(t,e))return void ankiduHint("🔮 Choisis une case ADJACENTE (vide=TRAP, ennemie=CURSE).");const a=gameState.board[e];a?2===a.p?(handleHexChoice(t,e,"curse"),gameState.placementState.adjacentHighlighted=[],updateUI()):ankiduHint("🔮 Impossible sur un allié. Vise un ennemi ou une case vide."):(handleHexChoice(t,e,"trap"),gameState.placementState.adjacentHighlighted=[],updateUI())}else if(null!==gameState.placementState.selectedWheel&&isCellEmpty(e)){if(1===gameState.placementState.pendingPlacements.length&&2===maxTilesAllowedForPlayer(gameState.currentPlayer)&&!gameState.placementState.adjacentHighlighted.includes(e))return;gameState.placementState.pendingPlacements.length>=maxTilesAllowedForPlayer(gameState.currentPlayer)||placeTile(e)}}function maxTilesAllowedForPlayer(e){return(gameState.turnsTaken?.[e]??0)>=2?1:2}function placeTile(e){const t=gameState.placementState.selectedWheel;let a=gameState.players[0].wheels[t];a===T.ECLIPSE&&gameState.players[0].eclipseUsed&&(a=T.ATK);const n={p:1,t:a,sh:0,cu:null};gameState.placementState.pendingPlacements.push({wheelIndex:t,cellIndex:e,tileType:a}),gameState.board[e]=n,gameState.placementState.selectedWheel=null;const l=gameState.traps.some(t=>t.cell===e&&t.player!==n.p);gameState.placementState.pendingPlacements[gameState.placementState.pendingPlacements.length-1].trapped=l,l||(a===T.WARD?startWardEffect(e):a===T.HEX?startHexEffect(e):a===T.ECLIPSE&&startEclipseEffect(e)),updateAdjacentHighlights(),updateUI()}function startWardEffect(e){const t=ADJ[e].filter(e=>{const t=gameState.board[e];return t&&1===t.p});if(0===t.length){const t=gameState.board[e];t.sh=1,t.cu&&(t.cu=null),gameState.placementState.adjacentHighlighted=[]}else gameState.placementState.awaitingWardTarget={tileCell:e,availableTargets:t},gameState.placementState.adjacentHighlighted=t.slice()}function startHexEffect(e){const t=[],a=[];ADJ[e].forEach(e=>{const n=gameState.board[e];n&&1!==n.p?t.push(e):n||a.push(e)}),gameState.placementState.awaitingHexChoice={tileCell:e,curseTargets:t,trapTargets:a},gameState.placementState.adjacentHighlighted=[...t,...a]}function startEclipseEffect(e){gameState.placementState.awaitingEclipseChoice={tileCell:e,wheelIndex:gameState.placementState.pendingPlacements[gameState.placementState.pendingPlacements.length-1].wheelIndex}}function handleWardTarget(e,t){const a=gameState.board[e],n=gameState.board[t];a.sh=1,a.cu&&(a.cu=null),n.sh=1,n.cu&&(n.cu=null),gameState.placementState.awaitingWardTarget=null,updateUI()}function handleHexChoice(e,t,a){if("curse"===a)gameState.board[t]&&armCurse(t,1);else if("trap"===a){const e=gameState.traps;for(let t=e.length-1;t>=0;t--)1===e[t].player&&e.splice(t,1);e.push({cell:t,player:1}),rebuildTrapIndex()}gameState.placementState.awaitingHexChoice=null,updateUI()}function handleEclipseChoice(e,t){gameState.board[e].t=t,gameState.placementState.awaitingEclipseChoice=null,t===T.WARD?startWardEffect(e):t===T.HEX?startHexEffect(e):gameState.placementState.adjacentHighlighted=[],Ankidu.say(`🌙 ECLIPSE: Affinity ${ICON[t]} chosen. You can continue your turn.`),updateUI()}function rollFaces(e,t=!0){const a=gameState.players[e],n=!a.eclipseUsed;let l=!1;for(let e=0;e<5;e++){if(t&&a.usedWheels.includes(e))continue;const i=n&&!l?[T.ATK,T.HEX,T.WARD,T.ECLIPSE]:[T.ATK,T.HEX,T.WARD],s=i[Math.random()*i.length|0];s===T.ECLIPSE?(a.wheels[e]=T.ECLIPSE,l=!0):a.wheels[e]=s}}function rerollAction(){const e=gameState.currentPlayer;1===e&&"place"===gameState.phase&&(gameState.placementState.pendingPlacements.length>0||gameState.firstMoveDone?.[e]&&(gameState.rerollUsedThisTurn||gameState.rerollsLeft[e]<=0||(rollFaces(0,!0),gameState.rerollsLeft[e]--,gameState.rerollUsedThisTurn=!0,updateUI())))}function validateAction(){if(0===gameState.placementState.pendingPlacements.length)return;if(gameState.placementState.awaitingWardTarget||gameState.placementState.awaitingHexChoice||gameState.placementState.awaitingEclipseChoice)return;const e=gameState.placementState.pendingPlacements.slice();e.forEach(e=>{gameState.players[0].usedWheels.includes(e.wheelIndex)||gameState.players[0].usedWheels.push(e.wheelIndex),gameState.players[0].wheels[e.wheelIndex]===T.ECLIPSE&&(gameState.players[0].eclipseUsed=!0)});const t=[];for(const a of e)if(a.trapped){const e=gameState.traps.findIndex(e=>e.cell===a.cellIndex&&2===e.player);if(e>=0){const n=gameState.board[a.cellIndex];n.sh>0?n.sh=0:(t.push({idx:a.cellIndex,from:n.p,to:2,src:"TRAP"}),n.p=2),gameState.traps.splice(e,1),rebuildTrapIndex()}}if(t.push(...resolveCombatSimultaneousOn(gameState.board,1)),gameState.lastFlips=t.slice(),gameState.placementState.pendingPlacements=[],gameState.placementState.adjacentHighlighted=[],gameState.rerollUsedThisTurn=!1,gameState.turnSerial++,resolveCursesForPlayer(1),!1===gameState.firstMoveDone[1]&&(gameState.firstMoveDone[1]=!0),gameState.turnsTaken[1]=(gameState.turnsTaken[1]||0)+1,gameState.turnsTaken[1]>=3&&gameState.turnsTaken[2]>=3)return gameState.lastFlips=gameState.lastFlips||[],gameState.phase="end",updateUI(),endRound();gameState.currentPlayer=2,updateUI(),setTimeout(simulateAITurn,800)}function cancelAction(){if(0===gameState.placementState.pendingPlacements.length)return;const e=gameState.placementState.pendingPlacements.pop();gameState.board[e.cellIndex]=null,gameState.placementState.awaitingWardTarget=null,gameState.placementState.awaitingHexChoice=null,gameState.placementState.awaitingEclipseChoice=null,updateAdjacentHighlights(),updateUI()}function resetAction(){gameState.placementState.pendingPlacements.forEach(e=>{gameState.board[e.cellIndex]=null}),gameState.placementState.pendingPlacements=[],gameState.placementState.selectedWheel=null,gameState.placementState.adjacentHighlighted=[],gameState.placementState.awaitingWardTarget=null,gameState.placementState.awaitingHexChoice=null,gameState.placementState.awaitingEclipseChoice=null,updateUI()}function isCellEmpty(e){return null===gameState.board[e]&&!gameState.placementState.pendingPlacements.some(t=>t.cellIndex===e)}function updateAdjacentHighlights(){if(gameState.placementState.adjacentHighlighted=[],1===gameState.placementState.pendingPlacements.length&&2===maxTilesAllowedForPlayer(gameState.currentPlayer)){const e=gameState.placementState.pendingPlacements[0],t=ADJ[e.cellIndex];gameState.placementState.adjacentHighlighted=t.filter(e=>isCellEmpty(e))}}function doesTileBeat(e,t){return BEATS[e]===t}function resolveCombatSimultaneousOn(e,t,a){const n=SCR.atk;for(let e=0;e<9;e++)n[e].p1=0,n[e].p2=0;for(let t=0;t<9;t++){const a=e[t];if(!a)continue;const l=ADJ[t];for(const t of l){const l=e[t];l&&l.p!==a.p&&doesTileBeat(a.t,l.t)&&(1===a.p?n[t].p1++:n[t].p2++)}}const l=[];for(let i=0;i<9;i++){const s=e[i];if(!s)continue;let{p1:o,p2:c}=n[i];(o||c)&&(s.sh>0&&(o>c?o--:c>o||1===t&&c>0?c--:2===t&&o>0&&o--,a&&a(i),e[i].sh=0),o>c&&1!==s.p?(l.push({idx:i,from:s.p,to:1,src:"RPS"}),a&&a(i),e[i].p=1):c>o&&2!==s.p&&(l.push({idx:i,from:s.p,to:2,src:"RPS"}),a&&a(i),e[i].p=2))}return l}function resolveCursesForPlayer(e){const t=[];for(let a=0;a<9;a++){const n=gameState.board[a];if(!n||!n.cu)continue;const l=n.cu;if(n.p===e&&gameState.turnSerial>=l.triggerOn)if(n.sh>0)n.cu=null;else{const e=l.by,i=n.p;i!==e&&(n.p=e,t.push({idx:a,from:i,to:e,src:"CURSE"})),n.cu=null}}t.length&&(gameState.lastFlips=t)}function makeCOW(e,t,a){return function(n){return t[n]===e[n]&&(a.push([n,e[n]]),t[n]=t[n]?{...t[n]}:null,!0)}}function scoreBoardFor(e,t){const a=[0,2,6,8];let n=0;for(let l=0;l<9;l++){const i=t[l];if(!i)continue;const s=i.p===e?1:-1;n+=s,4===l?n+=2*s:a.includes(l)&&(n+=1*s);const o=ADJ[l];let c=0,r=0;for(const e of o){const a=t[e];a&&a.p!==i.p&&(doesTileBeat(i.t,a.t)&&c++,doesTileBeat(a.t,i.t)&&r++)}n+=.4*s*c-.3*s*r}return n}function simulatePlacementAndResolve(e,t,a,n,l,i={}){const s=n.slice(),o=[],c=makeCOW(n,s,o),r={p:e,t:t,sh:0,cu:null},d=1===e?2:1,m=l.some(e=>e.cell===a&&e.player===d);if(o.push([a,s[a]]),s[a]=r,m)r.sh>0?r.sh=0:r.p=d;else if(t===T.WARD){r.sh=1;const t=ADJ[a].filter(t=>s[t]&&s[t].p===e);if(t.length){let a=t[0],n=-1;for(const l of t){const t=ADJ[l];let i=0;for(const a of t){const t=s[a];t&&t.p!==e&&doesTileBeat(t.t,s[l].t)&&i++}i>n&&(n=i,a=l)}c(a),s[a]={...s[a],sh:(s[a].sh||0)+1,cu:null}}}else if(t===T.HEX){const t=ADJ[a].filter(e=>s[e]&&s[e].p===d),n=ADJ[a].filter(e=>!s[e]);let l=!1;if(t.length){const a=t.includes(4)?4:t[0];"number"==typeof a&&s[a]&&(c(a),s[a]={...s[a],cu:{by:e,triggerOn:1/0}},l=!0)}!l&&n.length}return resolveCombatSimultaneousOn(s,e,c),s}function evaluateMove(e,t,a,n,l){return scoreBoardFor(e,simulatePlacementAndResolve(e,t,a,n,l))}function simulateAITurn(){if(isRoundComplete())return endRound();if(canUseOmenNow()&&2===gameState.currentPlayer){let e=null,t=-1e9;for(const a of gameState.lastFlips){const n=gameState.board.map(e=>e?{...e}:null);n[a.idx]&&(n[a.idx].p=a.from);const l=scoreBoardFor(2,n)-scoreBoardFor(2,gameState.board);l>t&&(t=l,e=a.idx)}null!==e&&(applyOmenOn(e),updateUI())}const e=gameState.players[1],t=[];for(let a=0;a<5;a++)e.usedWheels.includes(a)||t.push(a);const a=[];for(let e=0;e<9;e++)isCellEmpty(e)&&a.push(e);if(!t.length||!a.length)return gameState.currentPlayer=1,void updateUI();let n=null,l=-1e9,i=null;for(const s of t){const t=e.wheels[s];for(const e of a)if(t===T.ECLIPSE)for(const t of[T.ATK,T.HEX,T.WARD]){const a=evaluateMove(2,t,e,gameState.board,gameState.traps);a>l&&(l=a,n={wheelIndex:s,cellIndex:e,type:T.ECLIPSE},i=t)}else{const a=evaluateMove(2,t,e,gameState.board,gameState.traps);a>l&&(l=a,n={wheelIndex:s,cellIndex:e,type:t},i=null)}}if(l<=scoreBoardFor(2,gameState.board)-.1&&gameState.rerollsLeft[2]>0&&!0===gameState.firstMoveDone[2])return rollFaces(1,!0),gameState.rerollsLeft[2]--,setTimeout(simulateAITurn,200);const s=n.wheelIndex;let o=n.type;const c=n.cellIndex,r={p:2,t:o,sh:0,cu:null};gameState.board[c]=r,gameState.players[1].usedWheels.push(s);const d=gameState.traps.some(e=>e.cell===c&&1===e.player);if(!d)if(o===T.WARD){r.sh=1;const e=ADJ[c].filter(e=>gameState.board[e]&&2===gameState.board[e].p);if(e.length){let t=e[0],a=-1;for(const n of e){const e=ADJ[n];let l=0;for(const t of e){const e=gameState.board[t];e&&1===e.p&&doesTileBeat(e.t,gameState.board[n].t)&&l++}l>a&&(a=l,t=n)}gameState.board[t].sh=(gameState.board[t].sh||0)+1,gameState.board[t].cu&&(gameState.board[t].cu=null)}}else if(o===T.HEX){const e=ADJ[c],t=e.filter(e=>gameState.board[e]&&1===gameState.board[e].p),a=e.filter(e=>!gameState.board[e]);if(t.length){const e=t.includes(4)?4:t[0];"number"==typeof e&&gameState.board[e]&&armCurse(e,2)}else if(a.length){gameState.traps=gameState.traps.filter(e=>2!==e.player);const e=a.sort((e,t)=>{const a=4===e?2:[0,2,6,8].includes(e)?1:0;return(4===t?2:[0,2,6,8].includes(t)?1:0)-a})[0];gameState.traps.push({cell:e,player:2})}}else o===T.ECLIPSE&&(r.t=i||T.ATK,r.t===T.WARD&&(r.sh=1),gameState.players[1].eclipseUsed=!0);const m=[];if(d){const e=gameState.traps.findIndex(e=>e.cell===c&&1===e.player);e>=0&&(r.sh>0?r.sh=0:(m.push({idx:c,from:r.p,to:1,src:"TRAP"}),r.p=1),gameState.traps.splice(e,1),rebuildTrapIndex())}const u=resolveCombatSimultaneousOn(gameState.board,2);gameState.lastFlips=m.concat(u),gameState.turnSerial++,resolveCursesForPlayer(2),gameState.turnsTaken[2]=(gameState.turnsTaken[2]||0)+1,!1===gameState.firstMoveDone[2]&&(gameState.firstMoveDone[2]=!0),setTimeout(()=>{gameState.currentPlayer=1,gameState.currentTurn++,gameState.currentTurn>3?endRound():gameState.phase="place",updateUI()},300),updateUI()}function endRound(){gameState.lastFlips=[],gameState.omen={1:0,2:0},gameState.phase="end";const e=gameState.board.filter(e=>e&&1===e.p).length,t=gameState.board.filter(e=>e&&2===e.p).length;let a="TIE";return e>t?(gameState.roundWins[1]+=1,a="P1"):t>e&&(gameState.roundWins[2]+=1,a="P2"),gameState.roundResults.push(a),2===gameState.roundWins[1]||2===gameState.roundWins[2]||gameState.currentRound>=3?endGame():(gameState.currentRound++,void seedRound())}function seedRound(){const e=document.getElementById("hud");e&&(e.style.display="block"),"function"==typeof Ankidu.clear&&Ankidu.clear(),gameState.gameOver=!1,gameState.phase="place",gameState.placementState={selectedWheel:null,pendingPlacements:[],adjacentHighlighted:[],awaitingWardTarget:null,awaitingHexChoice:null,awaitingEclipseChoice:null},gameState.lastFlips=[],gameState.turnSerial=0,gameState.board=Array(9).fill(null),gameState.traps=[],gameState.lastFlips=[],rebuildTrapIndex(),gameState.currentTurn=1,gameState.rerollsLeft={1:2,2:2},gameState.rerollUsedThisTurn=!1,gameState.firstMoveDone={1:!1,2:!1},gameState.turnsTaken={1:0,2:0},gameState.players.forEach(e=>{e.usedWheels=[],e.rerollsUsed=0,e.eclipseUsed=!1}),rollFaces(0,!1),rollFaces(1,!1);const t=Math.random()<.5?1:2;gameState.currentPlayer=t,gameState.omen=1===t?{1:0,2:1}:{1:1,2:0},gameState.phase="place",updateUI(),2===t?(Ankidu.say("I'm starting...",[]),setTimeout(simulateAITurn,2e3)):updateSpecialEffects()}function endGame(){gameState.lastFlips=[],gameState.gameOver=!0,document.querySelectorAll(".btn").forEach(e=>e.disabled=!0);const e=gameState.roundWins[1],t=gameState.roundWins[2],a=document.getElementById("hud");let n,l;a&&(a.style.display="none"),n=e>t?`You won the match (${e}–${t}).\n\n“I grant you the time you came for. Cherish those new lives.”`:t>e?`I won the match (${t}–${e}).\n\n“Forgive me — the night takes as it gives. Try again, and I may yet bend the hours in your favor.”`:"Draw.\n\n“Shadows linger. One more round?”",l=[{label:"Rematch",onClick:()=>rematchAction()}],Ankidu.say(n,l),updateUI()}function rebuildTrapIndex(){trapByCell.fill(0);for(const e of gameState.traps)trapByCell[e.cell]=1===e.player?1:2}window.onload=function(){initializeUI()}</script>