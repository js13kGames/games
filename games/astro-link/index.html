<!doctype html><title>Astro Link</title><style>body,html{width:100%;height:100%;margin:0;border:0;overflow:hidden;display:block}</style><script src=/2018/webxr/aframe.js></script><script>AFRAME.registerComponent("restart",{schema:{}});var PolyLine=function(e,t=65280,i=.5){this.geometry=new THREE.BufferGeometry,this.vertices=new Float32Array(12),this.width=e,this.geometry.addAttribute("position",new THREE.BufferAttribute(this.vertices,3).setDynamic(!0)),this.material=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,color:t,opacity:i,transparent:!0}),this.mesh=new THREE.Mesh(this.geometry,this.material),this.mesh.drawMode=THREE.TriangleStripDrawMode,this.mesh.frustumCulled=!1,this.mesh.vertices=this.vertices,this.direction=new THREE.Vector3};PolyLine.prototype={setDirection:function(e){var t=new THREE.Vector3(0,1,0);this.direction.copy(e).cross(t).normalize().multiplyScalar(this.width/2)},setWidth:function(e){this.width=e},setPoint:function(){var e=new THREE.Vector3,t=new THREE.Vector3;return function(i){e.copy(i).add(this.direction),t.copy(i).sub(this.direction);var r=6;this.vertices[r++]=e.x,this.vertices[r++]=e.y,this.vertices[r++]=e.z,this.vertices[r++]=t.x,this.vertices[r++]=t.y,this.vertices[r++]=t.z,this.geometry.attributes.position.needsUpdate=!0}}()},AFRAME.registerComponent("levelup",{schema:{level:{default:1}},init:function(){this.cycl=document.createElement("a-entity"),this.cycl.setAttribute("position","0 0.0 0"),this.cycl.setAttribute("geometry","primitive: cylinder; radius: 0.5; height: 2.0"),this.cycl.setAttribute("material","color: yellow"),this.el.appendChild(this.cycl)}}),AFRAME.registerComponent("power",{schema:{},init:function(){this.cone=document.createElement("a-entity"),this.cone.setAttribute("position","0 1.0 0"),this.cone.setAttribute("geometry","primitive: cone; radius-bottom: 0.5; radius-top: 0.0"),this.cone.setAttribute("material","color: green"),this.el.appendChild(this.cone)}}),AFRAME.registerComponent("portable",{schema:{maxCountdown:{default:1e3},colour:{default:"#fff"},portedTo:{default:!1},position:{default:-1}},init:function(){this.countdown=this.data.maxCountdown,this.inFocus=!1,this.el.setAttribute("material","color: "+this.data.colour),this.el.addEventListener("mouseenter",(()=>{this.el.setAttribute("scale","1.2 1.2 1.2"),this.inFocus=!0})),this.el.addEventListener("mouseleave",(()=>{this.el.setAttribute("scale","1.0 1.0 1.0"),this.el.setAttribute("material","color: "+this.data.colour),this.inFocus=!1}))},update:function(e){e.portedTo!=this.data.portedTo&&1==this.data.portedTo&&(this.torus=document.createElement("a-entity"),this.torus.setAttribute("position","0 1.0 0"),this.torus.setAttribute("geometry","primitive: torus; arc: 360; radius: 0.25; radius-tubular: 0.05"),this.torus.setAttribute("rotation","-90 0 0"),this.torus.setAttribute("material","color: #00D4FF"),this.el.appendChild(this.torus))},tick:function(e,t){if(1==this.inFocus){this.countdown-=t;var i=new THREE.Color(this.data.colour),r=this.countdown/this.data.maxCountdown;i.r=Math.max(0,i.r*r),i.g=Math.max(0,i.g*r),i.b=Math.max(0,i.b*r),this.el.setAttribute("material","color: #"+i.getHexString())}else this.countdown=this.data.maxCountdown;0>=this.countdown&&(document.querySelector("a-scene").systems["game-system"].el.emit("jump",{dest:this},!1),this.countdown=this.data.maxCountdown)}}),AFRAME.registerSystem("game-system",{schema:{power:{default:5},maxPower:{default:20},height:{default:0},maxHeight:{default:0}},init:function(){console.log("Game System Init"),this.levelNum=1,this.random=this.seed(this.levelNum),this.level=[],this.levelWH=20,this.levelSZ=this.levelWH*this.levelWH,this.generateFloor(this,0,1,0),this.money=0,this.chain=[],this.restartText=null,this.listener=new THREE.AudioListener,this.listenerAdded=!1;var e=document.createElement("a-entity");e.setAttribute("position","10 0 -10"),e.setAttribute("geometry","primitive: icosahedron; radius: 1"),e.setAttribute("portable","colour: #6600DD; portedTo: true; position: "+this.level.length),e.setAttribute("power",""),this.el.appendChild(e),this.chain.push(e),this.level.push(e),document.querySelector("#camera-rig").setAttribute("position","10 1.6 -10");var t=this.data,i=this;this.el.addEventListener("jump",(function(e){var r=document.querySelector("#camera-rig");if(0<t.power){var o=new THREE.Vector3;e.detail.dest.el.object3D.getWorldPosition(o),e.detail.dest.el.setAttribute("material","color: "+e.detail.dest.data.colour),o.y+=1.6;var s=r.object3D.position.clone();s.sub(o),r.setAttribute("position",o);var l=document.querySelector("#height-marker"),n=Math.floor(o.y);l.setAttribute("value",n+"m"),e.detail.dest.line=new PolyLine(1),e.detail.dest.line.setDirection(s),e.detail.dest.line.setPoint(s);var a=document.createElement("a-entity");if(a.setObject3D("mesh",e.detail.dest.line.mesh),e.detail.dest.el.appendChild(a),e.detail.dest.line=a,--t.power,null!=e.detail.dest.el.components.power&&0==e.detail.dest.el.components.portable.data.portedTo&&(t.power+=5,t.power>t.maxPower&&(t.power=t.maxPower)),0>=t.power&&null==i.restartText&&(i.restartText=document.createElement("a-entity"),i.restartText.setAttribute("position","0 1 -2.5"),i.restartText.setAttribute("geometry","primitive: plane; width: 1; height: 1;"),i.restartText.setAttribute("portable","colour: #444444; position: "+i.level.length),i.restartText.setAttribute("restart",""),i.restartText.setAttribute("text","value: RESTART; width:5; align:center"),i.restartText.system=i,e.detail.dest.el.appendChild(i.restartText)),null!=e.detail.dest.el.components.levelup&&i.levelNum<e.detail.dest.el.components.levelup.data.level){i.levelNum=e.detail.dest.el.components.levelup.data.level;for(var u=i.chain.splice(0),d=0;d<u.length;++d)i.money+=10*(d+1);t.power+=5,t.power>t.maxPower&&(t.power=t.maxPower),i.generateFloor(i,o.x,o.y/10,o.z)}if(0==i.chain.includes(e.detail.dest.el))i.chain.push(e.detail.dest.el);else{var h,c=i.chain.indexOf(e.detail.dest.el);for(u=i.chain.splice(c+1),d=0;d<u.length;++d)-1!=(h=u[d].components.portable.data.position)&&(i.level[h]=void 0),i.el.removeChild(u[d]),i.money+=10*(d+1);e.detail.dest.el.removeChild(e.detail.dest.line)}}else if(null!=e.detail.dest.el.components.restart){i.levelNum=1,i.generateFloor(i,0,1,0),i.money=0,t.power=i.data.power=5,t.height=i.data.height=0,i.chain=[],i.restartText=null;var m=document.createElement("a-entity");m.setAttribute("position","10 0 -10"),m.setAttribute("geometry","primitive: icosahedron; radius: 1"),m.setAttribute("portable","colour: #6600DD; portedTo: true; position: "+i.level.length),m.setAttribute("power",""),i.el.appendChild(m),i.chain.push(m),i.level.push(m),r.setAttribute("position","10 1.6 -10")}e.detail.dest.el.setAttribute("portable","portedTo: true")}))},update:function(){},remove:function(){},tick:function(){for(var e=document.querySelector("#power-marker"),t="",i=0;i<this.data.power;++i)t+="I";e.setAttribute("value",t),document.querySelector("#money-marker").setAttribute("value","$"+this.money)},seed:function(e){return function(){return(e=1e4*Math.sin(e))-Math.floor(e)}},generateFloor:function(e,t,i,r){for(var o=0;o<e.level.length;++o)null!=e.level[o]&&e.el.removeChild(e.level[o]);e.level=[];for(o=0;o<e.levelSZ;++o)if(1==25>100*e.random()){var s=r+(o%e.levelWH*10+10*e.random()),l=t+(o/e.levelWH*10+10*e.random()),n=10*i+10*e.random();if(1==25>e.random()*e.levelSZ)(a=document.createElement("a-entity")).setAttribute("position",l-100+" "+n+" "+(s-100)),a.setAttribute("geometry","primitive: icosahedron; radius: 1"),a.setAttribute("portable","colour: #6600DD; position: "+this.level.length),a.setAttribute("power",""),a.system=e,e.el.appendChild(a),this.level.push(a);else(a=document.createElement("a-entity")).setAttribute("position",l-100+" "+n+" "+(s-100)),a.setAttribute("geometry","primitive: icosahedron; radius: 1"),a.setAttribute("portable","colour: #FF1144; position: "+this.level.length),a.system=e,e.el.appendChild(a),this.level.push(a)}var a=document.createElement("a-entity"),u=new THREE.Vector3(100*e.random()-50,10*i+30,100*e.random()-50);a.setAttribute("position",u.x+" "+u.y+" "+u.z),a.setAttribute("geometry","primitive: icosahedron; radius: 1"),a.setAttribute("portable","colour: #663C00; position: "+this.level.length),a.setAttribute("levelup","level: "+e.levelNum+1),a.system=e,e.el.appendChild(a);var d=new PolyLine(1,65520,.25);u.y*=-1,d.setDirection(u),d.setPoint(u);var h=document.createElement("a-entity");h.setObject3D("mesh",d.mesh),a.appendChild(h),a.line=h,this.level.push(a)}})</script><body><a-scene fog="type: exponential; density: 0.035; color: #330022"><a-sky color=#330033></a-sky><a-entity position="0.0 0.1 0.0" id=camera-rig><a-entity id=camera camera look-controls><a-cursor><a-entity position="-0.1 0 0"><a-text align=right id=power-marker opacity=0.25 value="" width=2.5></a-text></a-entity><a-entity position="0.1 0.1 0"><a-text align=left id=height-marker opacity=0.25 value=0m width=1.5></a-text></a-entity><a-entity position="0.1 -0.1 0"><a-text align=left id=money-marker opacity=0.25 value=$0 width=1.5></a-text></a-entity></a-entity></a-entity></a-scene>