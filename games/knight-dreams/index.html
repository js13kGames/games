<title>Knight Dreams - js13kGames 2023</title><body style=overflow:hidden;background-color:#000><script>const p=(t,i)=>t+(Math.random()*(i-t+1)|0),y=(t,i,h)=>(i=(1-t)*i[0]+t*i[1]|0)+(Math.random()*(((1-t)*h[0]+t*h[1]|0)-i+1)|0),m=(t,i,h)=>{let s,e=Math.random(),a=t[0],r=i[0],o=Math.min(t.length,i.length),f=(1-h)*a+h*r;for(s=0;s<o&&!(e<f);++s)s<o-1&&(a=t[s+1],r=i[s+1],f+=(1-h)*a+h*r);return s};class F{constructor(t,i,h,s,e,a){this.i=void 0,this.g=t,this.h=Array.from(i),this.m=h,this.type=s,this.u=e,this.l=a}play(t){const i=["setValueAtTime","linearRampToValueAtTime","exponentialRampToValueAtTime"],h=this.g.currentTime,s=this.g.createOscillator(),e=this.g.createGain();s.type=this.type,t*=this.m,s.frequency.setValueAtTime(this.h[0],h),e.gain.setValueAtTime(.2*t,h),e.gain.exponentialRampToValueAtTime(Math.max(Math.min(t,1),.01),h+this.l/60);let a,r,o=0;for(let t=0;t<this.h.length;t+=2)a=this.h[t],r=this.h[t+1],s.frequency[i[this.u]](a,h+o),o+=1/60*r;e.gain.exponentialRampToValueAtTime(.5*t,h+o),s.connect(e).connect(this.g.destination),s.start(h),s.stop(h+o),s.onended=()=>s.disconnect(),this.i?.disconnect(),this.i=s}}function v(t,i,h=1){if(t.g)try{i.play(h*t.wa)}catch(t){}}class G{constructor(){this.W=(t,i=1,h="square",s=2,e=2)=>new F(this.h,t,i,h,s,e),this.toggle=(t=!this.g)=>this.g=t,this.h=new AudioContext,this.g=!0}}class e{constructor(t=0,i=0){this.g=()=>new e(this.x,this.y),this.x=t,this.y=i}}function h(t){let i=window.innerWidth,h=window.innerHeight,s=Math.min(i/t.width,h/t.height);1<s&&(s|=0),t.g.style.width=String(s*t.width|0)+"px",t.g.style.height=String(s*t.height|0)+"px",t.g.style.left=String(i/2-s*t.width/2|0)+"px",t.g.style.top=String(h/2-s*t.height/2|0)+"px"}function w(t,i,h=0,s=0,e=0,a=0,r=i.width,o=i.height,f=0){var n=t.T,l=0!=f;e|=0,a|=0,r|=0,o|=0,h=h+t.H.x|0,s=s+t.H.y|0,l&&n.save(),1&f&&(n.translate(r,0),n.scale(-1,1),h*=-1),2&f&&(n.translate(0,o),n.scale(1,-1),s*=-1),n.drawImage(i,e,a,r,o,h,s,r,o),l&&n.restore()}function g(i,h,s,e,a,r=0,o=0,f=0){let n=h.width/16|0,l=e;1==f&&(l=e-=s.length*(n+r)/2);for(let t=0;t<s.length;++t)10==(f=s.charCodeAt(t))?(l=e,a+=n+o):(w(i,h,l,a,(f-=32)%16*n,(f/16|0)*n,n,n),l+=n+r)}class H{constructor(){var t,i;this.h="#ffffff",this.width=192,this.height=144,[this.g,this.T]=((i=document.createElement("canvas")).setAttribute("style","position: absolute; top: 0; left: 0; z-index: -1;"),i.setAttribute("style","position: absolute; top: 0; left: 0; z-index: -1;image-rendering: optimizeSpeed;image-rendering: pixelated;image-rendering: -moz-crisp-edges;"),i.width=192,i.height=144,(t=document.createElement("div")).setAttribute("style","position: absolute; top: 0; left: 0; z-index: -1;"),t.appendChild(i),document.body.appendChild(t),[i,i.getContext("2d")]),this.T.imageSmoothingEnabled=!1,this.H=new e,window.addEventListener("resize",()=>{h(this)}),h(this)}clear(t){var i=this.T;i.fillStyle=t,i.fillRect(0,0,this.width,this.height),i.fillStyle=this.h}fillColor(t){this.T.fillStyle=this.h=t}fillRect(t=0,i=0,h=this.width,s=this.height){this.T.fillRect(t+this.H.x|0,i+this.H.y|0,0|h,0|s)}moveTo(t=0,i=0){this.H.x=t,this.H.y=i}move(t,i){this.H.x+=t,this.H.y+=i}}function o(t,i,h){t.g.set(i,h)}function a(t,i,h){const s=new Image;s.onload=()=>{o(t,i,s),++t.loaded},s.src=h,++t.h}class k{constructor(){this.h=this.loaded=0,this.F=t=>this.g.get(t),this.R=t=>this.U.get(t),this.i=()=>this.loaded>=this.h,this.g=new Map,this.U=new Map}}class K{get la(){return this.g.width}get V(){return this.g.height}constructor(t,i,h,s,e){this.o=1,this.g=t,this.S=i,this.input=h,this.audio=s,this.s=e}}class L{constructor(t){this.keys=Array.from(t)}}function i(t,i,h){t.keys.get(i)!==h-2&&(t.keys.set(i,h),t.g||(t.g=!!(1&h)))}function r(t,i,h){t.actions.set(i,new L(h))}function f(t,i){if(void 0===(i=t.actions.get(i)))return 0;let h=0;for(var s of i.keys)if(0!=(h=t.keys.get(s)??0))break;return h}class J{constructor(){this.g=!1,this.keys=new Map,this.h=[],this.actions=new Map,window.addEventListener("keydown",t=>{this.h.includes(t.code)&&t.preventDefault(),i(this,t.code,3)}),window.addEventListener("keyup",t=>{this.h.includes(t.code)&&t.preventDefault(),i(this,t.code,2)}),window.addEventListener("contextmenu",t=>t.preventDefault()),window.addEventListener("mousemove",()=>window.focus()),window.addEventListener("mousedown",()=>window.focus())}update(){var t,i;for(i of this.keys.keys())1<(t=this.keys.get(i))&&this.keys.set(i,t-2);this.g=!1}}class U{constructor(){this.g=void 0,this.S=new Map}update(t){this.g?.update(t)}ha(t,i){this.g?.ha(t,i)}}class V{constructor(){this.m=this.g=0,this.l=!1,this.u=void 0,this.i=new H,this.audio=new G,this.input=new J,this.s=new k,this.S=new U,this.h=new K(this.i,this.S,this.input,this.audio,this.s)}}class t{constructor(){this.g=!1,this.da=()=>this.g}}function x(t,i){for(var h of i)if(!h.da())return h;return t=new t.prototype.constructor,i.push(t),t}const q=[1,2],W=[5,4],s=[12,6],n=[18,12],Y=[2,0],X=[1,0];function l(t){let i=q[t.l],h=W[t.l];return 1==t.l&&(i+=t.X.g??0,h+=t.X.g??0),[i,h]}function Z(t,i){var h=[.67,.33];return 1!=t.h||0!=t.i?(t.K=0,!1):0<--t.K||--t.B<=0&&(t.B=y(i,s,n),t.K=1+m(h,h,1),!0)}class d{constructor(t,i,h=0){this.K=this.G=this.O=this.i=this.v=this.m=0,this.J=!1,(this.X=this).aa=()=>this.g,this.xa=()=>0==this.h,this.qa=()=>0!=this.h&&0==this.i&&!this.J,this.va=()=>Math.min(this.G,this.m),this.width=t,this.g=Y[i],this.h=X[i],this.height=Array(this.width).fill(this.g),this.type=Array(this.width).fill(this.h),this.C=Array(this.width).fill(0),this.u=Array(this.width).fill(0),this.L=Array(this.width).fill(!1),this.A=p(4,16),this.N=p(8,16),this.B=p(s[0],n[0]),this.l=i,this.D=h,0==i&&(h=p(2,(t=this).width/2),i=p(1,3),t.u[h]=i,h=p(h+4,t.width-4),t.u[h]=1+(i-1+p(1,2))%3)}update(t,i){t:{var h=[.67,.33],[s,e]=(this.O=this.i,--this.v<=0&&(this.i=0),l(this));if(1==this.h&&1==this.l){var a=this.g-this.X.g;if(-1==this.X.i&&a<=2||a<=1){this.i=-1,this.A=2,this.v=0,this.g-=this.i,++this.m;break t}}1==this.h&&2<=this.m&&--this.A<=0&&(this.v=Math.min(this.m-1,1+m(h,h,1)),this.A=this.v-1+p(4,16),this.i=Math.random()<.5?-1:1,(h=this.g-this.i*this.v)!=Math.max(Math.min(h,e),s)&&(this.i*=-1),++this.m),this.g-=this.i}var h=[[2,2,2],[4,2,0]],a=[[4,16,6],[16,10,0]],[r,o]=l(this);0==this.h&&++this.G,--this.m<=0&&0==this.O&&(1!=this.h?((this.h=1)==this.l&&(this.g=p(r,o)),this.G=0):(this.h=!this.J&&Math.random()<[.33,0][this.l]?2:0,0==this.l&&0==this.h&&(this.g=p(Math.max(r,this.g-2),Math.min(o,this.g+2)))),this.m=p(h[this.l][this.h],a[this.l][this.h])),this.u[t]=0,(this.L[t]=this.J=Z(this,i))||0<--this.N||1!=this.h||0!=this.i||0==this.l&&0!==this.X.h||(i=m(i=[.2,.3,.5],i,1)+1,3==(i=0==this.l&&1==this.X.h&&this.X.g-this.g<=2?3:i)&&(this.A<=2||this.m<=1)&&(i=2),this.u[t]=i,this.N=p(8,16),3==i&&(this.B=Math.max(this.B+1,1))),this.height[t]=this.g,this.type[t]=this.h,this.C[t]=this.i}P(i,h,s,e){var a=[80,32,96],r=[0,0,-1],o=i.height/16|0;for(let t=0;t<this.width;++t){var f,n=(t+s)%this.width,l=this.C[n],d=16*t-(0|e)-32+this.D,g=o-this.height[n],u=this.width,c=(u=1!=this.type[((n-1)%u+u)%u],1!=this.type[(1+n)%this.width]);switch(0!=this.u[n]&&w(i,h,d+[,-8,0,8][f=this.u[n]],16*g+[,-33,-16,-16][f],[,160,24,0][f],[,0,48,48][f],[,32,16,24][f],[,33,16,16][f]),this.type[n]){case 1:for(f=a[l+1],u?f-=16:c&&(f+=16),w(i,h,d,16*g+16*r[l+1],f,0,16,32),f=32,u?f-=16:c&&(f+=16),l=g+r[l+1]+2;l<o;++l)w(i,h,d,16*l,f,l==g?0:16,16,16);u&&w(i,h,d-16,16*g,0,0,16,16),c&&w(i,h,d+16,16*g,64,0,16,16);break;case 2:u||w(i,h,d-16,16*g-2-14,0,64,16,16),c||w(i,h,d+16,16*g-2-14,32,64,16,16),w(i,h,d,16*g-2-14,16,64,16,16),w(i,h,d,16*g-2,96,32,16,16)}this.L[n]&&w(i,h,d,16*(g-1),112+s%2*16,48,16,16)}}$(i,h,s,e,a){var r=a.V/16|0,o=2+((i.ea().x-this.D)/16|0);for(let t=o-2;t<=2+o;++t){var f=((t+s)%(f=this.width)+f)%f;if(0!=this.type[f]){var n=this.width,l=Number(0==this.type[((f-1)%n+n)%n]),d=Number(0==this.type[(1+f)%this.width]),g=(n=16*t-e-32+this.D,16*(r-this.height[f]));switch(this.C[f]){case 0:M(i,n,g,n+16,g,h,a,l,d);break;case-1:M(i,n,16+g,n+16,g,h,a,0,0);break;case 1:M(i,n,g-16,n+16,g,h,a,0,0)}this.L[f]&&i.ya?.(n+2,g-6,a)}}}}class $ extends t{constructor(){super(),this.type=this.width=0,this.j=new e}Z(t,i,h,s){this.j.x=t,this.j.y=i,this.width=h,this.type=s,this.g=!0}update(t,i){this.g&&(this.j.x-=t*i.o)<=8*-this.width&&(this.g=!1)}P(t,i){if(this.g){var h=Math.round(this.j.x),s=t.height-this.j.y;switch(this.type){case 0:for(var e=0;e<this.width;++e){var a=128;0==e?a-=16:e==this.width-1&&(a+=16),w(t,i,h-8*this.width+16*e,s,a,0,16,16)}for(w(t,i,h-12,16+s,124,16,24,16),a=2;a<((t.height-s)/16|0);++a)w(t,i,h-8,s+16*a,128,32,16,16);break;case 1:if(w(t,i,h-8*this.width-16,s,0,32,16,16),w(t,i,h+8*this.width,s,64,32,16,16),1==this.width)w(t,i,h-8,s,80,32,16,16);else for(e=0;e<this.width;++e)a=32,0==e?a-=16:e==this.width-1&&(a+=16),w(t,i,h-8*this.width+16*e,s,a,32,16,16)}}}$(t,i,h){var s;this.g&&(s=h.V-this.j.y,M(t,this.j.x-8*this.width,s,this.j.x+8*this.width,s,i,h))}}const u=(t,i,h)=>t<i?Math.min(i,t+h):Math.max(i,t-h);function M(t,i,h,s,e,a,r,o=1,f=1,n=0){return!(!t.na||!t.g||t.l||t.speed.y<=n||t.j.x+t.M.x+t.I.x/2*o<i||t.j.x+t.M.x-t.I.x/2*f>s)&&(i=t.j.x*(s=(e-h)/(s-i))+(h-s*i),h=t.j.y+t.M.y+t.I.y/2,a=Math.abs(s*(t.speed.x+a))*r.o,h<i+8+Math.abs(t.speed.y)*r.o+a)&&i-2-a<=h&&(t.j.y=i-t.M.y-t.I.y/2,t.speed.y=0,t.i=!0,t.ma(),1)}class c extends t{constructor(t=0,i=0){super(),this.i=this.l=!1,this.na=!0,this.fa=()=>this.l,this.ea=()=>this.j.g(),this.ka=(t,i,h)=>this.j.x+this.M.x+this.I.x/2>=t.x+i.x-h.x/2&&this.j.x+this.M.x-this.I.x/2<=t.x+i.x+h.x/2&&this.j.y+this.M.y+this.I.y/2>=t.y+i.y-h.y/2&&this.j.y+this.M.y-this.I.y/2<=t.y+i.y+h.y/2,this.ra=t=>this.ka(t.j,t.M,t.I),this.j=new e(t,i),this.speed=new e,this.target=new e,this.D=new e(1,1),this.I=new e,this.M=new e}ia(){return!0}move(t){this.speed.x=u(this.speed.x,this.target.x,this.D.x*t.o),this.speed.y=u(this.speed.y,this.target.y,this.D.y*t.o),this.j.x+=this.speed.x*t.o,this.j.y+=this.speed.y*t.o}ma(){}update(t,i){this.g&&(this.l?this.ia(t,i)&&(this.g=this.l=!1):(this.pa?.(t,i),this.move(i),this.i=!1))}}const A=(t,i,h,s,e)=>{var a=[16,8,8,8][h];w(t,i,s+(16-a)/2,e-6,[32,48,56,48][h],48,a,8,[0,0,0,1][h])};function I(t,i,h){v(h.audio,h.s.R("ak"),.5),t.l=!0,i.ba+=100*(1+i.ga/10)|(t.m=0)}class R extends c{constructor(){super(),this.v=this.A=this.m=this.h=this.type=0,this.g=this.u=!1,this.D=new e(.15,.125)}ia(t,i){return this.j.x-=t*i.o,1<=(this.m+=1/12*i.o)}pa(t,i){let h=2*Math.PI/60,s=2*Math.PI/150,e=1,a=1;switch(this.type){case 1:this.h=(this.h+h*i.o)%(2*Math.PI);break;case 2:this.h=(this.h+.1*i.o)%4;break;case 5:this.speed.x=0,this.i||(this.speed.x=-.5),this.target.x=this.speed.x,e=2,a=.75;case 3:this.i&&3<=(this.h+=.1*e*i.o)&&(this.h=0,this.speed.y=-3.25*a);break;case 4:this.h=(this.h+2/15*i.o)%2,this.target.x=this.speed.x=-.5,this.u&&!this.i&&(this.speed.y=-2.5);break;case 6:this.h=(this.h+s*i.o)%(2*Math.PI),this.target.x=this.speed.x=-.25,this.A=12*Math.sin(this.h),this.j.y=this.v+this.A}(this.j.x-=t*i.o)<-8&&(this.g=!1),this.u=this.i}Z(t,i,h){this.j=new e(t,i);var s=this.speed;s.x=0,s.y=0,(s=this.target).x=0,s.y=0,(s=this.M).x=0,s.y=0,this.v=i,this.type=h,this.g=!0,this.l=!1,i=1==h,h=6==h,this.I=new e(i?12:8,12),this.h=0,i||h||(this.target.y=2.5,this.M.y=2),this.h=(t/16|0)%2*Math.PI*(h?.5:1),this.i=!0,this.u=!1,this.na=!h,this.D.y=h?.05:.15}P(t,i){var h=[0,1,0,2];if(this.g&&0!=this.type){var s,e,a,r=i.F("b"),o=Math.round(this.j.x),f=Math.round(this.j.y),n=1==this.type;if(this.l){if(i=.25+.75*this.m,t.fillColor(n?"#ffaaff":"#ff0000"),r=t.T,!((h=i*i*16|0)>=(n=16*i|0)))for(o+=t.H.x,t=f+t.H.y,o|=0,t|=0,f=-n;f<=n;++f)i=f/n,(i=Math.round(Math.sqrt(1-i*i)*n))<=0||(a=0,Math.abs(f)<h&&(a=f/h,a=Math.round(Math.sqrt(1-a*a)*h)),a<=0?r.fillRect(o-i,t+f,2*i,1):(r.fillRect(o-i,t+f,i-a,1),r.fillRect(o+a,t+f,i-a,1)))}else n?w(t,r,o-8,f-8+Math.round(2*Math.sin(this.h)),48,88,16,16):(n=i.F("b"+String(this.type-1)),s=a=i=0,e=16,[2,3,5].includes(this.type)?(s=h[0|this.h],a=1<Math.abs(this.speed.y)?2*Math.sign(this.speed.y):0):4==this.type&&(e=14,a=2,i=-1),w(t,n,o-8,f-7,16*s,0,16,e),w(t,r,o-5+i,f-3+a+[0,1,-1][s],16+[0,8,0,24,16][this.type-2],112,8,[8,8,4,8,8][this.type-2]),4==this.type?w(t,r,o-8,f+1,48,104+8*(s=0|this.h),16,8):6==this.type&&A(t,r,(this.h/(2*Math.PI)*32|0)%4,o-8,f-5))}}}const C=[4,1],S=[12,6],D=[16,6],j=[32,12],E=[[.5,.3,.2],[.1,.5,.4]],b=[[.4,.3,.2,.1],[.25,.25,.25,.25]];function _(t,i){var h=1==t.l?-10:-8,s=t.i;x(R,t.u).Z(t.D()+8-16*(1-s)-8*s,i.V-16*t.g[s].aa()+h,t.l)}function z(t){return!t.g[t.i].qa()&&!t.g[t.i=1-t.i].qa()}class Q{constructor(t){this.i=this.A=this.C=this.h=this.m=0,this.l=1,this.B=0,this.D=()=>16*this.width-32+this.h%16,this.width=5+(t.la/16|0),this.g=Array(2),this.g[0]=new d(this.width,0),this.g[1]=new d(this.width,1,8),this.g[0].X=this.g[1],this.g[1].X=this.g[0],this.C=p(4,16),this.v=[],this.G=p(C[0],S[0]),this.B=p(D[0],j[0]),this.u=[]}update(t,i,h,s){for(var e of this.v)e.update(h,s);for(var a of this.u){a.update(h,s);var r,o,f,n=h,l=t,d=s;(e=a).g&&l.da()&&!e.fa()&&!l.fa()&&(r=1==e.type,o=e.j.x-10,f=e.j.y+e.M.y+-6,!r&&l.ua(e)?I(e,l,d):!r&&M(l,o,f,20+o,f,n,d,1,1,-1)?(I(e,l,d),(e=l).speed.y=-3,e.B=!0,e.j.y+=-2):e.ra(l)&&(n=l,r?(++n.ga,n.u=Math.min(1,n.u+.15),v(d.audio,d.s.R("ag"),.6)):B(n,d),r)&&(e.l=!0,e.m=0)),this.$(a,h,s)}if(16<=(this.h+=h*s.o)){for(var g of(this.h-=16,this.g))g.update(this.m,i);if(!(0<--this.C||(t=p(1,5),this.g[1].va()<=t/2+1))&&(h=this.g[0].aa(),this.g[1].xa()||(h=this.g[1].aa()),h+=p(3,5),a=m(a=[.75,.25],a,1),5==t?a=0:(h>=this.g[0].aa()+6||t<=2)&&(a=1),g=this.D(),x($,this.v).Z(g,16*h,t,a),this.C=p(t+2,16),Math.random()<.5))for(a=Math.min(3,p(1,t)),t=g+8-16*t/2+16*(Math.random()*(t-a+1)|0),h=s.V-16*h+(1==this.l?-10:-8),g=0;g<a;++g)x(R,this.u).Z(t+16*g,h,this.l);if(c=i,w=s,(0<(u=this).A?z(u)||(--u.A,_(u,w),0):0<--u.G||(u.i=1-u.i,z(u))||(u.l=1==u.l?2+m(b[0],b[1],c):1,u.A=m(E[0],E[1],c),u.G=u.A+y(c,C,S),_(u,w),0))&&!(0<--this.B))for(t=Math.random()<.5?0:1,s=s.V-16*this.g[t].aa()-32,h=m(E[0],E[1],i),this.B=y(i,D,j),i=0;i<h;++i)x(R,this.u).Z(this.D()+8-16*(1-t)-8*t+16*i,s,6);this.m=(this.m+1)%this.width}var u,c,w}P(t,i){var h,s,e=i.F("t");for(h of this.v)h.P(t,e);for(h=1;0<=h;--h)this.g[h].P(t,e,this.m,this.h);for(s of this.u)s.P(t,i)}$(t,i,h){if(t.da()&&!t.fa()){for(var s of this.g)s.$(t,i,this.m,this.h,h);for(var e of this.v)e.$(t,i,h)}}}function tt(t){t.g+=1,t.g<0?t.g=3:3<t.g&&(t.g=0)}function it(t,i,h){if(i<=0)tt(t);else for(t.i+=h;t.i>=i;)t.i-=i,tt(t)}class ht{constructor(){this.i=this.g=0,this.h=()=>this.g}}class st extends t{constructor(){super(...arguments),this.y=this.x=this.h=0}Z(t,i){this.x=t,this.y=i,this.h=1,this.g=!0}update(t,i){this.g&&((this.h-=1/30*i.o)<=0?this.g=!1:this.x-=t*i.o)}P(t,i){this.g&&w(t,i,Math.round(this.x)-4,Math.round(this.y)-4,32+8*Math.round(3*(1-this.h)),72,8,8)}}function T(t){t.J.x=t.j.x+24+64*Math.sin((1-t.h)*Math.PI),t.J.y=t.j.y+3}function B(t,i){t.l=!0,v(i.audio,i.s.R("ad"),.6)}class et extends c{constructor(t){super(64,t),this.v=this.C=0,this.m=!1,this.G=0,this.Y=!1,this.B=!0,this.h=this.A=0,this.N=10,this.u=1,this.ga=this.ca=this.ba=0,this.ua=t=>t.ka(this.J,new e,new e(16,8)),this.oa=()=>this.A,this.sa=()=>this.u,this.ja=()=>this.ba,this.ta=()=>this.ga,this.D=new e(.15,.15),this.I=new e(12,12),this.M=new e(0,2),this.K=new ht,this.O=new ht,this.g=!0,this.J=new e,T(this),this.L=[]}pa(t,i){var h,s=1/180,e=0,a=(1&f(i.input,"r")?e=1:1&f(i.input,"l")&&(e=-1),this.target.x=1.5*e,this.target.y=4,!!(1&(e=f(i.input,"j"))));for(h of(this.Y&&!a&&(this.Y=!1),this.m=0<this.u&&!this.Y&&a,0<this.v&&3==e?(this.C=20,this.i=!1,this.v=0,v(i.audio,i.s.R("aj"),.6)):1&e||(this.C=0),this.m?(this.u=Math.max(0,this.u-s*i.o),0<this.G?(this.G-=i.o,this.speed.y=Math.max(Math.min(this.speed.y-.3*i.o,2),-1.5)):!this.B&&.75<=this.speed.y?(this.speed.y=.75,this.target.y=this.speed.y):this.B&&(this.G=60,this.B=!1)):this.G=0,s=f(i.input,"t"),this.h<=0&&3==s?(this.h=1,v(i.audio,i.s.R("aa"),.6)):.5<this.h&&!(1&s)&&(this.h=1-this.h),0<this.C&&(this.speed.y=-2.75,this.C-=i.o),0<this.v&&(this.v-=i.o),0<this.h&&(this.h-=1/60*i.o),this.speed.x<0&&this.j.x-this.I.x/2<=0?(this.j.x=this.I.x/2,this.speed.x=0):0<this.speed.x&&this.j.x+this.I.x/2>=i.la&&(this.j.x=i.la-this.I.x/2,this.speed.x=0),this.j.y>i.V&&(B(this,i),this.j.y=i.V),this.i?it(this.K,8-2*t,i.o):(s=5,this.speed.y<-.5?s=4:.5<this.speed.y&&(s=6),this.K.g=s),s=this.O.h(),this.m&&(it(this.O,2,i.o),this.O.h()!=s)&&0==s&&v(i.audio,i.s.R("ap"),.6),s=this.m?6:8,e=this.m?1:t,(this.i||this.m)&&(this.N-=e*i.o)<=0&&(this.N+=s,x(st,this.L).Z(this.j.x-4,this.j.y+7)),this.L))h.update(t,i);this.i=!1,6<=(this.ca+=t*i.o)&&(this.ca-=6,this.ba+=1+this.ga/10|0),T(this)}ia(t,i){for(var h of this.L)h.update(t,i);return 60<=(this.A+=i.o)}ma(){this.i=!0,this.v=8,this.Y=!0,this.m=!1,this.B=!0}P(t,i){if(this.g){var h=Math.round(this.j.x)-8,s=Math.round(this.j.y)-7;for(r of(i=i.F("b"),this.L))r.P(t,i);if(this.l){h=["#5555aa","#aaaaff","#ffffff"],s=[7,5,3],i=this.A/60*64;for(var e=0;e<8;++e)for(var a=2*Math.PI/8*e,r=this.j.x+Math.cos(a)*i,o=this.j.y+Math.sin(a)*i,f=0;f<3;++f){t.fillColor(h[(f+(this.A/3|0)%3)%3]);var n,a=r,l=o,d=s[f],g=t.T;a=a+t.H.x|0,l=l+t.H.y|0;for(let t=-d;t<=d;++t)n=t/d,(n=Math.round(Math.sqrt(1-n*n)*d))<=0||g.fillRect(a-n,l+t,2*n,1)}}else for(r=16*[0,1,0,2,0,0,1][this.K.h()],e=40+8*[0,0,0,0,1,0,1][this.K.h()],a=16*[0,1,0,2,1,0,2][this.K.h()],T(this),l=Math.round(this.j.x),d=Math.round(this.J.x),o=Math.round(this.J.y),f=d-l,t.fillColor("#000000"),t.fillRect(l,o-1,f,3),t.fillColor("#aa5500"),t.fillRect(l,o,f,1),w(t,i,d-8,o-3,0,112,16,8),w(t,i,h,s,48,32,16,16),w(t,i,h,s+8,r,e,16,8),this.m?A(t,i,this.O.h(),h,s):w(t,i,h,s-6,a,32,16,8),t.fillColor("#aa0000"),i=0;i<2;++i)t.fillRect(h+7+4*i,s+6,1,1)}}ya(t,i,h){this.g&&!this.l&&this.ka(new e(t+6,i+3),new e,new e(12,6))&&B(this,h)}}class at{constructor(){this.speed=1,this.ea=()=>this.y,this.y=-144}}const N=t=>(t=String(t),"0".repeat(Math.max(0,6-t.length))+t);class rt{constructor(t){this.m=this.v=0,this.L=1,this.l=this.K=this.D=0,this.G=!1,this.h=0,this.i=1,this.O=!1,this.J=0,this.C=!0,this.A=.49,this.Y=!1,this.B=1,this.N=new Q(t),this.g=new et(t.V-40),this.u=new at;t:{try{var i=Number(window.localStorage.getItem("__s"));break t}catch(t){}i=0}this.J=i}update(t){var i,h=1/30,s=this.C?.5:1;if(0<this.i)(this.i-=h*s*t.o)<=0&&2==this.h&&(this.i=1,this.O=!1,this.g=new et(t.V-40),this.N=new Q(t),this.m=this.u.y=0,this.L=1,this.l=this.K=this.D=0,this.B=1,this.h=0);else if(this.A=(this.A+1/60*t.o)%1,this.C)this.v=(this.v+.25*t.o)%48,3==f(t.input,"s")&&(v(t.audio,t.s.R("as"),.6),this.C=!1);else if(this.Y){if(2==this.h)3==f(t.input,"s")&&(v(t.audio,t.s.R("as"),.6),this.i=1,this.O=!0);else if(0==this.h&&3==f(t.input,"p")&&(v(t.audio,t.s.R("as"),.6),this.G=!this.G),!this.G){if(0<this.l&&(this.l-=t.o),this.D+=t.o,this.K<4&&this.D>=1200*(this.K+1)&&(this.L=1+.25*++this.K,this.l=180,v(t.audio,t.s.R("au"),.5)),this.m=u(this.m,this.L,1/60*(2*this.h+1)),this.B=u(this.B,this.g.sa(),1/60*t.o),this.N.update(this.g,this.D/10800,this.m,t),this.g.update(this.m,t),0==this.h&&this.g.fa()){this.h=1,this.L=0,h=this.J=Math.max(this.g.ja(),this.J);try{window.localStorage.setItem("__s",String(h))}catch(t){}}this.g.da()?(this.N.$(this.g,this.m,t),h=this.u,i=this.g.ea().y-t.V/2+24,s=h.y-i,16<=Math.abs(s)&&(h.y=i+16*Math.sign(s)),h.y=Math.min(0,h.y),this.v=(this.v+(.25+.125*this.m)*t.o)%48):this.h=2}}else(h=this.u).speed=Math.min(4,h.speed+.1*t.o),t=0<=(h.y+=h.speed*t.o)&&!(h.y=0),this.Y=t}ha(t,i){var h=i.F("fy"),s=(t.moveTo(),i.F("b"));w(t,i.F("s")),t.move(0,-Math.round(.25*this.u.ea())),t.fillColor("#ffffff"),t.fillRect(0,80,t.width,16);for(var e=-Math.round(this.v),a=0;a<t.width/48+2;++a)w(t,s,e+48*a,64,0,56,48,16);for(t.fillColor("#0055aa"),t.fillRect(0,112,t.width,t.height-112),e=0;e<t.width/8;++e)w(t,s,8*e,96,48,56,8,16);if(t.moveTo(),t.moveTo(0,-Math.round(this.u.y)),1==this.h&&this.g.oa()<30&&t.move(4*(2*Math.random()-1)|0,4*(2*Math.random()-1)|0),this.N.P(t,i),this.g.P?.(t,i),t.moveTo(),0<this.h)if(h=i.F("g"),e=i.F("fy"),s=(a=t.width/2)-60,2==this.h&&(t.fillColor("#000000aa"),t.fillRect(),g(t,e,"SCORE: "+N(this.g.ja()),a,80,-1,0,1),g(t,e,"BEST: "+N(this.J),a,96,-1,0,1),.5<=this.A)&&g(t,e,"PRESS ENTER",a,t.height-24,-1,0,1),e=this.g.oa()/60,1==this.h&&e<.5)for(var e=2*(.5-e),a=t.T,r=1+16*(e*=e),o=0;o<h.height;++o)a.drawImage(h,0,o,h.width,1,s+32*Math.sin(8*Math.PI/h.height*o+4*e*Math.PI)*e|0,32+o*r|0,h.width,1);else w(t,h,s,32);else if(!this.C){for(s=["#aaff00","#ffff55","#ffaa00","#aa0000","#000000"],e=["#55aa00","#aaaa00","#aa5500","#550000","#000000"],a=["#000000","#555555"],r=i.F("b"),o=i.F("fw"),t.fillColor("#00000033"),t.fillRect(0,0,t.width,16),w(t,r,t.width/2-8,1,48,80,16,8),g(t,o,N(this.g.ja()),t.width/2,8,-1,0,1),w(t,r,t.width-40,4,32,88,8,8),g(t,o,"#"+String(this.g.ta()),t.width-31,4,-1),w(t,r,2,4,40,88,8,8),r=0;r<2;++r)t.fillColor(a[r]),t.fillRect(12+r,5+r,40-2*r,7-2*r);a=38*this.B|0,r=3-Math.round(3*this.B),1<a&&(t.fillColor(e[r]),t.fillRect(13,6,a,5),t.fillColor(s[r]),t.fillRect(13,6,a-1,4)),this.G?(t.fillColor("#00000055"),t.fillRect(),g(t,h,"PAUSED",t.width/2,t.height/2-4,-1,0,1)):0<this.l&&(60<this.l||0==(this.l/4|0)%2)&&g(t,h,"SPEED UP!",t.width/2,32,-1,0,1)}if(this.C){h=i.F("l"),s=i.F("fy"),i=i.F("fw"),e=t.width,a=t.height,t.fillColor("#00000055"),t.fillRect(),(r=0)<this.i&&(r=this.i*t.height),t.move(0,Math.round(r));var r=e/2-h.width/2,o=(this.A+this.i)*Math.PI*2,f=2*Math.PI,n=t.T,l=(r+=t.H.x,12+t.H.y);for(let t=0;t<h.width;++t){var d=o+t/h.width*f,d=Math.round(4*Math.sin(d));n.drawImage(h,0|t,0,1,h.height,r+t|0,l+d|0,1,h.height)}t.fillRect(24,48,t.width-48,56),g(t,s,"CONTROLS: ",t.width/2,52,0,0,1),g(t,i,"+;/< OR A/D: MOVE",28,62),g(t,i,"+= OR W: JUMP/FLY",28,72),g(t,i,"+SPACE: ATTACK",28,82),g(t,i,"+ENTER: PAUSE",28,92),.5<=this.A&&g(t,s,"PRESS ENTER",e/2,a-28,-1,0,1),g(t,s,"$2023 JANI NYK%NEN",e/2,a-9,-1,0,1),t.moveTo()}this.i<=0||(i=this.i,this.O||(i=1-i),t.fillColor("#000000"),function(i,h,s=i.width/2,e=i.height/2){var a=i.T,r=0|Math.max(0,e-h),o=0|Math.min(i.height,e+h);0<r&&a.fillRect(0,0,i.width,r),o<i.height&&a.fillRect(0,o,i.width,i.height-o);for(let t=r;t<o;++t){var f=t-e;Math.abs(f)>=h?a.fillRect(0,t,i.width,1):(r=Math.round(s-Math.sqrt(h*h-f*f)),f=Math.round(s+Math.sqrt(h*h-f*f)),0<r&&a.fillRect(0,t,r,1),f<i.width&&a.fillRect(f,t,i.width-r,1))}}(t,Math.hypot(t.width/2,t.height/2)*i*i|0))}}const ot=(h,s,t,e,a,r)=>{var o,f;for(let i=t;i<t+8;++i)for(let t=s;t<s+8;++t){f=i*e+t,o=r[a[h.data[4*f]/85|0]];for(let t=0;t<4;++t)h.data[4*f+t]=o[t]}};var O=(h,s)=>{var e=ft,t=document.createElement("canvas"),i=t.getContext("2d"),a=(t.width=h.width,t.height=h.height,i.drawImage(h,0,0),i.getImageData(0,0,h.width,h.height)),r=t.width/8|0,o=t.height/8|0;h=h.width,e=(h=>{var s,e=[];for(let i=0;i<h.length;++i){s=h[i].length/2|0,e.push(Array(s));for(let t=0;t<s;++t)e[i][t]=parseInt(h[i].substring(2*t,2*t+2),16)}return e})(e);let f,n=0;for(let i=0;i<o;++i)for(let t=0;t<r;++t)n>=s.length||(f=(s[n]??"0000").split("").map(t=>parseInt(t,32)),ot(a,8*t,8*i,h,f,e),++n);return i.putImageData(a,0,0),t},P=(t,i,h,s,e)=>{var a=document.createElement("canvas"),r=a.getContext("2d");if(s(r,a.width=t,a.height=i,h),e){for(r.drawImage(a,0,0),h=r.getImageData(0,0,a.width,a.height),t*=i,i=0;i<t;++i){for(s=0;s<3;++s)h.data[4*i+s]=e[s];h.data[4*i+3]=h.data[4*i+3]<192?0:255}r.putImageData(h,0,0)}return a};const ft="00000000 000000ff ffffffff ffff00ff aaff00ff 55aa00ff aa5555ff ffaa55ff ffffaaff aa0000ff ff5500ff aaaa55ff aaaaaaff 555555ff aa5500ff 5555aaff aaaaffff 0055aaff 55aaffff 005500ff aaffffff ff0000ff aaffaaff 55aa55ff 550055ff aa55aaff ffaaffff".split(" "),nt="1540 1540 6670 0880 1E70 19A0 19A0 19A0 1670 1670 1B80 1B80 1E70 19A0 19A0 19A0 1670 1670 1540 1540 1670 1B80 1B80 1B80 6660 6660 1540 1540 1670 1670 1L30 1970 1FG0 1FG0 1FG0 1FG0 1FG0 1FG0 1DC0 1DC0 1B80 1B80 1B80 1B80 1B80 1B80 1DC0 1DC0 1B80 1B80 1B80 1B80 1FG0 1FG0 1FG0 1FG0 H2I0 H2I0 H2I0 H2I0 H2I0 H2I0 0HI2 1780 H2I0 H2I0 H2I0 H2I0 H2I0 H2I0 0HI2 1780 1J50 1J50 1J50 1J50 0B80 0B80 0B80 0B80 1540 1540 1540 1E70 1E70 1E70 3000 3000 1540 1540 1540 0K20 1QP0 14C0 1QP0 1OP0 1DC0 1DC0 1DC0 1DC0 1DC0 1DC0 1OP0 1OP0 1DC0 1DC0 1DC0 1DC0 1DC0 1DC0 1620 1620 1DC0 12C0 1020 1020 1020 1020 1620 1620".split(" "),lt=(r,t,i,h)=>{const o=h[0];for(t=(t,i,h,s,e=0,a=0)=>{r.drawImage(o,8*t,8*i,8,8,8*h+e,8*s+a,8,8)},r.fillStyle="#000000",r.translate(8,0),i=0;i<2;++i)for(r.drawImage(o,12,0,4,8,4,32*i,4,8),r.drawImage(o,8,0,4,8,56,32*i,4,8),h=0;h<6;++h){if(1==i&&(0==h?t(0,2,h+1,5):5==h?t(1,2,h+1,5):t(5,3,h+1,5)),0==i)for(var s=0;s<3;++s)t(0,1,h+1,s+1);t(0,0,h+1,4*i),t(2,0,h+1,4*i+1,0,-2)}for(i=1;i<4;++i)r.drawImage(o,8,8,2,8,8,8*i,2,8),r.drawImage(o,14,8,2,8,54,8*i,2,8);for(t(0,2,9,5),t(1,2,10,5),i=0;i<2;++i)t(0,0,9+i,4),t(2,0,9+i,5,0,-2);for(r.fillRect(8,6,1,2),r.fillRect(55,6,1,2),r.fillRect(8,38,1,2),r.fillRect(55,38,1,2),r.fillRect(72,38,1,2),r.fillRect(87,38,1,2),i=0;i<2;++i){for(h=0;h<4;++h)t(0,1,9+h,2+i);for(s=0;s<2;++s)t(4,2+i,9+s+2*i,2+(h=s*i*2-(i+s))),t(2+i,2,9+s+2*i,1+h),t(2+i,3,9+s+2*i,2+h),t(i,3,9+s+2*i,2+h,0,-1)}for(i=0;i<2;++i)t(4,0,11+i,4),t(4,1,11+i,5),t(3,0,11+i,4,1,5),t(6,3,13+i,7),t(7,3,15+i,7);for(i=0;i<2;++i)t(7,7,20,1+i,4,1);for(t(7,8,20,3,4,1),r.drawImage(o,0,72,32,8,152,5,32,8),i=0;i<2;++i)r.fillRect(160+11*i,4,5,1);for(i=0;i<4;++i)t(2,1,15,5-i),t(3,1,16,5-i);for(r.fillStyle="#aaaa55",r.fillRect(122,16,12,1),r.drawImage(o,40,16,24,8,116,24,24,8),i=0;i<4;++i)t(6,0,14+i,0),t(6,1,14+i,1);for(i=0;i<2;++i)t(5+2*i,0,13+5*i,0),t(5+2*i,1,13+5*i,1);r.translate(-8,0),r.drawImage(o,0,80,24,16,0,48,24,16),r.drawImage(o,0,80,8,16,24,48,8,16),r.drawImage(o,16,80,8,16,32,48,8,16),t(3,10,1,9),t(4,10,2,9),t(4,10,3,9),t(5,10,4,9)},dt=(a,t,i,h)=>{var s,e=(i,h,s)=>{for(let t=-s;t<=s;++t){var e=t/s;(e=Math.round(Math.sqrt(1-e*e)*s))<=0||a.fillRect(i-e|0,h+t|0,2*e,1)}};for(s of(a.fillStyle="#55aaff",a.fillRect(0,0,t,i),a.fillStyle="#aaffff",e(t-48,36,28),a.fillStyle="#55aaff",e(t-66,26,26),[[32,16,0],[84,40,1],[64,8,1],[112,20,0],[8,36,1],[48,48,0],[180,12,0],[180,64,1],[104,64,0],[18,62,1],[32,80,0],[64,72,1],[128,84,1],[176,88,0]]))a.drawImage(h[0],24,88+4*s[2],4,4,s[0],s[1],4,4)},gt=(t,i,h)=>{t.font="bold 18px Arial",t.textAlign="center",t.fillStyle="#ffffff",t.fillText("Game Over!",i/2,h-2)},ut=(t,i,h)=>{t.font="bold 19px Arial",t.textAlign="center",t.fillStyle="#ffffff",t.fillText("Knight Dreams",i/2,h-6)},ct=(t,i,h,s)=>{for(i=-1;i<=2;++i)for(h=-1;h<=1;++h)t.drawImage(s[0],h+1,i+1);t.drawImage(s[1],1,1)},wt=t=>{const h=[["12M0","1NM0"],["12K0","1IK0"],["12Q0","16Q0"],["12C0","1DC0"],["13A0","19A0"]];var s=t.s.F("_b"),e=t.s.F("_f"),i=(a=e,o((i=t).s,"fw",O(a,Array(64).fill("0002"))),o(i.s,"fy",O(a,Array(64).fill("0003"))),e=O(s,nt),o(t.s,"b",e),o(t.s,"t",P(256,128,[e],lt)),o(t.s,"s",P(192,144,[e],dt)),e=P(112,20,[],gt,[255,85,0]),P(112,20,[],gt,[85,0,0])),a=P(132,24,[],ut,[255,85,0]),r=P(132,24,[],ut,[85,0,0]);o(t.s,"g",P(114,22,[i,e],ct)),o(t.s,"l",P(134,26,[r,a],ct)),e="010101111111".split("").map(t=>Number(t)),s=P(48,16,[s],(t,i,h,s)=>{t.drawImage(s[0],0,96,48,16,0,0,48,16)});for(let i=0;i<5;++i)o(t.s,"b"+String(i+1),O(s,e.map(t=>h[i][t])));r=(i=t).audio.W([96,7,112,6,160,5,256,3],.6,"sawtooth",2,6),i.s.U.set("aj",r),r=i.audio.W([128,4,192,4,320,10],.4,"square",0,4),i.s.U.set("ag",r),r=i.audio.W([96,3],.7,"sawtooth",0,2),i.s.U.set("ap",r),r=i.audio.W([96,8,144,8,96,10,64,16],.5,"square",2,6),i.s.U.set("ad",r),r=i.audio.W([224,20],.5,"sawtooth",1,6),i.s.U.set("as",r),r=i.audio.W([320,6,192,4,80,10],.55,"square",1,4),i.s.U.set("ak",r),r=i.audio.W([96,4,128,8,256,6],.4,"square",2,4),i.s.U.set("aa",r),r=i.audio.W([96,6,192,4,128,4,192,6,256,16],.5,"square",1,6),i.s.U.set("au",r),r=i.audio.W([128,8],.5,"sawtooth",0,1),i.s.U.set("ac",r)};function pt(i,h,s,e,a){var r=["#000000","#ffffff","#000000"];h-=e/2,s-=a/2,i.fillColor("#00000055"),i.fillRect(h+4,s+4,e,a);for(let t=0;t<r.length;++t)i.fillColor(r[t]),i.fillRect(h+t,s+t,e-2*t,a-2*t)}class yt{constructor(){this.g=0;var t=["ENABLE AUDIO? PRESS","ENTER TO CONFIRM.","","WARNING: AUDIO DOES","NOT WORK ON SAFARI!"];this.width=Math.max(...t.map(t=>t.length)),this.height=t.length}update(t){var i;3!=f(t.input,"u")&&3!=f(t.input,"d")||(this.g=1-this.g),3==f(t.input,"s")&&(t.audio.toggle(0==this.g),(i=t.S).g=i.S.get("g"),v(t.audio,t.s.R("ac"),.6))}ha(i,h){h=[h.F("fw"),h.F("fy")],i.clear("#0055aa");var s=7*this.width,e=10*this.height;pt(i,i.width/2,48,12+s,12+e),g(i,h[0],"ENABLE AUDIO? PRESS\nENTER TO CONFIRM.\n\nWARNING: AUDIO DOES\nNOT WORK ON SAFARI!",i.width/2-s/2,48-e/2,-1,2),pt(i,i.width/2,112,40,32);for(let t=0;t<2;++t)s=((e=t==this.g)?"&":" ")+["YES","NO"][t],g(i,h[Number(e)],s,i.width/2-18,102+10*t,-1,0)}}window.onload=()=>{var t=new V,i=t.h,h=(i.audio.wa=.4,r(i.input,"l",["ArrowLeft","KeyA"]),r(i.input,"r",["ArrowRight","KeyD"]),r(i.input,"u",["ArrowUp","KeyW"]),r(i.input,"d",["ArrowDown","KeyS"]),r(i.input,"s",["Enter","Space"]),r(i.input,"j",["ArrowUp","KeyW"]),r(i.input,"t",["Space"]),r(i.input,"p",["Enter"]),i.S),s=new rt(i);h.S.set("g",s),h.g=s,h=i.S,s=new yt,h.S.set("a",s),h.g=s,a(i.s,"_f","f.png"),a(i.s,"_b","b.png"),t.u=wt,function i(h,t){var s=h.s.i();for(h.g=Math.min(h.g+(t-h.m),83.33335),h.m=t,s&&!h.l&&(h.u?.(h.h),h.l=!0),t=!0;16.66667<=h.g;h.g-=16.66667)s&&h.S.update(h.h),t&&(h.h.input.update(),t=!1);s?h.S.ha(h.i,h.s):h.i.clear("#0055aa"),window.requestAnimationFrame(t=>i(h,t))}(t,0)}</script>