<!doctype html><title>Red Billion</title><style>html{box-sizing:border-box}*,:after,:before{box-sizing:inherit}body,html{width:100%;height:100%;margin:0;border:0;padding:0;position:absolute;overflow:hidden;font-family:sans-serif;color:#fff}.main-canvas{position:absolute;background-color:red}.main-menu{width:100%;margin:0 auto;position:absolute;display:flex;flex-direction:column;align-items:center}.main-menu-title{margin:22px 0}.main-menu-play{margin:0 0 11px 0}.dead-menu,.help-menu,.level-end-menu{width:100%;border:0;margin:0;padding:0;padding-top:24px;position:absolute;display:flex;flex-direction:column;align-items:center}.dead-title,.le-title{text-transform:uppercase}.dead-wrapper,.help-wrapper,.le-wrapper{border:4px solid #fff;margin:0;padding:24px;background-color:rgba(0,0,0,.4);display:flex;flex-direction:column}.dead-wrapper{align-items:center}.le-split{display:flex;flex-direction:row}.score-split{display:flex;flex-direction:row}.fragment-text,.level-score-box,.total-score-box{border:1px solid #fff;padding:12px}.level-score,.total-score{font-weight:700}.score-spacer{width:12px}.le-canvas{margin-right:24px;border:1px solid #fff;background-color:#000}.le-buttons{margin-top:24px;display:flex;flex-direction:row;justify-content:center}.le-buttons-spacer{width:16px}.fragment-text{margin:0 0 12px 0;white-space:pre-line;font-family:monospace}.dead-button-spacer{height:12px}.complete-button,.continue-button,.retry-button{font-weight:700}.help-description{margin:0 0 24px 0}.help-description-part{font-weight:700}.help-description-part,.help-instructions-part{margin:4px 0}.help-instructions{margin:0 0 24px 0}.turn-speed-wrapper{margin:0 0 24px 0;display:flex;flex-direction:row;justify-content:space-between;align-items:center}.turn-speed-input{max-width:100px;text-align:right}.dlink{color:inherit;text-decoration:inherit}.dlink:hover{text-decoration:underline}</style><body tabindex=-1><canvas class=main-canvas>Canvas not supported</canvas><div class=main-menu><h1 class=main-menu-title>Red Billion</h1><button class=main-menu-play>Continue</button></div><div class=help-menu><div class=help-wrapper><div class=help-description><p class=help-description-part>The recipe shattered.<p class=help-description-part>404 Fragments.<p class=help-description-part>Recover the recipe.</div><div class=help-instructions><p class=help-instructions-part>TANK CONTROLS.<p class=help-instructions-part>DO DRIFTING.<p class=help-instructions-part>Going faster earns more points.<p class=help-instructions-part>Turn with A and D.<p class=help-instructions-part>Space or W to accelerate.<p class=help-instructions-part>Decrease/increase volume with 1 and 2.<p class=help-instructions-part>Version: 0.6.0<p class=help-instructions-part><span>Author: </span><a href=https://github.com/Costava target=_blank class=dlink>Costava</a><p class=help-instructions-part><a href=https://github.com/Costava/red-billion target=_blank class=dlink><span>View source on GitHub</span></a></div><div class=turn-speed-wrapper><span>Turn sensitivity:</span> <input class=turn-speed-input type=number min=1 max=99999999 value=500></div><button class=help-menu-go>GO</button></div></div><div class=level-end-menu><div class=le-wrapper><h1 class=le-title><span>Oracle </span><span class=oracle-number>X</span> <span>reveals Fragments </span><span class=fragment-low>-2</span> <span>through </span><span class=fragment-high>-1</span></h1><div class=le-split><canvas class=le-canvas width=256 height=256>Canvas not supported</canvas><div class=le-column><p class=fragment-text>Lorem ipsum dolor sit amet<div class=score-split><div class=level-score-box><span>Level score: </span><span class=level-score>00000</span></div><div class=score-spacer></div><div class=total-score-box><span>Total score: </span><span class=total-score>00000</span></div></div></div></div><div class=le-buttons><div class=le-normal-buttons><button class=continue-button>I will continue</button> <span class=le-buttons-spacer></span> <button class=quit-button>I quit</button></div><div class=le-final-buttons><button class=complete-button><span>Recovery successful. Suspend thought indefinitely.</span></button></div></div></div></div><div class=dead-menu><div class=dead-wrapper><h1 class=dead-title><span>The collision with the wall between yourself and the world was fatal</span></h1><div class=dead-button-wrapper><button class=retry-button>I will go back</button></div><span class=dead-button-spacer></span><div class=dead-button-wrapper><button class=dead-button>I am dead</button></div></div></div><script>console.log("Script is executing");class Hook{constructor(e,t,n){this.target=e,this.eventType=t,this.work=n,this.active=!1}start(){this.active||(this.target.addEventListener(this.eventType,this.work),this.active=!0)}stop(){this.active&&(this.target.removeEventListener(this.eventType,this.work),this.active=!1)}}class KbMon{constructor(){this.down={},this.downHook=new Hook(window,"keydown",(e=>{this.down[e.key]=!0})),this.upHook=new Hook(window,"keyup",(e=>{this.down[e.key]=!1}))}start(){this.downHook.start(),this.upHook.start()}stop(){this.downHook.stop(),this.upHook.stop()}}class Vec3{constructor(e,t,n){this.x=e,this.y=t,this.z=n}cross(e){return new Vec3(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)}magSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}mag(){return Math.sqrt(this.magSquared())}xy(){return new Vec2(this.x,this.y)}}class Vec2{constructor(e,t){this.x=e,this.y=t}copy(){return new Vec2(this.x,this.y)}cross(e){return this.x*e.y-this.y*e.x}dot(e){return this.x*e.x+this.y*e.y}toVec3(e){return new Vec3(this.x,this.y,e)}static fromRads(e){return new Vec2(Math.cos(e),Math.sin(e))}add(e){return this.x+=e.x,this.y+=e.y,this}sub(e){return this.x-=e.x,this.y-=e.y,this}scale(e){return this.x*=e,this.y*=e,this}magSquared(){return this.x*this.x+this.y*this.y}mag(){return Math.sqrt(this.magSquared())}distanceTo(e){return e.copy().sub(this).mag()}normalize(){let e=this.mag();return this.x/=e,this.y/=e,this}}class LineSegment{constructor(e,t){this.aPos=e,this.bPos=t,this.diff=this.bPos.copy().sub(this.aPos)}}class Ray{constructor(e,t){this.pos=e,this.dir=t}intersectsLineSegment(e){let t=e.aPos.copy().sub(this.pos),n=this.dir.cross(e.diff),o=t.cross(e.diff)/n;if(o<0)return{intersects:!1};let a=t.cross(this.dir)/n;return a<0||a>1?{intersects:!1}:{intersects:!0,intersection:e.aPos.copy().add(e.diff.copy().scale(a)),t:o}}castAtWalls(e){let t=null;for(let n=0;n<e.length;n+=1){let o=e[n],a=this.intersectsLineSegment(o.lineSegment);a.intersects&&(null==t||a.t<t.result.t)&&(t={result:a,wall:o})}return t}}function wAlpha(e){return"rgb("+21*e.hitResult.intersection.x%255+", "+21*e.hitResult.intersection.y%255+", "+`${e.hitResult.intersection.x+e.hitResult.intersection.y%255})`}function wRed(e){return"rgb(255,0,0)"}class Wall{constructor(e,t){this.lineSegment=e,this.getColor=t}}let ecmStateLength=document.querySelector(".le-canvas").width;class Level{constructor(e){this.walls=[],e.wallData.forEach(function(e){let t=new LineSegment(new Vec2(e[0],e[1]),new Vec2(e[2],e[3]));this.walls.push(new Wall(t,e[4]))}.bind(this)),this.winPoint=e.winPoint,this.winRadius=e.winRadius,this.oracleRule=e.oracleRule,this.fragmentLow=e.fragmentLow,this.fragmentHigh=e.fragmentHigh,this.fragmentText=e.fragmentText,this.ecmConfig=e.ecmConfig,this.ecmLookup=Ecm.getLookup(this.oracleRule),this.reset()}reset(){this.ecmState=Ecm.getInitialState(ecmStateLength,this.ecmLookup,this.ecmConfig)}}function randomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}function randomBool(){return Math.random()<.5}class Ecm{static getLookup(e){(e<0||e>255)&&(console.log(`WARNING: Impossible rule given: ${e}. Using random rule instead`),e=randomInt(0,255));let t=[];for(let n=0;n<8;n+=1){1==(1&e)?t.push(!0):t.push(!1),e>>=1}return t}static getInitialState(e,t,n){let o=[];if(n.init==EcmInitEnum.SINGLE_CENTER){for(let t=0;t<e;t+=1)o.push(!1);o[Math.floor(o.length)]=!0}else if(n.init==EcmInitEnum.RANDOM)for(let t=0;t<e;t+=1)o.push(randomBool());else{console.log("WARNING: Unrecognized init value on ecm config:",n.init);for(let t=0;t<e;t+=1)o.push(randomBool())}return o}static getNewState(e,t,n){let o=[];for(let a=0;a<e.length;a+=1){let l=!1;0==a&&n.wrap?l=e[e.length-1]:l>0&&(l=e[a-1]);let r=e[a],i=!1;a==e.length-1&&n.wrap?i=e[0]:a<e.length-1&&(i=e[a+1]);let s=0;l&&(s|=4),r&&(s|=2),i&&(s|=1),o.push(t[s])}return o}}function showMainMenu(){document.querySelector(".main-menu").style.marginTop="0",document.querySelector(".main-menu-play").disabled=!1}function hideMainMenu(){document.querySelector(".main-menu").style.marginTop="-100%",document.querySelector(".main-menu-play").disabled=!0}function showHelpMenu(){document.querySelector(".help-menu").style.marginTop="0"}function hideHelpMenu(){document.querySelector(".help-menu").style.marginTop="-100%"}function showLevelEndMenu(){document.querySelector(".level-end-menu").style.marginTop="0",document.querySelector(".oracle-number").innerHTML=currentLevel.oracleRule,document.querySelector(".fragment-low").innerHTML=currentLevel.fragmentLow,document.querySelector(".fragment-high").innerHTML=currentLevel.fragmentHigh,document.querySelector(".fragment-text").innerHTML=currentLevel.fragmentText,document.querySelector(".level-score").innerHTML=score,document.querySelector(".total-score").innerHTML=totalScore,currentLevel==levels[levels.length-1]?showFinalLeButtons():showNormalLeButtons()}function showNormalLeButtons(){document.querySelector(".le-normal-buttons").style.display="inherit",document.querySelector(".le-final-buttons").style.display="none"}function showFinalLeButtons(){document.querySelector(".le-normal-buttons").style.display="none",document.querySelector(".le-final-buttons").style.display="inherit"}function hideLevelEndMenu(){document.querySelector(".level-end-menu").style.marginTop="-100%"}function showDeadMenu(){document.querySelector(".dead-menu").style.marginTop="0"}function hideDeadMenu(){document.querySelector(".dead-menu").style.marginTop="-100%"}function hideAllMenus(){document.body.focus(),hideMainMenu(),hideHelpMenu(),hideLevelEndMenu(),hideDeadMenu()}function startLevel(e){currentLevel=e,playerPos=new Vec2(0,0),playerVel=new Vec2(0,0),playerDir=Math.PI/2,gameState=GameStateEnum.PLAYING,score=0,closestToGoal=playerPos.distanceTo(currentLevel.winPoint),startMotorSound()}const GameStateEnum=Object.freeze({NOT_PLAYING:0,PLAYING:100,DEAD:200,LEVEL_END_REACHED:300,COMPLETE:400}),EcmInitEnum=Object.freeze({SINGLE_CENTER:100,RANDOM:200});let canvas=document.querySelector(".main-canvas"),ctx=canvas.getContext("2d"),kbMon=new KbMon;kbMon.start();let playerPos,playerVel,playerDir,frameNumber=0,turnSpeed=5e-4,hfov=Math.PI/180*90,wallMaxHeight=1.3,wallZeroDistance=500;function startMotorSound(){motorGainNode.connect(audioContext.destination)}function stopMotorSound(){motorGainNode.disconnect(audioContext.destination)}function setMotorFreq(e){oscillator.frequency.setValueAtTime(e,audioContext.currentTime)}let zeroMotorFreq=130,hzPerSpeed=120;const audioContext=new AudioContext;let oscillator=audioContext.createOscillator();oscillator.type="sine",setMotorFreq(zeroMotorFreq);const motorGainNode=audioContext.createGain();oscillator.connect(motorGainNode),motorGainNode.gain.value=.12;let oscillatorStarted=!1,ecmConfig={init:EcmInitEnum.SINGLE_CENTER,wrap:!0},ecmLookup=Ecm.getLookup(randomInt(0,255)),ecmState=Ecm.getInitialState(canvas.width,ecmLookup,ecmConfig),ecmRow=0,levels=[];function expandLongLine(e){let t=[];for(let n=0;n<e.length-1;++n){let o=e[n],a=e[n+1];t.push([o[0],o[1],a[0],a[1],a[2]])}return t}levels.push(new Level({wallData:expandLongLine([[-20,0],[-20,2400,wAlpha]]).concat(expandLongLine([[20,0],[20,1e3,wAlpha],[-3,1900,wAlpha],[20,2400,wAlpha]])).concat([[-6,700,6,700,wRed]]),winPoint:new Vec2(0,2500),winRadius:100,oracleRule:57,ecmConfig:{init:EcmInitEnum.SINGLE_CENTER,wrap:!0},fragmentLow:1,fragmentHigh:92,fragmentText:"Ingredients:\n\t\t\t\t\tTwo eggs\n\t\t\t\t\tOne cup flour\n\t\t\t\t\tOne cup milk\n\t\t\t\t\tOne teaspoon baking soda\n\t\t\t\t\tOne teaspoon salt"})),levels.push(new Level({wallData:expandLongLine([[-15,0],[-15,200,wAlpha],[-30,400,wAlpha],[-45,600,wAlpha],[-75,800,wAlpha],[-125,1e3,wAlpha],[-185,1100,wAlpha],[-305,1300,wAlpha],[-405,1500,wAlpha],[-445,1600,wAlpha],[-465,1700,wAlpha],[-465,1800,wAlpha],[-445,2e3,wAlpha],[-425,2100,wAlpha],[-395,2200,wAlpha],[-355,2300,wAlpha],[-305,2400,wAlpha],[-245,2500,wAlpha],[-175,2600,wAlpha],[-125,2700,wAlpha],[-90,2800,wAlpha],[-80,2900,wAlpha],[-80,3300,wAlpha]]).concat(expandLongLine([[15,0],[15,200,wAlpha],[0,400,wAlpha],[-15,600,wAlpha],[-45,800,wAlpha],[-95,1e3,wAlpha],[-155,1100,wAlpha],[-275,1300,wAlpha],[-375,1500,wAlpha],[-415,1600,wAlpha],[-435,1700,wAlpha],[-435,1800,wAlpha],[-415,2e3,wAlpha],[-395,2100,wAlpha],[-365,2200,wAlpha],[-325,2300,wAlpha],[-275,2400,wAlpha],[-215,2500,wAlpha],[-145,2600,wAlpha],[-95,2700,wAlpha],[-60,2800,wAlpha],[-50,2900,wAlpha],[-50,3300,wAlpha]])),winPoint:new Vec2(-65,3400),winRadius:100,oracleRule:154,ecmConfig:{init:EcmInitEnum.SINGLE_CENTER,wrap:!0},fragmentLow:93,fragmentHigh:245,fragmentText:"One tablespoon vegetable oil\n\n\t\t\t\tDirections:\n\t\t\t\tWear smile on face\n\t\t\t\tMix ingredients well in bowl\n\t\t\t\tCook in pan on stove top\n\t\t\t\tTurn off lights and unlock front door"})),levels.push(new Level({wallData:expandLongLine([[-15,0],[-15,300,wAlpha],[-70,600,wAlpha],[40,1100,wAlpha],[-70,1600,wAlpha],[40,2100,wAlpha],[-15,2500,wAlpha],[-15,4e3,wAlpha],[110,4400,wAlpha],[140,4700,wAlpha],[153,5400,wAlpha]]).concat(expandLongLine([[15,0],[15,300,wAlpha],[-40,600,wAlpha],[70,1100,wAlpha],[-40,1600,wAlpha],[70,2100,wAlpha],[15,2500,wAlpha],[15,4e3,wAlpha],[140,4400,wAlpha],[170,4700,wAlpha],[157,5400,wAlpha]])).concat([[-4,2800,4,2800,wRed],[-15,3100,-6,3100,wRed],[6,3100,15,3100,wRed],[-15,3400,5,3400,wRed],[-5,3700,15,3700,wRed],[110,4400,120,4400,wRed],[130,4400,140,4400,wRed]]),winPoint:new Vec2(155,5500),winRadius:100,oracleRule:9,ecmConfig:{init:EcmInitEnum.RANDOM,wrap:!0},fragmentLow:246,fragmentHigh:404,fragmentText:"Optionally, add chocolate chips\n\t\t\t\t\tTop with syrup, yogurt, or whipped cream\n\t\t\t\t\tConsume while looking out window\n\t\t\t\t\tKill and eat cloud\n\t\t\t\t\tMakes one to two servings\n\t\t\t\t\tHave day"}));let currentLevel=levels[0],gameState=GameStateEnum.NOT_PLAYING,score=0,totalScore=0,closestToGoal=Number.POSITIVE_INFINITY;hideAllMenus(),showMainMenu();let oldTime=(new Date).getTime(),loop=()=>{const e=(new Date).getTime(),t=e-oldTime;if(oldTime=e,gameState==GameStateEnum.PLAYING){let e=canvas.width;if(kbMon.down[1]){const e=motorGainNode.gain.value-.005;e>0&&(motorGainNode.gain.value=e)}if(kbMon.down[2]){const e=motorGainNode.gain.value+.005;e<3.4&&(motorGainNode.gain.value=e)}kbMon.down.a&&(playerDir+=turnSpeed*t),kbMon.down.d&&(playerDir-=turnSpeed*t);let n=Vec2.fromRads(playerDir);(kbMon.down[" "]||kbMon.down.w)&&playerVel.add(n.copy().scale(.002*t)),setMotorFreq(zeroMotorFreq+playerVel.mag()*hzPerSpeed+randomInt(-15,15)),playerVel.scale(.9882);let o=playerPos.copy();playerPos.add(playerVel);let a=playerPos.copy().sub(o),l=a.mag();if(l>0){let e=a.copy().normalize(),t=new Ray(o,e).castAtWalls(currentLevel.walls);null!=t&&t.result.t<l&&(gameState=GameStateEnum.DEAD,playerVel.x=0,playerVel.y=0,playerPos=o,stopMotorSound(),showDeadMenu())}if(gameState==GameStateEnum.PLAYING){const e=playerPos.distanceTo(currentLevel.winPoint);if(e<closestToGoal){const t=closestToGoal-e,n=playerVel.mag()+1;score+=Math.floor(t*n*n),closestToGoal=e}e<currentLevel.winRadius&&(gameState=GameStateEnum.LEVEL_END_REACHED,totalScore+=score,stopMotorSound(),showLevelEndMenu())}let r=Math.floor(canvas.height/2);ctx.save(),ctx.fillStyle="rgb(20, 20, 30)",ctx.fillRect(0,0,canvas.width,r),ctx.fillStyle="black",ctx.fillRect(0,r,canvas.width,canvas.height-r),ctx.restore();let i=hfov/e,s=playerDir+hfov/2,c=canvas.width/e;for(let t=0;t<e;t+=1){let e=s-i/2-i*t,n=new Ray(playerPos,Vec2.fromRads(e)).castAtWalls(currentLevel.walls);if(null!=n){let e=n.result.intersection.distanceTo(playerPos);if(e<wallZeroDistance){let o=(wallZeroDistance-e)/wallZeroDistance;o*=o,o*=o;let a=o*wallMaxHeight*canvas.height;Math.floor(255*o);ctx.save(),ctx.fillStyle=n.wall.getColor({hitResult:n.result,playerPos:playerPos,playerVel:playerVel}),ctx.fillRect(t*c,canvas.height/2-a/2,c,a),ctx.restore()}}}}else if(gameState==GameStateEnum.LEVEL_END_REACHED){let e=document.querySelector(".le-canvas"),t=e.getContext("2d");t.save();for(let n=0;n<e.height;n+=1){for(let o=0;o<e.width;o+=1)currentLevel.ecmState[o]?t.fillStyle="white":t.fillStyle="black",t.fillRect(o,n,1,1);currentLevel.ecmState=Ecm.getNewState(currentLevel.ecmState,currentLevel.ecmLookup,currentLevel.ecmConfig)}t.restore()}else if(gameState==GameStateEnum.COMPLETE){if(ecmState.length<canvas.width)for(let e=0;e<canvas.width-ecmState.length;++e)ecmState.push(randomBool());else if(ecmState.length>canvas.width)for(let e=0;e<ecmState.length-canvas.width;++e)ecmState.pop();for(let e=0;e<14;++e){for(let e=0;e<canvas.width;e+=1){if(ecmState[e]){let e=Math.random()<2e-4?"white":`rgb(\n\t\t\t\t\t\t\t\t\t\t${170+randomInt(-40,85)},\n\t\t\t\t\t\t\t\t\t\t${30+randomInt(-20,50)},\n\t\t\t\t\t\t\t\t\t\t${40+randomInt(-30,50)})`;ctx.fillStyle=e}else{let e=10+randomInt(-10,20);ctx.fillStyle=`rgb(\n\t\t\t\t\t\t\t\t\t${e},\n\t\t\t\t\t\t\t\t\t${e},\n\t\t\t\t\t\t\t\t\t${e}\n\t\t\t\t\t\t\t\t)`}ctx.fillRect(e,ecmRow,1,1)}if(ecmState=Ecm.getNewState(ecmState,ecmLookup,ecmConfig),ecmRow+=1,ecmRow>=canvas.height){ecmRow=0,ecmLookup=Ecm.getLookup(randomInt(0,255)),ecmConfig.wrap=randomBool();for(let e=0;e<40;++e){let e=randomInt(0,ecmState.length-1);ecmState[e]=randomBool()}}}}window.requestAnimationFrame(loop)};loop();let handleResize=()=>{console.log("Handling window resize"),canvas.width=document.body.offsetWidth,canvas.height=document.body.offsetHeight},handleResizeHook=new Hook(window,"resize",handleResize);handleResize(),handleResizeHook.start();let turnSpeedInputNum=Number(document.querySelector(".turn-speed-input").value),handleTurnSpeedInputChange=()=>{console.log("Handle turn speed input change");let e=document.querySelector(".turn-speed-input"),t=e.value,n=Number(t);n>=1&&n<=99999999?(turnSpeedInputNum=n,turnSpeed=n/1e6):e.value=turnSpeedInputNum};function saveFrame(e,t){t=String(t).padStart(5,"0");let n=e.toDataURL("image/png").replace("image/png","image/octet-stream"),o=document.createElement("a");o.href=n,o.download="frame"+t+".png",document.body.appendChild(o),o.click()}handleTurnSpeedInputChange(),document.querySelector(".turn-speed-input").addEventListener("change",handleTurnSpeedInputChange),document.querySelector(".main-menu-play").addEventListener("click",(e=>{oscillatorStarted||(oscillatorStarted=!0,oscillator.start()),hideAllMenus(),showHelpMenu()})),document.querySelector(".help-menu-go").addEventListener("click",(e=>{hideAllMenus(),document.body.focus(),levels.forEach((e=>{e.reset()})),totalScore=0,startLevel(levels[0])})),document.querySelector(".retry-button").addEventListener("click",(e=>{hideAllMenus(),startLevel(currentLevel)})),document.querySelector(".dead-button").addEventListener("click",(e=>{gameState=GameStateEnum.NOT_PLAYING,hideAllMenus(),showMainMenu()})),document.querySelector(".continue-button").addEventListener("click",(e=>{currentLevel=levels[levels.indexOf(currentLevel)+1],hideAllMenus(),startLevel(currentLevel)})),document.querySelector(".quit-button").addEventListener("click",(e=>{gameState=GameStateEnum.NOT_PLAYING,hideAllMenus(),showMainMenu()})),document.querySelector(".complete-button").addEventListener("click",(e=>{hideAllMenus(),gameState=GameStateEnum.COMPLETE}))</script>