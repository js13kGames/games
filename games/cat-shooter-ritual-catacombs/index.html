<!doctype html><title>Cat Shooter Ritual Catacombs - js13kGames 2025</title><style>body,html{margin:0;height:100%;overflow:hidden;background:#000}canvas{display:block;width:100vw;height:100vh;image-rendering:pixelated}</style><canvas id=c></canvas><div id=xh style="position:fixed;left:50%;top:50%;width:24px;height:24px;margin:-12px 0 0 -12px;pointer-events:none"><div style=position:absolute;left:11px;top:0;width:2px;height:24px;background:#fff;opacity:.7></div><div style=position:absolute;left:0;top:11px;width:24px;height:2px;background:#fff;opacity:.7></div></div><div id=hud style="position:fixed;top:5%;left:50%;transform:translateX(-50%);pointer-events:none;font:700 40px/1.2 system-ui,sans-serif;color:#f33;text-shadow:0 0 8px #000;letter-spacing:2px"></div><div id=end style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);color:#eee;z-index:9;pointer-events:none;font:700 32px/1.3 system-ui,sans-serif;text-align:center;letter-spacing:1px"><div id=endT style="margin-top:16vh;font-size:64px;color:#f33;text-shadow:0 0 14px #500"></div><div id=endB style=margin-top:18px;font-weight:600;opacity:.95></div><div id=endS style=margin-top:28px;font-size:18px;color:#aaa>Wait for 60 s, then click to restart.</div></div><script>const canvas=c,gl=canvas.getContext("webgl2",{antialias:!1,depth:!1,stencil:!1});let W=0,H=0,DPR=Math.min(1,devicePixelRatio||1);const RES_PRESETS=[[400,300],[320,240],[288,216],[256,192],[224,168],[192,144]];let resIdx=0;function setRenderSize(o){resIdx=Math.max(0,Math.min(RES_PRESETS.length-1,o));const[e,t]=RES_PRESETS[resIdx];W=canvas.width=e,H=canvas.height=t;const s=Math.min(innerWidth/e,innerHeight/t);canvas.style.width=e*s+"px",canvas.style.height=t*s+"px",canvas.style.marginLeft=(innerWidth-e*s)/2+"px",canvas.style.marginTop=(innerHeight-t*s)/2+"px",canvas.style.position="absolute",canvas.style.left=canvas.style.top="0",gl.viewport(0,0,W,H)}function resize(){setRenderSize(resIdx)}addEventListener("resize",resize),resize();let keys={},yaw=0,pitch=0,pos=[0,0,0],frames=0,startT=performance.now(),enemyDownUntil=0,shardCount=0,hp=100,gameOver=!1,hurtPulse=0,muzzle=0,fearPulse=0,rightMouse=!1;const hud=document.getElementById("hud");let hudUntil=0,hudMsg="",endState="none",endLockUntil=0;const endEl=document.getElementById("end"),endT=document.getElementById("endT"),endB=document.getElementById("endB"),endS=document.getElementById("endS");function showEnd(o,e,t,s=6e4){endState=o,gameOver=!0,endLockUntil=performance.now()+s,endT.textContent=e,endB.textContent=t,endEl.style.display="block"}function hideEnd(){endEl.style.display="none",endState="none",endLockUntil=0}let checkpointIndex=0;const HUD_MS=2500,CAT_ALERT_RADIUS=3.5,CAT_EYES_DELAY_MS=1500,CAT_CHARGE=3,CAT_WALK=.4,CAT_SAFE_MS=7e3,SHARDS_REQ=3,WRAITH_ORBIT_R=1.9,WRAITH_SPEED=1.2,WRAITH_DRAIN_RANGE=4,AC=window.AudioContext||window.webkitAudioContext,ac=new AC;function sfx(o=1200,e=.08,t=.2,s="square"){let n=ac.createOscillator(),a=ac.createGain();n.type=s,n.frequency.value=o,n.connect(a),a.connect(ac.destination),a.gain.value=t;let i=ac.currentTime;n.start(i),a.gain.exponentialRampToValueAtTime(1e-4,i+e),n.stop(i+e)}const TILE=2,LEVELS=[["ooooooooooo*****","o***S*****XSSSdo","o*********o","o*********o","o*********o","o*p**d**Sko","o*********o","o*********o","o*k*S*k***o","o*********o","ooooooooooo"],["oooooooooooooooo*****","o*p**S**o***d*XSSSdo","o***o*k***o***o","o***o*o*o*o***o","o****S**k*****o","o***o*o*o*o***o","o*k**k*****k**o","o***o*o*o*o***o","o**k*****k****o","o***oS***So***o","o*k*ooo*ooo**So","o***o*****o***o","o***o***kSo***o","ooooooooooooooo"],["ooooooooooooooooooooooooo***","o*p*D*******************XSdo","o***o***o***S*S***o*****o","o***o*S*o***ooo***o**S**o","o***o***o***odo***o*****o","o*******o***oXo***o*****o","o***********************o","o***********************o","o****T******T******T****o","o***********************o","o***********************o","ooooo***ooooooooooooo***o","o****k*k**ooo*ooo****k*k*o","o**********o***o*********o","o***ooooo***o***o***oooo*o","o***o***o***o***o***o***o","o***o***oXXXXXXXXXo***o*do","o***o***oSk*o***oSk*o*k*o","o***o***ok**o*k*okk*o***o","o********k************kSo","ooooooooooooooooooooooooo"],["oooooooooooooooooooo****","o**********H********XSSdo","op***S***T**k*****do","o***ooo***ooo***ooo*o","o**ko*S*k*o*Tk*o***o","o***ooo***ooo***ooo*o","o****k***H**S*****k*o","oooooooooooooooooooo"],["ooooooooooo****","o****d****XSSdo","o****S****o","o****k****o","o****o****o","oSok*p*kSo","o****o****o","o****k****o","o****T****o","o*********o","ooooooooooo"],["ooooooooooooooooo****","o*p*****S*****Do","o***oooo*oooo***XSdo","o***oS****o*k*So","o***o*XoX*o***o","oT***XH*HX***So","o***o*XoX*o***o","oS*k*o*****o*k*o","o***oooXXXooo***o","o******S*******o","ooooooooooooooooo"],["oooooooooooooooooooo*****","o****p****H*****H**XSSSdo","o*H****************o","o*************H****o","o******************o","o*H******H****H****o","o******************o","o*H***********H****o","o******************o","o****H***d*******B*o","oooooooooooooooooooo"]],WALL_SET=new Set(["o","X","#"]),SOLID_SET=new Set(["o","#"]);function parseLevel(o){const e=o.length,t=o[0].length,s=(t-1)/2,n=(e-1)/2;let a=[0,0,0],i=[],l=[],r=[],c=[],u=[];const d=[];let p=null;for(let f=0;f<e;f++){const e=o[f];for(let o=0;o<t;o++){const t=e[o],[m,h,v]=[2*(o-s),-.4,2*-(f-n)];"p"===t&&(a=[m,0,v]),"C"!==t&&"c"!==t&&"K"!==t&&"k"!==t||i.push([m,h,v]),"S"===t&&l.push([m,h,v]),"H"!==t&&"h"!==t||r.push([m,h,v]),"d"!==t&&"D"!==t||c.push({x:m,y:h,z:v,ch:t}),"T"===t&&u.push([m,h,v]),"B"===t&&(p=[m,0,v]),d.push({ch:t,x:m,y:h,z:v})}}return{playerStart:a,catSpawns:i,sphereSpawns:l,healSpawns:r,doors:c,tiles:d,rows:e,cols:t,center:[s,n],turretSpawns:u,bossPos:p}}function buildTileTexture(o){const e=o.length,t=o[0].length,s=new Uint8Array(t*e);for(let n=0;n<e;n++){const e=o[n];for(let o=0;o<t;o++){const a=e[o];s[n*t+o]=WALL_SET.has(a)?1:0}}const n=gl.createTexture();return gl.bindTexture(gl.TEXTURE_2D,n),gl.pixelStorei(gl.UNPACK_ALIGNMENT,1),gl.pixelStorei(gl.UNPACK_ROW_LENGTH,0),console.assert(s.byteLength===t*e,"tile data size mismatch",{cols:t,rows:e,len:s.byteLength}),gl.texImage2D(gl.TEXTURE_2D,0,gl.R8,t,e,0,gl.RED,gl.UNSIGNED_BYTE,s),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),{tex:n,cols:t,rows:e}}let boss={active:!1,pos:[0,0,0],scale:2,phase:0,until:0,eyes:0,lives:9,nextShot:0,didNova:!1};const MAX_CATS=13,MAX_SPHERES=12,MAX_DOORS=4,MAX_TURRETS=6,MAX_ORBS=12,TURRET_RANGE=8,ORB_SPEED=2.1,ORB_DMG=10;let LV,TILE_TEX,cats=[],spheres=[],doors=[],turrets=[],orbs=[],levelIndex=0,minDoorReq=3,LEVEL_ROWS=null;function loadLevel(o){LEVEL_ROWS=o,LV=parseLevel(o),TILE_TEX&&TILE_TEX.tex&&gl.deleteTexture(TILE_TEX.tex),TILE_TEX=buildTileTexture(o),cats=LV.catSpawns.slice(0,13).map(([o,e,t])=>({pos:[o,e,t],eyes:0,attacking:!1,mode:0,modeUntil:0,spawn:[o,e,t],theta:6.283*Math.random(),nextBlink:performance.now()+1500+1500*Math.random(),gaze:0,noGazeUntil:0})),spheres=[],spheres.push(...LV.sphereSpawns.slice(0,12).map(([o,e,t])=>({pos:[o,-.2,t],R:.3,downUntil:0,collected:!1,type:"shard"})));const e=Math.max(0,12-spheres.length);if(spheres.push(...LV.healSpawns.slice(0,e).map(([o,e,t])=>({pos:[o,-.2,t],R:.3,downUntil:0,collected:!1,type:"heal"}))),doors=LV.doors.slice(0,4).map(o=>({pos:[o.x,0,o.z],half:[.08,.6,.92],open:!1,req:"D"===o.ch?6:3,activeVisual:!1})),turrets=LV.turretSpawns.slice(0,6).map(([o,e,t])=>({pos:[o,0,t],next:performance.now()+500+800*Math.random()})),orbs=[],minDoorReq=doors.length?Math.min(...doors.map(o=>o.req)):0,LV.playerStart&&(pos=[LV.playerStart[0],0,LV.playerStart[2]]),LV.bossPos){const o=performance.now();boss.active=!0,boss.pos=[LV.bossPos[0],0,LV.bossPos[2]],boss.scale=2,boss.phase=1,boss.until=o+1600,boss.eyes=0,boss.lives=9,boss.nextShot=o+1400,boss.didNova=!1,hudMsg="NINE LIVES RITUAL",hudUntil=o+2e3}else boss.active=!1;shardCount=0,hudMsg=LV.bossPos?"DON'T STARE — WAIT FOR THE EYES":minDoorReq>0?`COLLECT ${minDoorReq} SHARDS`:"FIND EXIT",hudUntil=performance.now()+3200}const vs="#version 300 es\nvoid main(){vec2 p=vec2((gl_VertexID<<1)&2,gl_VertexID&2);gl_Position=vec4(p*2.-1.,0,1);}",fs="#version 300 es\nprecision highp float;out vec4 o;uniform vec2 uRes;uniform float uTime;uniform vec3 uCam,uF,uR,uU;uniform float uEnemy;uniform float uHurt,uMuzzle;uniform float uFear;uniform sampler2D uTileTex;uniform ivec2 uTileSize;uniform vec2 uTileCenter;uniform float uTileScale;const int MAX_CATS=13;uniform int uCatCount;uniform vec4 uCatsPos[MAX_CATS];uniform float uCatsState[MAX_CATS];uniform float uCatsEyes[MAX_CATS];float packCatId(int i){return 3.0+float(i)*0.01;}int unpackCatId(float m){int id=int(floor((m-3.0)*100.0+0.5));if(id<0)id=0;if(id>=MAX_CATS)id=MAX_CATS-1;return id;}const int MAX_SPHERES=8;uniform int uSphereCount;uniform vec4 uSpheresPos[MAX_SPHERES];uniform float uSpheresActive[MAX_SPHERES];float packSphereId(int i){return 2.0+float(i)*0.01;}int unpackSphereId(float m){int id=int(floor((m-2.0)*100.0+0.5));if(id<0)id=0;if(id>=MAX_SPHERES)id=MAX_SPHERES-1;return id;}float hash21(vec2 p){return fract(sin(dot(p,vec2(127.1,311.7)))*43758.5453123);}float hash31(vec3 p){return fract(sin(dot(p,vec3(17.3,113.1,241.7)))*43758.5453);}float sdCircle2(vec2 p,float r){return length(p)-r;}float pawMask(vec2 uv){vec2 c=uv-vec2(0.32,0.34);float d=sdCircle2(c,0.11);d=min(d,sdCircle2(c-vec2(-0.10,0.14),0.050));d=min(d,sdCircle2(c-vec2(0.00,0.16),0.058));d=min(d,sdCircle2(c-vec2(0.10,0.14),0.050));return smoothstep(0.03,0.0,d);}float catRune(vec2 uv){vec2 p=(uv-0.5);p.x/=0.86;float d=sdCircle2(p,0.24);d=min(d,sdCircle2(p-vec2(-0.18,0.16),0.11));d=min(d,sdCircle2(p-vec2(0.18,0.16),0.11));return smoothstep(0.03,0.0,d);}const int MAX_DOORS=4;uniform int uDoorCount;uniform vec4 uDoorsPos[MAX_DOORS];uniform vec4 uDoorsHalf[MAX_DOORS];float packDoorId(int i){return 5.0+float(i)*0.01;}int unpackDoorId(float m){int id=int(floor((m-5.0)*100.0+0.5));if(id<0)id=0;if(id>=MAX_DOORS)id=MAX_DOORS-1;return id;}const int MAX_TURRETS=6;uniform int uTurretCount;uniform vec4 uTurretsPos[MAX_TURRETS];uniform int uBossActive;uniform vec4 uBoss;uniform float uBossEyes;uniform float uBossPhase;float packTurretId(int i){return 6.0+float(i)*0.01;}int unpackTurretId(float m){int id=int(floor((m-6.0)*100.0+0.5));if(id<0)id=0;if(id>=MAX_TURRETS)id=MAX_TURRETS-1;return id;}float sdSphere(vec3 p,float r){return length(p)-r;}float sdRect(vec2 p,vec2 b){vec2 d=abs(p)-b;return min(max(d.x,d.y),0.)+length(max(d,0.));}float sdCapsule(vec3 q,vec3 a,vec3 b,float r){vec3 pa=q-a,ba=b-a;float h=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-ba*h)-r;}float sdEllipsoid(vec3 q,vec3 s){return(length(q/s)-1.0)*min(min(s.x,s.y),s.z);}float sdBox(vec3 p,vec3 b){vec3 d=abs(p)-b;return min(max(d.x,max(d.y,d.z)),0.)+length(max(d,0.));}float smin(float a,float b,float k){float h=clamp(0.5+0.5*(b-a)/k,0.0,1.0);return mix(b,a,h)-k*h*(1.0-h);}float opInter(float a,float b){return max(a,b);}float sdTwoPlanesY(vec3 p,float h){return min(abs(p.y-h),abs(p.y+h));}float sdCatModelAt(vec3 q,vec3 catPos){q-=catPos;float d=1e9;d=min(d,sdEllipsoid(q-vec3(-0.06,0.03,0.00),vec3(0.58,0.24,0.28)));d=min(d,sdEllipsoid(q-vec3(0.18,0.01,0.00),vec3(0.22,0.14,0.22)));d=min(d,sdEllipsoid(q-vec3(-0.10,0.07,0.00),vec3(0.52,0.20,0.26)));d=min(d,sdEllipsoid(q-vec3(0.03,-0.06,0.00),vec3(0.28,0.11,0.20)));d=min(d,sdCapsule(q,vec3(0.36,0.10,0.17),vec3(0.48,0.14,0.17),0.070));{float hd=sdEllipsoid(q-vec3(0.585,0.160,0.170),vec3(0.155,0.125,0.135));float hZL=sdEllipsoid(q-vec3(0.575,0.150,0.255),vec3(0.105,0.070,0.070));float hZR=sdEllipsoid(q-vec3(0.575,0.150,0.085),vec3(0.105,0.070,0.070));float hWL=sdEllipsoid(q-vec3(0.635,0.108,0.230),vec3(0.088,0.058,0.078));float hWR=sdEllipsoid(q-vec3(0.635,0.108,0.110),vec3(0.088,0.058,0.078));float hSN=sdEllipsoid(q-vec3(0.690,0.095,0.170),vec3(0.060,0.045,0.060));float hFL=sdBox(q-vec3(0.570,0.185,0.170),vec3(0.120,0.030,0.120));float k=0.08;hd=smin(hd,hZL,k);hd=smin(hd,hZR,k);hd=smin(hd,hWL,k);hd=smin(hd,hWR,k);hd=smin(hd,hSN,k*0.85);hd=smin(hd,hFL,k*0.70);d=min(d,hd);}{vec3 eBL=vec3(0.620,0.292,0.100),eTL=vec3(0.640,0.332,0.095);vec3 eBR=vec3(0.620,0.292,0.240),eTR=vec3(0.640,0.332,0.245);float earL=smin(sdBox(q-eBL,vec3(0.046,0.085,0.026)),sdBox(q-eTL,vec3(0.030,0.050,0.018)),0.06);float earR=smin(sdBox(q-eBR,vec3(0.046,0.085,0.026)),sdBox(q-eTR,vec3(0.030,0.050,0.018)),0.06);d=min(d,earL);d=min(d,earR);}d=min(d,sdCapsule(q,vec3(0.05,-0.12,0.20),vec3(0.05,-0.48,0.20),0.038));d=min(d,sdCapsule(q,vec3(0.05,-0.12,-0.20),vec3(0.05,-0.48,-0.20),0.038));d=min(d,sdEllipsoid(q-vec3(-0.31,-0.06,0.25),vec3(0.13,0.095,0.105)));d=min(d,sdEllipsoid(q-vec3(-0.31,-0.06,-0.25),vec3(0.13,0.095,0.105)));d=min(d,sdCapsule(q,vec3(-0.34,-0.16,0.25),vec3(-0.34,-0.46,0.25),0.053));d=min(d,sdCapsule(q,vec3(-0.34,-0.16,-0.25),vec3(-0.34,-0.46,-0.25),0.053));d=min(d,sdCapsule(q,vec3(-0.62,0.00,0.02),vec3(-0.92,0.19,0.02),0.036));d=min(d,sdCapsule(q,vec3(-0.92,0.19,0.02),vec3(-1.02,0.36,-0.06),0.030));d=min(d,sdCapsule(q,vec3(-1.02,0.36,-0.06),vec3(-1.07,0.47,0.10),0.024));return d;}float sdCatScaled(vec3 p,vec3 c,float s){vec3 q=c+(p-c)/s;return sdCatModelAt(q,c)*s;}vec2 map(vec3 p){float d=1e9,m=0.;float dFloor=sdTwoPlanesY(p,0.6);if(dFloor<d){d=dFloor;m=4.;}int ix=int(floor(p.x/uTileScale+uTileCenter.x+0.5));int iz=int(floor(-p.z/uTileScale+uTileCenter.y+0.5));for(int dz=-1;dz<=1;dz++){for(int dx=-1;dx<=1;dx++){int tx=ix+dx;int tz=iz+dz;if(tx<0||tz<0||tx>=uTileSize.x||tz>=uTileSize.y)continue;float code=texture(uTileTex,(vec2(tx,tz)+0.5)/vec2(uTileSize)).r*255.0;if(code<0.5)continue;vec3 c=vec3((float(tx)-uTileCenter.x)*uTileScale,0.0,-(float(tz)-uTileCenter.y)*uTileScale);vec3 b=vec3(uTileScale*0.48,0.6,uTileScale*0.48);vec3 d3=abs(p-c)-b;float rough=max(max(d3.x,d3.y),d3.z);if(rough>d)continue;float db=sdBox(p-c,b);if(db<d){d=db;m=1.;}}}for(int i=0;i<MAX_SPHERES;i++){if(i>=uSphereCount)break;if(uSpheresActive[i]<0.5)continue;vec3 sp=uSpheresPos[i].xyz;float rr=abs(uSpheresPos[i].w);float ds=sdSphere(p-sp,rr);if(ds<d){d=ds;m=packSphereId(i);}}for(int i=0;i<MAX_CATS;i++){if(i>=uCatCount)break;if(uCatsState[i]<0.5)continue;vec3 cp=uCatsPos[i].xyz;float dc=sdCatModelAt(p,cp);if(dc<d){d=dc;m=packCatId(i);}}for(int i=0;i<MAX_DOORS;i++){if(i>=uDoorCount)break;vec3 dp=uDoorsPos[i].xyz;vec3 dh=uDoorsHalf[i].xyz;float dd=sdBox(p-dp,dh);if(dd<d){d=dd;m=packDoorId(i);}}for(int i=0;i<MAX_TURRETS;i++){if(i>=uTurretCount)break;vec3 tp=uTurretsPos[i].xyz;float dp=sdCapsule(p,tp+vec3(0.0,-0.45,0.0),tp+vec3(0.0,0.30,0.0),0.035);if(dp<d){d=dp;m=packTurretId(i);}float de=sdSphere(p-(tp+vec3(0.0,0.38,0.0)),0.11);if(de<d){d=de;m=packTurretId(i);}}if(uBossActive>0){float db=sdCatScaled(p,uBoss.xyz,uBoss.w);if(db<d){d=db;m=7.0;}}return vec2(d,m);}vec2 march(vec3 ro,vec3 rd){float t=0.0;float m=0.0;for(int i=0;i<128;i++){vec2 h=map(ro+rd*t);float eps=mix(0.001,0.015,clamp((t-5.0)/20.0,0.0,1.0));if(h.x<eps){m=h.y;break;}t+=h.x;if(t>40.0){m=0.0;break;}if(exp(-0.09*t)<0.02){m=0.0;break;}}return vec2(t,m);}vec3 nrm(vec3 p){float e=0.001;vec2 k=vec2(1,-1);return normalize(k.xyy*map(p+k.xyy*e).x+k.yyx*map(p+k.yyx*e).x+k.yxy*map(p+k.yxy*e).x+k.xxx*map(p+k.xxx*e).x);}void main(){vec2 uv=(gl_FragCoord.xy-0.5*uRes)/uRes.y;vec3 rd=normalize(uv.x*uR+uv.y*uU+uF);vec2 h=march(uCam,rd);float t=h.x,mat=h.y;vec3 bg=vec3(0.02,0.02,0.04);if(t>40.||mat<0.5){o=vec4(bg,1.0);return;}vec3 p=uCam+rd*t;vec3 n=(mat>3.5&&mat<4.5)?vec3(0.0,(p.y>0.0)?1.0:-1.0,0.0):nrm(p);float fx=(p.x/uTileScale+uTileCenter.x);float fz=(-p.z/uTileScale+uTileCenter.y);int ix=int(floor(fx+0.5));int iz=int(floor(fz+0.5));vec2 tuv=fract(vec2(fx,fz));vec3 col;int ciHit=-1,diHit=-1,siHit=-1;int tiHit=-1;if(mat>=3.0&&mat<4.0)ciHit=unpackCatId(mat);if(mat>=5.0&&mat<6.0)diHit=unpackDoorId(mat);if(mat>=2.0&&mat<3.0)siHit=unpackSphereId(mat);if(mat>=6.0&&mat<7.0)tiHit=unpackTurretId(mat);if(mat<1.5){col=mix(vec3(0.09,0.10,0.11),vec3(0.12,0.13,0.14),0.5+0.5*sin((p.x*1.7+p.z*1.3)*0.4));float u=(abs(n.x)>abs(n.z))?fract(-p.z/uTileScale+uTileCenter.y):fract(p.x/uTileScale+uTileCenter.x);float v=clamp((p.y+0.6)/1.2,0.0,1.0);vec2 wuv=vec2(u,v);float r=hash21(vec2(ix,iz)*1.23);if(r<0.16){float m=catRune(wuv);col=mix(col,col+vec3(0.00,0.08,0.12),m*0.28);}}else if(mat<3.0){bool isHeal=false;bool isProj=false;if(siHit>=0&&siHit<uSphereCount){isHeal=(uSpheresPos[siHit].w<0.0);isProj=(uSpheresActive[siHit]>1.5);}if(isProj){float pulse=0.5+0.5*sin(uTime*8.0);col=vec3(0.10,0.02,0.03)+pulse*vec3(1.8,0.3,0.6);}else if(isHeal){col=vec3(0.05,0.10,0.12)+0.8*vec3(0.2,0.9,1.6);}else{col=vec3(0.05,0.12,0.04)+0.7*vec3(0.2,0.9,0.2);}}else if(mat<4.0){float state=(ciHit>=0&&ciHit<uCatCount)?uCatsState[ciHit]:1.0;if(state<1.5){col=vec3(0.02,0.02,0.03);float fr=pow(1.0-max(dot(n,-rd),0.0),3.0);col+=fr*vec3(0.35,0.05,0.05);}else{col=vec3(0.85);float flick=0.5+0.5*sin(uTime*20.0+p.x*10.0+p.z*7.0);col+=vec3(0.15,0.45,0.55)*flick;}}else if(mat<4.5){bool isCeil=(n.y>0.0);col=mix(vec3(0.10),vec3(0.18,0.19,0.20),0.5+0.5*sin(p.x*2.0));float rv=hash21(vec2(ix,iz));if(!isCeil){if(rv<0.33){float paw=pawMask(tuv);col=mix(col,col*0.60+vec3(0.03,0.00,0.00),paw*0.75);}else if(rv<0.66){float w=abs(sin((tuv.x*18.0+sin(tuv.y*6.0+rv*6.0))*1.0));float crack=smoothstep(0.06,0.03,w);col-=crack*0.07;}}else{float str=abs(sin((tuv.x+tuv.y+rv)*14.0))*0.5+abs(sin((tuv.x*2.0-tuv.y)*9.0))*0.5;float mold=smoothstep(1.0,0.85,str);col=mix(col,col+vec3(0.00,0.12,0.16),mold*0.20);}}else if(mat<5.5){float door_active=(diHit>=0&&diHit<uDoorCount)?step(0.5,uDoorsHalf[diHit].w):0.0;vec3 dp=uDoorsPos[diHit].xyz;vec3 dh=uDoorsHalf[diHit].xyz;vec3 lp=p-dp;bool faceX=(dh.x<dh.z);vec2 uvd=faceX?vec2((lp.z/dh.z)*0.5+0.5,(lp.y/dh.y)*0.5+0.5):vec2((lp.x/dh.x)*0.5+0.5,(lp.y/dh.y)*0.5+0.5);uvd=clamp(uvd,0.0,1.0);vec3 base=vec3(0.08,0.08,0.10);float panel=0.55+0.45*sin(uTime*1.8+float(diHit)*1.3);vec3 colOff=vec3(0.35,0.10,0.55);vec3 colOn=vec3(1.60,0.35,0.90);vec3 eCol=mix(colOff,colOn,door_active);float seam=smoothstep(0.06,0.00,abs(uvd.x-0.5));float edge=smoothstep(0.10,0.00,min(min(uvd.x,1.0-uvd.x),min(uvd.y,1.0-uvd.y)));float rune=catRune(uvd);vec2 pawUV=fract(uvd*vec2(2.0,1.5)+vec2(0.0,-0.15));float paw=pawMask(pawUV)*smoothstep(0.4,0.9,uvd.y);float eBoost=mix(1.0,1.8,smoothstep(8.0,24.0,t));vec3 emiss=vec3(0.0);emiss+=panel*(0.22+0.28*door_active)*eCol;emiss+=seam*(0.14+0.24*door_active)*eCol;emiss+=edge*(0.08+0.22*door_active)*eCol;emiss+=(0.28*rune+0.22*paw)*(0.4+0.6*(0.5+0.5*sin(uTime*6.0+float(diHit))))*eCol;emiss*=eBoost;col=base+emiss;}else if(mat<7.0){col=vec3(0.08,0.08,0.10);if(tiHit>=0&&tiHit<uTurretCount){vec3 tp=uTurretsPos[tiHit].xyz;float dEye=length(p-(tp+vec3(0.0,0.45,0.0)));float pulse=0.6+0.4*sin(uTime*3.0+float(tiHit)*1.7);float glow=smoothstep(0.20,0.03,dEye);col+=glow*(vec3(0.10,0.02,0.05)+pulse*vec3(1.00,0.30,0.90));float poleBand=0.15+0.85*abs(sin((p.y+tp.y+1.5)*6.0));col=mix(col,col+vec3(0.06,0.01,0.08)*pulse,0.25*poleBand);}}else if(mat<8.0){col=vec3(0.02,0.02,0.03);float fr=pow(1.0-max(dot(n,-rd),0.0),3.0);col+=fr*vec3(0.40,0.10,0.45);if(uBossEyes>0.0){vec3 pr=p-uBoss.xyz;float eL=length(pr-vec3(0.662,0.172,0.238)*uBoss.w);float eR=length(pr-vec3(0.662,0.172,0.102)*uBoss.w);float glow=uBossEyes*smoothstep(0.20*uBoss.w,0.04*uBoss.w,min(eL,eR));col+=glow*vec3(2.2,0.5,2.6);}}else{col=vec3(0.1);}vec3 l=normalize(vec3(0.4,0.6,0.7));float diff=max(0.05,dot(n,l));col*=diff+(mat>2.5?0.3:0.3);if(ciHit>=0&&ciHit<uCatCount){float eyes=uCatsEyes[ciHit];if(eyes>0.0){vec3 pr=p-uCatsPos[ciHit].xyz;float eyeL=length(pr-vec3(0.662,0.172,0.238));float eyeR=length(pr-vec3(0.662,0.172,0.102));float dEye=min(eyeL,eyeR);float glow=eyes*smoothstep(0.10,0.028,dEye);float stateE=(ciHit>=0&&ciHit<uCatCount)?uCatsState[ciHit]:1.0;vec3 glowCol=(stateE<1.5)?vec3(3.0,0.6,0.2):vec3(0.6,1.6,2.3);col+=glow*glowCol;}}float fog=exp(-0.09*t);vec3 colFog=mix(bg,col,fog);colFog=mix(colFog,vec3(0.45,0.0,0.0),clamp(uHurt,0.0,1.0));colFog=mix(colFog,vec3(0.0,0.22,0.33),clamp(uFear,0.0,1.0));float flash=uMuzzle*smoothstep(0.6,0.0,length(uv));colFog+=flash*0.6;colFog*=1.3;o=vec4(colFog,1.0);}";function shader(o,e){const t=gl.createShader(o);return gl.shaderSource(t,e),gl.compileShader(t),gl.getShaderParameter(t,gl.COMPILE_STATUS)||console.error("SHADER COMPILE ERROR:",gl.getShaderInfoLog(t),"\n--- SOURCE ---\n"+e),t}const pr=gl.createProgram(),vao=gl.createVertexArray();gl.attachShader(pr,shader(gl.VERTEX_SHADER,vs)),gl.attachShader(pr,shader(gl.FRAGMENT_SHADER,fs)),gl.linkProgram(pr),gl.useProgram(pr),gl.bindVertexArray(vao),gl.getProgramParameter(pr,gl.LINK_STATUS)||console.error("PROGRAM LINK ERROR:",gl.getProgramInfoLog(pr));const uRes=gl.getUniformLocation(pr,"uRes"),uTime=gl.getUniformLocation(pr,"uTime"),uCam=gl.getUniformLocation(pr,"uCam"),uF=gl.getUniformLocation(pr,"uF"),uR=gl.getUniformLocation(pr,"uR"),uU=gl.getUniformLocation(pr,"uU"),uEnemy=gl.getUniformLocation(pr,"uEnemy"),uHurt=gl.getUniformLocation(pr,"uHurt"),uMuzzle=gl.getUniformLocation(pr,"uMuzzle"),uFear=gl.getUniformLocation(pr,"uFear"),uTileTex=gl.getUniformLocation(pr,"uTileTex"),uTileSize=gl.getUniformLocation(pr,"uTileSize"),uTileCenter=gl.getUniformLocation(pr,"uTileCenter"),uTileScale=gl.getUniformLocation(pr,"uTileScale"),uCatCount=gl.getUniformLocation(pr,"uCatCount"),uCatsPos=gl.getUniformLocation(pr,"uCatsPos[0]"),uCatsState=gl.getUniformLocation(pr,"uCatsState[0]"),uCatsEyes=gl.getUniformLocation(pr,"uCatsEyes[0]"),uSphereCount=gl.getUniformLocation(pr,"uSphereCount"),uSpheresPos=gl.getUniformLocation(pr,"uSpheresPos[0]"),uSpheresActive=gl.getUniformLocation(pr,"uSpheresActive[0]"),uDoorCount=gl.getUniformLocation(pr,"uDoorCount"),uDoorsPos=gl.getUniformLocation(pr,"uDoorsPos[0]"),uDoorsHalf=gl.getUniformLocation(pr,"uDoorsHalf[0]"),uTurretCount=gl.getUniformLocation(pr,"uTurretCount"),uTurretsPos=gl.getUniformLocation(pr,"uTurretsPos[0]");function onKey(o){["KeyW","KeyA","KeyS","KeyD"].includes(o.code)&&(keys[o.code]="keydown"===o.type,o.preventDefault())}function hasLOS(o,e,t,s){const n=t-o,a=s-e,i=Math.hypot(n,a),l=Math.max(1,Math.floor(i/.5));let r=o,c=e,u=n/l,d=a/l;for(let o=0;o<l;o++)if(r+=u,c+=d,isSolidAt(r,c))return!1;return!0}function pointInDoor(o,e,t=0){const s=Math.abs(o[0]-e.pos[0])-(e.half[0]+t),n=Math.abs(o[1]-e.pos[1])-(e.half[1]+t),a=Math.abs(o[2]-e.pos[2])-(e.half[2]+t);return s<=0&&n<=0&&a<=0}function resolveDoorCollision(o,e){let t=[e[0],e[1],e[2]];const s=.02;for(const n of doors)if(!n.open&&pointInDoor(t,n,s)){const a=[e[0],o[1],o[2]],i=[o[0],o[1],e[2]],l=pointInDoor(a,n,s),r=pointInDoor(i,n,s);t=!l&&r?a:l&&!r?i:l||r?[o[0],o[1],o[2]]:Math.abs(a[0]-n.pos[0])>Math.abs(i[2]-n.pos[2])?a:i}return t}function worldToTile(o,e){return{col:Math.floor(o/2+LV.center[0]+.5),row:Math.floor(-e/2+LV.center[1]+.5)}}function isSolidAt(o,e){const{col:t,row:s}=worldToTile(o,e);if(t<0||s<0||t>=LV.cols||s>=LV.rows)return!0;const n=LEVEL_ROWS[s][t];return SOLID_SET.has(n)}function resolveWallCollision(o,e){const t=.28;let s=e[0],n=e[2],a=[s,e[1],o[2]];(isSolidAt(a[0]+t,a[2])||isSolidAt(a[0]-t,a[2])||isSolidAt(a[0],a[2]+t)||isSolidAt(a[0],a[2]-t))&&(a[0]=o[0]);let i=[a[0],e[1],n];return(isSolidAt(i[0]+t,i[2])||isSolidAt(i[0]-t,i[2])||isSolidAt(i[0],i[2]+t)||isSolidAt(i[0],i[2]-t))&&(i[2]=o[2]),[i[0],e[1],i[2]]}function pickNearest(o,e,t){const s=o.map((e,s)=>{const n=t(o[s]),a=n[0]-pos[0],i=n[1]-pos[1],l=n[2]-pos[2];return{i:s,d:a*a+i*i+l*l}});return s.sort((o,e)=>o.d-e.d),s.slice(0,Math.min(e,s.length)).map(o=>o.i)}function vec3(o,e,t){return new Float32Array([o,e,t])}function frame(o){frames++;let e=(o-(frame.t||o))/1e3;if(frame.t=o,frame.acc=(frame.acc||0)+e,frame.count=(frame.count||0)+1,frame.acc>=.75){const o=frame.count/frame.acc;o<55&&resIdx<RES_PRESETS.length-1?setRenderSize(resIdx+1):o>62&&resIdx>0&&setRenderSize(resIdx-1),frame.acc=0,frame.count=0}const t=Math.cos(yaw),s=Math.sin(yaw),n=Math.cos(pitch),a=Math.sin(pitch),i=[s*n,a,-t*n],l=[-s*a,n,t*a],r=[t,0,s],c=3*e*(gameOver?0:1);let u=[pos[0],pos[1],pos[2]];(keys.KeyW||rightMouse)&&(u[0]+=i[0]*c,u[1]+=i[1]*c,u[2]+=i[2]*c),keys.KeyS&&(u[0]-=i[0]*c,u[1]-=i[1]*c,u[2]-=i[2]*c),keys.KeyA&&(u[0]-=r[0]*c,u[2]-=r[2]*c),keys.KeyD&&(u[0]+=r[0]*c,u[2]+=r[2]*c),u[1]=0,u=resolveWallCollision(pos,u),u=resolveDoorCollision(pos,u),pos=u;const d=performance.now();for(let o=0;o<spheres.length;o++){const e=spheres[o];if(e.collected)continue;const t=pos[0]-e.pos[0],s=pos[1]-e.pos[1],n=pos[2]-e.pos[2];if(Math.hypot(t,s,n)<.8)if(e.collected=!0,"heal"===e.type){const o=0|hp;hp=Math.min(100,hp+25),hudMsg="HEAL +"+((0|hp)-o),hudUntil=performance.now()+2500,sfx(640,.1,.22,"triangle")}else shardCount++,hudMsg="SHARD +1",hudUntil=performance.now()+2500,sfx(900,.06,.25,"triangle")}for(let o=0;o<doors.length;o++){const e=doors[o];e.open=shardCount>=e.req,e.activeVisual=e.open}if(!gameOver)for(const o of doors){const e=Math.hypot(pos[0]-o.pos[0],pos[2]-o.pos[2]);if(!o.open&&e<1.2&&d>hudUntil&&(hudMsg=`NEED ${o.req} SHARDS`,hudUntil=d+900),o.open&&pointInDoor(pos,o,.02)){hp=Math.min(100,hp+25),sfx(1080,.2,.2,"triangle"),levelIndex++,levelIndex<LEVELS.length?(sfx(1200,.5,.25,"triangle"),loadLevel(LEVELS[levelIndex]),hudMsg=`LEVEL ${levelIndex+1} — COLLECT ${minDoorReq||0} SHARDS`,hudUntil=performance.now()+2600,levelIndex%3==0&&(checkpointIndex=levelIndex,hudMsg=`RITUAL ${Math.floor(levelIndex/3)} COMPLETE — CHECKPOINT SET`,hudUntil=performance.now()+2800)):(gameOver=!0,showEnd("ritualWin","RITUAL COMPLITE","Catacombs now silent. You have made way out."),sfx(1200,.5,.25,"triangle"));break}}if(!gameOver)for(let o=0;o<cats.length;o++){const t=cats[o],s=performance.now();let n=1===t.mode&&s<t.modeUntil;1!==t.mode||n||(t.mode=0,t.gaze=0,t.eyes=0,t.attacking=!1,t.pos=t.spawn.slice());const a=pos[0]-t.pos[0],l=pos[1]-t.pos[1],c=pos[2]-t.pos[2],u=Math.hypot(a,l,c);if(n){t.attacking=!1,t.eyes=0,t.theta+=.8*e;const o=pos[0]+1.9*Math.sin(t.theta),n=pos[2]+1.9*Math.cos(t.theta);t.pos[0]+=(o-t.pos[0])*Math.min(1,1.2*e*1.5),t.pos[2]+=(n-t.pos[2])*Math.min(1,1.2*e*1.5),s>t.nextBlink&&(t.nextBlink=s+1500+1500*Math.random(),t.pos[0]=pos[0]-1.4*i[0]+.4*(Math.random()-.5)*r[0],t.pos[2]=pos[2]-1.4*i[2]+.4*(Math.random()-.5)*r[2],t.noGazeUntil=s+300);const a=t.pos[0]-pos[0],l=t.pos[1]-pos[1],c=t.pos[2]-pos[2];(a*i[0]+l*i[1]+c*i[2])/Math.max(.001,Math.hypot(a,l,c))>.92&&u<4&&s>(t.noGazeUntil||0)?(t.gaze+=e,fearPulse=Math.min(1,fearPulse+1.5*e),t.gaze>.6&&(hp=Math.max(0,hp-8*e),hudMsg="DON'T STARE",hudUntil=s+2500,hp<=0&&(gameOver=!0,endState="fail",hudMsg="RITUAL FAILED — CLICK TO RESTART",hudUntil=s+999999,sfx(140,.6,.25,"sawtooth")))):t.gaze*=Math.exp(2*-e)}else if(t.attacking){const n=1/Math.max(1e-5,u);let i=a*n,d=l*n,p=c*n;const f=.3*Math.sin(.012*s+o);i+=r[0]*f,p+=r[2]*f;const m=1/Math.max(1e-5,Math.hypot(i,d,p));i*=m,d*=m,p*=m,t.pos[0]+=3*i*e,t.pos[1]+=3*d*e,t.pos[2]+=3*p*e,t.eyes=1,u<.6&&(hp=Math.max(0,hp-25),hurtPulse=1,hudMsg="BLACK CAT ATTACKED YOU",hudUntil=s+2500,sfx(220,.12,.3,"square"),t.pos=t.spawn.slice(),t.attacking=!1,t.eyes=0,hp<=0&&(gameOver=!0,endState="fail",hudMsg="RITUAL FAILED — CLICK TO RESTART",hudUntil=s+999999,sfx(140,.6,.25,"sawtooth")))}else u<3.5?(t.eyes=Math.min(1,t.eyes+e*(1/1500*1e3)),t.eyes>=1&&(t.attacking=!0)):(t.eyes=0,t.pos[2]+=.4*e,t.pos[2]>t.spawn[2]+1.5&&(t.pos[2]=t.spawn[2]+1.5))}if(hurtPulse*=Math.exp(3.5*-e),muzzle*=Math.exp(25*-e),fearPulse*=Math.exp(2.2*-e),boss.active&&!gameOver){const o=performance.now();if(1===boss.phase)boss.eyes=0,o>boss.until&&(boss.phase=2,boss.until=o+3e3+1e3*Math.random());else if(2===boss.phase){boss.eyes=0;const t=3,s=.9,n=7e-4*o%6.283,a=pos[0]+Math.sin(n)*t,l=pos[2]+Math.cos(n)*t;boss.pos[0]+=(a-boss.pos[0])*Math.min(1,e*s*1.6),boss.pos[2]+=(l-boss.pos[2])*Math.min(1,e*s*1.6);const r=boss.pos[0]-pos[0],c=boss.pos[1]-pos[1],u=boss.pos[2]-pos[2],d=Math.hypot(r,c,u);if((r*i[0]+c*i[1]+u*i[2])/Math.max(.001,d)>.9&&d<6&&(fearPulse=Math.min(1,fearPulse+2*e),hp=Math.max(0,hp-15*e),o>hudUntil&&(hudMsg="THE AVATAR FEEDS ON YOUR STARE",hudUntil=o+900),hp<=0&&(gameOver=!0,endState="fail",hudMsg="RITUAL FAILED — CLICK TO RESTART",hudUntil=o+999999,sfx(140,.6,.25,"sawtooth"))),o>=boss.nextShot){const e=pos[0]-boss.pos[0],t=pos[2]-boss.pos[2],s=Math.hypot(e,t),n=1/Math.max(1e-5,s),a=e*n*2.1*1.05,i=t*n*2.1*1.05;orbs.length>=12&&orbs.shift(),orbs.push({pos:[boss.pos[0],0,boss.pos[2]],vel:[a,0,i],R:.24,collected:!1,type:"orb",born:o,ttl:4800}),sfx(520,.05,.15,"square"),boss.nextShot=o+1100+700*Math.random()}o>boss.until&&(boss.phase=3,boss.until=o+1200,boss.eyes=1)}else if(3===boss.phase)boss.eyes=Math.min(1,boss.eyes+3*e),o>boss.until&&(boss.phase=2,boss.until=o+2600+900*Math.random(),boss.eyes=0);else if(4===boss.phase){if(boss.eyes=0,!boss.didNova){boss.didNova=!0;const e=8,t=2.1*.9;for(let s=0;s<e;s++){const n=s*(2*Math.PI/e),a=Math.cos(n)*t,i=Math.sin(n)*t;orbs.length>=12&&orbs.shift(),orbs.push({pos:[boss.pos[0],0,boss.pos[2]],vel:[a,0,i],R:.22,collected:!1,type:"orb",born:o,ttl:5200})}sfx(360,.1,.18,"square")}o>boss.until&&(boss.phase=2,boss.until=o+2600+900*Math.random())}}for(const o of turrets)if(d>=o.next){const e=pos[0]-o.pos[0],t=pos[2]-o.pos[2],s=Math.hypot(e,t);if(s<8&&hasLOS(o.pos[0],o.pos[2],pos[0],pos[2])){const n=1/Math.max(1e-5,s),a=e*n*2.1,i=t*n*2.1;orbs.length>=12&&orbs.shift(),orbs.push({pos:[o.pos[0],0,o.pos[2]],vel:[a,0,i],R:.22,collected:!1,type:"orb",born:d,ttl:5200}),sfx(520,.05,.15,"square")}o.next=d+1400+1e3*Math.random()}for(const o of orbs)if(!o.collected)if(o.pos[0]+=o.vel[0]*e,o.pos[2]+=o.vel[2]*e,isSolidAt(o.pos[0],o.pos[2]))o.collected=!0;else{for(const e of doors)if(!e.open&&pointInDoor([o.pos[0],0,o.pos[2]],e,o.R)){o.collected=!0;break}o.collected||(d>o.born+o.ttl?o.collected=!0:Math.hypot(o.pos[0]-pos[0],o.pos[2]-pos[2])<.38&&(hp=Math.max(0,hp-10),hurtPulse=1,o.collected=!0,sfx(180,.08,.22,"square"),hp<=0&&(gameOver=!0,endState="fail",hudMsg="RITUAL FAILED — CLICK TO RESTART",hudUntil=d+999999,sfx(140,.6,.25,"sawtooth"))))}const p=`${d<hudUntil?hudMsg:""}   SHARDS:${shardCount}   HP:${0|hp}`;if(hud._prev!==p&&(hud.textContent=p,hud._prev=p),"none"!==endState){const o=Math.ceil((endLockUntil-performance.now())/1e3);endS.textContent=o>0?`Wait for ${o} s, then click to restart.`:"Click to restart."}gl.uniform2f(uRes,W,H),gl.uniform1f(uTime,(o-startT)/1e3),gl.uniform3fv(uCam,vec3(pos[0],pos[1],pos[2])),gl.uniform3fv(uF,vec3(i[0],i[1],i[2])),gl.uniform3fv(uR,vec3(r[0],r[1],r[2])),gl.uniform3fv(uU,vec3(l[0],l[1],l[2])),gl.uniform1f(uEnemy,performance.now()<enemyDownUntil?0:1),gl.uniform1f(uHurt,hurtPulse),gl.uniform1f(uMuzzle,muzzle),gl.uniform1f(uFear,fearPulse);{const o=pickNearest(cats,6,o=>o.pos),e=0|o.length,t=new Float32Array(52),s=new Float32Array(13),n=new Float32Array(13),a=performance.now();for(let i=0;i<Math.min(e,13);i++){const e=o[i],l=cats[e];t[4*i+0]=l.pos[0],t[4*i+1]=l.pos[1],t[4*i+2]=l.pos[2],s[i]=1===l.mode&&a<l.modeUntil?2:1,n[i]=l.eyes}gl.uniform1i(uCatCount,Math.min(e,13)),gl.uniform4fv(uCatsPos,t),gl.uniform1fv(uCatsState,s),gl.uniform1fv(uCatsEyes,n)}{const o=6,e=spheres.concat(orbs.filter(o=>!o.collected)),t=pickNearest(e,o,o=>o.pos),s=0|t.length,n=new Float32Array(48),a=new Float32Array(12),i=performance.now();for(let o=0;o<Math.min(s,12);o++){const s=e[t[o]];n[4*o+0]=s.pos[0],n[4*o+1]=s.pos[1],n[4*o+2]=s.pos[2],n[4*o+3]=("heal"===s.type?-1:1)*s.R,a[o]=s.collected||i<(s.downUntil||0)?0:"orb"===s.type?2:1}gl.uniform1i(uSphereCount,Math.min(s,12)),gl.uniform4fv(uSpheresPos,n),gl.uniform1fv(uSpheresActive,a)}{const o=Math.min(0|doors.length,4),e=new Float32Array(16),t=new Float32Array(16);for(let s=0;s<o;s++){const o=doors[s];e[4*s+0]=o.pos[0],e[4*s+1]=o.pos[1],e[4*s+2]=o.pos[2],t[4*s+0]=o.half[0],t[4*s+1]=o.half[1],t[4*s+2]=o.half[2],t[4*s+3]=o.activeVisual?1:0}gl.uniform1i(uDoorCount,o),gl.uniform4fv(uDoorsPos,e),gl.uniform4fv(uDoorsHalf,t)}{const o=Math.min(6,6),e=pickNearest(turrets,o,o=>o.pos),t=Math.min(0|e.length,6),s=new Float32Array(24);for(let o=0;o<t;o++){const t=turrets[e[o]];s[4*o+0]=t.pos[0],s[4*o+1]=t.pos[1],s[4*o+2]=t.pos[2]}gl.uniform1i(uTurretCount,t),gl.uniform4fv(uTurretsPos,s)}gl.uniform1i(uBossActive,boss.active?1:0),gl.uniform4f(uBoss,boss.pos[0],boss.pos[1],boss.pos[2],boss.scale),gl.uniform1f(uBossEyes,boss.eyes),gl.uniform1f(uBossPhase,boss.phase),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,TILE_TEX.tex),gl.uniform1i(uTileTex,0),gl.uniform2i(uTileSize,TILE_TEX.cols,TILE_TEX.rows),gl.uniform2f(uTileCenter,LV.center[0],LV.center[1]),gl.uniform1f(uTileScale,2),gl.drawArrays(gl.TRIANGLES,0,3),requestAnimationFrame(frame)}function resetGame(){shardCount=0,hp=100,gameOver=!1,hurtPulse=0,muzzle=0,hideEnd(),endState="none",endLockUntil=0,levelIndex=0|checkpointIndex,loadLevel(LEVELS[levelIndex])}uBossActive=gl.getUniformLocation(pr,"uBossActive"),uBoss=gl.getUniformLocation(pr,"uBoss"),uBossEyes=gl.getUniformLocation(pr,"uBossEyes"),uBossPhase=gl.getUniformLocation(pr,"uBossPhase"),loadLevel(LEVELS[levelIndex]),document.addEventListener("keydown",onKey),document.addEventListener("keyup",onKey),canvas.addEventListener("mousedown",()=>{canvas.requestPointerLock?.()},{passive:!0}),document.addEventListener("pointerlockchange",()=>{},!1),document.addEventListener("mousemove",o=>{document.pointerLockElement===canvas&&(yaw+=.002*o.movementX,pitch-=.002*o.movementY,pitch=Math.max(-1.5,Math.min(1.5,pitch)))}),canvas.addEventListener("mousedown",o=>{if(0===o.button){if("none"!==endState){if(performance.now()<endLockUntil)return;return"bossWin"===endState||"ritualWin"===endState?(levelIndex=0,checkpointIndex=0):levelIndex=0|checkpointIndex,gameOver=!1,hideEnd(),hp=100,loadLevel(LEVELS[levelIndex]),hudMsg=`RESPAWN AT LEVEL ${levelIndex+1}`,void(hudUntil=performance.now()+2e3)}if(gameOver)return levelIndex=0|checkpointIndex,gameOver=!1,hp=100,loadLevel(LEVELS[levelIndex]),hudMsg=`RESPAWN AT LEVEL ${levelIndex+1}`,void(hudUntil=performance.now()+2e3);muzzle=1,sfx(1200,.08,.22,"square");const t=performance.now(),s=Math.cos(yaw),n=Math.sin(yaw),a=Math.cos(pitch),i=Math.sin(pitch),l=pos,r=[n*a,i,-s*a];for(let c=0;c<spheres.length;c++){const u=spheres[c];if(u.collected)continue;const d=u.pos,p=u.R,f=[l[0]-d[0],l[1]-d[1],l[2]-d[2]],m=-(f[0]*r[0]+f[1]*r[1]+f[2]*r[2]);if(m>0){const h=f[0]+m*r[0],v=f[1]+m*r[1],g=f[2]+m*r[2];Math.hypot(h,v,g)<=p+.02&&(u.downUntil=t+2e3)}}function e(o,e,t,s,n=.02){const a=[o[0]-t[0],o[1]-t[1],o[2]-t[2]],i=-(a[0]*e[0]+a[1]*e[1]+a[2]*e[2]);if(i<=0)return!1;const l=a[0]+i*e[0],r=a[1]+i*e[1],c=a[2]+i*e[2];return l*l+r*r+c*c<=(s+n)*(s+n)}for(let S=0;S<cats.length;S++){const T=cats[S],E=[{C:[T.pos[0]+.6,T.pos[1]+.16,T.pos[2]+.17],R:.32},{C:[T.pos[0]+.22,T.pos[1]+0,T.pos[2]+0],R:.4},{C:[T.pos[0]-.15,T.pos[1]+.02,T.pos[2]+0],R:.44}];let x=!1;for(const y of E)if(e(pos,r,y.C,y.R,.03)){x=!0;break}x&&(0===T.mode?(T.mode=1,T.modeUntil=t+7e3+2500,T.attacking=!1,T.eyes=0,hudMsg="IT SPLITS — WRAITH!",hudUntil=t+2500,sfx(1800,.1,.25,"sawtooth"),fearPulse=1):(T.modeUntil=t+Math.max(1500,T.modeUntil-t+800),hudMsg="WRAITH SHRIEKS",hudUntil=t+2500,sfx(260,.12,.25,"triangle"),fearPulse=1))}if(boss.active&&3===boss.phase){const L=boss.scale,b=boss.pos,R=[b[0]+.662*L,b[1]+.172*L,b[2]+.238*L],C=[b[0]+.662*L,b[1]+.172*L,b[2]+.102*L],M=.1*L;(e(l,r,R,M,.02)||e(l,r,C,M,.02))&&(boss.lives=Math.max(0,boss.lives-1),boss.phase=4,boss.until=t+900,boss.eyes=0,boss.didNova=!1,hudMsg=`LIFE -1 (${boss.lives}/9)`,hudUntil=t+1200,sfx(460,.2,.28,"triangle"),fearPulse=1,boss.lives<=0&&(boss.active=!1,gameOver=!0,showEnd("bossWin","CEREMONY COMPLITE","CHERNOCOT avatar has been banished from this realm. The World signs in relief."),sfx(1200,.6,.25,"triangle")))}for(let A=0;A<orbs.length;A++){const k=orbs[A];k.collected||e(l,r,k.pos,k.R,.03)&&(k.collected=!0,sfx(420,.05,.18,"triangle"))}}}),canvas.addEventListener("mousedown",o=>{2===o.button&&(rightMouse=!0,o.preventDefault())}),canvas.addEventListener("mouseup",o=>{2===o.button&&(rightMouse=!1,o.preventDefault())}),canvas.addEventListener("contextmenu",o=>o.preventDefault()),requestAnimationFrame(frame),console.assert(canvas&&gl instanceof WebGL2RenderingContext,"canvas exists"),console.assert("requestPointerLock"in canvas&&"exitPointerLock"in document,"pointer lock path"),function(){let o=keys;onKey({code:"KeyW",type:"keydown",preventDefault:()=>{}}),console.assert(!0===o.KeyW,"input update"),onKey({code:"KeyW",type:"keyup",preventDefault:()=>{}})}(),console.assert(gl.getProgramParameter(pr,gl.LINK_STATUS),"shader compile success"),setTimeout(()=>console.assert(frames>0,"frame counter > 0 after 1s"),1100)</script>