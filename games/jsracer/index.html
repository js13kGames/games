<!doctype html><html lang="fr"><head><meta charset="UTF-8"><title>JSRACER</title><style type="text/css">html,body {margin:0;height:100%;overflow:hidden;perspective:2000px;font-family:Arial;color: #FFF;}#levels {width: 1000%;padding: 0;transition:all 0.5s ease-out;height:50vh;}li {animation: a 8s linear infinite;box-shadow: 0 0 18px #FFF;background-color: #FFF;display: inline-block;margin: 0 1%;opacity:0.5;width: 30vw;vertical-align: middle;text-align: center;}li img {max-width: 100%;max-height: 24vw;}img {max-height:100%;}@keyframes a {0% { transform: rotateX(45deg) rotateZ(0deg);}100% { transform: rotateX(45deg) rotateZ(360deg);}}#home2,#end,#GUI,#game {position:absolute;top:0; left:0; width:100%; height:100%}h1 {text-align: center;font-size: 6vw;transform: rotateX(8deg) rotateY(343deg);text-shadow: -3px -3px 0 #f00,3px -3px 0 #0007ef,-3px 3px 0 #0043ff,3px 3px 0 #fff,4px 4px 0 #fff,5px 5px 0 #fff,6px 6px 0 #fff,7px 7px 0 #fff;margin-bottom:0;}h2,h4 {position: absolute;width: 100%;text-align: center;font-size: 3vw!important;transform: rotateX(362deg) rotateY(0deg) skew(-12deg);animation: b 4s ease-in-out infinite alternate;}h2 {bottom: 0px;}h3 {text-align: center;font-size:24px;animation: b 1s ease-in-out infinite alternate;}@keyframes b {0% { transform: rotateX(362deg) rotateY(-4deg) skew(-12deg);}100% { transform:rotateX(362deg) rotateY(4deg) skew(-12deg);}}</style><script id="rings-fs" type="x-shader/x-fragment">precision mediump float;precision highp int;varying float vLightWeighting;varying vec3 inTunnel;varying vec3 normal;uniform float iTime;void main( void ){float time=iTime/1000.;float cosTheta=dot(abs(normal),vec3(0.,1.,0.));cosTheta*=cosTheta;cosTheta*=cosTheta;float extra=1.;if(inTunnel.x>0.){extra=inTunnel.x;}gl_FragColor=vec4(vec3(0.5+(cos(iTime/100.)/2.),0.+(sin(iTime/100.)/2.),0.5+(sin(iTime/100.)/2.))*extra*vLightWeighting*(0.5+cosTheta),1.);}</script><script id="rock-fs" type="x-shader/x-fragment">precision mediump float;precision highp int;varying vec2 vTextureCoord;varying float vLightWeighting;varying vec3 worldPosition;varying vec3 vPosition;varying vec3 inTunnel;varying vec3 normal;uniform vec3 lights[48];uniform int nbLights;uniform float iTime;uniform sampler2D uSampler;void main( void ){float time=iTime/1000.;float cosTheta=dot(abs(normal),vec3(1.,0.5,1.));cosTheta*=cosTheta;vec4 textureColor=texture2D(uSampler,vec2(vTextureCoord.s,vTextureCoord.t));float extra=1.;if(inTunnel.x>0.){extra=inTunnel.x;}gl_FragColor=vec4(textureColor.rgb*extra*vLightWeighting*(cosTheta/2.),1.);vec3 totalLight=vec3(0.,0.,0.);for(int i=0; i<48; i++){if(i==nbLights){break;}vec3 light;float d=distance(worldPosition,lights[i].xyz);light=vec3(0.5+(cos(iTime/100.)/2.),0.+(sin(iTime/100.)/2.),0.5+(sin(iTime/100.)/2.));light*=max(0.,1.-(0.4*(d)));totalLight+=light;}gl_FragColor+=vec4(totalLight/6.,1.);}</script><script id="shader-fs" type="x-shader/x-fragment">precision mediump float;varying vec2 vTextureCoord;varying float vLightWeighting;varying vec3 worldPosition;varying vec3 normal;uniform sampler2D uSampler;uniform vec3 lights[48];uniform int nbLights;uniform int showShadows;uniform float iTime;void main(void){vec4 textureColor=texture2D(uSampler,vec2(vTextureCoord.s,vTextureCoord.t));if(showShadows>0){float cosTheta=0.5+abs(dot(normal,vec3(0.,0.,1.))/2.);gl_FragColor=vec4(textureColor.rgb*vLightWeighting*cosTheta,textureColor.a);}else{gl_FragColor=vec4(textureColor.rgb*vLightWeighting,textureColor.a);}}</script><script id="shader-vs" type="x-shader/x-vertex">attribute vec3 aVertexPosition;attribute vec2 aTextureCoord;attribute vec3 vertexsNormals;attribute vec3 tunnel;uniform mat4 uMVMatrix;uniform mat4 uPMatrix;uniform vec3 cameraPosition;varying vec2 vTextureCoord;varying float vLightWeighting;varying vec3 normal;varying vec3 inTunnel;varying vec3 worldPosition;varying vec2 frag_uv;varying vec3 vPosition;void main(void){gl_Position=uPMatrix*uMVMatrix*vec4(aVertexPosition,1.);normal=vertexsNormals;inTunnel=tunnel;vPosition=normalize(aVertexPosition);vTextureCoord=aTextureCoord*1.;vLightWeighting=1.-gl_Position.z/50.;worldPosition=cameraPosition.xyz+aVertexPosition;}</script></head><body onload="webGLStart();" onresize="resize()"><div id="race"><canvas id="canvasMap"></canvas><canvas id="textureCanvas"></canvas><canvas id="game"></canvas><canvas id="GUI" ></canvas></div><div id="home" style="height:100%"></div><div id="home2"><h1>JS RACER</h1><ul id="levels"></ul><h3></h3><h2>SELECT A TRACK AND PRESS SPACEBAR TO START</h2></div><div id="end"><h1>JS RACER</h1><h4></h4><h2>PRESS SPACEBAR TO CONTINUE</h2></div></body></html><script>function SfxrP(){this.set=function(e){for(var t=0;24>t;t++)this[String.fromCharCode(97+t)]=e[t]||0;this.c<.01&&(this.c=.01);var a=this.b+this.c+this.e;if(.18>a){var r=.18/a;this.b*=r,this.c*=r,this.e*=r}}}function sy(){this._p=new SfxrP;var e,t,a,r,i,n,o,s,l,c,g,d;this.reset=function(){var e=this._p;r=100/(e.f*e.f+.001),i=100/(e.g*e.g+.001),n=1-e.h*e.h*e.h*.01,o=-e.i*e.i*e.i*1e-6,e.a||(g=.5-e.n/2,d=5e-5*-e.o),s=1+e.l*e.l*(e.l>0?-.9:10),l=0,c=1==e.m?0:(1-e.m)*(1-e.m)*2e4+32},this.totalReset=function(){this.reset();var r=this._p;return e=r.b*r.b*1e5,t=r.c*r.c*1e5,a=r.e*r.e*1e5+12,3*((e+t+a)/3|0)},this.sW=function(m,u){var h=this._p,f=1!=h.s||h.v,v=h.v*h.v*.1,x=1+3e-4*h.w,y=h.s*h.s*h.s*.1,p=1+1e-4*h.t,b=1!=h.s,R=h.x*h.x,M=h.g,P=h.q||h.r,A=h.r*h.r*h.r*.2,S=h.q*h.q*(h.q<0?-1020:1020),T=h.p?((1-h.p)*(1-h.p)*2e4|0)+32:0,E=h.d,I=h.j/2,w=h.k*h.k*.01,_=h.a,U=e,F=1/e,k=1/t,B=1/a,D=5/(1+h.u*h.u*20)*(.01+y);D>.8&&(D=.8),D=1-D;for(var L,N,C,Y,z,X,G=!1,V=0,W=0,H=0,O=0,Q=0,q=0,K=0,j=0,J=0,Z=0,$=new Array(1024),et=new Array(32),tt=$.length;tt--;)$[tt]=0;for(var tt=et.length;tt--;)et[tt]=2*Math.random()-1;for(var tt=0;u>tt;tt++){if(G)return tt;if(T&&++J>=T&&(J=0,this.reset()),c&&++l>=c&&(c=0,r*=s),n+=o,r*=n,r>i&&(r=i,M>0&&(G=!0)),N=r,I>0&&(Z+=w,N*=1+Math.sin(Z)*I),N|=0,8>N&&(N=8),_||(g+=d,0>g?g=0:g>.5&&(g=.5)),++W>U)switch(W=0,++V){case 1:U=t;break;case 2:U=a}switch(V){case 0:H=W*F;break;case 1:H=1+2*(1-W*k)*E;break;case 2:H=1-W*B;break;case 3:H=0,G=!0}P&&(S+=A,C=0|S,0>C?C=-C:C>1023&&(C=1023)),f&&x&&(v*=x,1e-5>v?v=1e-5:v>.1&&(v=.1)),X=0;for(var at=8;at--;){if(K++,K>=N&&(K%=N,3==_))for(var rt=et.length;rt--;)et[rt]=2*Math.random()-1;switch(_){case 0:z=g>K/N?.5:-.5;break;case 1:z=1-K/N*2;break;case 2:Y=K/N,Y=6.28318531*(Y>.5?Y-1:Y),z=1.27323954*Y+.405284735*Y*Y*(0>Y?1:-1),z=.225*((0>z?-1:1)*z*z-z)+z;break;case 3:z=et[Math.abs(32*K/N|0)]}f&&(L=q,y*=p,0>y?y=0:y>.1&&(y=.1),b?(Q+=(z-q)*y,Q*=D):(q=z,Q=0),q+=Q,O+=q-L,O*=1-v,z=O),P&&($[j%1024]=z,z+=$[(j-C+1024)%1024],j++),X+=z}X*=.125*H*R,m[tt]=X>=1?1:-1>=X?-1:X}return u}}function setMatrixUniforms(e){gl.uniformMatrix4fv(e.pMatrixUniform,!1,pMatrix),gl.uniformMatrix4fv(e.mvMatrixUniform,!1,mvMatrix)}function getShader(e,t){var a=self[t],r=e.createShader("x-shader/x-fragment"==a.type?e.FRAGMENT_SHADER:e.VERTEX_SHADER);return e.shaderSource(r,a.textContent),e.compileShader(r),r}function initShaders(){var e=[["shaderProgram","shader-fs"],["shaderRock","rock-fs"],["shaderRings","rings-fs"]];e.forEach(function(e){s=gl.createProgram(),gl.attachShader(s,getShader(gl,"shader-vs")),gl.attachShader(s,getShader(gl,e[1])),gl.linkProgram(s),gl.useProgram(s),s.vertexPositionAttribute=gl.getAttribLocation(s,"aVertexPosition"),gl.enableVertexAttribArray(s.vertexPositionAttribute),s.textureCoordAttribute=gl.getAttribLocation(s,"aTextureCoord"),gl.enableVertexAttribArray(s.textureCoordAttribute),s.vertexsNormals=gl.getAttribLocation(s,"vertexsNormals"),gl.enableVertexAttribArray(s.vertexsNormals),s.tunnel=gl.getAttribLocation(s,"tunnel"),gl.enableVertexAttribArray(s.tunnel),s.iTime=gl.getUniformLocation(s,"iTime"),s.pMatrixUniform=gl.getUniformLocation(s,"uPMatrix"),s.mvMatrixUniform=gl.getUniformLocation(s,"uMVMatrix"),s.samplerUniform=gl.getUniformLocation(s,"uSampler"),s.cameraPosition=gl.getUniformLocation(s,"cameraPosition"),s.lights=gl.getUniformLocation(s,"lights"),s.nbLights=gl.getUniformLocation(s,"nbLights"),s.showShadows=gl.getUniformLocation(s,"showShadows"),self[e[0]]=s}),cubeVertexIndexBuffer=gl.createBuffer(),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,cubeVertexIndexBuffer);var t=[0,1,2,0,2,3];gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(t),gl.STATIC_DRAW),cubeVertexIndexBuffer.itemSize=1,cubeVertexIndexBuffer.numItems=6}function handleLoadedTexture(e){gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.bindTexture(gl.TEXTURE_2D,e),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e.image),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST),gl.generateMipmap(gl.TEXTURE_2D)}function handleLoadedTextureFromCanvas(e,t){texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,t),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.generateMipmap(gl.TEXTURE_2D),gl.bindTexture(gl.TEXTURE_2D,null),texture._img=new Image,texture._img.src=t.toDataURL(),self[e]=texture}function initTexture(){sol=gl.createTexture(),sol.image=new Image,sol.image.onload=function(){handleLoadedTexture(sol)},sol.image.src="boue.png"}function degToRad(e){return e*Math.PI/180}function radToDeg(e){return e*(180/Math.PI)}function getQuadraticXY(e,t){return{x:(1-e)*(1-e)*t[0]+2*(1-e)*e*t[2]+e*e*t[4],y:(1-e)*(1-e)*t[1]+2*(1-e)*e*t[3]+e*e*t[5]}}function getQuadraticAngle(e,t){return-Math.atan2(2*(1-e)*(t[2]-t[0])+2*e*(t[4]-t[2]),2*(1-e)*(t[3]-t[1])+2*e*(t[5]-t[3]))+.5*Math.PI}function getQuadraticLength(e,t,a,r,i,n){if(e==a&&t==r)return t-n;var o=e-2*a+i,s=t-2*r+n,l=2*a-2*e,c=2*r-2*t,g=4*(o*o+s*s),d=4*(o*l+s*c),m=l*l+c*c,u=2*Math.sqrt(g+d+m),h=Math.sqrt(g),f=2*g*h,v=2*Math.sqrt(m),x=d/h;return(f*u+h*d*(u-v)+(4*m*g-d*d)*Math.log((2*h+x+u)/(x+v)))/(4*f)}function Random(e){this._seed=e%2147483647,this._seed<=0&&(this._seed+=2147483646)}function resize(){gl=game.getContext("webgl"),game.width=gl.viewportWidth=GUI.width=self.innerWidth,game.height=gl.viewportHeight=GUI.height=self.innerHeight}function webGLStart(){initSound("engine",[0,,.81,,,.18,,,,,,,,2e-4,,,,,1,,,.1,,.5],.1),initSound("brake",[0,,.3213,,.1078,.3735,,.207,,.2345,.5592,,,.0971,,,,,1,,,,,.5],.2),initSound("note",[2,,.01,.3845,4.92,.7389,,,,,,,,,,,,,1,,,,,.5],.02),initSound("heart",[2,,.0697,,.1102,.14,,,,,,,,.0815,,,,,1,,,,,.64],0),ctx=GUI.getContext("2d"),resize(),initShaders(),initTexture(),gl.clearColor(0,0,0,1),gl.enable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),textureCanvas.width=textureCanvas.height=512;var e=textureCanvas.getContext("2d"),t=e.createLinearGradient(0,512,0,0);t.addColorStop(0,"#334499"),t.addColorStop(.5,"#000"),t.addColorStop(1,"#000"),e.fillStyle=t,e.fillRect(0,0,512,512),handleLoadedTextureFromCanvas("sky",textureCanvas),textureCanvas.width=512,textureCanvas.height=128,e.fillStyle="#AAA",e.fillRect(0,0,512,512),e.fillStyle="white",e.fillRect(16,16,480,96);var a=0;size=8;for(var r=0;512>r;r+=size){for(var i=a;512>i;i+=2*size)e.fillRect(i,r,size,size);a=a?0:size}e.font="bold italic 64px Arial",e.fillStyle="#f50",e.fillText("CHECKPOINT",45,88),handleLoadedTextureFromCanvas("checkpoint",textureCanvas),e.fillStyle="white",e.fillRect(0,16,512,96),e.fillStyle="#f50",e.fillText("FINISH",150,88),handleLoadedTextureFromCanvas("finishLine",textureCanvas),imageDataH=ctx.createImageData(20,5),imageDataV=ctx.createImageData(5,20),[0,128,255].forEach(function(e){for(r=0;5>r;r++)for(i=Math.abs(2-r);i<20-Math.abs(2-r);i++)setPixel(i,r,e,0,0,imageDataH),setPixel(r,i,e,0,0,imageDataV);values=[119,36,93,109,46,107,123,37,127,111];for(var t=0;10>t;t++)chiffres[e+""+t]=ctx.createImageData(40,50),1&values[t]&&copyImageData(imageDataH,3,0,chiffres[e+""+t]),8&values[t]&&copyImageData(imageDataH,3,21,chiffres[e+""+t]),64&values[t]&&copyImageData(imageDataH,3,42,chiffres[e+""+t]),2&values[t]&&copyImageData(imageDataV,0,3,chiffres[e+""+t]),4&values[t]&&copyImageData(imageDataV,21,3,chiffres[e+""+t]),16&values[t]&&copyImageData(imageDataV,0,24,chiffres[e+""+t]),32&values[t]&&copyImageData(imageDataV,21,24,chiffres[e+""+t]);chiffres[e+" "]=ctx.createImageData(40,50),copyImageData(imageDataV,0,3,chiffres[e+" "])}),showEnterGame(),tick()}function tick(){if(mat4.perspective(fov,gl.viewportWidth/gl.viewportHeight,.001,150,pMatrix),mat4.identity(mvMatrix),gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.depthMask(!1),drawSky(),gl.depthMask(!0),!GameStarted)return sounds.engine.playbackRate.value*=.99,sounds.engine._dest.gain.value*=.99,void requestAnimationFrame(tick);if(frame++,frame>180&&(timeLeft-=1/60),0>=timeLeft)return endGame(!0),void requestAnimationFrame(tick);if(backInProgress){1==back.length&&(backInProgress=!1,backP=0);var e=back.pop();camera=e.camera,velocityR=e.velocityR,velocity=e.velocity,speed=e.speed,rpm=e.rpm,vitesse=e.vitesse,gear=e.gear,timeLeft=e.timeLeft,currentSectionNumber=e.currentSectionNumber,e.hideRing&&(rings[e.hideRing].visible=!0)}else{if(position={x:128-(camera.x+velocity.x),y:camera.y+velocity.y+512},oldS=currentSectionNumber,currentPosition=getShortestStartFrom(position,0,1,9999999,0,!1),2==altitudes[currentSectionNumber].length)return endGame(),void requestAnimationFrame(tick);if(currentSectionNumber>oldS&&playSound([0,,.0457,.4586,.477,.5938,,,,,,,,,,,,,1,,,,,.57]),camera.rotation.x<-180&&(camera.rotation.x+=360),cible=sens*(radToDeg(-currentPosition[3])-90),-180>cible&&(cible+=360),cible>180&&(cible-=360),cible>camera.rotation.x?camera.rotation.x+=(cible-camera.rotation.x)/10:camera.rotation.x-=(camera.rotation.x-cible)/10,camera.z=currentPosition[2]-127.95,angleBord=radToDeg(getQuadraticAngle(currentPosition[0],section)),currentPosition[1]<=currentPosition[4])camera.x+=velocity.x,camera.y+=velocity.y;else{var t=radToDeg(Math.atan2(velocity.y,-velocity.x));for(nbTest=0;;){if(nbTest++,nouvelAngleRad=degToRad(angleBord+angleBord-t-90),ancienAngle=Math.atan2(velocity.y,-velocity.x),velocity.x=Math.sin(nouvelAngleRad)*speed/1.2,velocity.y=Math.cos(nouvelAngleRad)*speed/1.2,vitesse/=1.2,position={x:128-(camera.x+velocity.x),y:camera.y+velocity.y+512},currentPosition2=getShortestStartFrom(position,0,1,9999999,0,!1),!(currentPosition2[1]>currentPosition[4]))break;if(angleBord+=0>nouvelAngleRad-ancienAngle?10:-10,36==nbTest)break}playSound([3,,.2469,.7464,.0704,.0242,,-.0179,,,,-.1426,.7292,,,,-.006,-.2524,1,,,,,.5])}debrayage&&(rpm-=200,debrayage>=rpm&&(rpm=debrayage,debrayage=!1));var a=!1;facteurPente=1-2*((currentPosition[3]+Math.PI)%Math.PI-Math.PI/2),0>sens&&(facteurPente=2-facteurPente),moveF&&frame>180?debrayage||(vitesse-=gears[gear]*facteurPente):moveB&&frame>180?(vitesse+=gears[gear],0>vitesse&&(vitesse+=.001,a=!0)):vitesse*=.995,vitesse>.1&&(vitesse=.09),debrayage||(rpm=gears[gear]*-vitesse*1e8),rpm>=6e3?6==gear?vitesse+=gears[gear]:(gear++,debrayage=gears[gear]*-vitesse*1e8):2500>=rpm&&0!=gear&&gear--,a?sounds.brake._play():sounds.brake._stop(),moveL?velocityR-=.1:moveR?velocityR+=.1:velocityR*=.9,velocityR=Math.min(velocityR,1),velocityR=Math.max(velocityR,-1),camera.rotation.z+=4*velocityR-.1*camera.rotation.z,camera.rotation.y+=velocityR*(1.5-2*speed),velocity.x*=.9,velocity.y*=.9,velocity.z*=.9,velocity.y+=Math.cos(degToRad(camera.rotation.y))*vitesse*.1,velocity.x+=Math.sin(degToRad(camera.rotation.y))*vitesse*.1,velocity.z+=Math.sin(degToRad(camera.rotation.z))*vitesse*.1,speed=Math.hypot(velocity.x,velocity.y),frame>180&&(back.push({camera:{x:camera.x,y:camera.y,z:camera.z,rotation:{x:camera.rotation.x,y:camera.rotation.y,z:camera.rotation.z}},velocity:{x:velocity.x,y:velocity.y,z:velocity.z},velocityR:velocityR,speed:speed,rpm:rpm,vitesse:vitesse,gear:gear,timeLeft:timeLeft,currentSectionNumber:currentSectionNumber}),backP+=.001,backP>1&&(backP=1),back.length>200&&back.shift())}for(var r=0;r<rings.length;r++)rings[r].visible&&(r!=currentSectionNumber||backInProgress||Math.hypot(-rings[r].x-camera.x,-rings[r].y-camera.y)<.75&&(rings[r].visible=!1,back[back.length-1].hideRing=r,playSound([0,,.0201,,.3213,.4204,,.3154,,,,,,.5324,,.5125,,,1,,,,,.5]),timeLeft+=2));400>rpm&&(rpm+=100*Math.random()),sounds.engine.playbackRate.value=.5+Math.abs(rpm)/3e3,drawScene(),drawGUI(),requestAnimationFrame(tick),frame%Math.round(10*timeLeft)==0&&(sounds.heart.playbackRate.value=timeLeft>10?1:1+(10-timeLeft)/10)}function createGeometries(){[0,1].forEach(function(e){geometries[e]=createPlaneBufferGeometry(sols.length,4,sols.length,4),geometryGround=createPlaneBufferGeometry(sols.length,4,sols.length,4),geometryGround.shader=shaderRock,computeVertexNormals(geometryGround);for(var t=0;t<=sols.length;t++){id=t==sols.length?t-1:t,x=sols[id].x-128,y=512-sols[id].y,z=sols[id].z,yGround=sols[id].y-512,angle=sols[id].angle,length=sols[id].length,tunnel=sols[id].tunnel?.5:1,xWall=x+Math.cos(angle)*length*(0==e?-1:1),yWall=y-Math.sin(angle)*length*(0==e?-1:1);for(var a=0;5>a;a++)o=15*id+3*a,geometries[e].points.splice(o,3,xWall,yWall,geometries[e].points[o+2]+z),xOK=x+Math.cos(angle)*(length/2)*(a-2),yOK=yGround+Math.sin(angle)*(length/2)*(a-2),geometryGround.points.splice(o,3,xOK,-yOK,z),geometryGround.UV.splice(o/3*2,2,xOK,yOK),geometryGround.tunnel[o+0]=tunnel}computeVertexNormals(geometryGround),computeVertexNormals(geometries[e]);for(var t=0;t<=sols.length;t++)for(var a=1;5>a;a++){id=t==sols.length?t-1:t,seed=seeds[id][a],length=sols[id].length,tunnel=sols[id].tunnel?.5:1,normalX=geometries[e].vertexsNormals[15*id+3*a+0],normalY=geometries[e].vertexsNormals[15*id+3*a+1];var r=0;4==a?(seed=Math.max(Math.abs(seed),.1),seed*=-10,.99>tunnel&&(seed=1.2*length,j=2*(5*t+a),geometries[e].UV[j+1]*=length/2),r=-.25):seed=-Math.abs(seed)-.2,geometries[e].tunnel[15*id+0+0]=tunnel,geometries[e].tunnel[15*id+3*a+0]=tunnel,1==e&&(seed=-seed),geometries[e].points[15*id+3*a+0]+=seed*normalX,geometries[e].points[15*id+3*a+1]+=seed*normalY,geometries[e].points[15*id+3*a+2]+=r}if(computeVertexNormals(geometries[e]),geometries[e].shader=shaderRock,1==e){geometryFinish=createPlaneBufferGeometry(1,4,1,4,!0),w=sols.length-3;for(var a=0;5>a;a++)[0,1,2].forEach(function(e){geometryFinish.points[15+3*a+e]=geometries[0].points[15*w+3*(2==e?a:4)+e],geometryFinish.points[3*a+e]=geometries[1].points[15*w+3*(2==e?a:4)+e]});computeVertexNormals(geometryFinish)}var i=8,n=6;geometryRings=createPlaneBufferGeometry(i,n,i,n),geometryRings.shader=shaderRings;for(var t=0;i>=t;t++){angle=degToRad(360/i*t);for(var a=0;n>=a;a++)angle2=degToRad(360/n*a),f2=.05,f=.25+Math.sin(angle2)*f2,geometryRings.points.splice(3*t*(n+1)+3*a,3,Math.cos(angle)*f,-Math.cos(angle2)*f2,Math.sin(angle)*f)}computeVertexNormals(geometryRings)});for(var e=0;e<sections.length;e++){section=sections[e],altitude=altitudes[e],width=widths[e],positionStart=getQuadraticXY(0,section),sectionAngle=getQuadraticAngle(0,section),altitudeXY=getQuadraticXY(0,altitude);var t=getQuadraticXY(0,width);t=Math.max(1,t.x),checkpoints[e]={x:positionStart.x-128,y:512-positionStart.y,dx:-Math.sin(sectionAngle)*t,dy:-Math.cos(sectionAngle)*t,z:altitudeXY.x-128+3,a:-sectionAngle},checkpoints[e].geometry=createPlaneBufferGeometry(2*t,1,1,1,!0),computeVertexNormals(checkpoints[e].geometry),positionStart=getQuadraticXY(.5,section),altitudeXY=getQuadraticXY(.5,altitude),rings[e]={x:positionStart.x-128,y:512-positionStart.y,z:altitudeXY.x-128+1.35,visible:!0}}geometriesCalculated=!0}function drawScene(){mat4.perspective(fov,gl.viewportWidth/gl.viewportHeight,.001,150,pMatrix),mat4.identity(mvMatrix),geometriesCalculated||createGeometries(),lightsDisplayed=[];for(var e=0;e<sections.length;e++)c=checkpoints[e],r=rings[e],drawPlane(c.x+c.dx*sens,c.y+c.dy*sens,c.z,c.geometry,checkpoint,c.a+(sens>0?0:Math.PI)),r.visible&&Math.abs(currentSectionNumber-e)<3&&(lightsDisplayed.push(r.x,r.y,r.z),drawPlane(r.x,r.y,r.z,geometryRings,checkpoint));geometryRings.rotation.z+=.05,drawPlane(0,0,1,geometryFinish,finishLine),[0,1].forEach(function(e){drawPlane(0,0,1,geometries[e],sol)}),drawPlane(0,0,1,geometryGround,sol),d=(camera.rotation.y-90-angleBord)%360,0>d&&(d=360+d),sens=d>90&&270>d?-1:1}function drawPlane(e,t,a,r,i,n){var o=r.shader?r.shader:shaderProgram;gl.useProgram(o),gl.uniform3f(o.cameraPosition,e,t,a),e+=camera.x,t+=camera.y,a+=-1.2-camera.z,mat4.identity(mvMatrix),mat4.rotate(mvMatrix,degToRad(camera.rotation.z),[0,0,1]),mat4.rotate(mvMatrix,degToRad(camera.rotation.x),[1,0,0]),mat4.rotate(mvMatrix,degToRad(camera.rotation.y),[0,1,0]),mat4.rotate(mvMatrix,degToRad(-90),[1,0,0]),mat4.translate(mvMatrix,[e,t,a]),mat4.rotate(mvMatrix,n?n:0,[0,0,1]),mat4.rotate(mvMatrix,r.rotation.x,[1,0,0]),mat4.rotate(mvMatrix,r.rotation.y,[0,1,0]),mat4.rotate(mvMatrix,r.rotation.z,[0,0,1]),lightsDisplayed.length&&gl.uniform3fv(o.lights,lightsDisplayed),gl.uniform1i(o.nbLights,lightsDisplayed.length/3),gl.uniform1i(o.showShadows,1),gl.uniform1i(o.samplerUniform,0),gl.uniform1f(o.iTime,frame),setMatrixUniforms(o),vertexs=gl.createBuffer(),vertexs.itemSize=3,vertexs.numItems=r.points.length,gl.bindBuffer(gl.ARRAY_BUFFER,vertexs),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(r.points),gl.STATIC_DRAW),gl.vertexAttribPointer(o.vertexPositionAttribute,vertexs.itemSize,gl.FLOAT,!1,0,0),UV=gl.createBuffer(),UV.itemSize=2,UV.numItems=r.UV.length,gl.bindBuffer(gl.ARRAY_BUFFER,UV),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(r.UV),gl.STATIC_DRAW),gl.vertexAttribPointer(o.textureCoordAttribute,UV.itemSize,gl.FLOAT,!1,0,0),vertexs=gl.createBuffer(),vertexs.itemSize=3,vertexs.numItems=r.vertexsNormals.length,gl.bindBuffer(gl.ARRAY_BUFFER,vertexs),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(r.vertexsNormals),gl.STATIC_DRAW),gl.vertexAttribPointer(o.vertexsNormals,vertexs.itemSize,gl.FLOAT,!1,0,0),tunnel=gl.createBuffer(),tunnel.itemSize=3,tunnel.numItems=r.tunnel.length,gl.bindBuffer(gl.ARRAY_BUFFER,tunnel),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(r.tunnel),gl.STATIC_DRAW),gl.vertexAttribPointer(o.tunnel,tunnel.itemSize,gl.FLOAT,!1,0,0),planeVertexIndexBuffer=gl.createBuffer(),planeVertexIndexBuffer.itemSize=1,planeVertexIndexBuffer.numItems=r.indices.length/8,gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,planeVertexIndexBuffer),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(r.indices),gl.STATIC_DRAW),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,i),i==sol?(nbCheckpointToDisplay=3,sections.length-currentSectionNumber<=6&&(nbCheckpointToDisplay=sections.length-currentSectionNumber-2),gl.drawElements(gl.TRIANGLES,480*(nbCheckpointToDisplay+3),gl.UNSIGNED_SHORT,48*solsIndex[currentSectionNumber-3])):gl.drawElements(gl.TRIANGLES,r.indices.length,gl.UNSIGNED_SHORT,0)}function drawSky(){var e=shaderProgram;gl.useProgram(e),gl.uniform3f(e.cameraPosition,0,0,0),gl.uniform1i(e.nbLights,0),gl.uniform1i(e.showShadows,0),gl.uniform1i(e.samplerUniform,0),UVWBuffer||(UVWBuffer=gl.createBuffer(),UVWBuffer.itemSize=2,UVWBuffer.numItems=4,gl.bindBuffer(gl.ARRAY_BUFFER,UVWBuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([0,-1,1,-1,0,0,0,0]),gl.STATIC_DRAW)),gl.bindBuffer(gl.ARRAY_BUFFER,UVWBuffer),gl.vertexAttribPointer(e.textureCoordAttribute,UVWBuffer.itemSize,gl.FLOAT,!1,0,0),mat4.identity(mvMatrix),mat4.rotate(mvMatrix,degToRad(camera.rotation.z),[0,0,1]),mat4.translate(mvMatrix,[0,0,-6]),coordBuffer||(coordBuffer=gl.createBuffer(),coordBuffer.itemSize=3,coordBuffer.numItems=12,gl.bindBuffer(gl.ARRAY_BUFFER,coordBuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-6,-6,1,6,-6,1,6,6,1,-6,6,1]),gl.STATIC_DRAW)),gl.bindBuffer(gl.ARRAY_BUFFER,coordBuffer),gl.vertexAttribPointer(e.vertexPositionAttribute,coordBuffer.itemSize,gl.FLOAT,!1,0,0),setMatrixUniforms(e),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,cubeVertexIndexBuffer),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,sky),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}function drawGUI(){ctx.clearRect(0,0,self.innerWidth,self.innerHeight),ctx.beginPath(),ctx.arc(GUI.width-128,GUI.height-128,100,0,2*Math.PI,!1),ctx.strokeStyle="#FFF",ctx.fillStyle="gray",ctx.fill(),ctx.globalCompositeOperation="source-in",ctx.drawImage(canvasMap,Math.round(-minX+28-camera.x),Math.round(-minY+415+camera.y),200,200,GUI.width-228,GUI.height-228,200,200),ctx.globalCompositeOperation="source-over",ctx.beginPath(),ctx.arc(GUI.width-128,GUI.height-128,10,0,2*Math.PI,!1),ctx.strokeStyle="#FFF",ctx.fillStyle="black",ctx.fill();var e=self.innerWidth/4;if(1==backP&&(ctx.fillStyle="rgba(128,0,0, 1)"),ctx.fillRect(35,self.innerHeight-10-40,backP*e,20),ctx.beginPath(),ctx.lineWidth=1,ctx.strokeStyle="white",ctx.rect(35,self.innerHeight-50,e,20),ctx.stroke(),240>frame){colors=[60>frame?"black":"green",120>frame?"black":"green",180>frame?"black":"green"],60==frame||120==frame?playSound([0,,.0696,,.57,.35,,,,,,,,.0815,,,,,1,,,,,.5]):180==frame&&playSound([0,,.0696,,.63,.47,,,,,,,,.0815,,,,,1,,,,,.5]);for(var t=0;6>t;t++)ctx.beginPath(),ctx.arc(GUI.width/2+90*(t/3|0)-45,GUI.height/2+(t%3*90+(t%3==2?20:0))-120,40,0,2*Math.PI,!1),ctx.lineWidth=2,ctx.fillStyle=colors[t%3],ctx.fill(),ctx.stroke()}drawLed(self.innerWidth/2,self.innerHeight-64,Math.round(1e3*speed),0);var a=Math.round(timeLeft%Math.ceil(timeLeft/100)*100);100==a&&(a=0),10>a&&(a="0"+a),drawLed(self.innerWidth/2,self.innerHeight-164,(0|timeLeft)+" "+a,1>timeLeft?255:3>timeLeft?128:0)}var synth=new sy;self.jsfxr=function(e){self._audioContext=self._audioContext||new AudioContext;var t=self._audioContext;synth._p.set(e);var a=synth.totalReset(),r=a+1>>1<<1,i=t.createBuffer(1,r,t.sampleRate),n=i.getChannelData(0);return 2*synth.sW(n,a),i},self.playSound=function(e){jsfxr(e);var t=self._audioContext,a=t.createBufferSource(),r=t.createGain();return a.buffer=jsfxr(e),a.loop=!1,a.connect(r),r.connect(t.destination),a.start(t.currentTime),[a.buffer,t,a,r]},glMatrixArrayType="undefined"!=typeof Float32Array?Float32Array:"undefined"!=typeof WebGLFloatArray?WebGLFloatArray:Array;var mat3={};mat3.create=function(e){var t=new glMatrixArrayType(9);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9]),t},mat3.transpose=function(e,t){if(!t||e==t){var a=e[1],r=e[2],i=e[5];return e[1]=e[3],e[2]=e[6],e[3]=a,e[5]=e[7],e[6]=r,e[7]=i,e}return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],t};var mat4={};mat4.create=function(e){var t=new glMatrixArrayType(16);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t},mat4.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},mat4.toInverseMat3=function(e,t){var a=e[0],r=e[1],i=e[2],n=e[4],o=e[5],s=e[6],l=e[8],c=e[9],g=e[10],d=g*o-s*c,m=-g*n+s*l,u=c*n-o*l,h=a*d+r*m+i*u;return h?(h=1/h,t||(t=mat3.create()),t[0]=d*h,t[1]=(-g*r+i*c)*h,t[2]=(s*r-i*o)*h,t[3]=m*h,t[4]=(g*a-i*l)*h,t[5]=(-s*a+i*n)*h,t[6]=u*h,t[7]=(-c*a+r*l)*h,t[8]=(o*a-r*n)*h,t):null},mat4.translate=function(e,t,a){var r=t[0],i=t[1];if(t=t[2],!a||e==a)return e[12]=e[0]*r+e[4]*i+e[8]*t+e[12],e[13]=e[1]*r+e[5]*i+e[9]*t+e[13],e[14]=e[2]*r+e[6]*i+e[10]*t+e[14],e[15]=e[3]*r+e[7]*i+e[11]*t+e[15],e;var n=e[0],o=e[1],s=e[2],l=e[3],c=e[4],g=e[5],d=e[6],m=e[7],u=e[8],h=e[9],f=e[10],v=e[11];return a[0]=n,a[1]=o,a[2]=s,a[3]=l,a[4]=c,a[5]=g,a[6]=d,a[7]=m,a[8]=u,a[9]=h,a[10]=f,a[11]=v,a[12]=n*r+c*i+u*t+e[12],a[13]=o*r+g*i+h*t+e[13],a[14]=s*r+d*i+f*t+e[14],a[15]=l*r+m*i+v*t+e[15],a},mat4.rotate=function(e,t,a,r){var i=a[0],n=a[1];a=a[2];var o=Math.sqrt(i*i+n*n+a*a);if(!o)return null;1!=o&&(i*=o=1/o,n*=o,a*=o);var s=Math.sin(t),l=Math.cos(t),c=1-l;t=e[0],o=e[1];var g=e[2],d=e[3],m=e[4],u=e[5],h=e[6],f=e[7],v=e[8],x=e[9],y=e[10],p=e[11],b=i*i*c+l,R=n*i*c+a*s,M=a*i*c-n*s,P=i*n*c-a*s,A=n*n*c+l,S=a*n*c+i*s,T=i*a*c+n*s;return i=n*a*c-i*s,n=a*a*c+l,r?e!=r&&(r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=t*b+m*R+v*M,r[1]=o*b+u*R+x*M,r[2]=g*b+h*R+y*M,r[3]=d*b+f*R+p*M,r[4]=t*P+m*A+v*S,r[5]=o*P+u*A+x*S,r[6]=g*P+h*A+y*S,r[7]=d*P+f*A+p*S,r[8]=t*T+m*i+v*n,r[9]=o*T+u*i+x*n,r[10]=g*T+h*i+y*n,r[11]=d*T+f*i+p*n,r},mat4.frustum=function(e,t,a,r,i,n,o){o||(o=mat4.create());var s=t-e,l=r-a,c=n-i;return o[0]=2*i/s,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2*i/l,o[6]=0,o[7]=0,o[8]=(t+e)/s,o[9]=(r+a)/l,o[10]=-(n+i)/c,o[11]=-1,o[12]=0,o[13]=0,o[14]=-n*i*2/c,o[15]=0,o},mat4.perspective=function(e,t,a,r,i){return e=a*Math.tan(e*Math.PI/360),t*=e,mat4.frustum(-t,t,-e,e,a,r,i)},mvMatrix=mat4.create(),pMatrix=mat4.create(),createPlaneBufferGeometry=function(e,t,a,r,i){var n=[],o=[],s=[],l=[];for(x=0;e>=x;x+=e/a)for(y=0;t>=y;y+=t/r)n.push(0,x,y),l.push(0,0,0),u=i?x/e:x,v=i?y/t:y,o.push(-u,-v);first=-1;for(var c=0;a*r>c;c++)c%r==0&&first++,s.push(first,first+r+1,first+r+2),s.push(first,first+r+2,first+1),first++;return{points:n,UV:o,indices:s,tunnel:l,rotation:{x:0,y:0,z:0}}},computeVertexNormals=function(e){function t(e,t,a){this.x=e||0,this.y=t||0,this.z=a||0}Object.assign(t.prototype,{subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},cross:function(e){a=this;var t=a.x,r=a.y,i=a.z,n=e.x,o=e.y,s=e.z;return this.x=r*s-i*o,this.y=i*n-t*s,this.z=t*o-r*n,this},add:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},normalize:function(){var e=1/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return this.x*=e,this.y*=e,this.z*=e,this}});var r=e.indices,i=e.points,n=new Array(i.length/3);for(v=0;v<i.length/3;v++)n[v]=new t;for(var o=new t,s=new t,l=0;l<r.length;l+=3){var c=r[l],g=r[l+1],d=r[l+2];vA=new t(i[3*c],i[3*c+1],i[3*c+2]),vB=new t(i[3*g],i[3*g+1],i[3*g+2]),vC=new t(i[3*d],i[3*d+1],i[3*d+2]),o.subVectors(vC,vB),s.subVectors(vA,vB),o.cross(s),n[c].add(o),n[g].add(o),n[d].add(o)}e.vertexsNormals=[];for(var m=0;m<n.length;m++)n[m].normalize(),e.vertexsNormals.push(n[m].x),e.vertexsNormals.push(n[m].y),e.vertexsNormals.push(n[m].z)},Random.prototype.next=function(){return this._seed=16807*this._seed%2147483647},Random.prototype.nextFloat=function(){return(this.next()-1)/2147483646},document.onkeydown=function(e){switch(e.keyCode){case 90:case 87:case 38:moveF=!0;break;case 81:case 37:moveL=!0;break;case 40:case 83:case 65:moveB=!0;break;case 68:case 39:moveR=!0}},document.onkeyup=function(e){switch(e.keyCode){case 90:case 87:case 38:moveF=!1;break;case 81:case 37:GameStarted||nextLevel(-1),moveL=!1;break;case 40:case 83:case 65:moveB=!1;break;case 68:case 39:GameStarted||nextLevel(1),moveR=!1;break;case 32:GameEnded?showEnterGame():GameStarted?1==backP&&(backInProgress=!0):goLevel()}},frame=0,moveF=moveB=moveL=moveR=!1,fov=45,velocityR=0,speed=0,sounds=[],levelHome=0,chiffres=[],initSound=function(e,t,r){tmp=playSound(t),tmp[2].stop(),sounds[e]=tmp[1].createBufferSource(),sounds[e]._dest=tmp[3],sounds[e]._connected=!1,sounds[e]._play=function(){this._connected||(this.connect(this._dest),this._connected=!0)},sounds[e]._stop=function(){this._connected&&(this.disconnect(),this._connected=!1)},"heart"==e?(a=tmp[1].createBuffer(1,30*tmp[0].length,tmp[0].sampleRate),d=tmp[0].getChannelData(0),a.copyToChannel(d,0,0),a.copyToChannel(d,0,15e3),sounds[e].buffer=a):sounds[e].buffer=tmp[0],sounds[e].loop=!0,sounds[e].loopStart=r,sounds[e].loopEnd=1,sounds[e].start()},maps=[["TRACK 1 - EASY",1,3,40],["TRACK 2 - EASY",18,6,40],["TRACK 3 - MEDIUM",56,7,35],["TRACK 4 - MEDIUM",64,8,30],["TRACK 5 - HARD",13,2,40],["TRACK 6 - EVIL",15,6,35]],levelInit=!1,showEnterGame=function(){if(GameEnded=!1,race.style.display="none",home.appendChild(sky._img),sky._img.style.width="100%",sky._img.style.height="100%",!levelInit){for(var e=0;e<maps.length;e++){generateLevel(maps[e][1],maps[e][2]);var t=new Image;t.src=canvasMap.toDataURL(),li=document.createElement("LI"),li.appendChild(t),levels.appendChild(li)}nextLevel(0),levelInit=!0}home2.style.display="block",home.style.display="block",end.style.display="none"},endGame=function(e){playSound([3,,.2624,.5001,.96,.0806,,-.092,,,,-.4,.7741,,,,-.28,-.1419,1,,,,,.57]),GameStarted=!1,GameEnded=!0,sounds.heart._stop(),sounds.brake._stop(),race.style.display="none",document.querySelector("#end h4").innerHTML=e?"YOU LOSE, LAST CHECKPOINT : "+currentSectionNumber:"CONGRATULATIONS !",home.style.display="block",end.style.display="block"},nextLevel=function(e){levelHome+=e,0>levelHome&&(levelHome=maps.length-1),levelHome%=maps.length,levels.style.marginLeft=25+50*-levelHome+"%",document.querySelectorAll("#levels li").forEach(function(e,t){e.style.opacity=t==levelHome?1:.2}),document.querySelector("h3").innerHTML=maps[levelHome][0]},goLevel=function(){generateLevel(maps[levelHome][1],maps[levelHome][2]),race.style.display="block",home.style.display=home2.style.display=end.style.display="none",resize(),sounds.engine._dest.gain.value=sounds.engine.playbackRate.value=sounds.heart.playbackRate.value=1,sounds.engine._play(),sounds.heart._play(),initValues(),timeLeft=maps[levelHome][3],GameStarted=!0},initValues=function(){velocity={x:0,y:0,z:0},camera={rotation:{x:0,y:0,z:0},x:0,y:-65,z:0},vitesse=gear=rpm=currentSectionNumber=backP=frame=0,debrayage=GameStarted=geometriesCalculated=GameEnded=backInProgress=!1,back=[]},initValues(),getShortestStartFrom=function(e,t,a,r,i,n){section=sections[currentSectionNumber];for(var o=0;1e3>=o;o++)if(positionPoint=getQuadraticXY(t+o*a/1e3,section),distancePoint=Math.hypot(positionPoint.x-e.x,positionPoint.y-e.y),r>distancePoint)r=distancePoint,i=t+o*a/1e3;else if(distancePoint>r)break;if(1==i)return currentSectionNumber++,currentSectionNumber==sections.length&&(currentSectionNumber=0),getShortestStartFrom(e,t,a,9999999,0,!0);if(0==i&&!n){if(currentSectionNumber--,-1!=currentSectionNumber)return getShortestStartFrom(e,t,a,9999999,0);currentSectionNumber=0}altitude=altitudes[currentSectionNumber],width=widths[currentSectionNumber],altitudeAngle=getQuadraticAngle(i,altitude),altitudeXY=getQuadraticXY(i,altitude);var s=getQuadraticXY(i,width);return s=Math.max(1,s.x),[i,r,altitudeXY.x,altitudeAngle,s]},gears=[.0012,5e-4,25e-5,17e-5,12e-5,1e-4,4e-5];var geometryGround,geometryRings,checkpoints=[],rings=[],sens=1,coordBuffer,UVWBuffer;drawLed=function(e,t,a,r){var i=a.toString();e-=16*i.length;for(var n=0;n<i.length;n++)ctx.putImageData(chiffres[r+i[n]],e+32*n,t)},copyImageData=function(e,t,a,r){for(var i=0;i<e.width;i++)for(var n=0;n<e.height;n++){var o=4*n*e.width+4*i;0!=e.data[o+3]&&setPixel(t+i,a+n,e.data[o],e.data[o+1],e.data[o+2],r)}},setPixel=function(e,t,a,r,i,n){var o=4*Math.round(t)*n.width+4*Math.round(e);n.data[o]=a,n.data[o+1]=r,n.data[o+2]=i,n.data[o+3]=255};var lights=new Float32Array([]);geometries=[],coordsMap=[],sols=[];var path=[];seeds=[];var sections=[],pathCoords=[];initLevel=function(e,t){var a=128,r=450;XPrevPoint=a,YPrevPoint=r;var n=0,o=512;XPrevPointWidth=n,YPrevPointWidth=o;var s=0;for(minX=minY=1/0,maxX=maxY=-1/0,i=0;i<e.length-1;i++){pathCoords[i]=[],a=e[i][0],r=e[i][1],n=t[i][0],o=t[i][1],id=i==e.length-1?0:i+1,XNextPoint=e[id][0],YNextPoint=e[id][1],XNextPointWidth=t[id][0],YNextPointWidth=t[id][1];var l=(a+XNextPoint)/2,c=(r+YNextPoint)/2,g=(n+XNextPointWidth)/2,d=(o+YNextPointWidth)/2;t[i]=[XPrevPointWidth,o,n,o,g,d];for(var m=0;1>=m;m+=.005){deb=getQuadraticXY(m,[XPrevPoint,YPrevPoint,a,r,l,c]),deb.angle=getQuadraticAngle(m,[XPrevPoint,YPrevPoint,a,r,l,c]);var u=getQuadraticXY(m,[XPrevPointWidth,YPrevPointWidth,n,o,g,d]);deb.length=Math.max(1,u.x),deb.sectionNumber=i,deb.percent=m,coordsMap.push(deb),pathCoords[i].push(deb),s++,deb.x<minX&&(minX=deb.x),deb.y<minY&&(minY=deb.y),deb.x>maxX&&(maxX=deb.x),deb.y>maxY&&(maxY=deb.y)}section=[XPrevPoint,YPrevPoint,a,r,l,c],section.push(getQuadraticLength(XPrevPoint,YPrevPoint,a,r,l,c)),sections.push(section),XPrevPoint=l,YPrevPoint=c,XPrevPointWidth=g,YPrevPointWidth=d}minX-=100,minY-=100},generateLevel=function(e,t){sections=[],sols=[],solsIndex=[];var r=new Random(e);coordsMap=[],decals=[[0,1]],oldA=Math.PI/4;for(var i=0;32>i;i++)oldA+=.174*r.nextFloat()-.0872,v=2+6*r.nextFloat(),x=Math.cos(oldA)*v,y=Math.sin(oldA)*v,a=radToDeg(Math.atan2(x,y)),Math.hypot(x,y)<2||Math.abs(a-oldA)>90?i--:(decals.push([x,y]),oldA=a);for(var n=new Array(decals.length),o=128,s=450,i=0;i<decals.length;i++)n[i]=[o,s],o+=10*decals[i][0],s-=10*decals[i][1];n[i]=[o,s],widths=[];for(var l=new Random(t),i=0;i<=decals.length;i++)s=512-512/decals.length*i,o=10*l.nextFloat()-2,widths.push([o,s]);initLevel(n,widths),altitudes=[];var c=new Random(t);s=450;for(var i=0;i<sections.length;i++)s-=sections[i][6],o=128+(c.nextFloat()-.5)*(sections[i][6]/5),altitudes.push([o,s]);var o=128,s=450;XPrevPoint=o,YPrevPoint=s,sols=[];var g=0,d=0;for(i=0;i<altitudes.length-1;i++){o=altitudes[i][0],s=altitudes[i][1],XNextPoint=altitudes[i+1][0],YNextPoint=altitudes[i+1][1];
var m=(o+XNextPoint)/2,u=(s+YNextPoint)/2;altitudes[i]=[XPrevPoint,YPrevPoint,o,s,m,u];for(var h=0,f=0;f<coordsMap.length/altitudes.length&&(h+=1/(coordsMap.length/altitudes.length),deb=getQuadraticXY(h,[XPrevPoint,YPrevPoint,o,s,m,u]),coordsMap[g]);f++)coordsMap[g].z=deb.x-128,x=coordsMap[g].x,y=coordsMap[g].y,z=coordsMap[g].z,angle=coordsMap[g].angle+Math.PI/2,length=coordsMap[g].length,g%10==0&&(c.nextFloat()>.99&&(d=1-d),sols.push({x:x,y:y,z:z,angle:angle,length:length,sectionNumber:coordsMap[i].sectionNumber,percent:coordsMap[i].percent,tunnel:d})),g++;solsIndex[i]=sols.length,XPrevPoint=m,YPrevPoint=u}height=[],canvasMap.width=maxX-minX+100,canvasMap.height=maxY-minY+100,ctxMap=canvasMap.getContext("2d"),ctxMap.fillStyle="white",ctxMap.fillRect(0,0,canvasMap.width,canvasMap.height),imageDataMap=ctxMap.getImageData(0,0,canvasMap.width,canvasMap.height);for(var i=2;i<coordsMap.length-1;i++){x=coordsMap[i].x,y=coordsMap[i].y,z=coordsMap[i].z,angle=coordsMap[i].angle+Math.PI/2,length=coordsMap[i].length;for(var v=1;length+1>=v;v+=.1)v+.1>=length?(setPixel(-minX+x+Math.cos(angle)*v,-minY+y+Math.sin(angle)*v,40,60,70,imageDataMap),setPixel(-minX+x-Math.cos(angle)*v,-minY+y-Math.sin(angle)*v,40,60,70,imageDataMap)):(setPixel(-minX+x+Math.cos(angle)*v,-minY+y+Math.sin(angle)*v,109,208,242,imageDataMap),setPixel(-minX+x-Math.cos(angle)*v,-minY+y-Math.sin(angle)*v,109,208,242,imageDataMap))}ctxMap.putImageData(imageDataMap,0,0),ctxMap.filter="blur(1px)",ctxMap.drawImage(canvasMap,0,0),sols.push({x:x,y:y,angle:angle,length:length,z:z/100}),vitesseDelta=0;for(var i=0;i<sols.length;i++){vitesseDelta+=(Math.random()-.5)/5,seeds[i]=[],-.5>vitesseDelta&&(vitesseDelta=-.45);for(var f=0;5>f;f++)seeds[i][f]=Math.random()/2-.25}};</script></html>