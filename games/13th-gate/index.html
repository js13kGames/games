<!doctype html><meta name=viewport content="width=device-width"><title>13th gate</title><style>body{background:#002b36;margin:0;padding:0;overflow:hidden;color:#e6e6fa;font-family:sans-serif;font-variant:small-caps}body>div{background:#002b36;position:absolute;top:0;width:100vw;height:100vh;display:grid;opacity:0;pointer-events:none;grid-template:30% 40% 20% 1fr/1fr 50% 1fr;grid-template-areas:"l t r" ". c ." " . b ." ". h .";transition:1s}canvas{transition:1s}#splash{background:0 0}#splash button{border-color:tomato;color:tomato}#win{background:#990}#intro>div{grid-area:c;text-align:center;font-size:5vb}#intro>div>div{opacity:0;transition:opacity 1s ease-in-out}#intro.active>div>div:first-child{opacity:1;transition-delay:0.5s}#intro.active>div>div:nth-child(2){opacity:1;transition-delay:2s}#intro.active>div>div:nth-child(3){opacity:1;transition-delay:5s}#intro.active>div>div:nth-child(4){opacity:1;transition-delay:6.5s}#win>div{grid-area:c;font-size:5vw;text-align:center}.active{opacity:1;pointer-events:auto}button{background:0 0;border:2px solid #e6e6fa;font-size:15vb;color:#e6e6fa;border-radius:5px;grid-area:b;font-weight:100}button:hover{border-color:#ff0!important}button[disabled]{color:#a9a9a9;border-color:#9a9a9a}#t{grid-area:t;display:flex;justify-content:center;align-items:center;font-size:5vw}strong{color:tomato}#ls{grid-area:c;display:flex;justify-content:space-around;text-align:center}#ls button{display:block;margin-bottom:5px}#dif{grid-area:b;display:flex;justify-content:space-around;align-items:center}label{border:2px solid #e6e6fa;font-size:1.5vw;width:10vw;height:8vh;display:grid;place-items:center}label:has(> :checked){border-color:#ff0}input{display:none}#h{grid-area:h;text-align:center;line-height:1.5}kbd{padding:0 5px;background:rgba(0,0,0,.2)}#hud{background:0 0}#hud div{display:grid;place-items:center;border-bottom:2px solid;width:50%;height:50%;font-size:2vw}#hscore{grid-area:l;transform:rotate(-15deg)}#hboosts{grid-area:r;justify-self:end;color:#ff0;transform:rotate(15deg)}#defeat{background:#993b2b}#defeat>div{grid-area:c;font-size:10vw;text-align:center}#debug{position:fixed;z-index:1000;right:50px;bottom:50px;background:#000}#debug *{display:block}</style><script type=module>var ct="#version 300 es\nprecision highp float;in vec4 pos,col,uv,normal;uniform mat4 pv,eye,m,im;uniform vec4 bb;out vec4 v_pos,v_col,v_uv,v_normal;void main(){gl_Position=pv*(v_pos=bb.z>0.? m[3]+eye*(pos*bb): m*pos);v_col=col;v_uv=uv;v_normal=transpose(inverse(m))*normal;}",lt="#version 300 es\nprecision highp float;in vec4 v_pos,v_col,v_uv,v_normal;uniform vec3 light;uniform vec4 o;uniform sampler2D sampler;out vec4 c;void main(){c=mix(texture(sampler,v_uv.xy),v_col,o[3]);if(o[1]>0.){if(o[0]>0.){c=vec4(c.rgb*(max(dot(light,-normalize(vec3(v_normal.xyz))),0.0)+o[2]),c.a);}else{c=vec4(c.rgb*(max(dot(light,-normalize(cross(dFdx(v_pos.xyz),dFdy(v_pos.xyz)))),0.0)+o[2]),c.a);}}}";class Q{#t=!1;current={};#i={};#e={};#r=0;#s="#000000";#o={};constructor(t){this.#t=t.debug,this.canvas=t.canvas,this.#s=t.clearColor||this.#s,this.gl=this.canvas.getContext("webgl2"),this.gl.blendFunc(770,771),this.gl.activeTexture(33984),this.#n(),this.gl.useProgram(this.program),this.#t&&console.log("program:",this.gl.getProgramInfoLog(this.program)||"OK"),this.gl.clearColor(...this.col(this.#s)),this.gl.enable(2929),this.light(t.light||{y:-1}),this.camera(t.camera||{fov:30}),this.ambient(t.ambient||.2);for(let i in t.geometry)this.#o[i]=t.geometry[i],this.#o[i].normals&&(this.#o[i].customNormals=1)}#a(t,i){const e=this.gl.createShader(t);return this.gl.shaderSource(e,i),this.gl.compileShader(e),this.#t&&console.log("shader:",this.gl.getShaderInfoLog(e)||"OK"),e}#n(){this.program=this.gl.createProgram(),this.gl.attachShader(this.program,this.#a(35633,ct)),this.gl.attachShader(this.program,this.#a(35632,lt)),this.gl.linkProgram(this.program)}#h(t,i,e){t.id||="o"+this.#r++,t.size&&(t.w=t.h=t.d=t.size),t.t&&t.t.width&&!this.#e[t.t.id]&&(e=this.gl.createTexture(),this.gl.pixelStorei(37441,!0),this.gl.bindTexture(3553,e),this.gl.pixelStorei(37440,1),this.gl.texImage2D(3553,0,6408,6408,5121,t.t),this.gl.generateMipmap(3553),this.#e[t.t.id]=e),t.fov&&(this.projection=new DOMMatrix([1/Math.tan(t.fov*Math.PI/180)/(this.canvas.width/this.canvas.height),0,0,0,0,1/Math.tan(t.fov*Math.PI/180),0,0,0,0,-1001/999,-1,0,0,-2002/999,0])),t={type:i,...this.current[t.id]=this.#i[t.id]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888",o:1,mode:4,mix:0},...t,f:0};const r=this.#o[t.type];r&&(r.vertices&&!r.verticesBuffer&&(this.gl.bindBuffer(34962,r.verticesBuffer=this.gl.createBuffer()),this.gl.bufferData(34962,new Float32Array(r.vertices),35044),r.normals&&(this.gl.bindBuffer(34962,r.normalsBuffer=this.gl.createBuffer()),this.gl.bufferData(34962,new Float32Array(r.normals.flat()),35044))),r.uv&&!r.uvBuffer&&(this.gl.bindBuffer(34962,r.uvBuffer=this.gl.createBuffer()),this.gl.bufferData(34962,new Float32Array(r.uv),35044)),r.indices&&!r.indicesBuffer&&(this.gl.bindBuffer(34963,r.indicesBuffer=this.gl.createBuffer()),this.gl.bufferData(34963,new Uint16Array(r.indices),35044))),t.t?t.t&&!t.mix&&(t.mix=0):t.mix=1,this.#i[t.id]=t}draw(t){this.#i.camera?.g&&this.#l(this.#i[this.#i.camera.g],t,1);const i=this.#c("camera");this.#i?.camera?.g&&i.preMultiplySelf(this.#i[this.#i.camera.g].M||this.#i[this.#i.camera.g].m),this.gl.uniformMatrix4fv(this.gl.getUniformLocation(this.program,"eye"),!1,i.toFloat32Array()),i.invertSelf(),i.preMultiplySelf(this.projection),this.gl.uniformMatrix4fv(this.gl.getUniformLocation(this.program,"pv"),!1,i.toFloat32Array()),this.gl.clear(16640);const e=[];for(let i in this.#i)this.#i[i].t||1!==this.col(this.#i[i].b,this.#i[i].o)[3]?e.push(this.#i[i]):this.#l(this.#i[i],t);e.sort(((t,i)=>this.#d(i)-this.#d(t))),this.gl.enable(3042);for(let i of e)["plane","billboard"].includes(i.type)&&this.gl.depthMask(0),this.#l(i,t),this.gl.depthMask(1);this.gl.disable(3042),this.gl.uniform3f(this.gl.getUniformLocation(this.program,"light"),this.#m("light","x"),this.#m("light","y"),this.#m("light","z"))}#l(t,i){if(t.t&&(this.gl.bindTexture(3553,this.#e[t.t.id]),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"sampler"),0)),t.f<t.a&&(t.f+=i),t.f>t.a&&(t.f=t.a),this.#i[t.id].m=this.#c(t.id),this.#i[t.g]&&this.#i[t.id].m.preMultiplySelf(this.#i[t.g].M||this.#i[t.g].m),this.gl.uniformMatrix4fv(this.gl.getUniformLocation(this.program,"m"),!1,(this.#i[t.id].M||this.#i[t.id].m).toFloat32Array()),this.gl.uniformMatrix4fv(this.gl.getUniformLocation(this.program,"im"),!1,new DOMMatrix(this.#i[t.id].M||this.#i[t.id].m).invertSelf().toFloat32Array()),["camera","light","group"].includes(t.type))return;let e;this.gl.bindBuffer(34962,this.#o[t.type].verticesBuffer),this.gl.vertexAttribPointer(e=this.gl.getAttribLocation(this.program,"pos"),3,5126,!1,0,0),this.gl.enableVertexAttribArray(e),this.#o[t.type].uvBuffer&&(this.gl.bindBuffer(34962,this.#o[t.type].uvBuffer),this.gl.vertexAttribPointer(e=this.gl.getAttribLocation(this.program,"uv"),2,5126,!1,0,0),this.gl.enableVertexAttribArray(e)),(t.s||this.#o[t.type].customNormals)&&this.#o[t.type].normalsBuffer&&(this.gl.bindBuffer(34962,this.#o[t.type].normalsBuffer),this.gl.vertexAttribPointer(e=this.gl.getAttribLocation(this.program,"normal"),3,5126,!1,0,0),this.gl.enableVertexAttribArray(e)),this.gl.uniform4f(this.gl.getUniformLocation(this.program,"o"),t.s,(t.mode>3||this.gl[t.mode]>3)&&!t.ns?1:0,this.ambientLight||.2,t.mix),this.gl.uniform4f(this.gl.getUniformLocation(this.program,"bb"),t.w,t.h,"billboard"===t.type?1:0,0),this.#o[t.type].indicesBuffer&&this.gl.bindBuffer(34963,this.#o[t.type].indicesBuffer),this.gl.vertexAttrib4fv(this.gl.getAttribLocation(this.program,"col"),this.col(t.b,t.o)),this.#o[t.type].indicesBuffer?this.gl.drawElements(+t.mode||this.gl[t.mode],this.#o[t.type].indices.length,5123,0):this.gl.drawArrays(+t.mode||this.gl[t.mode],0,this.#o[t.type].vertices.length/3)}#m=(t,i)=>this.#i[t]?.a?this.current[t][i]+(this.#i[t][i]-this.current[t][i])*(this.#i[t].f/this.#i[t].a):this.#i[t][i];#c=(t,i=new DOMMatrix)=>this.#i[t]?i.translateSelf(this.#m(t,"x"),this.#m(t,"y"),this.#m(t,"z")).rotateSelf(this.#m(t,"rx"),this.#m(t,"ry"),this.#m(t,"rz")).scaleSelf(this.#m(t,"w"),this.#m(t,"h"),this.#m(t,"d")):i;#d=(t,i=this.#i.camera)=>t?.m&&i?.m?(i.m.m41-t.m.m41)**2+(i.m.m42-t.m.m42)**2+(i.m.m43-t.m.m43)**2:0;ambient=t=>this.ambientLight=t;col=(t,i=1)=>[...t.replace("#","").match(t.length<5?/./g:/../g).map((i=>("0x"+i)/(t.length<5?15:255))),i];add(t,i){this.#h(i,t)}group(t){this.#h(t,"group")}move(t,i){i?setTimeout((()=>{this.#h(t)}),i):this.#h(t)}delete(t,i){setTimeout((()=>{"group"===this.#i[t].type&&Object.keys(this.#i).filter((i=>this.#i[i].g===t)).forEach((t=>this.delete(t))),delete this.#i[t]}),i||1)}camera(t,i){i?setTimeout((()=>{this.#h(t,t.id="camera")}),i):this.#h(t,t.id="camera")}light(t,i){i?setTimeout((()=>{this.#h(t,t.id="light")}),i):this.#h(t,t.id="light")}}const dt={vertices:[.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]},ft={vertices:[.5,.5,0,-.5,.5,0,-.5,-.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0],uv:[1,1,0,1,0,0,1,1,0,0,1,0]},ut={vertices:[-.5,-.5,.5,.5,-.5,.5,0,.5,0,.5,-.5,.5,.5,-.5,-.5,0,.5,0,.5,-.5,-.5,-.5,-.5,-.5,0,.5,0,-.5,-.5,-.5,-.5,-.5,.5,0,.5,0,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,1,1,0,1,0,0,1,1,0,0,1,0]},mt=((t,i,e,r,s,o,n=[],a=[],h=[],l=15)=>{for(e=0;e<=l;e++)for(r=e*Math.PI/l,t=0;t<=l;t++)i=2*t*Math.PI/l,n.push(+(Math.sin(i)*Math.sin(r)/2).toFixed(6),+(Math.cos(r)/2).toFixed(6),+(Math.cos(i)*Math.sin(r)/2).toFixed(6)),h.push(3.5*Math.sin(t/l),-Math.sin(e/l)),t<l&&e<l&&(o=(s=e*(l+1)+t)+(l+1),a.push(s,o,s+1,s+1,o,o+1));return{vertices:n,uv:h,indices:a}})();function C(t,i,e=1,r=0,s=0){const o=document.createElement("canvas"),n=300;o.width=o.height=n,o.id=self.crypto.randomUUID();const a=o.getContext("2d"),h=a.createLinearGradient(0,0,e?0:n,e&&n);return r?(h.addColorStop(0,t),h.addColorStop(.5-r/2,t),h.addColorStop(.5-r/2,i),h.addColorStop(.5+r/2,i),h.addColorStop(.5+r/2,t),h.addColorStop(1,t)):(h.addColorStop(0,t),h.addColorStop(1,i)),a.fillStyle=h,a.fillRect(0,0,n,n),s&&(document.body.appendChild(o),o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.zIndex=100),o}const gt=(t,i,e)=>Math.min(Math.max(t,i),e);let pt=0;const X=t=>t[0]+pt++,H=()=>JSON.parse(localStorage.getItem(j)||'""')||{score:[]},Y=t=>{localStorage.setItem(j,JSON.stringify(t))},yt=(t,i,e)=>(1-e)*t+e*i;function vt(t,i){for(let e=t.length-1;e>=0;e--){const r=Math.floor(i.f(1)*(e+1));[t[e],t[r]]=[t[r],t[e]]}}const W=t=>Math.sqrt(1-Math.pow(t-1,2));function z(t){function i(){let i=(t=(t|=0)+2654435769|0)^t>>>16;return i=Math.imul(i,569420461),i^=i>>>15,i=Math.imul(i,1935289751),((i^=i>>>15)>>>0)/4294967296}return{n:t=>Math.floor(i()*(t+1)),n1:t=>Math.floor(i()*(t+1)+1),f:t=>i()*t,r:(t,e)=>Math.floor(i()*(e-t+1))+t}}const U={body:{vertices:[2.6,.58,10,2.9,.55,10,2.9,.76,10,2.6,.72,10,2.03,1.3,0,0,.87,0,2.03,0,0,0,.44,0,2.9,.55,10,2.6,.58,10,3.5,.58,10,6.1,.44,0,6.1,.87,0,3.5,.72,10,0,.44,0,0,.87,0,4.07,1.3,0,6.1,.87,0,6.1,.44,0,4.07,0,0,3.2,.55,10,3.5,.58,10,3.2,.76,10,3.2,.55,10].map((t=>t/10)),uv:[.38,0,.46,0,.46,.25,.38,.25,.46,.5,.38,.5,.46,.75,.38,.75,.46,1,.38,1,.63,0,.88,0,.88,.25,.63,.25,.13,0,.13,.25,.54,.5,.63,.5,.63,.75,.54,.75,.54,1,.63,1,.54,.25,.54,0],indices:[0,1,2,0,2,3,3,2,4,3,4,5,5,4,6,5,6,7,7,6,8,7,8,9,10,11,12,10,12,13,14,0,3,14,3,15,16,17,18,16,18,19,20,19,18,20,18,21,22,23,10,22,10,13,16,22,13,16,13,17,4,16,19,4,19,6,2,1,23,2,23,22,8,6,19,8,19,20,4,2,22,4,22,16]},fin:{vertices:[3.08,1.2,7.02,.48,4.84,1.42,.12,4.84,1.44,2.45,1.2,7.02,.35,4.84,0,0,4.84,.02,2.53,1.84,1.47,1.6,1.84,1.47,3.08,1.2,7.02,2.45,1.2,7.02,0,4.84,.02,1.6,1.84,1.47,2.53,1.84,1.47,.35,4.84,0,4.18,.3,9.9,3.31,1.32,8.25,2.29,1.11,8.32,2.74,0,10,2.43,2.13,.92,1.42,1.92,.99,3.32,.77,1.79,1.88,.47,1.89,1.42,1.92,.99,1.88,.47,1.89,3.32,.77,1.79,2.43,2.13,.92].map((t=>t/10)),uv:[.38,0,.38,.25,.63,.25,.63,0,.38,.5,.63,.5,.38,.75,.63,.75,.38,1,.63,1,.88,.25,.88,0,.13,0,.13,.25,.38,0,.38,.25,.63,.25,.63,0,.38,.5,.63,.5,.38,.75,.63,.75,.88,.25,.88,0,.13,0,.13,.25],indices:[0,1,2,0,2,3,1,4,5,1,5,2,4,6,7,4,7,5,6,8,9,6,9,7,3,2,10,3,10,11,12,13,1,12,1,0,14,15,16,14,16,17,15,18,19,15,19,16,18,20,21,18,21,19,17,16,22,17,22,23,24,25,15,24,15,14]},wing:{vertices:[7.73,.1,10,7.73,.46,10,5.37,.43,7.35,5.37,.14,7.35,5.33,.57,.85,3.55,.5,.56,5.33,0,.85,3.55,.07,.56,7.73,.1,10,5.37,.14,7.35,.65,.21,2.05,.65,.36,2.05,0,.36,0,0,.21,0,1.78,.43,.28,1.78,.14,.28,0,.21,0,0,.36,0,3.01,.17,4.7,.65,.21,2.05,3.01,.39,4.7,3.01,.17,4.7].map((t=>t/10)),uv:[.38,0,.38,.25,.46,.25,.46,0,.38,.5,.46,.5,.38,.75,.46,.75,.38,1,.46,1,.63,0,.63,.25,.88,.25,.88,0,.54,.5,.54,.75,.63,.75,.63,.5,.54,1,.63,1,.54,.25,.54,0],indices:[0,1,2,0,2,3,1,4,5,1,5,2,4,6,7,4,7,5,6,8,9,6,9,7,10,11,12,10,12,13,14,15,16,14,16,17,18,19,16,18,16,15,20,11,10,20,10,21,14,17,11,14,11,20,5,7,15,5,15,14,9,18,15,9,15,7,2,20,21,2,21,3,5,14,20,5,20,2]}},j="js13k13gate8bdb3b08a930",xt=5,Ft=[.1,.25,.5],bt=[.75,1,1.25],K=300,E=10,tt=2,R=10,Mt=20,zt=3,$=12,b=.25,wt=1e3,q={clearColor:"#002B36",debug:!0,light:{x:-.3,y:.9,z:-.9},camera:{z:1.2,y:-2.5,rx:80,fov:30},ambient:.1,geometry:{sphere:mt,plane:ft,cube:dt,pyramid:ut,shipBody:U.body,shipFin:U.fin,shipWing:U.wing}},At={alive:!0,x:0,y:0,z:b,boosts:0,score:0,turn:0,vz:0,lastFrame:0},G=6e5,w=[[,,1,,1,1,1,,2,2,2,,2,,2],[,1,1,,,,1,,,2,,,2,2,2],[,,1,,,1,1,,,2,,,2,,2],[,,1,,,,1,,,,,,,,],[,,1,,1,1,1,,,,,,,,],[,,,,,,,,,,,,,,],[2,2,2,,2,2,2,,2,2,2,,2,2,2],[2,,,,2,,2,,,2,,,2,,],[2,,2,,2,2,2,,,2,,,2,2],[2,,2,,2,,2,,,2,,,2,,],[2,2,2,,2,,2,,,2,,,2,2,2]],St=[()=>z(2),()=>z(3),()=>z(3),()=>z(6),()=>z(0),()=>z(Math.random()*2**32>>>0)],it=(t,i)=>{t.group({id:"ship"}),t.group({id:"shipPivot",g:"ship",y:-.25,z:.05});const e=C("#00FFFF","#FFA500",0,.081);t.add("shipBody",{id:"body",g:"shipPivot",x:-.305,z:0,rx:-90,b:"#00FFFF",t:e}),t.add("shipFin",{id:"fin1",g:"shipPivot",x:.3,z:-.045,rx:90,rz:180,b:"#00FFFF",size:.5}),t.add("shipFin",{id:"fin2",g:"shipPivot",x:-.3,z:-.045,rx:90,rz:180,b:"#00FFFF",w:-.5,h:.5,d:.5}),t.add("shipFin",{id:"fin3",g:"shipPivot",x:.3,z:-.045,rx:90,rz:180,b:"#00FFFF",w:.5,h:-.5,d:.5}),t.add("shipFin",{id:"fin4",g:"shipPivot",x:-.3,z:-.045,rx:90,rz:180,b:"#00FFFF",w:-.5,h:-.5,d:.5}),t.add("shipWing",{id:"wing1",g:"shipPivot",x:-.55,z:-.05,rx:-90,b:"#00FFFF",t:e,size:.5}),t.add("shipWing",{id:"wing2",g:"shipPivot",x:.55,z:-.05,rx:-90,b:"#00FFFF",t:e,w:-.5,h:.5,d:.5}),t.add("pyramid",{id:"canopy",g:"shipPivot",x:0,y:.42,z:-.038,rx:-4,b:"#191970",t:C("#191970","#2F4F4F",1),w:.12,h:.5,d:.075});const r={rx:180,w:.07,d:.07,h:.2,z:-.06,y:-.1,b:"#ffff00",o:.15};t.add("pyramid",{g:"shipPivot",id:"flame1",...r,x:.18}),t.add("pyramid",{g:"shipPivot",id:"flame2",...r,x:-.18})},V=(t,i,e)=>{const r=X`boost`;return t.group({id:r,x:i,y:e}),t.group({id:r+"p",g:r}),t.add("pyramid",{g:r+"p",z:.4,b:"#FFFF00AA",rx:90,rz:45,w:.5,d:.5,h:.4}),t.add("pyramid",{g:r+"p",z:0,b:"#FFFF00AA",rx:90,rz:45,w:.5,d:.5,h:-.4}),t.move({id:r+"p",rz:.2*G,a:G}),{id:r,x:i,y:e,t:"boost",s:"sphere",r:.375,z:.25}},Lt=C("#8A2BE2","#E6E6FA"),Bt=(t,i,e,r=2,s=3)=>{const o=X`spike`;return t.add("pyramid",{id:o,x:i,y:e,z:s/2-.01,rx:90,b:"#ff00ff",w:r,h:s,d:r,t:Lt}),{id:o,x:i,y:e,z:0,t:"wall",s:"pyramid",r:r,h:s}},Pt=(t,i,e,r,s)=>{const o="gate"+i;return t.group({id:o,x:e,y:r,z:s}),t.add("cube",{id:o+"c",g:o,z:13,b:"#FF6347",o:0,d:26,w:3,h:3}),{id:o,x:e,y:r,z:s,s:"box",w:3,h:26,d:3,t:"wall"}},et=(t,i=K)=>{t.add("plane",{id:"floor",x:0,y:i/2,z:0,b:"#E6E6FA",w:39,h:i,t:C("#D3D3D3","#E6E6FA",0,.85)})},It=(t,i)=>{t.add("plane",{id:"exit",x:0,y:i-1,z:13,b:"#FFFF00",rx:90,w:39,h:26})},kt=([t,i],e,r)=>{const s=r.r(2,3),o=r.r(3,5);return[[t,i-3,s,o],[t-3,i,s,o],[t+3,i,s,o],[t,i+3,s,o]].slice(0,e)},Dt=([t,i],e,r)=>Array.from({length:e},((e,s)=>[t+r.r(-1,1),i+r.r(-1,1),r.r(3,4),r.r(4,5)])),Et=([t,i],e,r)=>{const s=r.n(1);return Array.from({length:e},((e,o)=>{const n=r.r(2,3);return[t+o*(s?2:-2),i+o*n,n,3+.5*o]}))},J=[Dt,Et,kt],qt=(t,i,e)=>{const r=[],s=[],o=3*E,n=K*(1+.2*(t-1)),a=2*t,h=1e3*Array.from({length:a+1}).fill(n/(a+1)).map(((t,i)=>t/(E+tt*i))).reduce(((t,i)=>t+i),0);et(i,n),It(i,n),r.push(V(i,0,2*E));for(let t=1;t<(n-o)/15;t++)r.push(V(i,e.r(-8,8),o+20*t));const l=s=>{const o=e.r(2,2+t),n=[],a=J[e.n(J.length-1)];n.push(...a(s,o,e)),n.forEach((([t,e,s,o])=>r.push(Bt(i,t,e,s,o))))};for(let i=0;i<(n-o)/(25-t);i++){const r=o+(25-t)*i;switch(i%3){case 0:l([e.r(-14,-5),r]),l([e.r(-5,5),r+5]),l([e.r(5,14),r]);break;case 1:l([e.r(-14,-5),r]),l([e.r(5,14),r]);break;case 2:l([e.r(-14,-5),r]),l([e.r(-5,5),r-5]),l([e.r(5,14),r])}}const c=[];for(let t=0;t<13;t++)c.push(t);vt(c,e);const d=h/26,m=h/13*1.5,g=(h-m)/12;return c.forEach(((t,e)=>{r.push(Pt(i,t,3*t-19.5+1.5,n,30+5*e));const o=d+g*e;s.push({id:"gate"+t+"c",key:"o",from:0,delta:1,duration:.2*m,delay:o,progress:0}),s.push({id:"gate"+t,key:"z",from:20+2*e,delta:-(20+2*e),duration:m,delay:o,progress:0})})),[r.sort(((t,i)=>t.y-i.y)),s]},_={explosion:t=>t>4e4?null:Math.sin(t/200-Math.sin(t/331)*Math.sin(t/61)+33*Math.sin(Math.sin(t/59)/39))*Ct(t,4e4)*9,boost:t=>Math.sin(t/20)*Math.cos(Math.sqrt(t)/5)*Math.exp(-t/2e4),jump:t=>Math.sin(t/100+50*Math.random())*Math.exp(-t/8e3),fall:t=>Math.sin(t*t/1e6)*Math.exp(-t/2e3)*9},Ct=(t,i)=>(i-t)/i,T=t=>{const i=new AudioContext,e=i.createGain();e.gain.value=.2;const r=i.createBuffer(1,96e3,48e3),s=r.getChannelData(0);for(let i=96e3;i--;)s[i]=t(i);const o=i.createBufferSource();return o.buffer=r,o.connect(e),e.connect(i.destination),o.start(),o},I={direction:0,jump:!1},v={ArrowLeft:0,KeyA:0,KeyD:0,ArrowRight:0,Space:0},st=()=>{I.jump=!!v.Space,I.direction=Math.sign(Math.max(v.ArrowRight,v.KeyD)-Math.max(v.ArrowLeft,v.KeyA))};function _t(t,i,e,r){i.y+=(E+i.boosts*tt)*t;const s=Mt*(1.2-r/10)*t;I.direction?i.turn=gt(i.turn+s*I.direction,-R,R):i.turn&&(Math.abs(i.turn)<s?i.turn=0:i.turn-=s*Math.sign(i.turn));const o=Math.abs(i.x);o>18&&i.turn*i.x>0&&(i.turn*=o>19?0:1-o%18/3),i.x+=i.turn*t,I.jump&&i.z<=b&&i.boosts&&(i.vz=$,i.boosts-=1,T(_.jump)),i.vz=Math.max(-50,i.vz-10*t);const n=i.z+i.vz*t;i.z>b&&n<=b&&T(_.fall),i.z=Math.max(b,n),e.move({id:"shipPivot",ry:i.turn*zt,rx:yt(e.current.shipPivot.rx,i.z>b?i.vz/$*15:0,.2)}),e.move({id:"ship",x:i.x,y:i.y,z:i.z})}function Tt(t,i){let e=null,r=0;for(;r<i.length&&t.y+.25>i[r].y-xt;){if({sphere:()=>rt(t,i[r])<=t.r+i[r].r,pyramid:()=>Ot(t,i[r]),box:()=>Ut(t,i[r])}[i[r].s]()){e=i[r];break}r+=1}for(;i.length&&i[0].y+(i[0].r||i[0].d/2)<t.y-t.r;)i.shift();return e}document.addEventListener("keydown",(t=>{v[t.code]=Date.now(),st()})),document.addEventListener("keyup",(t=>{v[t.code]=0,st()})),document.addEventListener("blur",(()=>{for(let t in v)v[t]=0}));const rt=({x:t,y:i,z:e},{x:r,y:s,z:o})=>x([t,i,e],[r,s,o]),Ot=({x:t,y:i,z:e,r:r},{x:s,y:o,r:n,h:a})=>{if(rt({x:t,y:i,z:e},{x:s,y:o,z:0})>Math.max(n/2*1.5,e>b?a:0)+r)return!1;const h=n/2,l=[s,o,a],c=[s-h,o-h,0],d=[s+h,o-h,0],m=[s+h,o+h,0],g=[s-h,o+h,0];return Math.min(N([t,i,e],[l,c,d]),N([t,i,e],t>s?[l,d,m]:[l,c,g]))<r},Ut=({x:t,y:i,z:e,r:r},{x:s,y:o,z:n,w:a,h:h,d:l})=>Ht([t,i,e],[s-a/2,o-l/2,n,s+a/2,o+l/2,n+h])<r;function N(t,i){const[e,r,s,o]=[t,...i],n=A(s,r),a=A(o,r),h=A(e,r),l=S(n,h),c=S(a,h);if(l<=0&&c<=0)return x(e,r);const d=A(e,s),m=S(n,d),g=S(a,d);if(m>=0&&g<=m)return x(e,s);const u=l*g-m*c;if(u<=0&&l>=0&&m<=0){return x(e,B(r,P(n,l/(l-m))))}const f=A(e,o),p=S(n,f),v=S(a,f);if(v>=0&&p<=v)return x(e,o);const y=p*c-l*v;if(y<=0&&c>=0&&v<=0){return x(e,B(r,P(a,c/(c-v))))}const b=m*v-p*g;if(b<=0&&g-m>=0&&p-v>=0){const t=(g-m)/(g-m+(p-v));return x(e,B(s,P(A(o,s),t)))}const M=1/(b+y+u),F=u*M,z=B(r,B(P(n,y*M),P(a,F)));return x(e,z)}function Ht(t,i){const[e,r,s]=t,[o,n,a,h,l,c]=i,d=Math.max(o-e,0,e-h),m=Math.max(n-r,0,r-l),g=Math.max(a-s,0,s-c);return Math.sqrt(d*d+m*m+g*g)}const x=(t,i)=>Math.sqrt((i[0]-t[0])**2+(i[1]-t[1])**2+(i[2]-t[2])**2),A=(t,i)=>t.map(((t,e)=>t-i[e])),B=(t,i)=>t.map(((t,e)=>t+i[e])),P=(t,i)=>t.map((t=>t*i)),S=(t,i)=>t.reduce(((t,e,r)=>t+e*i[r]),0),M=document.querySelector("#c");function Kt(t){M.width=window.innerWidth,M.height=window.innerHeight;const i=parseInt(document.querySelector("input:checked").value),e=new Q({canvas:M,...q}),r={...At,r:Ft[i-1]},[s,o]=qt(t,e,St[t-1]()),n=K*(1+.2*(t-1));let a=8e3,h=n/10*1e3,l=0;const c=t=>{l||=t;const i=Math.min(t-l,100);l=t,a-=i,a<0?d():requestAnimationFrame(c)},d=()=>{go("hud"),e.move({id:"camera",g:"ship",y:n-1,z:10}),e.draw(1),e.move({id:"camera",y:q.camera.y,z:q.camera.z,a:h}),requestAnimationFrame(m)},m=t=>{l||=t;const i=Math.min(t-r.lastFrame,100);l=t,h-=i,h<0?requestAnimationFrame(g):(e.draw(i),requestAnimationFrame(m))};it(e,r.r);const g=a=>{r.lastFrame||=a;const h=Math.min(a-r.lastFrame,100);r.lastFrame=a,_t(h/1e3,r,e,i),Z(r.score,r.boosts);let l=Tt(r,s);"boost"===l?.t&&(r.boosts+=1,r.score+=wt*bt[i],s.splice(s.findIndex((t=>t.id===l.id)),1),e.move({id:l.id,z:.5,size:.5,a:50}),e.delete(l.id,50),Z(r.score,r.boosts),T(_.boost)),"wall"!==l?.t?r.y>=n?Wt(t,r.score):($t(o,s,e,h),ot(e,a,r.boosts),e.draw(h),requestAnimationFrame(g)):Rt()},u=H();u.seenIntro?d():(u.seenIntro=!0,Y(u),go("intro"),requestAnimationFrame(c))}function Wt(t,i){const e=H();e.score[t-1]=i,Y(e),document.querySelector("#score").innerHTML=i,nt(),go("win")}function Rt(){T(_.explosion),go("defeat")}function $t(t,i,e,r){t.forEach((t=>{if(!(t.progress>=t.duration)){if(t.delay>0)return void(t.delay-=r);t.progress+=r,e.move({id:t.id,[t.key]:t.from+t.delta*W(t.progress/t.duration)}),["x","y","z"].includes(t.key)&&(i.find((i=>i.id===t.id))[t.key]=t.from+t.delta*W(t.progress/t.duration))}}))}function ot(t,i,e=1){const r=.015*Math.sin(i/150)+.02*e;t.move({id:"flame1",h:.15+r,y:-r/2-.1}),t.move({id:"flame2",h:.15+r,y:-r/2-.1})}function nt(){const t=document.querySelector("#ls"),i=H();let e="";for(let t=0;t<6;t++)e+=`<div><button data-level="${t+1}"${t>0&&!i.score[t-1]?"disabled":""}>${5===t?"?":t+1}</button>${i.score[t]||"Not Passed"}</div>`;t.innerHTML=e}function Z(t,i){const[e,r]=document.querySelectorAll("#hscore,#hboosts");e.innerHTML=t,r.innerHTML=i+"  &#9671;"}function Gt(){M.width=window.innerWidth,M.height=window.innerHeight;const t=window.innerWidth/window.innerHeight;let[i,e,r,s,o,n,a]=[2.5,-2,2,68,-19,28,27];a*=1+Math.max(0,1.5-t);const h={x:i,y:e,z:r,rx:s,fov:a,ry:o,rz:n},l=new Q({canvas:M,...q,camera:h});it(l),et(l,1e3),l.move({id:"floor",w:22,y:-10}),l.group({id:"logo",y:50,z:w.length,x:-w[0].length/2+1});for(let t=0;t<w.length;t+=1)for(let i=0;i<w[0].length;i+=1)w[t][i]&&l.add("cube",{g:"logo",x:i,z:-t,b:[,"f00","fff"][w[t][i]]});const c=t=>{ot(l,t),l.draw(1),document.querySelector("#splash").classList.contains("active")&&requestAnimationFrame(c)};requestAnimationFrame(c)}document.querySelector("#ls").addEventListener("click",(t=>{const i=t.target.dataset?.level;i&&Kt(parseInt(i,10))})),window.go=function(t){const[i,e]=document.querySelectorAll(`.active,#${t}`);M.style.opacity="hud"===t?"1":"0",i.classList.toggle("active"),e.classList.toggle("active"),document.querySelectorAll("button").forEach((t=>t.blur()))},nt(),Gt()</script><main id=debug></main><canvas id=c></canvas><div id=splash class=active><button onclick='go("menu")'>Start</button></div><div id=intro><div><div>When 13th gates closes</div><div>all hope will be lost.</div><div>But with enough speed</div><div>you will glide through.</div><br></div></div><div id=win><div>Escape<div id=score></div></div><button onclick='go("menu")'>Continue</button></div><div id=defeat><div>Death</div><button onclick='go("menu")'>Return</button></div><div id=hud><div id=hscore></div><div id=hboosts></div></div><div id=menu><div id=t><strong>13</strong>th gate</div><div id=ls></div><div id=dif><label><input type=radio value=1 name=dif>Easy</label> <label><input type=radio value=2 name=dif checked>Normal</label> <label><input type=radio value=3 name=dif>Hard</label></div><div id=h><kbd>←</kbd>, <kbd>→</kbd> or <kbd>A</kbd>, <kbd>D</kbd> to strafe<br><kbd>Space</kbd> to jump by consuming a boost</div></div><div id=title>13th gate</div>