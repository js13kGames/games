<!DOCTYPE html>
<html>
  <head>
    <title>The Last Tear</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script>
      window.$ = (...a) => document.querySelector(...a);
      window.$$ = (...a) => document.createElement(...a);
    </script>
    <script type="module" crossorigin>
let J=null;class c{scene=[];invEl=$("#inv");canEl=$("#canvas");lev=$("#level");lOff=0;levPos=0;xOffset=0;keys={};col=[];inv={};aCtx=new AudioContext;static getIns(){return J==null&&(J=new c),J}}const ee=350,Ae=433,ve=1e3,te=100,T=10,A=3500,ge=3100,Ce={C4:261.63,D4:293.6,E4:329.63,F4:349.23,G4:392,A4:440,B4:493.88,C5:523.25,D5:587.33,E5:659.25,F5:698.46,G5:783.99,A5:880,B5:987.77},O=120,ne=[["F4:4","A4:4","C5:4","C4:1","D4:1:1","E4:1:2","F4:1:3"],["E4:4","G4:4","B4:4"],["D4:4","F4:4","A4:4"],["E4:4","G4:4","B4:4"],["F4:4","A4:4","C5:4","C4:1","D4:1:1","E4:1:2","F4:1:3"],["E4:4","G4:4","B4:4"],["D4:4","F4:4","A4:4"],["C4:4","F4:4","A4:4"]],we=.05;let P=null,W;class y{i=0;playTS(t){this.playNote(t,t.aCtx.currentTime,Ce.D5,.1,.1)}playNote(t,C,n,i,s=we){const o=new OscillatorNode(t.aCtx,{frequency:n,type:"sine"});let a=new BiquadFilterNode(t.aCtx,{type:"highpass",frequency:190}),d=new BiquadFilterNode(t.aCtx,{type:"notch",frequency:1223}),r=new BiquadFilterNode(t.aCtx,{type:"lowshelf",frequency:1870,gain:-10.5});const l=t.aCtx.createGain();return l.gain.cancelScheduledValues(C),l.gain.setValueAtTime(0,C),l.gain.linearRampToValueAtTime(s,C+.008),l.gain.linearRampToValueAtTime(0,C+i-.008),o.connect(l),l.connect(a),a.connect(d),d.connect(r),r.connect(t.aCtx.destination),o.start(C),o.stop(C+i),o}playMelody(t){this.i===ne.length&&(this.i=0),ne[this.i].forEach(C=>{const[n,i,s=0]=C.split(":");this.playNote(t,t.aCtx.currentTime+s*60/O,Ce[n],i*60/O)}),this.i++}playBgMusic(t){this.playMelody(t),W=setInterval(()=>this.playMelody(t),4*6e4/O)}stopBgMusic(){W&&clearInterval(W)}static getIns(){return P==null&&(P=new y),P}}const u=e=>new Promise(t=>setTimeout(t,e)),S=(e,t)=>Math.floor(Math.random()*(t-e))+e;function v(e,t=C=>C){return e.split("|").map(C=>C.split("").map(t))}const V=({bs:e,bg:t,s:C})=>`height:${C};width:${C};box-shadow:${e};background:${t}`;function R(){const e={};let t=new Promise(function(C,n){e.resolve=C,e.reject=n});return e.promise=t,e}function L(e,t,C,n){if(n||(n=R(),y.getIns().playTS(e)),C.length){const i=C.shift();t.innerHTML+=i===`
`?"<br/>":i,e.textTimeout=setTimeout(()=>{clearTimeout(e.textTimeout),[" ",`
`].includes(i)&&y.getIns().playTS(e),L(e,t,C,n)},25+(i===`
`?100:0))}else y.getIns().playTS(e),n.resolve();return n.promise}const ie=["#f0c188","#ef7e45","#d44f26","#ab3232","#66333c","#392245","#5c4b4b","#917d65","#b5a774","#81906c","#5c635e","#363c3d","#091d21","#405351","#78756c","#a8a192","#cfcbb8","#ebe8e2","#a6dde3","#72b4c4","#5f96b0","#4d73a1","#204d85","#161d80","#4f3c80","#78618c","#b089a1","#d4b8b2"];var _="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz=_";function se(e){return e.length<2?_.indexOf(e):se(e.slice(0,-1))*_.length+_.indexOf(e.slice(-1))}function D(e,t=T){let C=v(e,s=>s==="-"?-1:se(s));const n=C.length-1,i=C.reduce((s,o,a)=>s+o.reduce((d,r,l)=>l===0&&a===n||r===-1?d:`${d}${l*t}px ${-(n-a)*t}px 0 0 ${ie[r]}, `,""),"");return{bs:i.substring(0,i.length-2),bg:C[n][0]===-1?"":ie[C[n][0]],s:`${t}px`}}function M(e,t){const{bs:C,bg:n,s:i}=D(t,e.scale);e.el.style.height=i,e.el.style.width=i,e.el.style.boxShadow=C,e.el.style.backgroundColor=n}function xe(e,t){const C=t.a[t.currAction+1];if(!C||e.currentLines||C.type==="msg"&&C.cond&&!e.inv[C.cond])return!1;const n=Object.keys(e.inv),s=Object.keys(C).filter(o=>o.startsWith("c_")).find(o=>n.includes(o.slice(2,o.length)));return!(C.type==="cond"&&!s&&C.bad===void 0)}function oe(e){e.levPos=e.p.x-e.canW/2+e.p.width/2,e.levPos<0+e.lOff&&(e.levPos=0+e.lOff);const t=e.levW-e.canW+(e.lOff?A:0);e.levPos>t&&(e.levPos=t)}function De(){const e=c.getIns();if(Object.values(e.scene).forEach(t=>{!t.hidden&&t.a&&t.a.length>0&&t.currAction<t.a.length-1&&(e.p.x+e.p.width>t.x-te&&e.p.x+e.p.width<t.x+t.width+te&&xe(e,t)?e.currAvailAct=t.id:e.currAvailAct===t.id&&(e.currAvailAct=void 0));const C=(t.id==="puddle"?-1:1)*t.y;!t.hidden&&(t.el.style.left!==`${t.x}px`||t.el.style.bottom!==`${C}px`||t.id==="actionButton")?(t.el.style.opacity="1",t.el.style.left=`${t.x}px`,t.el.style.bottom=`${C}px`):t.hidden&&t.el.style.opacity!=="0"&&(t.el.style.opacity="0")}),e.currAvailAct){const t=e.scene[e.currAvailAct];e.actionButton.hidden=!1,e.actionButton.x=t.x-e.actionButton.width,e.actionButton.y=t.y+t.height}else e.actionButton.hidden=!0;oe(e),e.lev.style.transform=`translate3d(${-e.levPos}px,0, 0)`}function ke(){const e=c.getIns();e.invMod&&(e.invMod=!1,e.invEl.innerHTML="",Object.keys(e.inv).filter(t=>!t.startsWith("t_")).forEach(t=>{const C=e.inv[t],n=$$("div");n.classList.add("slot");const i=$$("div");i.id=C.id;const{bs:s,bg:o,s:a}=D(C.sprite,C.scale);i.style.cssText=V({bs:s,bg:o,s:a}),n.appendChild(i),e.invEl.appendChild(n)}))}let le;async function q(e){e.canEl.style.opacity=0,await u(300),e.canEl.style.opacity=1}async function re(e){const t=c.getIns();t.keys={},e?(t.override=!1,t.xOffset=100,t.autoX=t.levW+A+100,await u(4e3),await q(t),t.xOffset=0,t.autoX=0,t.lOff=0,t.p.y=-1,t.p.x=4800,oe(t),le.resolve()):(await q(t),t.p.y=-1,t.p.x=5600)}async function Ie(e,t){le=t,await q(e),e.p.x=5600,e.lOff=5490,e.override=!0}const G=(e,t,C)=>({o:{x:e,y:t},dir:C});function N(e,t,C){return t>C&&([C,t]=[t,C]),e<t?-1:e>C?1:0}function be(e,t,C){if(e==="down"&&t.y<=C.y&&N(t.x,C.x,C.x+C.w)==0)return{x:t.x,y:C.y};if(e==="left"&&t.x>=C.x+C.w&&N(t.y,C.y,C.y+C.h)==0)return{x:C.x+C.w,y:t.y};if(e==="right"&&t.x<=C.x&&N(t.y,C.y,C.y+C.h)==0)return{x:C.x,y:t.y}}function Te(e,t){var C=Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2));return C<.001?0:C}function Y(e){var t=c.getIns().col.map(C=>{const n=be(e.dir,e.o,C);return{id:C.id,i:n,ray:e,dist:n&&Te(e.o,n)}}).filter(C=>C.i).sort((C,n)=>C.dist-n.dist);return t[0]}function Re(e){const t=Y(G(e.x,e.y-1,"left")),C=Y(G(e.x+e.w,e.y-1,"right")),n=[G(e.x+1,e.y,"down"),G(e.x+e.w/2,e.y,"down"),G(e.x+e.w-1,e.y,"down")].map(Y).filter(Boolean);return[t,C,...n].find(s=>s?.id?.startsWith("egg")&&s?.dist<1)?re(!1):{left:t?.dist,right:C?.dist,bottom:Math.min(...n.map(s=>s.dist))}}function Le(e){const t=e.p.movAn;t.tick===t.tPF&&(t.tick=-1,M(e.p,e.p.movS[t.currKF]),t.currKF++,t.currKF>t.nbKeyframes&&(t.currKF=0)),t.tick++}function $e(e){const t=c.getIns(),C=Re({x:t.p.x+(t.p.flipped?-10:0),w:t.p.width+(t.p.flipped?0:-10),y:t.p.y+t.canH});if(!!C){t.p.vx=t.xOffset,t.p.vy+=ve*e,t.keys.ArrowLeft&&(t.p.vx=-ee),t.keys.ArrowRight&&(t.p.vx=ee),t.keys[" "]&&C.bottom==0&&(t.p.vy=-Ae);var n=t.p.vx*e,i=t.p.vy*e;t.p.vx<0&&C.left!=null&&(n=-Math.min(C.left,Math.abs(n))),t.p.vx>0&&C.right!=null&&(n=Math.min(C.right,Math.abs(n))),t.p.vy>0&&C.bottom!=null&&(C.bottom<i&&(t.p.vy=0),i=Math.min(C.bottom,Math.abs(i))),n&&Le(t),t.p.x+=n,t.p.y+=Math.round(i),t.p.x>=t.levW+ge&&t.override&&re(!0),(t.xOffset>0&&t.p.x>=t.autoX||t.xOffset<0&&t.p.x<t.autoX)&&(t.xOffset=0,t.autoX=!1)}}const F=JSON.parse('{"actionButton":{"scale":5,"sprite":"---CCCCC---|--CFFFFFC--|-CFFFFFFEC-|CFFFMMMFFEC|CFFFMFFFFEC|CFFFMMFFFEC|CFFFMFFFFEC|CFFFMMMFFEC|-CFFFFFFEC-|--CFFFEEC--|---CCCCC---"},"bush":{"scale":5,"sprite":"----BBB-BB---|--BB998B88B--|-B99R88888RB-|-B9998888899B|B99988888899B|B99988888899B|B99998888R9B-|-B999R88899B-|--B9998899B--"},"cemetery":{"sprites":["D-DCEECD-D|-D-CBAC-D-|D-DCFACD-D|-D-CFBC-D-|D-DCEECD-D|-D-CBBC-D-|D-DCFBCD-D|-D-CFAC-D-|D-DCAFCD-D|-D-CEFC-D-","----------|----------|----CC----|---CEFC---|---CEAC---|--CAEAAC--|--CAFEAC--|---CFAC---|---CAFC---|CCCCEFCCCC","-D-D-D-D-D|D-D-D-D-D-|-D-D-D-D-D|D-D-D-D-D-|-D-D-D-D-D|D-D-D-D-D-|-D-D-D-D-D|D-D-D-D-D-|-D-D-D-D-D|D-D-D-D-D-","----------|----------|----------|----------|----------|----------|----------|----------|----------|CCCCCCCCCC","D-DCEEC---|-D-CBAC---|D-DCFAC---|-D-CFBC---|D-DCEEC---|-D-CBBC---|D-DCFBC---|-D-CFAC---|D-DCAFC---|-D-CEFC---","----------|----------|----CC----|---CEFC---|---CEAC---|--CAEAAC--|--CAFEAC--|---CFAC---|---CAFC---|CCCCEFC---"]},"egg":{"sprite":"--CC--|-CHHC-|CG9HHC|CGHHHC|CGH9HC|CGGHHC|-CGGC-"},"cloud":{"sprite":"-------BBBB-----|------BGGHHB----|---BBBFHHHHHB---|--BHGGBFHHHHB---|-BHHHHGBHHHFBB--|-BHHHHHHHHGBHFB-|BGHHHHHHHHHHHHFB|BFGGGHHHHHHHHGGB|-BFFGGGGGGGGGGB-|--BBBBBBBBBBBB--"},"color1":{"sprite":"---CC---|--C22C--|-C2222C-|C22H122C|C2H2212C|C2H2212C|C22H122C|-C2222C-|--C22C--|---CC---"},"color2":{"sprite":"---CC---|--CIIC--|-CIIIIC-|CIIHJIIC|CIHIIJIC|CIHIIJIC|CIIHJIIC|-CIIIIC-|--CIIC--|---CC---"},"deave":{"sprite":"CC--CC---|CBCCCBC--|CBBBBBAC-|CBBBBBAC-|CFFEBBAC-|CFFEBCAC-|CGGGBBAC-|CGGGBBACC|CGGGBBABC|CGGCBBAC-|-CC-CCC--","bShift":-10},"fox":{"sprite":"CC---CC--------|C1C--C1C-------|C1C--C1C-------|C22CCC2C---CC--|CC22222C--CHC--|-C2C2C22C-CHHC-|-C2C2CH2C-C21C-|C2CHHHHC--C221C|CGHHHH1C---C21C|-CGHH112C--C21C|--CGHH122C-C21C|--C616C222C21C-|--CBCBC22221C--|-CBCBC22222C---|-CCCCCCCCCC----"},"house":{"scale":14,"sprite":"-----------C------------------------|----------C2C-------------CC--------|----------C2C------------C11C-------|---------C211C-----------C12C-------|---------C211C-----------C22C-------|--------C21111CCCCCCCCCCCCCCCCC-----|--------C21111C211111111111111C-----|-------C21AAA11C211111111111111C----|-------C2AJJIA1C221111111111111C----|------C21AJIJA11C211111111111111C---|------C21AJJJA11C221111111111111C---|-----C2111AAA1111C221111111111111C--|-----C21111111111C222222222222222C--|-----CCCCCCCCCCCCCCCCCCCCCCCCCCCCC--|-----CFFFFFFFFFFFFFFFFFFFFFFFFFFFC--|-----CGGGGGGGGGGGGGGGGGGGGGGGGGGGC--|-----CGGGGGGGGGGGGGGGGGGGGGGGGGGGC--|-----CGG6666GGGG666666G6666666GGGC--|-----CGG6776GGGGGJJJJGGGJJJJJGGGGC--|-----CGG6776GGGGGJJIJGGGJJJIJGGGGC--|-----CGG6666GGGGGJIJJGGGJJIJJGGGGC--|---C-CGG67F6GGGGGJJJJGG8JJ8JJGGGGC--|--CRCCGG6666GGGGG88RJGG8J8888GGGGC--|--C99CGG6776GGGG8R888GGG88R888GGGC--|-C899CGG6776GGGG84444GGG44444RGCCC--|-C98R9CG6666GGGG84444GGG44444CC99C--|C99998CFEEEEFGGGGGGGGGGGGGGGC9989RC-|CR98988CDDDDDGGGGGGGGGGGGGGCR989889C|C98999RCBBBBBBBBBBBBBBBBBBC98899R89C"},"key":{"sprite":"--CCCC--------------|-CHHHGC-------------|CHHGGGFC------------|CHGCCGGFCCCCCCCCCCCC|CGFCCGFFFHHHHHHHHHHC|CGFCCFFFFFFFFFFFFGHC|CEFCCFFFCCCCCCFCFHC-|CEEFFFEC-----CECEEC-|-CEEEEC------CCCCC--|--CCCC--------------"},"lama":{"sprite":"---C-C----------|--CFCFC---------|--CGHGC---------|--CHHHC---------|-CHHCHC---------|CHHHHHC---------|CHHHHFC---------|-CCFFGC---------|---CGGC---------|---CGGC---------|---CGHC------CC-|---CHHHC----CHHC|---CHHHCCCCCCHGC|---CHHHH3993HHCC|---CHHHH3993HGC-|---CGHHHH33HHGC-|----CGGHHHHHHGC-|-----CCGGCCCGGC-|-----C-CC--CCC--|-----C-C---C-C--|-----C-C---C-C--"},"mouse":{"sprite":"--CC-CC----|-CQC-CQC---|-CCC-CCC---|---CCC-----|--CEEEC----|-CEECEEC---|CQEEEEEC---|--C0000C---|--C0000C---|-CFFFFFC---|-CFFFFFC---|-CFFFEEC---|-CFEEEEC---|--CCCCC-C--|--C---C--CC","bShift":-10},"puddle":{"movAn":{"nbKeyframes":4,"currKF":0,"tPF":5},"bShift":10,"sprite":"----CCCC--|---CGHHHC-|---CGHHHC-|---CCH211C|---CGH211C|---CGHHHC-|---CGHHHC-|--CFGHHHC-|--CFHGFHC-|CCEFFFHHC-|CEEFHHHHC-|-CCFHHHC--|--CCCCC---|--C---C---","movS":["----------|----CCCC--|---CGHHHC-|---CGHHHC-|---CCH211C|---CGH211C|---CGHHHC-|--CFGHHHC-|--CFHGFHC-|CCEFFFHHC-|CEEFHHHHC-|-CCFHHHC--|--CCCCC---|--C----C--","----------|----CCCC--|---CGHHHC-|---CGHHHC-|---CCH211C|---CGH211C|---CGHHHC-|--CFGHHHC-|--CFHGFHC-|CCEFFFHHC-|CEEFHHHHC-|-CCFHHHC--|--CCCCC---|---C---C--","----CCCC--|---CGHHHC-|---CGHHHC-|---CCH211C|---CGH211C|---CGHHHC-|---CGHHHC-|--CFGHHHC-|--CFHGFHC-|CCEFFFHHC-|CEEFHHHHC-|-CCFHHHC--|--CCCCC---|---C--C---"]},"rocks":{"sprite":"-------------------CCCCCC-----|----------------CCCFFFFEECC---|---------------CEFFFFFFFFEEC--|--------------CEFFFFFFFFFFEC--|--------------CEFFFFFFFFFFEEC-|--------------CEFFFFFFFFFFFEC-|--------------CEFFFFFFFFFFFEEC|-------------CEFFFFFFFFFFFFEEC|----------CCCCCCFFFFFFFFFFFEBC|-------CCCFFFFEECCFFFFFFFFEEBC|----CCCFFFFFFFFEEECFFFFFFFEBBC|--CCEEFFFFFFFFFFFECFFFFFFFEBBC|-CEEFFFFFFFFFFFFEEBCFFFFFFEBBC|CEFFFFFFFFFFFFFFEBBCFFFFFEEBBC|CEFFFFFFFFFFFFEEEBBCFEEEEEEBBC|-CEFFFFFFFFEEEEEEBBCEEEEEEEBBC|--CEEEEEEEEEEEEBBBCEEEEEEBBBC-|---CBBBBBBBBBBBBBCBBBBBBBBBC--"},"snail":{"sprite":"-------CC-CC|--CCCC--C-C-|-CHHHHC-CCC-|-CHGGHC-C9C-|-CHGHHC-C9C-|-CHGHHCC99C-|C999999999C-"},"tallTree":{"sprite":"----BBBBB----|---B99898B---|--B999888RB--|--B9999888B--|--B99R8889B--|-B999888899B-|-B999888888B-|-B999888888B-|-B999988898B-|-B999998889B-|-B999888888B-|-B999888888B-|--B996884R9B-|---B94R9B9B--|----B496BB---|----B444B----|----B444B----|----B444B----|----B444B----|----B444B----|----B464B----|---B64664B---","variants":["----BBBBB----|---B99898B---|--B9998882B--|--B9999888B--|--B9928889B--|-B999888899B-|-B999888888B-|-B999888888B-|-B999988898B-|-B999998889B-|-B999888888B-|-B999888888B-|--B99688429B-|---B9429B9B--|----B496BB---|----B444B----|----B444B----|----B444B----|----B444B----|----B444B----|----B464B----|---B64664B---"]},"tombstone":{"sprite":"----CCC----|---CAAAC---|--CAACAAC--|-CAACCCAAC-|-CAAACAAAC-|-CAAACAABC-|-CAAAAABBC-|-C7ABBBB7C-|-7676BB786-|78667887667"},"well":{"sprite":"--------CCCCCCCCC----------|------CCR4CRCRC4RCC--------|-----CRR4CR4C4RC4RRC-------|---CCR44CR44C44RC44RCC-----|--CRR44CR444C444RC44RRC----|-CR444CR4444C4444RC444RC---|-CR44CR44444C44444RC44RC---|CR44CR444444C444444RC44RC--|CR44CR444444C444444RC44RC--|-CCCCCCCCCCCCCCCCCCCCCCC---|---CABC-----------CABC-----|---CABC-----------CABC---CC|---CABC---C767C---CABC---C-|---CABCCCC67676CCCCABCCCCC-|---CABC---C767C---CABC-----|---CABC-----6-----CABC-----|---CABC-----6-----CABC-----|---CABC-----6-----CABC-----|---CBBBCCCCCCCCCCCCBBC-----|--CAAAAAAAABBAAABBBBBBC----|-CFFFAFFFFFBFFFFFBFFFFBC---|-CEFFAFFFEEAEEFFFAFFFEEC---|-CEEEAEEEEEAEEEEEAEEEAEC---|-CAAAAAABBBAAAAAAAAABAAC---|-CFFAFFFFBFFFFAFFFEAFFFC---|-CEEAFFEEAEFFEAFFEEBFFEC---|-CEABEEEEAEEEEBEEEEBEEEC---|-CAABAAAAAAAABBAAAAAAAAC---"},"wideTree":{"sprite":"-BBBBBBBBBBB-|B99998889888B|B99988888888B|B99998888888B|B99999888888B|B99988888888B|B99998888888B|B99988888988B|B99999888998B|B99999999999B|-BBBB444B4BB-|---B6444BB---|----B46646B--|---B4444BB---|---B44666B---|--B4446646B--"}}'),f=$("#letters"),ae=$("#game"),H=$("#play"),Me="My dear Suzy I know we had our differences but I love you please forgive me";let g,I,de,p=0,X,w=!1,E=!1;function ce(e){const t=e.key;if(w===!1){if(t==="Enter")return E?Pe():We()}else g&&t===g[p]&&(X&&clearTimeout(X),$(`.key-${p}`)?.classList.remove("active"),p++,ue())}function Je(e,t){const C=$$("div");C.classList.add("key",`key-${t}`),C.innerText=e,f.appendChild(C)}function ue(){if(g.length===p)return I.resolve();$(`.key-${p}`)?.classList.add("active"),X=setTimeout(()=>{I.reject()},700)}async function Oe(e){for(E=!0;E&&e.length;){f.innerHTML="",g=e.shift(),g.split("").forEach(Je),p=0,I=R(),ue();try{await I.promise}catch{E=!1,w=!1}}E?(w=!1,f.innerText="Well done !",H.innerText="Press enter go back",H.style.display="block"):(f.innerText="You failed !",H.innerText="Press enter to try again",H.style.display="block")}function Pe(){Be();const e=c.getIns();ae.style.display="none",e.lev.classList.remove("bg"),document.removeEventListener("keydown",ce),de.resolve(),w=!1}async function We(){w=!0,H.style.display="none",f.innerHTML="3",await u(1e3),f.innerHTML="2",await u(1e3),f.innerHTML="1",await u(1e3),Oe(Me.toLowerCase().split(" "))}function Se(e,t){de=t,ye(),document.addEventListener("keydown",ce),ae.style.display="flex",e.lev.classList.add("bg")}async function _e(e){if(!e.extraAction)return;e.isInAction=!0;const t=e.extraAction.p;switch(e.extraAction.type){case"show":e.scene[t].hidden=!1,await u(3e3);break;case"give":const C={id:t,...F[t]};e.inv[C.id]=C,e.invMod=!0;break;case"end":je();break;case"play":const n=R();t==="letter"?Se(e,n):t==="race"&&await Ie(e,n),await n.promise;break;case"color":const i=e.scene.deave;(e.extraAction.p==="color1"?["F:1","E:2"]:["B:I","A:J","G:H"]).map(o=>{i.sprite=i.sprite.split(o[0]).join(o[2]),M(i,i.sprite)}),await u(3e3);break}e.isInAction=!1,delete e.extraAction}async function z(){const e=c.getIns();if($("#bubble")?.remove(),clearTimeout(e.textTimeout),e.extraAction&&await _e(e),e.currentLines.length){const[t,C,n]=e.currentLines.shift().split(":");C&&(e.currentAuthor=C);const i=e.scene[e.currentAuthor],s=$$("div");s.id="bubble";let o=-e.levPos+i.x+i.width/2+(i.bShift??0);o+300>window.innerWidth&&(s.classList.add("reverse"),o-=300),s.style.cssText=`bottom: ${i.y+i.height+25}px; left: ${o}px;`;const a=$$("div");if(s.appendChild(a),e.canEl.appendChild(s),n){const[d,r]=e.currentDiag.a[+n].split(":");e.extraAction={type:d,p:r}}return await L(e,a,t.split("")),s.classList.add("continue")}else delete e.currentLines}function Ne(e,t){const C=Object.keys(e.inv),i=Object.keys(t).filter(o=>o.startsWith("c_")).find(o=>C.includes(o.slice(2,o.length)));let s;return i?(i.slice(2,i.length).startsWith("t_")||(delete e.inv[i.slice(2,i.length)],e.invMod=!0),s=e.diag[t[i]],delete t[i],Object.keys(t).filter(o=>o.startsWith("c_")).length||e.scene[e.currAvailAct].a.shift(),e.currAvailAct=void 0):s=e.diag[t.bad],e.currentLines=[...s.l],e.currentDiag=s,z()}function Ye(){const e=c.getIns();e.keys={};const t=e.scene[e.currAvailAct];t.currAction>=t.a.length-1&&(e.actionButton.hidden=!0);let C=t.a[t.currAction+1];switch(C.type){case"cond":return Ne(e,C);case"msg":C.repeat||(t.currAction=t.currAction+1);const n=e.diag[C.diag];return e.currentLines=[...n.l],e.currentDiag=n,e.currAvailAct=void 0,z()}}function Fe(e){const t=c.getIns(),C=e.key;t.keys[C]=!1,!t.autoX&&(C==="ArrowLeft"||C==="ArrowRight")&&(t.p.el.classList.remove(`key-${t.p.currKF}`),t.p.currKF=0)}function he(e){const t=c.getIns(),C=e.key;t.autoX||((!t.currentLines||t.override)&&(t.keys[C]=!0,["ArrowLeft","ArrowRight"].includes(C)&&(t.p.flipped=C==="ArrowLeft",t.p.el.classList.toggle("flipped",t.p.flipped))),C==="e"&&(t.currAvailAct&&!t.currentLines?Ye():t.currentLines&&!t.isInAction&&(clearTimeout(0),z())))}function Be(){document.addEventListener("keyup",Fe),document.addEventListener("keydown",he)}function ye(){document.removeEventListener("keyup",Fe),document.removeEventListener("keydown",he)}const B=JSON.parse(`{"width":5500,"bg":[{"id":"cloud","s":"cloud","x":-500,"y":500,"repeat":true,"spread":true},{"id":"wideTree","s":"wideTree","x":20,"repeat":true},{"id":"bush","s":"bush","x":10,"repeat":true},{"id":"tallTree","s":"tallTree","x":-20,"repeat":true},{"id":"r1","s":"rocks","x":4390,"flipped":true},{"id":"r2","s":"rocks","x":3860},{"id":"r3","s":"rocks","x":2580},{"id":"r5","s":"rocks","x":3150,"flipped":true},{"id":"r4","s":"rocks","x":3300,"flipped":true},{"id":"cemetery","s":"cemetery","x":-90,"struct":"442442442446|331331331335|331331331335"},{"id":"house","s":"house","x":1700},{"id":"tb1","s":"tombstone","x":25,"mod":["A:D"]},{"id":"tb2","s":"tombstone","x":150,"mod":["B:D","A:B"]},{"id":"tb3","s":"tombstone","x":290,"mod":["B:D"]},{"id":"tb4","s":"tombstone","x":425,"mod":["B:D"]},{"id":"tb5","s":"tombstone","x":540,"mod":["A:D"]},{"id":"tb6","s":"tombstone","x":800,"mod":["B:D"]},{"id":"tb7","s":"tombstone","x":930,"mod":["B:D","A:B"]}],"diag":[{"l":["In loving memory of Deave, he will be missed.:tb_deave","I... I miss you my friend... I truly miss you...:puddle","Things haven't been the same without you. It's not as fun as it used to be.","I really wish I could've spent more time with you...::0","Oh wow! This guy wasn't joking with the whole 'getting you out of here'!:deave","Puddle? Is that you? What are you doing here?","Dea... Deave? Is this you? Is this really you?:puddle","Yeah, it's me buddy! I'm not really sure how I got here though.:deave","I met some weird dude on the other side. I don't think he likes me much. We were talking and suddenly he kicked me right up to the world of the living!","You're looking kind of gray. Is that normal?:puddle","Oooh! I see why you didn't recognise me! Weird. Maybe he did something to me.:deave","Are you ok bud?","I don't know, my dead best friend just came out of nowhere, grayed out and, well...:puddle","I've really missed you Deave.","I've missed you too, Puddle. I wish I could hug you, but not like this. I think it's best if you move on. I can't stay here long.:deave","I know... I'm happy to see you now, at least.:puddle","Thanks a lot dude me too. Can I ask you to help me move on? I need my colors and I'm getting a feeling one of them is near that snail. Can you ask him if he's seen them?:deave:1"],"a":["show:deave","give:t_start"]},{"l":["Hi, I'm Puddle, my friend over there is kind of trapped here.:puddle","I'm looking for his colors so I can help him cross over to the other side.","Did you see anything weird lately?","Oh hi there! I'm Lola! That's seems quite a story you got there!:snail","Well I've seen some colorful shards fall down from the sky around the time your friend arrived. That might be it?","Oh really?\\n That must be it! Did you see where they fell?:puddle","Yes! Near the well over there. You should check it out.:snail","Thank you so much Lola!:puddle:0"],"a":["give:t_snail"]},{"l":["You look around the well and see a small crater.:well","Beside the hole, a set of tiny footprints could be seen. They looked very mouselike.::0"],"a":["give:t_well"]},{"l":["Well I guess this is it...:deave","I guess so...:puddle","Listen, just because I'm gone, doesn't mean you have to be miserable.:deave","You've met some new people helping me. I'm sure you guys can be friends.","Don't let my death ruin your life, ok?","Yeah... You're right, I'm gonna try, for you.:puddle","Promise?:deave","Promise.:puddle","Brilliant! I have to go now.Thank you so much Puddle, I'll never forget it!:deave","Bye bud! See you soon - but not too soon!","Bye my friend!:puddle:0"],"a":["end"]},{"l":["I need my colors before I get back to the other side, can you find them?:deave"]},{"l":["Um, hello?:puddle","I can't! I'm going to kill him, I swear I'm going to kill him!:m1","Not with your small arms.:m2","Ummh! I'm sorry to bother you, but I'm looking for some color shards.:puddle","I followed some footsteps from the well and it led me to you. Did you see them? I really need them to help a friend.","I'm sure John found them. He likes 'taking' colorful things.:m2","Oh don't you dare! I don't care about your colored things!:m1","Please, I really need them. It's really important to me.:puddle","Alright, look, I actually do have one of them.:m1","Ha! I knew you weren't 'borrowing' anything.:m2","but I'm not going to give them to you unless I get the keys to the shop from my brother.:m1","It's not that I don't want to, it's that I don't have them, you do!:m2","Well, you see the issue here. Good luck on convincing this butthead.:m1","But... I don't know where your keys are...:puddle"]},{"l":["Are these yours?:puddle","There we go, I told you I didn't have them!:m2","You always think I'm a liar anyway so it doesn't matter.","Well for once it wasn't you!:m1","You know, you guys should not be fighting like this.:puddle","I just lost my best friend. It's been very difficult.","I regret not cherishing his life with me.","Don't be like me. Enjoy the time you have together, because when Death comes, apologies won't be enough.","I'm sorry about your friend and I guess you're right, I was too hard on you Doe.:m1","I'm sorry.","It's alright. *Hugs John* Just try to not lose the keys next time.:m2","Haha, very funny.\\nAnyway, here is your shard. Thank you for your help.:m1","Thank you, I'll go give it to him!:puddle:0"],"a":["give:color1"]},{"l":["Did you find our key?:m1"]},{"l":["Sorry, I can't talk right now!:lama"]},{"l":["Grr... I'm gonna kill him!:m1","I'd like to see that!:m2"]},{"l":["Oh man! I'm in so much trouble!:fox"]},{"l":["Please, can you help me?:fox","Yes, but I'm in a hurry. I'm looking for some color shards for my friend.:puddle","Oh! I found one of those earlier. If you help me write a small poem for my dear Suzy, I'll give it to you!:fox","Ok, what do you want to write about?:puddle","Well, I made a big mistake and I want to apologize, but I don't know how.:fox","Let me help with that!:puddle:0","Is this ok?:puddle","That's perfect! Thank you so much! I hope she can forgive me! Here's your color, my friend.:fox:1","Thanks and good luck! :puddle"],"a":["play:letter","give:color2"]},{"l":["Oh great, you found my beak's color! Let me try it on!:deave:0","Perfect! It looks great!"],"a":["color:color1"]},{"l":["Oh great, you found my feathers' color! Let me try it on!:deave:0","Perfect! It looks great!"],"a":["color:color2"]},{"l":["Hey, did you find a color shard around here?:puddle","A what?\\nNo, but since you're here, I need your help with something.:lama","To do what?:puddle","The race, obviously! I think I'm the best but the fox over there is doubting me!:lama","Would you mind trying it out? You just have to avoid crushing the eggs.","Well I'm in a rush, so maybe later.:puddle","Oh, come on, it only takes 20s, at least for me.\\nPlus if you beat me I'll give you something interesting.:lama","Ok... Let me try it.:puddle:0","Wow you're good!\\nWell, I guess I should get back to training.\\nHere's your prize!:lama:1","Thanks!:puddle"],"a":["play:race","give:key"]}],"objects":[{"id":"snail","s":"snail","x":4000,"a":[{"type":"msg","cond":"t_start","diag":1}]},{"id":"tb_deave","s":"tombstone","x":670,"a":[{"type":"msg","diag":0}]},{"id":"deave","s":"deave","x":800,"y":20,"hidden":true,"a":[{"type":"cond","c_color1":12,"c_color2":13,"bad":4},{"type":"msg","diag":3}]},{"id":"well","s":"well","x":2800,"a":[{"type":"msg","diag":2,"cond":"t_snail"}]},{"id":"m1","s":"mouse","x":1850,"a":[{"type":"cond","c_t_well":5,"bad":9},{"type":"cond","c_key":6,"bad":7}]},{"id":"m2","s":"mouse","x":2100,"mod":["0:3"],"flipped":true,"bShift":-90},{"id":"lama","s":"lama","x":5000,"a":[{"type":"cond","c_t_snail":14,"bad":8}]},{"id":"fox","s":"fox","x":2650,"a":[{"type":"cond","c_t_snail":11,"bad":10}]}]}`);function K(e,t){const C=e.scale||T;e.currAction=-1;let n=e.sprite;const i=v(n);e.height=i.length*C,e.width=i[0].length*C,e.mod&&e.mod.forEach(d=>{n=n.split(d[0]).join(d[2])});const{bs:s,bg:o,s:a}=D(n,e.scale);return e.animation&&(e.animation.tick=0),e.movAn&&(e.movAn.tick=0),e.el=$$("div"),e.el.classList.add(e.id),e.el.id=e.id,e.flipped&&e.el.classList.add("flipped"),e.el.style.cssText=V({bs:s,bg:o,s:a}),t.lev.appendChild(e.el),t.scene[e.id]=e,e}function fe(e,t,C,n){C.el=$$("div"),C.el.id=C.id,C.el.classList.add(t),C.flipped&&C.el.classList.add("flipped"),C.el.style.cssText=`animation-delay:${Math.random()}s;left:${C.x}px;bottom:${C.y}px;${V(n)}`,e.lev.appendChild(C.el)}function qe(e,t){const C=t.scale||T,n=t.sprites.map(r=>({sprite:r,...D(r,t.scale)})),i=v(t.sprites[0]),s=i[0].length*C,o=i.length*C;let a={x:t.x,y:t.y};const d=v(t.struct,r=>+r).reverse();for(let r in d){for(let l in d[r]){if(d[r][l]!==0){const h=n[d[r][l]-1],m={...t,...a,height:h.length*C,width:h.width,id:`${t.id}${r*d[r].length+l}`};fe(e,t.id,m,h)}a.x+=s}a.y+=o,a.x=t.x}}function Xe(e,t,C){t.forEach(n=>{if(n.struct)return qe(e,n);const i=n.scale||T;let s=n.sprite;n.mod&&n.mod.forEach(l=>{s=s.split(l[0]).join(l[2])});const o=[s,...n?.variants||[]].map(l=>({...D(l,n.scale),sprite:l,width:v(l)[0].length*i})),a=o.reduce((l,h)=>l>h.width?l:h.width,0);let d=n.x;const r=n.repeat?Math.ceil(C/a):1;for(let l=0;l<r;l++){const h=S(0,o.length),m=o[h],j={...n,x:d,y:n.spread?S(250,500):n.y,height:m.length*i,width:m.width,id:`${n.id}${r>1?"-"+l:""}`};fe(e,n.id,j,m),d+=j.width+(n.spread?S(100,300):0)}})}function Ke(e){e.col=[{x:0,y:e.canH,h:0,w:e.levW+A},{x:-10,y:0,h:e.canH,w:10},{x:e.levW,y:0,h:e.canH,w:10},...Object.values(e.scene).filter(t=>t.solid).map(({id:t,x:C,y:n,height:i,width:s})=>({x:C,y:n+e.canH-i,h:i,w:s,id:t}))]}function Ue(){const e=c.getIns();e.lev.innerHTML="",e.lev.style.width=`${B.width+A}px`,e.levW=B.width,e.diag=B.diag,Xe(e,B.bg.map(t=>({...t,...F[t.s],y:t.y||0})),B.width+A),B.objects.push(...[6e3,6600,7e3,7600,8200].map((t,C)=>({id:"egg"+C,s:"egg",x:t,solid:!0}))),B.objects.forEach(t=>K({...F[t.s],...t,y:t.y||0},e)),Ke(e)}const Ve=`Puddle has been through a tough time these days.
He has recently lost his best friend Deave in a flight accident.
After a few days of crying and mourning, he goes to his friend's grave to say goodbye to him one last time...`,ze=`After their last encounter Puddle never went to his friend's grave.
He followed his friend's advice and tried to live his life to the fullest.
Even though he made some new friends along the way, he never forgot Deave, the friend that reminded him who he was.

The End`;let k,U;const x={id:"puddle",...F.puddle,y:0,vx:0,vy:0,movS:[F.puddle.sprite,...F.puddle.movS,F.puddle.sprite]},pe=$(".fs"),me=$("#continue"),Qe={id:"actionButton",hidden:!0,hasBubble:!1,...F.actionButton};async function Ze(){await et(),$("#canvas").style.display="flex";const e=c.getIns();e.canW=e.canEl.offsetWidth,e.canH=e.canEl.offsetHeight,Be(),Ue(),e.actionButton=K(Qe,e),e.p=K(x,e),e.p.x=0,e.p.el.classList.add("p"),e.xOffset=100,e.autoX=500,y.getIns().playBgMusic(e)}async function je(){ye(),y.getIns().stopBgMusic();const e=c.getIns(),t=$(".fs-txt");t.innerHTML="";const C=e.scene.deave;C.el.style.transition="opacity 2s",C.hidden=!0,await u(2e3),e.p.el.classList.add("flipped"),e.xOffset=-100,e.autoX=-120;const n=$(".fs");n.style.cssText="visibility: visible; z-index: 3",await u(3e3),n.style.opacity=1,await u(2e3),await L(e,t,ze.split(""))}function Ge(e){if(e.key==="e"){const t=c.getIns();document.removeEventListener("keydown",Ge),clearTimeout(t.textTimeout),pe.style.opacity=0,me.style.visibility="hidden",U.resolve()}}function et(){U=R();const e=c.getIns();pe.style.cssText="visibility: visible; transition: none; opacity: 1";const t=$(".fs-txt");return document.addEventListener("keydown",Ge),L(e,t,Ve.split("")).then(()=>me.style.visibility="visible"),U.promise}function He(e){if(window.requestAnimationFrame(He),!(e<k+1e3/60)){var t=(e-k)/1e3;k=e,$e(t),De(),ke()}}async function tt(){$("#home").style.display="none",await Ze(),k=performance.now(),window.requestAnimationFrame(He)}const Ct=$("#start-btn"),Ee=document.querySelector("#home"),Q=$$("div");Q.id=x.id;x.el=Q;M(x,x.sprite);Ee.append(Q);const b={id:"deave",...F.deave},Z=$$("div");Z.id=b.id;b.el=Z;Ee.append(Z);M(b,b.sprite);Ct.addEventListener("click",tt);

</script>
    <style type="text/css">
#home{position:relative;display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;width:100%;padding:5%;background-color:#111}#home:before,#home:after{content:"";position:absolute;left:70px;bottom:20px;height:350px;width:350px;background-color:#81906c;border-radius:500px}#home:after{right:70px;left:auto;background-color:#d4b8b2}#home h1{font-size:80px;margin-bottom:0}#home h3{font-size:20px;margin-bottom:50px}#home #puddle{position:absolute;left:150px;bottom:70px;transform:scale(1.8)}#home #deave{position:absolute;z-index:2;right:310px;bottom:80px;transform:scale(2)}#home menu{display:flex;flex-direction:column;width:300px;padding:0}#home button{height:70px;display:flex;justify-content:center;align-items:center;background:none;border:3px solid #ebe8e2;color:#ebe8e2;border-radius:5px;margin-bottom:40px;transition:background-color .3s,color .3s;text-transform:uppercase;font-size:25px;line-height:25px}#home button:hover{background-color:#ebe8e2;color:#204d85;cursor:pointer}.commands,.guide,.arrows,.bottom-arrows{display:flex;justify-content:center;align-items:center}.commands>label{padding:10px;border-bottom:1px solid #ebe8e2}.guide{align-items:flex-start;margin-top:20px;padding:20px;border-radius:3px}.guide>*{width:230px}.commands,.arrows{flex-direction:column}.arrows{border-right:1px solid #ebe8e2;padding-right:40px;margin-right:40px}.arrows>label{display:block;width:100%}.key{position:relative;display:flex;align-items:center;justify-content:center;border:2px solid #ebe8e2;height:50px;width:50px;margin:12px;text-align:center;font-size:20px;line-height:44px;border-radius:5px}.arrow-right{transform:rotate(180deg)}.arrow-down{transform:rotate(-90deg)}.arrow-up{transform:rotate(90deg)}.key.e{margin:10px 0}.key.space{margin:10px 0;width:150px}#game{position:absolute;z-index:2;display:none;align-items:center;justify-content:center;flex-direction:column;height:350px;width:950px;border:5px solid black;border-radius:10px;color:#ebe8e2;background:rgb(50,50,50)}.bg:after{content:"";position:absolute;height:100%;width:100%;background-color:#00000080!important}#letters{display:flex;align-items:center;justify-content:center;font-size:40px;text-transform:uppercase}@keyframes shrink{0%{opacity:1;height:100px;width:100px}to{opacity:1;height:50px;width:50px}}.key:before{opacity:0;content:"";position:absolute;display:block;height:100px;width:100px;font-size:20px;line-height:20px;border-radius:5px;border:4px solid #ef7e45}.key.active:before{animation:linear .7s shrink}#play{margin-top:20px;color:#fff;font-size:20px}*,*:before,*:after{font-family:sans-serif;box-sizing:border-box}html,body{height:100%;width:100%;margin:0;padding:0;background:#111;color:#ebe8e2;display:flex;justify-content:center;align-items:center;overflow:hidden}@keyframes float{0%{transform:translateZ(0)}50%{transform:translate3d(0,20px,0)}}.cloud,.deave{animation:linear 5s infinite float}#canvas{display:none;position:relative;max-height:640px;height:100%;width:100%;overflow:hidden;color:#363c3d;transition:opacity .3s}.fs{position:absolute;top:0;left:0;height:100%;width:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;visibility:hidden;background:#111;padding:0 15%;color:#ebe8e2;font-size:30px;transition:opacity 2s;opacity:0}.fs-txt{width:100%;text-align:left}#continue{display:block;visibility:hidden;font-size:24px;width:100%;text-align:right;margin-top:50px}#inv{position:absolute;top:0;right:0;padding:20px;display:flex}#inv .slot{position:relative;border:5px solid #363c3d;height:50px;width:50px;background-color:#ebe8e2;margin-right:20px}#inv .slot *{position:absolute;bottom:0}#inv .slot #color1,#inv .slot #color2{transform:scale(.3);bottom:2px;left:5px}#inv .slot #key{transform:scale(.17) rotate(90deg) translate(-155px);bottom:5px;left:9px}#level{position:absolute;bottom:0;left:0;height:100%;width:2000px;background-color:#a6dde3;border-bottom:10px solid #5c4b4b}#level:before{content:"";position:absolute;height:150px;width:100%;bottom:0;background-color:#405351}#level *{position:absolute;transition:opacity .3s}#level .deave{opacity:0;transition:all 3s}#bubble{position:absolute;z-index:999;padding:20px 20px 25px;background:#ebe8e2;border:5px solid #343a40;color:#343a40;border-radius:5px;width:300px;min-height:50px;font-size:18px;transition:all .3s}#bubble:before{content:"";display:inline-block;position:absolute;left:-5px;bottom:-15px;height:0;width:0;border-top:15px solid #414141;border-right:15px solid transparent}#bubble.continue:after{content:"Press E to continue";display:block;position:absolute;right:5px;bottom:5px;font-size:12px;color:#204d85;font-weight:700}.p.right{transform:none}.p.left #bubble{transform:rotateY(180deg)}#bubble.reverse,#bubble.reverse:after,#bubble.reverse div{transform:rotateY(180deg)}.p.left #bubble:before{left:auto;right:0;border-top:15px solid #363c3d;border-left:15px solid transparent;border-right:none}#bubble.reverse:after{right:auto;left:5px}.flipped{transform:rotateY(180deg)}.p.flipped{transform:rotateY(180deg) translate3d(-90px,0,0)}

</style>
  </head>
  <body>
    <div id="home">
      <h1>The Last Tear</h1>
      <h3>a short story by Corentin Pillet</h3>
      <menu> <button id="start-btn">Start</button> </menu>
      <div class="commands">
        <label>Commands</label>
        <div class="guide">
          <div class="arrows">
            <label>Movements:</label>
            <div class="key arrow-up">&lt;</div>
            <div class="bottom-arrows">
              <div class="key arrow-left">&lt;</div>
              <div class="key arrow-down">&lt;</div>
              <div class="key arrow-right">&lt;</div>
            </div>
          </div>
          <div class="action">
            <label>Action:</label>
            <div class="key e">E</div>
            <br />
            <label>Jump:</label>
            <div class="key space">Space</div>
          </div>
        </div>
      </div>
    </div>
    <div class="fs">
      <div class="fs-txt"></div>
      <div id="continue">Press E to continue</div>
    </div>
    <div id="game">
      <div id="letters">Ready ?</div>
      <i id="play">Press enter</i>
    </div>
    <div id="canvas">
      <div id="level"></div>
      <div id="inv"></div>
    </div>
  </body>
  
</html>
