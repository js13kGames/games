<!doctype html><title>The last link</title><link rel=icon type=image/png href=icon.png><link rel=manifest href=m.json><meta name=viewport content="width=device-width,maximum-scale=1,user-scalable=no"><meta name=theme-color content=#000><style>:root{--c-b:#000;--c-w:#fff;--c-br:#754;--c-sh:#000000ab;--c-y:#dc6;--c-g:#d9e0e3;--d-t:49px}*{margin:0;padding:0}body,html{background:var(--c-b);font-family:Arial;overflow:hidden;position:fixed;user-select:none}div{box-sizing:border-box}.wh{width:100%;height:100%}button{background:0 0;border:0;cursor:pointer}.ce{align-items:center;display:flex;justify-content:center}.s{background:var(--c-w);overflow:hidden;position:relative}.bw{background:var(--c-y)}.bw.red{background:var(--c-red)}.bw.blue{background:var(--c-blue)}.cl{background:var(--c-w);border-radius:50% 50% 0 0;font-weight:700;height:40px;padding-top:0;position:absolute;right:-10px;top:30px;transform:rotate(-90deg);width:50px;z-index:3}.tu{border:5px solid var(--c-w);color:var(--c-w);font-size:35px;font-weight:700;height:85px;opacity:0;position:absolute;text-align:center;line-height:.8;width:50%;z-index:3}.tu.red{background:var(--c-red)}.tu.blue{background:var(--c-blue)}.tu.to{border-radius:0 0 50% 50%;top:-10px}.tu.bo{border-radius:50% 50% 0 0;bottom:-10px}.tu.sh{animation:bIn 1.5s both}.sc{background:var(--c-w);border-radius:50% 50% 0 0;bottom:40px;font-weight:700;height:40px;left:-15px;position:absolute;transform:rotate(90deg);width:65px}.sc span{transform:rotate(180deg)}.sc span:first-child{margin-right:10px}.sc span:first-child:before{color:var(--c-b);content:'-';height:25%;left:-40%;position:absolute;top:0;width:25%}.sc-red{color:var(--c-red)}.sc-blue{color:var(--c-blue)}.bc{background:var(--c-sh);color:var(--c-w);position:absolute;z-index:2}.bc span{animation:bIn 1.5s both;font-size:120px;font-weight:700;text-align:center;text-shadow:9px 11px 4px var(--c-sh);text-transform:uppercase}.bc.hi{display:none}.bc.red{background:var(--c-red)}.bc.blue{background:var(--c-blue)}.b{border:10px solid var(--c-b);position:relative;width:100%;background:var(--c-w);background-image:linear-gradient(45deg,var(--c-br) 25%,transparent 26%,transparent 75%,var(--c-br) 75%,var(--c-br)),linear-gradient(45deg,var(--c-br) 25%,transparent 26%,transparent 75%,var(--c-br) 75%,var(--c-br));background-size:calc(var(--d-t) * 2) calc(var(--d-t) * 2);background-position:0 0,var(--d-t) var(--d-t);z-index:0;transition:all 2s ease}.b.ro{transform:rotate(180deg)}.t-e,.t-p{height:calc(var(--d-t) - 3px);position:absolute;width:calc(var(--d-t) - 3px);z-index:1}.t-e{transition:all .5s ease}.t-e.sel{background:var(--c-y)}.t-e.re{transform:scale(0)}.t-e:after,.t-p:after{animation:bIn 1.5s both;background:var(--c-y);border-radius:50%;content:'';height:calc(var(--d-t) - 10px);left:8%;position:absolute;top:8%;width:calc(var(--d-t) - 10px)}.t-e.blue:after,.t-e.red:after{border:4px solid var(--c-b);box-shadow:2px 3px 2px var(--c-sh);height:calc(var(--d-t) - 20px);left:15%;top:15%;width:calc(var(--d-t) - 20px);z-index:-1}.b.ro .t-e.blue:after,.b.ro .t-e.red:after{box-shadow:-2px -3px 2px var(--c-sh)}.b.ro .t-e.blue::before,.b.ro .t-e.red::before{transform:rotate(180deg)}.t-e:disabled,.t-e[disabled]{color:var(--c-b)}.t-e.blue:before,.t-e.red:before{background:url(/s.png) -16px 0;content:'';height:16px;left:17px;position:absolute;top:17px;width:16px;z-index:10}.t-e.blue.c:before,.t-e.red.c:before{background:url(/s.png) 0 0}.t-e.blue.bl:before,.t-e.red.bl:before{background:url(/s.png) -32px 0}.t-e.blue.r:after,.t-e.red.r:after{animation:rotate 2s linear infinite;border-style:dashed}.t-e.blue.di,.t-e.red.di{opacity:.2}.t-e.blue:after{background:var(--c-blue)}.t-e.red:after{background:var(--c-red)}.t-p{display:none}.t-p.v{display:block}.lo{flex-direction:column;justify-content:flex-start}.ti{background:var(--c-y);color:var(--c-w);flex-direction:column;font-size:40px;font-weight:700;height:25%;margin-bottom:5%;position:relative;text-align:center;text-shadow:3px 6px 2px var(--c-sh);text-transform:uppercase;width:100%}.ti span{font-size:60px;display:block;margin-bottom:10px}.ti-bt{position:absolute;top:15px;right:10px}.ti-bt button{font-size:30px;margin-right:10px}.cb{flex-direction:column;height:60%;justify-content:space-evenly;width:100%}.cb .btn{animation-fill-mode:both;animation-name:bInL;font-size:18px;height:50px;justify-content:space-between;margin-bottom:10px;padding:0 20px;width:70%}.cb .btn:first-child{animation-duration:.5s}.cb .btn:nth-child(2){animation-duration:1s}.cb .btn:nth-child(3){animation-duration:1.5s}.cb .btn:nth-child(4){animation-duration:2s}.cb .btn:nth-child(5){animation-duration:2.5s}.cb .btn:nth-child(6){animation-duration:3s}.cb .btn span{font-size:25px}.btn{border-radius:10px;border:none;color:var(--c-w);font-weight:700;margin-bottom:10px;text-align:center}.btn.blue{background:#2ae;box-shadow:0 5px var(--c-blue)}.btn.blue:active{box-shadow:0 1px var(--c-blue)}.btn.red{background:#c66;box-shadow:0 5px var(--c-red)}.btn.red:active{box-shadow:0 1px var(--c-red)}.mo{animation:bIn .5s both;background:var(--c-g);border-radius:10px;color:var(--c-b);flex-direction:column;height:40%;position:relative;width:80%}.se{display:none;flex-direction:column;padding:20px;text-align:center}.frm input{border-radius:10px 0 0 10px;border:0;font-size:20px;margin:20px 0;padding:10px;width:80%}.frm .btn{height:45px;margin-top:5px;width:20%}.se.so{display:flex}.clm{height:30px;position:absolute;right:10px;top:10px;width:40px}.cta{height:50px;margin-bottom:20px;width:60%}.co{flex-wrap:wrap;position:relative;width:100%}.co .t-e{background:var(--c-br);border:1px solid var(--c-w);flex:1 0 21%;height:calc(var(--d-t) * 2.2);position:relative;width:calc(var(--d-t) * 2.2)}.co .t-e.blue:after,.co .t-e.red:after{height:var(--d-t);width:var(--d-t);left:20%;top:20%}.co .t-e.blue:before,.co .t-e.red:before{transform:scale(2);left:42%;top:39%}.tp{background:var(--c-sh);display:none;flex-wrap:wrap;height:calc(var(--d-t) * 2.2);left:0;position:absolute;top:0;transition:all .5s ease;width:calc(var(--d-t) * 2.1);z-index:2}.tp.sht{display:flex}.tp.tpr{transform:rotate(180deg)}.tp .t-p{display:block;position:relative;visibility:hidden}.tp .t-p.v{visibility:visible}.ch{background:var(--c-w);bottom:-70px;height:15%;left:15%;outline:10px solid var(--c-b);padding:0 10px;position:absolute;width:70%}.ch-w{display:flex;overflow-x:scroll;scrollbar-width:none;width:100%}.ch-w::-webkit-scrollbar{width:0!important}.ems{font-size:30px;margin:10px 3px;padding:0 5px}.ems:disabled{opacity:.2}.ems.seb:disabled{animation:bIn 1s both;background:var(--c-sh);filter:drop-shadow(2px 4px 6px var(--c-b));color:var(--c-y)}.ch-s{position:absolute;top:-80px;left:40%;font-size:60px;display:none}.ch-s.an{display:block;animation:bIn 1.5s both}.fof{font-size:30px;font-weight:700;height:var(--d-t);position:absolute;text-shadow:4px 2px 3px var(--c-b);width:var(--d-t)}.co .fof{font-size:50px;height:calc(var(--d-t) * 2);width:calc(var(--d-t) * 2);z-index:2}.b.ro .fof{transform:rotate(180deg)}.fof span:first-child{color:var(--c-y);animation:fUp 1.5s both}.fof span:nth-child(2){color:var(--c-blue);animation:fUp 2.5s both}.fof span:nth-child(3){color:var(--c-red);animation:fUp 3.5s both}@keyframes rotate{to{transform:rotate(360deg)}}@keyframes bIn{20%,40%,60%,80%,from,to{animation-timing-function:cubic-bezier(0.215,0.61,0.355,1)}0%{opacity:0;transform:scale3d(.3,.3,.3)}20%{transform:scale3d(1.1,1.1,1.1)}40%{transform:scale3d(.9,.9,.9)}60%{opacity:1;transform:scale3d(1.03,1.03,1.03)}80%{transform:scale3d(.97,.97,.97)}to{opacity:1;transform:scale3d(1,1,1)}}@keyframes bInL{60%,75%,90%,from,to{animation-timing-function:cubic-bezier(0.215,0.61,0.355,1)}0%{opacity:0;transform:translate3d(-3000px,0,0)}60%{opacity:1;transform:translate3d(25px,0,0)}75%{transform:translate3d(-10px,0,0)}90%{transform:translate3d(5px,0,0)}to{transform:translate3d(0,0,0)}}@keyframes fUp{from{opacity:1}to{opacity:0;transform:translate3d(0,-150%,0)}}</style><body class="wh ce"><div class="s ce"></div><script src=/socket.io.js></script><script src=shared.js></script><script>"use strict";let zzfx,zzfxV,zzfxX,zzfxR;zzfxV=.3,zzfx=(t=1,e=.05,o=220,n=0,r=0,c=.1,a=0,i=1,s=0,l=0,d=0,u=0,m=0,h=0,p=0,b=0,f=0,v=1,g=0,y=0)=>{let w,x,k=2*Math.PI,T=s*=500*k/zzfxR**2,z=(0<p?1:-1)*k/4,$=o*=(1+2*e*Math.random()-e)*k/zzfxR,M=[],E=0,P=0,R=0,j=1,A=0,C=0,I=0;for(l*=500*k/zzfxR**3,p*=k/zzfxR,d*=k/zzfxR,u*=zzfxR,m=zzfxR*m|0,x=(n=99+zzfxR*n)+(g*=zzfxR)+(r*=zzfxR)+(c*=zzfxR)+(f*=zzfxR)|0;R<x;M[R++]=I)++C%(100*b|0)||(I=a?1<a?2<a?3<a?Math.sin((E%k)**3):Math.max(Math.min(Math.tan(E),1),-1):1-(2*E/k%2+2)%2:1-4*Math.abs(Math.round(E/k)-E/k):Math.sin(E),I=(m?1-y+y*Math.sin(2*Math.PI*R/m):1)*(0<I?1:-1)*Math.abs(I)**i*t*zzfxV*(R<n?R/n:R<n+g?1-(R-n)/g*(1-v):R<n+g+r?v:R<x-f?(x-R-f)/c*v:0),I=f?I/2+(f>R?0:(R<x-f?1:(x-R)/f)*M[R-f|0]/2):I),E+=(w=(o+=s+=l)*Math.sin(P*p-z))-w*h*(1-1e9*(Math.sin(R)+1)%2),P+=w-w*h*(1-1e9*(Math.sin(R)**2+1)%2),j&&++j>u&&(o+=d,$+=d,j=0),!m||++A%m||(o=$,s=T,j=j||1);return(t=zzfxX.createBuffer(1,x,zzfxR)).getChannelData(0).set(M),(o=zzfxX.createBufferSource()).buffer=t,o.connect(zzfxX.destination),o.start(),o},zzfxX=new(window.AudioContext||webkitAudioContext),zzfxR=44100,(()=>{const t=document.querySelector.bind(document),e=document.querySelectorAll.bind(document),o=(e="#000")=>{const o=t("meta[name=theme-color]");o&&o.setAttribute("content",e)},n=(t,e,o,n={})=>{t&&t.addEventListener(e,o,n)},r=(t,e)=>{if(t)for(let o in e)t.style[o]=e[o]},c=t=>{t&&t.parentNode.removeChild(t)},a=(t,e)=>{t.innerHTML=e},i=(t,e)=>t.classList.contains(e),s=(t,e)=>{t&&e.split(" ").forEach((e=>{t.classList.add(e)}))},l=(t,e)=>{t&&e.split(" ").forEach((e=>{t.classList.remove(e)}))},d=(t,e)=>{var o;return function(){clearTimeout(o),o=setTimeout(t,e)}},u=(t,e,o)=>{let n=0;const r=setInterval((()=>{n++,n>e&&clearInterval(r),t(n)}),o);return r},m=[412,732],h=["üòÉ","ü§î","üò¥","üò±","üò≠","üò°","üíÄ","üî•","üéä","üí™","üëè","üëç"],p={blue:"#28c",red:"#a55"},b=guid(),f="share"in navigator;let v,g=0,y=!1,w="",x=!0;const k=t=>{x&&zzfx(...{click:[,,1675,,.06,.24,1,1.82,,,837,.06],interval:[,,1090,,.01,.13,,1.4,,,513,.08,,,,,,.65,.05],endGame:[,,20,.04,,.6,,1.31,,,-990,.06,.17,,,.04,.07],tokenMove:[,,150,.05,,.05,,1.3,,,,,,3],removeToken:[,,925,.04,.3,.6,1,.3,,6.27,-184,.09,.17],emoji:[,.5,847,.02,.3,.9,1,1.67,,,-294,.04,.13,,,,.1],king:[,,80,.3,.4,.7,2,.1,-.73,3.42,-430,.09,.17,,,,.19]}[t])},T=(t,e)=>`rgb(${{red:[150+10*e,85,85],blue:[34,136,180+10*e]}[t].join(" ")})`,z=()=>{const r=()=>{[...e(".se")].forEach((t=>l(t,"so"))),a(t("#se-1"),""),t(".frm input").value=""},c=(e="",o=!1,n=!1)=>{j({type:4===g?2:3,localRoom:String(e),table:o,createRoom:n}),r(),s(t("#se-1"),"so"),a(t("#se-1"),`<h1>CODE: ${e}</h1><p>üîç Waiting for friend to connect üîé</p>`),v&&!o&&5===g&&v.on("dT",(()=>{alert("The board has been disconnected so the game cannot be started :("),s(t(".bc"),"hi"),R()}))};a(t(".s"),`<div class='lo wh ce'>\n        <div class='bc wh ce hi'>\n    <div class='mo ce'>\n      <button class='btn blue clm'>X</button>\n      <h2></h2>\n      <div class='se ce so' id=se-1></div>\n      <div class='se ce' id=se-2>\n        <button class='btn blue cta'></button>\n        <form class='ce frm'>\n          <input type='number' placeholder='Table code'/>\n          <button type='submit' class='btn red'>Join</button>\n        </form>\n      </div>\n      </div></div>\n        <div class='ti ce'><span>üîó</span>The last link\n        <div class='ti-bt ce'>\n          ${f?"<button id=shr title=Share>üìÆ</button>":""}\n          <button id=sou title=Sounds>${x?"üîä":"üîá"}</button>\n        </div></div>\n        <div class='cb ce'>\n          ${["<span>üì¥</span> PLAY OFFLINE","<span>üïπ</span> VS BOT","<span>ü§ñ</span> BOT VS BOT","<span>üåé</span> PLAY ONLINE","<span>ü§ù</span> PLAY WITH A FRIEND","<span>üéâ</span> PARTY MODE"].map(((t,e)=>`<button class='btn ${e<3?"red":"blue"} ce'>${t}</button>`)).join("")}\n        </div>\n        <h3>Developed by: <a href='https://twitter.com/ostjh' target='_blank' rel='noopener noreferrer'>Jorge Rubiano</h3>\n      </div>`),[...e(".lo .cb button")].forEach(((e,o)=>n(e,"click",(()=>{k("click"),g=o,o<=2?E(o):navigator.onLine?(r(),l(t(".bc"),"hi"),s(t("#se-"+(3===o?1:2)),"so"),t(".mo h2").textContent=["Play online!","Play with a friend!","Party mode!"][g-3],3===o?(j({type:1}),a(t("#se-1"),"<p>üîç Looking for an opponent üîé</p><p>This may take a few seconds, if you can't find an opponent you can create a room and play with a friend</p>")):t(".cta").textContent=4===o?"CREATE ROOM":"CREATE TABLE"):alert("Sorry, you must have an internet connection for this option")})))),f&&n(t("#shr"),"click",(t=>{t.preventDefault(),k("click"),navigator.share({title:"The last link",text:"Play The last link #js13k 2020 edition by Jorge Rubiano @ostjh",url:location.href}).then((()=>{alert("Thanks for sharing")})).catch((t=>{alert(t)}))})),n(t("#sou"),"click",(()=>{x=!x,t("#sou").textContent=x?"üîä":"üîá",k("click")})),n(t(".clm"),"click",(()=>{k("click"),s(t(".bc"),"hi"),R()})),n(t(".frm"),"submit",(e=>{k("click"),e.preventDefault();const o=t(".frm input").value;isNaN(o)||5!==o.length?(alert("The code is not valid"),t(".frm input").focus()):c(o)})),n(t(".cta"),"click",(()=>{k("click"),c(randomNumber(1e4,99999),5===g,!0)})),o()},$=(e,o,n="b")=>{const r=guid(),a=document.createElement("div");a.className="fof ce",a.id="f-"+r,a.style.left=e,a.style.top=o,a.innerHTML="404".split("").map((t=>`<span>${t}</span>`)).join(""),n&&(t("."+n).appendChild(a),setTimeout((()=>{t("#f-"+r)&&c(t("#f-"+r))}),4e3))},M=(c,d)=>{const m=Object.keys(p)[c];let h=!1,f=!1;const g=c===d;let y=[];const x=t=>({row:t<4?t:t<8?t-4:t-8,col:t<4?0:t<8?1:2}),T=()=>{[...e(".t-e")].forEach((t=>{t.disabled=!0,s(t,"di"),l(t,"r bl")}))};a(t(".s"),`<div class='bw wh ce ${m}'>\n        <button class=cl>EXIT</button>\n        <div class='bc wh ce'><span></span><button class=cl>EXIT</button></div>\n        <div class='tu bo ce ${m}'>Your turn</div>\n        <div class='co ce'>\n          <div class='tp ce ${g?"tpr":""}'>${[...new Array(4)].map(((t,e)=>`<button class=t-p id=tg-${e}></button>`)).join("")}</div>\n          ${[...new Array(12)].map(((t,e)=>`<button color=${m} disabled class='t-e cc-${e} ${m} di'id=o-${e}></button>`)).join("")}\n        </div>\n      </div>`),["t-p","t-e"].forEach((o=>{[...e("."+o)].forEach((o=>{n(o,"click",(o=>{const n=o.target.id.split("-");if(!h)if(k("click"),"o"===n[0]){[...e(".t-p")].forEach((t=>{l(t,"v")}));const o=+n[1],{row:c,col:a}=x(o);let i=f?y.filter((t=>t[0].counter===o))[0]:y.filter((t=>t.counter===o))[0];f&&(i={...i[0],availableMoves:i[1]}),i&&(s(t(".tp"),"sht"),r(t(".tp"),{left:100*c+3*c+"px",top:100*a+8*a+"px"}),h=!0,v.emit("mV",{type:3,user:b,color:m,removeToken:f,id:i.id,room:w,data:i}))}else{const[e,n,r,c]=o.target.getAttribute("p").split("-");h=!0,v.emit("mV",{type:1,user:b,color:m,room:w,movement:[+e,+n,+r,""===c?-1:+c]}),T(),l(t(".tp"),"sht")}}))}))}));const M=u((e=>{k("interval");const o=3-e-2+3;t(".bc span").textContent=o,o||s(t(".bc"),"hi")}),3,500);n(t(".cl"),"click",(()=>{k("click"),M&&clearInterval(M),v&&R(),z()})),o(p[m]),v&&(v.on("aC",(e=>{if(h=!1,T(),l(t(".tp"),"sht"),l(t(".tu."+m),"sh"),y=e.data,f=e.removeToken||!1,e.color===m?(s(t(".tu."+m),"sh"),f?y.forEach((e=>{t("#o-"+e[0].counter).disabled=!1,l(t("#o-"+e[0].counter),"di"),s(t("#o-"+e[0].counter),"r")})):y.forEach((e=>{t("#o-"+e.counter).disabled=!1,l(t("#o-"+e.counter),"di"),e.isKing&&!i(t("#o-"+e.counter),"c")&&(s(t("#o-"+e.counter),"c"),k("king"))}))):f&&y.forEach((e=>{e[1].forEach((e=>{s(t("#o-"+e.counter),"bl"),l(t("#o-"+e.counter),"di")}))})),e&&e.tokenRemove&&Object.keys(e.tokenRemove)&&e.tokenRemove.c===m&&t("#o-"+e.tokenRemove.counter)){k("removeToken"),s(t("#o-"+e.tokenRemove.counter),"re");const{row:o,col:n}=x(e.tokenRemove.counter);$(100*o+3*o+"px",100*n+8*n+"px","co"),"vibrate"in navigator&&navigator.vibrate(500)}})),v.on("sT",(e=>{h=!1,e.color===m&&e.data.availableMoves.forEach((({target:o,col:n,row:r,id:c=""})=>{t("#tg-"+o).setAttribute("p",`${n}-${r}-${e.data.id}-${c}`),s(t("#tg-"+o),"v")}))})),v.on("gT",(e=>{""!==e.scoreText&&s(t(".bc"),e.scoreText),l(t(".bc"),"hi"),t(".bc span").textContent=e.scoreText?e.scoreText+" win":"Tied game",k("endGame"),o(""!==e.scoreText?p[e.scoreText]:"#000")})),v.on("gD",(t=>{const e=t&&t.roomData&&t.roomData.table&&t.roomData.table.id||"";t.userDisconnected===e&&(alert("Sorry the board has been disconnected :("),R(),z())})))},E=(f=0,g={baseColor:0,initialTurn:0,isPartyMode:!1})=>{const y=f>2,x=Math.round(m[0]/8-3),T=Object.keys(p);let M=!1;const E=y?+!g.baseColor:randomNumber(0,1),P=T[E],j=T[+!E],A={[P]:{score:12,human:!0,local:!y,counter:11},[j]:{score:12,human:!0,local:!0,counter:0}};2===f&&(A[j].human=!1),1!==f&&2!==f||(A[P].human=!1);let C,I=[],O=!1,L=y?g.initialTurn:randomNumber(0,1),N=0;const D=u((e=>{const o=3-e-2+3;k("interval"),t(".bc span").textContent=o,o||(s(t(".bc"),"hi"),H(Z(T[L]).map((t=>t.id))),G(),A[T[L]].human||Y())}),3,500),V=[...new Array(8)].map(((t,e)=>[...new Array(8)].map(((t,o)=>e<3||e>4?e%2?o%2?{}:{c:e<3?P:j,id:N++,d:e<3?1:-1,col:e,row:o,counter:e<3?A[P].counter--:A[j].counter++,arrival:e<3?7:0}:o%2?{c:e<3?P:j,id:N++,d:e<3?1:-1,col:e,row:o,counter:e<3?A[P].counter--:A[j].counter++,arrival:e<3?7:0}:{}:{})))),S=()=>{const e=Object.keys(A),o=A[e[0]].score===A[e[1]].score?"":A[e[0]].score>A[e[1]].score?e[0]:e[1];""!==o&&s(t(".bc"),o),k("endGame"),l(t(".bc"),"hi"),t(".bc span").textContent=o?o+" win":"Tied game",g.isPartyMode&&v.emit("mV",{type:4,room:w,scoreText:o})},X=e=>{const o=U(e);if(o.c===T[L]){const n=i(t("#o-"+o.id),"r")?I.filter((t=>t[0].id===e))[0][1]:Q(o);n.length&&n.forEach((({col:e,row:n,id:c=""},a)=>{const i=t("#tg-"+a);i.setAttribute("p",`${e}-${n}-${o.id}-${c}`),s(i,"v"),r(i,{left:n*x+"px",top:e*x+"px"})}))}},B=(e,o,a,d=-1)=>{const u=U(a),{hasListener:m=!1}=V[u.col][u.row];W(),l(t("#o-"+a),"sel"),k("tokenMove");let h={};d>=0&&(h=U(d),V[h.col][h.row]={},s(t("#o-"+d),"re"),$(h.row*x+"px",h.col*x+"px"),(!g.isPartyMode&&h.c===j&&2!==f||0===f)&&"vibrate"in navigator&&navigator.vibrate(500),k("removeToken")),V[e][o]={...V[u.col][u.row],row:o,col:e,hasListener:m,counterTransition:0,removedToken:d>=0,tokenRemove:h},V[u.col][u.row]={},O=!0,r(t("#o-"+a),{left:o*x+"px",top:e*x+"px"}),m||n(t("#o-"+a),"transitionend",(e=>{const{propertyName:o}=e;if("transform"===o)c(t("#"+e.target.id));else if("left"===o||"top"===o){const o=U(+e.target.id.split("-")[1]);if(2==++V[o.col][o.row].counterTransition){o.arrival!==o.col||i(t("#"+e.target.id),"c")||(V[o.col][o.row].isKing=!0,s(t("#"+e.target.id),"c"),k("king")),O=!1,V[o.col][o.row].removedToken&&(A[T[+!L]].score--,t(".sc-"+T[+!L]).textContent=(A[T[+!L]].score<=9?"0":"")+A[T[+!L]].score),!!V[o.col][o.row].removedToken&&0!==_().length||(L=+!L),I=_();const n=I.length?I:Z(T[L]);H(n.map((t=>I.length?t[0].id:t.id))),I.forEach((e=>{s(t("#o-"+e[0].id),"r"),e[1].forEach((e=>{s(t("#o-"+e.id),"bl")}))})),G(n.length||I.length),n.length||I.length?(A[T[L]].human||Y(),g.isPartyMode&&(v.emit("mV",{type:2,user:b,room:w,color:T[L],tokenRemove:V[o.col][o.row].tokenRemove,removeToken:!!I.length,data:I.length?I:n.map((t=>({...t,availableMoves:Q(t)})))}),P===T[L]?s(t(".b"),"ro"):l(t(".b"),"ro"))):S()}}}))},Y=d((()=>{let t=0,e={};if(I.length){const o=randomNumber(0,I.length-1);t=I[o][0];const n=I[o][1];e=n[randomNumber(0,n.length-1)]}else{const o=Z(T[L]);t=o[randomNumber(0,o.length-1)];const n=Q(t);e=n[randomNumber(0,n.length-1)]}const o=null===e.id||void 0===e.id?-1:e.id;y?(M=!0,v.emit("mV",{type:1,user:b,room:w,movement:[e.col,e.row,t.id,o]})):B(e.col,e.row,t.id,o)}),y?0:500),G=(e=!0)=>{l(t(".bw"),T[+!L]),l(t(".tu."+T[+!L]),"sh"),e&&(s(t(".bw"),T[L]),g.isPartyMode||(s(t(".tu."+T[L]),"sh"),t(".tu."+T[L]).textContent=y&&!g.isPartyMode?"10":"Your turn"),o(p[T[L]]),y&&!g.isPartyMode&&(C=u((e=>{const o=9-e+1;o<=3&&k("interval"),o>=0&&(t(".tu."+T[L]).textContent=(o<=9?"0":"")+o,0===o&&A[T[L]].local&&Y())}),10,1e3)))},H=(e=[])=>{let o=!1;const n=T[L],r=T[+!L];[F(r),F(n)].forEach(((r,c)=>{r.forEach((({id:r})=>{const a="#o-"+r;t(a).disabled=c?!(A[n].human&&A[n].local||g.isPartyMode)||(e.length?!e.includes(r):!c):!c,l(t(a),"r bl di"),!c||t(a).disabled||o||g.isPartyMode||(t(a).focus(),o=!0),c&&(A[n].human&&A[n].local||g.isPartyMode)&&t(a).disabled&&s(t(a),"di")}))}))},F=t=>V.map((e=>e.filter((e=>Object.keys(e).length&&e.c===t)))).filter((t=>t.length)).reduce(((t,e)=>[...t,...e]),[]),J=t=>t>=0&&t<8,K=(t,e)=>0===Object.keys(V[t][e]).length,W=()=>{[...e(".t-p")].forEach((t=>{l(t,"v")}))},q=(t=!0)=>{[...e(".ems")].forEach((e=>{e.disabled=t}))},U=t=>{for(let e=0;e<8;e++)for(let o=0;o<8;o++)if(Object.keys(V[e][o]).length&&V[e][o].id===t)return V[e][o]},_=()=>F(T[L]).map((t=>{const e=Q(t,!0).filter((t=>J(t.col+t.direction)&&J(t.row+t.position)&&K(t.col+t.direction,t.row+t.position))).map((t=>({...t,col:t.col+t.direction,row:t.row+t.position})));return e.length?[t,e]:[]})).filter((t=>t.length&&t[1].length)),Q=({isKing:t=!1,col:e,row:o,d:n,c:r},c=!1)=>[1,-1].map(((a,i)=>[1,-1].map(((s,l)=>!(!t&&a!==n||!J(e+a)||!J(o+s)||!(!c&&K(e+a,o+s)||c&&!K(e+a,o+s)&&V[e+a][o+s].c!==r))&&{col:e+a,row:o+s,direction:a,position:s,id:V[e+a][o+s].id,counter:V[e+a][o+s].counter,target:i+l+i})).filter((t=>t)))).reduce(((t,e)=>[...t,...e]),[]),Z=t=>F(t).filter((t=>Q(t).length));a(t(".s"),`<div class='bw wh ce'>\n        <button class=cl>EXIT</button>\n        ${["to","bo"].map(((t,e)=>`<div class='tu ${t} ce ${e?j:P}'></div>`)).join("")}\n        <div class='sc ce'>${[P,j].map((t=>`<span class=sc-${t}>${A[t].score}</span>`)).join("")}</div>\n        <div class=b style='height : ${8*x+20}px'>\n          ${V.map((t=>t.map((t=>Object.keys(t).length?`<button color=${t.c} disabled class='t-e ${g.isPartyMode?"cc-"+t.counter:""} ${t.c}' style='left : ${t.row*x}px; top : ${t.col*x}px;' id=o-${t.id}></button>`:"")).join(""))).join("")}${[...new Array(4)].map(((t,e)=>`<button class=t-p id=tg-${e}></button>`)).join("")}${y&&!g.isPartyMode?`<div class='ch-s'></div><div class='ch'><div class='ch-w'>${h.map(((t,e)=>`<button id=em-${e} class='ems'>${t}</button>`)).join("")}</div></div>`:""}\n        </div>\n        <div class='bc wh ce'><span></span><button class=cl>EXIT</button></div>\n      </div>`),["t-p","t-e"].forEach((t=>{[...e("."+t)].forEach((e=>{("t-e"!==t||A[e.getAttribute("color")].human&&A[e.getAttribute("color")].local&&!g.isPartyMode)&&n(e,"click",(t=>{if(!O&&!M){y&&C&&clearInterval(C),g.isPartyMode||W();const e=t.target.id.split("-");if("o"===e[0])k("click"),X(+e[1]);else if(!g.isPartyMode){const[e,o,n,r]=t.target.getAttribute("p").split("-"),c=""===r?-1:+r;y?(M=!0,v.emit("mV",{type:1,user:b,room:w,movement:[+e,+o,+n,c]})):B(+e,+o,+n,c)}}}))}))})),y&&!g.isPartyMode&&[...e(".ems")].forEach((e=>{n(e,"click",(e=>{k("emoji"),q();const o=e.target.id.split("-");s(t("#em-"+ +o[1]),"seb"),v.emit("mV",{type:5,user:b,room:w,emoji:+o[1]}),setTimeout((()=>{q(!1),l(t("#em-"+ +o[1]),"seb")}),4e3)}))})),n(t(".cl"),"click",(()=>{k("click"),D&&clearInterval(D),C&&clearInterval(C),y&&v&&R(),z()})),y&&v&&(v.on("rV",(t=>{y&&C&&clearInterval(C),M=!1;const e=t.user===b||g.isPartyMode;let[o,n,r,c]=t.movement;e||(r=23-r,o=7-o,n=7-n,c=c>=0?23-c:c),B(o,n,r,c)})),v.on("gD",(()=>{D&&clearInterval(D),C&&clearInterval(C),S(),y&&v&&R()})),v.on("sT",(o=>{W(),[...e(".t-e")].forEach((t=>{l(t,"sel")})),s(t("#o-"+o.id),"sel"),X(o.id)})),v.on("rE",(e=>{b!==e.user&&(k("emoji"),t(".ch-s").textContent=h[e.emoji],s(t(".ch-s"),"an"),setTimeout((()=>{t(".ch-s")&&l(t(".ch-s"),"an")}),4e3))})),g.isPartyMode&&v.emit("mV",{type:2,user:b,room:w,color:T[L],data:Z(T[L]).map((t=>({...t,availableMoves:Q(t)})))}))},P=d((()=>{const{w:e,h:o}={w:window.innerWidth,h:window.innerHeight},n=Math.min(e/m[0],o/m[1]),c=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);r(t("body"),{zoom:(e<m[0]?Math.round(e/m[0]*100):100)+"%",transform:n>=1||c?`scale(${c?1:n})`:void 0})}),100),R=()=>{y&&v&&(y=!1,w="",v.disconnect())},j=(e={})=>{v=io({path:location.pathname+"io",upgrade:!1,transports:["websocket"]}),y=!0,v.on("connect",(()=>{v.emit("nU",{...e,user:b},(e=>{e&&(alert(e),t(".clm")?s(t(".bc"),"hi"):z(),R())}))})),v.on("sG",(t=>{w=t.room;const{color:e}=t.p1.user===b?t.p1:t.p2;3!==t.type?E(g,{baseColor:e,initialTurn:t.turn}):t.table&&t.table.user===b?E(g,{baseColor:t.turn,initialTurn:t.turn,isPartyMode:!0}):M(e,t.turn)}))};n(document,"contextmenu",(t=>t.preventDefault())),n(window,"load",(()=>{const e=document.createElement("style");let o="";for(let t in p)document.documentElement.style.setProperty("--c-"+t,p[t]),o+=[...new Array(12)].map(((e,o)=>`.cc-${o}.${t}:after{background:${T(t,o)}}`)).join("");a(e,o),t("head").appendChild(e),r(t(".s"),{width:m[0]+"px",height:m[1]+"px"}),z(),n(window,"resize",P),P()}))})()</script><script>"serviceWorker"in navigator&&navigator.serviceWorker.register("serviceworker.js")</script>