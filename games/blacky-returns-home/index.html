<!doctype html><title>Blacky Returns Home - js13kGames 2025</title><style>body,html{height:100%;margin:0;display:flex;justify-content:center;align-items:center;background-color:#f0f0f0}canvas{border:1px solid #000}</style><canvas id=game width=720 height=360 style=background:linear-gradient(blue,pink)></canvas><script>function t(t,e,i){return Math.min(Math.max(t,i),e)}function e(t,e){let s=i(t),h=i(e);return!(t.radius&&s.width!=s.height||e.radius&&h.width!=h.height)&&([s,h]=[s,h].map(i=>((i==s?t:e).radius&&(i.radius=i.width/2,i.x+=i.radius,i.y+=i.radius),i)),t.radius&&e.radius?Math.hypot(s.x-h.x,s.y-h.y)<s.radius+h.radius:t.radius||e.radius?n(t.radius?s:h,t.radius?e:t):s.x<h.x+h.width&&s.x+s.width>h.x&&s.y<h.y+h.height&&s.y+s.height>h.y)}function i(t){let{x:e=0,y:i=0,width:s,height:h,radius:n}=t.world||t;return t.mapwidth&&(s=t.mapwidth,h=t.mapheight),n&&(s=2*n.x,h=2*n.y),t.anchor&&(e-=s*t.anchor.x,i-=h*t.anchor.y),s<0&&(e+=s,s*=-1),h<0&&(i+=h,h*=-1),{x:e,y:i,width:s,height:h}}let s=()=>{};function h(t,e){let i=t.indexOf(e);if(-1!=i)return t.splice(i,1),!0}function n(t,e){let{x:s,y:h,width:n,height:r}=i(e);do{s-=e.sx||0,h-=e.sy||0}while(e=e.parent);let o=t.x-Math.max(s,Math.min(t.x,s+n)),a=t.y-Math.max(h,Math.min(t.y,h+r));return o*o+a*a<t.radius*t.radius}let r,o,a={};function l(t,e){a[t]=a[t]||[],a[t].push(e)}function c(t,...e){(a[t]||[]).map(t=>t(...e))}let d={get:(t,e)=>"_proxy"==e||s};function u(){return r}function f(){return o}class p{constructor(t=0,e=0,i={}){null!=t.x?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e),i._c&&(this.clamp(i._a,i._b,i._d,i._e),this.x=t,this.y=e)}set(t){this.x=t.x,this.y=t.y}add(t){return new p(this.x+t.x,this.y+t.y,this)}subtract(t){return new p(this.x-t.x,this.y-t.y,this)}scale(t){return new p(this.x*t,this.y*t)}normalize(t=this.length()||1){return new p(this.x/t,this.y/t)}dot(t){return this.x*t.x+this.y*t.y}length(){return Math.hypot(this.x,this.y)}distance(t){return Math.hypot(this.x-t.x,this.y-t.y)}angle(t){return Math.acos(this.dot(t)/(this.length()*t.length()))}direction(){return Math.atan2(this.y,this.x)}clamp(t,e,i,s){this._c=!0,this._a=t,this._b=e,this._d=i,this._e=s}get x(){return this._x}get y(){return this._y}set x(e){this._x=this._c?t(this._a,this._d,e):e}set y(e){this._y=this._c?t(this._b,this._e,e):e}}function x(){return new p(...arguments)}class g{constructor(t){return this.init(t)}init(t={}){this.position=x(),this.velocity=x(),this.acceleration=x(),this.ttl=1/0,Object.assign(this,t)}update(t){this.advance(t)}advance(t){let e=this.acceleration;t&&(e=e.scale(t)),this.velocity=this.velocity.add(e);let i=this.velocity;t&&(i=i.scale(t)),this.position=this.position.add(i),this._pc(),this.ttl--}get dx(){return this.velocity.x}get dy(){return this.velocity.y}set dx(t){this.velocity.x=t}set dy(t){this.velocity.y=t}get ddx(){return this.acceleration.x}get ddy(){return this.acceleration.y}set ddx(t){this.acceleration.x=t}set ddy(t){this.acceleration.y=t}isAlive(){return this.ttl>0}_pc(){}}class w extends g{init({width:t=0,height:e=0,context:i=f(),render:s=this.draw,update:h=this.advance,children:n=[],anchor:r={x:0,y:0},opacity:o=1,rotation:a=0,drotation:c=0,ddrotation:d=0,scaleX:u=1,scaleY:p=1,...x}={}){this._c=[],super.init({width:t,height:e,context:i,anchor:r,opacity:o,rotation:a,drotation:c,ddrotation:d,scaleX:u,scaleY:p,...x}),this._di=!0,this._uw(),this.addChild(n),this._rf=s,this._uf=h,l("init",()=>{this.context??=f()})}update(t){this._uf(t),this.children.map(e=>e.update&&e.update(t))}render(){let t=this.context;t.save(),(this.x||this.y)&&t.translate(this.x,this.y),this.rotation&&t.rotate(this.rotation),1==this.scaleX&&1==this.scaleY||t.scale(this.scaleX,this.scaleY);let e=this.width,i=this.height;this.radius&&(e=i=2*this.radius);let s=-e*this.anchor.x,h=-i*this.anchor.y;(s||h)&&t.translate(s,h),this.context.globalAlpha=this.opacity,this._rf(),(s||h)&&t.translate(-s,-h),this.children.map(t=>t.render&&t.render()),t.restore()}draw(){}_pc(){this._uw(),this.children.map(t=>t._pc())}get x(){return this.position.x}get y(){return this.position.y}set x(t){this.position.x=t,this._pc()}set y(t){this.position.y=t,this._pc()}get width(){return this._w}set width(t){this._w=t,this._pc()}get height(){return this._h}set height(t){this._h=t,this._pc()}_uw(){if(!this._di)return;let{_wx:t=0,_wy:e=0,_wo:i=1,_wrot:s=0,_wsx:h=1,_wsy:n=1}=this.parent||{};this._wx=this.x,this._wy=this.y,this._ww=this.width,this._wh=this.height,this.radius&&(this._wrx=this.radius,this._wry=this.radius),this._wo=i*this.opacity,this._wsx=h*this.scaleX,this._wsy=n*this.scaleY,this._wx=this._wx*h,this._wy=this._wy*n,this._ww=this.width*this._wsx,this._wh=this.height*this._wsy,this.radius&&(this._wrx=this.radius*this._wsx,this._wry=this.radius*this._wsy),this._wrot=s+this.rotation;let{x:r,y:o}=function(t,e){let i=Math.sin(e),s=Math.cos(e);return{x:t.x*s-t.y*i,y:t.x*i+t.y*s}}({x:this._wx,y:this._wy},s);this._wx=r,this._wy=o,this._wx+=t,this._wy+=e}get world(){return{x:this._wx,y:this._wy,width:this._ww,height:this._wh,radius:this.radius?{x:this._wrx,y:this._wry}:void 0,opacity:this._wo,rotation:this._wrot,scaleX:this._wsx,scaleY:this._wsy}}set children(t){this.removeChild(this._c),this.addChild(t)}get children(){return this._c}addChild(...t){t.flat().map(t=>{this.children.push(t),t.parent=this,t._pc=t._pc||s,t._pc()})}removeChild(...t){t.flat().map(t=>{h(this.children,t)&&(t.parent=null,t._pc())})}get radius(){return this._r}set radius(t){this._r=t,this._pc()}get opacity(){return this._opa}set opacity(e){this._opa=t(0,1,e),this._pc()}get rotation(){return this._rot}set rotation(t){this._rot=t,this._pc()}advance(t){super.advance(t),this.drotation+=this.ddrotation,this.rotation+=this.drotation}setScale(t,e=t){this.scaleX=t,this.scaleY=e}get scaleX(){return this._scx}set scaleX(t){this._scx=t,this._pc()}get scaleY(){return this._scy}set scaleY(t){this._scy=t,this._pc()}}class y extends w{init({image:t,width:e=(t?t.width:void 0),height:i=(t?t.height:void 0),...s}={}){super.init({image:t,width:e,height:i,...s})}get animations(){return this._a}set animations(t){let e,i;for(e in this._a={},t)this._a[e]=t[e].clone(),i=i||this._a[e];this.currentAnimation=i,this.width=this.width||i.width,this.height=this.height||i.height}playAnimation(t){this.currentAnimation?.stop(),this.currentAnimation=this.animations[t],this.currentAnimation.start()}advance(t){super.advance(t),this.currentAnimation?.update(t)}draw(){if(this.image&&this.context.drawImage(this.image,0,0,this.image.width,this.image.height),this.currentAnimation&&this.currentAnimation.render({x:0,y:0,width:this.width,height:this.height,context:this.context}),this.color){if(this.context.fillStyle=this.color,this.radius)return this.context.beginPath(),this.context.arc(this.radius,this.radius,this.radius,0,2*Math.PI),void this.context.fill();this.context.fillRect(0,0,this.width,this.height)}}}function _(){return new y(...arguments)}let m=/(\d+)(\w+)/;class v extends w{init({text:t="",textAlign:e="",lineHeight:i=1,font:s=f()?.font,...h}={}){t=""+t,super.init({text:t,textAlign:e,lineHeight:i,font:s,...h}),this.context&&this._p(),l("init",()=>{this.font??=f().font,this._p()})}get width(){return this._w}set width(t){this._d=!0,this._w=t,this._fw=t}get text(){return this._t}set text(t){this._d=!0,this._t=""+t}get font(){return this._f}set font(t){this._d=!0,this._f=t,this._fs=function(t){if(!t)return{computed:0};let e=t.match(m),i=+e[1];return{size:i,unit:e[2],computed:i}}(t).computed}get lineHeight(){return this._lh}set lineHeight(t){this._d=!0,this._lh=t}render(){this._d&&this._p(),super.render()}_p(){this._s=[],this._d=!1;let t=this.context,e=[this.text];if(t.font=this.font,e=this.text.split("\n"),this._fw&&e.map(e=>{let i=e.split(" "),s=i.shift(),h=s;i.map(e=>{h+=" "+e,t.measureText(h).width>this._fw&&(this._s.push(s),h=e),s=h}),this._s.push(h)}),!this._s.length&&this.text.includes("\n")){let i=0;e.map(e=>{this._s.push(e),i=Math.max(i,t.measureText(e).width)}),this._w=this._fw||i}this._s.length||(this._s.push(this.text),this._w=this._fw||t.measureText(this.text).width),this.height=this._fs+(this._s.length-1)*this._fs*this.lineHeight,this._uw()}draw(){let t=0,e=this.textAlign,i=this.context;e=this.textAlign||("rtl"==i.canvas.dir?"right":"left"),t="right"==e?this.width:"center"==e?this.width/2|0:0,this._s.map((s,h)=>{i.textBaseline="top",i.textAlign=e,i.fillStyle=this.color,i.font=this.font,this.strokeColor&&(i.strokeStyle=this.strokeColor,i.lineWidth=this.lineWidth??1,i.strokeText(s,t,this._fs*this.lineHeight*h)),i.fillText(s,t,this._fs*this.lineHeight*h)})}}function b(){return new v(...arguments)}let C=new WeakMap,k={},M={},A={0:"left",1:"middle",2:"right"};function S(t,e){return parseFloat(t.getPropertyValue(e))||0}function E(t){let e=null!=t.button?A[t.button]:"left";M[e]=!0,P(t,"onDown")}function R(t){let e=null!=t.button?A[t.button]:"left";M[e]=!1,P(t,"onUp")}function T(t){P(t,"onOver")}function O(t){C.get(t.target)._oo=null,M={}}function Y(t,e,i){let s=function(t){let e=t._lf.length?t._lf:t._cf;for(let i=e.length-1;i>=0;i--){let s=e[i];if(s.collidesWithPointer?s.collidesWithPointer(t):n(t,s))return s}}(t);s&&s[e]&&s[e](i),k[e]&&k[e](i,s),"onOver"==e&&(s!=t._oo&&t._oo&&t._oo.onOut&&t._oo.onOut(i),t._oo=s)}function P(t,e){t.preventDefault();let i=t.target,s=C.get(i),{scaleX:h,scaleY:n,offsetX:r,offsetY:o}=function(t){let{canvas:e,_s:i}=t,s=e.getBoundingClientRect(),h="none"!=i.transform?i.transform.replace("matrix(","").split(","):[1,1,1,1],n=parseFloat(h[0]),r=parseFloat(h[3]),o=(S(i,"border-left-width")+S(i,"border-right-width"))*n,a=(S(i,"border-top-width")+S(i,"border-bottom-width"))*r,l=(S(i,"padding-left")+S(i,"padding-right"))*n,c=(S(i,"padding-top")+S(i,"padding-bottom"))*r;return{scaleX:(s.width-o-l)/e.width,scaleY:(s.height-a-c)/e.height,offsetX:s.left+(S(i,"border-left-width")+S(i,"padding-left"))*n,offsetY:s.top+(S(i,"border-top-width")+S(i,"padding-top"))*r}}(s);t.type.includes("touch")?(Array.from(t.touches).map(({clientX:t,clientY:e,identifier:i})=>{let a=s.touches[i];a||(a=s.touches[i]={start:{x:(t-r)/h,y:(e-o)/n}},s.touches.length++),a.changed=!1}),Array.from(t.changedTouches).map(({clientX:i,clientY:a,identifier:l})=>{let d=s.touches[l];d.changed=!0,d.x=s.x=(i-r)/h,d.y=s.y=(a-o)/n,Y(s,e,t),c("touchChanged",t,s.touches),"onUp"==e&&(delete s.touches[l],s.touches.length--,s.touches.length||c("touchEnd"))})):(s.x=(t.clientX-r)/h,s.y=(t.clientY-o)/n,Y(s,e,t))}function L(t){let e=t.canvas;t.clearRect(0,0,e.width,e.height)}let G={set:(t,e,i)=>(e.startsWith("_")||(t._d=!0),Reflect.set(t,e,i))},X={start:t=>t?1:0,center:()=>.5,end:t=>t?0:1};class j extends w{init({flow:t="column",align:e="start",justify:i="start",colGap:s=0,rowGap:h=0,numCols:n=1,dir:r="",breakpoints:o=[],...a}={}){return super.init({flow:t,align:e,justify:i,colGap:s,rowGap:h,numCols:n,dir:r,breakpoints:o,...a}),this._p(),new Proxy(this,G)}addChild(t){this._d=!0,super.addChild(t)}removeChild(t){this._d=!0,super.removeChild(t)}render(){this._d&&this._p(),super.render()}destroy(){this.children.map(t=>t.destroy&&t.destroy())}_p(){this._d=!1,this.breakpoints.map(t=>{t.metric.call(this)&&this._b!==t&&(this._b=t,t.callback.call(this))});let t=this._g=[],e=this._cw=[],i=this._rh=[],s=this.children,h=this._nc="column"==this.flow?1:"row"==this.flow?s.length:this.numCols,n=0,r=0;for(let o,a=0;o=s[a];a++){t[n]=t[n]||[],o._p&&o._p();let{width:s,height:a}=o.world||o;i[n]=Math.max(i[n]||0,a);let l=o.colSpan||1,c=l;do{e[r]=Math.max(e[r]||0,s/c),t[n][r]=o}while(r++<=h&&--l);r>=h&&(r=0,n++)}for(;r>0&&r<h;)t[n][r++]=!1;let o=t.length,a=[].concat(this.colGap),l=[].concat(this.rowGap);this._w=e.reduce((t,e)=>t+e,0);for(let t=0;t<h-1;t++)this._w+=a[t%a.length];this._h=i.reduce((t,e)=>t+e,0);for(let t=0;t<o-1;t++)this._h+=l[t%l.length];this._uw();let c="rtl"==this.context.canvas.dir&&!this.dir||"rtl"==this.dir;this._rtl=c,c&&(this._g=t.map(t=>t.reverse()),this._cw=e.reverse(),a=a.reverse());let d=-this.anchor.y*this.height,u=[],f=[].concat(this.justify),p=[].concat(this.align);this._g.map((t,s)=>{let h=-this.anchor.x*this.width;t.map((t,n)=>{if(t&&!u.includes(t)){u.push(t);let r=X[t.justifySelf||f[n%f.length]](this._rtl),o=X[t.alignSelf||p[s%p.length]](),l=t.colSpan||1,c=e[n];if(l>1&&n+l<=this._nc)for(let t=1;t<l;t++)c+=e[n+t]+a[(n+t)%a.length];let x=c*r,g=i[s]*o,w=0,y=0,{width:_,height:m}=t.world||t;t.anchor&&(w=t.anchor.x,y=t.anchor.y),0==r?x+=_*w:.5==r?x+=(w<.5?-1:.5==w?0:1)*_*r:x-=_*(1-w),0==o?g+=m*y:.5==o?g+=(y<.5?-1:.5==y?0:1)*m*o:g-=m*(1-y),t.x=h+x,t.y=d+g}h+=e[n]+a[n%a.length]}),d+=i[s]+l[s%l.length]})}}let W={},H={},I={},F={Enter:"enter",Escape:"esc",Space:"space",ArrowLeft:"arrowleft",ArrowUp:"arrowup",ArrowRight:"arrowright",ArrowDown:"arrowdown"};function B(t=s,e){t._pd&&e.preventDefault(),t(e)}function D(t){let e=F[t.code],i=W[e];I[e]=!0,B(i,t)}function N(t){let e=F[t.code],i=H[e];I[e]=!1,B(i,t)}function q(){I={}}function z(t){return!![].concat(t).some(t=>I[t])}function U(t,e){return t/e|0}function $(t,e){return t/e|0}class J{constructor(t={}){let{width:e,height:i,tilewidth:s,tileheight:h,tilesets:n}=t,r=e*s,o=i*h,a=document.createElement("canvas");a.width=r,a.height=o,this._c=a,this._ctx=a.getContext("2d"),n.map(e=>{let{__k:i,location:s}=window,h=(i?i.dm.get(t):"")||s.href,{source:n}=e;if(n){if(!i)throw Error('You must use "load" or "loadData" to resolve tileset.source');let t=i.d[i.u(n,h)];if(!t)throw Error(`You must load the tileset source "${n}" before loading the tileset`);Object.keys(t).map(i=>{e[i]=t[i]})}let{image:r}=e;if(""+r===r){if(!i)throw Error('You must use "load" or "loadImage" to resolve tileset.image');let t=i.i[i.u(r,h)];if(!t)throw Error(`You must load the image "${r}" before loading the tileset`);e.image=t}}),Object.assign(this,{context:f(),layerMap:{},layerCanvases:{},mapwidth:r,mapheight:o,_sx:0,_sy:0,_o:[],...t}),this.context&&this._p(),l("init",()=>{this.context??=f(),this._p()})}get sx(){return this._sx}get sy(){return this._sy}set sx(e){let i=Math.max(0,this.mapwidth-u().width);this._sx=t(0,i,e)}set sy(e){let i=Math.max(0,this.mapheight-u().height);this._sy=t(0,i,e)}set objects(t){this.remove(this._o),this.add(t)}get objects(){return this._o}add(...t){t.flat().map(t=>{this._o.push(t),t.parent=this})}remove(...t){t.flat().map(t=>{h(this._o,t),t.parent=null})}getPosition(t){let e=u().getBoundingClientRect(),i=t.x-e.x,s=t.y-e.y;return i+=this.sx,s+=this.sy,{x:i,y:s,row:U(s,this.tileheight),col:$(i,this.tilewidth)}}setTileAtLayer(t,e,i){let{layerMap:s,tileheight:h,tilewidth:n,width:r}=this,{row:o,col:a,x:l,y:c}=e,d=o??U(c,h),u=a??$(l,n);s[t]&&(this._d=!0,s[t]._d=!0,s[t].data[d*r+u]=i)}setLayer(t,e){let{layerMap:i}=this;i[t]&&(this._d=!0,i[t]._d=!0,i[t].data=e)}layerCollidesWith(t,e){let{tilewidth:s,tileheight:h,layerMap:n}=this,{x:r,y:o,width:a,height:l}=i(e),c=U(o,h),d=$(r,s),u=U(o+l,h),f=$(r+a,s),p=n[t];for(let t=c;t<=u;t++)for(let e=d;e<=f;e++)if(p.data[e+t*this.width])return!0;return!1}tileAtLayer(t,e){let{layerMap:i,tileheight:s,tilewidth:h,width:n}=this,{row:r,col:o,x:a,y:l}=e,c=r??U(l,s),d=o??$(a,h);return i[t]?i[t].data[c*n+d]:-1}render(t=this._c,e=!0){let{_d:i,context:s,sx:h=0,sy:n=0}=this;i&&this._p();let{width:r,height:o}=u(),a=Math.min(t.width,r),l=Math.min(t.height,o);s.drawImage(t,h,n,a,l,0,0,a,l),e&&(s.save(),(h||n)&&s.translate(-h,-n),this.objects.map(t=>t.render&&t.render()),s.restore())}renderLayer(t){let{layerCanvases:e,layerMap:i}=this,s=i[t],h=e[t],n=h?.getContext("2d");if(!h){let{mapwidth:i,mapheight:r}=this;h=document.createElement("canvas"),n=h.getContext("2d"),h.width=i,h.height=r,e[t]=h,this._rl(s,n)}s._d&&(s._d=!1,n.clearRect(0,0,h.width,h.height),this._rl(s,n)),this.render(h,!1)}_p(){let{_ctx:t,layers:e=[],layerMap:i}=this;this._d=!1,e.map(e=>{let{name:s,data:h,visible:n}=e;e._d=!1,i[s]=e,h&&0!=n&&this._rl(e,t)})}_rl(t,e){let{opacity:i,data:s=[]}=t,{tilesets:h,width:n,tilewidth:r,tileheight:o}=this;e.save(),e.globalAlpha=i,s.map((t,i)=>{if(!t)return;let s,a=0,l=0,c=2147483648&t,d=1073741824&t,u=0,f=0,p=0,x=0,g=0;a=c||d,g=536870912&(t&=1073741823),g&&(c&&d?p=1:c?u=1:d?f=1:x=1,l=u||f||p||x,t&=-536870913);for(let e=h.length-1;e>=0&&(s=h[e],!(t/s.firstgid>=1));e--);let{image:w,spacing:y=0,margin:_=0,firstgid:m,columns:v}=s,b=t-m,C=v??w.width/(r+y)|0,k=i%n*r,M=(i/n|0)*o,A=_+b%C*(r+y),S=_+(b/C|0)*(o+y);l?(e.save(),e.translate(k+r/2,M+o/2),f||x?e.rotate(-Math.PI/2):(u||p)&&e.rotate(Math.PI/2),(p||x)&&e.scale(-1,1),k=-r/2,M=-o/2):a&&(e.save(),e.translate(k+(c?r:0),M+(d?o:0)),e.scale(c?-1:1,d?-1:1),k=a?0:k,M=a?0:M),e.drawImage(w,A,S,r,o,k,M,r,o),(a||l)&&e.restore()}),e.restore()}}let K=new AudioContext,V=(t=1,e=.05,i=220,s=0,h=0,n=.1,r=0,o=1,a=0,l=0,c=0,d=0,u=0,f=0,p=0,x=0,g=0,w=1,y=0,_=0,m=0)=>{let v=Math,b=2*v.PI,C=44100,k=a*=500*b/C/C,M=i*=(1-e+2*e*v.random(e=[]))*b/C,A=0,S=0,E=0,R=1,T=0,O=0,Y=0,P=m<0?-1:1,L=b*P*m*2/C,G=v.cos(L),X=v.sin,j=X(L)/4,W=1+j,H=-2*G/W,I=(1-j)/W,F=(1+P*G)/2/W,B=-(P+G)/W,D=F,N=0,q=0,z=0,U=0;for(l*=500*b/C**3,p*=b/C,c*=b/C,d*=C,u=C*u|0,t*=.3,P=(s=C*s+9)+(y*=C)+(h*=C)+(n*=C)+(g*=C)|0;E<P;e[E++]=Y*t)++O%(100*x|0)||(Y=r?1<r?2<r?3<r?X(A**3):v.max(v.min(v.tan(A),1),-1):1-(2*A/b%2+2)%2:1-4*v.abs(v.round(A/b)-A/b):X(A),Y=(u?1-_+_*X(b*E/u):1)*(Y<0?-1:1)*v.abs(Y)**o*(E<s?E/s:E<s+y?1-(E-s)/y*(1-w):E<s+y+h?w:E<P-g?(P-E-g)/n*w:0),Y=g?Y/2+(g>E?0:(E<P-g?1:(P-E)/g)*e[E-g|0]/2/t):Y,m&&(Y=U=D*N+B*(N=q)+F*(q=Y)-I*z-H*(z=U))),L=(i+=a+=l)*v.cos(p*S++),A+=L+L*f*X(E**5),R&&++R>d&&(i+=c,M+=c,R=0),!u||++T%u||(i=M,a=k,R=R||1);(t=K.createBuffer(1,P,C)).getChannelData(0).set(e),(i=K.createBufferSource()).buffer=t,i.connect(K.destination),i.start()};function Q(t){switch(t){case"jump":V(...[.7,,177,.01,.02,.05,,.1,,35,,,,,,,,.81,.02,,146]);break;case"rebound":V(...[2.1,,358,.02,.01,.17,4,3.6,,,,,,.6,15,.4,.17,.75,.06]);break;case"pickup":V(...[1.5,,539,,,.06,,.8,,,,,,.1,,,,.65]);break;case"catStep1":V(...[,,120,.01,.02,.02,1,1.5,,.5]);break;case"catStep2":V(...[,,160,.01,.015,.02,1,1.2,,.6])}}const{canvas:Z}=function(t,{contextless:e=!1}={}){if(r=document.getElementById(t)||t||document.querySelector("canvas"),e&&(r=r||new Proxy({},d)),!r)throw Error("You must provide a canvas element for the game");return o=r.getContext("2d")||new Proxy({},d),o.imageSmoothingEnabled=!1,c("init"),{canvas:r,context:o}}();!function({radius:t=5,canvas:e=u()}={}){let i=C.get(e);if(!i){let s=window.getComputedStyle(e);i={x:0,y:0,radius:t,touches:{length:0},canvas:e,_cf:[],_lf:[],_o:[],_oo:null,_s:s},C.set(e,i)}e.addEventListener("mousedown",E),e.addEventListener("touchstart",E),e.addEventListener("mouseup",R),e.addEventListener("touchend",R),e.addEventListener("touchcancel",R),e.addEventListener("blur",O),e.addEventListener("mousemove",T),e.addEventListener("touchmove",T),i._t||(i._t=!0,l("tick",()=>{i._lf.length=0,i._cf.map(t=>{i._lf.push(t)}),i._cf.length=0}))}(),function(){let t;for(t=0;t<26;t++)F["Key"+String.fromCharCode(t+65)]=String.fromCharCode(t+97);for(t=0;t<10;t++)F["Digit"+t]=F["Numpad"+t]=""+t;window.addEventListener("keydown",D),window.addEventListener("keyup",N),window.addEventListener("blur",q)}();const tt=Math.floor(.7*Z.height),et="bold 20px Arial, sans-serif",it="20px Arial, sans-serif",st={color:"white",font:it},ht=36,nt=36,rt=[[[],[3,2,7,1,10,1,13,1],[16,4],[0,2],[],[2,3,11,5],[],[5,5],[],[]],[[],[15,3],[1,4,8,1,11,2,19,1],[],[0,1,6,1,9,1,12,1,17,2],[],[2,2,13,4],[9,1],[4,1],[]],[[5,1],[0,4,5,1,10,2],[5,3,14,1,16,1],[3,3,19,1],[10,1,12,1],[8,1,10,1,12,1,17,1],[0,4,6,1,8,1,10,1],[5,2,8,1,14,2],[6,1],[]],[[],[2,1,5,2,10,1],[0,1,13,2,16,1,19,1],[6,2,11,1],[3,1,18,2],[0,2,4,1,9,1,12,1,15,1],[8,3,14,1],[2,1,5,2,9,1,16,1],[0,1,4,1,16,1],[]],[[],[6,1,9,1,12,1,15,2],[0,4],[18,2],[],[4,5,15,3],[],[10,5],[],[]],[[],[2,3],[0,1,7,2,11,1,15,4],[],[1,2,7,1,10,1,13,1,19,1],[],[3,4,16,2],[10,1],[15,1],[]],[[14,1],[8,2,14,1,16,4],[3,1,5,1,12,3],[0,1,14,3],[7,1,9,1],[2,1,7,1,9,1,11,1],[9,1,11,1,13,1,16,4],[4,2,11,1,13,2],[13,1],[]],[[],[9,1,13,2,17,1],[0,1,3,1,5,2,19,1],[8,1,12,2],[0,2,16,1],[4,1,7,1,10,1,15,1,18,2],[5,1,9,3],[3,1,10,1,13,2,17,1],[3,1,15,1,19,1],[]]],ot=[[["p",8,1],["f",3,2],["w",1,19]],[["p",8,1],["f",1,19],["f",8,10],["w",3,9]],[["p",0,1],["f",8,1],["f",0,19],["w",1,6]],[["p",8,18],["f",8,2],["f",1,19],["f",3,9],["w",1,0]],[["p",8,18],["f",3,17],["w",1,0]],[["p",8,18],["f",1,0],["f",8,9],["w",3,10]],[["p",0,18],["f",8,18],["f",0,0],["w",1,13]],[["p",8,1],["f",8,17],["f",1,0],["f",3,10],["w",1,19]]];let at,lt,ct,dt=new Array(200).fill(0),ut=[],ft=[],pt=1,xt="menu",gt=0,wt=1,yt=rt.length,_t=function(){let t=0,e=0,i=!1;return{start(){t=performance.now(),i=!0},stop(){i&&(e=performance.now(),i=!1)},reset(){t=0,e=0,i=!1},getElapsed:()=>((i?performance.now():e)-t)/1e3}}();const mt=function(t="#999"){const e=document.createElement("canvas");e.width=ht,e.height=nt;const i=e.getContext("2d");return i.fillStyle=t,i.fillRect(0,0,ht,nt),i.strokeStyle="#777",i.strokeRect(0,0,ht,nt),e}("#9aa");function vt(){return JSON.parse(localStorage.getItem("blacky_returns_home_highscores"))||[]}function bt(t,e){return b({text:t,font:"54px Arial",color:e,x:Z.width/2,y:75,anchor:{x:.5,y:.5},textAlign:"center"})}!function(t,e,{handler:i="keydown",preventDefault:s=!0}={}){let h="keydown"==i?W:H;e._pd=s,[].concat(t).map(t=>h[t]=e)}("r",function(t){xt="menu",Ht("restart",wt)});let Ct=bt("😺 Blacky returns home 😺","black"),kt=bt("🏆 -= Highscore =- 🏆","gold"),Mt=b({text:"Game Over\n\nYour score: "+gt,font:"italic 58px Arial",color:"red",x:Z.width/2,y:100,anchor:{x:.5,y:.5},textAlign:"center",update:function(){this.text="Game Over\nYour score: "+gt}}),At=b({text:"🎉Congratulation🎉\n\nYour score: "+gt,font:"italic 58px Arial",color:"white",x:Z.width/2,y:100,anchor:{x:.5,y:.5},textAlign:"center",update:function(){this.text="🎉Congratulation🎉\nYour score: "+gt}}),St=b({text:"Press [r] to restart",font:"bold 16px Arial",color:"white",x:Z.width/2,y:225,anchor:{x:.5,y:.5},textAlign:"center"}),Et=b({text:"SCORE: "+gt.toString().padStart(4,"0"),font:"bold 20px Arial",color:"white",strokeColor:"black",x:640,y:345,anchor:{x:.5,y:.5},textAlign:"right",update:function(){this.text="SCORE: "+gt.toString().padStart(4,"0")}}),Rt=b({text:"😺 Blacky returns Home",font:"bold 32px Comic Sans MS",color:"Black",x:16,y:345,anchor:{x:0,y:.5},textAlign:"Left",update:function(){this.text="😺 Blacky returns Home"}}),Tt=b({text:"Start",onDown:function(){xt="play"},onOver:function(){this.font=et},onOut:function(){this.font=it},...st}),Ot=b({text:"Highscore",onDown:function(){xt="highscores"},onOver:function(){this.font=et},onOut:function(){this.font=it},...st}),Yt=function(){return new j(...arguments)}({x:Z.width/2,y:250,anchor:{x:.5,y:.5},rowGap:15,justify:"center",children:[Tt,Ot]});function Pt(t,e){return at.tileAtLayer("solid",{x:t,y:e})>0}function Lt(t){t.y+=t.vy;const e=t.width/2,i=t.height/2;if(t.vy>=0){const s=t.y+i+4,h=t.x-e+2,n=t.x+e-2;if(Pt(h,s)||Pt(n,s)){const e=Math.floor(s/nt);t.y=e*nt-i-4,t.vy=0,t.onGround=!0}else t.onGround=!1}else{const s=t.y-i-1,h=t.x-e+2,n=t.x+e-2;if(Pt(h,s)||Pt(n,s)){const e=Math.floor(s/nt);t.y=(e+1)*nt+i,t.vy=0}}if(t.x+=t.vx,t.vx>0){const s=t.x+e,h=t.y-i+2,n=t.y+i-2;if(Pt(s,h)||Pt(s,n)){const i=Math.floor(s/ht);t.x=i*ht-e,t.vx=0}}else if(t.vx<0){const s=t.x-e,h=t.y-i+2,n=t.y+i-2;if(Pt(s,h)||Pt(s,n)){const i=Math.floor(s/ht);t.x=(i+1)*ht+e,t.vx=0}}}function Gt(t={}){return _({x:t.x||100,y:t.y||100,width:32,height:32,render(){!function(t){t.save(),t.strokeStyle="#faf600ff",t.lineWidth=2,t.beginPath(),t.moveTo(-12,0),t.lineTo(10,0),t.stroke(),t.beginPath(),t.moveTo(-16,0),t.lineTo(-12,-6),t.lineTo(-12,6),t.closePath(),t.stroke(),t.beginPath(),t.moveTo(10,0),t.lineTo(16,-6),t.moveTo(10,0),t.lineTo(16,6),t.stroke();for(let e=-8;e<=9;e+=5)t.beginPath(),t.moveTo(e,0),t.lineTo(e,-5),t.moveTo(e,0),t.lineTo(e,5),t.stroke();t.restore()}(this.context)}})}function Xt(t){let e=(t=t||{}).w||48,i=t.h||48;return _({x:t.x||100,y:t.y||80,width:e,height:i,anchor:{x:0,y:.25},open:0,targetOpen:0,speed:.05,timer:0,frameColor:t.frame||"#965d08ff",glassColor:t.glass||"#b4dcffcf",openWindow(){this.targetOpen=1,this.timer=1800},closeWindow(){this.targetOpen=0},toggleWindow(){this.targetOpen=this.targetOpen>.5?0:1},update(){this.open<this.targetOpen?this.open=Math.min(this.open+this.speed,this.targetOpen):this.open>this.targetOpen&&(this.open=Math.max(this.open-this.speed,this.targetOpen)),this.timer>0&&(this.timer--,0===this.timer&&this.closeWindow())},render(){const t=this.context,e=this.width/2,i=this.height/2;t.fillStyle=this.frameColor,t.fillRect(-e,-i,this.width,this.height);let s=this.width-8,h=this.height-8,n=4-e,r=4-i;t.fillStyle=this.glassColor,t.fillRect(n,r,s,h);let o=h/2,a=r+h-o,l=a-(a-r)*this.open;t.fillStyle=this.glassColor,t.fillRect(n,l,s,o),t.fillStyle=this.frameColor,t.fillRect(n,a,s,2)}})}function jt(e){let i=e||{};return _({x:i.x||50,y:i.y||tt,width:32,height:32,furColor:i.furColor,eyeColor:i.eyeColor,vx:i.vx||0,vy:0,speed:i.speed||2.2,ai:!!i.ai,state:"idle",crouchT:0,sliding:0,facing:1,t:0,blink:0,onGround:!1,reboundCooldown:0,stepFrameCount:0,stepToggle:!1,update:function(){if(this.t+=.1,this.vy+=.5,this.ai){let t=function(t,e){let i=t.x-e.x,s=t.y-e.y;return Math.hypot(i,s)}(this,lt),e=lt.x-this.x;lt.y,this.y;let i=t?e/t:0;"idle"===this.state?(Math.random()<.02&&(this.vx=(Math.random()-.5)*(.8*this.speed)),this.onGround&&Math.random()<.005&&(this.vy=-8.5,Q("jump"),this.onGround=!1),t<110&&(this.state="chase")):"chase"===this.state?(this.vx=i*this.speed*1.3,t<46&&(this.state="crouch",this.crouchT=20,this.vx=0)):"crouch"===this.state?(this.vx=0,this.crouchT--,this.crouchT<=0&&(this.state="dash",this.vx=i*this.speed*4)):"dash"===this.state&&(this.vx*=.96,Math.abs(this.vx)<.2&&(this.state=t<110?"chase":"idle")),this.facing=0===this.vx?this.facing:this.vx>0?1:-1}else{const e=this.onGround;if(this.reboundCooldown>0&&this.reboundCooldown--,lt.reboundCooldown>0)return this.x+=this.vx,this.y+=this.vy,this.vy+=.5,Lt(this),void(this.x=t(16+at.sx,at.sx+Z.width-8,this.x));let i=z("arrowleft"),s=z("arrowright"),h=z("space")||z("arrowup");this.vx=(i?-this.speed:0)+(s?this.speed:0),e&&h&&(this.vy=-8.5,Q("jump"),this.onGround=!1)}Lt(this),!this.ai&&this.onGround&&Math.abs(this.vx)>.1?(this.stepFrameCount++,this.stepFrameCount>=10&&(this.stepFrameCount=0,this.stepToggle=!this.stepToggle,Q(this.stepToggle?"catStep1":"catStep2"))):this.stepFrameCount=0,this.x=t(16,at.sx+Z.width-8,this.x)},render:function(){let t=this.context;this.ai&&"crouch"===this.state?(t.fillStyle=this.furColor,t.beginPath(),t.ellipse(0,6,15,10,0,0,2*Math.PI),t.fill()):function(t){let e=t.context;e.fillStyle=t.furColor?t.furColor:"black",e.fillRect(-10,0,20,12),e.fillRect(-8,-10,16,10),e.fillRect(-8,-14,4,4),e.fillRect(4,-14,4,4);let i=1.2*Math.min(Math.abs(t.vx||0),3)+2,s=Math.sin(1.6*t.t)*i;t.ai?e.fillRect(10,-6+s,4,14):(e.fillRect(10,-4+s,4,8),e.fillRect(14,-6+s,4,5));let h=t.sliding?0:2*Math.sin(3*t.t);if(e.fillRect(-8,12+h,4,6),e.fillRect(4,12-h,4,6),e.fillRect(-10,12-h,4,6),e.fillRect(8,12+h,4,6),(t.blink=(t.blink+1)%200)<5?(e.fillStyle=t.furColor?t.furColor:"black",e.fillRect(-5,-7,3,1),e.fillRect(2,-7,3,1)):(e.fillStyle=t.eyeColor?t.eyeColor:"yellow",e.fillRect(-5,-7,3,3),e.fillRect(2,-7,3,3)),!t.onGround){let i=function(t,e){let i=t.y+t.height/2,s=Math.floor(t.x/e.tilewidth),h=Math.floor(i/e.tileheight);const n=e.width,r=e.height;for(let t=h;t<r;t++)if(e.layers[0].data[t*n+s])return t*e.tileheight;return null}(t,at);null!==i&&(e.fillStyle="#0000004d",e.fillRect(-8,i-t.y,16,3))}}(this)}})}function Wt(t,e,i){let s=i.tilewidth,h=i.tileheight;return{x:t*s+s/2,y:e*h+h/2}}function Ht(t,e){"restart"==t&&(_t.reset(),gt=0),_t.start(),pt=e,dt=new Array(200).fill(0);for(let t=0;t<20;t++)dt[180+t]=1;for(let t=0;t<rt[pt-1].length;t++){const e=rt[pt-1][t];for(let i=0;i<e.length;i+=2){const s=e[i],h=e[i+1];for(let e=0;e<h;e++)dt[20*t+(s+e)]=1}}at=function(){return new J(...arguments)}({tilewidth:ht,tileheight:nt,width:20,height:10,tilesets:[{firstgid:1,image:mt,columns:1}],layers:[{name:"solid",data:dt}]}),ut=[jt({x:320,y:200,speed:1.2,vx:.8,ai:!0,furColor:"white",eyeColor:"blue"}),jt({x:460,y:100,speed:1.6,vx:-1.2,ai:!0,furColor:"silver",eyeColor:"green"}),jt({x:500,y:tt,speed:1,vx:.4,ai:!0})],ft=[];let i=function(t,e,i,s){let h=[],n=ot[pt-1];for(let t=0;t<n.length;t++){let[e,r,o]=n[t],{x:a,y:l}=Wt(o,r,i);if("f"===e){let t=Gt({x:a,y:l});s.push(t)}else"w"===e?(ct=Xt({x:a,y:l,w:36}),h.push(ct)):"p"===e&&(lt=jt({x:a,y:l,speed:2.2,ai:!1}),h.push(lt))}return h}(0,0,at,ft);at.add(ut,i,ft,Et,Rt)}[Tt,Ot].flat().map(t=>{let e=t.context?t.context.canvas:u(),i=C.get(e);if(!i)throw new ReferenceError("Pointer events not initialized for the objects canvas");t.__r||(t.__r=t.render,t.render=function(){i._cf.push(this),this.__r()},i._o.push(t))}),Ht("start",wt);let It=[],Ft=function({fps:t=60,clearCanvas:e=!0,update:i=s,render:h,context:n=f(),blur:r=!1}={}){if(!h)throw Error("You must provide a render() function");let o,a,d,u,p,x=0,g=1e3/t,w=1/t,y=e?L:s,_=!0;function m(){if(a=requestAnimationFrame(m),_&&(d=performance.now(),u=d-o,o=d,!(u>1e3))){for(x+=u;x>=g;)c("tick"),p.update(w),x-=g;y(p.context),p.render()}}return r||(window.addEventListener("focus",()=>{_=!0}),window.addEventListener("blur",()=>{_=!1})),l("init",()=>{p.context??=f()}),p={update:i,render:h,isStopped:!0,context:n,start(){this.isStopped&&(o=performance.now(),this.isStopped=!1,requestAnimationFrame(m))},stop(){this.isStopped=!0,cancelAnimationFrame(a)},_frame:m,set _last(t){o=t}},p}({update:function(){let t=[];switch(xt){case"menu":break;case"play":lt.update();for(let t=0;t<ut.length;t++)ut[t].update();ct.update(),function(t){ut.forEach(i=>{if(e(t,i)&&t.onGround&&0===t.reboundCooldown){let e=t.x-i.x;t.vx=e>0?4:-4,t.vy=-8,t.reboundCooldown=20,gt-=50,Q("rebound")}})}(lt);for(let t=ft.length-1;t>=0;t--){let i=ft[t];i&&e(lt,i)&&(gt+=200,Q("pickup"),i.ttl=0,at.remove(i),ft.splice(t,1),ct.openWindow())}if(ct&&e(lt,ct)){_t.stop();let t=function(t){let e=Math.min(t,60);return Math.max(0,Math.round(1e3*(60-e)/60))}(_t.getElapsed());gt+=t,gt+=500,Q("pickup"),wt==yt?(wt=1,xt="gamewon"):(wt+=1,Ht("nextlevel",wt))}Rt.update,Et.update(),at.sx=lt.x+lt.width/2-Z.width/2;break;case"gameover":Mt.update(),t=vt();break;case"gamewon":if(At.update(),t=vt(),t.length<5||gt>t[t.length-1].score){let e=prompt("New High Score! Enter your nickname:").substring(0,3);!function(t,e){let i=vt();const s={score:t,name:e};i.push(s),i.sort((t,e)=>e.score-t.score),i.splice(5),localStorage.setItem("blacky_returns_home_highscores",JSON.stringify(i))}(gt,e),t=vt(),xt="menu"}break;case"highscores":It=function(t){let e=[],i=160;const s=Z.width/2,h=s-100,n=s+100,r={Rank:h,Name:s,Score:n};return["Rank","Name","Score"].forEach(t=>{e.push(b({text:t,font:"20px Arial",color:"white",x:r[t],y:120,anchor:{x:.5,y:.5},textAlign:"center"}))}),t.forEach((t,r)=>{let o=160+40*r;i=o,e.push(b({text:`${r+1}`.padStart(3,"0"),font:"20px Arial",color:"white",x:h,y:o,anchor:{x:.5,y:.5},textAlign:"center"})),e.push(b({text:t.name,font:"20px Arial",color:"white",x:s,y:o,anchor:{x:.5,y:.5},textAlign:"center"})),e.push(b({text:t.score.toString().padStart(3,"0"),font:"20px Arial",color:"white",x:n,y:o,anchor:{x:.5,y:.5},textAlign:"center"}))}),e.push(b({text:"Press [r] to restart",font:"bold 16px Arial",color:"white",x:Z.width/2,y:i+60,anchor:{x:.5,y:.5},textAlign:"center"})),e}(vt())}},render:function(){switch(xt){case"menu":Ct.render(),Yt.render();break;case"play":at.render();break;case"gameover":Mt.render(),St.render();break;case"gamewon":At.render(),St.render();break;case"highscores":kt.render(),It.forEach(t=>t.render())}}});Ft.start()</script>