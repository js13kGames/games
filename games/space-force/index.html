<!doctype html><title>SpaceForce</title><meta name=viewport content="width=device-width,user-scalable=0,minimum-scale=1,maximum-scale=1"><style>body{margin:0}h1,h2{position:fixed;left:50%;transform:translateX(-50%);font-size:xx-large;color:#ececec;font-family:AvenirNext-Heavy,'arial black',futura,impact;user-select:none}#random{left:20%;top:40%}#play{left:80%;top:40%}canvas{-webkit-tap-highlight-color:transparent}</style><h1 id=title>SPACE FORCE</h1><h2 id=random>üé≤</h2><h2 id=play>‚ñ∂Ô∏è</h2><script src=/socket.io.js></script><script src=shared.js></script><script>"use strict";let socket,_ctx,_c,cam,cw,ch,_P,_ppI,_pD,_t,_tI,_tP,_tID,_g,_x,_y,_plt,message="test",title=document.getElementById("title"),randBtn=document.getElementById("random"),playBtn=document.getElementById("play"),timer=0,cnv=document.createElement("canvas"),ctx=cnv.getContext("2d"),Canvas=(e,t)=>{let a=document.createElement("canvas");return a.ctx=a.getContext("2d"),a.width=e,a.height=t,a},images={sprites:Canvas(128,128),stars:Canvas(512,512)},scale=2,bScl=2,dScl=1,aScl=2,sSpd=.01,particles={thruster:[-.5,1,5,8,.2,500,[6,5,4,4]],splosion:[.6,8,12,12,2*PI,300,[3,3,2,15,15,10,7]],bullet:[-1,2,4,4,PI/3,200,[15,14,13,13,7,0]]},particlePool=ObjectPool(Obj),_pV=vec(),emitParticle=(e,t,a,c=0)=>{for(_pD=particles[a],_ppI=0;_ppI<_pD[1];_ppI++)t=t-_pD[4]/2+Math.random()*_pD[4],_pV.vFrD(t).scl(_pD[0]+c),_P={type:"particle",name:a,x:e.x,y:e.y,vx:_pV.x,vy:_pV.y,w:_pD[2],h:_pD[3],dir:_pV.dir(),life:_pD[5],sprite:_pD[6]},particlePool.newObject(_P)},updateParticle=(e,t)=>{t.life-=e,t.life<0&&t.release(),t.pos.add(t.vel),t.acc=t.life/t.mLife},stars=[],db=document.body,keys={},mouse=vec(-1,-1),touches={},touchStart=[null,null],touchIDs=[null,null],keyH=e=>{e.preventDefault(),keys[e.keyCode]=e.type,"keyup"===e.type&&delete keys[e.keyCode]},mouseH=e=>{switch(e.type){case"mousedown":audioCtx||(audioCtx=new(window.AudioContext||window.webkitAudioContext),startAudio()),game||join(e),mouse.pressed=!0;case"mousemove":mouse.moved=!0,mouse.x=e.clientX/scale+cam.pos.x,mouse.y=e.clientY/scale+cam.pos.y;break;case"mouseup":mouse.pressed=!1}},touchH=e=>{for(_tI in e.preventDefault(),audioCtx||(audioCtx=new(window.AudioContext||window.webkitAudioContext),startAudio()),game||"touchend"===e.type||join(e),message=null,e.changedTouches)_t=e.changedTouches[_tI],((_tID=_t.identifier)||0===_tID)&&("touchend"===e.type?delete touches[_tID]:touches[_tID]=_t);for(_tI in touchIDs.forEach(((e,t)=>{null===e||touches[e]||(touchIDs[t]=null,touchStart[t]=null)})),touches)_t=touches[_tI],_tID=_t.identifier,touchPos(_t).x<cam.w/scale/2?null===touchIDs[0]&&(touchStart[0]=_t,touchIDs[0]=_tID):null===touchIDs[1]&&(touchStart[1]=_t,touchIDs[1]=_tID)},resetTouches=e=>{touches={},touchIDs=[null,null]},touchPos=e=>vec(e.clientX/scale,e.clientY/scale),displayObj=e=>{switch(ctx.fillStyle=e.fS,ctx.save(),ctx.translate(e.pos.x,e.pos.y),ctx.rotate(e.dir),e.type){case"enemy":case"player":ctx.rotate(PI/2),ctx.drawImage(images[e.sprite],0,!1!==e.hurt?48:0,32,32,-e.w/2-4,-e.h/2-4,32,32);break;case"cargo":ctx.rotate(PI/2),ctx.drawImage(images[e.sprite],0,!1!==e.hurt?48:0,32,47,-e.w/2+2,-e.h/2-6,32,47);break;case"pBullet":case"eBullet":ctx.drawImage(images.sprites,0,16*(e.w/2-2),16,16,-8,-8,16,16);break;case"particle":switch(ctx.globalAlpha=e.acc,ctx.globalCompositeOperation="screen",ctx.fillStyle=colours[e.sprite[e.acc*e.sprite.length|0]],e.name){case"splosion":case"bullet":ctx.beginPath(),ctx.arc(0,0,e.w/2,0,2*Math.PI),ctx.fill();break;case"thruster":ctx.fillRect(-e.w/2,-e.h/2,e.w,e.h)}break;case"star":ctx.drawImage(images.sprites,27,81,4,4,-2,-2,4,4)}e.debug&&(ctx.strokeStyle="rgba(20,180,70,1)",ctx.strokeRect(.5*-e.w,.5*-e.h,e.w,e.h)),ctx.restore()},join=e=>{audioCtx&&(e.touches&&touchPos(e.touches[0]).x>innerWidth/scale/2||touchPos(e).x>innerWidth/scale/2?Date.now()-timer>1e3&&(timer=Date.now(),socket.emit("join",_ship)):randomPlayer())},endGame=e=>{game.GL.stop(),game.GL=null,game=null,ctx.fillStyle="rgb(20,20,20)",ctx.fillRect(0,0,cam.w,cam.h,cam.w,cam.h),socket.emit("exit"),title.style.visibility="visible",randBtn.style.visibility="visible",playBtn.style.visibility="visible",randomPlayer()},size=e=>{setTimeout((e=>{cnv.width=innerWidth,cnv.height=innerHeight,ctx.fillStyle="rgb(20,20,20)",ctx.fillRect(0,0,innerWidth,innerHeight),ctx.imageSmoothingEnabled=!1,aScl=cnv.width>cnv.height?cnv.width:cnv.height,bScl=Math.max(2,aScl/360),resetTouches(),cam&&cam.size(),randomPlayer()}),150)},colours=["#fff","#b2dcef","#9d9d9d","#2f484e","#31a2f2","#005784","#1b2632","#f7e26b","#a3ce27","#44891a","#eb8931","#a46422","#493c2b","#fad5ee","#e06f8b","#be2633","#141414"],graphs=[[,,3,2,,,,6,,,3,2,,,7,6,,,3,6,,,3,1,3,3,3,2,3,3,2,2,3,3,2,2,2,2,1,1,,,,3,,,,3,,,,3,,,3,3,,3,3,3,,8,8,8,3,1,2,1,8,3,3,1,8,3,3,2,,8,2,1,,2,1,0],[,,3,0,,3,7,5,,3,2,1,,7,6,5,,3,2,5,,,3,0,2,3,2,1,3,2,1,0,2,2,1,2,2,1,0,0,,,3,1,,,3,2,,,3,2,,3,2,1,3,2,2,3,8,8,8,3,3,2,1,0,8,8,8,2,8,8,3,1,,,3,3,,,2,1],[,3,2,0,3,2,6,4,3,2,1,5,,7,5,4,,3,1,4,,3,2,0,1,3,1,0,2,1,0,0,3,1,0,2,1,0,1,1,,3,1,1,,3,1,3,,3,2,1,3,2,0,2,3,2,1,1,8,3,2,1,,8,2,0,8,3,1,2,8,2,3,1,,,8,2,,,,2],[,3,1,6,2,1,6,5,3,0,5,4,7,6,6,6,3,2,0,5,3,2,1,0,1,2,3,0,2,1,0,0,1,0,0,2,1,0,1,1,3,0,1,1,3,1,2,2,3,2,1,1,2,1,0,3,3,2,1,2,8,8,8,3,8,3,3,2,8,8,2,8,,,,2,,,8,3,,,,],[3,2,2,5,3,3,1,0,3,1,6,1,7,6,5,1,3,2,1,6,3,1,1,1,1,2,1,2,3,1,2,1,3,2,2,2,1,0,1,1,3,1,2,1,2,2,2,1,3,2,1,0,2,1,0,3,3,3,2,1,8,3,2,1,8,8,3,1,,,3,,,,,3],[3,1,7,4,2,1,2,6,3,3,2,0,3,2,3,2,,3,2,5,3,3,2,1,2,2,1,0,3,2,3,0,1,0,0,0,1,0,1,1,3,1,3,3,2,2,1,3,3,2,1,0,3,2,1,3,3,2,0,1,,8,8,3,8,2,3,1,,,3],[3,0,7,6,2,1,2,5,3,2,2,1,3,2,1,0,3,2,1,6,3,1,2,0,2,2,1,1,2,3,2,1,2,1,0,1,2,1,0,0,3,3,,,3,3,2,2,3,2,1,0,,3,2,3,3,2,0,0,,8,3,2,,,,2,,,3],[,3,1,7,,3,2,1,,3,1,2,,3,2,1,,3,2,7,3,2,3,2,3,3,2,1,2,2,3,3,3,2,2,3,2,2,1,1,,,,,,,3,3,,3,2,2,,,3,3,,3,2,2,,8,3,2,,,,3,,,8]],palettes=[[0,1,2,3,1,4,5,6,6],[1,4,5,6,7,10,11,12,6],[7,10,11,12,0,7,8,3,6],[7,8,9,3,0,14,15,12,6],[13,14,15,12,1,4,5,6,6],[1,1,0,0,1,1,0,0,0],[0,0,1],[0,1],[4],[5],[1],[0]],graph=(e,t)=>{for(_g=graphs,_plt=palettes[t[3]],e.save(),e.translate(t[0],t[1]),_y=0;_y<8;_y++)for(_x=0;_x<4;_x++)_c=_x+4*t[2],_g[_y]&&(_g[_y][_c]||0===_g[_y][_c])&&((_c=_plt[_g[_y][_c]])||0===_c)&&(e.fillStyle=colours[_c],t[5]?e.fillRect(_x,7-_y,1,1):e.fillRect(_x,_y,1,1),(t[4]||0===t[4])&&(t[5]?e.fillRect(7-_x+t[4],7-_y,1,1):e.fillRect(7-_x+t[4],_y,1,1)));e.restore()},circles=(e,t)=>{for(_ctx=images.sprites.ctx,_iI=0;_iI<5;_iI++)for(_i=0;_i<2;_i++)_ctx.fillStyle=colours[t[_i]],_ctx.beginPath(),_ctx.arc(16*e+8,64-16*_iI+8,6-_iI-_i,0,2*Math.PI),_ctx.fill();for(_i=0;_i<5;_i++)graph(_ctx,[2+8*_i,82,20,_i,-1]),graph(_ctx,[2+8*_i,90,20,_i+7,-1]),0==_i&&graph(_ctx,[2+8*_i,83,20,7,-1,1]);for(_i=0;_i<32;_i++)for(_iI=0;_iI<32;_iI++)_o=[5*Math.random()|0,28*Math.random()|0+32*_i,28*Math.random()|0+32*_iI],(_ctx=images.stars.ctx).drawImage(images.sprites,8+8*_o[0],90,8,8,_o[1],_o[2],8,8)},addShip=e=>{images[e]=Canvas(64,96),e[5]?(drawCargo(images[e].ctx,0,0,e[4]||0,e),drawCargo(images[e].ctx,0,48,5,e)):(drawShip(images[e].ctx,0,0,e[4]||0,e),drawShip(images[e].ctx,0,48,5,e))},drawShip=(e,t,a,c,s)=>{graph(e,[t+8,a,s[0],c,0]),graph(e,[t+8,a+8,5+s[1]%5,c,0,s[1]>5?1:0]),graph(e,[t+4,a+8,10+s[2]%5,c,8,s[2]>5?1:0]),graph(e,[t+8,a+16,15+1*s[3],c,0])},drawCargo=(e,t,a,c,s)=>{graph(e,[t+8,a,4,c,0]),graph(e,[t+8,a+8,6,c,0]),graph(e,[t+8,a+16,9,c,0]),graph(e,[t+8,a+24,7,c,0]),graph(e,[t+8,a+32,15,c,0]),graph(e,[t+4,a+8,1*s[1]+12,c,8]),graph(e,[t+4,a+16,1*s[2]+6,c,8]),graph(e,[t,a+16,1*s[3]+12,c,16]),graph(e,[t+4,a+24,1*s[5]+12,c,8,1])},randomPlayer=e=>{for(randomShip(0),ctx.save(),ctx.fillRect(0,0,cnv.width,cnv.height),ctx.drawImage(images.stars,0,0,512,512,0,0,1024,1024),ctx.translate(cnv.width/2|0,0),ctx.scale(6,6),drawShip(ctx,-20,cnv.height/scale/12|0,_ship[4]||0,_ship),_i=0;_i<_ship[0];_i++)ctx.drawImage(images.sprites,0,16*(1==_ship[0]?4:2==_ship[0]?1:0),16,16,0,(cnv.height/scale/14|0)+8*_i,16,16);ctx.font="2px futura",ctx.textAlign="center",["Armour","Accel","Turn"].forEach(((e,t)=>{ctx.fillStyle=colours[3],ctx.fillRect(-5,cnv.height/scale/5+4*t,10,2.5),ctx.fillStyle=colours[8],ctx.fillRect(-5,cnv.height/scale/5+4*t,10*shipStats(_ship)[t]/mStats[t],2.5),ctx.fillStyle=colours[0],ctx.fillText(e,0,cnv.height/scale/5+4*t+2)})),ctx.restore()};function bind(){socket.on("state",(e=>{game.receiveState(e)})),socket.on("connect",(()=>{})),socket.on("joined",(()=>{title.style.visibility="hidden",randBtn.style.visibility="hidden",playBtn.style.visibility="hidden",resetTouches(),game=new Game(!1,socket.id)})),socket.on("score",(e=>{for(game._points=e,_iI=0;_iI<e.length;_iI++)game.players[e[_iI][2]].points=e[_iI][0]})),socket.on("end",(()=>{game&&setTimeout(endGame,3e3)})),socket.on("disconnect",(()=>{game&&endGame()}))}document.body.appendChild(cnv),size(),addEventListener("orientationchange",size),setTimeout(randomPlayer,200),circles(0,[1,0]),(cam=new Obj(null,null,0,0,cnv.width,cnv.height)).bg=[],cam.off=vec(),cam.shk=vec(),cam.shaking=!1,cam.shake=e=>{cam.shaking=e?"1":"5",cam.shk.vFrD(e).unit().scl(-5)},cam.size=e=>{cam.w=cnv.width,cam.h=cnv.height},cam.offScreen=e=>e.pos.x+e.w/2<cam.pos.x||e.pos.x-e.w/2>cam.pos.x+cam.w/scale||e.pos.y+e.w/2<cam.pos.y||e.pos.y-e.w/2>cam.pos.y+cam.h/scale,cam.follow=()=>{cw=cam.w/scale,ch=cam.h/scale,_p=game.player,dScl=Math.min(_p.vel.mag()/5,1),aScl=bScl-dScl,Math.abs(scale-aScl<sSpd)?scale=aScl:scale>aScl?scale-=sSpd:scale+=sSpd,cam.tDir.copy(_p.pos).sub({x:cam.w/2/scale,y:cam.h/2/scale}).add(_tV.vFrD(_p.dir).scl(cam.w/8/scale)),cam.off.copy(cam.tDir).sub(cam.pos).mag(),cam.off.m>100?cam.off.scl(.5):cam.off.m>1.5&&cam.off.unit().scl(1.5),cam.off.add(game.player.vel),cam.pos.add(cam.off),mouse.add(cam.off),cam.shaking&&(cam.shaking>1?(cam.shk.vFrD(Math.random()*PI*2).scl(5),cam.shaking--):cam.shk.scl(.5),(cam.shk.mag()<.05||cam.shaking<1)&&(cam.shaking=!1)),cam.bg=[],_X=cam.pos.x>0?cam.pos.x%512:512- -cam.pos.x%512,_Y=cam.pos.y>0?cam.pos.y%512:512- -cam.pos.y%512,_W=Math.min(cw,512-_X),_H=Math.min(ch,512-_Y),cam.bg.push([_X,_Y,_W,_H]),_W<cw&&(cam.bg[1]=[0,_Y,cw-_W,_H,_W]),_H<ch&&(cam.bg[2]=[_X,0,_W,ch-_H,,_H]),_W<cw&&_H<ch&&(cam.bg[3]=[0,0,cw-_W,ch-_H,_W,_H])},db.onkeydown=keyH,db.onkeyup=keyH,db.onmousedown=mouseH,db.onmousemove=mouseH,db.onmouseup=mouseH,db.addEventListener("touchstart",touchH,{passive:!1}),db.addEventListener("touchmove",touchH,{passive:!1}),db.addEventListener("touchend",touchH,{passive:!1});let _source,_gain,audioCtx=null,sampleRate=0,sounds={},instruments={},halfStep=1.059463094,square=(e,t)=>(e%t|0)/(t/2)|0?-1:1,sine=(e,t)=>Math.sin(6.28*e/t),saw=(e,t)=>e%t/t*2-1,linear=e=>e,smoothStep=e=>e*e*Math.pow(3-2*e,1),acceleration=e=>e*e,deceleration=e=>1-Math.pow(1-e,2),motifs=[[1,2],[4,5]],songs={test:{bpm:140,npb:4,parts:[["test",0,40,4,8],["test",1,40,4,8,17]]}},_song=[0,1],_seq=[0,4,0,6],startAudio=()=>{sampleRate=audioCtx.sampleRate,createInstrument(["shoot",76,16,[3,660,.01,.1,.1,.2,.1,-220,1,40,1,-8,3]]),createInstrument(["splode",40,16,[1,120,.01,.1,.1,.5,0,-60,1,25,1,-15]]),createInstrument(["hit",40,16,[1,120,.01,.05,.05,.4,0,-5,1,25,.8,-5]]),createInstrument(["lead",20,25,[3,,.1,.1,.2,.5,.05,-1,1,20,.05,-1]]),createInstrument(["beat",45,1,[2,,.01,.1,.03,0,0,-100]]),sounds.hat=createBuffer([0,,.02,0,.01,1,.015,,0,10,1]),playBuffer("beat",.001,45)},createInstrument=e=>{instruments[e[0]]=instruments[e[0]]||{};let t=instruments[e[0]];for(let a=0,c=e[2];a<c;a++)e[3][1]=freqFromMidi(e[1]+a),t[e[1]+a]=createBuffer(e[3])},createBuffer=e=>{let t=e[0],a=e[1],c=e[2]*sampleRate,s=e[3]*sampleRate,i=e[4]*sampleRate,o=e[5],l=e[6]*sampleRate,n=e[7]||0,r=e[8]||-1,m=e[9]||0,h=e[10]||0,_=e[11]||0,p=e[12]||0,d=c+s,u=d+i,g=sampleRate/a,x=0,f=audioCtx.createBuffer(2,u+l,sampleRate),y=null,w=f.length,b=0,v=0,I=0,S=e=>{e<=c?v=e/c:e<=d&&(v=-(e-d)/s*(1-o)+o),e>u&&(v=(-(e-u)/l+1)*o)};for(let e=0;e<2;e++){y=f.getChannelData(e);for(let e=0,c=w;e<c;e++)p||(x=linear(e/c)),1==p&&(x=smoothStep(e/c)),2==p&&(x=acceleration(e/c)),3==p&&(x=deceleration(e/c)),g=sampleRate/(a+n*x),t||(b=Math.max(.8,2*Math.random()-1)),1==t&&(b=square(e,g)),2==t&&(b=sine(e,g)),3==t&&(b=saw(e,g)),I=1,1==r&&(I=square(e,sampleRate/(m+_*x))*h+(1-h)),2==r&&(I=sine(e,sampleRate/(m+_*x))*h+(1-h)),3==r&&(I=saw(e,sampleRate/(m+_*x))*h+(1-h)),I=I/2+.5,S(e),y[e]=b*I*v}return f},freqFromMidi=e=>roundToTwo(440*Math.pow(halfStep,e-69)),roundToTwo=e=>Math.round(100*e)/100,playBuffer=(e,t,a)=>{_source=audioCtx.createBufferSource(),(_gain=audioCtx.createGain()).gain.value=t||.5,_source.buffer=a?instruments[e][a]:sounds[e],_source.connect(_gain),_gain.connect(audioCtx.destination),_source.start()};function init(){socket=io({path:location.pathname+"io",upgrade:!1,transports:["websocket"]}),bind()}window.addEventListener("load",init,!1)</script>