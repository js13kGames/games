<!DOCTYPE html><html><head><title>Castle Attack</title><meta charset="utf-8"><style>body {margin:0;overflow:hidden;background-color: #000;}canvas {width:100%;}</style></head><body><canvas width="1200" height="600" id="canvas"></canvas><script>var zzfx,zzfxV,zzfxX,nbS = [];nbS[0.06] = 0;nbS[0.22] = 0;zzfxV=.3,    zzfx=(p=1,k=.05,b=220,e=0,r=0,t=.1,q=0,D=1,u=0,y=0,v=0,z=0,l=0,E=0,A=0,F=0,c=0,w=1,m=0,B=0,M=Math,R=44100,d=2*M.PI,G=u*=500*d/R/R,C=b*=(1-k+2*k*M.random(k=[]))*d/R,g=0,H=0,a=0,n=1,I=0,J=0,f=0,x,h)=>{if(nbS[B]==10) { return; }nbS[B]++;e=R*e+9;m*=R;r*=R;t*=R;c*=R;y*=500*d/R**3;A*=d/R;v*=d/R;z*=R;l=R*l|0;for(h=e+m+r+t+c|0;a<h;k[a++]=f)++J%(100*F|0)||(f=q?1<q?2<q?3<q?M.sin((g%d)**3):M.max(M.min(M.tan(g),1),-1):1-(2*g/d%2+2)%2:1-4*M.abs(M.round(g/d)-g/d):M.sin(g),f=(l?1-B+B*M.sin(d*a/l):1)*(0<f?1:-1)*M.abs(f)**D*zzfxV*p*(a<e?a/e:a<e+m?1-(a-e)/m*(1-w):a<e+m+r?w:a<h-c?(h-a-c)/t*w:0),f=c?f/2+(c>a?0:(a<h-c?1:(h-a)/c)*k[a-c|0]/2):f),x=(b+=u+=y)*M.cos(A*H++),g+=x-x*E*(1-1E9*(M.sin(a)+1)%2),n&&++n>z&&(b+=v,C+=v,n=0),!l||++I%l||(b=C,u=G,n||=1);p=zzfxX.createBuffer(1,h,R);p.getChannelData(0).set(k);b=zzfxX.createBufferSource();b.buffer=p;b.connect(zzfxX.destination);b.onended=()=>{nbS[B]--};b.start();return b};zzfxX=new AudioContext;</script><script>class vec2{static create(){return new Float32Array([0,0])}static xLen(t,e){return t[0]*e[1]-t[1]*e[0]}static rotate(t,e,a){var o=Math.cos(a),s=Math.sin(a),[i,r]=e;t[0]=o*i-s*r,t[1]=s*i+o*r}static rotate90cw(t,e){t[0]=e[1],t[1]=-e[0]}static centroid(t,e,a,o){vec2.add(t,e,a),vec2.add(t,t,o),vec2.scale(t,t,1/3)}static fromValues(t,e){return new Float32Array([t,e])}static copy(t,e){t.set(e)}static set(t,e,a){t.set([e,a])}static add(t,e,a){t[0]=e[0]+a[0],t[1]=e[1]+a[1]}static sub(t,e,a){t[0]=e[0]-a[0],t[1]=e[1]-a[1]}static mult(t,e,a){t[0]=e[0]*a[0],t[1]=e[1]*a[1]}static scale(t,e,a){return t[0]=e[0]*a,t[1]=e[1]*a,t}static length(t){var[e,a]=t;return Math.sqrt(e*e+a*a)}static sqLen(t){var[e,a]=t;return e*e+a*a}static norm(t,e){var[a,o]=e,s=a*a+o*o;s>0&&(s=1/Math.sqrt(s),t[0]=e[0]*s,t[1]=e[1]*s)}static dot(t,e){return t[0]*e[0]+t[1]*e[1]}}class AABB{constructor(){this.lowerBound=vec2.create(),this.upperBound=vec2.create()}setFromPoints(t,e,a){var o=this.lowerBound,s=this.upperBound;vec2.rotate(o,t[0],a),vec2.copy(s,o);for(var i=Math.cos(a),r=Math.sin(a),n=1;n<t.length;n++)for(var[c,l]=t[n],p=[i*c-r*l,r*c+i*l],h=0;h<2;h++)p[h]>s[h]&&(s[h]=p[h]),p[h]<o[h]&&(o[h]=p[h]);e&&(vec2.add(this.lowerBound,this.lowerBound,e),vec2.add(this.upperBound,this.upperBound,e))}copy(t){vec2.copy(this.lowerBound,t.lowerBound),vec2.copy(this.upperBound,t.upperBound)}overlaps(t){var e=this.lowerBound,a=this.upperBound,o=t.lowerBound,s=t.upperBound;return(o[0]<=a[0]&&a[0]<=s[0]||e[0]<=s[0]&&s[0]<=a[0])&&(o[1]<=a[1]&&a[1]<=s[1]||e[1]<=s[1]&&s[1]<=a[1])}}class Shape{constructor(t={}){this.body=null,this.position=vec2.fromValues(0,0),this.angle=0,this.type=t.type,this.id=ShapeIDCounter++,this.material=null}}class Box extends Shape{constructor(t){var e=t.width,a=t.height;switch(t.type){case"box":case"triangleD":var o=[[-.5,-.5],[.5,-.5],[.5,.5],[-.5,.5]];break;case"triangle3":o=[[-.5,-.5],[0,-.5],[.5,-.5],[0,.5]];break;case"triangleA":o=[[-.5,-.5],[0,-.5],[.5,-.5],[0,0]];break;case"triangleB":o=[[-.5,-.5],[0,-.5],[.5,-.5],[.5,.5]];break;case"triangleC":o=[[-.5,-.5],[0,-.5],[.5,-.5],[-.5,.5]]}t.type=8,super(t),this.vertices=o.map(t=>vec2.fromValues(e*t[0],a*t[1])),this.width=e,this.height=a}cMI(t){return t*(this.height**2+this.width**2)/12}computeAABB(t,e,a){t.setFromPoints(this.vertices,e,a)}}class Plane extends Shape{constructor(){super({type:4})}computeAABB(t,e,a){var o=a%(2*Math.PI);vec2.set(t.lowerBound,-1e7,-1e7),vec2.set(t.upperBound,1e7,1e7),0===o?t.upperBound[1]=0:o===Math.PI?t.lowerBound[1]=0:o===Math.PI/2?t.lowerBound[0]=0:o===3*Math.PI/2&&(t.upperBound[0]=0)}}class Circ extends Shape{constructor(t={}){t.type=1,super(t),this.radius=t.radius}cMI(t){return t*this.radius**2/2}computeAABB(t,e,a){vec2.set(t.upperBound,this.radius,this.radius),vec2.set(t.lowerBound,-this.radius,-this.radius),e&&(vec2.add(t.lowerBound,t.lowerBound,e),vec2.add(t.upperBound,t.upperBound,e))}}class ContactMaterial{constructor(t,e,a={}){this.id=ContactMaterialIDCounter++,this.materialA=t,this.materialB=e,this.friction=a.friction||.3,this.restitution=a.restitution||0,this.stiffness=a.stiffness||1e6}}class TupleDict{constructor(){this.data={},this.keys=[]}getKey(t,e){return 0|(t>e?t<<16|65535&e:e<<16|65535&t)}get(t,e){return this.data[this.getKey(t,e)]}set(t,e,a){var o=this.getKey(t,e);return this.data[o]||this.keys.push(o),this.data[o]=a,o}reset(){for(var t=this.keys,e=t.length;e--;)delete this.data[t[e]];t.length=0}copy(t){this.reset(),this.keys.push(...t.keys);for(var e=t.keys.length;e--;){var a=t.keys[e];this.data[a]=t.data[a]}}}class OverlapKeeperRecord{constructor(t,e,a,o){this.set(...arguments)}set(t,e,a,o){this.shapeA=e,this.shapeB=o,this.bodyA=t,this.bodyB=a}}class Equation{constructor(t,e){this.minForce=0,this.maxForce=Number.MAX_VALUE,this.bodyA=t,this.bodyB=e,this.stiffness=1e6,this.G=new Float32Array(6).fill(0),this.a=0,this.b=0,this.epsilon=0,this.timeStep=1/60,this.multiplier=0}update(){var t=this.timeStep;this.a=4/(17*t),this.b=16/17,this.epsilon=4/(t**2*this.stiffness*17)}gmult(t,e,a,o,s){return t[0]*e[0]+t[1]*e[1]+t[2]*a+t[3]*o[0]+t[4]*o[1]+t[5]*s}computeGW(){var t=this.bodyA,e=this.bodyB;return this.gmult(this.G,t.vel,t.angVel,e.vel,e.angVel)}computeGiMf(){var t=this.bodyA,e=this.bodyB,a=vec2.scale(vec2.create(),t.force,t.invMassSolve),o=vec2.scale(vec2.create(),e.force,e.invMassSolve);return vec2.mult(a,t.massMultiplier,a),vec2.mult(o,e.massMultiplier,o),this.gmult(this.G,a,0,o,0)}addToWlambda(t){var e=this.bodyA,a=this.bodyB,o=this.G,s=vec2.fromValues(o[0],o[1]),i=vec2.fromValues(o[3],o[4]),r=vec2.create();vec2.scale(r,s,e.invMassSolve*t),vec2.mult(r,r,e.massMultiplier),vec2.add(e.vlambda,e.vlambda,r),e.wlambda+=e.invInertiaSolve*o[2]*t,vec2.scale(r,i,a.invMassSolve*t),vec2.mult(r,r,a.massMultiplier),vec2.add(a.vlambda,a.vlambda,r),a.wlambda+=a.invInertiaSolve*o[5]*t}computeInvC(t){var e=this.bodyA,a=this.bodyB,o=e.invMassSolve,s=a.invMassSolve,i=e.invInertiaSolve,r=a.invInertiaSolve,n=this.G;return 1/(n[0]*n[0]*o*e.massMultiplier[0]+n[1]*n[1]*o*e.massMultiplier[1]+n[2]*n[2]*i+n[3]*n[3]*s*a.massMultiplier[0]+n[4]*n[4]*s*a.massMultiplier[1]+n[5]*n[5]*r+t)}}class ContactEquation extends Equation{constructor(t,e){super(t,e),this.conPtA=vec2.create(),this.penetrationVec=vec2.create(),this.conPtB=vec2.create(),this.normalA=vec2.create(),this.restitution=0,this.firstImpact=!1}computeB(t,e,a){var o=this.bodyA,s=this.bodyB,i=this.penetrationVec,r=this.normalA,n=vec2.xLen(this.conPtA,r),c=vec2.xLen(this.conPtB,r);this.G.set([-r[0],-r[1],-n,r[0],r[1],c]),vec2.add(i,s.position,this.conPtB),vec2.sub(i,i,o.position),vec2.sub(i,i,this.conPtA);var l=this.computeGW(),p=0;return this.firstImpact&&0!==this.restitution?l*=1/e*(1+this.restitution):p=vec2.dot(r,i),-p*t-l*e-a*this.computeGiMf()}}class FrictionEquation extends Equation{constructor(){super(),this.conPtA=vec2.create(),this.conPtB=vec2.create(),this.t=vec2.create(),this.conEqs=[],this.frictionCoefficient=.3}computeB(t,e,a){var o=this.t;return this.G.set([-o[0],-o[1],-vec2.xLen(this.conPtA,o),o[0],o[1],vec2.xLen(this.conPtB,o)]),-this.computeGW()*e-a*this.computeGiMf()}}class Pool{constructor(t,e){this.objects=Array.from({length:e},()=>new t)}get(t){return this.objects.length?this.objects.pop():new t}release(t){t.bodyA=t.bodyB=null,this.objects.push(t)}}class OverlapKeeper{constructor(){this.overlappingShapesLastState=new TupleDict,this.overlappingShapesCurrentState=new TupleDict,this.recordPool=new Pool(OverlapKeeperRecord,16)}tick(){for(var t=this.overlappingShapesLastState,e=this.overlappingShapesCurrentState,a=t.keys.length;a--;){var o=t.data[t.keys[a]];o&&this.recordPool.release(o)}t.reset(),t.copy(e),e.reset()}setOverlapping(t,e,a,o){var s=this.overlappingShapesCurrentState;if(!s.get(e.id,o.id)){var i=this.recordPool.get(OverlapKeeperRecord);i.set(t,e,a,o),s.set(e.id,o.id,i)}}}class Narrowphase{constructor(){this.conEqs=[],this.conEqPool=new Pool(ContactEquation,32),this.fricEqs=[],this.frictionCoefficient=.3,this.frictionEquationPool=new Pool(FrictionEquation,64),this.restitution=0,this.stiffness=1e6,this.collidePrev=new TupleDict}reset(){this.collidePrev.reset();for(var t=this.conEqs,e=t.length;e--;){var a=t[e];this.collidePrev.set(a.bodyA.id,a.bodyB.id,!0)}for(var o=0;o<this.conEqs.length;o++)this.conEqPool.release(this.conEqs[o]);for(o=0;o<this.fricEqs.length;o++)this.frictionEquationPool.release(this.fricEqs[o]);this.conEqs.length=this.fricEqs.length=0}createContactEquation(t,e,a,o){var s=this.conEqPool.get(ContactEquation);return s.bodyA=t,s.bodyB=e,s.restitution=this.restitution,s.firstImpact=!this.collidePrev.get(t.id,e.id),s.stiffness=this.stiffness,s}createFrictionEquation(t,e,a,o){var s=this.frictionEquationPool.get(FrictionEquation);return s.bodyA=t,s.bodyB=e,s.maxForce=this.slipForce,s.minForce=-this.slipForce,s.frictionCoefficient=this.frictionCoefficient,s.conEqs.length=0,s.stiffness=1e6,s}createFrictionFromContact(t){var e=this.createFrictionEquation(t.bodyA,t.bodyB,t.shapeA,t.shapeB);return e.conPtA.set(t.conPtA),e.conPtB.set(t.conPtB),vec2.rotate90cw(e.t,t.normalA),e.conEqs.push(t),e}createFrictionFromAverage(t){var e=this.conEqs[this.conEqs.length-1],a=this.createFrictionEquation(e.bodyA,e.bodyB,e.shapeA,e.shapeB),o=e.bodyA;vec2.set(a.conPtA,0,0),vec2.set(a.conPtB,0,0),vec2.set(a.t,0,0);for(var s=0;s!==t;s++)(e=this.conEqs[this.conEqs.length-1-s]).bodyA===o?(vec2.add(a.t,a.t,e.normalA),vec2.add(a.conPtA,a.conPtA,e.conPtA),vec2.add(a.conPtB,a.conPtB,e.conPtB)):(vec2.sub(a.t,a.t,e.normalA),vec2.add(a.conPtA,a.conPtA,e.conPtB),vec2.add(a.conPtB,a.conPtB,e.conPtA)),a.conEqs.push(e);var i=1/t;return vec2.scale(a.conPtA,a.conPtA,i),vec2.scale(a.conPtB,a.conPtB,i),vec2.norm(a.t,a.t),vec2.rotate90cw(a.t,a.t),a}circCvx(t,e,a,o,s,i,r,n){for(var c=e.radius,l=!1,p=Number.MAX_VALUE,h=i.vertices,m=0;m!==h.length+1;m++){var v=h[m%h.length],d=h[(m+1)%h.length];if(vec2.rotate(tmp1,v,n),vec2.rotate(tmp2,d,n),vec2.add(tmp1,tmp1,r),vec2.add(tmp2,tmp2,r),vec2.sub(tmp3,tmp2,tmp1),vec2.norm(tmp4,tmp3),vec2.rotate90cw(tmp5,tmp4),vec2.scale(tmp14,tmp5,-e.radius),vec2.add(tmp14,tmp14,a),Narrowphase.pointInCvx(tmp14,i,r,n)){vec2.sub(tmp15,tmp1,tmp14);var x=Math.abs(vec2.dot(tmp15,tmp5));x<p&&(vec2.copy(tmp16,tmp14),p=x,vec2.scale(tmp13,tmp5,x),vec2.add(tmp13,tmp13,tmp14),l=!0)}}if(l){var u=this.createContactEquation(t,s,e,i);return vec2.sub(u.normalA,tmp16,a),vec2.norm(u.normalA,u.normalA),vec2.scale(u.conPtA,u.normalA,c),vec2.add(u.conPtA,u.conPtA,a),vec2.sub(u.conPtA,u.conPtA,t.position),vec2.sub(u.conPtB,tmp13,r),vec2.add(u.conPtB,u.conPtB,r),vec2.sub(u.conPtB,u.conPtB,s.position),this.conEqs.push(u),this.fricEqs.push(this.createFrictionFromContact(u)),1}for(m=0;m<h.length;m++){var f=h[m];if(vec2.rotate(tmp11,f,n),vec2.add(tmp11,tmp11,r),vec2.sub(tmp10,tmp11,a),vec2.sqLen(tmp10)<Math.pow(c,2)){u=this.createContactEquation(t,s,e,i);return vec2.copy(u.normalA,tmp10),vec2.norm(u.normalA,u.normalA),vec2.scale(u.conPtA,u.normalA,c),vec2.add(u.conPtA,u.conPtA,a),vec2.sub(u.conPtA,u.conPtA,t.position),vec2.sub(u.conPtB,tmp11,r),vec2.add(u.conPtB,u.conPtB,r),vec2.sub(u.conPtB,u.conPtB,s.position),this.conEqs.push(u),this.fricEqs.push(this.createFrictionFromContact(u)),1}}return 0}static pointInCvx(t,e,a,o){for(var s=t,i=e.vertices,r=null,n=0;n!==i.length+1;n++){var c=i[n%i.length],l=i[(n+1)%i.length];vec2.rotate(tmp17,c,o),vec2.rotate(tmp18,l,o),vec2.add(tmp17,tmp17,a),vec2.add(tmp18,tmp18,a),vec2.sub(tmp19,tmp17,s),vec2.sub(tmp20,tmp18,s);var p=vec2.xLen(tmp19,tmp20);if(null===r&&(r=p),p*r<=0)return!1;r=p}return!0}planeCvx(t,e,a,o,s,i,r,n){var c=0;vec2.rotate(tmp2,tmp12,o);for(var l=0;l!==i.vertices.length;l++){var p=i.vertices[l];if(vec2.rotate(tmp1,p,n),vec2.add(tmp1,tmp1,r),vec2.sub(tmp3,tmp1,a),vec2.dot(tmp3,tmp2)<=0){c++;var h=this.createContactEquation(t,s,e,i);vec2.sub(tmp3,tmp1,a),vec2.copy(h.normalA,tmp2),vec2.scale(tmp3,h.normalA,vec2.dot(tmp3,h.normalA)),vec2.sub(h.conPtB,tmp1,s.position),vec2.sub(h.conPtA,tmp1,tmp3),vec2.sub(h.conPtA,h.conPtA,t.position),this.conEqs.push(h)}}return c&&this.fricEqs.push(this.createFrictionFromAverage(c)),c}circPlane(t,e,a,o,s,i,r,n){var c=s,l=r,p=n;vec2.sub(tmp1,a,l),vec2.rotate(tmp2,tmp12,p);var h=vec2.dot(tmp2,tmp1);if(h>e.radius)return 0;var m=this.createContactEquation(c,t,i,e);return vec2.copy(m.normalA,tmp2),vec2.scale(m.conPtB,m.normalA,-e.radius),vec2.add(m.conPtB,m.conPtB,a),vec2.sub(m.conPtB,m.conPtB,t.position),vec2.scale(tmp3,m.normalA,h),vec2.sub(m.conPtA,tmp1,tmp3),vec2.add(m.conPtA,m.conPtA,l),vec2.sub(m.conPtA,m.conPtA,c.position),this.conEqs.push(m),this.fricEqs.push(this.createFrictionFromContact(m)),1}circCirc(t,e,a,o,s,i,r,n){vec2.sub(tmp1,a,r);var c=e.radius+i.radius;if(vec2.sqLen(tmp1)>Math.pow(c,2))return 0;var l=this.createContactEquation(t,s,e,i);return vec2.sub(l.normalA,r,a),vec2.norm(l.normalA,l.normalA),vec2.scale(l.conPtA,l.normalA,e.radius),vec2.scale(l.conPtB,l.normalA,-i.radius),vec2.add(l.conPtA,l.conPtA,a),vec2.sub(l.conPtA,l.conPtA,t.position),vec2.add(l.conPtB,l.conPtB,r),vec2.sub(l.conPtB,l.conPtB,s.position),this.conEqs.push(l),this.fricEqs.push(this.createFrictionFromContact(l)),1}cvxCvx(t,e,a,o,s,i,r,n){var c=0;if(!Narrowphase.findSeparatingAxis(e,a,o,i,r,n,tmp1))return 0;vec2.sub(tmp8,r,a),vec2.dot(tmp1,tmp8)>0&&vec2.scale(tmp1,tmp1,-1);var l=Narrowphase.getClosestEdge(e,o,tmp1,!0),p=Narrowphase.getClosestEdge(i,n,tmp1);if(-1===l||-1===p)return 0;for(var h=0;h<2;h++){var m=l,v=p,d=e,x=i,u=a,f=r,E=o,b=n,g=t,B=s;0===h&&([m,v]=[v,m],[d,x]=[x,d],[u,f]=[f,u],[E,b]=[b,E],[g,B]=[B,g]);for(var M=v;M<v+2;M++){var y=x.vertices[(M+x.vertices.length)%x.vertices.length];vec2.rotate(tmp2,y,b),vec2.add(tmp2,tmp2,f);for(var W=0,w=m-1;w<m+2;w++){var A=d.vertices[(w+d.vertices.length)%d.vertices.length],C=d.vertices[(w+1+d.vertices.length)%d.vertices.length];vec2.rotate(tmp3,A,E),vec2.rotate(tmp4,C,E),vec2.add(tmp3,tmp3,u),vec2.add(tmp4,tmp4,u),vec2.sub(tmp5,tmp4,tmp3),vec2.rotate90cw(tmp9,tmp5),vec2.norm(tmp9,tmp9),vec2.sub(tmp8,tmp2,tmp3);var P=vec2.dot(tmp9,tmp8);(w===m&&P<=0||w!==m&&P<=0)&&W++}if(W>=3){var D=this.createContactEquation(g,B,d,x);c++;A=d.vertices[m%d.vertices.length],C=d.vertices[(m+1)%d.vertices.length];vec2.rotate(tmp3,A,E),vec2.rotate(tmp4,C,E),vec2.add(tmp3,tmp3,u),vec2.add(tmp4,tmp4,u),vec2.sub(tmp5,tmp4,tmp3),vec2.rotate90cw(D.normalA,tmp5),vec2.norm(D.normalA,D.normalA),vec2.sub(tmp8,tmp2,tmp3);P=vec2.dot(D.normalA,tmp8);vec2.scale(tmp7,D.normalA,P),vec2.sub(D.conPtA,tmp2,u),vec2.sub(D.conPtA,D.conPtA,tmp7),vec2.add(D.conPtA,D.conPtA,u),vec2.sub(D.conPtA,D.conPtA,g.position),vec2.sub(D.conPtB,tmp2,f),vec2.add(D.conPtB,D.conPtB,f),vec2.sub(D.conPtB,D.conPtB,B.position),this.conEqs.push(D)}}}return c&&this.fricEqs.push(this.createFrictionFromAverage(c)),c}static projectCvxOntoAxis(t,e,a,o,s){var i=-1/0,r=1/0;vec2.rotate(tmp21,o,-a);for(var n=0;n<t.vertices.length;n++){var c=t.vertices[n],l=vec2.dot(c,tmp21);i=Math.max(i,l),r=Math.min(r,l)}r>i&&([r,i]=[i,r]);var p=vec2.dot(e,o);vec2.set(s,r+p,i+p)}static findSeparatingAxis(t,e,a,o,s,i,r){var n=null,c=!1;if(t instanceof Box&&o instanceof Box)for(var l=0;2!==l;l++){var p=t,h=a;1===l&&(p=o,h=i);for(var m=0;2!==m;m++){0===m?vec2.set(tmp25,0,1):1===m&&vec2.set(tmp25,1,0),0!==h&&vec2.rotate(tmp25,tmp25,h),Narrowphase.projectCvxOntoAxis(t,e,a,tmp25,tmp26),Narrowphase.projectCvxOntoAxis(o,s,i,tmp25,tmp27);var v=tmp27[0]-tmp26[1];if(tmp26[0]>tmp27[0])v=tmp26[0]-tmp27[1];(null===n||v>n)&&(vec2.copy(r,tmp25),n=v,c=v<=0)}}else for(l=0;2!==l;l++){p=t,h=a;1===l&&(p=o,h=i);for(m=0;m!==p.vertices.length;m++){vec2.rotate(tmp23,p.vertices[m],h),vec2.rotate(tmp24,p.vertices[(m+1)%p.vertices.length],h),sub(tmp22,tmp24,tmp23),vec2.rotate90cw(tmp25,tmp22),vec2.norm(tmp25,tmp25),Narrowphase.projectCvxOntoAxis(t,e,a,tmp25,tmp26),Narrowphase.projectCvxOntoAxis(o,s,i,tmp25,tmp27);v=tmp27[0]-tmp26[1];if(tmp26[0]>tmp27[0])v=tmp26[0]-tmp27[1];(null===n||v>n)&&(vec2.copy(r,tmp25),n=v,c=v<=0)}}return c}static getClosestEdge(t,e,a,o){vec2.rotate(tmp28,a,-e),o&&vec2.scale(tmp28,tmp28,-1);for(var s=-1,i=t.vertices.length,r=-1,n=0;n!==i;n++){vec2.sub(tmp29,t.vertices[(n+1)%i],t.vertices[n%i]),vec2.rotate90cw(tmp30,tmp29),vec2.norm(tmp30,tmp30);var c=vec2.dot(tmp30,tmp28);(-1===s||c>r)&&(s=n%i,r=c)}return s}}class GSSolver{constructor(){this.type=1,this.lambda=new Float32Array(30),this.Bs=new Float32Array(30),this.invCs=new Float32Array(30)}solve(t,e){for(var a=e.length,o=world.bodies,s=world.bodies.length,i=0;i!==s;i++){var r=o[i];2===o[i].sleepState?(r.invMassSolve=0,r.invInertiaSolve=0):(r.invMassSolve=r.invMass,r.invInertiaSolve=r.invInertia)}this.lambda.length<a&&(this.lambda=new Float32Array(a+30),this.Bs=new Float32Array(a+30),this.invCs=new Float32Array(a+30)),this.lambda.fill(0);for(i=0;i!==e.length;i++){(p=e[i]).timeStep=t,p.update(),this.Bs[i]=p.computeB(p.a,p.b,t),this.invCs[i]=p.computeInvC(p.epsilon)}if(0!==a){for(i=0;i!==s;i++)o[i].vlambda=[0,0],o[i].wlambda=0;for(var n=0;10!==n;n++){for(var c=0,l=0;l!==a;l++){var p=e[l],h=this.lambda[l],m=p.gmult(p.G,p.bodyA.vlambda,p.bodyA.wlambda,p.bodyB.vlambda,p.bodyB.wlambda),v=p.maxForce,d=p.minForce,x=this.invCs[l]*(this.Bs[l]-m-p.epsilon*h);h+x<d*t?x=d*t-h:h+x>v*t&&(x=v*t-h),this.lambda[l]+=x,p.addToWlambda(x),c+=Math.abs(x)}if(c*c<=0)break}for(i=0;i!==s;i++)vec2.add(o[i].vel,o[i].vel,o[i].vlambda),o[i].angVel+=o[i].wlambda;for(var u=e.length;u--;)e[u].multiplier=1*this.lambda[u]/t}}}class Body{constructor(t){this.id=++BodyIDCounter,this._ID=void 0!==t.ID?t.ID:null,null!==this._ID&&(this.Y=!0),this.mass=t.mass||0,this.invMassSolve=0,this.invInertiaSolve=0,this.massMultiplier=vec2.create(),this.position=vec2.fromValues(t.position[0],t.position[1]),this.vel=vec2.fromValues(0,0),this.vlambda=vec2.fromValues(0,0),this.wlambda=0,this.angle=t.angle||0,this.angVel=0,this.force=vec2.create(),this.type=t.mass?1:2,this.aabb=new AABB,this.wantSleep=!1,this.sleepState=0,this.sleepSpeedLimit=.15,this.sleepTimeLimit=2,this.idleTime=0,this.narrowWakeUp=!1,t.shape.body=this,this.shape=t.shape,2===this.type?(this.mass=Number.MAX_VALUE,this.invMass=0,this.inertia=Number.MAX_VALUE,this.invInertia=0):(this.inertia=this.shape.cMI(this.mass)+this.mass*vec2.sqLen(this.shape.position),this.invInertia=this.inertia>0?1/this.inertia:0,this.invMass=1/this.mass,this.massMultiplier.set([1,1])),world.bodies.push(this)}sleepTick(t){2!==this.type&&(vec2.sqLen(this.vel)+Math.pow(this.angVel,2)>=Math.pow(this.sleepSpeedLimit,2)?(this.idleTime=0,this.sleepState=0):(this.idleTime+=t,this.sleepState=1,this.idleTime>this.sleepTimeLimit&&(this.sleepState=2,this.angVel=0,this.vel=[0,0],this.force=[0,0])))}integrate(t){vec2.scale(tmp31,this.force,t*this.invMass),vec2.mult(tmp31,this.massMultiplier,tmp31),vec2.add(this.vel,tmp31,this.vel),vec2.scale(tmp32,this.vel,t),vec2.add(this.position,this.position,tmp32),this.angle+=this.angVel*t,vec2.rotate(tmp,this.shape.position,this.angle),vec2.add(tmp,tmp,this.position),this.shape.computeAABB(shapeAABB,tmp,this.shape.angle+this.angle),this.aabb.copy(shapeAABB)}}class World{constructor(){this.bodies=[],this.solver=new GSSolver,this.narrowphase=new Narrowphase;this.gravity=vec2.fromValues(0,-0),this.defaultMaterial={id:MaterialIDCounter++},this.defConMat=new ContactMaterial(this.defaultMaterial,this.defaultMaterial),this.conMats=[],this.stepping=!1,this.removeBodies=[],this.overlapKeeper=new OverlapKeeper}step(t){this.stepping=!0;var e=this.bodies,a=this.bodies.length,o=this.narrowphase;this.overlapKeeper.tick();for(var s=0;s!==a;s++){1===(r=e[s]).type&&2!==r.sleepState&&(vec2.scale(tmp33,this.gravity,r.mass),vec2.add(r.force,r.force,tmp33))}var i=[];for(s=1;s!==a;s++){for(var r=e[s],n=s-1;n>=0&&!(e[n].aabb.lowerBound[0]<=r.aabb.lowerBound[0]);n--)e[n+1]=e[n];e[n+1]=r}for(s=0;s!==a;s++)for(r=e[s],n=s+1;n<a;n++){var c=e[n];if(c.aabb.lowerBound[0]>r.aabb.upperBound[0])break;!(2===r.type&&2===c.type||2===r.sleepState&&2===c.sleepState||2===r.sleepState&&2===c.type||2===c.sleepState&&2===r.type)&&r.aabb.overlaps(c.aabb)&&i.push(r,c)}o.reset();for(s=0;s!==i.length;s+=2){var l=i[s],p=i[s+1],h=!1;if(l.shape.material&&p.shape.material)for(n=0;n!==this.conMats.length;n++){var m=this.conMats[n];if(m.materialA.id===l.shape.material.id&&m.materialB.id===p.shape.material.id||m.materialA.id===p.shape.material.id&&m.materialB.id===l.shape.material.id){h=m;break}}this.runNarrowphase(o,l,l.shape,l.shape.position,l.shape.angle,p,p.shape,p.shape.position,p.shape.angle,h||this.defConMat,-this.gravity[1])}for(s=0;s!==a;s++){(r=e[s]).narrowWakeUp&&(r.idleTime=0,r.sleepState=0,r.narrowWakeUp=!1)}(o.conEqs.length||o.fricEqs.length)&&this.solver.solve(t,o.conEqs.concat(o.fricEqs));for(s=0;s!==a;s++){(r=e[s]).integrate(t),r.force=[0,0]}for(s=0;s!==o.conEqs.length;s++){var v=o.conEqs[s];v.firstImpact&&impact({bodyA:v.bodyA,bodyB:v.bodyB})}for(s=0;s!==a;s++){(r=e[s]).sleepTick(t)}this.stepping=!1;for(s=0;s!==this.removeBodies.length;s++)this.removeBody(this.removeBodies[s])}runNarrowphase(t,e,a,o,s,i,r,n,c,l,p){vec2.rotate(tmp34,o,e.angle),vec2.rotate(tmp35,n,i.angle),vec2.add(tmp34,tmp34,e.position),vec2.add(tmp35,tmp35,i.position);var h=s+e.angle,m=c+i.angle;if(t.frictionCoefficient=l.friction,2===e.type)var v=i.mass;else if(2===i.type)v=e.mass;else v=e.mass*i.mass/(e.mass+i.mass);switch(t.slipForce=l.friction*p*v,t.restitution=l.restitution,t.frictionStiffness=1e6,t.stiffness=l.stiffness,a.type|r.type){case 12:case 40:var d=t.planeCvx;break;case 5:d=t.circPlane;break;case 8:case 40:case 32:d=t.cvxCvx;break;case 9:case 33:d=t.circCvx;break;case 1:d=t.circCirc}if(d&&(a.type<r.type?d.call(t,e,a,tmp34,h,i,r,tmp35,m):d.call(t,i,r,tmp35,m,e,a,tmp34,h))){if(1===e.type&&2===e.sleepState&&0===i.sleepState&&2!==i.type)vec2.sqLen(i.vel)+Math.pow(i.angVel,2)>=2*Math.pow(i.sleepSpeedLimit,2)&&(e.narrowWakeUp=!0);if(1===i.type&&2===i.sleepState&&0===e.sleepState&&2!==e.type)vec2.sqLen(e.vel)+Math.pow(e.angVel,2)>=2*Math.pow(e.sleepSpeedLimit,2)&&(i.narrowWakeUp=!0);this.overlapKeeper.setOverlapping(e,a,i,r)}}removeBody(t){if(this.stepping)this.removeBodies.push(t),this.removed=!0;else{var e=this.bodies.indexOf(t);if(-1!==e){for(var a=e,o=this.bodies.length-1;a<o;a++)this.bodies[a]=this.bodies[a+1];this.bodies.length=o}}}}for(var i=1;i<=35;i++)window["tmp"+i]=vec2.create();var ctx,w,h,boxBody,planeBody,steps,tmp12=vec2.fromValues(0,1),ContactMaterialIDCounter=0,BodyIDCounter=0,ShapeIDCounter=0,shapeAABB=new AABB,tmp=vec2.create(),MaterialIDCounter=0,balls=[],keys=[];keys[38]=!1,keys[40]=!1;var areas=[{ammos:["BOULDER","BOULDER","BOULDER","BOULDER","BOULDER"],level:"\n                       X\n                      BDDC\n                      W11E\n                X     WMME\n               BWE    W11E\n        X     BDWExxxxW11E\n       BWEC   W11E    W11E\n       WW1ExxxWMME    W11EC\n       WWME111W11E   BW11EE\n       WW1E111W11EDDDDW11EE\n       WW1ExxxW11E1111W11EE\n".split("\n")},{ammos:["IMPACT BOMB","IMPACT BOMB","IMPACT BOMB","IMPACT BOMB","IMPACT BOMB"],level:"\n          X\n          WE          \n          WE          \n         3WE3          \n         W1EE         \n         WMEE         \n         W1EE         \n         WMEE         \n         W1EE      X\n         WMEE   BDDDDDDC\n         W1EE  BDDDDDDDDC\n        BW1EE  W11111111E\n    BDDDDW1EE  W1M1451M1E\n    W1111W1EE  W11167111E\n    W1111W1EEX W11189111E\n".split("\n")},{ammos:["IMPACT BOMB","BOULDER","IMPACT BOMB","TIME BOMB"],level:"\n                                 X\n                              W1 1 1E\n                              W11111E\n                              W1M1M1E\n      BC      A      A        W11111E\n     BDDC    BDC    BDC    BC W11111E\n     W11E    W1E   BDDDC   WE W11111E\n     WMME X  WME   W111E  BWECW11111E\nBDDDDW11E 1 1W1Ec( WM1ME  WWEEW11111E\nW111EW11E1111111111W111EX WWEEW11111E\nW111EW11E1111451111W111E11WWEEW11111E\nW111EW11E1111671111W111E11WWEEW11111E\nW111EW11E1111891111W111E11WWEEW11111E\n".split("\n")},{ammos:["IMPACT BOMB","TIME BOMB","BOULDER","IMPACT BOMB","IMPACT BOMB"],level:"\n              3                  A\n             BDC                BDC\n             W1E                W1E\n             WME                WME\n             W1E                W1E\n             W1E                W1E\n            BDDDC              BDDDC\n            W111E              W111E\n            WM1ME              WM1ME\n            W111E              W111E\n           BDDDDDC            BDDDDDC\n           W11111E            W11111E\n           W11111E   BDDDDC   W11111E  \n           W11111E X W1111EX  W11111E\n   x       W11111ExxxW1451ExxxW11111E\n  xxX     xW11111ExxxW1671ExxxW11111Ex\n xxxW1E xxxW11111ExxxW1891ExxxW11111Exxx\n".split("\n")},{ammos:["TIME BOMB","IMPACT BOMB","IMPACT BOMB","IMPACT BOMB","IMPACT BOMB"],camera:{x:-160,y:190},zoom:20,level:"\n\n               BC\n              BDDC\n             BDDDDC\n             W1111E\n             WM11ME\n             W1111E\n         BC  W1xx1E  BC\n        BDDC W1  1E BDDC\n        W11E W1X 1E W11E\nW 1 1 E WxxE W1111E WxxE W 1 1 E\nW11111E W  E W1111E W  E W11111E\nWMMMMME WX E W1111E WX E WMMMMME\nW11111E W11E W1111E W11E W11111E\nW11111E W11E W1111E W11E W11111E\nW11111ExxxxxxxxxxxxxxxxxxW11111E\nW11111E111111111111111111W11111E\nW11111E11M11M114511M11M11W11111E\nW11111E111111116711111111W11111E \nW11111E111111118911111111W11111E     \n".split("\n")},{ammos:["IMPACT BOMB","IMPACT BOMB","TIME BOMB","TIME BOMB","TIME BOMB"],level:"\n            3\n           BDC\n          BDDDC\n          W111E\n          W1M1E\n BDDDDDDDDW111E\n W11111111W1M1Exxxxxxxxx\n W1M1111M1W111Exxxxx   x\n W11111111xxxxxx     X x\n xxxxxxxxxxxxxxx     WE \n                     WE \n                     WE \n                   xxxxx\n                       x     A\n                       x    BDC\n                xW1Ex  x    W1E\n                xW1Ex  xDDDDWME\n xx   BDDDC     xWMEx  x1111W1E  \n xx   W111Exxx  xW1Ex  x1M11W1E\n xx   W1M1Exxx  xW1Ex  x1111DDDC\n xx   W111ExxxX xW1ExX x1111111E\n".split("\n")},{ammos:["IMPACT BOMB","IMPACT BOMB","IMPACT BOMB","TIME BOMB"],level:"\n                              3\n                             BDC\n                             W1E\n                     A       WME\n                    BDC      W1E  BDC \n                   BDDDC     W1E  W1E \nxxx                W1xxxxxx  xxx  xxx\nxxx                WMxxx\nxxx BDDDC          W1xxx\nxxxxxx11E          WMxxx\nxxxx  1ME        BDW1xxx                 \nxxxxX 11E        W1xxxxx\nxxxxxxxxxx       WME xxx 1 1 E\nxxxx             W1E xxx11111E\nxxxxBDC          W1E xxx1MMMME\nxxxxW1EBC       BDDDCxxx11111E\nxxxxWMEWE       W111Exxx11111E\nxxxxW1EWE       W111Exxx11451E\nxxxxW1EWEDDDC   W111Exxx11671E\nxxxxW1EWEW11E X W111Exxx11891E    X  \n".split("\n")}];function Particle(t,e,a,o,s,i){this.x=t,this.y=e,this.z=a,this.velX=o,this.velY=s,this.velZ=i,this.type="particle",this.frame=0,this.update=function(){this.frame++,this.velY-=.001,this.x+=this.velX,this.y+=this.velY,this.z+=this.velZ,ctx.beginPath();var t=this.x,e=Math.max(-.5,this.y);return ctx.strokeStyle="rgba(255, 139, 50, "+(1-1/60*this.frame)+")",ctx.arc(t*zoom,e*-zoom,.05*zoom,0,2*Math.PI),ctx.stroke(),60!=this.frame}}function addExplosion(t,e,a,o,s){for(var i=0;i<o;i++){var r=Math.random()*s-s/2,n=Math.random()*s-s/2,c=Math.random()*s-s/2;objects.push(new Particle(t,e,a,r,n,c))}}function addObject(t){switch(t.ID=objects.length,t.addImpact=function(t,e){this.life-=t,this.life<0?objects[this.ID].destroy():"box"==this.type&&zzfx(1,.05,148,.01,.01,.16,4,.49,2,0,0,0,0,.4,0,.4,0,.5,0,.06),"circ"!=this.type||"IMPACT BOMB"!=this.weapon||e||this.explode()},t.destroy=function(){if("box"==this.type&&1==this.height&&(addExplosion(this.body.position[0],this.body.position[1],0,10,.02),zzfx(2.44,.05,615,0,.18,.5,2,3.62,.7,0,0,0,0,1.8,-44,.5,.03,.32,.16,.22)),this.died||"box"!=this.type||1.5!=this.height||(addExplosion(this.body.position[0],this.body.position[1],0,10,.12),zzfx(1.36,0,261.6256,.02,.17,.58,0,.6,0,.2,250,.09,.05,0,0,0,.06,.5,.4,0),nbChests--,nbChests||end()),this.died=!0,world.removeBody(this.body),"box"==this.type&&1==this.height&&Math.random()>.5){var t=this.body.position[0],e=this.body.position[1],a=this.subType,o=this.part;addObject({type:"box",position:[t,e],width:.5,height:.5,subType:a,part:o}),addObject({type:"box",position:[t+.5,e],width:.5,height:.5,subType:a,part:o}),addObject({type:"box",position:[t,e-.5],width:1,height:.5,subType:a,part:o})}},t.explode=function(){var t=this.body.position[0],e=this.body.position[1];addExplosion(t,e,0,100,.2),explode.frame||(explode.position.x=camera.x,explode.position.y=camera.y),explode.frame=1;for(var a=0;a<world.bodies.length;a++){var o=world.bodies[a];if(o.mass){var s=o.position[0],i=o.position[1],r=Math.atan2(s-t,i-e);f=50-Math.min(10*Math.hypot(t-s,e-i),50),o.force=[Math.sin(r)*f,Math.cos(r)*f],o.Y&&o._ID!=this.ID&&objects[o._ID].addImpact(f,!0)}}world.removeBody(this.body),objects[this.ID].destroy(),balls.splice(balls.indexOf(this),1);for(var n=0;n!==world.bodies.length;n++)world.bodies[n].idleTime=0},objects.push(t),t.life=t.life||50,t.type){case"triangle3":case"triangleA":case"triangleB":case"triangleC":case"triangleD":t.width=1,t.height=1,t.mass=.1,t.shape=new Box({type:t.type,width:t.width,height:t.height}),t.shape.material=materialCrate;break;case"box":t.width=t.width||1,t.height=t.height||1,t.mass=0===t.mass?0:.1,t.shape=new Box({type:"box",width:t.width,height:t.height}),t.shape.material=materialCrate;break;case"circ":t.life=1e3,t.shape=new Circ({radius:t.radius}),t.shape.material=materialBall}return t.body=new Body(t),t}function drawAll(){for(var t=0;t<objects.length;t++)if(!objects[t].died)switch(objects[t].type){case"box":case"triangle3":case"triangleA":case"triangleB":case"triangleC":case"triangleD":drawBox(objects[t]);break;case"circ":drawCirc(objects[t]);break;case"particle":objects[t].update()||(objects[t].died=!0)}}function drawBox(t){if(t.shape.vertices){var e=t.body.position[0],a=t.body.position[1];ctx.save(),ctx.translate(e*zoom,a*-zoom),ctx.rotate(-t.body.angle),vertices=t.shape.vertices,ctx.beginPath();var o=vertices[0];ctx.moveTo(o[0]*zoom,-o[1]*zoom);for(var s=1;s<vertices.length;s++)ctx.lineTo(vertices[s][0]*zoom,-vertices[s][1]*zoom);"X"==t.subType?(ctx.translate(zoom/1,zoom/1.35),ctx.scale(zoom/40,zoom/40)):(ctx.translate(-.51*zoom,-.51*zoom),ctx.scale(zoom/40,zoom/(40*t.height))),"triangle"==t.type.substring(0,8)?ctx.fillStyle=textures.T:"windows"==t.subType?ctx.fillStyle=textures.w[t.part]:(ctx.fillStyle=textures.b[50-Math.floor(t.life)],t.subType&&(ctx.fillStyle=textures[t.subType])),ctx.fill(),ctx.restore()}}function drawCirc(t){ctx.fillStyle=textures.R;var e=2*t.shape.radius;fillForm(t.body.position[0],t.body.position[1],e,e,e)}function random(t){this.s=t%2147483647,this.n=function(){return this.s=16807*this.s%2147483647,(this.s-1)/2147483646}}materialBall={id:MaterialIDCounter++},materialCrate={id:MaterialIDCounter++};var world,mountain=document.createElement("canvas");function generateMountain(e){for(v=480,t=[mr.n()*v|0,mr.n()*v|0];t.length<1008;)v*=.52,t=function(t,e){for(n=[t[0]],s=1;s<t.length;s++)n.push((t[s-1]+t[s])/2+(mr.n()-.5)*e|0),n.push(t[s]);return n}(t,v);var a=mountain.getContext("2d"),o=a.createLinearGradient(0,480,0,0);o.addColorStop(0,"#000"),o.addColorStop(.95,"rgb(100,"+Math.floor(100+155*mr.n())+",100)"),a.strokeStyle=o;for(var s=0;s<1008;s++)a.beginPath(),a.moveTo(s+.5,480-t[s]),a.lineTo(s+.5,480),a.stroke()}mountain.width=1008,mountain.height=480;var clouds=[],cloud=new Image;cloud.src="c.png",cloud.onload=function(){for(var t=0;t<10;t++)clouds.push({x:1224*Math.random(),y:250*Math.random(),size:.5+Math.random()/2,speed:Math.random()/4})};var goHome,images=[];function impact(t){var e=t.bodyA.shape,a=t.bodyB.shape,o=[a.body.vel[0]-e.body.vel[0],a.body.vel[1]-e.body.vel[1]],s=Math.sqrt(o[0]*o[0]+o[1]*o[1]);s<1||(e.body.Y&&objects[e.body._ID].addImpact(s),a.body.Y&&objects[a.body._ID].addImpact(s))}function initLevel(t){nbChests=3,level=areas[t].level,ammos=areas[t].ammos.slice(),world=new World,objects=[];for(var e=0;e<level[level.length-2].length;e++)for(var a=0;a<level.length;a++){switch(t=level[a][e]){case"X":addObject({type:"box",subType:t,position:[e+.5,level.length-a-1.75],width:2,height:1.5,life:10});break;case"1":case"M":case"E":case"W":case"x":addObject({type:"box",subType:t,position:[e,level.length-a-2],mass:"x"==t?0:.1,life:"x"==t?5e4:50});break;case"c":addObject({type:"box",subType:t,position:[e,level.length-a-2-.25],width:1,height:.5,angle:(level.length-a-1)%2==0?0:Math.PI});break;case"(":addObject({type:"box",subType:t,position:[e+.5,level.length-a-2-.25],width:1,height:.5,angle:(level.length-a-1)%2==0?0:Math.PI});break;case"3":case"A":case"B":case"C":case"D":addObject({type:"triangle"+t,position:[e,level.length-a-2]});break;case" ":case void 0:break;default:addObject({type:"box",subType:"windows",position:[e,level.length-a-2],width:1,height:1,angle:5==t?-Math.PI/2:0,part:t-4})}}planeShape=new Plane,planeBody=new Body({position:[0,-.5],angle:0,shape:planeShape}),planeShape.material={id:MaterialIDCounter++},world.conMats.push(new ContactMaterial(planeShape.material,materialBall,{restitution:.8,stiffness:2e7,friction:100})),world.conMats.push(new ContactMaterial(materialCrate,materialCrate,{restitution:0,stiffness:1e7,friction:1})),world.conMats.push(new ContactMaterial(planeShape.material,materialCrate,{restitution:0,stiffness:1e5,friction:1e4}))}function init(){function t(t,e,a,o=40,s=40){var i=document.createElement("canvas");images[e+a]=i,i.width=o,i.height=s;var r=i.getContext("2d"),n=r.createImageData(o,s),c=n.data,l=[100,80,70],p=[50,40,35];mr=new random(1001);for(var h=0;h<s;h++)for(var m=0;m<o;m++){var v=4*(h*o+m),d=[190+(x=20*Math.random()-10),150+x,100+x];if((h==s/2||h>s/2&&m==o/2||h<s/2&&0==m||0===h)&&(d=l),"E"==e&&m>25&&(percent=1-1/30*(m-25),d=[d[0]*percent,d[1]*percent,d[2]*percent]),"W"==e&&m<15&&(percent=.5+1/30*m,d=[d[0]*percent,d[1]*percent,d[2]*percent]),"M"==e&&m>14&&m<26&&(percent=0,d=[d[0]*percent,d[1]*percent,d[2]*percent]),"tuile"==e){const t=(h%20<10&&(20==m||0==m)||h%20>10&&(10==m||30==m))===(Math.floor(h)%10==0)?10+Math.floor(30*Math.random()):80;d=[t,t,t]}if("windows"==e){var x=Math.floor(70*Math.random())+145,u=Math.floor(30*Math.random())+60,f=Math.floor(30*Math.random())+10;switch(a){case 1:case 2:(E=Math.hypot(80-m,80-h))<90?(d=[.9*x,.9*u,.9*f],((m+3)%10<3||(h+3)%10<3)&&(d=p),E>87.75&&(d=p)):m==o/2&&(d=l);break;case 3:case 4:case 5:case 6:if(d=[x+m,u+m,f+m],4!=a&&6!=a||(m=40-m),3!=a&&5!=a&&4!=a&&6!=a||m<5&&(percent=1/3*m,d=[d[0]*percent,d[1]*percent,d[2]*percent]),m%10<2&&(percent=.8,d=[d[0]*percent,d[1]*percent,d[2]*percent]),a<5&&h<10&&(m+5)%20>h/2&&(m+5)%20<h/2+10-h&&(d=p),(m>37||h>20&&h<30)&&(d=p),5==a||6==a)(E=Math.hypot(30-m,5-h))<5&&E>2.5&&(d=p);4!=a&&6!=a||(m=40-m);break;case 7:d=[.9*x,.9*u,.9*f],(2==m||237==m||2==h||17==h||h>8&&h<12&&m%10<3||m>237||h>17)&&(d=[.6*x,.6*u,.6*f]),(m<2||h<2)&&(d=[1.2*x,1.2*u,1.2*f]);break;case 8:d=[1.2*x,2.4*u,2.5*f];break;case 9:d=[x,u,f];var E,b=!1;(m<8||m>72||h<4||h>18&&h<26||h>52)&&(b=!0),(h<18&&h%8<2||(h+26)%10<2)&&(d=[.8*x,.8*u,.8*f]),(E=Math.hypot(20-m,39-h))<3&&(d=p),((E=Math.hypot(60-m,39-h))<3||h>25&&h<35&&m>36&&m<44)&&(b=!0),b&&(d=p,(m%2==0&&h%2==0||m%2==1&&h%2==1)&&(d=[.5*d[0],.5*d[1],.5*d[2]]));break;case 10:d=[.4*d[0],.5*d[1],.6*d[2]]}}c[v]=d[0],c[v+1]=d[1],c[v+2]=d[2],c[v+3]=255}for(var g=[],B=0;B<20;B++)g.push([Math.floor(40*mr.n()),Math.floor(40*mr.n())]);return g.forEach(function(e,a){mr=new random(a);for(var s=e[0],i=e[1],r=0;r<t;r++)s+=mr.n()<.33?-1:mr.n()<.66?0:1,i+=mr.n()<.33?-1:mr.n()<.66?0:1,d=[152,120,80],c[v=4*(i*o+s)]=d[0],c[v+1]=d[1],c[v+2]=d[2],c[v+3]=255}),r.putImageData(n,0,0),ctx.createPattern(i,"repeat")}w=canvas.width,h=canvas.height,ctx=canvas.getContext("2d"),textures={X:t(0,"windows",9,80,60),T:t(0,"tuile",1),W:t(0,"W",1),E:t(0,"E",1),M:t(0,"M",1),B:t(0,"windows",7,240,20),R:t(0,"windows",8),x:t(0,"windows",10),w:[t(0,"windows",1),t(0,"windows",2),t(0,"windows",3),t(0,"windows",4),t(0,"windows",5),t(0,"windows",6)],b:[]};for(var e=0;e<=50;e++)textures.b[e]=t(e);mr=new random(201),generateMountain(),generateMountain(),generateMountain()}function drawPlane(){ctx.beginPath(),ctx.strokeStyle="black",ctx.moveTo(-w,.5*zoom),ctx.lineTo(w,.5*zoom),ctx.stroke()}function fillForm(t,e,a,o,s){ctx.beginPath(),s?ctx.arc(t*zoom,-e*zoom,s/2*zoom,0,2*Math.PI):ctx.rect(t*zoom,-e*zoom,a*zoom,o*zoom),ctx.translate(t*zoom,e*-zoom),ctx.scale(zoom/40,zoom/40),ctx.fill(),ctx.stroke(),ctx.scale(1/(zoom/40),1/(zoom/40)),ctx.translate(t*-zoom,e*zoom)}var font=[];function drawText(t,e,a,o=10,s){ctx.beginPath(),ctx.fillStyle=s||textures.T,pX=t;for(var i=0;i<a.length;i++){for(var r=0,n=0;n<5;n++)for(var c=0;c<3;c++)" "!=a[i]&&"1"==font[a[i]][r++]&&ctx.rect(pX+c*o,e+n*o,o,o);pX+=3.5*o}ctx.save(),ctx.translate(t,e),ctx.scale(.5,.5),ctx.fill(),ctx.restore()}function render(){for(ctx.fillStyle="#4290D1",ctx.fillRect(0,0,w,h),i=0;i<clouds.length;i++)clouds[i].x<-200&&(clouds[i].x=1200),ctx.drawImage(cloud,clouds[i].x-=clouds[i].speed,clouds[i].y,128*clouds[i].size,71*clouds[i].size);if(ctx.drawImage(mountain,0,0,w,h),"home"==screen){for(drawText(372,75,"CASTLE ATTACK"),x=180,i=0;i<7;i++){ctx.beginPath(),ctx.fillStyle="white",ctx.rect(x,250,80,60),ctx.strokeStyle=i>localStorage.gp44.length?"gray":"black",ctx.fill(),ctx.stroke(),ctx.beginPath(),drawText(x+18,260,"LEVEL "+(i+1),2,i>localStorage.gp44.length?"gray":"black");for(var t=0;t<3;t++)ctx.globalAlpha=localStorage.gp44[i]>t?1:.2,ctx.drawImage(images.windows9,x+12+20*t,290,16,12);ctx.globalAlpha=1,x+=130}ctx.beginPath()}if("level"==screen){if(!goHome){var e=areas[levelNumber].ammos,a=e.length-ammos.length,o=20;for(l=0;l<e.length;l++)drawText(30,o-(l==a?4:0),e[l],l==a?3:2,l<a?"#666":null),o+=20;ctx.beginPath(),ctx.strokeStyle="black",ammos.length?(ctx.moveTo(10,22+20*a),ctx.lineTo(25,22+20*a)):end(),ctx.stroke()}ctx.save(),ctx.translate(w/2+camera.x,h/2+camera.y),drawAll(),drawPlane(),ctx.restore(),ctx.fillStyle=textures.B,ctx.save(),ctx.translate(w/2+camera.x-15*zoom,h/2+camera.y-0*-zoom),ctx.translate(0,.25*-zoom),ctx.rotate(-weaponAngle),fillForm(0,.25,4,.5),ctx.fillRect(3.5*zoom,-0*zoom,.25*zoom,-.5*zoom);var s=keys[32]*(Math.min(frames-power,100)/100);ctx.beginPath(),ctx.moveTo(3.5*zoom,-.5*zoom),ctx.lineTo((3.5-3.5*s)*zoom,-.25*zoom),ctx.stroke(),ctx.rotate(weaponAngle),ctx.translate(0,.25*zoom),fillForm(-.5,.25,6,.5),fillForm(.5,0,1,1,1),fillForm(4.5,0,1,1,1),ctx.restore()}}function gotoScreen(t,e){screen=t,"level"==screen&&(levelNumber=e,initLevel(e))}font[1]="010110010010111",font[2]="111001111100111",font[3]="111001111001111",font[4]="101101111001001",font[5]="111100111001111",font[6]="111100111101111",font[7]="111001010010010",font[8]="111101111101111",font[9]="111101111001111",font.A="111101111101101",font.B="110101111101111",font.C="111100100100111",font.D="110101101101110",font.E="111100111100111",font.I="111010010010111",font.K="101101110101101",font.L="100100100100111",font.M="101111111101101",font.O="111101101101111",font.P="110101110100100",font.R="111101111110101",font.S="111100111001111",font.T="111010010010010",font.U="101101101101111",font.V="101101101101010",screen="",gotoScreen("home");var weaponAngle=.1,frames=0,explode={frame:0,position:{}},camera={x:-160,y:190},zoom=20;function animate(){explode.frame&&(explode.frame++,explodeForce=1*(30-explode.frame),camera.x=explode.position.x+Math.random()*explodeForce-explodeForce/2,camera.y=explode.position.y+Math.random()*explodeForce-explodeForce/2,30==explode.frame&&(explode.frame=0,camera.x=explode.position.x,camera.y=explode.position.y));for(var t=0;t<balls.length;t++){var e=balls[t];"TIME BOMB"==e.weapon&&frames-e.age>300&&e.explode()}frames++,keys[38]&&(weaponAngle=Math.min(1.17,weaponAngle+.015)),keys[40]&&(weaponAngle=Math.max(.1,weaponAngle-.015)),keys[27]&&gotoScreen("home"),requestAnimationFrame(animate),"level"==screen&&world&&world.step(1/60),render()}onclick=function(t){if("home"==screen){var e=canvas.getBoundingClientRect(),a=t.clientX*canvas.width/e.width,o=t.clientY*canvas.height/e.height;if(xTest=180,o>250&&o<310)for(i=0;i<7;i++)a>=xTest&&a<=xTest+80&&i<=localStorage.gp44.length&&gotoScreen("level",i),xTest+=130}},onkeyup=function(t){if(keys[t.keyCode]=!1,32==t.keyCode&&ammos.length){var e=4*Math.sqrt(Math.min(frames-power,100)/100*20);power=0;var a=addObject({type:"circ",weapon:ammos.shift(),radius:.2,mass:1,position:[3.5*Math.cos(weaponAngle)-15,.25+3.5*Math.sin(weaponAngle)]});world.gravity=vec2.fromValues(0,-5),a.age=frames,a.body.vel=[Math.cos(weaponAngle)*e,Math.sin(weaponAngle)*e],balls.push(a)}};var power=0;function end(){goHome||(goHome=!0,setTimeout(function(){localStorage.gp44=localStorage.gp44.slice(0,levelNumber)+Math.max(0|localStorage.gp44[levelNumber],3-nbChests)+localStorage.gp44.slice(levelNumber+1),gotoScreen("home"),goHome=!1},1e4))}onkeydown=function(t){keys[t.keyCode]=!0,power||32!=t.keyCode||(power=frames)},localStorage.gp44=localStorage.gp44||"",init(),animate();</script></body></html>