<!doctype html><title>Castle Attack - js13kGames 2023</title><style>body{margin:0;overflow:hidden;background-color:#000}canvas{width:100%}</style><canvas width=1200 height=600 id=canvas></canvas><script>var zzfx,zzfxV,zzfxX,nbS=[];nbS[.06]=0,nbS[.22]=0,zzfxV=.3,zzfx=(n=1,z=.05,e=220,f=0,t=0,a=.1,r=0,x=1,o=0,s=0,b=0,i=0,u=0,S=0,c=0,d=0,X=0,m=1,V=0,h=0,B=Math,C=44100,g=2*B.PI,l=(o*=500*g/C/C),v=(e*=(1-z+2*z*B.random(z=[]))*g/C),w=0,A=0,D=0,I=1,M=0,P=0,j=0,k,p)=>{if(10!=nbS[h]){for(nbS[h]++,s*=500*g/C**3,c*=g/C,b*=g/C,i*=C,u=C*u|0,p=(f=C*f+9)+(V*=C)+(t*=C)+(a*=C)+(X*=C)|0;D<p;z[D++]=j)++P%(100*d|0)||(j=r?1<r?2<r?3<r?B.sin((w%g)**3):B.max(B.min(B.tan(w),1),-1):1-(2*w/g%2+2)%2:1-4*B.abs(B.round(w/g)-w/g):B.sin(w),j=(u?1-h+h*B.sin(g*D/u):1)*(0<j?1:-1)*B.abs(j)**x*zzfxV*n*(D<f?D/f:D<f+V?1-(D-f)/V*(1-m):D<f+V+t?m:D<p-X?(p-D-X)/a*m:0),j=X?j/2+(X>D?0:(D<p-X?1:(p-D)/X)*z[D-X|0]/2):j),w+=(k=(e+=o+=s)*B.cos(c*A++))-k*S*(1-1e9*(B.sin(D)+1)%2),I&&++I>i&&(e+=b,v+=b,I=0),!u||++M%u||(e=v,o=l,I||=1);return(n=zzfxX.createBuffer(1,p,C)).getChannelData(0).set(z),(e=zzfxX.createBufferSource()).buffer=n,e.connect(zzfxX.destination),e.onended=()=>{nbS[h]--},e.start(),e}},zzfxX=new AudioContext</script><script>class C{static create(){return new Float32Array([0,0])}static xLen(t,e){return t[0]*e[1]-t[1]*e[0]}static rotate(t,e,s){var a=Math.cos(s),[e,i]=(s=Math.sin(s),e);t[0]=a*e-s*i,t[1]=s*e+a*i}static rotate90cw(t,e){t[0]=e[1],t[1]=-e[0]}static centroid(t,e,s,a){C.add(t,e,s),C.add(t,t,a),C.scale(t,t,1/3)}static fromValues(t,e){return new Float32Array([t,e])}static copy(t,e){t.set(e)}static set(t,e,s){t.set([e,s])}static add(t,e,s){t[0]=e[0]+s[0],t[1]=e[1]+s[1]}static sub(t,e,s){t[0]=e[0]-s[0],t[1]=e[1]-s[1]}static mult(t,e,s){t[0]=e[0]*s[0],t[1]=e[1]*s[1]}static scale(t,e,s){return t[0]=e[0]*s,t[1]=e[1]*s,t}static length(t){var[t,e]=t;return Math.sqrt(t*t+e*e)}static sqLen(t){var[t,e]=t;return t*t+e*e}static norm(t,e){var[s,a]=e;0<(s=s*s+a*a)&&(s=1/Math.sqrt(s),t[0]=e[0]*s,t[1]=e[1]*s)}static dot(t,e){return t[0]*e[0]+t[1]*e[1]}}class G{constructor(){this.lowerBound=C.create(),this.upperBound=C.create()}setFromPoints(t,e,s){var a=this.lowerBound,i=this.upperBound;C.rotate(a,t[0],s),C.copy(i,a);for(var o=Math.cos(s),n=Math.sin(s),r=1;r<t.length;r++)for(var[h,l]=t[r],p=[o*h-n*l,n*h+o*l],c=0;c<2;c++)p[c]>i[c]&&(i[c]=p[c]),p[c]<a[c]&&(a[c]=p[c]);e&&(C.add(this.lowerBound,this.lowerBound,e),C.add(this.upperBound,this.upperBound,e))}copy(t){C.copy(this.lowerBound,t.lowerBound),C.copy(this.upperBound,t.upperBound)}overlaps(t){var e=this.lowerBound,s=this.upperBound,a=t.lowerBound;return t=t.upperBound,(a[0]<=s[0]&&s[0]<=t[0]||e[0]<=t[0]&&t[0]<=s[0])&&(a[1]<=s[1]&&s[1]<=t[1]||e[1]<=t[1]&&t[1]<=s[1])}}class e{constructor(t={}){this.body=null,this.position=C.fromValues(0,0),this.angle=0,this.type=t.type,this.id=st++,this.material=null}}class u extends e{constructor(t){var e=t.width,s=t.height;switch(t.type){case"box":case"triangleD":var a=[[-.5,-.5],[.5,-.5],[.5,.5],[-.5,.5]];break;case"triangle3":a=[[-.5,-.5],[0,-.5],[.5,-.5],[0,.5]];break;case"triangleA":a=[[-.5,-.5],[0,-.5],[.5,-.5],[0,0]];break;case"triangleB":a=[[-.5,-.5],[0,-.5],[.5,-.5],[.5,.5]];break;case"triangleC":a=[[-.5,-.5],[0,-.5],[.5,-.5],[-.5,.5]]}t.type=8,super(t),this.vertices=a.map(t=>C.fromValues(e*t[0],s*t[1])),this.width=e,this.height=s}cMI(t){return t*(this.height**2+this.width**2)/12}computeAABB(t,e,s){t.setFromPoints(this.vertices,e,s)}}class R extends e{constructor(){super({type:4})}computeAABB(t,e,s){s%=2*Math.PI,C.set(t.lowerBound,-1e7,-1e7),C.set(t.upperBound,1e7,1e7),0==s?t.upperBound[1]=0:s===Math.PI?t.lowerBound[1]=0:s==Math.PI/2?t.lowerBound[0]=0:s==3*Math.PI/2&&(t.upperBound[0]=0)}}class z extends e{constructor(t={}){t.type=1,super(t),this.radius=t.radius}cMI(t){return t*this.radius**2/2}computeAABB(t,e,s){C.set(t.upperBound,this.radius,this.radius),C.set(t.lowerBound,-this.radius,-this.radius),e&&(C.add(t.lowerBound,t.lowerBound,e),C.add(t.upperBound,t.upperBound,e))}}class o{constructor(t,e,s={}){this.id=tt++,this.materialA=t,this.materialB=e,this.friction=s.friction||.3,this.restitution=s.restitution||0,this.stiffness=s.stiffness||1e6}}class s{constructor(){this.data={},this.keys=[]}getKey(t,e){return 0|(e<t?t<<16|65535&e:e<<16|65535&t)}get(t,e){return this.data[this.getKey(t,e)]}set(t,e,s){return t=this.getKey(t,e),this.data[t]||this.keys.push(t),this.data[t]=s,t}reset(){for(var t=this.keys,e=t.length;e--;)delete this.data[t[e]];t.length=0}copy(t){this.reset(),this.keys.push(...t.keys);for(var e=t.keys.length;e--;){var s=t.keys[e];this.data[s]=t.data[s]}}}class N{constructor(t,e,s,a){this.set(...arguments)}set(t,e,s,a){this.shapeA=e,this.shapeB=a,this.bodyA=t,this.bodyB=s}}class _{constructor(t,e){this.minForce=0,this.maxForce=Number.MAX_VALUE,this.bodyA=t,this.bodyB=e,this.stiffness=1e6,this.G=new Float32Array(6).fill(0),this.a=0,this.b=0,this.epsilon=0,this.timeStep=1/60,this.multiplier=0}update(){var t=this.timeStep;this.a=4/(17*t),this.b=16/17,this.epsilon=4/(t**2*this.stiffness*17)}gmult(t,e,s,a,i){return t[0]*e[0]+t[1]*e[1]+t[2]*s+t[3]*a[0]+t[4]*a[1]+t[5]*i}computeGW(){var t=this.bodyA,e=this.bodyB;return this.gmult(this.G,t.vel,t.angVel,e.vel,e.angVel)}computeGiMf(){var t=this.bodyA,e=this.bodyB,s=C.scale(C.create(),t.force,t.invMassSolve),a=C.scale(C.create(),e.force,e.invMassSolve);return C.mult(s,t.massMultiplier,s),C.mult(a,e.massMultiplier,a),this.gmult(this.G,s,0,a,0)}addToWlambda(t){var e=this.bodyA,s=this.bodyB,a=this.G,i=C.fromValues(a[0],a[1]),o=C.fromValues(a[3],a[4]),n=C.create();C.scale(n,i,e.invMassSolve*t),C.mult(n,n,e.massMultiplier),C.add(e.vlambda,e.vlambda,n),e.wlambda+=e.invInertiaSolve*a[2]*t,C.scale(n,o,s.invMassSolve*t),C.mult(n,n,s.massMultiplier),C.add(s.vlambda,s.vlambda,n),s.wlambda+=s.invInertiaSolve*a[5]*t}computeInvC(t){var e=this.bodyA,s=this.bodyB,a=e.invMassSolve,i=s.invMassSolve,o=this.G;return 1/(o[0]*o[0]*a*e.massMultiplier[0]+o[1]*o[1]*a*e.massMultiplier[1]+o[2]*o[2]*e.invInertiaSolve+o[3]*o[3]*i*s.massMultiplier[0]+o[4]*o[4]*i*s.massMultiplier[1]+o[5]*o[5]*s.invInertiaSolve+t)}}class K extends _{constructor(t,e){super(t,e),this.conPtA=C.create(),this.penetrationVec=C.create(),this.conPtB=C.create(),this.normalA=C.create(),this.restitution=0,this.firstImpact=!1}computeB(t,e,s){var a=this.bodyA,i=this.bodyB,o=this.penetrationVec,n=this.normalA,r=C.xLen(this.conPtA,n),h=C.xLen(this.conPtB,n);return this.G.set([-n[0],-n[1],-r,n[0],n[1],h]),C.add(o,i.position,this.conPtB),C.sub(o,o,a.position),C.sub(o,o,this.conPtA),r=this.computeGW(),h=0,this.firstImpact&&0!==this.restitution?r*=1/e*(1+this.restitution):h=C.dot(n,o),-h*t-r*e-s*this.computeGiMf()}}class Y extends _{constructor(){super(),this.conPtA=C.create(),this.conPtB=C.create(),this.t=C.create(),this.conEqs=[],this.frictionCoefficient=.3}computeB(t,e,s){var a=this.t;return this.G.set([-a[0],-a[1],-C.xLen(this.conPtA,a),a[0],a[1],C.xLen(this.conPtB,a)]),-this.computeGW()*e-s*this.computeGiMf()}}class a{constructor(t,e){this.objects=Array.from({length:e},()=>new t)}get(t){return this.objects.length?this.objects.pop():new t}release(t){t.bodyA=t.bodyB=null,this.objects.push(t)}}class Z{constructor(){this.overlappingShapesLastState=new s,this.overlappingShapesCurrentState=new s,this.recordPool=new a(N,16)}tick(){for(var t=this.overlappingShapesLastState,e=this.overlappingShapesCurrentState,s=t.keys.length;s--;){var a=t.data[t.keys[s]];a&&this.recordPool.release(a)}t.reset(),t.copy(e),e.reset()}setOverlapping(t,e,s,a){var i,o=this.overlappingShapesCurrentState;o.get(e.id,a.id)||((i=this.recordPool.get(N)).set(t,e,s,a),o.set(e.id,a.id,i))}}class S{constructor(){this.conEqs=[],this.conEqPool=new a(K,32),this.fricEqs=[],this.frictionCoefficient=.3,this.frictionEquationPool=new a(Y,64),this.restitution=0,this.stiffness=1e6,this.collidePrev=new s}reset(){this.collidePrev.reset();for(var t=this.conEqs,e=t.length;e--;){var s=t[e];this.collidePrev.set(s.bodyA.id,s.bodyB.id,!0)}for(var a=0;a<this.conEqs.length;a++)this.conEqPool.release(this.conEqs[a]);for(a=0;a<this.fricEqs.length;a++)this.frictionEquationPool.release(this.fricEqs[a]);this.conEqs.length=this.fricEqs.length=0}createContactEquation(t,e,s,a){var i=this.conEqPool.get(K);return i.bodyA=t,i.bodyB=e,i.restitution=this.restitution,i.firstImpact=!this.collidePrev.get(t.id,e.id),i.stiffness=this.stiffness,i}createFrictionEquation(t,e,s,a){var i=this.frictionEquationPool.get(Y);return i.bodyA=t,i.bodyB=e,i.maxForce=this.slipForce,i.minForce=-this.slipForce,i.frictionCoefficient=this.frictionCoefficient,i.conEqs.length=0,i.stiffness=1e6,i}createFrictionFromContact(t){var e=this.createFrictionEquation(t.bodyA,t.bodyB,t.shapeA,t.shapeB);return e.conPtA.set(t.conPtA),e.conPtB.set(t.conPtB),C.rotate90cw(e.t,t.normalA),e.conEqs.push(t),e}createFrictionFromAverage(t){var e=this.conEqs[this.conEqs.length-1],s=this.createFrictionEquation(e.bodyA,e.bodyB,e.shapeA,e.shapeB),a=e.bodyA;C.set(s.conPtA,0,0),C.set(s.conPtB,0,0),C.set(s.t,0,0);for(var i=0;i!==t;i++)(e=this.conEqs[this.conEqs.length-1-i]).bodyA===a?(C.add(s.t,s.t,e.normalA),C.add(s.conPtA,s.conPtA,e.conPtA),C.add(s.conPtB,s.conPtB,e.conPtB)):(C.sub(s.t,s.t,e.normalA),C.add(s.conPtA,s.conPtA,e.conPtB),C.add(s.conPtB,s.conPtB,e.conPtA)),s.conEqs.push(e);var o=1/t;return C.scale(s.conPtA,s.conPtA,o),C.scale(s.conPtB,s.conPtB,o),C.norm(s.t,s.t),C.rotate90cw(s.t,s.t),s}circCvx(t,e,s,a,i,o,n,r){for(var h,l=e.radius,p=!1,c=Number.MAX_VALUE,m=o.vertices,d=0;d!==m.length+1;d++){var x=m[d%m.length],u=m[(d+1)%m.length];C.rotate(tmp1,x,r),C.rotate(tmp2,u,r),C.add(tmp1,tmp1,n),C.add(tmp2,tmp2,n),C.sub(tmp3,tmp2,tmp1),C.norm(tmp4,tmp3),C.rotate90cw(tmp5,tmp4),C.scale(tmp14,tmp5,-e.radius),C.add(tmp14,tmp14,s),S.pointInCvx(tmp14,o,n,r)&&(C.sub(tmp15,tmp1,tmp14),(x=Math.abs(C.dot(tmp15,tmp5)))<c)&&(C.copy(tmp16,tmp14),c=x,C.scale(tmp13,tmp5,x),C.add(tmp13,tmp13,tmp14),p=!0)}if(p)return h=this.createContactEquation(t,i,e,o),C.sub(h.normalA,tmp16,s),C.norm(h.normalA,h.normalA),C.scale(h.conPtA,h.normalA,l),C.add(h.conPtA,h.conPtA,s),C.sub(h.conPtA,h.conPtA,t.position),C.sub(h.conPtB,tmp13,n),C.add(h.conPtB,h.conPtB,n),C.sub(h.conPtB,h.conPtB,i.position),this.conEqs.push(h),this.fricEqs.push(this.createFrictionFromContact(h)),1;for(d=0;d<m.length;d++){var v=m[d];if(C.rotate(tmp11,v,r),C.add(tmp11,tmp11,n),C.sub(tmp10,tmp11,s),C.sqLen(tmp10)<Math.pow(l,2))return h=this.createContactEquation(t,i,e,o),C.copy(h.normalA,tmp10),C.norm(h.normalA,h.normalA),C.scale(h.conPtA,h.normalA,l),C.add(h.conPtA,h.conPtA,s),C.sub(h.conPtA,h.conPtA,t.position),C.sub(h.conPtB,tmp11,n),C.add(h.conPtB,h.conPtB,n),C.sub(h.conPtB,h.conPtB,i.position),this.conEqs.push(h),this.fricEqs.push(this.createFrictionFromContact(h)),1}return 0}static pointInCvx(t,e,s,a){for(var i=t,o=e.vertices,n=null,r=0;r!==o.length+1;r++){var h=o[r%o.length],l=o[(r+1)%o.length];if(C.rotate(tmp17,h,a),C.rotate(tmp18,l,a),C.add(tmp17,tmp17,s),C.add(tmp18,tmp18,s),C.sub(tmp19,tmp17,i),C.sub(tmp20,tmp18,i),(h=C.xLen(tmp19,tmp20))*(n=null===n?h:n)<=0)return!1;n=h}return!0}planeCvx(t,e,s,a,i,o,n,r){var h=0;C.rotate(tmp2,$,a);for(var l=0;l!==o.vertices.length;l++){var p=o.vertices[l];C.rotate(tmp1,p,r),C.add(tmp1,tmp1,n),C.sub(tmp3,tmp1,s),C.dot(tmp3,tmp2)<=0&&(h++,p=this.createContactEquation(t,i,e,o),C.sub(tmp3,tmp1,s),C.copy(p.normalA,tmp2),C.scale(tmp3,p.normalA,C.dot(tmp3,p.normalA)),C.sub(p.conPtB,tmp1,i.position),C.sub(p.conPtA,tmp1,tmp3),C.sub(p.conPtA,p.conPtA,t.position),this.conEqs.push(p))}return h&&this.fricEqs.push(this.createFrictionFromAverage(h)),h}circPlane(t,e,s,a,i,o,n,r){return C.sub(tmp1,s,n),C.rotate(tmp2,$,r),(r=C.dot(tmp2,tmp1))>e.radius?0:(o=this.createContactEquation(i,t,o,e),C.copy(o.normalA,tmp2),C.scale(o.conPtB,o.normalA,-e.radius),C.add(o.conPtB,o.conPtB,s),C.sub(o.conPtB,o.conPtB,t.position),C.scale(tmp3,o.normalA,r),C.sub(o.conPtA,tmp1,tmp3),C.add(o.conPtA,o.conPtA,n),C.sub(o.conPtA,o.conPtA,i.position),this.conEqs.push(o),this.fricEqs.push(this.createFrictionFromContact(o)),1)}circCirc(t,e,s,a,i,o,n,r){C.sub(tmp1,s,n);var h=e.radius+o.radius;return C.sqLen(tmp1)>Math.pow(h,2)?0:(h=this.createContactEquation(t,i,e,o),C.sub(h.normalA,n,s),C.norm(h.normalA,h.normalA),C.scale(h.conPtA,h.normalA,e.radius),C.scale(h.conPtB,h.normalA,-o.radius),C.add(h.conPtA,h.conPtA,s),C.sub(h.conPtA,h.conPtA,t.position),C.add(h.conPtB,h.conPtB,n),C.sub(h.conPtB,h.conPtB,i.position),this.conEqs.push(h),this.fricEqs.push(this.createFrictionFromContact(h)),1)}cvxCvx(t,e,s,a,i,o,n,r){var h=0;if(!S.findSeparatingAxis(e,s,a,o,n,r,tmp1))return 0;C.sub(tmp8,n,s),0<C.dot(tmp1,tmp8)&&C.scale(tmp1,tmp1,-1);var l=S.getClosestEdge(e,a,tmp1,!0),p=S.getClosestEdge(o,r,tmp1);if(-1===l||-1===p)return 0;for(var c=0;c<2;c++){var m=l,d=p,x=e,u=o,v=s,E=n,b=a,f=r,g=t,B=i;0===c&&([m,d]=[d,m],[x,u]=[u,x],[v,E]=[E,v],[b,f]=[f,b],[g,B]=[B,g]);for(var M=d;M<d+2;M++){var W=u.vertices[(M+u.vertices.length)%u.vertices.length];C.rotate(tmp2,W,f),C.add(tmp2,tmp2,E);for(var y=0,A=m-1;A<m+2;A++){var w=x.vertices[(A+x.vertices.length)%x.vertices.length],P=x.vertices[(A+1+x.vertices.length)%x.vertices.length],D=(C.rotate(tmp3,w,b),C.rotate(tmp4,P,b),C.add(tmp3,tmp3,v),C.add(tmp4,tmp4,v),C.sub(tmp5,tmp4,tmp3),C.rotate90cw(tmp9,tmp5),C.norm(tmp9,tmp9),C.sub(tmp8,tmp2,tmp3),C.dot(tmp9,tmp8));(A===m&&D<=0||A!==m&&D<=0)&&y++}3<=y&&(W=this.createContactEquation(g,B,x,u),h++,w=x.vertices[m%x.vertices.length],P=x.vertices[(m+1)%x.vertices.length],C.rotate(tmp3,w,b),C.rotate(tmp4,P,b),C.add(tmp3,tmp3,v),C.add(tmp4,tmp4,v),C.sub(tmp5,tmp4,tmp3),C.rotate90cw(W.normalA,tmp5),C.norm(W.normalA,W.normalA),C.sub(tmp8,tmp2,tmp3),D=C.dot(W.normalA,tmp8),C.scale(tmp7,W.normalA,D),C.sub(W.conPtA,tmp2,v),C.sub(W.conPtA,W.conPtA,tmp7),C.add(W.conPtA,W.conPtA,v),C.sub(W.conPtA,W.conPtA,g.position),C.sub(W.conPtB,tmp2,E),C.add(W.conPtB,W.conPtB,E),C.sub(W.conPtB,W.conPtB,B.position),this.conEqs.push(W))}}return h&&this.fricEqs.push(this.createFrictionFromAverage(h)),h}static projectCvxOntoAxis(t,e,s,a,i){var o=-1/0,n=1/0;C.rotate(tmp21,a,-s);for(var r=0;r<t.vertices.length;r++)var h=t.vertices[r],h=C.dot(h,tmp21),o=Math.max(o,h),n=Math.min(n,h);o<n&&([n,o]=[o,n]),s=C.dot(e,a),C.set(i,n+s,o+s)}static findSeparatingAxis(t,e,s,a,i,o,n){var r=null,h=!1;if(t instanceof u&&a instanceof u)for(var l=0;2!==l;l++){var p=t,c=s;1===l&&(p=a,c=o);for(var m=0;2!==m;m++){0===m?C.set(tmp25,0,1):1===m&&C.set(tmp25,1,0),0!==c&&C.rotate(tmp25,tmp25,c),S.projectCvxOntoAxis(t,e,s,tmp25,tmp26),S.projectCvxOntoAxis(a,i,o,tmp25,tmp27);var d=tmp27[0]-tmp26[1];tmp27[0]<tmp26[0]&&(d=tmp26[0]-tmp27[1]),(null===r||r<d)&&(C.copy(n,tmp25),h=(r=d)<=0)}}else for(l=0;2!==l;l++)for(p=t,c=s,1===l&&(p=a,c=o),m=0;m!==p.vertices.length;m++)C.rotate(tmp23,p.vertices[m],c),C.rotate(tmp24,p.vertices[(m+1)%p.vertices.length],c),sub(tmp22,tmp24,tmp23),C.rotate90cw(tmp25,tmp22),C.norm(tmp25,tmp25),S.projectCvxOntoAxis(t,e,s,tmp25,tmp26),S.projectCvxOntoAxis(a,i,o,tmp25,tmp27),d=tmp27[0]-tmp26[1],tmp27[0]<tmp26[0]&&(d=tmp26[0]-tmp27[1]),(null===r||r<d)&&(C.copy(n,tmp25),h=(r=d)<=0);return h}static getClosestEdge(t,e,s,a){C.rotate(tmp28,s,-e),a&&C.scale(tmp28,tmp28,-1);for(var i=-1,o=t.vertices.length,n=-1,r=0;r!==o;r++){C.sub(tmp29,t.vertices[(r+1)%o],t.vertices[r%o]),C.rotate90cw(tmp30,tmp29),C.norm(tmp30,tmp30);var h=C.dot(tmp30,tmp28);(-1===i||n<h)&&(i=r%o,n=h)}return i}}class H{constructor(){this.type=1,this.lambda=new Float32Array(30),this.Bs=new Float32Array(30),this.invCs=new Float32Array(30)}solve(t,e){for(var s=e.length,a=w.bodies,i=w.bodies.length,o=0;o!==i;o++){var n=a[o];2===a[o].sleepState?(n.invMassSolve=0,n.invInertiaSolve=0):(n.invMassSolve=n.invMass,n.invInertiaSolve=n.invInertia)}for(this.lambda.length<s&&(this.lambda=new Float32Array(s+30),this.Bs=new Float32Array(s+30),this.invCs=new Float32Array(s+30)),this.lambda.fill(0),o=0;o!==e.length;o++)(p=e[o]).timeStep=t,p.update(),this.Bs[o]=p.computeB(p.a,p.b,t),this.invCs[o]=p.computeInvC(p.epsilon);if(0!==s){for(o=0;o!==i;o++)a[o].vlambda=[0,0],a[o].wlambda=0;for(var r=0;10!==r;r++){for(var h=0,l=0;l!==s;l++){var p=e[l],c=this.lambda[l],m=p.gmult(p.G,p.bodyA.vlambda,p.bodyA.wlambda,p.bodyB.vlambda,p.bodyB.wlambda),d=p.maxForce,x=p.minForce;c+(m=this.invCs[l]*(this.Bs[l]-m-p.epsilon*c))<x*t?m=x*t-c:d*t<c+m&&(m=d*t-c),this.lambda[l]+=m,p.addToWlambda(m),h+=Math.abs(m)}if(h*h<=0)break}for(o=0;o!==i;o++)C.add(a[o].vel,a[o].vel,a[o].vlambda),a[o].angVel+=a[o].wlambda;for(var u=e.length;u--;)e[u].multiplier=+this.lambda[u]/t}}}class J{constructor(t){this.id=++et,this._ID=void 0!==t.ID?t.ID:null,null!==this._ID&&(this.Y=!0),this.mass=t.mass||0,this.invMassSolve=0,this.invInertiaSolve=0,this.massMultiplier=C.create(),this.position=C.fromValues(t.position[0],t.position[1]),this.vel=C.fromValues(0,0),this.vlambda=C.fromValues(0,0),this.wlambda=0,this.angle=t.angle||0,this.angVel=0,this.force=C.create(),this.type=t.mass?1:2,this.aabb=new G,this.wantSleep=!1,this.sleepState=0,this.sleepSpeedLimit=.15,this.sleepTimeLimit=2,this.idleTime=0,this.narrowWakeUp=!1,(t.shape.body=this).shape=t.shape,2===this.type?(this.mass=Number.MAX_VALUE,this.invMass=0,this.inertia=Number.MAX_VALUE,this.invInertia=0):(this.inertia=this.shape.cMI(this.mass)+this.mass*C.sqLen(this.shape.position),this.invInertia=0<this.inertia?1/this.inertia:0,this.invMass=1/this.mass,this.massMultiplier.set([1,1])),w.bodies.push(this)}sleepTick(t){2!==this.type&&(C.sqLen(this.vel)+Math.pow(this.angVel,2)>=Math.pow(this.sleepSpeedLimit,2)?(this.idleTime=0,this.sleepState=0):(this.idleTime+=t,this.sleepState=1,this.idleTime>this.sleepTimeLimit&&(this.sleepState=2,this.angVel=0,this.vel=[0,0],this.force=[0,0])))}integrate(t){C.scale(tmp31,this.force,t*this.invMass),C.mult(tmp31,this.massMultiplier,tmp31),C.add(this.vel,tmp31,this.vel),C.scale(tmp32,this.vel,t),C.add(this.position,this.position,tmp32),this.angle+=this.angVel*t,C.rotate(i,this.shape.position,this.angle),C.add(i,i,this.position),this.shape.computeAABB(at,i,this.shape.angle+this.angle),this.aabb.copy(at)}}class Q{constructor(){this.bodies=[],this.solver=new H,this.narrowphase=new S,this.gravity=C.fromValues(0,-0),this.defaultMaterial={id:r++},this.defConMat=new o(this.defaultMaterial,this.defaultMaterial),this.conMats=[],this.stepping=!1,this.removeBodies=[],this.overlapKeeper=new Z}step(t){this.stepping=!0;var e=this.bodies,s=this.bodies.length,a=this.narrowphase;this.overlapKeeper.tick();for(var i=0;i!==s;i++)1===(n=e[i]).type&&2!==n.sleepState&&(C.scale(tmp33,this.gravity,n.mass),C.add(n.force,n.force,tmp33));for(var o=[],i=1;i!==s;i++){for(var n=e[i],r=i-1;0<=r&&!(e[r].aabb.lowerBound[0]<=n.aabb.lowerBound[0]);r--)e[r+1]=e[r];e[r+1]=n}for(i=0;i!==s;i++)for(n=e[i],r=i+1;r<s;r++){var h=e[r];if(h.aabb.lowerBound[0]>n.aabb.upperBound[0])break;2===n.type&&2===h.type||2===n.sleepState&&2===h.sleepState||2===n.sleepState&&2===h.type||2===h.sleepState&&2===n.type||!n.aabb.overlaps(h.aabb)||o.push(n,h)}for(a.reset(),i=0;i!==o.length;i+=2){var l=o[i],p=o[i+1],c=!1;if(l.shape.material&&p.shape.material)for(r=0;r!==this.conMats.length;r++){var m=this.conMats[r];if(m.materialA.id===l.shape.material.id&&m.materialB.id===p.shape.material.id||m.materialA.id===p.shape.material.id&&m.materialB.id===l.shape.material.id){c=m;break}}this.runNarrowphase(a,l,l.shape,l.shape.position,l.shape.angle,p,p.shape,p.shape.position,p.shape.angle,c||this.defConMat,-this.gravity[1])}for(i=0;i!==s;i++)(n=e[i]).narrowWakeUp&&(n.idleTime=0,n.sleepState=0,n.narrowWakeUp=!1);for((a.conEqs.length||a.fricEqs.length)&&this.solver.solve(t,a.conEqs.concat(a.fricEqs)),i=0;i!==s;i++)(n=e[i]).integrate(t),n.force=[0,0];for(i=0;i!==a.conEqs.length;i++){var d=a.conEqs[i];d.firstImpact&&nt({bodyA:d.bodyA,bodyB:d.bodyB})}for(i=0;i!==s;i++)(n=e[i]).sleepTick(t);for(this.stepping=!1,i=0;i!==this.removeBodies.length;i++)this.removeBody(this.removeBodies[i])}runNarrowphase(t,e,s,a,i,o,n,r,h,l,p){switch(C.rotate(tmp34,a,e.angle),C.rotate(tmp35,r,o.angle),C.add(tmp34,tmp34,e.position),C.add(tmp35,tmp35,o.position),a=i+e.angle,r=h+o.angle,t.frictionCoefficient=l.friction,t.slipForce=l.friction*p*(2===e.type?o.mass:2===o.type?e.mass:e.mass*o.mass/(e.mass+o.mass)),t.restitution=l.restitution,t.frictionStiffness=1e6,t.stiffness=l.stiffness,s.type|n.type){case 12:case 40:var c=t.planeCvx;break;case 5:c=t.circPlane;break;case 8:case 40:case 32:c=t.cvxCvx;break;case 9:case 33:c=t.circCvx;break;case 1:c=t.circCirc}c&&(s.type<n.type?c.call(t,e,s,tmp34,a,o,n,tmp35,r):c.call(t,o,n,tmp35,r,e,s,tmp34,a))&&(1===e.type&&2===e.sleepState&&0===o.sleepState&&2!==o.type&&C.sqLen(o.vel)+Math.pow(o.angVel,2)>=2*Math.pow(o.sleepSpeedLimit,2)&&(e.narrowWakeUp=!0),1===o.type&&2===o.sleepState&&0===e.sleepState&&2!==e.type&&C.sqLen(e.vel)+Math.pow(e.angVel,2)>=2*Math.pow(e.sleepSpeedLimit,2)&&(o.narrowWakeUp=!0),this.overlapKeeper.setOverlapping(e,s,o,n))}removeBody(t){if(this.stepping)this.removeBodies.push(t),this.removed=!0;else if(-1!==(t=this.bodies.indexOf(t))){for(var e=t,s=this.bodies.length-1;e<s;e++)this.bodies[e]=this.bodies[e+1];this.bodies.length=s}}}for(var E=1;E<=35;E++)window["tmp"+E]=C.create();var M,b,g,$=C.fromValues(0,1),tt=0,et=0,st=0,at=new G,i=C.create(),r=0,B=[],W=[],y=(W[38]=!1,W[40]=!1,[{ammos:["BOULDER","BOULDER","BOULDER","BOULDER","BOULDER"],level:"\n                       X\n                      BDDC\n                      W11E\n                X     WMME\n               BWE    W11E\n        X     BDWExxxxW11E\n       BWEC   W11E    W11E\n       WW1ExxxWMME    W11EC\n       WWME111W11E   BW11EE\n       WW1E111W11EDDDDW11EE\n       WW1ExxxW11E1111W11EE\n".split("\n")},{ammos:["IMPACT BOMB","IMPACT BOMB","IMPACT BOMB","IMPACT BOMB","IMPACT BOMB"],level:"\n          X\n          WE          \n          WE          \n         3WE3          \n         W1EE         \n         WMEE         \n         W1EE         \n         WMEE         \n         W1EE      X\n         WMEE   BDDDDDDC\n         W1EE  BDDDDDDDDC\n        BW1EE  W11111111E\n    BDDDDW1EE  W1M1451M1E\n    W1111W1EE  W11167111E\n    W1111W1EEX W11189111E\n".split("\n")},{ammos:["IMPACT BOMB","BOULDER","IMPACT BOMB","TIME BOMB"],level:"\n                                 X\n                              W1 1 1E\n                              W11111E\n                              W1M1M1E\n      BC      A      A        W11111E\n     BDDC    BDC    BDC    BC W11111E\n     W11E    W1E   BDDDC   WE W11111E\n     WMME X  WME   W111E  BWECW11111E\nBDDDDW11E 1 1W1Ec( WM1ME  WWEEW11111E\nW111EW11E1111111111W111EX WWEEW11111E\nW111EW11E1111451111W111E11WWEEW11111E\nW111EW11E1111671111W111E11WWEEW11111E\nW111EW11E1111891111W111E11WWEEW11111E\n".split("\n")},{ammos:["IMPACT BOMB","TIME BOMB","BOULDER","IMPACT BOMB","IMPACT BOMB"],level:"\n              3                  A\n             BDC                BDC\n             W1E                W1E\n             WME                WME\n             W1E                W1E\n             W1E                W1E\n            BDDDC              BDDDC\n            W111E              W111E\n            WM1ME              WM1ME\n            W111E              W111E\n           BDDDDDC            BDDDDDC\n           W11111E            W11111E\n           W11111E   BDDDDC   W11111E  \n           W11111E X W1111EX  W11111E\n   x       W11111ExxxW1451ExxxW11111E\n  xxX     xW11111ExxxW1671ExxxW11111Ex\n xxxW1E xxxW11111ExxxW1891ExxxW11111Exxx\n".split("\n")},{ammos:["TIME BOMB","IMPACT BOMB","IMPACT BOMB","IMPACT BOMB","IMPACT BOMB"],camera:{x:-160,y:190},zoom:20,level:"\n\n               BC\n              BDDC\n             BDDDDC\n             W1111E\n             WM11ME\n             W1111E\n         BC  W1xx1E  BC\n        BDDC W1  1E BDDC\n        W11E W1X 1E W11E\nW 1 1 E WxxE W1111E WxxE W 1 1 E\nW11111E W  E W1111E W  E W11111E\nWMMMMME WX E W1111E WX E WMMMMME\nW11111E W11E W1111E W11E W11111E\nW11111E W11E W1111E W11E W11111E\nW11111ExxxxxxxxxxxxxxxxxxW11111E\nW11111E111111111111111111W11111E\nW11111E11M11M114511M11M11W11111E\nW11111E111111116711111111W11111E \nW11111E111111118911111111W11111E     \n".split("\n")},{ammos:["IMPACT BOMB","IMPACT BOMB","TIME BOMB","TIME BOMB","TIME BOMB"],level:"\n            3\n           BDC\n          BDDDC\n          W111E\n          W1M1E\n BDDDDDDDDW111E\n W11111111W1M1Exxxxxxxxx\n W1M1111M1W111Exxxxx   x\n W11111111xxxxxx     X x\n xxxxxxxxxxxxxxx     WE \n                     WE \n                     WE \n                   xxxxx\n                       x     A\n                       x    BDC\n                xW1Ex  x    W1E\n                xW1Ex  xDDDDWME\n xx   BDDDC     xWMEx  x1111W1E  \n xx   W111Exxx  xW1Ex  x1M11W1E\n xx   W1M1Exxx  xW1Ex  x1111DDDC\n xx   W111ExxxX xW1ExX x1111111E\n".split("\n")},{ammos:["IMPACT BOMB","IMPACT BOMB","IMPACT BOMB","TIME BOMB"],level:"\n                              3\n                             BDC\n                             W1E\n                     A       WME\n                    BDC      W1E  BDC \n                   BDDDC     W1E  W1E \nxxx                W1xxxxxx  xxx  xxx\nxxx                WMxxx\nxxx BDDDC          W1xxx\nxxxxxx11E          WMxxx\nxxxx  1ME        BDW1xxx                 \nxxxxX 11E        W1xxxxx\nxxxxxxxxxx       WME xxx 1 1 E\nxxxx             W1E xxx11111E\nxxxxBDC          W1E xxx1MMMME\nxxxxW1EBC       BDDDCxxx11111E\nxxxxWMEWE       W111Exxx11111E\nxxxxW1EWE       W111Exxx11451E\nxxxxW1EWEDDDC   W111Exxx11671E\nxxxxW1EWEW11E X W111Exxx11891E    X  \n".split("\n")}]);function it(t,e,s,a,i,o){this.x=t,this.y=e,this.z=s,this.velX=a,this.velY=i,this.velZ=o,this.type="particle",this.frame=0,this.update=function(){this.frame++,this.velY-=.001,this.x+=this.velX,this.y+=this.velY,this.z+=this.velZ,M.beginPath();var t=this.x,e=Math.max(-.5,this.y);return M.strokeStyle="rgba(255, 139, 50, "+(1-1/60*this.frame)+")",M.arc(t*V,e*-V,.05*V,0,2*Math.PI),M.stroke(),60!=this.frame}}function h(t,e,s,a,i){for(var o=0;o<a;o++){var n=Math.random()*i-i/2,r=Math.random()*i-i/2,h=Math.random()*i-i/2;objects.push(new it(t,e,s,n,r,h))}}function p(t){switch(t.ID=objects.length,t.addImpact=function(t,e){this.life-=t,this.life<0?objects[this.ID].destroy():"box"==this.type&&zzfx(1,.05,148,.01,.01,.16,4,.49,2,0,0,0,0,.4,0,.4,0,.5,0,.06),"circ"!=this.type||"IMPACT BOMB"!=this.weapon||e||this.explode()},t.destroy=function(){var t,e,s,a;"box"==this.type&&1==this.height&&(h(this.body.position[0],this.body.position[1],0,10,.02),zzfx(2.44,.05,615,0,.18,.5,2,3.62,.7,0,0,0,0,1.8,-44,.5,.03,.32,.16,.22)),this.died||"box"!=this.type||1.5!=this.height||(h(this.body.position[0],this.body.position[1],0,10,.12),zzfx(1.36,0,261.6256,.02,.17,.58,0,.6,0,.2,250,.09,.05,0,0,0,.06,.5,.4,0),--nbChests)||ht(),this.died=!0,w.removeBody(this.body),"box"==this.type&&1==this.height&&.5<Math.random()&&(p({type:"box",position:[t=this.body.position[0],e=this.body.position[1]],width:.5,height:.5,subType:s=this.subType,part:a=this.part}),p({type:"box",position:[t+.5,e],width:.5,height:.5,subType:s,part:a}),p({type:"box",position:[t,e-.5],width:1,height:.5,subType:s,part:a}))},t.explode=function(){var t=this.body.position[0],e=this.body.position[1];h(t,e,0,100,.2),L.frame||(L.position.x=X.x,L.position.y=X.y),L.frame=1;for(var s=0;s<w.bodies.length;s++){var a,i,o,n=w.bodies[s];n.mass&&(a=n.position[0],i=n.position[1],o=Math.atan2(a-t,i-e),f=50-Math.min(10*Math.hypot(t-a,e-i),50),n.force=[Math.sin(o)*f,Math.cos(o)*f],n.Y)&&n._ID!=this.ID&&objects[n._ID].addImpact(f,!0)}w.removeBody(this.body),objects[this.ID].destroy(),B.splice(B.indexOf(this),1);for(var r=0;r!==w.bodies.length;r++)w.bodies[r].idleTime=0},objects.push(t),t.life=t.life||50,t.type){case"triangle3":case"triangleA":case"triangleB":case"triangleC":case"triangleD":t.width=1,t.height=1,t.mass=.1,t.shape=new u({type:t.type,width:t.width,height:t.height}),t.shape.material=materialCrate;break;case"box":t.width=t.width||1,t.height=t.height||1,t.mass=0===t.mass?0:.1,t.shape=new u({type:"box",width:t.width,height:t.height}),t.shape.material=materialCrate;break;case"circ":t.life=1e3,t.shape=new z({radius:t.radius}),t.shape.material=materialBall}return t.body=new J(t),t}function A(t){this.s=t%2147483647,this.n=function(){return this.s=16807*this.s%2147483647,(this.s-1)/2147483646}}materialBall={id:r++},materialCrate={id:r++};var w,P=document.createElement("canvas");function c(){for(v=480,t=[mr.n()*v|0,mr.n()*v|0];t.length<1008;)v*=.52,t=function(t,e){for(n=[t[0]],a=1;a<t.length;a++)n.push((t[a-1]+t[a])/2+(mr.n()-.5)*e|0),n.push(t[a]);return n}(t,v);var e=P.getContext("2d"),s=e.createLinearGradient(0,480,0,0);s.addColorStop(0,"#000"),s.addColorStop(.95,"rgb(100,"+Math.floor(100+155*mr.n())+",100)"),e.strokeStyle=s;for(var a=0;a<1008;a++)e.beginPath(),e.moveTo(a+.5,480-t[a]),e.lineTo(a+.5,480),e.stroke()}P.width=1008,P.height=480;var D=[],I=new Image;I.src="c.png",I.onload=function(){for(var t=0;t<10;t++)D.push({x:1224*Math.random(),y:250*Math.random(),size:.5+Math.random()/2,speed:Math.random()/4})};var T,ot=[];function nt(t){var e=t.bodyA.shape,s=[(t=t.bodyB.shape).body.vel[0]-e.body.vel[0],t.body.vel[1]-e.body.vel[1]];(s=Math.sqrt(s[0]*s[0]+s[1]*s[1]))<1||(e.body.Y&&objects[e.body._ID].addImpact(s),t.body.Y&&objects[t.body._ID].addImpact(s))}function k(t,e,s,a,i){M.beginPath(),i?M.arc(t*V,-e*V,i/2*V,0,2*Math.PI):M.rect(t*V,-e*V,s*V,a*V),M.translate(t*V,e*-V),M.scale(V/40,V/40),M.fill(),M.stroke(),M.scale(1/(V/40),1/(V/40)),M.translate(t*-V,e*V)}var m=[];function rt(t,e,s,a=10,i){M.beginPath(),M.fillStyle=i||textures.T,pX=t;for(var o=0;o<s.length;o++){for(var n=0,r=0;r<5;r++)for(var h=0;h<3;h++)" "!=s[o]&&"1"==m[s[o]][n++]&&M.rect(pX+h*a,e+r*a,a,a);pX+=3.5*a}M.save(),M.translate(t,e),M.scale(.5,.5),M.fill(),M.restore()}function q(t,e){if("level"==(screen=t)){var s=levelNumber=e;nbChests=3,level=y[s].level,ammos=y[s].ammos.slice(),w=new Q,objects=[];for(var a=0;a<level[level.length-2].length;a++)for(var i=0;i<level.length;i++)switch(s=level[i][a]){case"X":p({type:"box",subType:s,position:[a+.5,level.length-i-1.75],width:2,height:1.5,life:10});break;case"1":case"M":case"E":case"W":case"x":p({type:"box",subType:s,position:[a,level.length-i-2],mass:"x"==s?0:.1,life:"x"==s?5e4:50});break;case"c":p({type:"box",subType:s,position:[a,level.length-i-2-.25],width:1,height:.5,angle:(level.length-i-1)%2==0?0:Math.PI});break;case"(":p({type:"box",subType:s,position:[a+.5,level.length-i-2-.25],width:1,height:.5,angle:(level.length-i-1)%2==0?0:Math.PI});break;case"3":case"A":case"B":case"C":case"D":p({type:"triangle"+s,position:[a,level.length-i-2]});break;case" ":case void 0:break;default:p({type:"box",subType:"windows",position:[a,level.length-i-2],width:1,height:1,angle:5==s?-Math.PI/2:0,part:s-4})}planeShape=new R,new J({position:[0,-.5],angle:0,shape:planeShape}),planeShape.material={id:r++},w.conMats.push(new o(planeShape.material,materialBall,{restitution:.8,stiffness:2e7,friction:100})),w.conMats.push(new o(materialCrate,materialCrate,{restitution:0,stiffness:1e7,friction:1})),w.conMats.push(new o(planeShape.material,materialCrate,{restitution:0,stiffness:1e5,friction:1e4}))}}m[1]="010110010010111",m[2]="111001111100111",m[3]="111001111001111",m[4]="101101111001001",m[5]="111100111001111",m[6]="111100111101111",m[7]="111001010010010",m[8]="111101111101111",m[9]="111101111001111",m.A="111101111101101",m.B="110101111101111",m.C="111100100100111",m.D="110101101101110",m.E="111100111100111",m.I="111010010010111",m.K="101101110101101",m.L="100100100100111",m.M="101111111101101",m.O="111101101101111",m.P="110101110100100",m.R="111101111110101",m.S="111100111001111",m.T="111010010010010",m.U="101101101101111",m.V="101101101101010",screen="",q("home");var F=.1,O=0,L={frame:0,position:{}},X={x:-160,y:190},V=20,j=(onclick=function(t){if("home"==screen){var e=canvas.getBoundingClientRect(),s=t.clientX*canvas.width/e.width;if(xTest=180,250<(t=t.clientY*canvas.height/e.height)&&t<310)for(E=0;E<7;E++)s>=xTest&&s<=xTest+80&&E<=localStorage.gp44.length&&q("level",E),xTest+=130}},onkeyup=function(t){var e;W[t.keyCode]=!1,32==t.keyCode&&ammos.length&&(t=4*Math.sqrt(Math.min(O-j,100)/100*20),j=0,e=p({type:"circ",weapon:ammos.shift(),radius:.2,mass:1,position:[3.5*Math.cos(F)-15,.25+3.5*Math.sin(F)]}),w.gravity=C.fromValues(0,-5),e.age=O,e.body.vel=[Math.cos(F)*t,Math.sin(F)*t],B.push(e))},0);function ht(){T||(T=!0,setTimeout(function(){localStorage.gp44=localStorage.gp44.slice(0,levelNumber)+Math.max(0|localStorage.gp44[levelNumber],3-nbChests)+localStorage.gp44.slice(levelNumber+1),q("home"),T=!1},1e4))}function d(o,t,e,n=40,s=40){var a=document.createElement("canvas"),i=((ot[t+e]=a).width=n,a.height=s,a.getContext("2d")),r=i.createImageData(n,s),h=r.data,l=[100,80,70],p=[50,40,35];mr=new A(1001);for(var c=0;c<s;c++)for(var m=0;m<n;m++){var d=4*(c*n+m),x=[190+(u=20*Math.random()-10),150+u,100+u];if((c==s/2||s/2<c&&m==n/2||c<s/2&&0==m||0===c)&&(x=l),"E"==t&&25<m&&(percent=1-1/30*(m-25),x=[x[0]*percent,x[1]*percent,x[2]*percent]),"W"==t&&m<15&&(percent=.5+1/30*m,x=[x[0]*percent,x[1]*percent,x[2]*percent]),"M"==t&&14<m&&m<26&&(percent=0,x=[x[0]*percent,x[1]*percent,x[2]*percent]),"tuile"==t){const o=(c%20<10&&(20==m||0==m)||10<c%20&&(10==m||30==m))==(Math.floor(c)%10==0)?10+Math.floor(30*Math.random()):80;x=[o,o,o]}if("windows"==t){var u=Math.floor(70*Math.random())+145,v=Math.floor(30*Math.random())+60,E=Math.floor(30*Math.random())+10;switch(e){case 1:case 2:(b=Math.hypot(80-m,80-c))<90?x=87.75<b||(m+3)%10<3||(c+3)%10<3?p:[.9*u,.9*v,.9*E]:m==n/2&&(x=l);break;case 3:case 4:case 5:case 6:x=[u+m,v+m,E+m],4!=e&&6!=e||(m=40-m),3!=e&&5!=e&&4!=e&&6!=e||m<5&&(percent=1/3*m,x=[x[0]*percent,x[1]*percent,x[2]*percent]),m%10<2&&(percent=.8,x=[x[0]*percent,x[1]*percent,x[2]*percent]),e<5&&c<10&&c/2<(m+5)%20&&(m+5)%20<c/2+10-c&&(x=p),(37<m||20<c&&c<30)&&(x=p),(5==e||6==e)&&(b=Math.hypot(30-m,5-c))<5&&2.5<b&&(x=p),4!=e&&6!=e||(m=40-m);break;case 7:x=m<2||c<2?[1.2*u,1.2*v,1.2*E]:2==m||237==m||2==c||17==c||8<c&&c<12&&m%10<3||237<m||17<c?[.6*u,.6*v,.6*E]:[.9*u,.9*v,.9*E];break;case 8:x=[1.2*u,2.4*v,2.5*E];break;case 9:var b,x=[u,v,E],f=m<8||72<m||c<4||18<c&&c<26||52<c;(c<18&&c%8<2||(c+26)%10<2)&&(x=[.8*u,.8*v,.8*E]),(b=Math.hypot(20-m,39-c))<3&&(x=p),((b=Math.hypot(60-m,39-c))<3||25<c&&c<35&&36<m&&m<44||f)&&(x=p,m%2==0&&c%2==0||m%2==1&&c%2==1)&&(x=[.5*x[0],.5*x[1],.5*x[2]]);break;case 10:x=[.4*x[0],.5*x[1],.6*x[2]]}}h[d]=x[0],h[d+1]=x[1],h[d+2]=x[2],h[d+3]=255}for(var g=[],B=0;B<20;B++)g.push([Math.floor(40*mr.n()),Math.floor(40*mr.n())]);return g.forEach(function(t,e){mr=new A(e);for(var s=t[0],a=t[1],i=0;i<o;i++)s+=mr.n()<.33?-1:mr.n()<.66?0:1,a+=mr.n()<.33?-1:mr.n()<.66?0:1,x=[152,120,80],h[d=4*(a*n+s)]=x[0],h[d+1]=x[1],h[d+2]=x[2],h[d+3]=255}),i.putImageData(r,0,0),M.createPattern(a,"repeat")}onkeydown=function(t){W[t.keyCode]=!0,j||32!=t.keyCode||(j=O)},localStorage.gp44=localStorage.gp44||"",b=canvas.width,g=canvas.height,M=canvas.getContext("2d"),textures={X:d(0,"windows",9,80,60),T:d(0,"tuile",1),W:d(0,"W",1),E:d(0,"E",1),M:d(0,"M",1),B:d(0,"windows",7,240,20),R:d(0,"windows",8),x:d(0,"windows",10),w:[d(0,"windows",1),d(0,"windows",2),d(0,"windows",3),d(0,"windows",4),d(0,"windows",5),d(0,"windows",6)],b:[]};for(var U=0;U<=50;U++)textures.b[U]=d(U);mr=new A(201),c(),c(),c(),function t(){L.frame&&(L.frame++,explodeForce=30-L.frame,X.x=L.position.x+Math.random()*explodeForce-explodeForce/2,X.y=L.position.y+Math.random()*explodeForce-explodeForce/2,30==L.frame)&&(L.frame=0,X.x=L.position.x,X.y=L.position.y);for(var e=0;e<B.length;e++){var s=B[e];"TIME BOMB"==s.weapon&&300<O-s.age&&s.explode()}for(O++,W[38]&&(F=Math.min(1.17,F+.015)),W[40]&&(F=Math.max(.1,F-.015)),W[27]&&q("home"),requestAnimationFrame(t),"level"==screen&&w&&w.step(1/60),M.fillStyle="#4290D1",M.fillRect(0,0,b,g),E=0;E<D.length;E++)D[E].x<-200&&(D[E].x=1200),M.drawImage(I,D[E].x-=D[E].speed,D[E].y,128*D[E].size,71*D[E].size);if(M.drawImage(P,0,0,b,g),"home"==screen){for(rt(372,75,"CASTLE ATTACK"),x=180,E=0;E<7;E++){M.beginPath(),M.fillStyle="white",M.rect(x,250,80,60),M.strokeStyle=E>localStorage.gp44.length?"gray":"black",M.fill(),M.stroke(),M.beginPath(),rt(x+18,260,"LEVEL "+(E+1),2,E>localStorage.gp44.length?"gray":"black");for(var a=0;a<3;a++)M.globalAlpha=localStorage.gp44[E]>a?1:.2,M.drawImage(ot.windows9,x+12+20*a,290,16,12);M.globalAlpha=1,x+=130}M.beginPath()}if("level"==screen){if(!T){var i=y[levelNumber].ammos,o=i.length-ammos.length,n=20;for(l=0;l<i.length;l++)rt(30,n-(l==o?4:0),i[l],l==o?3:2,l<o?"#666":null),n+=20;M.beginPath(),M.strokeStyle="black",ammos.length?(M.moveTo(10,22+20*o),M.lineTo(25,22+20*o)):ht(),M.stroke()}M.save(),M.translate(b/2+X.x,g/2+X.y);for(var r=0;r<objects.length;r++)if(!objects[r].died)switch(objects[r].type){case"box":case"triangle3":case"triangleA":case"triangleB":case"triangleC":case"triangleD":var h=m=c=p=void 0,p=objects[r];if(p.shape.vertices){var c=p.body.position[0],m=p.body.position[1];for(M.save(),M.translate(c*V,m*-V),M.rotate(-p.body.angle),vertices=p.shape.vertices,M.beginPath(),c=vertices[0],M.moveTo(c[0]*V,-c[1]*V),h=1;h<vertices.length;h++)M.lineTo(vertices[h][0]*V,-vertices[h][1]*V);"X"==p.subType?(M.translate(+V,V/1.35),M.scale(V/40,V/40)):(M.translate(-.51*V,-.51*V),M.scale(V/40,V/(40*p.height))),"triangle"==p.type.substring(0,8)?M.fillStyle=textures.T:"windows"==p.subType?M.fillStyle=textures.w[p.part]:(M.fillStyle=textures.b[50-Math.floor(p.life)],p.subType&&(M.fillStyle=textures[p.subType])),M.fill(),M.restore()}break;case"circ":m=objects[r],c=void 0,M.fillStyle=textures.R,c=2*m.shape.radius,k(m.body.position[0],m.body.position[1],c,c,c);break;case"particle":objects[r].update()||(objects[r].died=!0)}M.beginPath(),M.strokeStyle="black",M.moveTo(-b,.5*V),M.lineTo(b,.5*V),M.stroke(),M.restore(),M.fillStyle=textures.B,M.save(),M.translate(b/2+X.x-15*V,g/2+X.y-0*-V),M.translate(0,.25*-V),M.rotate(-F),k(0,.25,4,.5),M.fillRect(3.5*V,-0*V,.25*V,-.5*V);var d=W[32]*(Math.min(O-j,100)/100);M.beginPath(),M.moveTo(3.5*V,-.5*V),M.lineTo((3.5-3.5*d)*V,-.25*V),M.stroke(),M.rotate(F),M.translate(0,.25*V),k(-.5,.25,6,.5),k(.5,0,1,1,1),k(4.5,0,1,1,1),M.restore()}}()</script>