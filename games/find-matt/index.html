<title>Find Matt - js13kGames 2020</title><style>body{margin:0}canvas{display:block}</style><body><script type=module>import*as l from"/2020/webxr/three.js";class s{constructor(e,t,i,s={width:60,height:25},n){this.scene=e,this.canvas=document.createElement("canvas"),this.cameraPosition=i,this.size=s,this.pages=void 0,this.pageCursor=0,this.options=n,this.camera=t,this.starshipPosition=i,(e=new l.Raycaster).setFromCamera({x:0,y:0},t),s=new l.Vector3,e.ray.at(45,s),this.boxPosition={x:s.x,y:s.y,z:s.z};var{x:n,y:t,z:e}=this.boxPosition,{width:s,height:o}=this.size;s=new l.PlaneGeometry(s,o),this.material=new l.MeshBasicMaterial,this.material.map=new l.CanvasTexture(this.canvas),this.plane=new l.Mesh(s,this.material),this.plane.position.x=n,this.plane.position.y=t-50,this.plane.position.z=e,this.plane.kind="message",this.plane.lookAt(i),this.scene.add(this.plane)}updateText(e){const t=e||this.pages[this.pageCursor],i=this.canvas.getContext("2d"),s=i.canvas.width,n=i.canvas.height;i.clearRect(0,0,s,n),i.fillStyle="#222222",i.fillRect(0,0,s,n),i.font=`${this.options&&this.options.fontSize||"20px"} Lucida Console`,i.fillStyle="white",t&&t.split("\n").forEach((e,t)=>{i.fillText(e,5,50+24*t,s)}),this.material.map.needsUpdate=!0}render(e){this.pages||(this.pages="string"==typeof e?[e]:e),this.pages&&"string"==typeof e&&(this.pages=[e]),this.updateText()}followCamera(){var e,t,i;this.options&&this.options.static&&((e=new l.Raycaster).setFromCamera({x:0,y:0},this.camera),t=new l.Vector3,{x:e,y:t,z:i}=(e.ray.at(this.options&&this.options.distance||100,t),this.boxPosition={x:t.x,y:t.y,z:t.z},this.boxPosition),this.plane.position.x=e,this.plane.position.y=t-(this.options&&this.options.yOffset||30),this.plane.position.z=i,this.plane.lookAt(this.starshipPosition))}autoNext(i){return new Promise(e=>{const t=setInterval(()=>{this.next()||(clearInterval(t),e())},i||2e3)})}next(){if(this.pages)return this.pageCursor+=1,this.pageCursor===this.pages.length?(this.destroy(),!1):(this.render(),!0)}reset(){this.pages=void 0,this.pageCursor=0}destroy(){this.reset(),this.scene.remove(this.plane)}}class t{constructor(e,t,i,s,n){this.inTransitToSystem,this.position=e.position,this.orbitingSystem=e,this.speed=n&&n.speed||10,this.direction,this.directionLine,this.scene=t,this.starshipPosition=i,this.gameOverCallback=s,this.options=n,e=new l.RingGeometry(3,6,2),t=new l.MeshBasicMaterial({color:n&&n.color||16711680}),i=new l.Mesh(e,t),s=new l.Raycaster;var{x:e,y:t,z:o}=this.starshipPosition,{x:a,y:r,z:h}=this.orbitingSystem.position;let c=new l.Vector3(this.position.x-this.starshipPosition.x,this.position.y-this.starshipPosition.y,this.position.z-this.starshipPosition.z);c=c.normalize(),e=new l.Vector3(e,t,o),t=new l.Vector3(a,r,h),o=e.distanceTo(t),c.applyAxisAngle(new l.Vector3(1,0,0),.02),s.set(e,c),a=new l.Vector3,s.ray.at(o,a),i.position.x=a.x,i.position.y=a.y,i.position.z=a.z,i.kind=n&&n.kind||"enemy",this.object3D=i,this.scene.add(i)}goTo(){const i=new l.Vector3(this.object3D.position.x,this.object3D.position.y,this.object3D.position.z);this.inTransitToSystem=this.scene.children.find(e=>{var t;return this.inTransitToSystem.uuid===e.uuid?null:(t=this.options&&this.options.maxDistance||700,("system"===e.kind||"singularity"===e.kind)&&50<i.distanceTo(new l.Vector3(e.position.x,e.position.y,e.position.z))&&i.distanceTo(new l.Vector3(e.position.x,e.position.y,e.position.z))<t)});var e=new l.Vector3(this.inTransitToSystem.position.x-this.object3D.position.x,this.inTransitToSystem.position.y-this.object3D.position.y,this.inTransitToSystem.position.z-this.object3D.position.z),t=(this.direction=e.normalize(),(e=new l.Geometry).vertices.push(i),e.vertices.push(new l.Vector3(this.inTransitToSystem.position.x,this.inTransitToSystem.position.y,this.inTransitToSystem.position.z)),new l.LineBasicMaterial({color:this.options&&this.options.directionColor||5570560}));this.directionLine=new l.Line(e,t),this.scene.add(this.directionLine)}move(){this.object3D.position.x+=this.direction.x*this.speed,this.object3D.position.y+=this.direction.y*this.speed,this.object3D.position.z+=this.direction.z*this.speed;var e=new l.Vector3(this.object3D.position.x,this.object3D.position.y,this.object3D.position.z),{x:t,y:i,z:s}=this.inTransitToSystem.position;e.distanceTo(new l.Vector3(t,i,s))<50&&(this.inTransitToSystem.systemId===this.orbitingSystemId&&this.gameOverCallback(),this.scene.remove(this.directionLine),this.goTo()),this.object3D.lookAt(this.starshipPosition)}think(){this.inTransitToSystem?this.move():(this.inTransitToSystem={},this.goTo())}setOrbitingSystemId(e){this.orbitingSystemId=e}}class L extends t{constructor(e,t,i,s){super(e,t,i,s,{kind:"matt",color:255,directionColor:85,speed:20,maxDistance:1e3})}}let o,n,a,r,h,c,d,p,m,R,N,y,u,w,f,x,g=0,b=new l.Scene,T=10,v=0,k=!1,I=0,S=[],M=0;function H(e){e.material.color.setHSL(.4,1,.7),e.isVisited=!0}function B(e){var t,i;e.isNextTarget=!0,t=new l.RingGeometry(20,22,32),i=new l.MeshBasicMaterial({color:16776960,side:l.DoubleSide}),(t=new l.Mesh(t,i)).kind="indicator",e.add(t)}function F(e){e.isNextTarget=!1,e.remove(e.children.find(e=>"indicator"===e.kind))}function z(){return b.children.filter(e=>"system"===e.kind||"singularity"===e.kind)}function C(e,t){const i=new l.Vector3(e.x,e.y,e.z);return z().filter(e=>i.distanceTo(new l.Vector3(e.position.x,e.position.y,e.position.z))<=t)}function D(e){var t=new l.Raycaster;t.setFromCamera({x:0,y:0},o);let i=new l.Vector3;t.ray.at(e?e-100:400,i);let s,n=(t=C(c.position,e||500))[0];return t.forEach(e=>{var t=i.distanceTo(new l.Vector3(e.position.x,e.position.y,e.position.z));s&&t<s&&(n=e),s=t}),n}function j(e,t,n){C(e,t).forEach(e=>{var t=n&&n[0]||.2,i=n&&n[1]||.9,s=n&&n[2]||.6;e.material.color.setHSL(t,i,s),e.inSearchArea=!0})}function E(){z().forEach(e=>{e.material.color.setHSL(0,0,1),e.inSearchArea=!1}),w=void 0}function A(){var e=(e=C(c.position,500))[Math.floor(Math.random()*e.length)-1];S.push(new t(e,b,c.position,()=>{f.render("Game Over"),r=3}))}function e(){var e,t,i=5e-5*Date.now();switch(a.followCamera(),v){case 0:f.render(["FIND MATT\nA JS13k 2020 game\nBy Eric Ros\n\nLook here to start.","To play, just move your headset around.\nNo controllers required."]);break;case 1:c.position.set(0,1.6,0),2!==r&&(r=2,(f=new s(b,o,c.position)).render(["Matt left our planet years ago...\nHe was looking for a new home...\nBefore it's too late.","I marked in the map where he is\n supposed to be.\n Just look there."]),v+=1);break;case 2:y?k&&(r=2,f.render(["I've detected a signal...\nIt's a beacon...","...but it doesn't contain any message.\nWhy?","And where is Matt?\nOur new home is here...\nBut, wait.","It has been devastated.\nThe Plague did this.\nI'm sure.","If they are here, our home planet\nwill be destroyed within months,\nmaybe weeks.","I must evade their ships, or I'm dead.","I can calculate Matt's route\nbased on the beacon orientation.\n","It's a risky guess\n but it's the only thing I have","I only need to check\nthe dozens of systems\nin that sector.\nGood luck Amy..."]),k=!1,v+=1,F(y),H(y),y=void 0):B(y=D());break;case 3:w||(h=2,j((w=D(1300)).position,400)),k&&(r=2,f.render(["I'm not alone in this sector\nI detect a near starship...","The Plague is here!","I marked its position on the map\nso I remember to stay away\n from them."]),A(),k=!1,v+=1,h=1);break;case 4:k&&(r=2,f.render(["It's my lucky day!\nI found another beacon!","Matt is OK, and he\nis looking for black matter\nto power his starship.","It can be found scanning singularities (blue).\nI need it to travel through\ninterestellar space.","His ship's navigation system\nseems to be broken\nso I can only make aproximate\ncalculations about his route."]),k=!1,v+=1,E());break;case 5:w||(h=2,j((w=D(1e3)).position,500)),k&&(r=2,f.render(["Bad news...","His navigation system seems definitively broken","He is heading to The Plague territory!","I need to arrive to the\ndestination sector without\nbeing discovered."]),k=!1,v+=1,E());break;case 6:w||(A(),A(),A(),h=2,C((w=D(700)).position,500).forEach(e=>{e.material.color.setHSL(1,.5,.5),e.inDangerArea=!0}),j((w=D(1600)).position,400)),k&&(r=2,f.render(["I found another beacon.\nIf my calculations are correct\nthis is Matt's last beacon.","It says that he received a strange signal from a system far away"]),k=!1,v+=1,E(),z().forEach(e=>{e.material.color.setHSL(0,0,1),e.inDangerArea=!1}));break;case 7:y?k&&(r=2,f.render(["This is incredible...\nThere is an ancient civilization here.","They have a sort of\ntelepathy ability they use to\ncomunicate with me.","They were once an galactic civilization,\nuntil they were decimated by The Plague","They planned to flee to a legendary planet\ncalled 'The Paradise'.\nBut they never could\nfind it.","For my surprise, they\nrevealed me that\nthey had another visitor\njust some days ago","It means that he is not far from here."]),k=!1,v+=1,F(y)):B(y=D(1500));break;case 8:w||(A(),h=3,j((w=D(0)).position,400)),k=!0,r=2,f.render(["I detected another signal today.\nBut this time is not a beacon.","It's Matt's starship!\nI must hurry!"]),k=!1,v+=1,E(),e=(e=C(c.position,500))[Math.floor(Math.random()*e.length)-1],x=new L(e,b,c.position,()=>{f.destroy(),M=0,(f=new s(b,o,c.position)).render(["I finally managed to\nintercept Matt's starship. He looked surprised.","- I was losing hope - he said.\n- But now I'm sure we\nwill be successful\nin our mission","- I went across a thousand\nstars for you - I said.","- Then let's find The Paradise together","My paradise is wherever you are.","THE END"]),r=3})}if(g%40==0&&2!==r&&3!==r&&(S.forEach(e=>{e.think()}),x)&&x.think(),0<I&&(c.position.x+=d.x*I,c.position.y+=d.y*I,c.position.z+=d.z*I,m&&m<250?I-=.006:I<1&&(I+=.003),(I<0||m<50)&&(S.forEach(e=>{e.setOrbitingSystemId(p.systemId)}),x&&x.setOrbitingSystemId(p.systemId),I=0,R=p.systemId,r=1,f=new s(b,o,c.position)),g%10==0&&(m=Math.sqrt(Math.pow(p.position.x-c.position.x,2)+Math.pow(p.position.y-c.position.y,2)+Math.pow(p.position.z-c.position.z,2))),z().forEach(e=>{e.lookAt(c.position)})),1===r&&(M+=.7,f.render(`SCANNING...${M.toFixed(0)}%`),100<=M))if(f.reset(),r=0,M=0,p.inDangerArea)f.render("This is the last entry in my log\nThe Plague caught me\nMatt, forgive me.\n(GAME OVER)"),r=3;else if(p.isNextTarget)f.reset(),k=!0;else if(H(p),p.inSearchArea&&0<h&&0==--h&&(k=!0),!p.inSearchArea||p.inSearchArea&&0<h){if("singularity"===p.kind){const l=Math.floor(6*Math.random()+1);T+=l,a.updateText(String("Jumps: "+T)),f.render(`Found black matter\nfor ${l} jumps`)}else 0===T?(f.render("I run out of black matter.\nI will end my days here.\n(GAME OVER)"),r=3):f.render("Nothing found");setTimeout(()=>{f.destroy()},1500)}!(i=N.pick({x:0,y:0},b,o,i))||0!==I||i.systemId===R||2===r||"system"!==i.kind&&"singularity"!==i.kind||i.isVisited?!i||2!==r&&3!==r||"message"!==i.kind||u?i&&0===v&&"message"===i.kind&&!u&&f.autoNext(5e3).then(()=>{f.destroy(),r=0,I=0,v+=1}):f.autoNext().then(()=>{3===r?location.reload():r=0}):(i.material.color.setHex(16776960),t=i,0<T&&(--T,a.updateText(String("Jumps: "+T)),I=.1,d=(d=new l.Vector3(t.position.x-c.position.x,t.position.y-c.position.y,t.position.z-c.position.z)).normalize(),p=t)),u=!!i,n.render(b,o),g+=1}b.fog=new l.FogExp2(0,.001),c=new l.Object3D,b.add(c),o=new l.PerspectiveCamera(50,window.innerWidth/window.innerHeight,.1,2e3),c.position.set(0,1.6,0),c.add(o),f=new s(b,o,c.position),(a=new class extends s{constructor(e,t,i,s={width:8,height:3}){super(e,t,i,s,{static:!0,yOffset:0,distance:20,fontSize:"64px"})}}(b,o,c.position)).render(["Jumps: "+String(T)]),N=new class{constructor(e,t){this.raycaster=new l.Raycaster,this.pickedObject=null,this.pickedObjectSavedColor=0,this.camera=e,this.maxInteractiveDistance=t,e=this.getCursor(),this.camera.add(e),e.position.z=-1.5,e.scale.set(.05,.05,.05),this.cursor=e,this.selectTimer=0,this.selectDuration=2,this.lastTime=0,this.selected=!1}getCursor(e=0){var t=new Uint8Array([64,64,64,64,200,200,200,200]),i=(this.cursorTexture=((t=new l.DataTexture(t,2,1,l.RGBAFormat)).minFilter=l.NearestFilter,t.magFilter=l.NearestFilter,t.needsUpdate=!0,t),t=new l.TorusBufferGeometry(.3,.15,4,4),new l.MeshBasicMaterial({color:"yellow",map:this.cursorTexture,transparent:!0,blending:l.CustomBlending,blendSrc:l.OneMinusDstColorFactor,blendDst:l.OneMinusSrcColorFactor})),t=new l.Mesh(t,i),i=this.selectDuration;return this.cursorTexture.offset.x=l.MathUtils.mapLinear(this.selectTimer,0,i,-.5,.5),t}pick(e,t,i,s){var n=s-this.lastTime,o=this.pickedObject;if(!this.pickedObject&&this.selected&&(this.selected=!1,this.selectTimer=0),this.pickedObject&&(this.pickedObject=void 0),this.raycaster.setFromCamera(e,i),(i=this.raycaster.intersectObjects(t.children)).length){this.pickedObject=i[0].object;const e=new l.Vector3(this.camera.position.x,this.camera.position.y,this.camera.position.z).distanceTo(new l.Vector3(this.pickedObject.position.x,this.pickedObject.position.y,this.pickedObject.position.z))<this.maxInteractiveDistance,t=(this.pickedObject&&o===this.pickedObject&&!this.selected&&e?(this.selectTimer+=n,this.selectTimer>=this.selectDuration&&(this.selectTimer=0,this.selected=!0)):(this.lastTime=s,this.selectTimer=0),this.selectDuration);return this.cursorTexture.offset.x=l.MathUtils.mapLinear(this.selectTimer,0,t,-.5,.5),this.selected?this.pickedObject:void 0}}}(o,1500);for(let e=0;e<5e3;e++){var i=.95<Math.random(),G=4e3*Math.random()-2e3,W=4e3*Math.random()-2e3,q=4e3*Math.random()-2e3,O=new l.CircleGeometry(i?7:10,32),U=new l.MeshBasicMaterial({transparent:!1});(O=new l.Mesh(O,U)).position.x=G,O.position.y=W,O.position.z=q,O.kind=i?"singularity":"system",O.systemId=e,O.lookAt(c.position),i&&O.material.color.setHSL(.6,.8,.3),b.add(O)}if((n=new l.WebGLRenderer).setPixelRatio(window.devicePixelRatio),n.setSize(window.innerWidth,window.innerHeight),n.xr.enabled=!0,document.body.appendChild(n.domElement),document.body.appendChild((X=n,"xr"in navigator?((P=document.createElement("button")).style.display="none",$(P),navigator.xr.isSessionSupported("immersive-vr").then(function(e){function s(e){e.addEventListener("end",t),P.style.display="none",X.xr.setSession(e),n=e,window.xrSessionStarted=!0}function t(){n.removeEventListener("end",t),P.textContent="ENTER VR",n=null}var n;e?(n=null,P.style.display="",P.style.cursor="pointer",P.style.left="calc(50% - 50px)",P.style.width="100px",P.style.height="auto",P.textContent="ENTER VR",P.onmouseenter=function(){P.style.opacity="1.0"},P.onmouseleave=function(){P.style.opacity="0.5"},P.onclick=function(){if(null===n){window.AudioContext=window.AudioContext||window.webkitAudioContext;var t=new AudioContext;{var i=t.createOscillator();let e=50*Math.random();i.frequency.value=150+50*Math.random(),i.start(0),i.connect(t.destination),setInterval(()=>{e=50*Math.random(),i.frequency.value=.5<Math.random()?150+e:20},500),setInterval(()=>{i.frequency.value=.5<Math.random()?500+e:20},1e3)}navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","bounded-floor"]}).then(s)}else n.end()}):(P.style.display="",P.style.cursor="auto",P.style.left="calc(50% - 75px)",P.style.width="150px",P.onmouseenter=null,P.onmouseleave=null,P.onclick=null,P.textContent="VR NOT SUPPORTED")}),P):(V=document.createElement("a"),!1===window.isSecureContext?(V.href=document.location.href.replace(/^http:/,"https:"),V.innerHTML="WEBXR NEEDS HTTPS"):(V.href="https://immersiveweb.dev/",V.innerHTML="WEBXR NOT AVAILABLE"),V.style.left="calc(50% - 90px)",V.style.width="180px",V.style.textDecoration="none",$(V),V))),window.addEventListener("resize",function(){o.aspect=window.innerWidth/window.innerHeight,o.updateProjectionMatrix(),n.setSize(window.innerWidth,window.innerHeight)},!1),"undefined"!=typeof TESTING)for(var J=0;J<200;J++)e();function $(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="rgba(0,0,0,0.1)",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}var X,P,V;n.setAnimationLoop(e),e()</script>