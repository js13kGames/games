<!doctype html><meta name=viewport content="width=device-width,user-scalable=no"><meta name=theme-color content=#000><title>Super Castle Game - js13kGames 2023</title><style>*{touch-action:none;-webkit-user-drag:none}body,html{overscroll-behavior:none;-webkit-user-select:none;user-select:none}html{background:#000}canvas{display:block;-webkit-tap-highlight-color:transparent}#a{left:0;position:absolute;top:0;transform-origin:0 0}#a,#c{height:540px;width:960px}#c{left:0;position:absolute;top:0}</style><div id=a><canvas id=c draggable=false></canvas></div><script>{function d(e,t,i){return e*(1-i)+t*i}function h(e){return e*(2-e)}function f(e){return e<.5?2*e*e:2*e*(2-e)-1}function G(i,s,e,a,n){a=BigInt(a);for(let t=0;t<e;++t)for(let e=0;e<s;++e)n(e,t,Number(i%a)),i/=a}class S{constructor(e=0,t=0){this.x=e,this.y=t}set(e,t){return this.x=e,this.y=t,this}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}length(){return Math.hypot(this.x,this.y)}distanceSquared(e){return(this.x-e.x)**2+(this.y-e.y)**2}}const m=new S,T=new S;class _ extends S{constructor(e,t,i){super(t,i),this.type=e,this.oldPosition=new S(t,i)}}class P{constructor(e){(this.pieces=e).forEach(e=>e.cluster=this)}}class ee{constructor(e,t){this.width=e,this.height=t,this.pieces={},this.positions=Array.from({length:t},()=>Array.from({length:e},()=>[]))}createPiece(e,t,i){var s=new _(e,t,i);return(this.pieces[e]??=[]).push(s),this.positions[i][t].push(s),s}discardPiece(e){let t=this.pieces[e.type];t.splice(t.indexOf(e),1),(t=this.positions[e.y][e.x]).splice(t.indexOf(e),1)}putPiece(e,t,i){var s=this.positions[e.y][e.x];s.splice(s.indexOf(e),1),this.positions[i][t].push(e.set(t,i))}getBorderingPieces(t,e){return this.pieces[e]?.filter(e=>1===e.distanceSquared(t))}getGroup(e){const t=new Set([e]),i=[e];for(;i.length;){const e=i.pop();this.getBorderingPieces(e,e.type).forEach(e=>{t.has(e)||(t.add(e),i.push(e))})}return t}buildClusters(e){const t=new Set(this.pieces[e]);for(const e of t)new P([...this.getGroup(e)]).pieces.forEach(e=>t.delete(e))}load(e){G(e,this.width,this.height,7,(e,t,i)=>{1!==i&&(0!==i&&--i,this.createPiece(i,e,t))})}}function u(e){return 440*2**((e-69)/12)}const E=4294967295;class te{constructor(e,t,i){this.channels=e,this.sampleRate=t,this.prng=i}generateReverb(t,e,i,s,a=0,n=-60){var o,r=Math.round(s*this.sampleRate),l=Math.round(a*this.sampleRate),c=(10**(n/10))**(1/(r-1)),d=1/(l-1);for(const t of function(t){var i=[];for(let e=0;e<t.numberOfChannels;++e)i[e]=t.getChannelData(e);return i}(a=new AudioBuffer({length:r,numberOfChannels:this.channels,sampleRate:this.sampleRate}))){for(let e=0;e<r;++e)t[e]=(2*this.prng.randomUint32()-E)/E*c**e;for(let e=0;e<l;++e)t[e]*=d*e}o=t,n=a,t=e,a=i,e=s,i=new OfflineAudioContext(n.numberOfChannels,n.length,n.sampleRate),(t=new BiquadFilterNode(i,{type:"lowpass",Q:1e-4,frequency:t})).connect(i.destination),t.frequency.exponentialRampToValueAtTime(a,e),(a=new AudioBufferSourceNode(i,{buffer:n})).connect(t),a.start(),i.oncomplete=e=>{o(e.renderedBuffer)},i.startRendering()}}const L=[[64,0,.5,40,0,.25,67,.04,.5,71,.08,.5,76,.12,.5,47,.25,.5,71,.5,1.25,52,.5,.75,55,.75,1],[59,0,.25,76,.25,.5,55,.25,.5,78,.5,.75,52,.5,.75,79,.75,1,47,.75,1],[69,0,.5,45,0,.25,72,.04,.5,76,.08,.5,81,.12,.5,52,.25,.5,76,.5,1.25,57,.5,.75,60,.75,1],[64,0,.25,81,.25,.5,60,.25,.5,83,.5,.75,57,.5,.75,86,.75,1,52,.75,1],[69,0,.75,50,0,.25,74,.04,.75,78,.08,.75,81,.12,.75,57,.25,.5,62,.5,.75,79,.75,1,66,.75,1],[78,0,.25,69,0,.25,79,.25,.375,66,.25,.5,78,.375,.625,62,.5,.75,74,.625,1,57,.75,1],[59,0,1,35,0,.25,63,.04,1,66,.08,1,71,.12,1,42,.25,.5,47,.5,.75,51,.75,1],[63,0,1,54,0,.25,66,.04,1,71,.08,1,75,.12,1,51,.25,.5,47,.5,.75,42,.75,1],0,1,2,3,4,5,[64,0,2,40,0,.25,67,.04,2,71,.08,2,76,.12,2,47,.25,.5,52,.5,.75,55,.75,1],[64,0,.25,59,.25,.5,55,.5,.75,52,.75,1],[64,0,.125,40,0,.25,71,.125,.25,69,.25,.375,47,.25,.5,71,.375,.5,74,.5,.625,52,.5,.75,71,.625,.75,69,.75,.875,55,.75,1,71,.875,1],[64,0,.125,59,0,.25,71,.125,.25,69,.25,.375,55,.25,.5,71,.375,.5,74,.5,.625,52,.5,.75,71,.625,.75,69,.75,.875,47,.75,1,71,.875,1],[66,0,.125,36,0,.25,67,.125,.25,66,.25,.375,43,.25,.5,67,.375,.5,71,.5,.625,48,.5,.75,67,.625,.75,66,.75,.875,52,.75,1,67,.875,1],[66,0,.125,55,0,.25,67,.125,.25,66,.25,.375,52,.25,.5,67,.375,.5,71,.5,.625,48,.5,.75,67,.625,.75,66,.75,.875,43,.75,1,67,.875,1],[62,0,.125,38,0,.25,69,.125,.25,67,.25,.375,45,.25,.5,69,.375,.5,74,.5,.625,50,.5,.75,69,.625,.75,67,.75,.875,54,.75,1,69,.875,1],[62,0,.125,57,0,.25,69,.125,.25,67,.25,.375,54,.25,.5,69,.375,.5,74,.5,.625,50,.5,.75,69,.625,.75,67,.75,.875,45,.75,1,69,.875,1],[63,0,.125,35,0,.25,71,.125,.25,69,.25,.375,42,.25,.5,71,.375,.5,75,.5,.625,47,.5,.75,71,.625,.75,69,.75,.875,51,.75,1,71,.875,1],[63,0,.125,54,0,.25,71,.125,.25,69,.25,.375,51,.25,.5,71,.375,.5,75,.5,.625,47,.5,.75,71,.625,.75,69,.75,.875,42,.75,1,71,.875,1],16,17,18,19,20,21,22,[63,0,.125,47,0,.25,71,.125,.25,69,.25,.375,51,.25,.5,71,.375,.5,75,.5,.625,54,.5,.75,71,.625,.75,75,.75,.875,59,.75,1,78,.875,1],[64,0,.5,40,0,.125,67,.04,.5,71,.08,.5,76,.12,.5,47,.125,.25,52,.25,.375,55,.375,.5,71,.5,1.25,67,.5,1.25,59,.5,.625,55,.625,.75,52,.75,.875,47,.875,1],[40,0,.125,52,.125,.25,76,.25,.5,71,.25,.5,55,.25,.375,59,.375,.5,78,.5,.75,71,.5,.75,64,.5,.625,59,.625,.75,79,.75,1,71,.75,1,55,.75,.875,52,.875,1],[69,0,.5,45,0,.125,72,.04,.5,76,.08,.5,81,.12,.5,52,.125,.25,57,.25,.375,60,.375,.5,76,.5,1.25,72,.5,1.25,64,.5,.625,60,.625,.75,57,.75,.875,52,.875,1],[45,0,.125,57,.125,.25,81,.25,.5,76,.25,.5,60,.25,.375,64,.375,.5,83,.5,.75,76,.5,.75,69,.5,.625,64,.625,.75,86,.75,1,78,.75,1,60,.75,.875,57,.875,1],[69,0,.75,50,0,.125,74,.04,.75,78,.08,.75,81,.12,.75,54,.125,.25,57,.25,.375,62,.375,.5,66,.5,.625,62,.625,.75,79,.75,1,57,.75,.875,50,.875,1],[78,0,.25,74,0,.25,38,0,.125,45,.125,.25,79,.25,.375,50,.25,.375,78,.375,.625,54,.375,.5,57,.5,.625,74,.625,1,54,.625,.75,50,.75,.875,45,.875,1],[59,0,1,35,0,.125,63,.04,1,66,.08,1,71,.12,1,42,.125,.25,47,.25,.375,51,.375,.5,54,.5,.625,51,.625,.75,47,.75,.875,42,.875,1],[63,0,1,47,0,.125,66,.04,1,71,.08,1,75,.12,1,51,.125,.25,54,.25,.375,59,.375,.5,63,.5,.625,59,.625,.75,54,.75,.875,51,.875,1],32,33,34,35,36,37,[64,0,2,40,0,.125,67,.04,2,71,.08,2,76,.12,2,47,.125,.25,52,.25,.375,55,.375,.5,59,.5,.625,55,.625,.75,52,.75,.875,47,.875,1],[40,0,.125,52,.125,.25,55,.25,.375,59,.375,.5,64,.5,.625,67,.625,.75,71,.75,.875,76,.875,1],[79,0,1,76,0,1,64,0,.125,67,.125,.25,71,.25,.375,67,.375,.5,71,.5,1],[78,0,.5,74,0,.5,62,0,.25,69,.25,.5,81,.5,.75,74,.5,1,86,.75,1],[88,0,2,84,0,2,67,0,1.5,60,0,1.5],[60,.5,.75,67,.75,1],[91,0,1,88,0,1,83,0,1,79,0,.25,76,.25,.5,71,.5,.75,67,.75,1],[81,0,.3125,62,0,1,86,.04,.3125,90,.08,.3125,86,.3125,.625,81,.625,.9375,86,.9375,1.25],[64,.25,2,71,.29,2,76,.33,2,79,.37,2,83,.41,2,88,.45,2]],C=120/70,M=new class{async initialize(e){if(!this.initialized){if(this.con??=new AudioContext,"running"!==this.con.state){try{await this.con.resume()}catch(e){return}if(this.initialized)return}e?.(this.con),this.initialized=1}}},ie=new class{constructor(e){this.state=0|e}randomUint32(){var e=this.state=this.state+1831565813|0,e=Math.imul(e^e>>>15,1|e);return((e^=e+Math.imul(e^e>>>7,61|e))^e>>>14)>>>0}random(){return this.randomUint32()/2**32}}(960);let l,r;const se=a=>t=>{l=new GainNode(t,{gain:.3333});const i=new ConvolverNode(t),e=new GainNode(t,{gain:.5}),s=new GainNode(t,{gain:.3333});l.connect(i),l.connect(e),i.connect(s),e.connect(t.destination),s.connect(t.destination),new te(2,t.sampleRate,ie).generateReverb(e=>{i.buffer=e,a?(r=t.currentTime+.05,K(),setInterval(K,999)):b(0)},16e3,1e3,2*C,1e-5,-90)};function W(e){l&&(l.gain.value=e?0:.3333)}let a=-1;function K(){let o=M.con.currentTime-r+4,e=(a+1)*C;if(!(e>o))for(o+=4;e<o;){const o=++a;var t=(e,t,i)=>{var s,a,n;t+=o,i+=o,t*=C,i*=C,s=e=new OscillatorNode(M.con,{type:"square",frequency:u(e)}),a=t,(n=new GainNode(M.con,{gain:.5})).gain.setValueAtTime(.5,r+a),n.gain.exponentialRampToValueAtTime(1e-5,r+a+2*C),s.connect(n),n.connect(l),e.start(r+t),e.stop(r+i)},i=o%57;if(!(54<i)){var s=L[i].push?L[i]:L[L[i]];for(let e=0;e<s.length;e+=3)t(s[e],s[e+1],s[e+2])}e+=C}}function b(e){if(l)switch(e){case 0:t(91,0,.04);break;case 1:t(76,0,.05),t(79,.05,.05),t(83,.1,.1);break;case 2:t(83,0,.05),t(79,.05,.05),t(76,.1,.1);break;case 3:t(74,0,.05),t(76,.05,.05),t(79,.1,.05),t(83,.15,.05),t(86,.2,.05),t(88,.25,.1)}}function t(e,t,i){t+=M.con.currentTime,(e=new OscillatorNode(M.con,{type:"square",frequency:u(e)})).connect(l),e.start(t),e.stop(t+i)}const ae=[35,36,38,39,40,42,43,45],z=[,"0a05773e0b74b0371f02a6eb5dea9e6","07057ffaad6f2661fea04ea","0805ab78ef52943bf9d44806c","0c05291e93482750939b387a1cf227159cfb5","070812c8d3595b377e96ef4aaaf849f7c7ac2a","0b054c3346f46f60b6eb689cf5911db8c7","09052c0a0c3a11e2df55b5b4a46d1","0a0a9a3d348ebb91b3fdd5392989e6e48280b767f7abd16628394fd76dca5f3a5f","0a088b588dbd8b8d12a6b6cf115e3616491f022796b1c5531ed9","0b0626c342fa69752fe1444f1eb4a23e4f81ad9c","0d08146eed2200f8076ba28e6790f3a49381687d319acf2d2c396dd39189a032","0e0755f2fd57b0666d3b250d1085faf6786f89fe1236509251103d1eec583b","0a09820ef83d1bfe8c558601a28a2edb322fbc288148a11ba997cf0","0c0d74b4615140b03be5ac9dc1e9ceca9f2e47a7408c85a25d406180ce4f33969ef77152c649f51ecf2f7146a986bceb938b45d4","0c0bb3cb3b721d397d7bb165728c74eb52e34eaace95545b2eccf34ff567bd7852b3e4dc45f3d2b07ed3bbc","120d48f5340829c0054829f082c37235cf198a27499414652d486f7667a38fe5180101bbf4c5295abe775669b1b0d0bbcff235c3588d8bd242522ad99cb5b95a06e1dc254739d9f8b73a582a4c","110c1b657fe7d222eb4ae2a9873b36084d7e192d41c422acd2df1cce8a24ee15c983a4fe25d297b60a8cfa4b697255004e436d2398ef23ca5e1d303c871c4f71a539ef","2210bb93abd355457213a83d4c3ccd6ecc6e9edc0f417c14e83fc99b589799e7f6a63b7bc350856c052eb27687ec04acb0d316cb09e9ebfbf9fce826e581013886de146c8a2bc3da08adb1012b698f23a2028d938e73732382eef6053b82f4c22265bb97c2985b27a8681686f76f01244ab0ea7aad7660c1ccc686b33c0203a9f303201f298a93c4ae25709da98e984cf38788e4e2e85697dffa5c53611b18aef86d00443542c8e0c6c63fb0de1ba18a66e0fd32","0f09b3cd90ef3c126095fe29bd6f411d6bfa0433c5c188d98e721e934991fd4fab1dbdaf66c7c3a36c279cd"];function p(e,t,i=0){e.phase=t,e.phaseTtl=(e.oldTtl=i)-1}function U(e,t){if(e.oldTtl=e.phaseTtl,0<e.phaseTtl)--e.phaseTtl;else{var i,s=e.phase<<1,a=t[s];if(a)return i=e.phase,p(e,a,t[1|s]),i}}function v(e,t,i){return 1-d(e.oldTtl,e.phaseTtl,i)/t}const ne=0x7c6667c0c67ad604e6e9cc1bffeb1011d39cc0e9ce730318c6780fe38fe04df39be0e9ce6e00df39bc0e9ce6e04f7fbcc11afffb07c6318c1359d7303b78c7c1e6319e04e7f9cc1e9ec7e00c6f1fc1f1bc7f03e739bc0e98e6e03e6f9bc13fce6en,oe={AoL:1,AoU:2,AoR:3,AoD:4,KA:5,KW:6,KD:7,KS:8,KR:9,Sc:10},re=new class{constructor(e,t,i,s=2,a){e??=document.createElement("canvas"),this.canvas=e,this.con=e.getContext("2d"),this.height=i,this.width=t,e.height=s*i,e.width=s*t,this.con.scale(s,s),a?.(this.con,t,i)}}(document.querySelector("#c"),960,540),k=re.con,le=(k.lineWidth=1.5,new class{constructor(e,t,i){this.updateWrapper=()=>{let e=visualViewport.width,t=visualViewport.height,i=this.width/this.height,s=visualViewport.offsetLeft,a=visualViewport.offsetTop;i<e/t?(this.scale=t/this.height,s+=.5*(e-this.scale*this.width)):(this.scale=e/this.width,a+=.5*(t-this.scale*this.height)),this.wrapper.style.transform=`translate(${s}px, ${a}px) scale(${this.scale})`},this.wrapper=e,this.width=t,this.height=i,this.scale=1}addEventListeners(){if(!visualViewport)return 1;addEventListener("resize",this.updateWrapper),visualViewport.addEventListener("resize",this.updateWrapper),visualViewport.addEventListener("scroll",this.updateWrapper),this.updateWrapper()}documentToViewport(e){e.x/=this.scale,e.y/=this.scale}}(document.querySelector("#a"),960,540)),O=(le.addEventListeners(),new class{constructor(){this.state=[]}setState(e,t){var i;t&&(e.altKey||e.ctrlKey||e.metaKey)||(i=oe[((i=e.code)[0]??"")+(i[3]??"")+(i[5]??"")])&&(e.repeat||(this.state[i]=t),e.preventDefault())}addEventListeners(e){e.addEventListener("keydown",e=>this.setState(e,1)),e.addEventListener("keyup",e=>this.setState(e))}}),R=(O.addEventListeners(document),new class extends class{constructor(e){this.x=this.y=0,this.plane=e}setPosition(e){var t=this.plane.getBoundingClientRect();this.x=e.clientX-t.left,this.y=e.clientY-t.top}addEventListeners(e){e.addEventListener("mousedown",e=>{e.preventDefault(),this.held=1,this.setPosition(e)}),e.addEventListener("mousemove",e=>{e.preventDefault(),this.setPosition(e)}),e.addEventListener("mouseup",e=>{e.preventDefault(),this.held=0}),e.addEventListener("mouseleave",e=>{this.held=0}),e.addEventListener("touchstart",e=>{e.preventDefault(),this.held=1,this.setPosition(e.targetTouches[0])}),e.addEventListener("touchmove",e=>{e.preventDefault(),this.setPosition(e.targetTouches[0])}),e.addEventListener("touchend",e=>{e.preventDefault(),this.held=0}),e.addEventListener("touchcancel",e=>{this.held=0})}}{setPosition(e){super.setPosition(e),le.documentToViewport(this)}}(re.canvas));function y(e){return e<.5?2*e:2-2*e}function F(e){return e-Math.floor(e)}function e(e){return(e/=255)<=.0404482362771082?e/12.92:Math.pow((e+.055)/1.055,2.4)}function i(e){return Math.floor(255*(e<=.00313066844250063?12.92*e:1.055*Math.pow(e,1/2.4)-.055)).toString(16)}R.addEventListeners(document),document.addEventListener("contextmenu",e=>{e.preventDefault()});const ce=e(255),de=e(205),he=e(117),fe=e(239),ue=e(125),be=e(87),pe=e(167),ve=e(240),ye=e(112),ge=e(56),xe=e(183),we=e(100);function n(a,n,o,r,t=0,i=0){a-=.5*o*(6*r.length-1),n-=.5*o*6;for(let s=0,e=0;e<r.length;++e){var l=r.charCodeAt(e)-65;if(0<=l){const r=t?t*o*f(y(F(i+.1*e))):0;G(ne>>BigInt(5*l*6),5,6,2n,(e,t,i)=>i&&k.rect(a+s+o*e,n+r+o*t,o,o))}s+=6*o}}const Se=new Set([0]),me=new Set([2,4]),Te=[1,96,,,,,2,,2,,6,64,2,,],A={phase:0,phaseTtl:0,oldTtl:0,levelIndex:1,clear:{}},Pe=[1,64,1,64],Ee={phase:0,phaseTtl:0,oldTtl:0};try{var s,H;localStorage.superCastleIndex&&localStorage.superCastleClear&&(s=+localStorage.superCastleIndex,H=JSON.parse(localStorage.superCastleClear),s)&&s<z.length&&z[s]&&1===H[1]&&(A.levelIndex=s,Object.assign(A.clear,H))}catch(e){}class I{constructor(e,t,i){this.board=new ee(e,t),this.external=i,this.active=new Set,this.t=new Set,this.i=new Set,this.cellSize=Math.min(960/e,540/t),this.boardLeft=.5*(960-e*this.cellSize),this.boardTop=.5*(540-t*this.cellSize)}tryMove(e,t,i){var s,a,n,o=function e(t,i,s,a,n){const o=i.x+s,r=i.y+a;if(!(o<0||r<0||o>=t.width||r>=t.height||t.positions[r][o].some(e=>Se.has(e.type)&&(!e.cluster||e.cluster!==i.cluster)))){var l=(i.cluster&&i.cluster!==n?.cluster?i.cluster.pieces.filter(e=>e!==i):[]).concat(t.positions[r][o].filter(e=>me.has(e.type)&&(!e.cluster||e.cluster!==i.cluster))),c=[[i,s,a]];for(const n of l){const o=e(t,n,s,a,i);if(!o)return;c.push(...o)}const d=new Set;return c.filter(([e,,])=>d.has(e)?0:d.add(e))}}(this.board,e,t,i);if(!o)return 1;let r=0;for([e,t,i]of o)this.board.putPiece(e,e.x+t,e.y+i),this.board.positions[e.y][e.x].some(e=>5===e.type)&&(r=e.killed=1),this.active.add(e);if(!this.board.pieces[1]?.filter(e=>!e.killed).length){for([e,t,i]of o)this.board.putPiece(e,e.x-t,e.y-i),e.killed=0,this.active.delete(e);return 1}r&&b(2),this.o(this.i),p(A,3,10),l&&(s=(o=M.con).currentTime,a=u(ae[function(e,t){for(var i=E-E%t;;){var s=e.randomUint32();if(s<i)return s%t}}(ie,ae.length)]),n=new OscillatorNode(o,{type:"square",frequency:a}),o=new GainNode(o),n.connect(o),o.connect(l),n.frequency.setValueAtTime(a,s),o.gain.setValueAtTime(1,s),n.frequency.exponentialRampToValueAtTime(.5*a,s+.2),o.gain.exponentialRampToValueAtTime(1e-5,s+.2),n.start(s),n.stop(s+.2))}discardPiece(e){this.board.discardPiece(e),1===e.type&&(this.t.delete(e),this.i.delete(e))}o(t){this.board.pieces[1]?.forEach(e=>{this.board.positions[e.y][e.x].some(e=>3===e.type)?t.add(e):t.delete(e)})}connectDucklings(e){const t=new Set;e.forEach(e=>{this.board.getBorderingPieces(e,2)?.forEach(e=>{t.add(e.cluster)})}),t.size&&(t.forEach(e=>{e.pieces.forEach(e=>{this.discardPiece(e),e=this.board.createPiece(1,e.x,e.y),this.active.add(e)})}),new P(this.board.pieces[1]),this.o(this.i),p(A,4,20),b(1))}splitCluster(e){const t=e.pieces[0].type,i=new Set(e.pieces.filter(e=>!e.killed)),s=[];for(const e of i){const t=[...this.board.getGroup(e)].filter(e=>i.has(e));t.length&&(t.forEach(e=>i.delete(e)),s.push(new P(t)))}if(1===t&&1<s.length){s.sort((e,t)=>t.pieces.length-e.pieces.length);for(let e=1;e<s.length;++e){const t=[];s[e].pieces.forEach(e=>{e.killed=1,this.discardPiece(e),e=this.board.createPiece(2,e.x,e.y),this.active.add(e),t.push(e)}),new P(t)}p(A,4,20)}}checkWin(){var e=this.board.pieces[1]?.length;if(e===this.board.pieces[3]?.length&&e===this.t.size&&e===this.i.size)return A.clear[A.levelIndex]=1,p(A,5,64),b(3),1}render(e,s){const a=3===A.phase?f(v(A,10,e)):4===A.phase?f(v(A,20,e)):0,n=["#ffcd75","#"+i(d(pe,ce,a))+i(d(ve,de,a))+i(d(ye,he,a)),"#"+i(d(ce,pe,a))+i(d(de,ve,a))+i(d(he,ye,a)),"#a7f070"],o=["#ef7d57","#"+i(d(ge,fe,a))+i(d(xe,ue,a))+i(d(we,be,a)),"#"+i(d(fe,ge,a))+i(d(ue,xe,a))+i(d(be,we,a)),"#38b764"];k.fillStyle="#1a1c2c",k.fillRect(this.boardLeft,this.boardTop,this.board.width*this.cellSize,this.board.height*this.cellSize),k.beginPath();var t=Math.max(this.board.width,this.board.height);for(let e=1;e<t;++e)e<this.board.width&&(k.moveTo(this.boardLeft+e*this.cellSize,this.boardTop),k.lineTo(this.boardLeft+e*this.cellSize,this.boardTop+this.board.height*this.cellSize)),e<this.board.height&&(k.moveTo(this.boardLeft,this.boardTop+e*this.cellSize),k.lineTo(this.boardLeft+this.board.width*this.cellSize,this.boardTop+e*this.cellSize));k.strokeStyle="#333c57",k.stroke(),this.outline&&(k.strokeStyle="#41a6f6",k.stroke(this.outline)),this.board.pieces[3]?.forEach(e=>this.renderPiece(e,e.x,e.y,a,0,n,o)),this.levelText();for(let i=0;i<this.board.height;++i)for(let t=0;t<this.board.width;++t){const r=F(s+.1*(t-.85*i));this.board.positions[i][t].forEach(e=>3!==e.type&&this.renderPiece(e,t,i,a,r,n,o))}}levelText(){}renderPiece(t,i,s,e,a,n,o){3===A.phase&&this.active.has(t)&&(i+=d(t.oldPosition.x-t.x,0,e),s+=d(t.oldPosition.y-t.y,0,e));let r=this.cellSize;if(i=i*r+this.boardLeft,s=s*r+this.boardTop,0===t.type)k.fillStyle="#000",k.fillRect(i,s,r,r),s+=(.1*f(y(a))-.05)*r,k.beginPath(),k.moveTo(i+.2*r,s+.2*r),k.lineTo(i+.8*r,s+.8*r),k.moveTo(i+.2*r,s+.8*r),k.lineTo(i+.8*r,s+.2*r),k.strokeStyle="#566c86",k.stroke();else if(3===t.type){const t=r/3;k.beginPath();for(let e=0;e<3;++e){const a=t*(e+.5);k.moveTo(i,s+a),k.lineTo(i+a,s),k.moveTo(i+r,s+r-a),k.lineTo(i+r-a,s+r)}k.strokeStyle="#a7f070",k.stroke()}else{if(i-=.25,s-=.25,r+=.5,t.killed){const t=.5*(this.cellSize-(r=d(r,0,e)));i+=t,s+=t}var l=.4*r;switch(t.type){case 1:const d=(this.t.has(t)?1:0)+(this.i.has(t)?2:0);g(i,s,r,l,n[d],o[d],0,20),3==d?(k.beginPath(),k.moveTo(i+.2*r,s-l+.5*r),k.lineTo(i+.4*r,s-l+.7*r),k.lineTo(i+.8*r,s-l+.3*r),k.strokeStyle="#38b764",k.stroke()):0==d&&this.t.size&&this.i.size&&(k.beginPath(),k.moveTo(i+.2*r,s-l+.2*r),k.lineTo(i+.8*r,s-l+.8*r),k.moveTo(i+.2*r,s-l+.8*r),k.lineTo(i+.8*r,s-l+.2*r),k.strokeStyle="#ef7d57",k.stroke()),4===A.phase&&this.active.has(t)&&g(i,s,r,l,"#94b0c2","#566c86",r*e);break;case 2:g(i,s,r,l,"#94b0c2","#566c86",0,20),4===A.phase&&this.active.has(t)&&g(i,s,r,l,"#ffcd75","#ef7d57",r*e);break;case 4:g(i,s,r,l,"#41a6f6","#3b5dc9",0,20),k.beginPath(),k.arc(i+.5*r,s-l+.5*r,.3*r,0,2*Math.PI),k.strokeStyle="#3b5dc9",k.stroke();break;case 5:const f=(.9*h(y(a))+.1)*l;k.beginPath(),k.lineTo(i+.8*r,s+.5*r),k.arc(i+.5*r,s+f+.5*r,.3*r,0,Math.PI),k.lineTo(i+.2*r,s+.5*r),k.fillStyle="#c4243020",k.fill(),k.beginPath(),k.lineTo(i+.8*r,s-f+.5*r),k.arc(i+.5*r,s+.5*r,.3*r,0,Math.PI),k.lineTo(i+.2*r,s-f+.5*r),k.fillStyle="#c42430",k.fill(),k.beginPath(),k.arc(i+.5*r,s-f+.5*r,.3*r,0,2*Math.PI),k.fillStyle="#f5555d",k.fill()}}}}function g(e,t,i,s,a,n,o,r){r&&(k.fillStyle=n+r,k.fillRect(e,t+i-.25,i,s+.25)),k.fillStyle=n,k.fillRect(e+o,t-s+i-.25,i-o,s+.25),k.fillStyle=a,k.fillRect(e+o,t-s,i-o,i)}class Le extends I{render(e,t){super.render(e,t),k.save(),k.shadowColor="#000",k.shadowOffsetX=k.shadowOffsetY=3,k.beginPath(),n(480,this.boardTop+4.5*this.cellSize,4,"ARROWS TO MOVE OR TAP ON SCREEN",1,t),k.fillStyle="#ffcd75",k.fill(),k.restore()}}class Ce extends I{checkWin(){let t,{x:e,y:i}=this.board.pieces[1][0];if(this.board.positions[i][e].some(e=>3===e.type&&(t=e)))return A.levelIndex=.5*(t.y-2)*6+.5*(t.x-2)-1,p(A,5,64),b(3),1}render(e,t){super.render(e,t),k.save(),k.shadowColor="#000",k.shadowOffsetX=k.shadowOffsetY=3,k.beginPath(),n(480,this.boardTop+8.5*this.cellSize,4,"CLICK HERE FOR MORE LEVELS",1,t),k.fillStyle="#73eff7",k.fill(),k.restore()}levelText(){k.save(),k.shadowColor="#000",k.shadowOffsetX=k.shadowOffsetY=3,k.beginPath();for(let e=1;e<z.length-2;++e)A.clear[e]||n(this.boardLeft+(e%6*2+2)*this.cellSize,this.boardTop+(2*Math.floor(e/6)+2.5)*this.cellSize+3,6,String.fromCharCode(64+e),0,0);k.fillStyle="#f4f4f4",k.fill(),k.beginPath();for(let e=1;e<z.length-2;++e)A.clear[e]&&n(this.boardLeft+(e%6*2+2)*this.cellSize,this.boardTop+(2*Math.floor(e/6)+2.5)*this.cellSize+3,6,String.fromCharCode(64+e),0,0);k.fillStyle="#a7f070",k.fill(),k.restore()}}function o(e,t){const i=parseInt(e.slice(0,2),16),s=parseInt(e.slice(2,4),16),a=BigInt("0x"+e.slice(4)),n=new(t?I:1===A.levelIndex?Le:A.levelIndex===z.length-1?Ce:I)(i,s,t);n.board.load(a),[1,2,4].forEach(e=>n.board.buildClusters(e));try{n.outline=function({board:s,cellSize:a,boardLeft:n,boardTop:o}){const r=Array.from({length:s.height+1},(e,i)=>Array.from({length:s.width+1},(e,t)=>({edges:[],value:s.positions[i]?.[t]?.every(e=>0!==e.type)}))),l=new Set,c=new Set,d=new Path2D;for(let t=0;t<s.height;++t)for(let e=0;e<s.width;++e)if(r[t][e].value){const s=0<e&&r[t][e-1].value?null:new V(e,t+1,e,t),o=0<t&&r[t-1][e].value?null:new V(e,t,e+1,t),d=r[t][e+1].value?null:new V(e+1,t,e+1,t+1),i=r[t+1][e].value?null:new V(e+1,t+1,e,t+1);s&&o&&(s.next=o,c.add(o)),o&&d&&(o.next=d,c.add(d)),d&&i&&(d.next=i,c.add(i)),i&&s&&(i.next=s,c.add(s)),s&&(r[s.start.y][s.start.x].edges.push(s),l.add(s)),o&&(r[o.start.y][o.start.x].edges.push(o),l.add(o)),d&&(r[d.start.y][d.start.x].edges.push(d),l.add(d)),i&&(r[i.start.y][i.start.x].edges.push(i),l.add(i))}function i(e){var t=e.start;for(d.moveTo(e.start.x*a+n,e.start.y*a+o);;){l.delete(e),c.delete(e);var i=r[e.start.y][e.start.x].edges;for(i.splice(i.indexOf(e),1);!e.next&&1===r[e.end.y][e.end.x].edges.length;){const a=r[e.end.y][e.end.x].edges[0];if(a.dir.x!==e.dir.x||a.dir.y!==e.dir.y)break;e.end.copy(a.end),e.next=a.next,l.delete(a),c.delete(a);const n=r[a.start.y][a.start.x].edges;n.splice(n.indexOf(a),1)}if(e.end.x===t.x&&e.end.y===t.y){d.closePath();break}if(d.lineTo(e.end.x*a+n,e.end.y*a+o),e.next)e=e.next;else{if(1!==r[e.end.y][e.end.x].edges.length)throw Error("Logic error");e=r[e.end.y][e.end.x].edges[0]}}}for(var e of c)i(e);for(const s of l)i(s);return d}(n)}catch(e){}return n}class V{constructor(e,t,i,s){this.start=new S(e,t),this.end=new S(i,s),this.dir=new S(i-e,s-t),this.next=null}}const Me=m,ze=new Path2D("M20.18 23.93l18.55-6.67v11.08a7.65 7.65 0 0 0-3.82-1c-3.92 0-7.09 2.85-7.09 6.37 0 3.52 3.17 6.37 7.09 6.37 3.92 0 7.09-2.85 7.09-6.37V14.98c0-2.24 0-4.12-0.18-5.61a13.45 13.45 0 0 0-0.08-0.62c-0.17-1.02-0.47-1.98-1.05-2.77a4.49 4.49 0 0 0-1.35-1.24l-0.02-0.01c-1.54-0.92-3.28-0.86-5.06-0.44-1.73 0.4-3.87 1.2-6.5 2.19l-4.57 1.71c-1.23 0.46-2.27 0.85-3.09 1.26-0.87 0.43-1.62 0.94-2.19 1.71-0.56 0.76-0.8 1.58-0.9 2.46-0.1 0.84-0.1 1.85-0.1 3.05v15.59a7.65 7.65 0 0 0-3.82-1C9.17 31.26 6 34.11 6 37.63 6 41.15 9.17 44 13.09 44c3.92 0 7.09-2.85 7.09-6.37v-13.7Z"),ke=new Path2D("M6.93 6.93C4 9.86 4 14.57 4 24c0 9.43 0 14.14 2.93 17.07C9.86 44 14.57 44 24 44c9.43 0 14.14 0 17.07-2.93C44 38.14 44 33.43 44 24c0-9.43 0-14.14-2.93-17.07C38.14 4 33.43 4 24 4S9.86 4 6.93 6.93Zm11.59 9.02A1.5 1.5 0 1 0 16.48 13.74L11.98 17.9a1.5 1.5 0 0 0 0 2.2l4.5 4.16a1.5 1.5 0 1 0 2.04-2.21l-1.68-1.55h11.24a5.42 5.42 0 0 1 0 10.85H19a1.5 1.5 0 1 0 0 3h9.08a8.42 8.42 0 0 0 0-16.85h-11.24l1.68-1.55Z"),Oe=new Path2D("M13.74 39c1.86 1 4.09 1 8.54 1h5.28c7.75 0 11.63 0 14.03-2.34C44 35.31 44 31.54 44 24c0-7.54 0-11.31-2.41-13.66C39.18 8 35.31 8 27.56 8h-5.27c-4.45 0-6.68 0-8.54 1-1.86 1-3.04 2.84-5.41 6.52L6.98 17.64C4.99 20.73 4 22.28 4 24c0 1.72 0.99 3.27 2.98 6.36l1.36 2.12c2.36 3.68 3.54 5.51 5.4 6.52Zm8.32-21.06A1.5 1.5 0 0 0 19.94 20.06L23.88 24l-3.94 3.94a1.5 1.5 0 1 0 2.12 2.12L26 26.12l3.94 3.94a1.5 1.5 0 0 0 2.12-2.12L28.12 24l3.94-3.94a1.5 1.5 0 0 0-2.12-2.12L26 21.88l-3.94-3.94Z"),Re=Math.cos(Math.PI/6);function x(e,t,i,s=0){var a=(e-t)*Re+480;e=.5*(e+t)-i+270,0===s?k.lineTo(a,e):k.moveTo(a,e)}const q=[],D=[],N=[],B=[];function X(t){let i,s,a,n,o,r,l,c,d,h,f,u,b=30*t*.47,p=0;for(let e=0;e<B.length;++e){var v=B[e],y=b-(1-t)*e;if(!(y<=0)){k.beginPath();for(let e=p;e<p+v;++e)x((d=q[e])-(u=y),(h=D[e])-u,(f=N[e])+u,1),x(d+u,h-u,f+u),x(d+u,h+u,f+u),x(d-u,h+u,f+u);k.fillStyle="#94b0c2",k.fill(),k.beginPath();for(let e=p;e<p+v;++e)x((o=q[e])+(c=y),(r=D[e])-c,(l=N[e])-c,1),x(o+c,r+c,l-c),x(o+c,r+c,l+c),x(o+c,r-c,l+c);k.fillStyle="#566c86",k.fill(),k.beginPath();for(let e=p;e<p+v;++e)x((i=q[e])+(n=y),(s=D[e])+n,(a=N[e])-n,1),x(i-n,s+n,a-n),x(i-n,s+n,a+n),x(i+n,s+n,a+n);k.fillStyle="#333c57",k.fill(),p+=v}}}let c;var Y,Z=new Set;for(let s=7;s--;)for(let i=7;i--;){let t=0;for(let e=7;e--;)0<s&&s<6&&0<i&&i<6||Math.hypot(s-7,i-3,e-1)<2||2<e&&e<5&&(2===s||4===s)||5<e&&1&s|1&i||(Y=960*(s-i)+(s+i-e-e),Z.has(Y))||(Z.add(Y),q.unshift(30*s),D.unshift(30*i),N.unshift(30*e),++t);t&&B.unshift(t)}try{c=o(location.hash.slice(1),1),A.levelIndex=z.length-2}catch(e){c=o(z[A.levelIndex])}function w(){if(c.external)try{c=o(location.hash.slice(1),1),A.levelIndex=z.length-2}catch(e){c=o(z[A.levelIndex])}else c=o(z[A.levelIndex])}{var[$,J,j=20]=[function(){const e=U(A,Te);switch(A.phase){case 2:if(3===e||4===e){const e=[],t=new Set;for(const i of c.active)i.killed?(c.discardPiece(i),i.cluster&&t.add(i.cluster)):(i.oldPosition.copy(i),1===i.type&&e.push(i));c.active.clear(),t.forEach(e=>{c.splitCluster(e)}),c.o(c.t),c.connectDucklings(e.filter(e=>!e.killed))}2!==A.phase||c.checkWin()||function(){if(O.state[9])return w();const e=O.state[1]||O.state[5],t=O.state[2]||O.state[6],i=O.state[3]||O.state[7],a=O.state[4]||O.state[8];if((e?!i:i)||(t?!a:a)){const n=c.board.pieces[1]??[];if(!n.length)return;const s=(i?1:0)-(e?1:0),o=(a?1:0)-(t?1:0);if(s&&(n.sort((e,t)=>s*(t.x-e.x)),!c.tryMove(n[0],s,0)))return;if(o&&(n.sort((e,t)=>o*(t.y-e.y)),!c.tryMove(n[0],0,o)))return}if(R.held){if(796<=R.x&&R.x<960&&R.y<48){if(!A.pointerHeld){if(A.pointerHeld=1,908<=R.x){if(A.levelIndex!==z.length-1||c.external)return A.levelIndex=z.length-2,p(A,5,64),b(3);w()}else 852<=R.x?w():W(A.audioMuted=!A.audioMuted);b(0)}return}if(A.levelIndex===z.length-1&&R.x>=c.boardLeft+2*c.cellSize&&R.x<960-(c.boardLeft+2*c.cellSize)&&R.y>=c.boardTop+8*c.cellSize)return A.pointerHeld||(A.pointerHeld=1,R.held=0,W(A.audioMuted=1),open("https://github.com/mvasilkov/super2023/tree/master/levels#levels","levels"));const e=c.board.pieces[1]??[];if(!e.length)return;let i,s;m.set((R.x-c.boardLeft)/c.cellSize-.5,(R.y-c.boardTop)/c.cellSize-.5),T.set(e.reduce((e,t)=>e+t.x,0)/e.length,e.reduce((e,t)=>e+t.y,0)/e.length);const a=Math.abs(i=m.x-T.x),n=Math.abs(s=m.y-T.y);if(a<n){if(n<.5)return;s=s<0?-1:1,e.sort((e,t)=>s*(t.y-e.y)),c.tryMove(e[0],0,s)}else{if(a<.5)return;i=i<0?-1:1,e.sort((e,t)=>i*(t.x-e.x)),c.tryMove(e[0],i,0)}}else A.pointerHeld=0;const n=function(){try{for(const e of navigator.getGamepads())if(e)return Me.b=e.buttons[1].pressed,Me.set(e.axes[0]<-.25?-1:.25<e.axes[0]?1:0,e.axes[1]<-.25?-1:.25<e.axes[1]?1:0)}catch(e){}}();if(n){if(n.b)return w();const e=c.board.pieces[1]??[];!e.length||n.x&&(e.sort((e,t)=>n.x*(t.x-e.x)),!c.tryMove(e[0],n.x,0))||n.y&&(e.sort((e,t)=>n.y*(t.y-e.y)),c.tryMove(e[0],0,n.y))}}();break;case 6:5===e&&(c=o(z[++A.levelIndex]),localStorage.superCastleIndex=A.levelIndex,localStorage.superCastleClear=JSON.stringify(A.clear))}U(Ee,Pe)},function(e){var t=v(Ee,64,e);if(k.fillStyle="#000",k.fillRect(0,0,960,540),1===A.phase||(c.render(e,t),k.save(),k.translate(800,0),k.fillStyle=A.audioMuted?"#ffcd7580":"#ffcd75",k.fill(ze),k.translate(56,0),k.fillStyle="#ffcd75",k.fill(ke,"evenodd"),k.translate(56,0),k.fill(Oe,"evenodd"),k.restore(),5===A.phase)){var i=e,s=t,a=v(A,1===A.phase?96:64,i),i=f(a);if(k.fillStyle="#ef7d57",k.fillRect(0,.5*(1-i)*540,960,540*i),X(i),k.beginPath(),n(480,d(-20,135,h(a)),6,"SUPER CASTLE GAME",1.5,s),k.shadowColor="#1a1c2c",k.shadowOffsetX=k.shadowOffsetY=3,k.fillStyle="#ffcd75",k.fill(),1===A.phase){const e=d(630,405,h(a));k.beginPath(),k.rect(60,e-80,300,160),k.rect(600,e-80,300,160),k.fillStyle="#ffcd75",k.fill(),k.beginPath(),n(210,e,6,"START",1,s),n(750,e-27,6,"START",1,s),n(750,e+27,4,"MUSIC OFF",1,s),k.shadowColor="#c42430",k.fillStyle="#f5555d",k.fill()}k.shadowColor="#0000",k.shadowOffsetX=k.shadowOffsetY=0}else 6===A.phase&&(e=f(v(A,64,e)),k.save(),k.beginPath(),k.rect(.5*e*960,0,960*(1-e),540),k.fillStyle="#ef7d57",k.fill(),k.clip(),X(1),k.beginPath(),n(480,135,6,"SUPER CASTLE GAME",1.5,t),k.shadowColor="#000",k.shadowOffsetX=k.shadowOffsetY=3,k.fillStyle="#ffcd75",k.fill(),k.restore())}];let i,s=0;function Q(e){requestAnimationFrame(Q),s+=e-i,i=e;let t=4;for(;0<s;)s-=j,0<=--t&&$(j);J(s/j+1)}requestAnimationFrame(function(e){requestAnimationFrame(Q),i=e})}document.addEventListener("mousedown",()=>{M.initialized||(M.initialize(se(R.x<480)),p(A,6,64))},{once:!0}),document.addEventListener("touchend",()=>{M.initialized||(M.initialize(se(R.x<480)),p(A,6,64))},{once:!0})}</script>