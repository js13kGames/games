<!doctype html><meta name=viewport content="width=device-width"><title>Lost Treasures</title><style>body,html{margin:0;padding:0;overflow:hidden}canvas{position:fixed;width:100%;height:100%}#Text{position:fixed;width:100%;height:100%;margin:0;padding:1em;font:200% monospace;color:#fff;font-weight:700;text-align:center;line-height:200%}#Controls{position:fixed;width:100%;bottom:0;margin:0;padding:1em 0;font:200% sans-serif;color:#fff}#Controls td{text-align:center}.Warning{color:#f22}#Text a{color:#fff}</style><canvas id=Canvas>Sorry, this browser cannot render this content.</canvas><div id=Text></div><table id=Controls><tr><td>←<td>↑<td>↧<td>↓<td>→</table><script id=SeaVertexShader type=x-shader/x-vertex>attribute vec3 vertex;
attribute vec3 normal;
uniform mat4 mvp;
uniform mat4 nm;
uniform vec3 light;
uniform float time;
uniform float radius;
varying mediump float intensity;
varying mediump float z;
void main() {
float vx = mod(radius + vertex.x, radius);
float vy = mod(radius + vertex.y, radius);
float t = sin(time + vx + vy) * .3;
gl_Position = mvp * vec4(vertex.x, vertex.y + t, vertex.z, 1.);
z = gl_Position.z;
intensity = max(0., dot(normalize(mat3(nm) * normal), light));
}</script><script id=VertexShader type=x-shader/x-vertex>attribute vec3 vertex;
attribute vec3 normal;
uniform mat4 mvp;
uniform mat4 nm;
uniform vec3 light;
varying mediump float intensity;
varying mediump float z;
void main() {
gl_Position = mvp * vec4(vertex, 1.);
z = gl_Position.z;
intensity = max(0., dot(normalize(mat3(nm) * normal), light));
}</script><script id=FragmentShader type=x-shader/x-fragment>#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif
uniform float far;
uniform vec4 sky;
uniform vec4 color;
varying mediump float intensity;
varying mediump float z;
void main() {
float f = z / far;
gl_FragColor = vec4(
(1. - f) * color.rgb * (.5 + intensity * .5) + f * sky.rgb,
color.a);
}</script><script>var text,gl,pm,program,seaProgram,seaHalf,sea,floor,player,coins,width,height,now,factor,last,first,pointersLength,M=Math,D=document,W=window,FA=Float32Array,im=new FA([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),vm=new FA(im),cm=new FA(im),nm=new FA(16),mvp=new FA(im),m=new FA(16),far=75,skyColor=[.43,.73,.96,1],lightDirection=[.5,.5,1],entitiesLength=0,entities=[],coinsFound=0,pointersX=[],pointersY=[],keysDown=[];function invert(e,r){var t=r[0],o=r[1],a=r[2],n=r[3],i=r[4],l=r[5],s=r[6],u=r[7],c=r[8],f=r[9],m=r[10],g=r[11],p=r[12],d=r[13],h=r[14],v=r[15],y=t*l-o*i,M=t*s-a*i,w=t*u-n*i,A=o*s-a*l,F=o*u-n*l,x=a*u-n*s,D=c*d-f*p,b=c*h-m*p,P=c*v-g*p,S=f*h-m*d,E=f*v-g*d,T=m*v-g*h,k=y*T-M*E+w*S+A*P-F*b+x*D;if(!k)return null;k=1/k,e[0]=(l*T-s*E+u*S)*k,e[1]=(a*E-o*T-n*S)*k,e[2]=(d*x-h*F+v*A)*k,e[3]=(m*F-f*x-g*A)*k,e[4]=(s*P-i*T-u*b)*k,e[5]=(t*T-a*P+n*b)*k,e[6]=(h*w-p*x-v*M)*k,e[7]=(c*x-m*w+g*M)*k,e[8]=(i*E-l*P+u*D)*k,e[9]=(o*P-t*E-n*D)*k,e[10]=(p*F-d*w+v*y)*k,e[11]=(f*w-c*F-g*y)*k,e[12]=(l*b-i*S-s*D)*k,e[13]=(t*S-o*b+a*D)*k,e[14]=(d*M-p*A-h*y)*k,e[15]=(c*A-f*M+m*y)*k}function multiply(e,r,t){var o=r[0],a=r[1],n=r[2],i=r[3],l=r[4],s=r[5],u=r[6],c=r[7],f=r[8],m=r[9],g=r[10],p=r[11],d=r[12],h=r[13],v=r[14];r=r[15];var y=t[0],M=t[1],w=t[2],A=t[3];e[0]=y*o+M*l+w*f+A*d,e[1]=y*a+M*s+w*m+A*h,e[2]=y*n+M*u+w*g+A*v,e[3]=y*i+M*c+w*p+A*r,y=t[4],M=t[5],w=t[6],A=t[7],e[4]=y*o+M*l+w*f+A*d,e[5]=y*a+M*s+w*m+A*h,e[6]=y*n+M*u+w*g+A*v,e[7]=y*i+M*c+w*p+A*r,y=t[8],M=t[9],w=t[10],A=t[11],e[8]=y*o+M*l+w*f+A*d,e[9]=y*a+M*s+w*m+A*h,e[10]=y*n+M*u+w*g+A*v,e[11]=y*i+M*c+w*p+A*r,y=t[12],M=t[13],w=t[14],A=t[15],e[12]=y*o+M*l+w*f+A*d,e[13]=y*a+M*s+w*m+A*h,e[14]=y*n+M*u+w*g+A*v,e[15]=y*i+M*c+w*p+A*r}function rotate(e,r,t,o,a,n){var i,l,s,u,c,f,m,g,p,d,h,v,y,w,A,F,x,D,b,P,S=M.sqrt(o*o+a*a+n*n);1e-6>M.abs(S)||(o*=S=1/S,a*=S,n*=S,i=M.sin(t),s=1-(l=M.cos(t)),t=r[0],S=r[1],u=r[2],c=r[3],f=r[4],m=r[5],g=r[6],p=r[7],d=r[8],h=r[9],v=r[10],y=r[11],w=o*o*s+l,A=a*o*s+n*i,F=n*o*s-a*i,x=o*a*s-n*i,D=a*a*s+l,b=n*a*s+o*i,P=o*n*s+a*i,o=a*n*s-o*i,n=n*n*s+l,e[0]=t*w+f*A+d*F,e[1]=S*w+m*A+h*F,e[2]=u*w+g*A+v*F,e[3]=c*w+p*A+y*F,e[4]=t*x+f*D+d*b,e[5]=S*x+m*D+h*b,e[6]=u*x+g*D+v*b,e[7]=c*x+p*D+y*b,e[8]=t*P+f*o+d*n,e[9]=S*P+m*o+h*n,e[10]=u*P+g*o+v*n,e[11]=c*P+p*o+y*n,r!==e&&(e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15]))}function scale(e,r,t,o,a){e[0]=r[0]*t,e[1]=r[1]*t,e[2]=r[2]*t,e[3]=r[3]*t,e[4]=r[4]*o,e[5]=r[5]*o,e[6]=r[6]*o,e[7]=r[7]*o,e[8]=r[8]*a,e[9]=r[9]*a,e[10]=r[10]*a,e[11]=r[11]*a,e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15]}function translate(e,r,t,o,a){var n,i,l,s,u,c,f,m,g,p,d,h;r===e?(e[12]=r[0]*t+r[4]*o+r[8]*a+r[12],e[13]=r[1]*t+r[5]*o+r[9]*a+r[13],e[14]=r[2]*t+r[6]*o+r[10]*a+r[14],e[15]=r[3]*t+r[7]*o+r[11]*a+r[15]):(n=r[0],i=r[1],l=r[2],s=r[3],u=r[4],c=r[5],f=r[6],m=r[7],g=r[8],p=r[9],d=r[10],h=r[11],e[0]=n,e[1]=i,e[2]=l,e[3]=s,e[4]=u,e[5]=c,e[6]=f,e[7]=m,e[8]=g,e[9]=p,e[10]=d,e[11]=h,e[12]=n*t+u*o+g*a+r[12],e[13]=i*t+c*o+p*a+r[13],e[14]=l*t+f*o+d*a+r[14],e[15]=s*t+m*o+h*a+r[15])}function transpose(e,r){if(e===r){var t=r[1],o=r[2],a=r[3],n=r[6],i=r[7],l=r[11];e[1]=r[4],e[2]=r[8],e[3]=r[12],e[4]=t,e[6]=r[9],e[7]=r[13],e[8]=o,e[9]=n,e[11]=r[14],e[12]=a,e[13]=i,e[14]=l}else e[0]=r[0],e[1]=r[4],e[2]=r[8],e[3]=r[12],e[4]=r[1],e[5]=r[5],e[6]=r[9],e[7]=r[13],e[8]=r[2],e[9]=r[6],e[10]=r[10],e[11]=r[14],e[12]=r[3],e[13]=r[7],e[14]=r[11],e[15]=r[15]}function dist(e,r,t,o){return(r=e[12]-r)*r+(t=e[13]-t)*t+(e=e[14]-o)*e}function drawModel(e,r,t,o){multiply(mvp,vm,e),multiply(mvp,pm,mvp),invert(nm,e),transpose(nm,nm),gl.uniformMatrix4fv(t.mvp,gl.FALSE,mvp),gl.uniformMatrix4fv(t.nm,gl.FALSE,nm),gl.uniform4fv(t.color,o),gl.drawElements(gl.TRIANGLES,r.count,gl.UNSIGNED_SHORT,0)}function bindModel(e,r){gl.bindBuffer(gl.ARRAY_BUFFER,r.vertices),gl.vertexAttribPointer(e.vertex,3,gl.FLOAT,gl.FALSE,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,r.normals),gl.vertexAttribPointer(e.normal,3,gl.FLOAT,gl.FALSE,0,0),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,r.indicies)}function drawSea(){gl.useProgram(seaProgram);var e=seaProgram.uniforms,r=seaProgram.attribs;gl.uniform3fv(e.light,lightDirection),gl.uniform4fv(e.sky,skyColor),gl.uniform1f(e.far,far),gl.uniform1f(e.time,(now-first)/500),gl.uniform1f(e.radius,seaHalf);var t=sea.model;bindModel(r,t),drawModel(sea.matrix,t,e,sea.color)}function drawPlayer(e,r){0==player.depth?rotate(m,player.matrix,player.tilt+M.sin(player.roll+=.1*factor)*(.05-player.v/(10*player.maxSpeed)),.2,.2,1):translate(m,player.matrix,0,player.depth,0);var t=player.model;bindModel(r,t),drawModel(m,t,e,player.color),0!=player.v&&rotate(m,m,.005*now,0,0,1),bindModel(r,t=player.prop),drawModel(m,t,e,player.color)}function drawFloor(e,r){var t=floor.model,o=floor.matrix;bindModel(r,t),drawModel(o,t,e,floor.color)}function draw(){gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.useProgram(program);var e=program.uniforms,r=program.attribs;gl.uniform3fv(e.light,lightDirection),gl.uniform4fv(e.sky,skyColor),gl.uniform1f(e.far,far),drawFloor(e,r);for(var t,o=(n=player.matrix)[12],a=player.depth,n=n[14],i=entitiesLength;i--;){var l=entities[i];if(!l.found){var s=l.matrix;l.isTreasure&&8>dist(s,o,a,n)?(l.found=!0,++coinsFound==coins?text.innerHTML='You found all coins!<br/><a href="javascript:newGame()">Play again?</a>':text.innerText="Found a coin! "+(coins-coinsFound)+" left ..."):(t!=l.model&&bindModel(r,t=l.model),drawModel(s,t,e,l.color),l.update&&l.update())}}drawPlayer(e,r),drawSea()}function updateView(e){invert(vm,e),translate(m,im,0,6,-30),multiply(vm,m,vm)}function getFloorOffset(e,r){var t=floor.model,o=t.size;return e=(e+floor.radius)/floor.mag|0,r=(r+floor.radius)/floor.mag|0,0>e||e>o||0>r||r>o?-1:(0|M.abs(r*o+e))%t.heightMap.length}function addToFloor(e,r,t){e=getFloorOffset(e,r),floor.model.heightMap[e]+=t}function getFloorHeight(e,r){var t=getFloorOffset(e,r);return 0>t?0:floor.model.heightMap[t]}function alignSea(e,r){var t=sea.matrix,o=sea.mag,a=sea.radius,n=M.round(e/a)*a;a=M.round(r/a)*a;translate(t,im,n,0,a),scale(t,t,o,1,o)}function move(e,r){translate(e,e,0,0,r);var t=floor.radius,o=e[12],a=e[14];o<-t||o>t||a<-t||a>t?text.warning||(text.innerHTML='<span class="Warning">You left the dive area!<span>',text.warning=!0):text.warning&&(text.innerText="",text.warning=!1),alignSea(o,a)}function turn(e,r){rotate(e,e,r,0,1,0),player.tilt+=4*r}function input(){keysDown[82]&&W.location.reload(!0);var e=player.matrix,r=player.maxSpeed,t=player.maxTurn;0!=player.v&&(move(e,-player.v),player.v*=.94,.01>M.abs(player.v)&&(player.v=0)),0!=player.tilt&&(player.tilt*=.75,.01>M.abs(player.tilt)&&(player.tilt=0));var o=!1,a=!1,n=!1,i=!1,l=!1;if(0<pointersLength)for(var s=width/5,u=pointersLength;u--;)switch(pointersX[u]/s|0){case 0:n=!0;break;case 1:o=!0;break;case 2:l=!0;break;case 3:a=!0;break;case 4:i=!0}else o=keysDown[87]||keysDown[38]||keysDown[75],a=keysDown[83]||keysDown[40]||keysDown[74],n=keysDown[65]||keysDown[37]||keysDown[72],i=keysDown[68]||keysDown[39]||keysDown[76],l=keysDown[32];n?turn(e,t):i?turn(e,-t):r*=1.5,a?player.v=-r/2:(o||n||i)&&(player.v=r),l&&getFloorHeight(e[12],e[14])<player.depth-2?player.depth-=.05:(player.depth*=.98,.2>M.abs(player.depth)&&(player.depth=0)),updateView(e)}function run(){requestAnimationFrame(run),now=Date.now(),factor=(now-last)/16,last=now,input(),draw()}function setPointer(e,r){if(r)if(e.touches)for(var t=e.touches,o=pointersLength=t.length;o--;){var a=t[o];pointersX[o]=a.pageX,pointersY[o]=a.pageY}else pointersLength=1,pointersX[0]=e.pageX,pointersY[0]=e.pageY;else pointersLength=e.touches?e.touches.length:0;e.preventDefault()}function pointerUp(e){setPointer(e,!1)}function pointerMove(e){setPointer(e,pointersLength)}function pointerDown(e){setPointer(e,!0)}function setKey(e,r){keysDown[e.keyCode]=r,e.preventDefault()}function keyUp(e){setKey(e,!1)}function keyDown(e){setKey(e,!0)}function setProjectionMatrix(){var e=width/height,r=.1-far,t=1/M.tan(.125*M.PI);pm=new FA([t/e,0,0,0,0,t,0,0,0,0,(far+.1)/r,-1,0,0,.2*far/r,0])}function resize(){width=gl.canvas.clientWidth,height=gl.canvas.clientHeight,gl.canvas.width=width,gl.canvas.height=height,gl.viewport(0,0,width,height),setProjectionMatrix()}function cacheUniformLocations(e,r){void 0===e.uniforms&&(e.uniforms={});for(var t=0,o=r.length;t<o;++t){var a=r[t];e.uniforms[a]=gl.getUniformLocation(e,a)}}function cacheAttribLocations(e,r){void 0===e.attribs&&(e.attribs={});for(var t=0,o=r.length;t<o;++t){var a=r[t];e.attribs[a]=gl.getAttribLocation(e,a),gl.enableVertexAttribArray(e.attribs[a])}}function compileShader(e,r){var t=gl.createShader(r);return gl.shaderSource(t,e),gl.compileShader(t),gl.getShaderParameter(t,gl.COMPILE_STATUS)?t:null}function linkProgram(e,r){var t=gl.createProgram();return t&&(gl.attachShader(t,e),gl.attachShader(t,r),gl.linkProgram(t),gl.getProgramParameter(t,gl.LINK_STATUS)||(gl.deleteProgram(t),t=null)),t}function buildProgram(e,r){var t,o,a;return(o=compileShader(e,gl.VERTEX_SHADER))&&((a=compileShader(r,gl.FRAGMENT_SHADER))&&(t=linkProgram(o,a),gl.deleteShader(a)),gl.deleteShader(o)),t}function calculateNormals(e,r){for(var t=[],o=0,a=r.length;o<a;){var n=3*r[o++],i=3*r[o++],l=3*r[o++],s=e[n],u=e[n+1],c=e[n+2],f=e[i]-s,m=e[i+1]-u,g=e[i+2]-c,p=(s=e[l]-s,u=e[l+1]-u,e[l+2]-c);c=m*p-g*u,g=g*s-f*p,f=f*u-m*s;t[n]=c,t[n+1]=g,t[n+2]=f,t[i]=c,t[i+1]=g,t[i+2]=f,t[l]=c,t[l+1]=g,t[l+2]=f}return t}function createModel(e,r){var t={count:r.length};return t.vertices=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,t.vertices),gl.bufferData(gl.ARRAY_BUFFER,new FA(e),gl.STATIC_DRAW),t.normals=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,t.normals),gl.bufferData(gl.ARRAY_BUFFER,new FA(calculateNormals(e,r)),gl.STATIC_DRAW),t.indicies=gl.createBuffer(),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,t.indicies),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),gl.STATIC_DRAW),t}function calculateMapIndicies(e){for(var r=[],t=0,o=1;o<e;++o){for(var a=1;a<e;++a)r.push(t),r.push(t+e),r.push(t+1),r.push(t+1),r.push(t+e),r.push(t+e+1),++t;++t}return r}function expandToHorizon(e,r,t){for(var o=0,a=e.length;o<a;++o){if(e[o]==-r)e[o]=-1e3;else{if(e[o]!=r)continue;e[o]=1e3}t&&(0==o%3?e[o+1]=-1e3:2==o%3&&(e[o-1]=-1e3))}}function createHeightMap(e,r){function t(r,t,a){r!=l&&t!=l||(a=o(r%l,t%l)),i[e*t+r|0]=a}function o(r,t){return i[t%l*e+r%l|0]}function a(e,r,a,n){t(e,r,(a=o(e-a,r-a)+o(e+a,r-a)+o(e+a,r+a)+o(e-a,r+a))/4+n)}function n(r,a,n,i){var l=0,s=0;-1<r-n&&(l+=o(r-n,a),++s),-1<a-n&&(l+=o(r,a-n),++s),r+n<e&&(l+=o(r+n,a),++s),a+n<e&&(l+=o(r,a+n),++s),t(r,a,l/s+i)}var i=new FA(e*e),l=e-1,s=M.random();for(t(0,0,s),t(l,0,s),t(l,l,s),t(0,l,s),s=l;;){var u,c,f=s>>1,m=r*s/l;if(1>f)break;for(c=f;c<l;c+=s)for(u=f;u<l;u+=s)a(u,c,f,M.random()*m*2-m);for(c=0;c<=l;c+=f)for(u=(c+f)%s;u<=l;u+=s)n(u,c,f,M.random()*m*2-m);s=f}return i}function createSeaModel(e){var r=[],t=M.pow(2,e)+1,o=2*t-1;e=o>>1;for(var a=0,n=1,i=4,l=t-1;a<l;++a,n+=3*o){for(var s=0;s<l;++s)r.push(s-e),r.push(.5*M.random()-.5),r.push(a-e);r.push(s-e),r.push(r[n]),r.push(a-e);s=1;for(var u=t-1;s<t;++s)r.push(u+s-e),r.push(r[i]),r.push(a-e),i+=3;i+=3*t}for(n=1,s=0;s<o;++s,n+=3)r.push(s-e),r.push(r[n]),r.push(a-e);for(i=3*o+1,l=t-1,a=0;a<l;++a)for(s=0;s<o;++s)r.push(s-e),r.push(r[i]),r.push(t+a-e),i+=3;return expandToHorizon(r,e),r=createModel(r,calculateMapIndicies(o)),seaHalf=r.radius=e,r}function createFloorModel(e,r,t){var o=[],a=(e=M.pow(2,e)+1)>>1,n=.5;r=createHeightMap(e,r);for(var i=0,l=0;l<e;++l)for(var s=0;s<e;++s){var u=r[i++]*t;n=M.max(n,u);o.push(s-a),o.push(u),o.push(l-a)}return expandToHorizon(o,a,!0),(t=createModel(o,calculateMapIndicies(e))).heightMap=r,t.size=e,t.radius=a,t.max=n,t}function mirrorModel(e,r){for(var t=e.length/3,o=0,a=e.length;o<a;)e.push(-e[o++]),e.push(e[o++]),e.push(e[o++]);for(o=0,a=r.length;o<a;o+=3)r.push(t+r[o+2]),r.push(t+r[o+1]),r.push(t+r[o])}function createPropModel(){return createModel([0,.536,3.258,-.464,.268,3.258,-.536,0,3.258,-.268,-.464,3.258,0,-.536,3.258,.464,-.268,3.258,.536,0,3.258,.268,.464,3.258,0,0,3.258,0,.536,3.294,-.464,.268,3.294,-.536,0,3.294,-.268,-.464,3.294,0,-.536,3.294,.464,-.268,3.294,.536,0,3.294,.268,.464,3.294,0,0,3.294],[1,8,2,3,8,4,6,5,8,7,8,0,10,11,17,12,13,17,15,17,14,16,9,17,6,8,17,8,17,13,4,13,12,8,17,9,8,17,11,5,6,15,7,16,17,1,10,17,0,9,16,3,12,17,2,11,10,8,5,14])}function createBoatModel(){var e=[.2,-.38,-2.459,.2,0,-2.565,.47,-.268,-2.459,.7,-.496,-2.217,.853,-.649,-1.202,.907,-.702,-.005,.853,-.649,1.192,.7,-.496,2.207,.47,-.268,2.885,.582,0,-2.459,.907,0,-2.217,1.123,0,-1.202,1.2,0,-.005,1.123,0,1.192,.907,0,2.207,.582,0,2.885,.47,.268,-2.459,.7,.496,-2.217,.853,.649,-1.202,.907,.702,-.005,.853,.649,1.192,.7,.496,2.207,.47,.268,2.885,.2,0,3.076,.2,.38,-2.459,.2,.702,-2.217,.391,.918,-1.202,.391,.993,.277,.2,.918,1.192,.2,.702,2.207,.2,.38,2.885,.2,-.702,-2.217,.2,-.918,-1.202,.2,-.993,-.005,.2,-.918,1.192,.2,-.702,2.207,.2,-.38,2.885,0,-.38,-2.459,0,0,-2.565,0,0,3.076,0,.38,-2.459,0,.702,-2.217,0,.918,-1.202,0,.993,.277,0,.918,1.192,0,.702,2.207,0,.38,2.885,0,-.702,-2.217,0,-.918,-1.202,0,-.993,-.005,0,-.918,1.192,0,-.702,2.207,0,-.38,2.885,.279,1.761,-1.202,.279,1.761,-.005,0,1.761,-1.202,0,1.761,-.005,.122,1.919,-1.039,.122,1.919,-.477,0,1.919,-1.039,0,1.919,-.477],r=[23,36,8,35,6,7,32,5,33,0,3,31,36,7,8,34,5,6,31,4,32,0,1,2,8,14,15,6,12,13,3,11,4,2,1,9,23,8,15,7,13,14,4,12,5,2,10,3,12,20,13,11,17,18,9,1,16,23,15,22,13,21,14,12,18,19,10,16,17,14,22,15,23,22,30,20,29,21,19,26,27,17,24,25,21,30,22,20,27,28,18,25,26,16,1,24,23,52,36,32,47,31,33,48,32,24,41,25,34,49,33,25,42,26,34,51,50,1,40,24,43,54,56,36,51,35,23,46,39,28,43,44,0,38,1,28,45,29,31,37,0,29,46,30,56,58,60,27,53,54,42,53,26,57,60,58,55,57,53,53,58,54,35,34,6,32,4,5,0,2,3,36,35,7,34,33,5,31,3,4,8,7,14,6,5,12,3,10,11,7,6,13,4,11,12,2,9,10,12,19,20,11,10,17,13,20,21,12,11,18,10,9,16,14,21,22,20,28,29,19,18,26,17,16,24,21,29,30,20,19,27,18,17,25,23,39,52,32,48,47,33,49,48,24,40,41,34,50,49,25,41,42,34,35,51,1,38,40,43,27,54,36,52,51,23,30,46,28,27,43,0,37,38,28,44,45,31,47,37,29,45,46,56,54,58,27,26,53,42,55,53,57,59,60,55,59,57,53,57,58];return mirrorModel(e,r),createModel(e,r)}function createCoinModel(){var e=[0,.063,-.637,.588,-.063,-.243,.637,-.063,0,.588,-.063,.243,.45,-.063,.45,.243,-.063,.588,0,-.063,.637,0,-.063,-.637,0,.063,.637,.243,.063,.588,.45,.063,.45,.588,.063,.243,.637,.063,0,.588,.063,-.243,.45,.063,-.45,.243,.063,-.588,.45,-.063,-.45,.243,-.063,-.588],r=[14,17,15,12,1,13,10,3,11,8,5,9,15,7,0,13,16,14,11,2,12,9,4,10,10,14,8,17,4,5,14,16,17,12,2,1,10,4,3,8,6,5,15,17,7,13,1,16,11,3,2,9,5,4,8,9,10,10,11,12,12,13,14,14,15,0,0,8,14,10,12,14,6,7,17,17,16,1,1,2,3,3,4,17,5,6,17,17,1,3];return mirrorModel(e,r),createModel(e,r)}function createPyramidModel(){return createModel([0,1,0,-1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],[0,3,4,0,4,2,0,1,2,0,3,1,1,3,2,2,3,4])}function createPlayer(){player={model:createBoatModel(),prop:createPropModel(),matrix:new FA(im),color:[1,1,1,1],roll:0,v:0,depth:0,tilt:0,maxSpeed:.15,maxTurn:.01}}function createEntities(){var e,r=[[-10,-40,9],[-15,-25,5]];for(e in r){var t=r[e][0],o=r[e][1],a=.66*(n=r[e][2]);translate(m,im,t,getFloorHeight(t,o),o),scale(m,m,n,a,n),addToFloor(t,o,a),entities.push({model:createPyramidModel(),matrix:new FA(m),color:[.3,.2,.1,1]})}r=createCoinModel();var n=[1,.6,.1,1],i=.5*(a=floor.model.size*floor.mag*.35);for(e=0;e<coins;++e){var l=getFloorHeight(t=-i+M.random()*a,o=-i+M.random()*a)+2;translate(m,im,t,l,o),rotate(m,m,M.random()*M.TAU,1,1,1),entities.push({model:r,matrix:new FA(m),color:n,found:!1,isTreasure:!0,update:function(){rotate(this.matrix,this.matrix,.01,1,1,1)}})}entitiesLength=entities.length}function createSea(){var e=createSeaModel(6);sea={model:e,matrix:new FA(im),color:[.4,.7,.8,.3],radius:1.75*e.radius,mag:1.75},alignSea(0,0)}function createFloor(e){for(var r=createFloorModel(5,.6,14),t=r.heightMap,o=-(10+r.max),a=t.length;a--;)t[a]=o+14*t[a];translate(m,im,0,o,0),scale(m,m,e,1,e),floor={model:r,matrix:new FA(m),color:[.3,.2,.1,1],radius:r.radius*e,mag:e,amp:14,base:o}}function newGame(){coins=1+(9*M.random()|0),coinsFound=0,text.innerText="Find "+coins+" lost coins!",text.warning=!0,createFloor(11),createEntities(),player.matrix=new FA(im),player.roll=0,player.v=0,player.depth=0,player.tilt=0,updateView(player.matrix)}function cacheLocations(){var e=["vertex","normal"],r="mvp nm light color sky far".split(" ");cacheAttribLocations(program,e),cacheUniformLocations(program,r),cacheAttribLocations(seaProgram,e),r.push("time"),r.push("radius"),cacheUniformLocations(seaProgram,r)}function createPrograms(){var e=D.getElementById("FragmentShader").textContent;return(program=buildProgram(D.getElementById("VertexShader").textContent,e))&&(seaProgram=buildProgram(D.getElementById("SeaVertexShader").textContent,e))}function getContext(){for(var e,r=D.getElementById("Canvas"),t=["webgl","experimental-webgl"],o=t.length,a=0;a<o;++a)if(e=r.getContext(t[a],{alpha:!1}))return e}function init(){(text=D.getElementById("Text"))&&(gl=getContext())&&createPrograms()?(cacheLocations(),createSea(),createPlayer(),newGame(),gl.enable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.clearColor(skyColor[0],skyColor[1],skyColor[2],skyColor[3]),W.onresize=resize,resize(),D.onkeydown=keyDown,D.onkeyup=keyUp,D.onmousedown=pointerDown,D.onmousemove=pointerMove,D.onmouseup=pointerUp,D.onmouseout=pointerUp,"ontouchstart"in D&&(D.ontouchstart=pointerDown,D.ontouchmove=pointerMove,D.ontouchend=pointerUp,D.ontouchleave=pointerUp,D.ontouchcancel=pointerUp),first=last=Date.now()-16,run()):alert("WebGL not available")}M.PI2=M.PI2||M.PI/2,M.TAU=M.TAU||2*M.PI,W.onload=init</script>