<!doctype html><title>Glitch Rabbit</title><style>body{margin:0;padding:70px;background:#223}canvas{width:1200px;height:576px;display:block;margin:0 auto}#mask{position:relative;width:1200px;height:576px;margin:-576px auto 0;background:#000;opacity:0;transition:opacity .5s}#mask.on{opacity:1}</style><canvas width=1200 height=576></canvas><div id=mask class=on></div><script>var PIXEL_SIZE=16,GAME_H=432,CAMERA_W=1200,START_X=50,IMAGE_TYPE="image/gif",SPRITES={HERO:{sprite:"HgAFAKECAPYHB////wAAAAAAACH5BAEKAAIALAAAAAAeAAUAAAIfVCx4mueYogm02oupbBRYX4FduEjZiTYeVDLmAk9VAQA7",frames:"still stepLeft stepRight jump punched dead".split(" "),w:5,h:5},BIRD:{sprite:"CAAEAKECAAAAADEAK////////yH5BAEKAAMALAAAAAAIAAQAAAILnA93wSEBHByNsgIAOw==",frames:["0","1"],w:4,h:4},MOUSE:{sprite:"CAADAMIEAAAAAAEBAepMTHx8fP///////////////yH5BAEKAAQALAAAAAAIAAMAAAMLSDS6CoOJCGOIIwEAOw==",frames:["0","1"],w:4,h:3},FIRE:{sprite:"DwADAMICAC8iErxhB/+DCv/ICv30BP////+DCv+DCiH5BAEKAAcALAAAAAAPAAMAAAMTeCeq0/AM8hZhCihByp3eAwRaAgA7",frames:["0","1","dead"],w:5,h:3},STONE:{sprite:"CAAIAKECAE5MSV5bV////////yH5BAEKAAIALAAAAAAIAAgAAAINhBFxl9aLFJxvpcrkKgA7",frames:["0"],w:8,h:8},CACTUS:{sprite:"AwAFAMIFAFJTDCd8HkibQFCxJVu8Qf///////////yH5BAEKAAcALAAAAAADAAUAAAMJCBIxSgEMsUYCADs=",frames:["0"],w:3,h:5},BIG_CACTUS:{sprite:"BQAKAMIBAFJTDCd8HkibQFCxJeqV7Sd8Hid8Hid8HiH5BAEKAAcALAAAAAAFAAoAAAMVGBIwvYIwJ0ZkwTZSgxrMVoGOt1gJADs=",frames:["0"],w:5,h:10},BAT:{sprite:"BgACAKECAAAAADEnNv///////yH5BAEKAAIALAAAAAAGAAIAAAIFjAwiaVEAOw==",frames:["0","1"],w:3,h:2},HYDRA:{sprite:"FQAHAKEDAAAAAHk+PvQfH////yH5BAEKAAMALAAAAAAVAAcAAAIk1I4Cp+gD4gFGwveWvRzF1SyMRmrc56BDAElsK04b7Knw9i0FADs=",frames:["0","1","dead"],w:7,h:7},SHOT:{sprite:"DAADAMIEAMvIvdLRzvTz8f///wAAAAAAAAAAAAAAACH5BAEKAAQALAAAAAAMAAMAAAMQCARBIUQMMpUjEdfVXpxDAgA7",frames:["0","1","2","3"],w:3,h:3},BALL:{sprite:"AQABAIABAM/Nzf///yH5BAEKAAEALAAAAAABAAEAAAICRAEAOw==",frames:["0"],w:1,h:1},POWERUP_GP:{sprite:"BAACAKEAAAAAAP///wAAAAAAACH5BAEKAAIALAAAAAAEAAIAAAIERGJgBQA7",frames:["0","1"],w:2,h:2},POWERUP_SU:{sprite:"BAACAKEBAAAAAPkWFvkWFvkWFiH5BAEKAAIALAAAAAAEAAIAAAIERGJgBQA7",frames:["0","1"],w:2,h:2},POWERUP_DD:{sprite:"BAACAKEAAAAAABah+QAAAAAAACH5BAEKAAIALAAAAAAEAAIAAAIERGJgBQA7",frames:["0","1"],w:2,h:2}},WHOLE_NOTE=1920,NOTES={C3:130.81,E3:164.81,F3:174.61,G3:196,A3:220,C4:261.63,D4:293.66,E4:329.63,F4:349.23,F4S:369.99,G4:392,A4:440,C5:523.35,D5:587.33},MUSIC={T0:{oType:"triangle",notes:["A3",1,"A3",1,"G3",1,"G3",1,"F3",1,"F3",1,"E3",1,"C3",1]},T1:{oType:"sawtooth",notes:["A4",4,0,8,"G4",8,"A4",8,"A4",16,"G4",16,"C5",8,"D5",8,0,4,"A4",8,"A4",16,0,16,"A4",8,0,8,"G4",8,0,8,"A4",4,0,8,"G4",8,"A4",8,"A4",16,"G4",16,"C5",8,"D5",8,0,4,"G4",8,"G4",16,0,16,"G4",8,0,8,"F4",8,0,8,"A4",4,0,8,"G4",8,"A4",8,"A4",16,"G4",16,"C5",8,"D5",8,0,4,"F4",8,"F4",16,0,16,"F4",8,0,8,"E4",8,0,8,"A4",4,0,8,"G4",8,"A4",8,"A4",16,"G4",16,"C5",8,"D5",8,0,4,"E4",8,"E4",16,0,16,"E4",8,0,8,"C4",8,0,8]}},COLOR_WHITE="#f9d4c1",COLOR_RED="#f65555",COLOR_BLUE="#1499ff",WIN_MESSAGES=["YOU WIN!","DONE!","YOU ROCK!","GOOD JOB!"],LOSE_MESSAGES=["NOT TODAY","MAYBE, NEXT TIME","YOU WERE NEAR","YOU LOSE"],LAND=[[65,26,50],[100,44,38],[40,77,66]],SAND=[[236,193,89],[203,193,135],[239,222,128]],DARK_SAND=[[196,143,59],[163,133,95],[179,182,88]],SKY=[[93,139,228],[98,144,233],[103,149,238],[108,154,243]],NIGHT_SKY=[[41,2,100],[47,5,107],[37,3,93],[0,2,96]];function extend(t,e){var i=function(){};i.prototype=e.prototype,t.prototype=new i}function random(t,e){return Math.floor(Math.random()*(e-t+1))+t}function on(t,e,i){on.keys[t]={listeners:[e,i],isPressed:!1}}function off(){on.keys={}}function haveCollision(t,e){var i=t.y<=e.y&&t.y+t.h>=e.y,s=t.y>=e.y&&t.y<=e.y+e.h,h=t.x<=e.x&&t.x+t.w>=e.x,a=t.x>=e.x&&t.x<=e.x+e.w;return i&&h||i&&a||s&&h||s&&a}on.keys={},window.addEventListener("keydown",(function(t){t.code in on.keys&&!on.keys[t.code].isPressed&&(on.keys[t.code].listeners[0]&&on.keys[t.code].listeners[0](),on.keys[t.code].isPressed=!0)})),window.addEventListener("keyup",(function(t){t.code in on.keys&&(on.keys[t.code].listeners[1]&&on.keys[t.code].listeners[1](),on.keys[t.code].isPressed=!1)}));var getUniqueID=function(){var t=0;return function(){return++t}}();function createCanvas(t,e){var i=document.createElement("canvas");return i.width=t,i.height=e,i}function disableCanvasSmoothness(t){t.mozImageSmoothingEnabled=!1,t.msImageSmoothingEnabled=!1,t.imageSmoothingEnabled=!1}function loadImages(t,e){var i=Object.keys(t);!function s(){var h=i.pop(),a=t[h].sprite,n=new Image;n.onload=function(){t[h].sprite=this,i.length?s():e()},n.src="data:"+IMAGE_TYPE+";base64,R0lGODlh"+a}()}function iterateImageData(t,e){function i(t,e,i){h[s]=t,h[s+1]=e,h[s+2]=i}var s,h=t.data,a=h.length;for(s=0;s<a;s+=4)e(h[s],h[s+1],h[s+2],i)}function Timers(){this.timers={},this.idCounter=0}function Texture(t,e,i){this.colors=i,this.canvas=createCanvas(t,e),this.ctx=this.canvas.getContext("2d"),disableCanvasSmoothness(this.ctx),this.imageData=this.ctx.createImageData(t,e)}function Animation(t){var e,i,s,h,a=t.frames.length,n=t.w*PIXEL_SIZE,o=t.h*PIXEL_SIZE;for(disableCanvasSmoothness(e=createCanvas(n*a,o).getContext("2d")),e.scale(PIXEL_SIZE,PIXEL_SIZE),e.drawImage(t.sprite,0,0),this.frames={};a--;)s=(i=createCanvas(n,o)).getContext("2d"),h=e.getImageData(n*a,0,n,o),s.putImageData(h,0,0),this.frames[t.frames[a]]=new Image,this.frames[t.frames[a]].src=i.toDataURL(IMAGE_TYPE),s.clearRect(0,0,n,o),s.scale(-1,1),s.drawImage(this.frames[t.frames[a]],-n,0),this.frames[t.frames[a]+"R"]=new Image,this.frames[t.frames[a]+"R"].src=i.toDataURL(IMAGE_TYPE)}function Glitch(t,e,i,s,h){this.update(t,e,i,s,h),this.id=getUniqueID(),level.glitches&&(level.glitches[this.id]=this)}function Shot(t,e,i,s,h,a,n,o){e=SPRITES[e],this.id=getUniqueID(),this.emitter=t,this.dir=h,this.w=e.w*PIXEL_SIZE,this.h=e.h*PIXEL_SIZE,this.x=this.startX=i+.5*PIXEL_SIZE*this.dir-(0>this.dir?this.w:0),this.y=s+1*PIXEL_SIZE,this.speed=a||random(12,15),this.range=n||random(400,1e3),this.power=o||random(15,30),this.animation=new Animation(e),this.lastFrameNumber=e.frames.length-1,this.creationTime=currentTime,level.attacks&&(level.attacks[this.id]=this)}function Beam(t){this.id=getUniqueID(),this.w=1e3,this.power=t,this.glitch=new Glitch(this.x,this.y,1e3,PIXEL_SIZE,1),this.stepsLeft=2,this.update(),level.attacks[this.id]=this}function Shrapnel(t,e,i){var s=SPRITES.BALL;this.id=getUniqueID(),this.dir=i,this.w=s.w*PIXEL_SIZE,this.h=s.h*PIXEL_SIZE,this.x=t+.5*PIXEL_SIZE*this.dir-(0>this.dir?this.w:0),this.y=e-2*PIXEL_SIZE,this.ay=-random(10,18),this.speed=random(4,10),this.power=random(3,6),this.animation=new Animation(s),level.attacks[this.id]=this}function powerupGlitchPlus(t){t.glitchUp(random(10,20))}function powerupSpeedUp(t){t.speed=Math.floor(1.6*t.defaultSpeed),gameTimers.setTimeout("powerupSU",(function(){t.speed=t.defaultSpeed}),7e3)}function powerupDoubleDamage(t){t.damageFactor=2,gameTimers.setTimeout("powerupDD",(function(){t.damageFactor=1}),7e3)}function Powerup(t,e){var i;this.id=getUniqueID(),this.creationTime=currentTime,i=Powerup.EFFECTS[random(0,Powerup.EFFECTS.length-1)],this.effect=i[0],i=i[1],this.animation=new Animation(i),this.x=t,this.y=e,this.w=i.w*PIXEL_SIZE,this.h=i.h*PIXEL_SIZE,this.hp=3,this.gp=0,level.units[this.id]=this}function Unit(){}function Hero(t){var e=SPRITES.HERO;this.x=t,this.y=200,this.w=e.w*PIXEL_SIZE,this.h=e.h*PIXEL_SIZE,this.ax=0,this.ay=-9,this.speed=this.defaultSpeed=10,this.damageFactor=this.dir=1,off(),on("ArrowRight",this.run.bind(this),this.stop.bind(this)),on("ArrowLeft",this.run.bind(this,!0),this.stop.bind(this,!0)),on("ArrowUp",this.jump.bind(this,24)),on("KeyZ",this.attack.bind(this,"shot",1)),on("KeyX",this.attack.bind(this,"beam",15)),on("KeyC",this.attack.bind(this,"xxxx",15)),this.animation=new Animation(e),this.timers={},this.glitchAmount=this.maxGlitchAmount=25,this.oneThird=this.maxGlitchAmount/3,this.glitch=new Glitch(this.x,this.y,this.w,this.h,this.getGlitchIntensity()),this.glitchUp(),this.glitchTrail()}function Enemy(){}function Bird(t){var e=SPRITES.BIRD;this.hp=10,this.gp=4,this.setCommons(e),this.x=t,this.y=this.startY=random(50,GAME_H-250),this.ax=0,this.ay=random(-5,5),this.speed=random(4,6),this.timers={},this.shoot()}function Mouse(t){var e=SPRITES.MOUSE;this.hp=10,this.gp=2,this.setCommons(e),this.x=t,this.y=GAME_H-this.w,this.ay=this.ax=0,this.speed=5}function Fire(t){var e=SPRITES.FIRE;this.hp=1,this.gp=3,this.setCommons(e),this.x=t,this.y=GAME_H-this.h,this.ay=this.ax=0}function Stone(t){var e=SPRITES.STONE;this.gp=this.hp=1,this.setCommons(e),this.x=t,this.y=GAME_H-this.h,this.ay=this.ax=0,this.isReversed=random(0,1),this.hitCounter=0}function Cactus(t){var e=SPRITES.CACTUS;this.hp=30,this.gp=8,this.setCommons(e),this.x=t,this.y=GAME_H-this.h,this.ay=this.ax=0}function BigCactus(t){var e=SPRITES.BIG_CACTUS;this.hp=300,this.gp=15,this.setCommons(e),this.x=t,this.y=GAME_H-this.h,this.ay=this.ax=0,this.timers={},this.shoot()}function Bat(t){var e=SPRITES.BAT;this.hp=30,this.gp=1,this.setCommons(e),this.x=t,this.y=random(50,GAME_H-250),this.ax=0,this.ay=random(-2,2),this.vDir=this.dir=1,this.speed=5,this.retreatCoef=1,this.timers={},this.hunt()}function Hydra(t){var e=SPRITES.HYDRA;this.hp=500,this.gp=8,this.setCommons(e),this.x=t,this.y=GAME_H-this.h,this.ay=this.ax=0,this.dir=-1,this.timers={},this.attack(),this.attacksCount=0}function Camera(){this.canvas=document.querySelector("canvas"),this.ctx=this.canvas.getContext("2d"),this.y=this.x=0,this.w=CAMERA_W,this.H=576,this.h=GAME_H,this.heightDiff=this.H-this.h,this.textureWidth=8*this.heightDiff,this.parallaxFactor=4,this.mask=document.querySelector("#mask")}function Level(t,e,i){this.meta=Level.LEVELS[t],this.w=this.meta.width,this.land=new Texture(camera.textureWidth,camera.heightDiff,this.meta.land).generate(),this.sky=new Texture(camera.textureWidth/camera.parallaxFactor,camera.h,this.meta.sky).generate(8),this.units={},this.attacks={},this.glitches={},this.ambushesPointer=this.heroFarthestX=0,this.winSteps=this.meta.ambushes.reduce((function(t,e){return e[5]&&"number"==typeof e[4]?t+e[2]:e[5]?t+e[4].length:t}),0),this.winCallback=e,this.loseCallback=i,this.textsCopy=this.meta.texts.slice(0),this.texts=[]}function Menu(t){var e=CAMERA_W/2;this.land=new Texture(camera.textureWidth,camera.heightDiff,LAND).generate(),this.sky=new Texture(camera.textureWidth/camera.parallaxFactor,camera.h,SKY).generate(8),this.w=CAMERA_W,this.units={1:new Fire(random(250,820)),2:new Cactus(100)},this.textsCopy=[[0,1,{text:"PRESS Z TO PLAY",font:"italic bold 56px Verdana",color:COLOR_RED,x:e,y:190,shake:1,center:!0}],[0,1,{text:"PRESS X TO LAUNCH TUTORIAL",font:"italic bold 22px Verdana",color:COLOR_RED,x:e,y:240,center:!0}],[0,1,{text:"Z and X to ATTACK",x:e-e/2,y:310,center:!0}],[0,1,{text:"ARROWS to MOVE",x:e+e/2,y:310,center:!0}],[0,1,{text:"Q to toggle MUSIC",x:e,y:85,center:!0}]],this.texts=[],off(),on("KeyZ",t.bind(null,1)),on("KeyX",t.bind(null,0))}function Music(){var t,e=this;e.context=new AudioContext,(t=e.context.createGain()).gain.value=.05,t.connect(e.context.destination),e.dest=t,e.tracks=[],e.timers=new Timers,e.start(MUSIC),window.addEventListener("keydown",(function(t){"KeyQ"===t.code&&(e.isPlaying?e.end():e.start(MUSIC))}))}function Track(t,e,i,s){this.ctx=t,this.dest=e,this.track=i,this.pos=0,this.timers=s}Timers.prototype.setTimeout=function(t,e,i,s){var h=this;return"function"==typeof t?(s=i,i=e,e=t,t=h.idCounter++):h.clearTimeout(h.timers[t]),h.timers[t]={timerID:setTimeout((function(){e(),delete h.timers[t]}),i),triggerBeforeClear:s,callback:e},t},Timers.prototype.clearTimeout=function(t){var e=this.timers[t];e&&(e.triggerBeforeClear&&e.callback(),clearTimeout(e.timerID),delete this.timers[t])},Timers.prototype.nullifyTimers=function(){Object.keys(this.timers).forEach(this.clearTimeout.bind(this)),this.timers={},this.idCounter=0},Texture.prototype.generate=function(t){var e,i,s=this.imageData.data;for(t=t||PIXEL_SIZE,i=0;i<s.length;i+=4)e=this.colors[random(0,this.colors.length-1)],s[i]=e[0],s[i+1]=e[1],s[i+2]=e[2],s[i+3]=255;return this.ctx.putImageData(this.imageData,0,0),this.ctx.save(),this.ctx.scale(t,t),this.ctx.drawImage(this.canvas,0,0),this.ctx.restore(),this.ctx.createPattern(this.canvas,"repeat")},Animation.prototype.getFrame=function(t,e){return this.frames[t+(e?"R":"")]},Glitch.prototype.update=function(t,e,i,s,h){this.x=t,this.y=e,this.w=i,this.h=s,this.intensity=h||this.intensity||1},Glitch.prototype.remove=function(){delete level.glitches[this.id]},Glitch.distort=function(t,e,i){var s,h,a,n=t.width,o=t.height,r=createCanvas(n+2*e,o+2*e),c=r.getContext("2d");for(c.putImageData(t,e,e);i--;)t=random(e,e+10),s=random(e,e+10),h=random(16,n+32),a=random(8,o/2+8),t=c.getImageData(t,s,h,a),t=Glitch.shift(t),c.putImageData(t,random(e/2,n/2+e/2),random(e,1.2*o));return r},Glitch.shift=function(t){switch(random(0,3)){case 0:iterateImageData(t,(function(t,e,i,s){s(t-100,e-100,i-100)}));break;case 1:iterateImageData(t,(function(t,e,i,s){s(t+100,e+100,i+100)}))}return t},Shot.prototype.tick=function(){var t=this,e=t.emitter==hero;t.x+=t.speed*t.dir,e?level.iterateUnits(hero.id,!0,(function(e){if(haveCollision(e,t))return delete level.attacks[t.id],e.hit(t.power),0})):haveCollision(hero,t)&&(delete level.attacks[t.id],hero.hit(t.power)),Math.abs(t.startX-t.x)>=t.range&&level.attacks[t.id]&&delete level.attacks[t.id]},Shot.prototype.getAnimationFrame=function(){var t;return t=Math.floor((currentTime-this.creationTime)/100),this.animation.getFrame(t<=this.lastFrameNumber?t:this.lastFrameNumber)},Beam.prototype.update=function(){0>this.stepsLeft?(hero.speed=hero.defaultSpeed,this.glitch.remove(),delete level.attacks[this.id]):(hero.speed=4,gameTimers.setTimeout(this.update.bind(this),800),this.stepsLeft--)},Beam.prototype.tick=function(){var t=this;t.h=(5-2*t.stepsLeft)*PIXEL_SIZE,t.x=hero.x+(0>hero.dir?-t.w:hero.w),t.y=hero.y+t.stepsLeft*PIXEL_SIZE,t.glitch.update(t.x,t.y,t.w,t.h,3-t.stepsLeft),level.iterateUnits(hero.id,!0,(function(e){haveCollision(e,t)&&(e.hp<=t.power?e.bump(t,10*hero.dir,-5):e.hit(t.power))}))},Shrapnel.prototype.tick=function(){this.x+=this.speed*this.dir,this.y+this.h+this.ay<GAME_H?this.y+=++this.ay:delete level.attacks[this.id],haveCollision(hero,this)&&(delete level.attacks[this.id],hero.hit(this.power))},Shrapnel.prototype.getAnimationFrame=function(){return this.animation.getFrame(0)},Powerup.prototype.tick=function(){5e3<=currentTime-this.creationTime&&this.absorb()},Powerup.prototype.hit=function(){this.hp--,this.hp||this.absorb()},Powerup.prototype.bump=function(t){this.absorb(t)},Powerup.prototype.absorb=function(t){var e=this;t==hero&&e.effect(t),gameTimers.setTimeout((function(){delete level.units[e.id]}),0)},Powerup.prototype.getAnimationFrame=function(){return this.animation.getFrame(isOdd?0:1)},Powerup.EFFECTS=[[powerupGlitchPlus,SPRITES.POWERUP_GP],[powerupSpeedUp,SPRITES.POWERUP_SU],[powerupDoubleDamage,SPRITES.POWERUP_DD]],Unit.prototype.applyBorders=function(t){this.x=this.x+this.ax>0-t?this.x+this.w+this.ax<level.w+t?this.x+this.ax:level.w-this.w+t:0-t},Unit.prototype.applyFriction=function(){this.isLanded&&!this.isRunning&&(0>this.ax?this.ax++:0<this.ax&&this.ax--)},Unit.prototype.applyGravity=function(){this.y+this.h+this.ay<GAME_H?this.y+=++this.ay:(this.y=GAME_H-this.h,this.ay=0)},Unit.prototype.getLandingState=function(){this.isLanded=this.y+this.h==GAME_H},Unit.prototype.jump=function(t){this.isLanded&&(this.ay-=t)},Unit.prototype.clearTimers=function(){var t=this;t.timers&&Object.keys(t.timers).forEach((function(e){gameTimers.clearTimeout(t.timers[e])}))},extend(Hero,Unit),Hero.prototype.tick=function(){this.applyBorders(0),this.applyFriction(),this.applyGravity(),this.getLandingState()},Hero.prototype.ownTick=function(){var t=this;level.iterateUnits(t.id,!0,(function(e){haveCollision(t,e)&&(t.hit(e.gp),e.bump(t,t.ax,-12))}))},Hero.prototype.glitchUp=function(t){gameTimers.clearTimeout(this.timers.glitch),this.glitchAmount+=t||1,this.glitchAmount>this.maxGlitchAmount?this.glitchAmount=this.maxGlitchAmount:0>this.glitchAmount&&(this.glitchAmount=0),0==this.glitchAmount?this.kill():(this.timers.glitch=gameTimers.setTimeout(this.glitchUp.bind(this),800),this.pushedWithForce=t)},Hero.prototype.glitchTrail=function(){this.glitch.update(this.x,this.y,this.w,this.h,this.getGlitchIntensity()),this.timers.trail=gameTimers.setTimeout(this.glitchTrail.bind(this),70)},Hero.prototype.getGlitchIntensity=function(){return Math.ceil(this.glitchAmount/this.oneThird)},Hero.prototype.run=function(t,e){var i=t?-1:1;!e&&this.isRunning&&this.dir==i||(gameTimers.clearTimeout(this.timers.run),this.isRunning=!0,this.dir=i,this.ax=t?-this.speed:this.speed,this.timers.run=gameTimers.setTimeout(this.run.bind(this,t,!0),50))},Hero.prototype.stop=function(t){this.dir==(t?-1:1)&&(gameTimers.clearTimeout(this.timers.run),this.isRunning=!1)},Hero.prototype.attack=function(t,e){var i=this.x+(0>this.dir?0:this.w);this.glitchAmount<=e||(this.glitchAmount-=e,"shot"==t?new Shot(this,"SHOT",i,this.y,this.dir,null,1e3,10*this.damageFactor):"beam"==t&&new Beam(5*this.damageFactor))},Hero.prototype.hit=function(t){this.glitchUp(-t)},Hero.prototype.bump=function(t,e,i){gameTimers.clearTimeout(this.timers.run),gameTimers.setTimeout(this.stop.bind(this),300),this.ax=e||-this.ax,this.ay=i||-5},Hero.prototype.kill=function(){this.dead=!0,this.ax=0,this.glitch.remove(),this.clearTimers(),off(),level.lose()},Hero.prototype.getAnimationFrame=function(){var t=0>this.dir;return this.dead?this.animation.getFrame("dead"):this.pushedWithForce?(this.pushedWithForce--,this.animation.getFrame("punched",t)):this.isLanded?this.isRunning?this.animation.getFrame(isOdd?"stepLeft":"stepRight",t):this.animation.getFrame("still",t):this.animation.getFrame("jump",t)},extend(Enemy,Unit),Enemy.prototype.tick=function(){this.applyBorders(this.w),this.applyGravity(),this.glitch&&this.glitch.update(this.x,this.y,this.w,this.h),this.x<=-this.w&&!this.dead&&this.kill()},Enemy.prototype.hit=function(t){this.hp-=t,0>=this.hp&&this.kill()},Enemy.prototype.bump=function(t,e,i){this.dead=!0,this.clearTimers(),this.ax=e,this.ay=i,gameTimers.setTimeout(this.kill.bind(this),500)},Enemy.prototype.kill=function(){var t=this;t.glitch=new Glitch(t.x,t.y,t.w,t.h,3),t.dead=!0,t.clearTimers(),t.ax=0,t.ay=0,gameTimers.setTimeout((function(){t.glitch.remove(),delete level.units[t.id],18>random(0,100)&&new Powerup(t.x+1*PIXEL_SIZE,t.y+t.h-2*PIXEL_SIZE),t.killToWin&&level.stepToWin()}),500)},Enemy.prototype.setCommons=function(t){this.w=t.w*PIXEL_SIZE,this.h=t.h*PIXEL_SIZE,this.animation=new Animation(t)},extend(Bird,Enemy),Bird.prototype.ownTick=function(){this.ax=-this.speed,this.ay+=this.y-30>this.startY?-6:1},Bird.prototype.shoot=function(){new Shrapnel(this.x,this.y,-1),new Shrapnel(this.x,this.y,-1),new Shrapnel(this.x,this.y,-1),this.timers.shoot=gameTimers.setTimeout(this.shoot.bind(this),2e3)},Bird.prototype.getAnimationFrame=function(){return this.animation.getFrame(isOdd?0:1)},extend(Mouse,Enemy),Mouse.prototype.ownTick=function(){this.ax=-this.speed,500>=this.x-hero.x+hero.w&&(this.speed=15)},Mouse.prototype.getAnimationFrame=function(){return this.animation.getFrame(15>this.speed?0:1)},extend(Fire,Enemy),Fire.prototype.bump=function(t){t==hero&&hero.bump(this),this.kill()},Fire.prototype.getAnimationFrame=function(){return this.dead?this.animation.getFrame("dead"):this.animation.getFrame(isOdd?0:1)},extend(Stone,Enemy),Stone.prototype.hit=function(){this.hitCounter++,0==this.hitCounter%5?level.addUnit(new Mouse(this.x)):11<=this.hitCounter&&this.kill()},Stone.prototype.bump=function(t){t==hero&&t.bump(this)},Stone.prototype.getAnimationFrame=function(){return this.animation.getFrame(0,this.isReversed)},extend(Cactus,Enemy),Cactus.prototype.hit=function(t){new Shot(this,"BALL",this.x,this.y,-1,t+5,800,4),new Shot(this,"BALL",this.x+this.w,this.y,1,t+5,800,4),this.hp-=t,0>=this.hp&&this.kill()},Cactus.prototype.bump=function(){this.kill()},Cactus.prototype.getAnimationFrame=function(){return this.animation.getFrame(0)},extend(BigCactus,Enemy),BigCactus.prototype.shoot=function(t){var e=random(0,1)?-1:1,i=random(0,5)*PIXEL_SIZE;new Shot(this,t?"BALL":"SHOT",this.x+(0>e?0:this.w),this.y+i,e,random(6,14),random(700,1300),3),t||(this.timers.shoot=gameTimers.setTimeout(this.shoot.bind(this),800))},BigCactus.prototype.hit=function(t){this.shoot(!0),this.hp-=t,0>=this.hp&&this.kill()},BigCactus.prototype.bump=function(){this.hp-=75,0>=this.hp&&this.kill()},BigCactus.prototype.getAnimationFrame=function(){return this.animation.getFrame(0)},extend(Bat,Enemy),Bat.prototype.ownTick=function(){this.ax=this.speed*this.dir,120>=this.y?this.vDir=this.retreatCoef=1:this.y>=GAME_H-70&&(this.vDir=-1),this.ay=4*this.vDir*this.retreatCoef},Bat.prototype.hunt=function(){var t=Math.abs(this.x-hero.x);600>t?(this.speed=8,1==this.retreatCoef&&(this.vDir=1)):800>t?(this.speed=5,this.dir*=random(0,1)?-1:1):(this.speed=5,this.dir=-t/(this.x-hero.x)),this.timers.hunt=gameTimers.setTimeout(this.hunt.bind(this),150)},Bat.prototype.bump=function(){this.y-=18,this.vDir=-1,this.retreatCoef=4},Bat.prototype.getAnimationFrame=function(){return this.dead?this.animation.getFrame(0):this.animation.getFrame(Math.floor(currentTime/300)%2?0:1)},extend(Hydra,Enemy),Hydra.prototype.ownTick=function(){this.getLandingState(),this.isLanded&&(this.dir=this.x>hero.x?-1:1,0<this.ax&&this.isLanded?this.ax--:0>this.ax&&this.isLanded&&this.ax++)},Hydra.prototype.attack=function(){this.attacksCount++,4<=this.attacksCount?(this.dance(),this.attacksCount=0):this.shoot(),this.timers.attack=gameTimers.setTimeout(this.attack.bind(this),2e3)},Hydra.prototype.shoot=function(){var t=this.x+(0>this.dir?0:this.w);new Shot(this,"BALL",t,this.y,this.dir,10,1e3,1),new Shot(this,"BALL",t,this.y,this.dir,8,1e3,2),new Shot(this,"BALL",t,this.y,this.dir,6,1e3,3),new Shrapnel(this.x,this.y,-1),new Shrapnel(this.x,this.y,-1),new Shrapnel(this.x,this.y,1),new Shrapnel(this.x,this.y,1)},Hydra.prototype.dance=function(){this.ax=20*this.dir,this.jump(9),this.dir*=-1},Hydra.prototype.bump=function(t){t==hero&&t.bump(this,2*-t.ax,-15),this.hit(100)},Hydra.prototype.getAnimationFrame=function(){return this.dead?this.animation.getFrame("dead",0<this.dir):this.animation.getFrame(Math.floor(currentTime/1e3)%2?0:1,0<this.dir)},Camera.prototype.fade=function(){self.mask.className="on"},Camera.prototype.unfade=function(){self.mask.className=""},Camera.prototype.clear=function(){this.x+START_X+50>this.focus.x&&0<this.x?(this.x=this.focus.x-START_X-50,this.x=0>this.x?0:this.x):this.x+START_X+200<this.focus.x&&this.x+this.w<level.w&&(this.x=this.focus.x-START_X-200,this.x=this.x+this.w>level.w?level.w-this.w:this.x),this.ctx.fillStyle=level.sky,this.ctx.save(),this.ctx.translate(-this.x%this.textureWidth/this.parallaxFactor,0),this.ctx.fillRect(0,0,this.w+this.textureWidth/this.parallaxFactor,this.h),this.ctx.restore(),this.ctx.fillStyle=level.land,this.ctx.save(),this.ctx.translate(-this.x%this.textureWidth,0),this.ctx.fillRect(0,this.h,this.w+this.textureWidth,this.H),this.ctx.restore()},Camera.prototype.draw=function(t){this.isInBounds(t)&&(t.getAnimationFrame?this.ctx.drawImage(t.getAnimationFrame(),t.x-this.x,t.y-this.y):(this.ctx.fillStyle=t.color||"#000",this.ctx.fillRect(t.x-this.x,t.y-this.y,t.w,t.h)))},Camera.prototype.drawAttacks=function(){var t=this;Object.keys(level.attacks).forEach((function(e){e=level.attacks[e],t.isInBounds(e)&&e.getAnimationFrame&&t.ctx.drawImage(e.getAnimationFrame(),e.x-t.x,e.y-t.y,e.w,e.h)}))},Camera.prototype.drawGlitches=function(){if(!isOdd&&!random(0,1)){var t=this;Object.keys(level.glitches).forEach((function(e){var i,s;e=level.glitches[e],t.isInBounds(e)&&(i=t.ctx.getImageData(e.x-t.x,e.y-t.y,e.w,e.h),s=12*e.intensity,t.ctx.drawImage(Glitch.distort(i,s,e.intensity),e.x-t.x-s,e.y-t.y-s))}))}},Camera.prototype.drawText=function(t){var e=t.shake?random(-t.shake,t.shake):0,i=t.shake?random(-t.shake,t.shake):0;this.ctx.font=t.font,this.ctx.textAlign=t.center?"center":"left",this.ctx.shadowColor="#000",this.ctx.shadowBlur=2,this.ctx.lineWidth=3,this.ctx.strokeText(t.text,t.x+e+1,t.y+i+1),this.ctx.shadowBlur=0,this.ctx.fillStyle=t.color,this.ctx.fillText(t.text,t.x+e-1,t.y+i-1)},Camera.prototype.postEffects=function(){var t,e,i,s;level.texts.forEach(this.drawText.bind(this)),hero&&(e=255-10*(t=hero.glitchAmount),i=9*t,s=40,15>t&&(e+=10*(15-t),i-=5*(15-t),s-=15-t),this.drawText({text:"G "+t,font:"italic bold 46px Verdana",color:"rgb("+(0>e?0:255<e?255:e)+", "+(0>i?0:255<i?255:i)+", "+s+")",x:40,y:60,shake:6>t?2:10>t?1:0}))},Camera.prototype.isInBounds=function(t){return t.x<this.x+this.w&&t.y<this.y+this.h&&t.x+t.w>this.x&&t.y+t.h>this.y},Camera.prototype.focusOn=function(t){this.focus=t},Camera.prototype.reset=function(){this.x=0},Level.prototype.update=function(t){var e,i,s,h,a=this.meta.ambushes,n=a.length,o=this.ambushesPointer;for(t>this.heroFarthestX&&(this.heroFarthestX=t);o<n&&(t=(e=a[o])[0],h=e[5],t<=this.heroFarthestX);){for(i=e[1],s=random(e[2],e[3]),"number"==typeof(e=e[4])&&(e=Level.createSpreadArray(s,0,e)),s=0;s<e.length;s++)level.addUnit(new i(t+CAMERA_W+e[s]),h);++o}this.ambushesPointer=o},Level.prototype.updateText=function(){var t,e,i=this.textsCopy;for(e=this.texts.length;e--;)((t=this.texts[e]).upToX<=camera.x||t.upToTime&&t.upToTime<currentTime)&&this.texts.splice(e,1);for(e=0;e<i.length&&(t=i[e],camera.x>=t[0]);)this.texts.push(Level.applyTextDefaults(t[2],t[1])),++e;this.textsCopy=this.textsCopy.slice(e)},Level.prototype.stepToWin=function(){this.winSteps--,!this.winSteps&&this.win()},Level.prototype.win=function(){var t;this.isLost||(t=this.meta.last?"YOUR GLITCH JOURNEY IS DONE!":WIN_MESSAGES[random(0,WIN_MESSAGES.length-1)],this.isLost=!1,this.textsCopy.unshift([camera.x-CAMERA_W,camera.x+CAMERA_W,{text:t,font:"italic bold 56px Verdana",color:COLOR_RED,x:CAMERA_W/2,y:250,center:!0}]),gameTimers.setTimeout(this.winCallback,this.meta.last?3e3:1800))},Level.prototype.lose=function(){!1!==this.isLost&&!0!==this.isLost&&(this.isLost=!0,this.textsCopy.unshift([camera.x-CAMERA_W,camera.x+CAMERA_W,{text:LOSE_MESSAGES[random(0,LOSE_MESSAGES.length-1)],font:"italic bold 56px Verdana",color:COLOR_WHITE,x:CAMERA_W/2,y:250,center:!0}]),gameTimers.setTimeout(this.loseCallback,2e3))},Level.prototype.addUnit=function(t,e){t.id=getUniqueID(),t.killToWin=e,this.units[t.id]=t},Level.prototype.iterateUnits=function(t,e,i){var s,h,a=Object.keys(this.units);for(h=0;h<a.length&&(s=a[h],t&&s==t||e&&this.units[s].dead||0!=i(this.units[s]));h++);},Level.prototype.iterateAttacks=function(){Object.keys(this.attacks).forEach((function(t){this.attacks[t].tick()}),this)},Level.createSpreadArray=function(t,e,i){for(var s=[];t--;)s.push(random(e,i));return s},Level.applyTextDefaults=function(t,e){var i={};return i.text=t.text,i.font=t.font||"italic bold 30px Verdana",i.color=t.color||COLOR_WHITE,i.center=t.center||!1,i.shake=t.shake||0,i.x=t.x||50,i.y=t.y||GAME_H+80,i.upToX=e,i.upToTime=t.duration?currentTime+1e3*t.duration:0,i},Level.LEVELS={0:{width:8e3,land:LAND,sky:SKY,ambushes:[[0,Fire,1,1,0],[700,Fire,5,5,[0,100,200,300,400]],[6200,Fire,1,1,0,!0]],texts:[[0,500,{text:"USE ARROWS TO MOVE AND JUMP",duration:5}],[500,1e3,{text:"PRESS Z FOR A COMMON ATTACK",duration:5}],[1e3,1600,{text:"PRESS X FOR A GLITCH BEAM",duration:5}],[1600,2200,{text:"EACH ATTACK SPENDS YOUR GLITCH",duration:5}],[2200,2800,{text:"GLITCH LEVEL IS DISPLAYED IN THE TOP LEFT",duration:5}],[2800,3400,{text:"COLORED BLOCKS WILL POWER-UP YOU",duration:5}],[3400,4e3,{text:"WHITE WILL GIVE YOU GLITCH",duration:5}],[4e3,4600,{text:"RED WILL IMPROVE YOUR SPEED",duration:5}],[4600,5200,{text:"AND BLUE WILL DOUBLE YOUR DAMAGE",duration:5}],[5200,5800,{text:"REMEMBER, GLITCH IS YOUR LIFE",duration:5}],[5800,6400,{text:"IF IT ENDS, YOU'LL DIE",duration:5}],[6400,7e3,{text:"AND, UNLIKE THAT FIRE, YOUR GLITCH MUST LIVE",duration:8}]]},1:{width:7e3,land:LAND,sky:SKY,ambushes:[[-1200,Fire,6,6,[700,2e3,2800,3800,4e3,6200]],[0,Stone,2,2,[1800,4e3]],[1400,Bird,2,3,100],[2e3,Mouse,3,4,600],[2200,Bird,3,3,[1e3,1100,2600]],[2800,Mouse,3,3,[300,400,500]],[3200,Bird,2,3,700],[3400,Mouse,4,4,[0,100,200,300]],[3800,Bat,3,5,500,!0]],texts:[[0,500,{text:"BY THE WAY, MY NAME IS NICH",duration:5,color:COLOR_BLUE}],[500,1e3,{text:"NICH THE GLITCH RABBIT",duration:5,color:COLOR_BLUE}],[1100,1500,{text:"O-OH, BEWARE!",duration:5,color:COLOR_BLUE}]]},2:{width:7e3,land:SAND,sky:SKY,ambushes:[[600,Cactus,3,6,3600],[700,Fire,4,4,[0,100,200,300]],[1e3,Bird,2,3,600],[1500,Mouse,2,4,1400],[1500,Stone,1,1,0],[1900,Fire,1,1,0],[2200,Bird,3,4,[0,200,400,600]],[2600,Mouse,4,4,[200,300,400,500]],[3200,BigCactus,1,1,1600,!0]],texts:[[0,500,{text:"I HEARD THAT CACTUS NEEDLES ARE DANGEROUS",duration:5,color:COLOR_BLUE}],[500,1e3,{text:"DON'T LET THEM HURT YOU",duration:5,color:COLOR_BLUE}]]},3:{last:!0,width:7e3,land:DARK_SAND,sky:NIGHT_SKY,ambushes:[[500,Fire,1,1,0],[800,Cactus,3,6,3600],[1e3,Mouse,3,3,[0,200,400]],[1500,Stone,1,1,0],[1800,Bird,2,3,600],[2400,Fire,1,1,100],[2500,Mouse,3,3,[0,200,400]],[2800,Bird,3,4,[0,200,400,600]],[3200,Bat,4,4,[200,300,400,500]],[3700,Hydra,1,1,1200,!0]],texts:[[0,500,{text:"IT'S GETTING LATE, YOU NEED TO MAKE A...",duration:5,color:COLOR_BLUE}],[500,1e3,{text:"LOOK, FIRE!",duration:5,color:COLOR_BLUE}]]}},extend(Menu,Level),Music.prototype.start=function(t){var e=this;e.tracks=[],Object.keys(t).forEach((function(i){e.tracks.push(new Track(e.context,e.dest,t[i],e.timers))})),e.tracks.forEach((function(t){t.play()})),e.isPlaying=!0},Music.prototype.end=function(){this.tracks.forEach((function(t){t.stop()})),this.isPlaying=!1},Track.prototype.play=function(){var t,e,i=this.track.notes;this.pos==i.length&&(this.pos=0),t=i[this.pos],e=WHOLE_NOTE/i[this.pos+1],t&&this.playNote(i[this.pos],e),this.pos+=2,this.timers.setTimeout(this.play.bind(this),e)},Track.prototype.playNote=function(t,e){var i=this.ctx.createOscillator();i.frequency.value=NOTES[t]/2,i.type=this.track.oType||"sine",i.connect(this.dest),i.start(),this.timers.setTimeout(i.stop.bind(i),e-20,!0)},Track.prototype.stop=function(){this.timers.nullifyTimers()};var camera,level,hero,RAFID,music,currentTime,isOdd,gameTimers=new Timers,levelCount=Object.keys(Level.LEVELS).length-1,delay=700;loadImages(SPRITES,(function(){function t(){currentTime=Date.now(),isOdd=100>currentTime%200,camera.clear(),level.update(hero.x),level.iterateUnits(!1,!1,(function(t){t.tick(),!t.dead&&t.ownTick&&t.ownTick(),camera.draw(t)})),level.iterateAttacks(),camera.drawAttacks(),camera.drawGlitches(),level.updateText(),camera.postEffects(),RAFID=window.requestAnimationFrame(t)}function e(){currentTime=Date.now(),isOdd=100>currentTime%200,camera.clear(),level.iterateUnits(!1,!1,(function(t){t.tick(),camera.draw(t)})),level.updateText(),camera.postEffects(),RAFID=window.requestAnimationFrame(e)}function i(e){RAFID&&window.cancelAnimationFrame(RAFID),gameTimers.nullifyTimers(),camera.reset(),camera.unfade(),level=new Level(e,(function(){e<levelCount?(camera.fade(),gameTimers.setTimeout(i.bind(null,e+1),delay)):(camera.fade(),gameTimers.setTimeout(s,delay))}),(function(){camera.fade(),gameTimers.setTimeout(s,delay)})),hero=new Hero(START_X),level.addUnit(hero),camera.focusOn(hero),window.requestAnimationFrame(t)}function s(){RAFID&&window.cancelAnimationFrame(RAFID),gameTimers.nullifyTimers(),camera.reset(),camera.unfade(),level=new Menu((function(t){camera.fade(),gameTimers.setTimeout((function(){i(t),camera.unfade()}),delay)})),camera.focusOn(level.units[1]),hero=null,window.requestAnimationFrame(e)}camera=new Camera,music=new Music,s()}))</script>