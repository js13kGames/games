<!doctype html><title>Lucky 13 - js13kgames 2012</title><style>body{overflow:hidden}#controls button{width:4em;height:4em}body{text-align:center}a{text-decoration:none;display:block}</style><div id=controls></div><canvas id=canvas width=640 height=480></canvas><script>function c(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,function(){n(window.event)})}function z(e){var t=e.keyCode,n=(g[t]=!0,a[t]);n&&n(t),(n||y[t])&&e.preventDefault()}function V(e){e=e.keyCode,g[e]=!1}function n(e){return"string"==typeof e?e.toUpperCase().charCodeAt():e}function B(){for(var e=0;e<g.length;e++)g[e]=!1}function h(e,t){a[n(e)]=t}function f(e,t){y[n(e)]=t}function u(e){return k(e*r)}function d(e,t){var n=document.createElement("button");n.innerHTML=e,n.onclick=t,document.getElementById("controls").appendChild(n)}function l(e){function t(e){n(),a=e}function n(){i.push([a+12*r,o,s]),o=.15,s=.5}for(var i=[],a=0,r=3,o=.15,s=.5,u=0;u<e.length;u++)switch(e[u]){case"a":t(0);break;case"A":t(1);break;case"b":t(2);break;case"c":t(3);break;case"C":t(4);break;case"d":t(5);break;case"D":t(6);break;case"e":t(7);break;case"f":t(8);break;case"F":t(9);break;case"g":t(10);break;case"G":t(11);break;case"r":t(0),s=0;break;case"0":r=0;break;case"1":r=1;break;case"2":r=2;break;case"3":r=3;break;case"4":r=4;break;case"5":r=5;break;case"6":r=6;break;case"7":r=7;break;case"*":o*=2;break;case"/":o*=.5;break;case".":o*=1.5;break;case"!":s=1;break;case",":s=.25}return n(),i.shift(),i}function w(e,t){for(out=[],i=0;i<e;i++)out=out.concat(t);return out}function s(e){var t,n,i=e-Z,a=(Z=e,i);for(n in y)g[n]&&y[n](n,a);e=i;var r=-.01*A(I);++N>=U.length&&(N=0),(M+=2)>=U.length&&(M=0),T()<.003*e&&(t={x:T(),y:-.1},E.push(t),T()<.3)&&E.push({x:t.x+.2*(T()-.5),y:t.y-.1*T()});for(var o=0;o<E.length;o++)(t=E[o]).y+=.01,t.x+=r,.85<t.y&&t.y<.95&&.5-2*R<t.x&&t.x<.5+2*R&&(P++,sfx.point.play(),13<P&&(v(),O=function(){p(20,-10,"#b00","BUSTED"),p(14,10,"#b00","OVER 13"),m(),music.pause(),sfx.lose.play()},cancelAnimFrame(S)),E.splice(o,1)),1.1<t.y&&E.splice(o,1);music.ended&&(v(),O=13==P?function(){p(40,0,"#fff","WIN"),m()}:function(){p(20,-10,"#b00","TIME UP"),p(14,10,"#b00","SCORE: "+P),m(),sfx.lose.play()},cancelAnimFrame(S)),j(),H(),D&&requestAnimFrame(s)}function j(){function e(e){W.beginPath(),W.moveTo(0,21),W.lineTo(14,58),W.bezierCurveTo(57,69,55,126,46,167),W.bezierCurveTo(151,195,253,124,264,-3),W.bezierCurveTo(301,23,359,101,348,206),W.bezierCurveTo(337,311,276,450,16*U[N]+276,450),W.lineTo(226,333),W.lineTo(12*e*U[M]+212,494),W.lineTo(172,378),W.lineTo(15*e*U[M]+132,526),W.lineTo(74,402),W.bezierCurveTo(74,402,38,431,36,486),W.bezierCurveTo(36,569,72,595,15*U[N]+106,680),W.lineTo(46,633),W.lineTo(10*-e*U[M]+24,683),W.lineTo(0,633),W.fill()}W.setTransform(1,0,0,1,0,0),W.globalCompositeOperation="source-atop",W.fillStyle="rgba(0,160,0, 0.5)",W.fillRect(0,0,q,L),W.fillStyle="#444";for(var t=0;t<E.length;t++){var n=W,i=(a=E[t]).x*q,a=a.y*L,r=L*R;n.beginPath(),n.moveTo(i,a),n.arc(i,a,r,0,J),n.fill()}W.fillStyle="#000",W.save();var o=ee*q/700;W.translate(q/2,L*(1-.8*ee)),W.scale(o,o),W.rotate(I),W.translate(0,-300),e(1),W.scale(-1,1),e(-1),W.restore()}function H(){O&&O()}function t(){W.setTransform(1,0,0,1,0,0),W.fillStyle="#090",W.fillRect(0,0,q,L)}function p(e,t,n,i){var a=Math.min(q/2,L)/60,r=q/2;t=L/2+t*a,W.fillStyle=n,W.font=e*a+"px bold terminus,terminal,monospace",W.textAlign="center",W.textBaseline="middle",W.fillText(i,r,t)}function m(){D=e=!1,E=[],I=P=0}function X(){e&&((D=!D)?(O=null,music.play(),S=requestAnimFrame(s)):(O=function(){p(20,0,"yellow","PAUSED")},music.pause(),cancelAnimFrame(S)))}function Y(){D||(t(),m(),D=e=!0,O=null,music.currentTime=0,music.currentTime=0,music.play(),S=requestAnimFrame(s))}function v(){D=!1}function G(e,t){-$<I&&(I-=_)}function K(e,t){I<$&&(I+=_)}function b(e,t,n,i){this.voices=[],this.seconds=e,this.noteLength=t||.25,this.temperamentName=n||Object.keys(Q)[0],this.volume=i||1;var a=Q[this.temperamentName];this.tuning=[];for(var r=55,o=0;o<6;o++){for(var s=0;s<12;s++)this.tuning.push(r*a[s]);r*=2}}var y={},a={},g=[],k=Math.floor,o=Math.pow,A=Math.sin,T=Math.random,J=2*Math.PI,C=44100,r=o(2,16)-1,Q={"qc-meantone":[1,1.0449,1.118,1.1963,1.25,1.3375,1.3975,1.4953,1.5625,1.6719,1.7889,1.8692]},x=((b.prototype=Object.create(Object.prototype)).mixdown=function(){for(var e=this.voices.length,t=new x(this),n=[],i=0;i<=e;i++)n.push(new Int16Array(this.voices[i].w,44));for(i=0;i<t.nSamples;i++){for(var a=0,r=0;r<e;r++)a+=n[r][i];n[e][i]=a/e}return t},function(e,t,n,i){(this.parent=e).voices.push(this),this.waveform=t||"saw",this.noteLength=n||e.noteLength,this.volume=(i||1)*e.volume,this.seconds=e.seconds,this.nSamples=this.seconds*C,this.audioLength=2*this.nSamples,this.byteLength=44+this.audioLength,this.w=new ArrayBuffer(this.byteLength),this.wb=new Uint8Array(this.w),this.ww=new DataView(this.w),this.pos=0,this.ds("RIFF"),this.d4(this.byteLength-8),this.ds("WAVE"),this.ds("fmt "),this.d4(16),this.d2(1),this.d2(1),this.d4(C),this.d4(2*C),this.d2(2),this.d2(16),this.ds("data"),this.d4(this.audioLength)});x.prototype=Object.create(Object.prototype),x.prototype.d1=function(e){this.ww.setUint8(this.pos,e),this.pos+=1},x.prototype.d2=function(e){this.ww.setUint16(this.pos,e,!0),this.pos+=2},x.prototype.d4=function(e){this.ww.setUint32(this.pos,e,!0),this.pos+=4},x.prototype.ds=function(e){for(var t=0;t<e.length;t++)this.ww.setUint8(this.pos++,e.charCodeAt(t))},x.prototype.renderNotes=function(e){for(var t=0;t<e.length;t++){var n=e[t],i=this.noteLength;if(null==n)this.rest(i);else switch(this.waveform){case"saw":this.sawWave(this.parent.tuning[n],i,.2);break;case"sine":this.sineWave(this.parent.tuning[n],i,.2);break;case"square":this.squareWave(this.parent.tuning[n],i,.2);break;case"snare":this.snareWave(this.parent.tuning[n],i,.2)}}},x.prototype.renderNotesPDV=function(e){for(var t=0;t<e.length;t++){var n=e[t],i=n[0],a=n[1],r=n[2]*this.volume;if(0==r)this.rest(a);else switch(this.waveform){case"saw":this.sawWave(this.parent.tuning[i],a,r);break;case"sine":this.sineWave(this.parent.tuning[i],a,r);break;case"square":this.squareWave(this.parent.tuning[i],a,r);break;case"snare":this.snareWave(this.parent.tuning[i],a,r)}}},x.prototype.rest=function(e){for(var t=k(C*e),n=0;n<t;n++)this.d2(0)},x.prototype.squareWave=function(e,t,n){for(var i=[],a=k(C/e/2),r=0;r<a;r++)i.push(u(0));for(r=0;r<a;r++)i.push(u(n));this.renderWave(i,t)},x.prototype.renderWave=function(e,t){t=C*t/e.length;for(var n=k(t),i=n;0<i;i--)for(var a=0;a<e.length;a++)this.d2(e[a]);t=k((t-n)*e.length),this.rest(t/C)},x.prototype.sawWave=function(e,t,n){for(var i=[],a=k(C/e),r=0;r<a;r++)i.push(u(n*r/a-n/2));this.renderWave(i,t)},x.prototype.sineWave=function(e,t,n){for(var i=[],a=k(C/e),r=J/a,o=0;o<a;o++){var s=A(o*r)*n;i.push(u(s))}this.renderWave(i,t)},x.prototype.snareWave=function(e,t,n){for(var i=k(C*t),a=0;a<i;a++){var r=T()*o(1-a*(1/i),2)*n;this.d2(u(r))}},x.prototype.asDataURI=function(){strbuf="";for(var e=0;e<this.wb.length;e++)strbuf+=String.fromCharCode(this.wb[e]);return"data:audio/wav;base64,"+escape(btoa(strbuf))},window.onload=function(){function n(t){return function(){var e=new Audio(sfx[t].src);e.volume=.5,e.play()}}var e,t,i,a,r;c(document,"keydown",z),c(document,"keyup",V),c(window,"focus",B),h(80,X),h(81,v),h(27,v),h(32,Y),f(37,G),f(39,K),f(90,G),f(88,K),window.music=new Audio((e=w(2,l("2dad f*. d*.  fdf a3*.f2*.  a3f2a3 c.*a*.  f2a3f2 a3*.f2*.")),t=w(8,l("1d*r d* rd*r")),i=w(8,l("ddd  d!*rd*r")),r=new b(r=function(e){for(var t=0,n=0;n<e.length;n++){var i=function(e){for(var t=0,n=0;n<e.length;n++)t+=e[n][1];return t}(e[n]);t<i&&(t=i)}return t}([e,t,a=w(8,l("1d*. 0d!*. 0d*r")),i]),.1,null,.4),new x(r,"sine",1,.8).renderNotesPDV(e),new x(r,"saw",1,.5).renderNotesPDV(t),new x(r,"snare",1,.8).renderNotesPDV(i),new x(r,"sine",1,.8).renderNotesPDV(a),r.mixdown().asDataURI())),music.load(),window.sfx=[],window.newSFX=function(e){var t=sfx.length;sfx.push(new Audio(e)),e=n(t),h(t=String.fromCharCode(49+t),e),d(t,e)};for(var o=0;o<sfx.length;o++){var s=n(o),u=String.fromCharCode(49+o);h(u,s),d(u,s)}e=new b(.2,null,null,.5),(t=new x(e,"square")).renderNotesPDV([[36,.03,.3],[43,.03,.4],[48,.05,.5]]),window.sfx.point={audio:new Audio(t.asDataURI()),play:function(){new Audio(this.audio.src).play()}},e=new b(.4,null,null,.5),(t=new x(e,"saw")).renderNotesPDV([[0,.4,.5]]),window.sfx.lose={audio:new Audio(t.asDataURI()),play:function(){new Audio(this.audio.src).play()}},window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame,window.requestAnimFrame&&(window.cancelAnimFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame,F=document.getElementById("canvas"),W=F.getContext("2d"),m(),O=function(){p(20,-15,"#bbb","LUCKY 13"),p(8,0,"#bbb","COLLECT EXACTLY"),p(8,8,"#bbb","13 POINTS TO WIN"),p(10,20,"#bbb","SPACE BAR = START")},onresize())};for(var F,W,S,q,L,D,e,E,P,I,Z=0,$=.7,_=.04,ee=.15,R=.015,U=[],N=0,M=5,i=0;i<2*Math.PI;i+=Math.PI/15)U.push(A(i));var O=null;window.onresize=function(){q=window.innerWidth-40,L=window.innerHeight-2*F.offsetTop,q=Math.min(q,4*L/3),F.width=q,F.height=L,D||(t(),e&&j(),H())}</script>