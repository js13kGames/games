function SimplexNoise(){function u(e,t,n){return e.X*t+e.Y*n}function a(t,n,r,i){return t<0?0:Math.pow(t,4)*u(e[n],r,i)}var e=[bt.Vector(1,1),bt.Vector(-1,1),bt.Vector(1,-1),bt.Vector(-1,-1),bt.Vector(1,0),bt.Vector(-1,0),bt.Vector(1,0),bt.Vector(-1,0),bt.Vector(0,1),bt.Vector(0,-1),bt.Vector(0,1),bt.Vector(0,-1)],t=[],n=[],r=[],i,s=.5*(Math.sqrt(3)-1),o=(3-Math.sqrt(3))/6;for(i=0;i<512;i++)t.push(Math.floor(Math.random()*255)),n.push(t[i&255]),r.push(n[i]%12);this.noise=function(e,t){var i=(e+t)*s,u=e+i|0,f=t+i|0,l=(u+f)*o,c=e-(u-l),h=t-(f-l),p,d,v,m,g,y,b,w,E,S,x,T;return c>h?(p=1,d=0):(p=0,d=1),v=c-p+o,g=h-d+o,m=c-1+2*o,y=h-1+2*o,b=u&255,w=f&255,E=r[b+n[w]],S=r[b+p+n[w+d]],x=r[b+1+n[w+1]],T=a(.5-c*c-h*h,E,c,h)+a(.5-v*v-g*g,S,v,g)+a(.5-m*m-y*y,x,m,y),70*T}}function gameView(e,t){var n=e-e%32+32,r=t-t%32+32,i=makeCanvas(n,r),s=[bt.Color("#152568"),bt.Color("#CCE010"),bt.Color("#E6DFC8"),bt.Color("#7A6212"),bt.Color("#00e17f")];gameView.canvas=i.canvas,gameView.context=i.context,gameView.width=n,gameView.height=r;var o=[procedural.terrain(tileSize,s[0]),procedural.terrain(tileSize,s[1]),procedural.terrain(tileSize,s[2]),procedural.terrain(tileSize,s[2]),procedural.terrain(tileSize,s[4])];o[3].getContext("2d").drawImage(procedural.noise(tileSize,10,12,s[1],6),0,0),game.map=ts.TileSet(o,procedural.noiseMap(128,128,40,4),gameView.canvas,n,r),game.mousePosition=bt.Vector(0,0),game.root.add(gameView),game.map.draw(),setInterval(gameView.scrollHandler,32)}function makeCanvas(e,t){var n=document.createElement("canvas");return n.width=e,n.height=t,{canvas:n,context:n.getContext("2d")}}function startGame(e){game.init(e),game.players.push(Player(10,10,Player.modes.LOCAL)),game.players.push(Player(100,100,Player.modes.AI)),game.run()}var art={open:function(e,t){game.context.save(),game.context.fillStyle=e,game.context.strokeStyle=t},body:function(e){game.context.rotate(e),game.context.fillRect(-8,-16,16,32),game.context.strokeRect(-8,-16,16,32)},box:function(e){e?(game.context.fillRect(-16,-16,64,64),game.context.strokeRect(-16,-16,64,64)):(game.context.fillRect(-16,-16,32,32),game.context.strokeRect(-16,-16,32,32))},tank:function(e,t,n,r,i,s,o){art.open(n,r),o?game.context.translate(e+tileSize/2,t+tileSize/2):game.context.translate(e-game.map.offset.X*tileSize+tileSize/2,t-game.map.offset.Y*tileSize+tileSize/2),art.body(i),s!==0&&(game.context.rotate(-i),game.context.rotate(s)),game.context.fillRect(-2,-16,4,24),game.context.strokeRect(-2,-16,4,24),game.context.fillRect(-5,-5,10,10),game.context.strokeRect(-5,-5,10,10),game.context.restore()},heavyTank:function(e,t,n,r,i,s,o){art.open(n,r),o?game.context.translate(e+tileSize/2,t+tileSize/2):game.context.translate(e-game.map.offset.X*tileSize+tileSize/2,t-game.map.offset.Y*tileSize+tileSize/2),art.body(i),s!==0&&(game.context.rotate(-i),game.context.rotate(s)),game.context.fillRect(-6,-16,4,24),game.context.strokeRect(-6,-16,4,24),game.context.fillRect(-5,-5,10,10),game.context.strokeRect(-5,-5,10,10),game.context.fillRect(2,-16,4,24),game.context.strokeRect(2,-16,4,24),game.context.fillRect(-5,-5,10,10),game.context.strokeRect(-5,-5,10,10),game.context.restore()},factory:function(e,t,n,r,i,s,o){var u=[[{X:-12,Y:3},{X:11,Y:3}],[{X:10,Y:3},{X:10,Y:-1}],[{X:10,Y:-1},{X:-12,Y:-1}],[{X:-12,Y:-1},{X:-12,Y:3}],[{X:-6,Y:-1},{X:-6,Y:-5}],[{X:-6,Y:-5},{X:2,Y:-5}],[{X:2,Y:-5},{X:2,Y:-1}],[{X:2,Y:-4},{X:14,Y:-4}],[{X:13,Y:-3},{X:2,Y:-3}],[{X:-11,Y:2},{X:-13,Y:5}],[{X:-13,Y:5},{X:-10,Y:7}],[{X:-10,Y:7},{X:10,Y:7}],[{X:10,Y:6},{X:12,Y:5}],[{X:12,Y:5},{X:11,Y:3}]];art.open(n,r),o?game.context.translate(e+tileSize/2,t+tileSize/2):game.context.translate(e-game.map.offset.X*tileSize+tileSize/2,t-game.map.offset.Y*tileSize+tileSize/2),art.box(!o),art.lines(u),game.context.restore()},turret:function(e,t,n,r,i,s,o){art.open(n,r),o?game.context.translate(e+tileSize/2,t+tileSize/2):game.context.translate(e-game.map.offset.X*tileSize+tileSize/2,t-game.map.offset.Y*tileSize+tileSize/2),game.context.rotate(i),art.box(),s!==0&&(game.context.rotate(-i),game.context.rotate(s)),game.context.fillRect(-4,-20,8,32),game.context.strokeRect(-4,-20,8,32),game.context.fillRect(-10,-10,20,20),game.context.strokeRect(-10,-10,20,20),game.context.restore()},sell:function(e,t,n,r,i,s,o){art.open(n,r),game.context.translate(e+tileSize/2,t+tileSize/2),art.box(),game.context.lineWidth=4,game.context.font="20px Arial Unicode MS, Arial",game.context.textAlign="center",game.context.fillStyle="yellow",game.context.strokeText("$",0,6),game.context.fillText("$",0,6),game.context.restore()},mine:function(e,t,n,r,i,s,o){var u=[[{X:-13,Y:-13},{X:14,Y:-13}],[{X:13,Y:-13},{X:13,Y:15}],[{X:13,Y:15},{X:7,Y:-7}],[{X:7,Y:-7},{X:-12,Y:-13}],[{X:6,Y:-7},{X:-14,Y:12}],[{X:-14,Y:12},{X:-10,Y:15}],[{X:-10,Y:14},{X:7,Y:-6}]];art.open(n,r),o?game.context.translate(e+tileSize/2,t+tileSize/2):(game.context.translate(e-game.map.offset.X*tileSize+tileSize/2,t-game.map.offset.Y*tileSize+tileSize/2),game.buildMode&&game.buildMode===def.mine&&(game.context.globalAlpha=.3,game.context.fillRect(-160,-160,320,320),game.context.globalAlpha=1)),art.box(),art.lines(u),game.context.restore()},hydroplant:function(e,t,n,r,i,s,o){var u=[[{X:-13,Y:0},{X:-4,Y:-10}],[{X:-4,Y:-10},{X:2,Y:0}],[{X:2,Y:0},{X:9,Y:-10}],[{X:-12,Y:7},{X:-4,Y:-2}],[{X:-4,Y:-2},{X:2,Y:7}],[{X:2,Y:7},{X:9,Y:-2}]];art.open(n,r),o?game.context.translate(e+tileSize/2,t+tileSize/2):(game.context.translate(e-game.map.offset.X*tileSize+tileSize/2,t-game.map.offset.Y*tileSize+tileSize/2),game.buildMode&&game.buildMode===def.hydroplant&&(game.context.globalAlpha=.5,game.context.fillRect(-160,-160,320,320),game.context.globalAlpha=1)),art.box(),art.lines(u),game.context.restore()},powerplant:function(e,t,n,r,i,s,o){var u=[[{X:-1,Y:-3},{X:11,Y:-2}],[{X:11,Y:-2},{X:-10,Y:10}],[{X:-10,Y:10},{X:1,Y:0}],[{X:1,Y:0},{X:-13,Y:-2}],[{X:-13,Y:-2},{X:10,Y:-10}],[{X:10,Y:-10},{X:-1,Y:-3}]];art.open(n,r),o?game.context.translate(e+tileSize/2,t+tileSize/2):game.context.translate(e-game.map.offset.X*tileSize+tileSize/2,t-game.map.offset.Y*tileSize+tileSize/2),art.box(),art.lines(u),game.context.restore()},lines:function(e){game.context.beginPath();for(var t=0;t<e.length;t++)game.context.moveTo(e[t][0].X,e[t][0].Y),game.context.lineTo(e[t][1].X,e[t][1].Y);game.context.stroke()}},def={tank:{name:"tank",mobile:!0,health:100,damage:10,range:5,art:art.tank,loadTime:1e3,moveDuration:400,cost:100},heavyTank:{name:"heavy tank",mobile:!0,health:200,damage:15,range:6,art:art.heavyTank,loadTime:1500,moveDuration:600,cost:200},turret:{name:"turret",mobile:!1,health:120,damage:40,range:7,art:art.turret,loadTime:700,upkeep:-50,cost:100,collision:3},mine:{name:"mining station",mobile:!1,health:100,range:7,upkeep:-100,cost:150,income:10,art:art.mine,terrain:3,collision:3},powerplant:{name:"powerplant",mobile:!1,health:100,range:7,upkeep:150,cost:50,art:art.powerplant,collision:3},hydroplant:{name:"hydroplant",mobile:!1,health:100,range:7,upkeep:800,cost:500,art:art.hydroplant,terrain:0,collision:3},factory:{name:"tank factory",mobile:!1,health:1e3,art:art.factory,factory:!0,range:5,collision:3,cost:150,upkeep:-100,big:!0}},pathFinder=function(){var e=[],t=16,n=[],r=!1;for(var i=0;i<t;i++)e.push(new Worker("js/astar.js"));return{find:function(t,r,i){e.length>0?function(t,r,i,s){t.postMessage({collisionMap:game.collisionMap,x1:r.X,y1:r.Y,x2:i.X,y2:i.Y}),t.onmessage=function(r){s(r.data),e.push(t);if(n.length>0){var i=n.shift();pathFinder.find(i.start,i.end,i.cb)}}}(e.shift(),t,r,i):n.push({start:t,end:r,cb:i})}}}(),Events={attach:function(e){var t={},n={on:function(e,n){t[e]||(t[e]=[]),t[e].push(n)},fire:function(e,n){if(t[e])for(var r=0;r<t[e].length;r++)t[e][r](n)}};for(prop in n)e[prop]=n[prop]}},ns={};ns.Pooled=function(){"use strict";var e={},t=function(t){return e[t]?e[t].shift():null},n=function(t){return e[t]},r=function(){return{release:function(){if(!this.type)throw"Cannot release to pool: object has no type property.";e[this.type]||(e[this.type]=[]),e[this.type].push(this)}}};return r.pull=t,r.available=n,r}(),ns.Node=function(){"use strict";var e=ns.Pooled.pull("node");if(!e){var t=[];e=Object.create(ns.Pooled(),{visible:{value:!0,enumerable:!0,configurable:!0},each:{value:function(e){for(var n=0;n<t.length;n++)e.apply(t[n])},enumerable:!0},get:{value:function(e){return t[e]}},clear:{value:function(){t.length=0}},add:{value:function(n){t.push(n),n.parent=e},enumerable:!0},remove:{value:function(e){var n=t.indexOf(e);n!==-1&&t.splice(n,1)},enumerable:!0},up:{get:function(){return Object.getPrototypeOf(this)}},length:{get:function(){return t.length}}})}return e};var bt={};bt.Vector=function(e,t){"use strict";var n=ns.Pooled.pull("vector");return n||(n=Object.create(ns.Pooled(),{shallow:{value:function(){return{X:n.X,Y:n.Y}}},add:{value:function(e){return bt.Vector(n.X+e.X,n.Y+e.Y)}},subtract:{value:function(e){return bt.Vector(n.X-e.X,n.Y-e.Y)}},multiply:{value:function(e){return bt.Vector(n.X*e.X,n.Y*e.Y)}},divide:{value:function(e){return bt.Vector(n.X/e.X,n.Y/e.Y)}},is:{value:function(e){return n.X===e.X&&n.Y===e.Y}},isInside:{value:function(e){return n.X>e[0]&&n.X<e[0]+e[2]&&n.Y>e[1]&&n.Y<e[1]+e[3]}},distanceTo:{value:function(e){var t=Math.abs(n.X-e.X),r=Math.abs(n.Y-e.Y);return Math.sqrt(Math.pow(t,2)+Math.pow(r,2))}},type:{value:"vector"}})),n.X=e||0,n.Y=t||0,n},bt.Vec={distance:function(e,t){var n=Math.abs(e.X-t.X),r=Math.abs(e.Y-t.Y);return Math.sqrt(Math.pow(n,2)+Math.pow(r,2))}},bt.Color=function(e){"use strict";var t,n,r;return e[0]==="#"&&(e.length===4?(t=(parseInt(e[1],16)+1)*16,n=(parseInt(e[2],16)+1)*16,r=(parseInt(e[3],16)+1)*16):(t=parseInt(e.substr(1,2),16)+1,n=parseInt(e.substr(3,2),16)+1,r=parseInt(e.substr(5,2),16)+1)),Object.create(ns.Pooled(),{array:{get:function(){return[t,n,r]},set:function(e){t=e[0],n=e[1],r=e[2]}},red:{get:function(){return t},set:function(e){t=e}},green:{get:function(){return n},set:function(e){n=e}},blue:{get:function(){return r},set:function(e){r=e}},toString:{value:function(){return"rgba("+t+","+n+","+r+",1.0)"}},mul:{value:function(e){var i=bt.Color("#FFF");return i.red=t*e|0,i.green=n*e|0,i.blue=r*e|0,i}},type:{value:"color"}})};var ts={};ts.pickTile=function(e,t,n){var r=e[t][n];return r},ts.collisionDebug=function(){if(game.map.offset){var e=bt.Vector(800/tileSize,800/tileSize),t=game.map.offset.add(e);for(var n=game.map.offset.X;n<t.X;n++)for(var r=game.map.offset.Y;r<t.Y;r++)if(game.collisionMap[n][r]!=0){var i="rgba(255, 0, 0, 0.5)";game.collisionMap[n][r]===collision.RESERVED&&(i="rgba(0, 0, 255, 0.5)"),game.context.fillStyle=i,game.context.fillRect((n-game.map.offset.X)*tileSize,(r-game.map.offset.Y)*tileSize,tileSize,tileSize)}t.release()}},ts.TileSet=function(e,t,n,r,i){console.log(e);var s=t.length,o=bt.Vector(r/tileSize,i/tileSize),u=n.getContext("2d"),a=["#152568","#CCE010","#E6DFC8","#7A6212"],f=Object.create(ns.Node(),{at:{value:function(e,t){return bt.Vector(e/tileSize+f.offset.X|0,t/tileSize+f.offset.Y|0)}},width:{value:t.length},height:{value:t[0].length},at:{value:function(e,t){return bt.Vector((e/tileSize|0)+game.map.offset.X,(t/tileSize|0)+game.map.offset.Y)}},horizontal:{value:function(r){u.drawImage(n,tileSize*r,0),f.offset.X-=r;for(var i=0+f.offset.Y;i<f.offset.Y+o.Y;i++){var s=(r<0?o.X:0)+f.offset.X-(r<0?1:0),a=e[ts.pickTile(t,s,i)];a&&u.drawImage(a,(s-f.offset.X)*tileSize,(i-f.offset.Y)*tileSize)}}},vertical:{value:function(r){u.drawImage(n,0,tileSize*r),f.offset.Y-=r;for(var i=0+f.offset.X;i<f.offset.X+o.X;i++){var s=(r<0?o.Y:0)+f.offset.Y-(r<0?1:0),a=e[ts.pickTile(t,i,s)];a&&u.drawImage(a,(i-f.offset.X)*tileSize,(s-f.offset.Y)*tileSize)}}},draw:{value:function(){if(f.offset){var n=f.offset.add(o);for(var r=f.offset.X;r<n.X;r++)for(var i=f.offset.Y;i<n.Y;i++)u.drawImage(e[ts.pickTile(t,r,i)],(r-f.offset.X)*tileSize,(i-f.offset.Y)*tileSize);n.release()}}},drawMini:{value:function(){var e=document.createElement("canvas");e.width=128,e.height=128;var n=e.getContext("2d");if(f.offset){var r=f.offset.add(o);for(var i=0;i<128;i++)for(var s=0;s<128;s++)n.fillStyle=a[t[i][s]],n.fillRect(i,s,1,1);r.release()}return e}},map:{value:t}});for(var l=0;l<t.length;l++){game.collisionMap[l]=new Uint8Array(t[0].length);for(var c=0;c<t[0].length;c++)ts.pickTile(t,l,c)===0?game.collisionMap[l][c]=collision.UNPASSABLE:game.collisionMap[l][c]=collision.PASSABLE}return f.offset=bt.Vector(0,0),f};var procedural={};procedural.terrain=function(e,t){var n=makeCanvas(e,e);n.context.fillStyle=t.toString(),n.context.fillRect(0,0,e,e),t=t.mul(.8),n.context.fillStyle=t.toString();for(var r=0;r<128;r++){var i=Math.random()*e|0,s=Math.random()*e|0;n.context.fillRect(i,s,Math.random()*4|0,Math.random()*4|0)}return n.canvas},procedural.terrainltr=function(e,t,n){var r=makeCanvas(e,e),i=r.context.createLinearGradient(0,e/2,e,e/2);return i.addColorStop(0,n.toString()),i.addColorStop(1,t.toString()),r.context.fillStyle=i,r.context.fillRect(0,0,e,e),r.canvas},procedural.noise=function(e,t,n,r,i){var s=t||10,o=new SimplexNoise,u=makeCanvas(e,e),a=u.context.createImageData(e,e),f=r||bt.Color("#11A600"),l=n||3;for(var c=0;c<e;c++)for(var h=0;h<e;h++){var p=parseInt((o.noise(c/s,h/s)+1)/2*l,10)*(256/l);a.data[c*4+h*e*4]=f.red/255*p,a.data[c*4+h*e*4+1]=f.green/255*p,a.data[c*4+h*e*4+2]=f.blue/255*p,a.data[c*4+h*e*4+3]=255,i&&p<160&&(a.data[c*4+h*e*4+3]=0)}return u.context.putImageData(a,0,0),u.canvas},procedural.noiseMap=function(e,t,n,r){var i=[],s=new SimplexNoise;for(var o=0;o<e;o++){i[o]=new Uint8Array(t);for(var u=0;u<t;u++)i[o][u]=parseInt((s.noise(o/n,u/n)+1)/2*r,10)}return i},procedural.spiral=function(e){if(e==0)return{X:0,Y:0};var t=(Math.sqrt(e)+1)/2|0,n=(e-Math.pow(2*t-1,2))/(2*t)|0,r=(e-Math.pow(2*t-1),2)-2*t*n-t+1,i=n===0?t:n===1?-r:n===2?-t:r,s=n===0?r:n===1?t:n===2?-r:-t;return{X:i,Y:s}},gameView.draw=function(){game.context.drawImage(gameView.canvas,0,0)},gameView.scrollHandler=function(){if(!game.map||ui.has(game.mousePosition.X,game.mousePosition.Y))return;game.mousePosition.X<tileSize*2&&game.map.offset.X>0&&game.map.horizontal(1),game.mousePosition.X>gameView.width-tileSize*2&&game.map.offset.X<game.map.width-gameView.width/tileSize&&game.map.horizontal(-1),game.mousePosition.Y<tileSize*2&&game.map.offset.Y>0&&game.map.vertical(1),game.mousePosition.Y>game.canvas.height-tileSize*2&&game.map.offset.Y<game.map.height-(game.canvas.height/tileSize+.5|0)&&game.map.vertical(-1)};var Bullet=function(e,t,n){var r=e.X,i=e.Y,s=bt.Vec.distance(e,t),o=s/tileSize*100,u=(t.X-e.X)/o,a=(t.Y-e.Y)/o,f=(new Date).getTime(),l=n/4,c={draw:function(){game.context.save(),game.context.translate(r-game.map.offset.X*tileSize+tileSize/2,i-game.map.offset.Y*tileSize+tileSize/2),game.context.fillStyle="#FF0000",game.context.fillRect(-1*(l/2),-1*(l/2),l,l),game.context.restore(),c.update()},update:function(){var s=(new Date).getTime()-f;r=e.X+u*s,i=e.Y+a*s;if(s>o){game.root.remove(c);var l=game.unitAt({X:t.X/tileSize|0,Y:t.Y/tileSize|0});l&&l.hit(n)&&c.owner.kill()}}};return c},Unit=function(e,t,n,r){var i=e*tileSize,s=t*tileSize,o=0,u=0,a=n,f=0,l=0,c=0,h=r.health||100,p=r.loadTime||null,d=Unit.GUARD,v=r.collision||collision.UNIT,m=r.moveDuration||100,g=[],y=r.range||5,b=!1,w=0,E=function(n,r,o){e=n,t=r,i=n*tileSize,s=r*tileSize;if(o){if(game.collisionMap[e][t]===v)return x.go(game.spiral(2,{X:e,Y:t})[1],!0),!0;game.collisionMap[e][t]=v}return!1},S=function(e){g=e,w=(new Date).getTime(),g.length===0&&console.log("no path!")},x={mobile:r.mobile,target:null,targetUnit:null,art:r.art,name:r.name,badge:"",team:0,dead:!1,factory:r.factory,get spec(){return r},get idle(){return g.length===0&&!x.target},get health(){return h},select:function(){b=!0},deselect:function(){b=!1},draw:function(){r.art(i,s,a.toString(),b?"yellow":"black",o,u),x.badge!==""&&(game.context.fillStyle="black",game.context.font="10px Dejavu Sans, Arial",game.context.textAlign="left",game.context.fillText(x.badge,i-game.map.offset.X*tileSize,s-game.map.offset.Y*tileSize)),this.update()},die:function(){x.dead||(x.dead=!0,x.owner.deaths++,r.upkeep&&(x.owner.energy-=r.upkeep),game.collisionMap[e][t]=collision.PASSABLE,r.big&&(game.collisionMap[e][t+1]=collision.PASSABLE,game.collisionMap[e+1][t]=collision.PASSABLE,game.collisionMap[e+1][t+1]=collision.PASSABLE),x.ondeath&&x.ondeath(r))},hit:function(e){return h-=e,!x.dead&&h<0?(x.die(),!0):!1},isInside:function(e,t){var n=game.map.offset.X*tileSize,r=game.map.offset.Y*tileSize;return t&&(n=0,r=0),i>e[0]+n&&i<e[0]+n+e[2]&&s>e[1]+r&&s<e[1]+r+e[3]},attack:function(e){x.targetUnit=e},go:function(n,i){r.mobile?(game.collisionMap[n.X][n.Y]!==collision.PASSABLE&&(n=game.spiral(1,n)[0]),game.collisionMap[n.X][n.Y]===collision.PASSABLE&&(i||(game.collisionMap[e][t]=collision.PASSABLE),pathFinder.find({X:e,Y:t},n,S))):x.rallyPoint=n},click:function(e,t){var n=i-game.map.offset.X*tileSize,o=s-game.map.offset.Y*tileSize,u=r.big?64:32;return e>n&&e<n+u&&t>o&&t<o+u?(x.fire("click"),!0):!1},update:function(){x.owner.energy<0&&!r.mobile?x.badge="⚡":x.badge=""+(x.team>0?x.team:"");if(r.income){var n=(new Date).getTime();n-c>1e3&&x.owner.energy>=0&&(x.owner.credits+=r.income,c=n)}if(r.mobile)if(g.length>0){curTime=(new Date).getTime()-w;if(curTime>m){var a=g.shift();E(a.X,a.Y,g.length===0),w=(new Date).getTime(),g.length>0&&game.collisionMap[g[0].X][g[0].Y]===collision.STRUCTURE&&x.go(g[g.length-1])}else{var l=g[0].X*tileSize,h=g[0].Y*tileSize,d=e*tileSize,v=t*tileSize,b=l-d,S=h-v,T=parseFloat(curTime)/parseFloat(m);i=d+T*b|0,s=v+T*S|0,o=Math.atan2(g[0].X-e,t-g[0].Y)}}else if(x.targetUnit&&!x.targetUnit.dead&&bt.Vec.distance(x.targetUnit.tile,x.tile)>y){var a=game.spiral(1,x.targetUnit.tile)[0];x.go(a)}if(r.loadTime&&!(!r.mobile&&x.owner.energy<0)){rangeBox=[i-y*tileSize,s-y*tileSize,y*2*tileSize,y*2*tileSize],x.target=null,game.units.each(function(){this.owner.id!==x.owner.id&&this.isInside(rangeBox,!0)&&(x.target=this.position)});var n=(new Date).getTime();if(x.target){u=Math.atan2(x.target.X-i,s-x.target.Y);if(n-f>p){var N=Bullet({X:i,Y:s},x.target,r.damage||10);N.owner=x,game.root.add(N),f=n}}else u=0}},kill:function(){l++,x.owner.kills++}};return Object.defineProperty(x,"position",{get:function(){return{X:i,Y:s}}}),Object.defineProperty(x,"tile",{get:function(){return{X:e,Y:t}}}),Object.defineProperty(x,"percent",{get:function(){return h/r.health}}),Object.defineProperty(x,"kills",{get:function(){return l}}),game.collisionMap[e][t]=v,r.big&&(game.collisionMap[e][t+1]=v,game.collisionMap[e+1][t]=v,game.collisionMap[e+1][t+1]=v),Events.attach(x),x};Unit.GUARD=0,Unit.AGRESSIVE=1,Unit.CEASEFIRE=0;var ui={topline:30,minimapImage:null,hudPosition:{X:10,Y:10},hudSize:{W:512,H:160},alpha:1,actionButtons:[],tooltips:[],buildables:[def.mine,def.powerplant,def.turret,def.factory],unitBuildables:[def.tank,def.heavyTank],modalMessage:"",alertMessage:{time:0,text:""},minimapUnits:function(){var e=document.createElement("canvas");return e.width=128,e.height=128,{canvas:e,context:e.getContext("2d")}}(),has:function(e,t){return e>ui.hudPosition.X&&e<ui.hudPosition.X+ui.hudSize.W&&t>ui.hudPosition.Y&&t<ui.hudPosition.Y+ui.hudSize.H},alert:function(e){ui.alertMessage={time:(new Date).getTime(),text:"⚠ "+e}},drawAlert:function(){var e=(new Date).getTime();if(e-ui.alertMessage.time>2e3){ui.alertMessage.time=0;return}game.context.save(),game.context.strokeStyle="yellow",game.context.fillStyle="black",game.context.font="24px Dejavu Sans, Arial",game.context.textAlign="center",game.context.strokeText(ui.alertMessage.text,game.canvas.width/2,50),game.context.fillText(ui.alertMessage.text,game.canvas.width/2,50),game.context.restore()},modal:function(){game.context.save(),game.context.fillStyle="rgba(0, 0, 0, 0.5)",game.context.fillRect(0,0,game.canvas.width,game.canvas.height),game.context.strokeStyle="yellow",game.context.fillStyle="black",game.context.font="24px Dejavu Sans, Arial",game.context.textAlign="center",game.context.strokeText(ui.modalMessage,game.canvas.width/2,game.canvas.height/2),game.context.fillText(ui.modalMessage,game.canvas.width/2,game.canvas.height/2),game.context.restore()},box:function(e,t,n,r){game.context.fillStyle="rgba(0, 255, 0, 0.5)",game.context.strokeStyle="black",game.context.fillRect(e,t,n,r),game.context.strokeRect(e,t,n,r)},label:function(e,t,n){game.context.font="10px Dejavu Sans, Arial",game.context.textAlign="left",game.context.fillStyle="black",game.context.fillText(e,t,n)},draw:function(){ui.hud(),ui.stats(),ui.minimap(),game.selectedUnits.length===1&&game.selectedUnits.get(0).factory?ui.factory(game.selectedUnits.get(0)):game.selectedUnits.length>0?ui.selection():ui.factory(),ui.modalMessage!==""&&ui.modal(),ui.alertMessage.time>0&&ui.drawAlert();var e=ui.buttonAt(game.mousePosition.X-ui.hudPosition.X,game.mousePosition.Y-ui.hudPosition.Y);if(e!==-1&&e<ui.actionButtons.length&&e<ui.tooltips.length){var t=ui.tooltips[e].split(",");ui.box(game.mousePosition.X,game.mousePosition.Y-15,80,30);for(var n=0;n<t.length;n++)ui.label(t[n],game.mousePosition.X+10,game.mousePosition.Y+n*12)}},factory:function(e){var t={X:100,Y:16},n="grey",r=e?ui.unitBuildables:ui.buildables;ui.actionButtons=[],ui.tooltips=[],game.context.save(),game.context.translate(ui.hudPosition.X,ui.hudPosition.Y),game.context.globalAlpha=ui.alpha;for(var i=0;i<r.length;i++)n=r[i].cost<game.players[0].credits?"grey":"red",r[i].art(t.X+i*40,t.Y,n,"black",0,0,!0),ui.label("$"+r[i].cost,t.X+i*40,t.Y),function(t){var n=t.name;t.upkeep&&(n+=",⚡"+t.upkeep),ui.tooltips.push(n),ui.actionButtons.push(function(){if(e){var n=game.spiral(1,e.tile)[0],r=game.players[0].unit(n.X,n.Y,t);if(r){var i=game.spiral(1,e.rallyPoint||e.tile)[0];r.go(i,!1)}}else game.buildMode=t})}(r[i]);if(e){var s=e;ui.tooltips.push(s.name+",Sell for $"+s.spec.cost/2),ui.actionButtons.push(function(){game.deselectAll(),game.sell(s)}),art.sell(100+r.length*40,16,"green","black",0,0,!0)}game.context.restore()},stats:function(){var e=game.players[0];game.context.save(),game.context.globalAlpha=ui.alpha,game.context.translate(ui.hudPosition.X,ui.hudPosition.Y),game.context.lineWidth=4,game.context.fillStyle="yellow",game.context.strokeStyle="black",game.context.font="30px Dejavu Sans, Arial",game.context.strokeText("⚡",20,ui.topline),game.context.fillText("⚡",20,ui.topline),game.context.strokeText("$",20,ui.topline+40),game.context.fillText("$",20,ui.topline+40),game.context.font="20px Dejavu Sans, Arial",game.context.strokeText("⚔",20,ui.topline+80),game.context.fillText("⚔",20,ui.topline+80),game.context.fillStyle="black",game.context.font="16px Dejavu Sans, Arial",game.context.fillText(e.energy,50,ui.topline),game.context.fillText(e.credits,50,ui.topline+40),game.context.fillText(e.kills+"/"+e.deaths,50,ui.topline+80),game.context.restore()},hud:function(){game.context.save(),game.context.globalAlpha=ui.alpha,game.context.fillStyle="grey",game.context.strokeStyle="black",game.context.lineWidth=4,game.context.translate(ui.hudPosition.X,ui.hudPosition.Y),game.context.fillRect(0,0,ui.hudSize.W,ui.hudSize.H),game.context.strokeRect(0,0,ui.hudSize.W,ui.hudSize.H),game.context.restore()},minimap:function(){ui.minimapImage||(ui.minimapImage=game.map.drawMini()),ui.minimapUnits.context.clearRect(0,0,128,128),game.units.each(function(){this.owner===game.players[0]?(ui.minimapUnits.context.fillStyle="#7eff15",ui.minimapUnits.context.fillRect(this.tile.X,this.tile.Y,2,2)):(ui.minimapUnits.context.fillStyle="#ff7e15",ui.minimapUnits.context.fillRect(this.tile.X,this.tile.Y,2,2))}),game.context.save(),ui.minimapUnits.context.strokeRect(game.map.offset.X,game.map.offset.Y,game.canvas.width/tileSize,game.canvas.height/tileSize),game.context.globalAlpha=.5*ui.alpha,game.context.drawImage(ui.minimapImage,ui.hudPosition.X+368,ui.hudPosition.Y+16),game.context.globalAlpha=ui.alpha,game.context.drawImage(ui.minimapUnits.canvas,ui.hudPosition.X+368,ui.hudPosition.Y+16),game.context.restore()},selection:function(){ui.actionButtons=[],game.context.save(),game.context.translate(ui.hudPosition.X,ui.hudPosition.Y),game.context.globalAlpha=ui.alpha;var e=0,t=0,n=bt.Color("#0F0"),r=18,i=0;ui.tooltips=[],game.selectedUnits.each(function(){!this.dead&&i<r&&(function(e){ui.tooltips.push(e.health+"hp"),ui.actionButtons.push(function(){game.deselectAll(),game.selectedUnits.add(e),e.select()})}(this),n.red=(1-this.percent)*255|0,n.green=this.percent*255|0,this.art(100+e,16+t,n.toString(),"black",0,0,!0),e+=40,e>225&&(e=0,t+=40),i++)});if(game.selectedUnits.length===1&&!game.selectedUnits.get(0).mobile){var s=game.selectedUnits.get(0);ui.tooltips.push(s.name+",Sell for $"+s.spec.cost/2),ui.actionButtons.push(function(){game.deselectAll(),game.sell(s)}),art.sell(140,16,"green","black",0,0,!0)}n.release(),game.context.restore()},buttonAt:function(e,t){var n={X:e-100,Y:t-16};if(n.X>0&&n.X<240&&n.Y>0&&n.Y<120){var r=(n.X/40|0)+(n.Y/40|0)*6;if(ui.actionButtons.length>r)return r}return-1},click:function(e,t){var n={X:e-368,Y:t-16},r={X:game.canvas.width/tileSize|0,Y:game.canvas.height/tileSize|0},i={X:e-100,Y:t-16};n.X>0&&n.X<128&&n.Y>0&&n.Y<128&&(game.map.offset.X=n.X&127-r.X|0,game.map.offset.Y=n.Y&127-r.Y|0,game.map.draw());var s=ui.buttonAt(e,t);s!==-1&&ui.actionButtons[s]()}},tileSize=32,game={tileSize:32,difficulty:1,root:ns.Node(),count:0,frames:0,selectedUnits:ns.Node(),mousePosition:{X:0,Y:0},units:ns.Node(),enemy:ns.Node(),fps:0,playerCount:0,players:[],buildMode:null,collisionMap:[],map:[],energy:0,energyWarning:0,colors:["#3A3","#A3A","#AA3"],EASY:0,MEDIUM:1,HARD:2},collision={PASSABLE:0,UNPASSABLE:1,UNIT:2,STRUCTURE:3,RESERVED:4},key={Q:81,W:87,E:69,R:82,T:84,ESC:27,F1:112};game.deselectAll=function(){game.selectedUnits.each(function(){this.deselect()}),game.selectedUnits.clear()},game.sell=function(e){e.dead||(e.owner.credits+=e.spec.cost/2,e.die())},game.canvasInit=function(){game.canvas=document.getElementById("game"),game.context=game.canvas.getContext("2d"),game.canvas.width=window.innerWidth,game.canvas.height=window.innerHeight},game.init=function(e){game.start=(new Date).getTime(),game.difficulty=e,game.canvas||game.canvasInit(),game.canvas.addEventListener("mousedown",function(e){game.mouseDown=!0,game.dragStart={X:e.clientX,Y:e.clientY},ui.has(e.clientX,e.clientY)&&(game.uiDrag={X:e.clientX-ui.hudPosition.X,Y:e.clientY-ui.hudPosition.Y})}),game.canvas.addEventListener("mousemove",function(e){game.mousePosition.X=e.clientX,game.mousePosition.Y=e.clientY;if(game.mouseDown){var t=game.dragStart;w=e.clientX-game.dragStart.X,h=e.clientY-game.dragStart.Y,game.uiDrag?(ui.alpha=.5,ui.hudPosition={X:t.X+w-game.uiDrag.X,Y:t.Y+h-game.uiDrag.Y}):(w<0&&(t.X+=w,w*=-1),h<0&&(t.Y+=h,h*=-1),game.selection=[t.X,t.Y,w,h])}}),document.addEventListener("keydown",function(e){var t=e.keyCode-48;if(e.ctrlKey){e.preventDefault();if(t>0&&t<10)return game.units.each(function(){this.team===t&&(this.team=0)}),game.selectedUnits.each(function(){this.team=t}),!1}else t>0&&t<10&&game.players[0].selectTeam(t);var n=-1;switch(e.keyCode){case key.Q:n=0;break;case key.W:n=1;break;case key.E:n=2;break;case key.R:n=3;break;case key.T:n=4;break;case key.ESC:game.deselectAll(),menu.hide("shortcuts");break;case key.F1:e.preventDefault(),menu.show("shortcuts")}n!==-1&&ui.actionButtons[n]&&ui.actionButtons[n]()}),game.canvas.addEventListener("mouseup",function(e){game.mouseDown=!1;if(ui.has(e.clientX,e.clientY))ui.click(e.clientX-ui.hudPosition.X,e.clientY-ui.hudPosition.Y);else if(game.buildMode){if(e.button===0){var t=game.buildMode,n={X:e.clientX/tileSize+game.map.offset.X|0,Y:e.clientY/tileSize+game.map.offset.Y|0};game.legalPosition(n,game.buildMode)?game.players[0].build(n.X,n.Y,t):ui.alert("You can't build that there.")}e.shiftKey||(game.buildMode=null)}else if(!game.uiDrag)if(bt.Vec.distance(game.dragStart,{X:e.clientX,Y:e.clientY})<32){var r=!1;if(e.button===0){game.units.each(function(){this.click(e.clientX,e.clientY)&&(r=!0)});if(!r){var i=game.map.at(e.clientX,e.clientY),s=game.spiral(game.selectedUnits.length,i);game.selectedUnits.each(function(){this.targetUnit=null,this.go(s.shift())})}}else game.deselectAll()}else game.deselectAll(),game.units.each(function(){this.isInside(game.selection)&&this.owner.local&&this.mobile&&(this.select(),game.selectedUnits.add(this))});return game.uiDrag=!1,ui.alpha=1,game.selection=null,!1}),gameView(window.innerWidth,window.innerHeight)},game.run=function(){game.frames++;for(var e=0;e<game.players.length;e++)game.players[e].update();game.root.each(function(){this.draw()}),game.selection&&(game.context.fillStyle="rgba(30, 210, 230, 0.5)",game.context.fillRect.apply(game.context,game.selection));if(game.buildMode){var t="grey",n=game.map.at(game.mousePosition.X,game.mousePosition.Y);if(!game.legalPosition(n,game.buildMode)||game.buildMode.cost>game.players[0].credits)t="red";game.buildMode.art(game.mousePosition.X-game.mousePosition.X%32,game.mousePosition.Y-game.mousePosition.Y%32,t,"black",0,0,!0)}var r=(new Date).getTime();game.players[0].energy<0&&r-game.energyWarning>1e4&&(ui.alert("Low energy, buildings offline."),game.energyWarning=r),ui.draw(),setTimeout(game.run,5)},game.unitAt=function(e){var t=null;return game.units.each(function(){this.tile.X===e.X&&this.tile.Y===e.Y&&(t=this)}),t},game.spiral=function(e,t,n){var r=0,i=0,s=0,o=-1,u,a=[];while(a.length<e){if(r==i||r<0&&r==-i||r>0&&r==1-i)u=s,s=-o,o=u;n?game.legalPosition({X:t.X+r,Y:t.Y+i},n)&&a.push({X:t.X+r,Y:t.Y+i}):game.collisionMap[t.X+r]&&game.collisionMap[t.X+r][t.Y+i]===collision.PASSABLE&&a.push({X:t.X+r,Y:t.Y+i}),r+=s,i+=o}return a},game.legalPosition=function(e,t){if(typeof t.terrain=="number"){var n=!1;return game.units.each(function(){this.spec==t&&bt.Vec.distance(this.tile,e)<6&&(n=!0)}),n?!1:game.map.map[e.X]&&game.map.map[e.X][e.Y]===t.terrain&&(game.collisionMap[e.X][e.Y]!==collision.UNIT||collision.STRUCTURE)}return t.big?game.map.map[e.X]&&game.map.map[e.X][e.Y]!==0&&game.map.map[e.X+1][e.Y]!==0&&game.map.map[e.X][e.Y+1]!==0&&game.map.map[e.X+1][e.Y+1]!==0&&game.collisionMap[e.X][e.Y]===collision.PASSABLE&&game.collisionMap[e.X+1][e.Y]===collision.PASSABLE&&game.collisionMap[e.X][e.Y+1]===collision.PASSABLE&&game.collisionMap[e.X+1][e.Y+1]===collision.PASSABLE:game.map.map[e.X]&&game.map.map[e.X][e.Y]!==0&&game.collisionMap[e.X][e.Y]===collision.PASSABLE};var AI=function(e){function t(e){var t={X:Math.random()*100|0,Y:Math.random()*50|50},n=null,r=ns.Node(),i=0,o=3e3,u=20,a=0,f={target:null,units:[]},l=[],c=[def.powerplant,def.mine,def.powerplant,def.powerplant,def.factory,def.powerplant,def.turret,def.powerplant,def.turret,def.powerplant,def.mine,def.mine,def.powerplant,def.powerplant,def.powerplant,def.powerplant,def.mine,def.mine,def.mine,def.mine,def.powerplant,def.mine,def.mine,def.mine],h=function(){f.target=game.players[0].units.get(0);for(var e=0;e<f.units.length;e++)f.units[e].attack(f.target);l.push(f),f={target:null,units:[]}},p={complete:!1,lastUpdate:0,attackSize:Math.random()*20|0,update:function(){var r=(new Date).getTime();if(r-p.lastUpdate<o)return;if(c.length>0&&e.credits>c[0].cost){f.length>0&&h();var i=c.shift(),d=game.spiral(1,t,i);s=e.build(d[0].X,d[0].Y,i);if(i==def.mine){var v=game.spiral(1,d[0])[0];e.build(v.X,v.Y,def.turret),c.push(def.powerplant)}s&&(i==def.factory&&(n=s,console.log("built factory")),s.ondeath=function(e){c.push(def.powerplant),c.push(e),c.push(def.turret)})}if(n&&c.length===0&&a<u){var m=null,d=game.spiral(1,n.tile)[0];e.credits>def.heavyTank.cost?m=e.unit(d.X,d.Y,def.heavyTank):e.credits>def.tank.cost&&(m=e.unit(d.X,d.Y,def.tank));if(m){a++;var g=game.spiral(1,n.rallyPoint||n.tile)[0];m.go(g),m.ondeath=function(){a--},f.units.push(m),f.units.length>=p.attackSize&&h()}p.complete=!0}if(l.length>0&&game.players[0].units.length>0)for(var y=0;y<l.length;y++)if(!l[y].target||l[y].target.dead||bt.Vec.distance(l[y].target.tile,l[y].units[0].tile)>l[y].units[0].range){l[y].target=game.players[0].units.get(0);for(var b=0;b<l[y].units.length;b++)l[y].units[b].attack(l[y].target)}}};switch(game.difficulty){case game.MEDIUM:e.credits+=1e3;break;case game.HARD:e.credits+=2500;break;default:}return p}var n={maxBases:5,bases:ns.Node(),update:function(){var r=!0;n.bases.each(function(){this.update(),this.complete||(r=!1)}),(r||n.bases.length===0)&&n.bases.length<n.maxBases&&n.bases.add(t(e))}};return n},Player=function(e,t,n){var r=null,i={local:n===Player.modes.LOCAL,id:game.playerCount++,energy:0,energyMax:0,unitCap:100,unitQueue:0,kills:0,deaths:0,credits:500,get units(){return s},unit:function(e,t,n){if(s.length>i.unitCap){game.players[0]===i&&ui.alert("Unit cap reached (100)");return}if(i.credits>=n.cost){var r=f(e,t,n);return i.credits-=n.cost,r}return game.players[0]===i&&ui.alert("You can't afford that."),null},build:function(e,t,n){if(s.length>i.unitCap){game.players[0]===i&&
ui.alert("Unit cap reached (100)");return}if(i.credits>=n.cost){var r=f(e,t,n);n.upkeep!=null&&(i.energy+=n.upkeep),n.cost!=null&&(i.credits-=n.cost)}else game.players[0]===i&&ui.alert("You can't afford that.");return r},update:function(){var e=(new Date).getTime();r&&r.update();if(!i.defeated&&e-game.start>1e3&&s.length===0){i.defeated=!0;var t=(e-game.start)/1e3,n=(t/60|0)+" minutes and "+(t%60|0)+" seconds";ui.modalMessage="☠ "+u+" was defeated. Playtime: "+n,console.log("player "+i.id+" was defeated.")}},selectTeam:function(e){game.deselectAll(),s.each(function(){this.team===e&&(game.selectedUnits.add(this),this.select())})}},s=ns.Node(),o=n,u=n==Player.modes.AI?"AI":"Human",a=game.colors[i.id],f=function(e,t,n){var r=Unit(e,t,a,n||def.tank);return o===0?r.on("click",function(e){return function(){game.deselectAll(),e.select(),game.selectedUnits.add(e)}}(r)):r.on("click",function(e){return function(){game.selectedUnits.each(function(){this.attack(e)})}}(r)),r.owner=i,game.units.add(r),s.add(r),r};console.log(i.id),s.draw=function(){var e=[];s.each(function(){this.draw(),this.dead&&e.push(this)});for(var t=e.length-1;t>=0;--t)s.remove(e[t]),game.units.remove(e[t])},game.root.add(s);if(n==Player.modes.AI)r=AI(i);else{var l=game.spiral(13,{X:e,Y:t});for(var c=0;c<13;c++)f(l[c].X,l[c].Y)}return i};Player.modes={LOCAL:0,AI:1,NETWORK:2};var menu={click:function(e,t){document.getElementById(e).addEventListener("click",t)},hide:function(e){document.getElementById(e).style.display="none"},show:function(e){document.getElementById(e).style.display="block"}};window.addEventListener("load",function(){menu.click("play",function(){menu.show("difficulty")}),menu.click("help",function(){menu.show("shortcuts")}),menu.click("easy",function(){menu.hide("menu"),startGame(0)}),menu.click("medium",function(){menu.hide("menu"),startGame(1)}),menu.click("hard",function(){menu.hide("menu"),startGame(2)}),menu.click("shortcuts",function(){menu.hide("shortcuts")})});