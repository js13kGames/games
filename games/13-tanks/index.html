<!doctype html><title>13 Tanks - js13kGames 2012</title><style>body{font-family:Dejavu Sans,Arial;font-size:24px}a{color:#000;text-decoration:none;font-size:24px}a:hover{color:green}#footer{position:absolute;text-align:center;bottom:0;left:0;width:100%}#shortcuts{display:none;padding:10px;color:#fff;z-index:9;position:absolute;top:25%;left:40%;width:20%;background-color:rgba(0,0,0,.6);text-align:left;font-size:14px}</style><body oncontextmenu=return!1 style=margin:0;padding:0;overflow:hidden;width:100%;height:100%><canvas id=game></canvas><div id=menu style=position:absolute;top:0;left:0;text-align:center;width:100%;height:100%><h1>☢ 13 tanks ☢</h1><a href=# id=play>play</a><br><div id=difficulty style=display:none><a href=# id=easy>♥ easy</a><br><a href=# id=medium>☣ medium</a><br><a href=# id=hard>☠ hardcore</a><br></div><a href=# id=help>help</a><div id=footer>[<a href=https://twitter.com/Armen138>@Armen138</a>] [<a href=http://www.js13kgames.com>js13kgames</a>] [<a href=https://github.com/Armen138/rts13k>github</a>]</div></div><div id=shortcuts>keyboard shortcuts:<ul><li>F1: shortcuts help<li>ctrl-(1-9): create numbered group<li>(1-9): select numbered group<li>(q-w-e-r-t): corresponds to buttons in HUD<li>ESC: deselect all<li>shift-click: when building, does not deselect current build setting</ul></div><script>function u(){function f(t,e,n,o){return t<0?0:Math.pow(t,4)*((t=a[e]).X*n+t.Y*o)}for(var a=[I.Vector(1,1),I.Vector(-1,1),I.Vector(1,-1),I.Vector(-1,-1),I.Vector(1,0),I.Vector(-1,0),I.Vector(1,0),I.Vector(-1,0),I.Vector(0,1),I.Vector(0,-1),I.Vector(0,1),I.Vector(0,-1)],t=[],d=[],p=[],h=.5*(Math.sqrt(3)-1),m=(3-Math.sqrt(3))/6,e=0;e<512;e++)t.push(Math.floor(255*Math.random())),d.push(t[255&e]),p.push(d[e]%12);this.noise=function(t,e){var n=(t+e)*h,o=t+n|0,a=(e-=(n=e+n|0)-(a=(o+n)*m))<(t-=o-a)?(u=1,0):(u=0,1),i=t-u+m,l=e-a+m,r=t-1+2*m,c=e-1+2*m,s=p[(o&=255)+d[n&=255]],u=p[o+u+d[n+a]],a=p[1+o+d[1+n]];return 70*(f(.5-t*t-e*e,s,t,e)+f(.5-i*i-l*l,u,i,l)+f(.5-r*r-c*c,a,r,c))}}function a(t,e){var n=f(t=t-t%32+32,e=e-e%32+32),o=[I.Color("#152568"),I.Color("#CCE010"),I.Color("#E6DFC8"),I.Color("#7A6212"),I.Color("#00e17f")];a.canvas=n.canvas,a.context=n.context,a.width=t,a.height=e,(n=[i(B,o[0]),i(B,o[1]),i(B,o[2]),i(B,o[2]),i(B,o[4])])[3].getContext("2d").drawImage(function(t,e,n){for(var o=new u,a=(e=f(t,t)).context.createImageData(t,t),i=n||I.Color("#11A600"),l=0;l<t;l++)for(var r=0;r<t;r++){var c=parseInt((o.noise(l/10,r/10)+1)/2*12,10)*(256/12);a.data[4*l+r*t*4]=i.red/255*c,a.data[4*l+r*t*4+1]=i.green/255*c,a.data[4*l+r*t*4+2]=i.blue/255*c,a.data[4*l+r*t*4+3]=255,c<160&&(a.data[4*l+r*t*4+3]=0)}return e.context.putImageData(a,0,0),e.canvas}(B,10,o[1]),0,0),C.map=p.TileSet(n,function(){for(var t=[],e=new u,n=0;n<128;n++){t[n]=new Uint8Array(128);for(var o=0;o<128;o++)t[n][o]=parseInt((e.noise(n/40,o/40)+1)/2*4,10)}return t}(),a.canvas,t,e),C.mousePosition=I.Vector(0,0),C.root.add(a),C.map.draw(),setInterval(a.scrollHandler,32)}function f(t,e){var n=document.createElement("canvas");return n.width=t,n.height=e,{canvas:n,context:n.getContext("2d")}}function t(t){C.init(t),C.players.push(g(10,10,g.modes.LOCAL)),C.players.push(g(100,100,g.modes.AI)),C.run()}function m(X,Y,t,v){function n(t){R=t,E=(new Date).getTime(),R.length}var b=X*B,y=Y*B,w=0,k=0,e=t,S=0,o=0,A=0,a=v.health||100,M=v.loadTime||null,P=v.collision||V.UNIT,T=v.moveDuration||100,R=[],U=v.range||5,i=!1,E=0,D={mobile:v.mobile,target:null,targetUnit:null,art:v.art,name:v.name,badge:"",team:0,dead:!1,factory:v.factory,get spec(){return v},get idle(){return 0===R.length&&!D.target},get health(){return a},select:function(){i=!0},deselect:function(){i=!1},draw:function(){v.art(b,y,e.toString(),i?"yellow":"black",w,k),""!==D.badge&&(C.context.fillStyle="black",C.context.font="10px Dejavu Sans, Arial",C.context.textAlign="left",C.context.fillText(D.badge,b-C.map.offset.X*B,y-C.map.offset.Y*B)),this.update()},die:function(){D.dead||(D.dead=!0,D.owner.deaths++,v.upkeep&&(D.owner.energy-=v.upkeep),C.collisionMap[X][Y]=V.PASSABLE,v.big&&(C.collisionMap[X][Y+1]=V.PASSABLE,C.collisionMap[X+1][Y]=V.PASSABLE,C.collisionMap[X+1][Y+1]=V.PASSABLE),D.ondeath&&D.ondeath(v))},hit:function(t){return a-=t,!D.dead&&a<0&&(D.die(),!0)},isInside:function(t,e){var n=C.map.offset.X*B,o=C.map.offset.Y*B;return e&&(o=n=0),b>t[0]+n&&b<t[0]+n+t[2]&&t[1]+o<y&&y<t[1]+o+t[3]},attack:function(t){D.targetUnit=t},go:function(t,e){v.mobile?(C.collisionMap[t.X][t.Y]!==V.PASSABLE&&(t=C.spiral(1,t)[0]),C.collisionMap[t.X][t.Y]===V.PASSABLE&&(e||(C.collisionMap[X][Y]=V.PASSABLE),d.find({X:X,Y:Y},t,n))):D.rallyPoint=t},click:function(t,e){var n=b-C.map.offset.X*B,o=y-C.map.offset.Y*B,a=v.big?64:32;return n<t&&t<n+a&&o<e&&e<o+a&&(D.fire("click"),!0)},update:function(){var t,e,n,o,a,i,l,r,c,s,u,f,d,p,h,m,g,x;D.owner.energy<0&&!v.mobile?D.badge="⚡":D.badge=""+(0<D.team?D.team:""),v.income&&1e3<(i=(new Date).getTime())-A&&0<=D.owner.energy&&(D.owner.credits+=v.income,A=i),v.mobile&&(0<R.length?(curTime=(new Date).getTime()-E)>T?(function(t,e,n){if(b=(X=t)*B,y=(Y=e)*B,n){if(C.collisionMap[X][Y]===P)return D.go(C.spiral(2,{X:X,Y:Y})[1],!0);C.collisionMap[X][Y]=P}}((t=R.shift()).X,t.Y,0===R.length),E=(new Date).getTime(),0<R.length&&C.collisionMap[R[0].X][R[0].Y]===V.STRUCTURE&&D.go(R[R.length-1])):(l=R[0].X*B,e=R[0].Y*B,n=l-(l=X*B),o=e-(e=Y*B),a=parseFloat(curTime)/parseFloat(T),b=l+a*n|0,y=e+a*o|0,w=Math.atan2(R[0].X-X,Y-R[0].Y)):D.targetUnit&&!D.targetUnit.dead&&I.Vec.distance(D.targetUnit.tile,D.tile)>U&&(t=C.spiral(1,D.targetUnit.tile)[0],D.go(t))),!v.loadTime||!v.mobile&&D.owner.energy<0||(rangeBox=[b-U*B,y-U*B,2*U*B,2*U*B],D.target=null,C.units.each(function(){this.owner.id!==D.owner.id&&this.isInside(rangeBox,!0)&&(D.target=this.position)}),i=(new Date).getTime(),D.target?(k=Math.atan2(D.target.X-b,y-D.target.Y),M<i-S&&(r={X:b,Y:y},c=D.target,s=v.damage||10,u=r.X,f=r.Y,d=I.Vec.distance(r,c)/B*100,p=(c.X-r.X)/d,h=(c.Y-r.Y)/d,m=(new Date).getTime(),g=s/4,(l=x={draw:function(){C.context.save(),C.context.translate(u-C.map.offset.X*B+B/2,f-C.map.offset.Y*B+B/2),C.context.fillStyle="#FF0000",C.context.fillRect(g/2*-1,g/2*-1,g,g),C.context.restore(),x.update()},update:function(){var t=(new Date).getTime()-m;u=r.X+p*t,f=r.Y+h*t,d<t&&(C.root.remove(x),t=C.unitAt({X:c.X/B|0,Y:c.Y/B|0}))&&t.hit(s)&&x.owner.kill()}}).owner=D,C.root.add(l),S=i)):k=0)},kill:function(){o++,D.owner.kills++}},l=(Object.defineProperty(D,"position",{get:function(){return{X:b,Y:y}}}),Object.defineProperty(D,"tile",{get:function(){return{X:X,Y:Y}}}),Object.defineProperty(D,"percent",{get:function(){return a/v.health}}),Object.defineProperty(D,"kills",{get:function(){return o}}),C.collisionMap[X][Y]=P,v.big&&(C.collisionMap[X][Y+1]=P,C.collisionMap[X+1][Y]=P,C.collisionMap[X+1][Y+1]=P),D),r={},c={on:function(t,e){r[t]||(r[t]=[]),r[t].push(e)},fire:function(t,e){if(r[t])for(var n=0;n<r[t].length;n++)r[t][n](e)}};for(prop in c)l[prop]=c[prop];return D}function g(t,e,n){var o,a,i=null,l={local:n===g.modes.LOCAL,id:C.playerCount++,energy:0,energyMax:0,unitCap:100,unitQueue:0,kills:0,deaths:0,credits:500,get units(){return r},unit:function(t,e,n){if(!(r.length>l.unitCap))return l.credits>=n.cost?(t=d(t,e,n),l.credits-=n.cost,t):(C.players[0]===l&&Y.alert("You can't afford that."),null);C.players[0]===l&&Y.alert("Unit cap reached (100)")},build:function(t,e,n){var o;if(!(r.length>l.unitCap))return l.credits>=n.cost?(o=d(t,e,n),null!=n.upkeep&&(l.energy+=n.upkeep),null!=n.cost&&(l.credits-=n.cost)):C.players[0]===l&&Y.alert("You can't afford that."),o;C.players[0]===l&&Y.alert("Unit cap reached (100)")},update:function(){var t=(new Date).getTime();i&&i.update(),!l.defeated&&1e3<t-C.start&&0===r.length&&(l.defeated=!0,t=(t-C.start)/1e3,Y.modalMessage="☠ "+u+" was defeated. Playtime: "+(t/60|0)+" minutes and "+(t%60|0)+" seconds")},selectTeam:function(t){C.deselectAll(),r.each(function(){this.team===t&&(C.selectedUnits.add(this),this.select())})}},r=X.Node(),c=n,u=n==g.modes.AI?"AI":"Human",f=C.colors[l.id],d=function(t,e,n){var o,a,t=m(t,e,f,n||x.tank);return 0===c?t.on("click",(a=t,function(){C.deselectAll(),a.select(),C.selectedUnits.add(a)})):t.on("click",(o=t,function(){C.selectedUnits.each(function(){this.attack(o)})})),t.owner=l,C.units.add(t),r.add(t),t};if(r.draw=function(){var t=[];r.each(function(){this.draw(),this.dead&&t.push(this)});for(var e=t.length-1;0<=e;--e)r.remove(t[e]),C.units.remove(t[e])},C.root.add(r),n==g.modes.AI)o=l,a={maxBases:5,bases:X.Node(),update:function(){var t=!0;a.bases.each(function(){this.update(),this.complete||(t=!1)}),(t||0===a.bases.length)&&a.bases.length<a.maxBases&&a.bases.add(function(i){function l(){f.target=C.players[0].units.get(0);for(var t=0;t<f.units.length;t++)f.units[t].attack(f.target);d.push(f),f={target:null,units:[]}}var r={X:100*Math.random()|0,Y:50*Math.random()|50},c=null,u=(X.Node(),0),f={target:null,units:[]},d=[],p=[x.powerplant,x.mine,x.powerplant,x.powerplant,x.factory,x.powerplant,x.turret,x.powerplant,x.turret,x.powerplant,x.mine,x.mine,x.powerplant,x.powerplant,x.powerplant,x.powerplant,x.mine,x.mine,x.mine,x.mine,x.powerplant,x.mine,x.mine,x.mine],h={complete:!1,lastUpdate:0,attackSize:20*Math.random()|0,update:function(){var t,e,n;if(!((new Date).getTime()-h.lastUpdate<3e3)&&(0<p.length&&i.credits>p[0].cost&&(0<f.length&&l(),e=p.shift(),n=C.spiral(1,r,e),s=i.build(n[0].X,n[0].Y,e),e==x.mine&&(t=C.spiral(1,n[0])[0],i.build(t.X,t.Y,x.turret),p.push(x.powerplant)),s)&&(e==x.factory&&(c=s),s.ondeath=function(t){p.push(x.powerplant),p.push(t),p.push(x.turret)}),c&&0===p.length&&u<20&&(t=null,n=C.spiral(1,c.tile)[0],i.credits>x.heavyTank.cost?t=i.unit(n.X,n.Y,x.heavyTank):i.credits>x.tank.cost&&(t=i.unit(n.X,n.Y,x.tank)),t&&(u++,e=C.spiral(1,c.rallyPoint||c.tile)[0],t.go(e),t.ondeath=function(){u--},f.units.push(t),f.units.length>=h.attackSize)&&l(),h.complete=!0),0<d.length)&&0<C.players[0].units.length)for(var o=0;o<d.length;o++)if(!d[o].target||d[o].target.dead||I.Vec.distance(d[o].target.tile,d[o].units[0].tile)>d[o].units[0].range){d[o].target=C.players[0].units.get(0);for(var a=0;a<d[o].units.length;a++)d[o].units[a].attack(d[o].target)}}};switch(C.difficulty){case C.MEDIUM:i.credits+=1e3;break;case C.HARD:i.credits+=2500}return h}(o))}},i=a;else for(var p=C.spiral(13,{X:t,Y:e}),h=0;h<13;h++)d(p[h].X,p[h].Y);return l}function i(t,e){var n=f(t,t);n.context.fillStyle=e.toString(),n.context.fillRect(0,0,t,t),e=e.mul(.8),n.context.fillStyle=e.toString();for(var o=0;o<128;o++){var a=Math.random()*t|0,i=Math.random()*t|0;n.context.fillRect(a,i,4*Math.random()|0,4*Math.random()|0)}return n.canvas}var e,r={open:function(t,e){C.context.save(),C.context.fillStyle=t,C.context.strokeStyle=e},body:function(t){C.context.rotate(t),C.context.fillRect(-8,-16,16,32),C.context.strokeRect(-8,-16,16,32)},box:function(t){t?(C.context.fillRect(-16,-16,64,64),C.context.strokeRect(-16,-16,64,64)):(C.context.fillRect(-16,-16,32,32),C.context.strokeRect(-16,-16,32,32))},tank:function(t,e,n,o,a,i,l){r.open(n,o),l?C.context.translate(t+B/2,e+B/2):C.context.translate(t-C.map.offset.X*B+B/2,e-C.map.offset.Y*B+B/2),r.body(a),0!==i&&(C.context.rotate(-a),C.context.rotate(i)),C.context.fillRect(-2,-16,4,24),C.context.strokeRect(-2,-16,4,24),C.context.fillRect(-5,-5,10,10),C.context.strokeRect(-5,-5,10,10),C.context.restore()},heavyTank:function(t,e,n,o,a,i,l){r.open(n,o),l?C.context.translate(t+B/2,e+B/2):C.context.translate(t-C.map.offset.X*B+B/2,e-C.map.offset.Y*B+B/2),r.body(a),0!==i&&(C.context.rotate(-a),C.context.rotate(i)),C.context.fillRect(-6,-16,4,24),C.context.strokeRect(-6,-16,4,24),C.context.fillRect(-5,-5,10,10),C.context.strokeRect(-5,-5,10,10),C.context.fillRect(2,-16,4,24),C.context.strokeRect(2,-16,4,24),C.context.fillRect(-5,-5,10,10),C.context.strokeRect(-5,-5,10,10),C.context.restore()},factory:function(t,e,n,o,a,i,l){r.open(n,o),l?C.context.translate(t+B/2,e+B/2):C.context.translate(t-C.map.offset.X*B+B/2,e-C.map.offset.Y*B+B/2),r.box(!l),r.lines([[{X:-12,Y:3},{X:11,Y:3}],[{X:10,Y:3},{X:10,Y:-1}],[{X:10,Y:-1},{X:-12,Y:-1}],[{X:-12,Y:-1},{X:-12,Y:3}],[{X:-6,Y:-1},{X:-6,Y:-5}],[{X:-6,Y:-5},{X:2,Y:-5}],[{X:2,Y:-5},{X:2,Y:-1}],[{X:2,Y:-4},{X:14,Y:-4}],[{X:13,Y:-3},{X:2,Y:-3}],[{X:-11,Y:2},{X:-13,Y:5}],[{X:-13,Y:5},{X:-10,Y:7}],[{X:-10,Y:7},{X:10,Y:7}],[{X:10,Y:6},{X:12,Y:5}],[{X:12,Y:5},{X:11,Y:3}]]),C.context.restore()},turret:function(t,e,n,o,a,i,l){r.open(n,o),l?C.context.translate(t+B/2,e+B/2):C.context.translate(t-C.map.offset.X*B+B/2,e-C.map.offset.Y*B+B/2),C.context.rotate(a),r.box(),0!==i&&(C.context.rotate(-a),C.context.rotate(i)),C.context.fillRect(-4,-20,8,32),C.context.strokeRect(-4,-20,8,32),C.context.fillRect(-10,-10,20,20),C.context.strokeRect(-10,-10,20,20),C.context.restore()},sell:function(t,e,n,o,a,i,l){r.open(n,o),C.context.translate(t+B/2,e+B/2),r.box(),C.context.lineWidth=4,C.context.font="20px Arial Unicode MS, Arial",C.context.textAlign="center",C.context.fillStyle="yellow",C.context.strokeText("$",0,6),C.context.fillText("$",0,6),C.context.restore()},mine:function(t,e,n,o,a,i,l){r.open(n,o),l?C.context.translate(t+B/2,e+B/2):(C.context.translate(t-C.map.offset.X*B+B/2,e-C.map.offset.Y*B+B/2),C.buildMode&&C.buildMode===x.mine&&(C.context.globalAlpha=.3,C.context.fillRect(-160,-160,320,320),C.context.globalAlpha=1)),r.box(),r.lines([[{X:-13,Y:-13},{X:14,Y:-13}],[{X:13,Y:-13},{X:13,Y:15}],[{X:13,Y:15},{X:7,Y:-7}],[{X:7,Y:-7},{X:-12,Y:-13}],[{X:6,Y:-7},{X:-14,Y:12}],[{X:-14,Y:12},{X:-10,Y:15}],[{X:-10,Y:14},{X:7,Y:-6}]]),C.context.restore()},hydroplant:function(t,e,n,o,a,i,l){r.open(n,o),l?C.context.translate(t+B/2,e+B/2):(C.context.translate(t-C.map.offset.X*B+B/2,e-C.map.offset.Y*B+B/2),C.buildMode&&C.buildMode===x.hydroplant&&(C.context.globalAlpha=.5,C.context.fillRect(-160,-160,320,320),C.context.globalAlpha=1)),r.box(),r.lines([[{X:-13,Y:0},{X:-4,Y:-10}],[{X:-4,Y:-10},{X:2,Y:0}],[{X:2,Y:0},{X:9,Y:-10}],[{X:-12,Y:7},{X:-4,Y:-2}],[{X:-4,Y:-2},{X:2,Y:7}],[{X:2,Y:7},{X:9,Y:-2}]]),C.context.restore()},powerplant:function(t,e,n,o,a,i,l){r.open(n,o),l?C.context.translate(t+B/2,e+B/2):C.context.translate(t-C.map.offset.X*B+B/2,e-C.map.offset.Y*B+B/2),r.box(),r.lines([[{X:-1,Y:-3},{X:11,Y:-2}],[{X:11,Y:-2},{X:-10,Y:10}],[{X:-10,Y:10},{X:1,Y:0}],[{X:1,Y:0},{X:-13,Y:-2}],[{X:-13,Y:-2},{X:10,Y:-10}],[{X:10,Y:-10},{X:-1,Y:-3}]]),C.context.restore()},lines:function(t){C.context.beginPath();for(var e=0;e<t.length;e++)C.context.moveTo(t[e][0].X,t[e][0].Y),C.context.lineTo(t[e][1].X,t[e][1].Y);C.context.stroke()}},x={tank:{name:"tank",mobile:!0,health:100,damage:10,range:5,art:r.tank,loadTime:1e3,moveDuration:400,cost:100},heavyTank:{name:"heavy tank",mobile:!0,health:200,damage:15,range:6,art:r.heavyTank,loadTime:1500,moveDuration:600,cost:200},turret:{name:"turret",mobile:!1,health:120,damage:40,range:7,art:r.turret,loadTime:700,upkeep:-50,cost:100,collision:3},mine:{name:"mining station",mobile:!1,health:100,range:7,upkeep:-100,cost:150,income:10,art:r.mine,terrain:3,collision:3},powerplant:{name:"powerplant",mobile:!1,health:100,range:7,upkeep:150,cost:50,art:r.powerplant,collision:3},hydroplant:{name:"hydroplant",mobile:!1,health:100,range:7,upkeep:800,cost:500,art:r.hydroplant,terrain:0,collision:3},factory:{name:"tank factory",mobile:!1,health:1e3,art:r.factory,factory:!0,range:5,collision:3,cost:150,upkeep:-100,big:!0}},d=function(){for(var i=[],l=[],t=0;t<16;t++)i.push(new Worker("astar.js"));return{find:function(t,e,n){var o,a;0<i.length?(o=i.shift(),a=n,o.postMessage({collisionMap:C.collisionMap,x1:t.X,y1:t.Y,x2:e.X,y2:e.Y}),o.onmessage=function(t){a(t.data),i.push(o),0<l.length&&(t=l.shift(),d.find(t.start,t.end,t.cb))}):l.push({start:t,end:e,cb:n})}}}(),X={},I=(X.Pooled=function(){"use strict";function t(){return{release:function(){if(!this.type)throw"Cannot release to pool: object has no type property.";e[this.type]||(e[this.type]=[]),e[this.type].push(this)}}}var e={};return t.pull=function(t){return e[t]?e[t].shift():null},t.available=function(t){return e[t]},t}(),X.Node=function(){"use strict";var n,e=X.Pooled.pull("node");return e||(n=[],e=Object.create(X.Pooled(),{visible:{value:!0,enumerable:!0,configurable:!0},each:{value:function(t){for(var e=0;e<n.length;e++)t.apply(n[e])},enumerable:!0},get:{value:function(t){return n[t]}},clear:{value:function(){n.length=0}},add:{value:function(t){n.push(t),t.parent=e},enumerable:!0},remove:{value:function(t){-1!==(t=n.indexOf(t))&&n.splice(t,1)},enumerable:!0},up:{get:function(){return Object.getPrototypeOf(this)}},length:{get:function(){return n.length}}})),e},{Vector:function(t,e){"use strict";var n=X.Pooled.pull("vector");return(n=n||Object.create(X.Pooled(),{shallow:{value:function(){return{X:n.X,Y:n.Y}}},add:{value:function(t){return I.Vector(n.X+t.X,n.Y+t.Y)}},subtract:{value:function(t){return I.Vector(n.X-t.X,n.Y-t.Y)}},multiply:{value:function(t){return I.Vector(n.X*t.X,n.Y*t.Y)}},divide:{value:function(t){return I.Vector(n.X/t.X,n.Y/t.Y)}},is:{value:function(t){return n.X===t.X&&n.Y===t.Y}},isInside:{value:function(t){return n.X>t[0]&&n.X<t[0]+t[2]&&n.Y>t[1]&&n.Y<t[1]+t[3]}},distanceTo:{value:function(t){var e=Math.abs(n.X-t.X),t=Math.abs(n.Y-t.Y);return Math.sqrt(Math.pow(e,2)+Math.pow(t,2))}},type:{value:"vector"}})).X=t||0,n.Y=e||0,n}}),p=(I.Vec={distance:function(t,e){var n=Math.abs(t.X-e.X),t=Math.abs(t.Y-e.Y);return Math.sqrt(Math.pow(n,2)+Math.pow(t,2))}},I.Color=function(t){"use strict";var n,o,a;return"#"===t[0]&&(a=4===t.length?(n=16*(parseInt(t[1],16)+1),o=16*(parseInt(t[2],16)+1),16*(parseInt(t[3],16)+1)):(n=parseInt(t.substr(1,2),16)+1,o=parseInt(t.substr(3,2),16)+1,parseInt(t.substr(5,2),16)+1)),Object.create(X.Pooled(),{array:{get:function(){return[n,o,a]},set:function(t){n=t[0],o=t[1],a=t[2]}},red:{get:function(){return n},set:function(t){n=t}},green:{get:function(){return o},set:function(t){o=t}},blue:{get:function(){return a},set:function(t){a=t}},toString:{value:function(){return"rgba("+n+","+o+","+a+",1.0)"}},mul:{value:function(t){var e=I.Color("#FFF");return e.red=n*t|0,e.green=o*t|0,e.blue=a*t|0,e}},type:{value:"color"}})},{pickTile:function(t,e,n){return t[e][n]},collisionDebug:function(){if(C.map.offset){for(var t,e=I.Vector(800/B,800/B),n=C.map.offset.add(e),o=C.map.offset.X;o<n.X;o++)for(var a=C.map.offset.Y;a<n.Y;a++)0!=C.collisionMap[o][a]&&(t="rgba(255, 0, 0, 0.5)",C.collisionMap[o][a]===V.RESERVED&&(t="rgba(0, 0, 255, 0.5)"),C.context.fillStyle=t,C.context.fillRect((o-C.map.offset.X)*B,(a-C.map.offset.Y)*B,B,B));n.release()}},TileSet:function(a,i,l,t,e){i.length;for(var r=I.Vector(t/B,e/B),c=l.getContext("2d"),s=["#152568","#CCE010","#E6DFC8","#7A6212"],u=Object.create(X.Node(),{at:{value:function(t,e){return I.Vector(t/B+u.offset.X|0,e/B+u.offset.Y|0)}},width:{value:i.length},height:{value:i[0].length},at:{value:function(t,e){return I.Vector((t/B|0)+C.map.offset.X,(e/B|0)+C.map.offset.Y)}},horizontal:{value:function(t){c.drawImage(l,B*t,0),u.offset.X-=t;for(var e=0+u.offset.Y;e<u.offset.Y+r.Y;e++){var n=(t<0?r.X:0)+u.offset.X-(t<0?1:0),o=a[p.pickTile(i,n,e)];o&&c.drawImage(o,(n-u.offset.X)*B,(e-u.offset.Y)*B)}}},vertical:{value:function(t){c.drawImage(l,0,B*t),u.offset.Y-=t;for(var e=0+u.offset.X;e<u.offset.X+r.X;e++){var n=(t<0?r.Y:0)+u.offset.Y-(t<0?1:0),o=a[p.pickTile(i,e,n)];o&&c.drawImage(o,(e-u.offset.X)*B,(n-u.offset.Y)*B)}}},draw:{value:function(){if(u.offset){for(var t=u.offset.add(r),e=u.offset.X;e<t.X;e++)for(var n=u.offset.Y;n<t.Y;n++)c.drawImage(a[p.pickTile(i,e,n)],(e-u.offset.X)*B,(n-u.offset.Y)*B);t.release()}}},drawMini:{value:function(){var t=document.createElement("canvas"),e=(t.width=128,t.height=128,t.getContext("2d"));if(u.offset){for(var n=u.offset.add(r),o=0;o<128;o++)for(var a=0;a<128;a++)e.fillStyle=s[i[o][a]],e.fillRect(o,a,1,1);n.release()}return t}},map:{value:i}}),n=0;n<i.length;n++){C.collisionMap[n]=new Uint8Array(i[0].length);for(var o=0;o<i[0].length;o++)0===p.pickTile(i,n,o)?C.collisionMap[n][o]=V.UNPASSABLE:C.collisionMap[n][o]=V.PASSABLE}return u.offset=I.Vector(0,0),u}}),Y=(a.draw=function(){C.context.drawImage(a.canvas,0,0)},a.scrollHandler=function(){C.map&&!Y.has(C.mousePosition.X,C.mousePosition.Y)&&(C.mousePosition.X<2*B&&0<C.map.offset.X&&C.map.horizontal(1),C.mousePosition.X>a.width-2*B&&C.map.offset.X<C.map.width-a.width/B&&C.map.horizontal(-1),C.mousePosition.Y<2*B&&0<C.map.offset.Y&&C.map.vertical(1),C.mousePosition.Y>C.canvas.height-2*B)&&C.map.offset.Y<C.map.height-(C.canvas.height/B+.5|0)&&C.map.vertical(-1)},m.GUARD=0,{topline:30,minimapImage:null,hudPosition:{X:10,Y:10},hudSize:{W:512,H:160},alpha:m.AGRESSIVE=1,actionButtons:[],tooltips:[],buildables:[x.mine,x.powerplant,x.turret,x.factory],unitBuildables:[x.tank,x.heavyTank],modalMessage:"",alertMessage:{time:m.CEASEFIRE=0,text:""},minimapUnits:((e=document.createElement("canvas")).width=128,e.height=128,{canvas:e,context:e.getContext("2d")}),has:function(t,e){return t>Y.hudPosition.X&&t<Y.hudPosition.X+Y.hudSize.W&&e>Y.hudPosition.Y&&e<Y.hudPosition.Y+Y.hudSize.H},alert:function(t){Y.alertMessage={time:(new Date).getTime(),text:"⚠ "+t}},drawAlert:function(){2e3<(new Date).getTime()-Y.alertMessage.time?Y.alertMessage.time=0:(C.context.save(),C.context.strokeStyle="yellow",C.context.fillStyle="black",C.context.font="24px Dejavu Sans, Arial",C.context.textAlign="center",C.context.strokeText(Y.alertMessage.text,C.canvas.width/2,50),C.context.fillText(Y.alertMessage.text,C.canvas.width/2,50),C.context.restore())},modal:function(){C.context.save(),C.context.fillStyle="rgba(0, 0, 0, 0.5)",C.context.fillRect(0,0,C.canvas.width,C.canvas.height),C.context.strokeStyle="yellow",C.context.fillStyle="black",C.context.font="24px Dejavu Sans, Arial",C.context.textAlign="center",C.context.strokeText(Y.modalMessage,C.canvas.width/2,C.canvas.height/2),C.context.fillText(Y.modalMessage,C.canvas.width/2,C.canvas.height/2),C.context.restore()},box:function(t,e,n,o){C.context.fillStyle="rgba(0, 255, 0, 0.5)",C.context.strokeStyle="black",C.context.fillRect(t,e,n,o),C.context.strokeRect(t,e,n,o)},label:function(t,e,n){C.context.font="10px Dejavu Sans, Arial",C.context.textAlign="left",C.context.fillStyle="black",C.context.fillText(t,e,n)},draw:function(){Y.hud(),Y.stats(),Y.minimap(),1===C.selectedUnits.length&&C.selectedUnits.get(0).factory?Y.factory(C.selectedUnits.get(0)):0<C.selectedUnits.length?Y.selection():Y.factory(),""!==Y.modalMessage&&Y.modal(),0<Y.alertMessage.time&&Y.drawAlert();var t=Y.buttonAt(C.mousePosition.X-Y.hudPosition.X,C.mousePosition.Y-Y.hudPosition.Y);if(-1!==t&&t<Y.actionButtons.length&&t<Y.tooltips.length){var e=Y.tooltips[t].split(",");Y.box(C.mousePosition.X,C.mousePosition.Y-15,80,30);for(var n=0;n<e.length;n++)Y.label(e[n],C.mousePosition.X+10,C.mousePosition.Y+12*n)}},factory:function(o){var t,e=o?Y.unitBuildables:Y.buildables;Y.actionButtons=[],Y.tooltips=[],C.context.save(),C.context.translate(Y.hudPosition.X,Y.hudPosition.Y),C.context.globalAlpha=Y.alpha;for(var n,a=0;a<e.length;a++)t=e[a].cost<C.players[0].credits?"grey":"red",e[a].art(100+40*a,16,t,"black",0,0,!0),Y.label("$"+e[a].cost,100+40*a,16),function(n){var t=n.name;n.upkeep&&(t+=",⚡"+n.upkeep),Y.tooltips.push(t),Y.actionButtons.push(function(){var t,e;o?(t=C.spiral(1,o.tile)[0],(t=C.players[0].unit(t.X,t.Y,n))&&(e=C.spiral(1,o.rallyPoint||o.tile)[0],t.go(e,!1))):C.buildMode=n})}(e[a]);o&&(Y.tooltips.push((n=o).name+",Sell for $"+n.spec.cost/2),Y.actionButtons.push(function(){C.deselectAll(),C.sell(n)}),r.sell(100+40*e.length,16,"green","black",0,0,!0)),C.context.restore()},stats:function(){var t=C.players[0];C.context.save(),C.context.globalAlpha=Y.alpha,C.context.translate(Y.hudPosition.X,Y.hudPosition.Y),C.context.lineWidth=4,C.context.fillStyle="yellow",C.context.strokeStyle="black",C.context.font="30px Dejavu Sans, Arial",C.context.strokeText("⚡",20,Y.topline),C.context.fillText("⚡",20,Y.topline),C.context.strokeText("$",20,Y.topline+40),C.context.fillText("$",20,Y.topline+40),C.context.font="20px Dejavu Sans, Arial",C.context.strokeText("⚔",20,Y.topline+80),C.context.fillText("⚔",20,Y.topline+80),C.context.fillStyle="black",C.context.font="16px Dejavu Sans, Arial",C.context.fillText(t.energy,50,Y.topline),C.context.fillText(t.credits,50,Y.topline+40),C.context.fillText(t.kills+"/"+t.deaths,50,Y.topline+80),C.context.restore()},hud:function(){C.context.save(),C.context.globalAlpha=Y.alpha,C.context.fillStyle="grey",C.context.strokeStyle="black",C.context.lineWidth=4,C.context.translate(Y.hudPosition.X,Y.hudPosition.Y),C.context.fillRect(0,0,Y.hudSize.W,Y.hudSize.H),C.context.strokeRect(0,0,Y.hudSize.W,Y.hudSize.H),C.context.restore()},minimap:function(){Y.minimapImage||(Y.minimapImage=C.map.drawMini()),Y.minimapUnits.context.clearRect(0,0,128,128),C.units.each(function(){this.owner===C.players[0]?Y.minimapUnits.context.fillStyle="#7eff15":Y.minimapUnits.context.fillStyle="#ff7e15",Y.minimapUnits.context.fillRect(this.tile.X,this.tile.Y,2,2)}),C.context.save(),Y.minimapUnits.context.strokeRect(C.map.offset.X,C.map.offset.Y,C.canvas.width/B,C.canvas.height/B),C.context.globalAlpha=.5*Y.alpha,C.context.drawImage(Y.minimapImage,Y.hudPosition.X+368,Y.hudPosition.Y+16),C.context.globalAlpha=Y.alpha,C.context.drawImage(Y.minimapUnits.canvas,Y.hudPosition.X+368,Y.hudPosition.Y+16),C.context.restore()},selection:function(){Y.actionButtons=[],C.context.save(),C.context.translate(Y.hudPosition.X,Y.hudPosition.Y),C.context.globalAlpha=Y.alpha;var t,e=0,n=0,o=I.Color("#0F0"),a=0;Y.tooltips=[],C.selectedUnits.each(function(){var t;!this.dead&&a<18&&(Y.tooltips.push((t=this).health+"hp"),Y.actionButtons.push(function(){C.deselectAll(),C.selectedUnits.add(t),t.select()}),o.red=255*(1-this.percent)|0,o.green=255*this.percent|0,this.art(100+e,16+n,o.toString(),"black",0,0,!0),225<(e+=40)&&(e=0,n+=40),a++)}),1!==C.selectedUnits.length||C.selectedUnits.get(0).mobile||(t=C.selectedUnits.get(0),Y.tooltips.push(t.name+",Sell for $"+t.spec.cost/2),Y.actionButtons.push(function(){C.deselectAll(),C.sell(t)}),r.sell(140,16,"green","black",0,0,!0)),o.release(),C.context.restore()},buttonAt:function(t,e){return e-=16,0<(t-=100)&&t<240&&0<e&&e<120&&Y.actionButtons.length>(t=(t/40|0)+6*(e/40|0))?t:-1},click:function(t,e){var n=t-368,o=e-16,a=C.canvas.width/B|0,i=C.canvas.height/B|0;0<n&&n<128&&0<o&&o<128&&(C.map.offset.X=n&127-a|0,C.map.offset.Y=o&127-i|0,C.map.draw()),-1!==(n=Y.buttonAt(t,e))&&Y.actionButtons[n]()}}),B=32,C={tileSize:32,difficulty:1,root:X.Node(),count:0,frames:0,selectedUnits:X.Node(),mousePosition:{X:0,Y:0},units:X.Node(),enemy:X.Node(),fps:0,playerCount:0,players:[],buildMode:null,collisionMap:[],map:[],energy:0,energyWarning:0,colors:["#3A3","#A3A","#AA3"],EASY:0,MEDIUM:1,HARD:2},V={PASSABLE:0,UNPASSABLE:1,UNIT:2,STRUCTURE:3,RESERVED:4},o=(C.deselectAll=function(){C.selectedUnits.each(function(){this.deselect()}),C.selectedUnits.clear()},C.sell=function(t){t.dead||(t.owner.credits+=t.spec.cost/2,t.die())},C.canvasInit=function(){C.canvas=document.getElementById("game"),C.context=C.canvas.getContext("2d"),C.canvas.width=window.innerWidth,C.canvas.height=window.innerHeight},C.init=function(t){C.start=(new Date).getTime(),C.difficulty=t,C.canvas||C.canvasInit(),C.canvas.addEventListener("mousedown",function(t){C.mouseDown=!0,C.dragStart={X:t.clientX,Y:t.clientY},Y.has(t.clientX,t.clientY)&&(C.uiDrag={X:t.clientX-Y.hudPosition.X,Y:t.clientY-Y.hudPosition.Y})}),C.canvas.addEventListener("mousemove",function(t){var e;C.mousePosition.X=t.clientX,C.mousePosition.Y=t.clientY,C.mouseDown&&(e=C.dragStart,w=t.clientX-C.dragStart.X,h=t.clientY-C.dragStart.Y,C.uiDrag?(Y.alpha=.5,Y.hudPosition={X:e.X+w-C.uiDrag.X,Y:e.Y+h-C.uiDrag.Y}):(w<0&&(e.X+=w,w*=-1),h<0&&(e.Y+=h,h*=-1),C.selection=[e.X,e.Y,w,h]))}),document.addEventListener("keydown",function(t){var e=t.keyCode-48;if(t.ctrlKey){if(t.preventDefault(),0<e&&e<10)return C.units.each(function(){this.team===e&&(this.team=0)}),C.selectedUnits.each(function(){this.team=e}),!1}else 0<e&&e<10&&C.players[0].selectTeam(e);var n=-1;switch(t.keyCode){case 81:n=0;break;case 87:n=1;break;case 69:n=2;break;case 82:n=3;break;case 84:n=4;break;case 27:C.deselectAll(),o.hide("shortcuts");break;case 112:t.preventDefault(),o.show("shortcuts")}-1!==n&&Y.actionButtons[n]&&Y.actionButtons[n]()}),C.canvas.addEventListener("mouseup",function(t){var e,n,o,a;return C.mouseDown=!1,Y.has(t.clientX,t.clientY)?Y.click(t.clientX-Y.hudPosition.X,t.clientY-Y.hudPosition.Y):C.buildMode?(0===t.button&&(e=C.buildMode,o={X:t.clientX/B+C.map.offset.X|0,Y:t.clientY/B+C.map.offset.Y|0},C.legalPosition(o,C.buildMode)?C.players[0].build(o.X,o.Y,e):Y.alert("You can't build that there.")),t.shiftKey||(C.buildMode=null)):C.uiDrag||(I.Vec.distance(C.dragStart,{X:t.clientX,Y:t.clientY})<32?(n=!1,0===t.button?(C.units.each(function(){this.click(t.clientX,t.clientY)&&(n=!0)}),n||(o=C.map.at(t.clientX,t.clientY),a=C.spiral(C.selectedUnits.length,o),C.selectedUnits.each(function(){this.targetUnit=null,this.go(a.shift())}))):C.deselectAll()):(C.deselectAll(),C.units.each(function(){this.isInside(C.selection)&&this.owner.local&&this.mobile&&(this.select(),C.selectedUnits.add(this))}))),C.uiDrag=!1,Y.alpha=1,C.selection=null,!1}),a(window.innerWidth,window.innerHeight)},C.run=function(){C.frames++;for(var t,e=0;e<C.players.length;e++)C.players[e].update();C.root.each(function(){this.draw()}),C.selection&&(C.context.fillStyle="rgba(30, 210, 230, 0.5)",C.context.fillRect.apply(C.context,C.selection)),C.buildMode&&(t="grey",n=C.map.at(C.mousePosition.X,C.mousePosition.Y),(!C.legalPosition(n,C.buildMode)||C.buildMode.cost>C.players[0].credits)&&(t="red"),C.buildMode.art(C.mousePosition.X-C.mousePosition.X%32,C.mousePosition.Y-C.mousePosition.Y%32,t,"black",0,0,!0));var n=(new Date).getTime();C.players[0].energy<0&&1e4<n-C.energyWarning&&(Y.alert("Low energy, buildings offline."),C.energyWarning=n),Y.draw(),setTimeout(C.run,5)},C.unitAt=function(t){var e=null;return C.units.each(function(){this.tile.X===t.X&&this.tile.Y===t.Y&&(e=this)}),e},C.spiral=function(t,e,n){for(var o,a=0,i=0,l=0,r=-1,c=[];c.length<t;)(a==i||a<0&&a==-i||0<a&&a==1-i)&&(o=l,l=-r,r=o),n?C.legalPosition({X:e.X+a,Y:e.Y+i},n)&&c.push({X:e.X+a,Y:e.Y+i}):C.collisionMap[e.X+a]&&C.collisionMap[e.X+a][e.Y+i]===V.PASSABLE&&c.push({X:e.X+a,Y:e.Y+i}),a+=l,i+=r;return c},C.legalPosition=function(t,e){var n;return"number"==typeof e.terrain?(n=!1,C.units.each(function(){this.spec==e&&I.Vec.distance(this.tile,t)<6&&(n=!0)}),!n&&C.map.map[t.X]&&C.map.map[t.X][t.Y]===e.terrain&&(C.collisionMap[t.X][t.Y]!==V.UNIT||V.STRUCTURE)):e.big?C.map.map[t.X]&&0!==C.map.map[t.X][t.Y]&&0!==C.map.map[t.X+1][t.Y]&&0!==C.map.map[t.X][t.Y+1]&&0!==C.map.map[t.X+1][t.Y+1]&&C.collisionMap[t.X][t.Y]===V.PASSABLE&&C.collisionMap[t.X+1][t.Y]===V.PASSABLE&&C.collisionMap[t.X][t.Y+1]===V.PASSABLE&&C.collisionMap[t.X+1][t.Y+1]===V.PASSABLE:C.map.map[t.X]&&0!==C.map.map[t.X][t.Y]&&C.collisionMap[t.X][t.Y]===V.PASSABLE},g.modes={LOCAL:0,AI:1,NETWORK:2},{click:function(t,e){document.getElementById(t).addEventListener("click",e)},hide:function(t){document.getElementById(t).style.display="none"},show:function(t){document.getElementById(t).style.display="block"}});window.addEventListener("load",function(){o.click("play",function(){o.show("difficulty")}),o.click("help",function(){o.show("shortcuts")}),o.click("easy",function(){o.hide("menu"),t(0)}),o.click("medium",function(){o.hide("menu"),t(1)}),o.click("hard",function(){o.hide("menu"),t(2)}),o.click("shortcuts",function(){o.hide("shortcuts")})})</script>