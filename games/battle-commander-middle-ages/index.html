<!doctype html><title>Battle commander - Middle ages - js13kGames 2023</title><style>#c2d{width:min(100vw,calc(100vh * 16/9));position:absolute;image-rendering:pixelated;image-rendering:crisp-edges}body,html{margin:0;background-color:#000;display:flex;justify-content:center;align-items:center;height:100%}</style><canvas height=1080 id=c2d width=1920></canvas><script>function j(t=0,i=0){return Math.floor(Math.random()*(i-t)+t)}var M=(t=1,i=0)=>Math.random()*(i-t)+t;let a=Math.PI;function o(t){return null!=t.time&&t.time<A}class S{constructor(t){this.time=null==t?void 0:A+t,this.g=t}set(t=0){this.time=A+t,this.g=t}kb(){return null!=this.time}active(){return null!=this.time&&A<=this.time}get(){return null!=this.time&&this.kb()?A-this.time:0}}function c(t,i){var h=i.x-t.x;return t=i.y-t.y,Math.sqrt(h*h+t*t)}function s(t,i){return t.x/=i,t.y/=i,t}function R(t){var i=t.x;return t=t.y,Math.sqrt(i*i+t*t)}class E{constructor(t,i){this.x=t,this.y=i}get key(){return this.x.toFixed(2)+","+this.y.toFixed(2)}add(t){return this.x+=t.x,this.y+=t.y,this}scale(t){return this.x*=t,this.y*=t,this}normalize(){return s(this,R(this))}unit(){return s(this,R(this))}length(){return R(this)}abs(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this}ea(t){var i=this.x-t.x;return t=this.y-t.y,Math.sqrt(i*i+t*t)}rotate(t){var i=Math.cos(t),h=(t=Math.sin(t),this.x),s=this.y;return this.x=h*i-s*t,this.y=h*t+s*i,this}clone(){return new E(this.x,this.y)}heading(){return Math.atan2(this.y,this.x)}}function H(t,i=k.h){t.sort((t,i)=>-(1e4*(i.i.y+i.O)+i.i.x)+(1e4*(t.i.y+t.O)+t.i.x)).forEach(t=>{t.F(i)})}function g(t,i,h,s,e="white"){var a=k.h;a.font=i+"px Impact, sans-serif-black",a.textAlign="center",a.strokeStyle="black",a.lineWidth=7,a.miterLimit=2,a.strokeText(t,h,s),a.fillStyle=e,a.fillText(t,h,s)}function O(t,i,h={stroke:"",fill:""}){var s=k.h;s.beginPath(),s.strokeStyle=h.stroke,s.lineWidth=3,s.rect(t.x,t.y,i.x,i.y),s.stroke(),""!=h.fill&&(s.fillStyle=h.fill,s.rect(t.x,t.y,i.x,i.y),s.fill())}function u(t,i=10,h={stroke:"",fill:"",lineWidth:3}){var s=k.h;s.beginPath(),s.strokeStyle=h.stroke,s.lineWidth=h.lineWidth,s.arc(t.x,t.y,i/2,0,2*Math.PI),s.stroke(),""!=h.fill&&(s.fillStyle=h.fill,s.arc(t.x,t.y,i/2,0,2*Math.PI),s.fill())}function G(t,i,h={stroke:"rgba(127,255,212,0.85)",fill:""}){var s=k.h;s.beginPath(),s.strokeStyle=h.stroke,s.lineWidth=3,s.moveTo(t.x,t.y),s.lineTo(i.x,i.y),s.stroke()}function J(t,i,h,s="#ff0",e="#ff0",a=!0){var n=k.g/2,l=k.h;i=(h-i)/h,l.save(),l.translate(t,110),t=0,l.beginPath(),l.strokeStyle=e,l.lineWidth=12,l.moveTo(t-n/2,0),l.lineTo(t+n/2,0),l.stroke(),l.beginPath(),l.strokeStyle=s,l.lineWidth=12,a?(l.moveTo(t+n/2,0),l.lineTo(t+n/2-n*i,0)):(l.moveTo(t-n/2,0),l.lineTo(t-n/2+n*i,0)),l.stroke(),l.restore()}let U,k=new class{constructor(){this.l=[],this.h=c2d.getContext("2d"),c2d.getContext("2d")}get g(){return this.h.canvas.width}get j(){return this.h.canvas.height}drawImage(t,i,h){var s=this.h;s.imageSmoothingEnabled=!1,s.drawImage(t,i,h-8,64,64)}};function C(t){var i=U;i.g.L=!1,i.g.Ka?.(),i.g=t,i.g.za?.(),setTimeout(()=>{i.g.L=!0},200)}class K{constructor(...t){this.g=v,this.g.za?.(...t),setTimeout(()=>{this.g.L=!0},200)}}let f=new class{constructor(){this.na=!1,this.g=new Map,this.h={na:this.na},document.addEventListener("keydown",t=>{this.g.set(t.code,!0)}),document.addEventListener("keyup",t=>{this.g.set(t.code,!1)})}};class N{constructor(t,i,h){this.L=!0,this.h=this.O=0,this.N=9.8,this.J=1,this.P=this.oa=100,this.ua=this.ia=this.R=0,this.i=t.clone(),this.m=i.clone(),this.I=new E(0,0),this.W=new E(0,0),this.ra=1,this.B=h}Na(t){return class{constructor(t){this.x=t.x,this.y=t.y,this.r=t.r,this.data=t.data}Na(t){var i=[],h=t.width/2,s=t.height/2,e=t.y+s;for(t=[[l=t.x+h,t.y],[t.x,t.y],[t.x,e],[l,e]],e=0;e<t.length;e++){var a=this.x,n=this.y,l=this.r;(a-=Math.max(t[e][0],Math.min(a,t[e][0]+h)))*a+(n-=Math.max(t[e][1],Math.min(n,t[e][1]+s)))*n<l*l&&i.push(e)}return i}}.prototype.Na.call({x:this.i.x,y:this.i.y,r:this.A},t)}get A(){return this.m.length()}set A(t){t=Math.sqrt(t*t),this.m=new E(t,t)}C(t){this.h-=this.N/t,this.O=Math.max(0,this.O+this.h),this.O<1&&(this.h=0)}F(){}ma(){this.L=!1}}class z{constructor(g,u,t=!0){this.g=this.h=0,this.j=[],this.l=g,this.v=t,["s"].forEach(t=>{for(var i=u[t]||[{f:0},{f:g}],h=1;h<i.length;h++)for(var s=i[h-1],e=i[h],a=e.f-s.f,n=0;n<a;n++){var l=n/a,r=this.j[s.f+n],o=r||{},c={};s.hasOwnProperty("p")?c.ha=new E(s.p[0]+(e.p[0]-s.p[0])*l,s.p[1]+(e.p[1]-s.p[1])*l):c.ha=new E(0,0),s.hasOwnProperty("r")?c.r=s.r+(e.r-s.r)*l:c.r=0,o[t]=c,r||this.j.push(o)}})}get o(){return this.j[this.g]}get u(){return!this.v&&this.g===this.l-1}C(){this.h+=1,this.g=Math.floor(this.h),this.g>this.l-1&&(this.h=this.g=0)}}var q={s:[{f:0,r:-2.094,p:[0,0]},{f:10,r:-2.139,p:[0,0]},{f:20,r:-2.094,p:[0,0]}]},Y={s:[{f:0,r:-a-.5,p:[0,-20]},{f:4,r:1.5-a,p:[0,0]},{f:16,r:1.6-a,p:[0,0]}]};let Z=[0,1,2,3,4,5],B="Troop Testudo Archer Knight Artillery Cavalry".split(" "),h=[];function I(i){return h.find(t=>t.type===i)||{type:-1,name:"",K:0,ja:0,ba:0,da:0,T:0,Aa:0,Z:0,ca:0}}function T(t){return 6==t?new E(4,4):7==t?new E(8,8):new E(20,20)}let V=new class{get g(){return h.filter(t=>![6,7,8].includes(t.type))}get data(){return h}};class X{constructor(t,i,h,s){this.Ga=s,t=this.g=new E(t,i),i=this.Ga,(s=new E(0,0)).x=t.x*i.x,s.y=t.y*i.y,this.ha=s,this.Bb=h,this.height=0}}let Q=.5*(Math.sqrt(3)-1),x=(3-Math.sqrt(3))/6,y=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]);class ${constructor(t=new E(60,60),i=new E(5,5),h=81962){this.g=[];var s=(()=>{let w=(t=>{for(var i=new Uint8Array(512),h=new Uint8Array(512),s=new Uint8Array(256),e=0;e<256;e++)s[e]=e;for(e=0;e<255;e++){var a=e+~~(t()*(256-e)),n=s[a];s[a]=s[e],i[e]=i[e+256]=n,h[e]=h[e+256]=n%12}return t=s[255],i[255]=i[511]=t,h[255]=h[511]=t%12,{Jb:i,Kb:h}})(()=>h);return{Ib:(t,i)=>{var{Jb:h,Kb:s}=w,e=0,a=0,n=0,l=(t+i)*Q,r=Math.floor(t+l),o=Math.floor(i+l),c=i-(o-(f=(r+o)*x)),g=(l=t-(r-f))>c?1:0,u=c<l?0:1,f=l-g+x,d=c-u+x,b=(i=l-1+2*x,t=c-1+2*x,r&=255,o&=255,.5-l*l-c*c);return 0<=b&&(e=3*s[r+h[o]],e=(b*=b)*b*(y[e]*l+y[e+1]*c)),0<=(l=.5-f*f-d*d)&&(a=3*s[r+g+h[o+u]],a=(l*=l)*l*(y[a]*f+y[a+1]*d)),0<=(l=.5-i*i-t*t)&&(n=3*s[1+r+h[1+o]],n=(l*=l)*l*(y[n]*i+y[n+1]*t)),70*(e+a+n)}}})();for(this.Ga=i,i=t.y;i--;){for(var e=[],a=t.x;a--;){var n=s.Ib(i/20,a/20),l=0;n<0?l=1:n<.35?l=2:n<.94?l=3:n<1&&(l=4),n=new X(a,i,l,this.Ga),e.push(n)}this.g.push(e.reverse())}this.g.reverse()}}let _=[0,1,2,3];function tt(t){t.j=new $(t.l,t.size,t.h),t.g=void 0}function it(t,i=15){var h=k.h,s=k.g,e=k.j;if(t.g)h.filter="contrast(120%) brightness(150%) saturated(200%)",h.filter="blur("+i+"px)",h.globalAlpha=.8,h.drawImage(t.g.canvas,s/2-s/2,e/2-e/2),h.filter="none",h.globalAlpha=1;else{var a=[["#fff","#28691e","#38792e","#48893e","#564d40"],["#F0E2AE","#F2CA9D","#E7A885","#CE8A7A","#C37F7C"],["#FE6927","#FFD85F","#FEE8AA","#FCEC9C","#FFE293"],["#fff","#ddd","#bbb","#999","#777"]][t.la];let i=c2d.cloneNode().getContext("2d");t.j.g.forEach(t=>{t.forEach(t=>{i.fillStyle=a[t.Bb],i.beginPath(),i.rect(t.ha.x,t.ha.y,t.Ga.x,t.Ga.y),i.fill()})}),t.g=i}}class t{constructor(t=new E(60,60),i=new E(5,5),h=81962,s=0){this.la=0,this.l=t,this.size=i,this.h=h,this.la=s,this.j=new $(t,i,h)}}function ht(t,i){t.o=new E(.82*k.g,.6*k.j),t.H=i,i=t.g[t.H],t.Ya=i.Ya,t.la=i.la,t.h=i.vb,t.Ua=i.Ua,t.l=i.Db,t.u=i.Eb,t.j=new S(60),t.V=0}let d=new class{constructor(){this.H=0,this.o=new E(1,1),this.l=0,this.g=[],this.Ua=!1,this.Ya=[],this.V=0,this.u=Z[0],this.h=1,this.j=new S(0),this.la=j(0,_.length+1),[[10,0,0,2,0],[50,2,1,1.5,0],[100,3,0,1.5,0],[20,4,1,1.5,0],[30,5,3,1.2,1],[100,-1,0,1.5,1],[150,-1,0,1,1],[200,-1,0,1,1],[150,-1,0,1,1],[100,-1,0,1.5,1],[100,-1,0,1.5,1],[100,-1,0,1.5,1],[500,-1,1,.7,0]].forEach((t,i)=>{var h=[];h.push(0),h.push(1),h.push(2),0<i&&h.push(3),0<i&&h.push(4),1<i&&h.push(5),i=0,this.g.push({Ya:[...h],Db:t[i++],Eb:t[i++],la:t[i++],vb:t[i++],Ua:1==t[i++],V:0,Ia:0})}),ht(this,this.H)}};function st(t,i=0,h=!1){t.image=function(t=0,i=!1){var h=c2d.cloneNode(),s=(h.width=32,h.height=32,h.getContext("2d"));switch(s.imageSmoothingEnabled=!1,s.beginPath(),t){case 3:t=1;break;case 5:t=2;break;default:t=0}if(s.filter="drop-shadow(1px 1px 1px #222)",s.drawImage(Zt,32*Math.floor(t%8),32*Math.floor(t/8),32,32,0,0,32,32),i){i=(t=s.getImageData(0,0,h.width,h.height)).data;var e=[255,0,0,255],a=[0,0,255,255];for(let t=0;t<i.length;t+=4)i[t]===e[0]&&i[t+1]===e[1]&&i[t+2]===e[2]&&(i[t]=a[0],i[t+1]=a[1],i[t+2]=a[2],i[t+3]=a[3]);s.putImageData(t,0,0)}return(s=new Image).src=h.toDataURL(),s}(i,h)}function e(t){t.P=t.oa=t.j.ja,t.ia=t.R=t.j.ba,t.ua=t.j.da,t.Z=t.j.Z,t.X=t.j.ca,t.j.ka&&(t.ka=t.j.ka),t.D=.3*t.ka,t.l=t.j.Aa,t.T=t.j.T,t.u=t.A*t.T/200,t.Fa=0}function et(t){0==t.O&&.5<M()&&(t.h+=t.m.y/8)}function at(t){t.g&&(t.g.Y=t.g.Ab.clone().scale(t.m.clone().scale(.03125).y),t.g.ga=t.g.Y.y)}function nt(t,i,h,s,e,a,n,l=6){n&&(s/=e,i.beginPath(),i.strokeStyle="#fff",i.lineWidth=8,i.moveTo(t.i.x-t.m.x/2,t.i.y+h),i.lineTo(t.i.x+t.m.x/2,t.i.y+h),i.stroke(),i.beginPath(),i.strokeStyle=a,i.lineWidth=l,i.moveTo(t.i.x-t.m.x/2,t.i.y+h),i.lineTo(t.i.x-t.m.x/2+t.m.x*s,t.i.y+h),i.stroke())}class b extends N{constructor(t,i=1,h,s){super(t,i=T(s).scale(i),h),this.type=-1,this.image=new Image,this.Xa=new E(32,32),this.Fa=this.u=this.Qa=0,this.sa=!1,this.D=this.ka=this.Z=0,this.Ra=new S(0),this.Fb=this.lb=this.X=0,this.zb=!1,this.T=1,this.l=0,this.Oa=new S(0),this.nb=!0,this.j=I(s),this.Ca=i,this.name="unit-"+Math.random().toString(36).substr(2,5),this.type=s,st(this,s,2==h),e(this),this.G=new z(20,q),this.ta=new z(16,Y,!1),this.aa=this.G}get Da(){return this.A*this.Z}get ub(){return this.A*this.ka}setActive(t){this.Ra=new S(0),this.Fa=t}wa(){}Ea(){}attack(){this.aa=this.ta}Ba(){}fa(){}ma(){this.fa(),super.ma()}C(t){var i,h,s;at(this),this.aa.C(t),this.aa==this.ta&&this.aa.u&&(this.aa=this.G,this.m=this.Ca.clone()),this.zb&&et(this),this.M&&this.M&&(i=function(t,i=new E(0,0)){let h=0,s=0,e=t.i;return 1<(e=R(i=new E(i.x-e.x,i.y-e.y)))&&(h=i.heading()-t.Qa,s=t.A),{Hb:s,r:h,d:e}}(this,this.M),this.Qa+=i.r,h=+i.Hb/t,h=Math.min(this.u,h),s=this.Qa,void 0===h&&(h=1),this.W.add(new E(h*Math.cos(s),h*Math.sin(s))),i.d<4)&&(this.M=void 0),super.C(t),t=!1,null!=this.M&&(t=this.i.ea(this.M)<this.Da),this.M&&t&&o(this.Ra)&&(this.aa=this.ta,this.attack(),this.Ra.set(this.X))}F(t){Z.includes(this.type)&&1<=d.g[d.H].vb&&this.nb&&(nt(this,t,.9*+this.A,this.ia,this.R,["","#666","#666"][this.B],0<this.ia,8),nt(this,t,.9*+this.A,this.P,this.oa,["","#f00","#00f"][this.B],0==this.ia&&0<this.P)),o(this.Oa)||u(this.i,.8*this.A,{stroke:"transparent",fill:["","rgb(255,0,0,.4)","rgb(0,0,255,.4)"][this.B],lineWidth:3}),super.F(t)}}function lt(t,i){if(t.g.length)for(var h=i.Na(t.j),s=0;s<h.length;s++)lt(t.g[h[s]],i);else if(t.h.push(i),t.h.length>t.ya&&t.l<t.Ja){if(!t.g.length){i=t.l+1;for(var h=t.j.width/2,s=t.j.height/2,e=[{x:(e=t.j.x)+h,y:a=t.j.y},{x:e,y:a},{x:e,y:a+s},{x:e+h,y:a+s}],a=0;a<4;a++)t.g[a]=new rt({x:e[a].x,y:e[a].y,width:h,height:s,ya:t.ya,Ja:t.Ja},i)}for(i=0;i<t.h.length;i++)for(h=t.h[i].Na(t.j),s=0;s<h.length;s++)lt(t.g[h[s]],t.h[i]);t.h=[]}}class rt{constructor(t,i=0){this.j={x:t.x||0,y:t.y||0,width:t.width,height:t.height},this.ya="number"==typeof t.ya?t.ya:10,this.Ja="number"==typeof t.Ja?t.Ja:4,this.l=i,this.h=[],this.g=[]}clear(){this.h=[];for(let t=0;t<this.g.length;t++)this.g.length&&this.g[t].clear();this.g=[]}}class ot{constructor(){this.i=new E(0,0),this.h=this.g=!1}}let w=new class{constructor(){this.v=this.u=0,this.g=new ot,this.h=()=>{},this.j=()=>{},this.l=()=>{},this.G=()=>{},this.D=()=>{},this.o=t=>{var i=c2d.getBoundingClientRect();this.u=(t.clientX-i.left)/c2d.offsetWidth*1920,this.v=(t.clientY-i.top)/(c2d.offsetWidth/(1920/1080))*1080,this.g.i=new E(this.u,this.v)},this.R=t=>{var i=window.event;i.which?this.g.g=1==i.which:i.button&&(this.g.g=0==i.button),i.which?this.g.h=3==i.which:i.button&&(this.g.h=1==i.button),this.o(t),this.g.i=new E(this.u,this.v),this.h()},this.X=t=>(this.o(t),this.j(),t.preventDefault()&&!1),this.S=t=>(this.o(t),this.g.g=!1,this.g.h=!1,this.l(),t.preventDefault()&&!1),this.N=t=>(this.D(),t.preventDefault()&&!1),this.J=t=>((t.wheelDelta?t.wheelDelta/40:t.detail&&-t.detail)&&this.G(),t.preventDefault()&&!1);var t=document.getElementById("c2d");t&&(t.addEventListener("mousedown",this.R,!1),t.addEventListener("mousemove",this.X,!1),t.addEventListener("mouseup",this.S,!1),t.addEventListener("DOMMouseScroll",this.J,!1),t.addEventListener("mousewheel",this.J,!1),t.addEventListener("contextmenu",this.N,!1))}},ct=[.5,0,246.9417,.01,.06,.42,,9.1,20,,2,,,,,,,0,.01],gt=[,0,65.40639,.02,.08,.03,,2.5,,8,,,,,,,.02,0,.03,.05],ut=[.1,,900,,,.5,2,.1,.2,,,,.08,10,,.34,.05,.32,.1,.5],ft=[.5,.01,1696,.01,.08,.14,1,1.9,,2.9,67,.08,,,,,,.66,.03],dt=[.5,,221,,.05,.07,,1.1,,.1,50,,.01,,,,,.9,,.01],bt=[,0,468,.03,.02,.06,,1.37,-9,2.6,-100,.02,.01,-.3,,-.1,.01,.57,.06,.01],wt=[.03,.5,293.6648,.06,.21,.01,,0,,1,1,.2,,100,-20,,,0,.02],xt=[3,0,130.8128,.1,1,.3,,.9,,-.4,,,-.1,,,,.1,.3,.1,.01],yt=[1.09,,150,.02,.06,.04,,2.41,-5.8,,,,,1,,.1,,.47,.02],mt=[.5,,1115,.02,.01,.04,4,1.13,-.4,.2,542,.13,-.04,.1,3,.1,,.12,.01,.25],pt=new AudioContext,F=f=>{if(o(Xt)){{var[d=1,b=.05,w=220,x=0,y=0,m=.1,p=0,v=1,A=0,j=0,M=0,S=0,E=0,k=0,C=0,B=0,I=0,T=1,F=0,W=0]=[...f];let t,i,h=Math,s=2*h.PI,e=A*=500*s/44100/44100,a=w*=(1-b+2*b*h.random(b=[]))*s/44100,n=0,l=0,r=0,o=1,c=0,g=0,u=0;for(j*=500*s/44100**3,C*=s/44100,M*=s/44100,S*=44100,E=44100*E|0,i=(x=44100*x+9)+(F*=44100)+(y*=44100)+(m*=44100)+(I*=44100)|0;r<i;b[r++]=u)++g%(100*B|0)||(u=p?1<p?2<p?3<p?h.sin((n%s)**3):h.max(h.min(h.tan(n),1),-1):1-(2*n/s%2+2)%2:1-4*h.abs(h.round(n/s)-n/s):h.sin(n),u=(E?1-W+W*h.sin(s*r/E):1)*(0<u?1:-1)*h.abs(u)**v*d*.25*(r<x?r/x:r<x+F?1-(r-x)/F*(1-T):r<x+F+y?T:r<i-I?(i-r-I)/m*T:0),u=I?u/2+(I>r?0:(r<i-I?1:(i-r)/I)*b[r-I|0]/2):u),t=(w+=A+=j)*h.cos(C*l++),n+=t-t*k*(1-1e9*(h.sin(r)+1)%2),o&&++o>S&&(w+=M,a+=M,o=0),!E||++c%E||(w=a,A=e,o=o||1);(d=pt.createBuffer(1,i,44100)).getChannelData(0).set(b),(w=pt.createBufferSource()).buffer=d,w.connect(pt.destination),w.start()}Xt.set(.05)}};function W(t){let{style:i,wb:h}={style:{text:"#ccc",color:"transparent",lineWidth:0,xa:"transparent",fontSize:60},wb:{text:"white",color:"rgb(150,150,150,.3)",lineWidth:0,xa:"transparent",fontSize:60}};t.forEach(t=>{t.Ha.default=i,t.Ha.Gb=h,t.tb=()=>{F(gt)},t.Sa=()=>{F(yt)}})}function n(t){var i,h,s=w.g.i;t.visible&&t.enabled&&(i=t.i.x-t.width/2,h=t.i.y-t.height/2,s.x>=i)&&s.x<=i+t.width&&h<=s.y&&s.y<=h+t.height&&(t.Sa(),"function"==typeof t.g&&t.g(t),t.h="default")}class P{constructor(t,i,h,s,e="",a="",n=50,l={default:{text:"#ccc",color:"transparent",lineWidth:0,xa:"transparent",fontSize:n},hover:{text:"#fff",color:"rgb(150,150,150,.3)",lineWidth:0,xa:"#ccc",fontSize:n},active:{text:"#fff",color:"rgb(200,200,200,.3)",lineWidth:0,xa:"#ccc",fontSize:n},disabled:{text:"#fff",color:"#ababab",lineWidth:0,xa:"#ccc",fontSize:n}}){this.enabled=this.visible=!0,this.selected=!1,this.i=new E(t,i),this.m=new E(h,s),this.name="",this.width=h,this.height=s,this.text=e,this.title=a,this.data="",this.g=()=>{},this.Ha=l,this.h="default",this.tb=()=>{},this.Sa=()=>{}}C(){var t,i,h;this.visible&&w.g&&(t=w.g.i,i=this.i.x-this.width/2,h=this.i.y-this.height/2,t.x>=i&&t.x<=i+this.width&&h<=t.y&&t.y<=h+this.height?this.enabled&&("active"!=this.h&&"hover"!=this.h&&(this.tb(),this.h="hover"),"active"!=this.h)&&w.g.g&&(this.h="active"):this.h="default")}qa(t){var i;this.visible&&(i=this.Ha[this.h],t.save(),t.translate(this.i.x,this.i.y),t.save(),!this.enabled||"hover"!=this.h&&"active"!=this.h||t.scale(1.05,1.05),this.enabled||(t.globalAlpha=.2),t.strokeStyle=i.xa,t.lineWidth=i.lineWidth,t.fillStyle=i.color,t.beginPath(),t.rect(-this.width/2,-this.height/2,this.width,this.height),t.fill(),this.selected&&(t.lineWidth=2,t.strokeStyle="#ccc",t.stroke()),g(this.text,i.fontSize,0,this.height/4,i.text),this.unit&&this.unit.F(t),this.enabled&&g(this.data,.5*i.fontSize,0,0+this.height,i.text),t.globalAlpha=1,t.restore(),"hover"==this.h&&g(this.title,.5*i.fontSize,0,0<this.data.length?1.8*this.height:this.height,i.text),t.restore())}}class m extends N{constructor(t,i,h,s,e="#fff"){super(i,h,s),this.h=4,this.N=.98,this.text=t,this.g=50,this.color=e}C(t){0==this.g?this.ma():(super.C(t),--this.g)}F(){g(this.text,this.A,this.i.x,this.i.y-this.O,this.color)}}let vt=new class{constructor(){this.L=!1,this.S=["","YOU WIN!","YOU LOOSE","TIE"],this.result=0,this.fa=Math.random(),this.o=!1,this.h=[],this.buttons=[],this.u=0,this.R=new E(20,22),this.N=new E(96,50),this.X=new t(this.N,this.R,this.fa)}get j(){return 700+100*this.u++}za(){this.o=!1,this.g=this.data.U.alpha-this.data.U.va,this.g=Math.max(0,this.g);{var h=this;let t;h.buttons=[],h.u=0,d.H<12?1==h.result&&((t=new P(k.g/2,h.j-50,500,80,"Next","")).g=()=>{h.v&&clearTimeout(h.v),h.D&&clearTimeout(h.D),h.G&&clearTimeout(h.G),h.J&&clearTimeout(h.J);var t=p,i=t.g;i.H=(i.H+1)%i.g.length,t.Da=Math.random(),Rt(t,t.g.H),C(p)},h.buttons.push(t)):(h.l=new P(k.g/2,h.j-50,500,80,"THE END"),h.buttons.push(h.l)),(t=new P(k.g/2,h.j,500,80,"Try again","")).g=()=>{C(p),Rt(p,p.g.H)},h.buttons.push(t),(t=new P(k.g/2,h.j,500,80,"Back to campaign","")).g=()=>{C(L)},h.buttons.push(t),W(h.buttons),h.l&&(h.l.Sa=()=>{F(xt)})}1==this.result?this.v=setTimeout(()=>{var t,i;(t=this).g&&(0<t.g&&t.g>d.g[d.H].Ia&&(d.g[d.H].Ia=t.g,t.o=!0),0<t.g?t.h.push(new m("+"+t.g,new E(k.g/2,k.j/2),new E(100,100),0)):t.h.push(new m("No score",new E(k.g/2,k.j/2),new E(100,100),0)),i=1e3,t.data.ob>t.data.Za/8&&(t.D=setTimeout(()=>{F(ft),t.h.push(new m("⭐",new E(k.g/2,k.j/2),new E(100,100),0)),d.g[d.H].V+=1},i),i+=1e3),t.data.ob>t.data.Za/4&&(t.G=setTimeout(()=>{F(ft),t.h.push(new m("⭐",new E(k.g/2,k.j/2),new E(100,100),0)),d.g[d.H].V+=1},i),i+=1e3),t.o)&&(t.J=setTimeout(()=>{F(dt),t.h.push(new m("🏆 new HighScore",new E(k.g/2,k.j/2),new E(40,40),0))},i))},1e3):2==this.result&&F(bt),w.h=()=>{w.g.g&&this.buttons.forEach(t=>n(t))}}Ka(){this.buttons=[],w.h=()=>{}}La(i){this.h=this.h.filter(t=>t.L),this.h.forEach(t=>{t.C(i)}),1==this.result&&it(this.X);var t=k.h.canvas.width/2;g("Level "+(d.H+1),80,t,120),g("HighScore: "+d.g[d.H].Ia,40,t,180),null!=this.g&&(g("Red kills: "+this.data?.U.alpha,50,t-200,270,"#d00"),g("Blue kills: "+this.data?.U.va,50,200+t,270,"#00d"),g("Score: "+this.g,60,t,350)),3==this.result&&g(this.S[this.result],80,t,270),1==this.result&&(g("Level cleared! ",80,t,450),g(Array(d.g[d.H].V).fill("⭐").join(""),80,t,530)),H([...this.h]),this.buttons.forEach(t=>{t.C(i),t.qa(k.h)}),f.na&&C(v)}};class At extends N{constructor(t,i=new E(4,4),h){super(t,i,h),this.pb=100}C(){--this.pb}F(t){t.fillStyle=["#333","rgb(255,0,0,.5)","rgb(0,0,255,.5)"][this.B],t.beginPath(),t.arc(this.i.x,this.i.y,Math.max(0,100-this.pb)/100*this.A,0,2*Math.PI),t.fill()}}function l(t,i,h){t.fillStyle="rgba(0,0,0,.5)",t.beginPath(),0<i.O?t.ellipse(i.i.x,i.i.y+2*i.A/3,i.m.x/2/Math.max(1,i.O/10),i.m.x/4/Math.max(1,i.O/10),0,0,2*Math.PI):t.ellipse(i.i.x,i.i.y+2*i.A/3,i.m.x/2,i.m.x/4,0,0,2*Math.PI),t.fill();var s=i.m.clone().scale(2),e=i.i.clone().add(new E(0,-i.O)).add(s.clone().scale(-.5)),s=i.Xa.clone().scale(s.x/32);t.save(),t.translate(e.x+s.x/2,e.y+s.y/2),h&&t.scale(-1,1),t.imageSmoothingEnabled=!1,t.drawImage(i.image,0,0,i.Xa.x,i.Xa.y,-s.x/2,-s.y/2,s.y,s.y),i.wa(t,s),t.restore()}function r(t,i){var h,s,e=k.o;t.P<1&&(s=t.m.clone().scale(2),h=t.i.clone().add(new E(0,-t.O)).add(s.clone().scale(-.5)),s=t.Xa.clone().scale(s.x/32),e.save(),e.translate(h.x+s.x/2,h.y+s.y/2),i&&e.scale(-1,1),e.rotate(Math.PI/2),e.font=.8*t.A+"px Impact, sans-serif-black",e.textBaseline="middle",e.textAlign="center",e.strokeText("💀",0,0),e.restore())}function jt(t,i){return{yb:new E(1,0).rotate(-Math.atan2(t.i.x-i.x,t.i.y-i.y)-Math.PI/2).scale(t.S)}}class D extends b{constructor(t,i,h,s=2){super(t,i,h,s),this.S=14,this.D=0,this.v=new S(0),this.pa=!0,e(this)}setActive(t){super.setActive(t),this.v=new S(1)}o(){}Ba(t){super.Ba(t);var i=jt(this,t);o(this.v)&&(this.o(t,i.yb),this.v.set(this.l))}F(t,i=!1){l(t,this,i=this.sa||i),r(this,i),super.F(t)}wa(t,i){t.translate(-.2*this.m.x,.2*i.y),t.rotate(-.1),t.beginPath(),t.lineWidth=5,t.moveTo(this.m.x,0),t.lineTo(0,0),t.moveTo(this.m.x,0),t.lineTo(.6*this.m.x,.2*this.m.y),t.moveTo(this.m.x,0),t.lineTo(.7*this.m.x,-.2*this.m.y),t.strokeStyle="#a33",t.stroke()}C(t){var i=!1;null!=this.M&&(i=(i=this.i.ea(this.M))<this.ub&&i>this.D),this.pa&&i?(this.I.scale(.5),this.W.scale(.5),this.u=this.A*this.T/1e3):this.u=this.A*this.T/100,super.C(t),this.M&&i&&this.Ba(this.M)}}class Mt extends N{constructor(t,i){super(new E(0,0),t,i),this.Y=this.Ab=t}}class St extends Mt{constructor(t){var i=new E(6,30);super(i,t),this.ga=0,this.ga=i.y}C(){}qa(t,i={ha:new E(0,0),r:0}){t.save(),t.lineWidth=1,t.globalAlpha=this.J,t.translate(this.i.x+i.ha.x,this.i.y+i.ha.y),t.rotate(0+i.r),t.lineWidth=2,t.fillStyle="#bfb6db",t.fillRect(0,5,this.Y.x/2,this.ga),t.fillStyle="#cfc6db",t.fillRect(this.Y.x/2,5,this.Y.x/2,this.ga),t.fillStyle="#333",t.fillRect(this.Y.x/4,0,this.Y.x/2,5),t.restore()}}class Et extends b{constructor(t,i,h,s=0){super(t,i,h,s),this.g=new St(this.B),e(this),at(this)}F(t,i){l(t,this,i=this.sa||i),r(this,i),super.F(t)}wa(t,i){t.translate(0,.3*i.y),i=this.aa.o,this.g&&this.g.qa(t,i.s)}}class kt extends Mt{constructor(t){var i=new E(10,30);super(i,t),this.ga=0,this.ga=i.y}C(){}qa(t,i={ha:new E(0,0),r:0}){t.save(),t.lineWidth=1,t.globalAlpha=this.J,t.translate(this.i.x+i.ha.x,this.i.y+i.ha.y),t.rotate(0+i.r),t.lineWidth=2,t.fillStyle="#ccf",t.fillRect(0,5,this.Y.x/2,this.ga),t.fillStyle="#ddf",t.fillRect(this.Y.x/2,5,this.Y.x/2,this.ga),t.fillStyle="#963",t.fillRect(0,5,this.Y.x,5),t.fillStyle="#333",t.fillRect(this.Y.x/4,0,this.Y.x/2,5),t.restore()}}class Ct extends Et{constructor(t,i,h){super(t,i,h,3),e(this),this.g=new kt(this.B)}F(t,i=!1){super.F(t,this.sa||i),l(t,this,i=this.sa||i),r(this,i)}}class Bt extends D{constructor(t,i,h){super(t,i,h,4),this.Aa=()=>this.l,st(this,4,2==h),e(this),this.S=10}F(t,i){var h,s;super.F(t,i),l(t,this,i=this.sa||i),r(this,i),i=null!=(i=this.v).time&&i.kb()&&([h,s=0]=[i.time-A,i.g],0-s)&&!((h=(h-s)/(0-s))<0)?1<h?1:h:0,this.nb&&i<1&&nt(this,t,+this.A,100*i,100,"#0f0",!0)}wa(t,i){t.translate(.2*this.m.x,.4*i.y),t.rotate(.4),t.lineWidth=2,t.fillStyle="#aaa",t.fillRect(0,0,.2*this.m.x,1.1*-this.m.y),t.fillStyle="#888",t.fillRect(.2*this.m.x,0,.1*this.m.x,1.1*-this.m.y)}}class It extends b{constructor(t,i,h,s,e,a=6){super(t,i,h,a),this.height=50,this.o=s,this.S=t.clone(),this.M=e,this.ea=c(this.M,this.S)}C(){this.O=Math.cos(-a/2+c(this.i,this.S)/this.ea*a)*this.height,this.O<=0&&this.ma()}F(t){var i=["","red","blue"][this.B],h=this.i.clone().add(new E(this.A,this.A).scale(.5));u(h.clone().add(new E(2,2)),this.A,{stroke:"#222",fill:"#222",lineWidth:3}),u(h.add(new E(0,-this.O)),this.A,{stroke:i,fill:i,lineWidth:3}),super.F(t)}}class Tt extends It{constructor(t,i,h,s,e,a=100){super(t,i,h,s,e,7),this.height=a}Ta(){}v(){}ma(){this.v(this.i),super.ma()}F(t){super.F(t),this.M&&g("🎯",30,this.M.x,this.M.y)}}class Ft extends b{constructor(t,i,h,s){super(t,i,h,8),this.o=s,t.clone()}C(t){this.m.scale(1.1),200<this.m.length()&&this.ma(),super.C(t)}F(t){var i=this.i.clone();k.h.globalAlpha=.2,u(i.add(new E(0,-this.O)),this.A,{stroke:"white",fill:"white",lineWidth:10}),k.h.globalAlpha=1,super.F(t)}}function Wt(t,i,h,s=1){return(t=new It(t.i.clone().add(new E(1,0).rotate(i.heading()).scale(t.A/2)),s,t.B,t,h)).W=i,t.O=1,t.h=4,t}function Pt(i,t,h,s=1){let e=j(50,300),a=new Tt(i.i.clone().add(new E(1,0).rotate(t.heading()).scale(i.A/2)),s,i.B,i,h,e);return a.W=t,a.O=1,a.h=0,a.v=t=>{(t=new Ft(t,s,i.B,i)).ra=1e3,a.Ta(t)},a}class Dt extends b{constructor(t,i,h,s=1){super(t,i,h,s),e(this),at(this)}F(t,i){l(t,this,i=this.sa||i),r(this,i),super.F(t)}wa(t,i){t.translate(.2*this.m.x,.45*i.y),t.lineWidth=2,t.fillStyle="#aaa",t.fillRect(0,0,.3*this.m.x,1.2*-this.m.y),t.fillStyle="#888",t.fillRect(.3*this.m.x,0,.3*this.m.x,1.2*-this.m.y)}}class Lt extends D{constructor(t,i,h){super(t,i,h,5),e(this),this.pa=!1}wa(t){t.translate(-.2*this.m.x+(this.aa==this.ta?15:0),.1*this.m.y),t.rotate(a/2+(this.aa==this.ta?.1:0)),t.lineWidth=2,t.fillStyle="#aaa",t.fillRect(0,0,.1*this.m.x,1.5*-this.m.y),t.fillStyle="#888",t.fillRect(.1*this.m.x,0,.1*this.m.x,1.5*-this.m.y)}}function Rt(s,i){(n=s).j=[],n.g.j.time=void 0,n.o=1,n.fa=[],n.j=[],n.v=[],n.X=[],n.j.forEach(t=>{t.Fa=0}),n.G=0,n.h.$=0,n.h.Pa=0,n.U.alpha=n.U.va=0,ht(s.g,i),tt(s.Ca),s.qb=new E(40,44),s.rb=new E(48,25),s.Ca=new t(s.rb,s.qb,s.Da,s.g.la),(n=k).o=c2d.cloneNode().getContext("2d"),n.u=c2d.cloneNode().getContext("2d");{var h,e=s;e.buttons=[],e.N=[],(n=new P(40,40,60,60,"↩","Back",60)).visible=!0,n.g=()=>{1==e.o&&e.u.forEach(t=>{t=I(t.type).K,e.l+=t,e.h.$-=t}),e.l=0,C(L)},e.buttons.push(n),e.bb=new P(.13*k.g,40,60,60,"💰",""),e.bb.g=()=>{},e.N.push(e.bb);let t=0,i=k.g/5.4;for(h of Z){var a=I(h).K,a=function(i,t,h,s){return(t=new P(t,40,60,60,"",s)).visible=!0,t.unit=new{0:Et,1:Dt,2:D,3:Ct,4:Bt,5:Lt}[h](new E(0,-4),1.8,1),t.unit&&(t.unit.nb=!1),t.g=t=>{i.G=t.unit.type},i.N.push(t),t}(e,i-30+72*t++,h,`Place ${B[h]} for ${a}$`);0==h&&(e.fb=a),1==h&&(e.eb=a),2==h&&(e.Ea=a),3==h&&(e.cb=a),4==h&&(e.$a=a),5==h&&(e.ab=a),e.N.push(a)}e.oa=new P(i-30+72*t++,40,60,60,"🗑","Clear"),e.oa.visible=!0,e.oa.g=()=>{e.u.forEach(t=>{t=I(t.type).K,e.l+=t,e.h.$-=t}),e.j=e.j.filter(t=>1!=t.B),Ot(e)},e.N.push(e.oa),e.S=new P(k.g/2,50,200,110,"⚔","Figth!",100),e.S.visible=!0,e.S.g=()=>{var t;1==e.o&&(e.o=2,e.S.visible=!1,(t=e).h.result=3,t.h.Za=t.u.length,t.h.xb=t.D.length,t.g.j=new S(60),t.j.forEach(t=>{t.setActive(k.g)}))},e.buttons.push(e.S),W(n=[n,e.oa,e.S,...e.N]),e.S.Sa=()=>{F(xt)},e.buttons=[...e.buttons,...e.N]}var n,l;let r=s.g.Ya;if(Z.forEach(t=>{r.includes(t)||(0==t&&(s.fb.enabled=!1),1==t&&(s.eb.enabled=!1),2==t&&(s.Ea.enabled=!1),3==t&&(s.cb.enabled=!1),4==t&&(s.$a.enabled=!1),5==t&&(s.ab.enabled=!1))}),-1==s.g.u){i=s.g.l;var o,c=s.g.o,g=T(2).scale(s.g.h),u=new E(0,0),f=(g=new E(1,1).scale(g.length()*s.g.h),[0,2,3]);for(let t=0;t<i;t++)o=f[j(0,f.length)],u=Ht(s,c.clone().add(g).add(u),s.g.h,2,o),s.j.push(u),u=new E(M(-1,1),M(-1,1)).scale(j(20,500)*s.g.h)}else{var d=s,b=s.g.l,w=s.g.o,x=s.g.h,y=s.g.u,m=3==s.g.H?2.5:1,p=(m=T(y).scale(x*m),Math.sqrt(b)),v=new E(-2*p/2,-p/2).scale(m.length()),A=new E(0,0);let i=0,h=0;for(let t=0;t<b;t++)A=Ht(d,w.clone().add(v).add(A),x,2,y),d.j.push(A),++h>=p&&(h=0,i++),A=new E(h*m.length(),i*m.length())}s.h.Pa=0,s.D.forEach(t=>{s.h.Pa+=I(t.type).K}),s.l=s.h.Pa,1==s.ra?s.l=Math.floor(1.5*s.l):2==s.ra&&(s.l=Math.floor(1.25*s.l)),(l=s).h.$=0,l.u.forEach(t=>{l.h.$+=I(t.type).K}),Ot(s)}function Ht(n,t,i,s,h){let l=new Et(t,i,s);if(l.g&&(l.g.ga=.6*l.m.length()),1==h)l=new Dt(t,i,s);else if(2==h){let h=new D(t,i,s);h.o=(t,i)=>{t=Wt(h,i,t,n.g.h),n.v.push(t),n.j.length<10&&F(wt)},l=h}else if(4==h){let h=new Bt(t,i,s);h.o=(t,i)=>{(t=Pt(h,i,t,n.g.h)).Ta=t=>{n.v.push(t),F(ut)},n.v.push(t)},l=h}else 5==h?l=new Lt(t,i,s):3==h&&(l=new Ct(t,i,s)).g&&(l.g.ga=.8*l.m.length());return l.fa=()=>{if(I(l.type).K,2==l.B&&(n.hb=l.i.clone(),n.R.push(new m("+1",l.i.clone(),l.m.clone().scale(.7),l.B,"#ff0"))),4==l.type)for(let t=0;t<M(2,4);t++){var i=l.i.clone().add(new E(M(-1,1),M(-1,1)).scale(60)),h=jt(l,i).yb;(i=Pt(l,h,i,n.g.h)).Ta=t=>{n.v.push(t),F(ut)},n.v.push(i)}var t=n,s=l.i,e=l.m.clone().scale(1.2),a=l.B,s=new At(s.clone(),e.clone(),a);t.X.push(s),l.F(k.o,!0),1==l.B?n.U.va+=1:n.U.alpha+=1},l.Ea=()=>{},t=I(l.type).K,n.l-=t,n.h.$+=t,l}function Ot(t){t.fb&&t.eb&&t.Ea&&t.cb&&t.$a&&t.ab&&(t.fb.data=""+i(t,0),t.eb.data=""+i(t,1),t.Ea.data=""+i(t,2),t.cb.data=""+i(t,3),t.$a.data=""+i(t,4),t.ab.data=""+i(t,5),t.bb.data=""+t.l)}function Gt(t){return t.x<k.g/2&&120<t.y&&16<t.x&&t.y<k.j-16}function Jt(t,i,h=32){let s=Math.floor(h),e=(i=i.clone(),new E(s*Math.floor(i.x/s),s*Math.floor(i.y/s))),a=[];return t.u.forEach(t=>{a.push(t.i.clone())}),a=a.map(t=>new E(s*Math.floor(t.x/s),s*Math.floor(t.y/s))),t=0===[...new Map(a.map(t=>[t.key,t])).values()].filter(t=>t.key==e.key).length,{Wa:e,Va:t}}function Ut(h,t,i){let s=[],e=i=>{for(let t=0;t<4;t++)s.push({Ma:h.clone().add(i.rotate(t*a/2)),Lb:10})};return s.push({Ma:h.clone(),Lb:10}),0<i&&(e(i=new E(Math.floor(t.length()),0)),e(t=new E(Math.floor(t.length()),Math.floor(t.length())))),s}function Kt(h){var t=w.g.i;if(h.L&&3!=h.o){var s=I(h.G).K;if(!(h.l<s)){var e=T(h.G).scale(h.g.h),t=t.clone();if(t=zt(h,t,e).Wa){let i=!1;Ut(t,e,h.J).forEach(t=>{zt(h,t.Ma,e).Va&&s<=h.l&&(t=Ht(h,t.Ma,h.g.h,1,h.G),1!=h.o&&(t.Fa=k.g),h.j.push(t),i=!0)}),i&&F(ct),Ot(h)}}}}function Nt(i){var h,s=w.g.i;1==i.o&&(h=T(i.G).scale(i.g.h),i.u.filter(t=>c(t.i,s)<i.ib*h.length()).forEach(t=>{t=I(t.type).K,i.l+=t,i.h.$-=t}),i.j=i.j.filter(t=>1!=t.B||c(t.i,s)>i.ib*h.length()),Ot(i))}function zt(t,i,h){var{Wa:t,Va:i}=Jt(t,i,h.length());return{Wa:t,Va:Gt(t)&&i}}function i(t,i){return Math.floor(t.l/I(i).K)}let p=new class{constructor(){this.L=!1,this.sb=0,this.fa=[],this.j=[],this.v=[],this.R=[],this.buttons=[],this.N=[],this.X=[],this.h={result:0,Za:0,xb:0,ob:0,Mb:0,$:0,Pa:0,U:{alpha:0,va:0}},this.rb=new E(1,1),this.qb=new E(1,1),this.Da=Math.random(),this.jb=[1,2],this.J=0,this.ib=this.jb[this.J],this.o=1,this.l=0,this.U={alpha:0,va:0},this.ra=1,this.gb=new rt({width:k.g,height:k.j,ya:3}),this.g=d,this.Ca=new t(new E(8,8),new E(8,8),this.Da,this.g.la)}get G(){return this.sb}set G(t){this.sb=t}get u(){return this.j.filter(t=>1==t.B)}get D(){return this.j.filter(t=>2==t.B)}get Cb(){return this.v.filter(t=>1==t.B)}za(){w.j=()=>{w.g.g&&Kt(this),w.g.h&&Nt(this)},w.h=()=>{w.g.g&&Kt(this),w.g.h&&Nt(this)},w.l=()=>{this.buttons.forEach(t=>n(t))},w.D=()=>{1==this.o&&Nt(this)},w.G=()=>{this.J+=1,this.J>this.jb.length-1&&(this.J=0),this.ib=this.jb[this.J]}}Ka(){w.j=()=>{}}La(i){12==this.g.H&&this.j.length<1e3&&this.l<1e5&&(this.l+=10),this.fa=[...this.j,...this.v],this.fa.forEach(t=>{t.P<1&&t.ma()}),this.j=this.j.filter(t=>t.L&&0<t.P),this.v=this.v.filter(t=>t.L&&0<t.P),this.R=this.R.filter(t=>t.L),this.X=this.X.filter(t=>t.L&&0<t.pb),this.X.forEach(t=>{t.C(i)}),this.buttons.forEach(t=>{t.selected=!1,t.unit&&t.unit.type==this.G&&(t.selected=!0),t.C(i)}),(h=this.j).filter(t=>o(t.Ra)).filter(t=>null==t.M).sort(()=>Math.random()-.5).slice(0,100).forEach(i=>{var t=h.filter(t=>t.B!=i.B).filter(t=>c(i.i,t.i)<i.Fa).map(t=>({unit:t,ea:c(i.i,t.i)})).sort((t,i)=>t.ea-i.ea).map(t=>t.unit);0<(t=4==i.type?h.filter(t=>t.B!=i.B).filter(t=>c(i.i,t.i)<i.ub).map(t=>({unit:t,ea:c(i.i,t.i)})).sort((t,i)=>i.ea-t.ea).map(t=>t.unit):t).length?(i.M=t[0].i.clone(),setTimeout(()=>{i.M=void 0},M(500,800))):i.M=void 0}),this.j.forEach(t=>{(1!=this.o?t:t.aa).C(i)}),this.v.forEach(t=>{t.C(i)}),this.R.forEach(t=>{t.C(i)}),this.v.forEach(t=>{t.I.add(t.W),t.i.add(t.I),t.W.scale(0)}),this.fa=[...this.j,...this.v],this.gb.clear(),this.fa.forEach(t=>{1==this.o&&t instanceof b||lt(this.gb,t)}),[a,t,n=1]=[this.j,i,Math.min(1,1/this.g.h)],a.forEach(s=>{var e=s.i.clone().add(s.I.clone().scale(1/t));(function i(h,s){let e=s.Na(h.j),a=h.h;if(h.g.length)for(let t=0;t<e.length;t++)a=a.concat(i(h.g[e[t]],s));return a=a.filter(function(t,i){return a.indexOf(t)>=i})})(p.gb,s).forEach(t=>{var i,h;t instanceof Tt||t===s||(i=(s.A+t.A)/2,h=t.i.clone().add(t.I.clone().scale(1/60)),0==(h=e.ea(h)))||i<h||(h=(i=new E(e.x-t.i.x,e.y-t.i.y)).length(),h=i.scale((s.A+t.A-h)/(2*h)),1==t.type?(s.i.add(h.scale(.3)),s.I.scale(.5),s.W.scale(0)):(i=t.i,h=h.scale(.1),i.x-=h.x,i.y-=h.y,s.I.scale(.99),s.W.scale(.99)),t.I.scale(.99),t.W.scale(.99),[0,1,2,3,4,5].includes(t.type)&&t.B!=s.B?t.aa==t.ta&&o(s.Oa)&&(0==s.ia&&(s.P=Math.max(s.P-t.ua*n,0)),s.ia=Math.max(s.ia-t.ua*n,0),0==s.P?(t.lb++,s.Oa.set(1)):(s.Oa.set(.2),a.length<10&&F(mt))):(t instanceof It&&t.B!=s.B||t instanceof Ft)&&(t instanceof Ft?s.P=Math.max(s.P-t.ua*n,0):(0==s.ia&&(s.P=Math.max(s.P-t.ua*n,0)),s.ia=Math.max(s.ia-t.ua*n,0),t.P=0),s.Oa.set(.2),0==s.P)&&(null!=t.o?t.o.B!=s.B?t.o.lb++:t.o.Fb++:t.lb++))}),s.I.add(s.W),(e.x+s.A>k.g||e.x<=0)&&(s.I.x*=-.95),(e.y+s.A>k.j||e.y<=0)&&(s.I.y*=-.95),s.i.x+s.m.x>k.g&&(s.i.add(new E(-s.m.x/2,0)),s.I.scale(0)),s.i.x-s.m.x<0&&(s.i.add(new E(s.m.x/2,0)),s.I.scale(0)),s.i.y+s.m.y>k.j&&(s.i.add(new E(0,-s.m.y/2)),s.I.scale(0)),s.i.y-s.m.y<100&&(s.i.add(new E(0,s.m.y/2)),s.I.scale(0)),s.i.add(s.I),s.I.scale(.95),s.W.scale(0),s.sa=s.I.clone().normalize().x<0}),it(this.Ca,15);var a,t,n,h,s,e=k.g/2-2;if(G(new E(e,0),new E(e,k.j),{stroke:"red",fill:""}),G(new E(e+=4,0),new E(e,k.j),{stroke:"blue",fill:""}),H(this.X,k.u),k.h.globalAlpha=.2,k.h.drawImage(k.u.canvas,0,0),k.h.globalAlpha=.4,k.h.drawImage(k.o.canvas,0,0),k.h.globalAlpha=1,H([...this.j,...this.v,...this.R]),this.g.Ua&&(3!=this.o||0==this.u.length||0==this.D.length)){var e=[...this.u,...this.Cb].map(t=>t.i.clone()),l=k;e=e.map(t=>new E(100*Math.floor(t.x/100),100*Math.floor(t.y/100))),e=[...new Map(e.map(t=>[t.key,t])).values()],l.l.push(e),100<l.l.length&&(l.l=l.l.slice(-1)),e=l.l.flat(),e=[...new Map(e.map(t=>[t.key,t])).values()];let i=c2d.cloneNode().getContext("2d");i.fillStyle="rgb(0,0,0,.95)",e.forEach(t=>{i.beginPath(),i.arc(t.x,t.y,400,0,2*Math.PI),i.fill()}),i.filter="blur(10px)",l.h.globalCompositeOperation="destination-in",l.h.drawImage(i.canvas,0,0),l.h.globalCompositeOperation="source-over"}2==(e=this).o&&(e.oa.visible=!1),O(new E(0,0),new E(k.g,110),{stroke:"transparent",fill:"rgb(150,0,150,.3)"}),J(k.g/4,e.u.length,e.h.Za,"#500","#f00",!1),J(3*k.g/4,e.D.length,e.h.xb,"#005","#00f",!0),l=new E(200,105),O(new E(k.g/2-l.x/2,0),l,{stroke:"#000",fill:"#808"}),2==e.o&&0<e.u.length&&0==e.g.V&&0==e.D.length&&(e.g.V=1,(s=e).hb)&&(s.R.push(new m("⭐",s.hb.clone(),new E(50,50),1)),s.hb=void 0),g(Array(e.g.V).fill("⭐").join(""),80,.9*k.g,75),l=k.g/2,g("Level "+(e.g.H+1),40,.07*k.g,70),g(e.u.length+" vs "+e.D.length,70,.75*k.g,80),1!=e.o&&g("Kills: "+e.U.alpha,30,.5*k.g,50,"#ff0"),2==e.o&&g(parseInt(""+-1*e.g.j.get()%60)+"s",40,l,100),e.buttons.forEach(t=>{t.qa(k.h)});var r=this;if(Gt(w.g.i)){let h=T(r.G).scale(r.g.h);Ut(Jt(r,w.g.i,h.length()).Wa,h,r.J).forEach(t=>{var i=Jt(r,t.Ma,h.length()).Va;u(t.Ma,Math.floor(h.length()),{stroke:"transparent",fill:["rgb(0,255,0,.3)","rgb(255,0,0,.3)"][i?0:1],lineWidth:3})})}2==(s=this).o&&0!=(e=function(t){let i=0;return t.pa?.kb()||0!=t.D.length&&0!=t.u.length||(t.pa=new S(1.5),t.j.forEach(t=>{t.zb=!0})),(t.pa&&o(t.pa)||o(t.g.j))&&(t.pa&&(t.pa.time=void 0),0==t.D.length&&0==t.u.length?i=3:0==t.D.length&&0<t.u.length?i=1:(0==t.u.length||0<t.g.j.get())&&(i=2)),i}(s))&&(s.o=3,s.h.result=e,s.h.ob=s.u.length,s.h.Mb=s.D.length,s.h.U=s.U,d.g[d.H].V=s.g.V,L.j=s.g.H+1+1,e=s.h,(s=vt).data=e,s.result=e.result,setTimeout(()=>{C(vt)},2e3)),f.na&&C(v)}},L=new class{constructor(){this.L=!1,this.u=1,this.buttons=[],this.h=this.l=this.g=0,this.J=Math.random(),this.D=new E(20,22),this.v=new E(96,50),this.G=new t(this.v,this.D,this.J,3),this.R=[...d.g]}get j(){return this.u}set j(t){this.u=t}get N(){return 0==this.g%4?(this.h++,this.l=0):this.l++,k.g/2-640+400*this.l*1.1}get o(){return k.j/2-220+120*this.h}za(){this.buttons=[],this.h=this.g=0;{var e=this;e.g=0,e.buttons=[];let{style:h,wb:s}={style:{text:"#ccc",color:"transparent",lineWidth:0,xa:"transparent",fontSize:60},wb:{text:"white",color:"rgb(150,150,150,.3)",lineWidth:0,xa:"transparent",fontSize:60}};e.R.forEach((t,i)=>{t=new P(e.N,e.o,400,110,i+1+"","",10),i+1>e.j?(t.enabled=!1,h.color="rgb(0,0,150,.8)",s.color="rgb(0,0,150,.8)"):(W([t]),h.color="rgb(150,0,0,.8)",s.color="rgb(150,0,0,.8)"),t.Ha.default=JSON.parse(JSON.stringify(h)),t.Ha.Gb=JSON.parse(JSON.stringify(s)),t.g=()=>{C(p),Rt(p,i)},12==i&&(t.i.x=k.g/2),e.buttons.push(t),e.g++})}this.h++;var t=new P(k.g/2,this.o,500,80,"Back","");t.g=()=>{C(v)},this.buttons.push(t),W([t]),w.h=()=>{w.g.g&&this.buttons.forEach(t=>n(t))}}Ka(){this.buttons=[],this.h=this.g=0,w.h=()=>{}}La(h){it(this.G),g("Levels",80,k.h.canvas.width/2,300),this.buttons.forEach((t,i)=>{t.C(h),t.qa(k.h),t.enabled?d.g[i]&&(0<d.g[i].V&&g(Array(d.g[i].V).fill("⭐").join(""),30,t.i.x+.3*t.m.x,t.i.y+12),0<d.g[i].Ia)&&(g("Highdcore:",25,t.i.x-.3*t.m.x,t.i.y-.25*t.m.y),g(""+d.g[i].Ia,35,t.i.x-.3*t.m.x,t.i.y+12)):g("🔒",70,t.i.x,t.i.y+22)}),f.na&&C(v)}},qt=new class{constructor(){this.buttons=[],this.o=[],this.j=this.u=this.v=0,this.l=[],this.g=[],this.D=this.L=!1,this.h=new E(k.g/2,.2*k.j)}get J(){return 0==this.v%6?(this.j++,this.u=0):this.u++,k.g/2-115-690+320*this.u}get G(){return k.j/2-180+200*this.j}za(){let i,s=new E(0,0);this.l=[],V.g.forEach(t=>{let i=new Et(s,2,1);if(t.name==B[1]&&(i=new Dt(s,2,1)),t.name==B[2]){let h=new D(s,2,1);h.l/=2,h.o=(t,i)=>{t=Wt(h,i,t),this.g.push(t),F(wt)},this.N=i=h}if(t.name==B[3]&&(i=new Ct(s,2,1)),t.name==B[4]){let h=new Bt(s,2,1);h.l/=2,h.o=(t,i)=>{(t=Pt(h,i,t)).Ta=t=>{this.g.push(t),F(ut)},this.g.push(t)},this.R=i=h}t.name==B[5]&&(i=new Lt(s,2,1)),this.l.push({name:t.name,data:t,unit:i})}),this.o=[],this.j=this.v=0,V.g.forEach(t=>{i={x:this.J,y:this.G,text:t.name},this.o.push(i),this.v++}),this.j++,this.j++;var t=new P(k.g/2,this.G,500,80,"Back","");t.g=()=>{C(v)},this.buttons.push(t),this.o.forEach(i=>{var t=this.l.filter(t=>t.name==i.text)[0];t&&(t.unit.i=new E(i.x,i.y-120))}),w.h=()=>{this.L&&w.g.g&&c(this.h,w.g.i)<50&&(this.h=w.g.i.clone(),this.D=!0)},w.j=()=>{this.L&&w.g.g&&this.D&&(this.h=w.g.i.clone())},w.l=()=>{var t;(t=this).L&&(t.buttons.forEach(t=>n(t)),t.N?.Ba(t.h),t.R?.Ba(t.h),t.D=!1)}}Ka(){this.buttons=[],w.h=()=>{}}La(s){this.g.forEach(t=>{t.P<1&&t.ma()}),this.g=this.g.filter(t=>t.L&&0<t.P),this.g.forEach(t=>{t.C(s)}),this.g.forEach(t=>{t.I.add(t.W),t.i.add(t.I),t.W.scale(0)}),g("13th Century Army",80,k.h.canvas.width/2,300);let e=0<Math.sin(A),a=0<Math.sin(2*A),n=0<Math.sin(4*A);this.buttons.forEach(t=>{t.C(s),t.qa(k.h)}),this.o.forEach(i=>{g(i.text,50,i.x,i.y+20,"#880");var h=this.l.find(t=>t.name==i.text);if(h){e&&et(h.unit),n&&h.unit.attack(),h.unit.Ba(this.h),h.unit.C(s),u(new E(i.x,i.y-120),150,{stroke:"#800",fill:"#222",lineWidth:10}),h.unit.F(k.h,a);let t=1;g("cost: "+h.data.K,30,i.x,i.y+39*++t),g("Armor: "+h.data.ba,30,i.x,i.y+39*++t),g("Damage: "+h.data.da,30,i.x,i.y+39*++t),g("Cooldown: "+h.data.ca,30,i.x,i.y+39*++t),g("Speed: "+Math.floor(h.data.T*h.unit.A),30,i.x,i.y+39*++t),h.data.ka&&g("Range: "+Math.floor(h.data.ka*h.unit.A),30,i.x,i.y+39*++t),h.data.mb&&g("Shoot: "+h.data.mb,30,i.x,i.y+39*++t),h.data.Aa&&g("Cooldown: "+h.data.Aa,30,i.x,i.y+39*++t),g("🎯",90,this.h.x,this.h.y+30)}}),H(this.g),f.na&&C(v)}},v=new class{constructor(){this.L=!1,this.buttons=[],this.j=0,this.u=Math.random(),this.o=new E(20,22),this.l=new E(96,50),this.g=new t(this.l,this.o,this.u,0)}get h(){return 500+100*this.j++}za(){this.buttons=[],this.j=0;let t,i=k.g/2,h=[0,1,2,3];(t=new P(450+i,this.h,300,80,["","Easy","Medium","Hard"][p.ra])).g=t=>{let i=p.ra+1;i>=h.length&&(i=1),p.ra=i,t.text=["","Easy","Medium","Hard"][i]},this.buttons.push(t),this.j--,(t=new P(i,this.h,500,80,"Play")).g=()=>{C(p),Rt(p,L.j-1)},this.buttons.push(t),(t=new P(i,this.h,500,80,"Army")).g=()=>{C(qt)},this.buttons.push(t),(t=new P(i,this.h,500,80,"Campaign")).g=()=>{C(L)},this.buttons.push(t),(t=new P(i,this.h,500,80,"Fullscreen")).g=()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()},this.buttons.push(t),W(this.buttons),w.h=()=>{w.g.g&&this.buttons.forEach(t=>n(t))}}Ka(){this.buttons=[],w.h=()=>{}}La(i){if(0==A%5){do{var t=j(0,_.length)}while(t==this.g.la);this.g.la=t,this.g.h=Math.random(),tt(this.g)}it(this.g),g("Battle commander",150,t=k.h.canvas.width/2,250),g("Middle Ages",60,t,350),this.buttons.forEach(t=>{t.C(i),t.qa(k.h)}),g("@santiHerranz",30,.9*k.g,.9*k.j,"#aaa"),g("for JS13K 2023",30,.9*k.g,.93*k.j,"#fff")}};var A=0,Yt=0;let Zt,Vt=0,Xt=new S(0);(async()=>{let i=new Image;return i.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAAAgCAMAAADaHo1mAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAhUExURf8AAO7DmgAAAM3NzUs8GktpL4pvMIGBgTw8PD4+PgAAAHbVe90AAAALdFJOU/////////////8ASk8B8gAAAAlwSFlzAAAOvwAADr8BOAVTJAAAAYBJREFUSEu9kotSwzAMBKkJL///B+OTVrbsPkggZWdaJSd8y6R5qSfyYnADpwm83CBxjgjWf26CcoPI2CmwQ+vZhPV2CI39guuzCdtdOqRityAgWGgLug1ScZrgcimlqFyDVEwHHlWI++sdAjvskCy8dggy9oRcoKFo23xj3w3KDaIZ2hsEmfknuCGgGTyboBsIBxQHirZGG1nAtuFhhuaAtMO5oCXql2EI2BkeZtRaSv+QdjgHSlRfShLcewvgB0F9m4j+sj1VsJX2SQK9X244LqC4Y/1GFgw8zBwTUC4QUBx4mHkgUA3FjhUHRwQJUkFR411wLWx1U+DZBMVAKHqTC/zK8CWCq7dg5WOCUFiTFf5NMCuIRBQ1PoVfCt8joLjj6YBHMyB3aJwF7M4UzLC7KfAs0x4LzQZpQOWC7+I3qPqFgukhGw8F9PkY+HISxLSLlSj+f0HU+bffxk0S2CsQUxcrkdvMfxBdTB/cnC4Y1Ywh+D0hZKY7bZ8p+Kq11m+Xf1ayHeIGzQAAAABJRU5ErkJggg==",new Promise(t=>{i.onload=()=>t(i)})})().then(async t=>{Zt=t,h.push({type:0,name:B[0],K:100,ja:100,ba:30,T:1,ca:.6,da:30,Z:2}),h.push({type:1,name:B[1],K:80,ja:100,ba:200,T:.1,ca:1,da:20,Z:1}),h.push({type:2,name:B[2],K:120,ja:100,ba:20,T:.2,ca:1,da:30,Z:12,mb:30,ka:10,Aa:1.2}),h.push({type:3,name:B[3],K:250,ja:100,ba:150,T:.8,ca:1,da:80,Z:3,ka:0}),h.push({type:4,name:B[4],K:1500,ja:100,ba:40,T:.2,ca:1,da:20,Z:15,mb:1e3,ka:20,Aa:2.5}),h.push({type:5,name:B[5],K:1300,ja:100,ba:180,T:1.8,ca:.5,da:200,Z:15}),h.push({type:6,name:"Arrow",K:0,ja:100,ba:0,T:0,ca:0,da:30,Z:0}),h.push({type:7,name:"CannonBall",K:0,ja:100,ba:0,T:0,ca:0,da:100,Z:0}),h.push({type:8,name:"Explosion",K:0,ja:100,ba:0,T:0,da:1e3,Z:0,ca:0}),U=new K,function t(i){A=(Yt+=1)/60;var h=i-Vt;1e3/60<=h&&(Vt=i-h%(1e3/60),f.h.na=f.na,f.na=!!f.g.get("Escape"),k.h.clearRect(0,0,k.g,k.j),U.g.La(h)),requestAnimationFrame(t)}(0)})</script>