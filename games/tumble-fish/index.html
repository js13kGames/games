<!doctype html><title>Tumble Fish - js13kGames 2012</title><style>body,html{background:#000;font-size:1em;color:#fff;text-align:center;height:100%;padding:0;margin:0;font-family:‘Lucida Sans Unicode’,‘Lucida Grande’,sans-serif}button{font-size:1em;font-family:‘Lucida Sans Unicode’,‘Lucida Grande’,sans-serif}a{color:#ff0}button strong{color:#ff0}button p{margin:.5em 0}#intro{max-width:25em;margin:0 auto}#restart{display:none;position:absolute;top:0;right:0;z-index:10}p{color:#fff}.shiny-blue{background:#88f;margin:1em auto;display:block;color:#ff0;text-decoration:none;background-color:#759ae9;background-image:-webkit-gradient(linear,left top,left bottom,color-stop(0,#759ae9),color-stop(50%,#376fe0),color-stop(50%,#1a5ad9),color-stop(100%,#2463de));background-image:-webkit-linear-gradient(top,#759ae9 0,#376fe0 50%,#1a5ad9 50%,#2463de 100%);background-image:-moz-linear-gradient(top,#759ae9 0,#376fe0 50%,#1a5ad9 50%,#2463de 100%);background-image:-ms-linear-gradient(top,#759ae9 0,#376fe0 50%,#1a5ad9 50%,#2463de 100%);background-image:-o-linear-gradient(top,#759ae9 0,#376fe0 50%,#1a5ad9 50%,#2463de 100%);background-image:linear-gradient(top,#759ae9 0,#376fe0 50%,#1a5ad9 50%,#2463de 100%);border-top:1px solid #1f58cc;border-right:1px solid #1b4db3;border-bottom:1px solid #174299;border-left:1px solid #1b4db3;-webkit-border-radius:4px;-moz-border-radius:4px;border-radius:4px;-webkit-box-shadow:inset 0 0 2px 0 rgba(57,140,255,.8);-moz-box-shadow:inset 0 0 2px 0 rgba(57,140,255,.8);box-shadow:inset 0 0 2px 0 rgba(57,140,255,.8);color:#fff;padding:7px;text-shadow:0 -1px 1px #1a5ad9;width:80%}.shiny-blue:hover{background-color:#5d89e8;background-image:-webkit-gradient(linear,left top,left bottom,color-stop(0,#5d89e8),color-stop(50%,#2261e0),color-stop(50%,#044bd9),color-stop(100%,#0d53de));background-image:-webkit-linear-gradient(top,#5d89e8 0,#2261e0 50%,#044bd9 50%,#0d53de 100%);background-image:-moz-linear-gradient(top,#5d89e8 0,#2261e0 50%,#044bd9 50%,#0d53de 100%);background-image:-ms-linear-gradient(top,#5d89e8 0,#2261e0 50%,#044bd9 50%,#0d53de 100%);background-image:-o-linear-gradient(top,#5d89e8 0,#2261e0 50%,#044bd9 50%,#0d53de 100%);background-image:linear-gradient(top,#5d89e8 0,#2261e0 50%,#044bd9 50%,#0d53de 100%);cursor:pointer}.shiny-blue:active{border-top:1px solid #1b4db3;border-right:1px solid #174299;border-bottom:1px solid #133780;border-left:1px solid #174299;-webkit-box-shadow:inset 0 0 5px 2px #1a47a0,0 1px 0 #eee;-moz-box-shadow:inset 0 0 5px 2px #1a47a0,0 1px 0 #eee;box-shadow:inset 0 0 5px 2px #1a47a0,0 1px 0 #eee}</style><meta name=viewport content="initial-scale=1"><div id=intro><h1>Tumble Fish</h1><p>You're Jim Bob the pet shop owner. Your arch nemesis, Bob Jim hid all your prize goldfish in a giant tower. You must shake them down all 13 floors without breaking the fish bowls.<p>Game by <a href=https://github.com/Patrick64>Patrick Woodcock</a>. Level design by Edward Mullins. This is an entry for the <a href=//js13kgames.com>Js13kGames</a> contest.</p><button onclick=go(0) class=shiny-blue><strong>Mobile version (recommended) »</strong><br><p>Tilt your mobile left/right to control. Tap the fishbowl to restart the level. Portrait mode only!</p><button class=shiny-blue onclick=go(1)><strong>Desktop version (still good) »</strong><p>Drag level left/right with mouse. Click the button on top right of screen to restart level.</div><input type=button value="Restart level" id=restart><canvas id=myCanvas style=display:none></canvas><script>var initializing=!1,fnTest=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(t){var i=this.prototype;initializing=!0;var e=new this;for(var s in initializing=!1,t)e[s]="function"==typeof t[s]&&"function"==typeof i[s]&&fnTest.test(t[s])?function(t,e){return function(){var s=this._super;this._super=i[t];var h=e.apply(this,arguments);return this._super=s,h}}(s,t[s]):t[s];function h(){!initializing&&this.init&&this.init.apply(this,arguments)}return h.prototype=e,h.prototype.constructor=h,h.extend=arguments.callee,h},String.prototype.replaceAt=function(t,i){return this.substr(0,t)+i+this.substr(t+i.length)};var $=function(t,i){return t=t.match(/^(\W)?(.*)/),(i||document)["getElement"+(t[1]?"#"==t[1]?"ById":"sByClassName":"sByTagName")](t[2])};function go(t){app=new Game(t)}var Game=function(t){$("#myCanvas").style.display="block",$("#intro").style.display="none";var i=this,e=this,s=function(t,i,e,s){return Math.sqrt(Math.pow(t-e,2)+Math.pow(i-s,2))};this.LR=0,this.FB=0,this.DIR=0;var h,a,n=.5;this.c=document.getElementById("myCanvas"),this.viewportwidth=window.innerWidth,this.viewportheight=window.innerHeight,this.c.style.height=this.viewportheight+"px",this.c.style.width=this.viewportwidth+"px",this.width=400,this.width,this.width,t?(a=this.width,h=this.viewportheight/this.viewportwidth*this.width,this.height=this.viewportheight/this.viewportwidth*this.width):(a=this.viewportwidth,h=this.viewportheight,this.height=this.viewportheight),this.c.setAttribute("width",a),this.c.setAttribute("height",h);var l=i.c.getContext("2d");this.centerX=this.width/2,this.centerY=this.height/2;var _=(new Date).getTime(),o=0,r=!0,m=!1,c=isNaN(document.location.hash.replace("#",""))?0:document.location.hash.replace("#","")-1,p=null,d=0,u=0,w={x:0,y:0},f=0,g=!1,v=0,y=0,x=0,M=0,I=[{wallMap:"\t\t\t        .....\t\t\t        .....\t\t\t        .....\t\t\t        .....\t\t\t        .....\t\t\t        ____g\t\t\t\t\t",itemMap:"\t\t\t        .....\t\t\t        .....\t\t\t\t.....\t\t\t\t.....\t\t\t\t.....\t\t\t\tp....\t\t\t      ",width:5},{wallMap:"\t\t\t        .....\t\t\t        ..__I\t\t\t        ._...\t\t\t        .._..\t\t\t        ..._.\t\t\t        ____g\t\t\t\t\t",itemMap:"\t\t\t\t\t...p",width:5},{wallMap:"\t\t\t        _....__.\t\t\t        .____I..\t\t\t        ___.....\t\t\t        ..._....\t\t\t        ...._...\t\t\t        g_______\t\t\t        ",itemMap:"\t\t\t        p.....p.\t\t\t        ........\t\t\t      ",width:8},{wallMap:"\t\t\t        _.I__.____\t\t\t        ._I____.._\t\t\t        ___...____\t\t\t        ._______..\t\t\t        _..I_..___\t\t\t        ._........\t\t\t        .._.......\t\t\t        ..._......\t\t\t        ________g_\t\t\t        ",itemMap:"\t\t\t        p......p..\t\t\t        ....p.....\t\t\t      ",width:10},{wallMap:"\t\t\t        ........\t\t\t        _..._..I\t\t\t        ....|..|\t\t\t        ....|..I\t\t\t        ....|..|\t\t\t        __ssI_gI\t\t\t        ....|..|\t\t\t        ....|...\t\t\t        ",itemMap:"\t\t\t        p...p...\t\t\t\t\t",width:8},{wallMap:"\t\t\t      .I____.|\t\t\t      I__..._.\t\t\t      |.__._I.\t\t\t      .__..|..\t\t\t      _...._g_\t\t\t      I___.|..\t\t\t      |..|.|..\t\t\t      |..I_I..\t\t\t      I_.IsI__\t\t\t      ",itemMap:"\t\t\t      .....b..\t\t\t      .p......\t\t\t      ",width:8},{wallMap:"\t\t\t      ____..___\t\t\t      .........\t\t\t\t  ....___..\t\t\t\t  ..._____.\t\t\t      _____g___\t\t\t      .........\t\t\t      s........\t\t\t\t  .........\t\t\t      sssssssss\t\t\t      ",itemMap:"\t\t\t      bbbb..bbb\t\t\t\t  .........\t\t\t\t  .........\t\t\t\t\t.........\t\t\t\t\t.........\t\t\t      ...p.....\t\t\t      ",width:9},{wallMap:"\t\t\t\t\t..__.....\t\t\t\t\t__..__...\t\t\t\t\t.....I_g.\t\t\t\t\t________.\t\t\t\t\t.......|.\t\t\t\t\t.......|.\t\t\t\t\t.......|s\t\t\t\t\t.......||\t\t\t\t\ts.s.s.s||\t\t\t\t\tIsIsIsIII\t\t\t      ",itemMap:"\t\t\t\t\t...b.....\t\t\t\t\t.........\t\t\t\t\t.........\t\t\t\t\t.........\t\t\t\t\t.........\t\t\t\t\t.........\t\t\t\t\t....p....\t\t\t      ",width:9},{wallMap:"      \t\t\t      __._...|..\t\t\t      |..._..|..      \t\t\t      |...._.|..     \t\t\t      |._____I__      \t\t\t      g_________      \t\t\t      ",itemMap:"\t\t\t      w..p......\t\t\t      ..........\t\t\t      ..........\t\t\t      ..........\t\t\t      .........w\t\t\t      ",width:10},{wallMap:"      ...__I___..      _g__....___      ...I____I..      ...........      ___________      ",itemMap:"\t\t\t      ..www.pww..\t\t\t\t\t...........\t\t\t      ",width:11},{wallMap:"\t\t\t\t\t_____\t\t\t\t\t_R__.\t\t\t\t\t...|.\t\t\t\t\t._.rg\t\t\t\t\t_....\t\t\t\t\t._...\t\t\t\t\t__.t_\t\t\t\t\t_IsI_\t\t\t\t      ",itemMap:"\t\t\t\t\t.....\t\t\t\t\tp....\t\t\t\t\t.....\t\t\t\t\t.p...\t\t\t\t\t.....\t\t\t\t\t.....\t\t\t\t\t.....\t\t\t\t\t.....      \t\t\t\t\t",width:5},{wallMap:"\t\t\t\t\t.R_T__\t\t\t\t\t_R__R.\t\t\t\t\t__._r_\t\t\t\t\t.r__R.\t\t\t\t\t.|..|.\t\t\t\t\t_I__I_\t\t\t\t\t.|..|.\t\t\t\t\t_I__Ig      ",itemMap:"\t\t\t\t\t..p..w\t\t\t\t\tb.....\t\t\t\t\t......\t\t\t\t\t......\t\t\t\t\t......      ",width:6},{wallMap:"\t\t\t\t\t__...\t\t\t\t\t.....\t\t\t\t\t.....\t\t\t\t\t...cc\t\t\t\t\t.....\t\t\t\t\t_c_..\t\t\t\t\t.....\t\t\t\t\t.....\t\t\t\t\t...c.\t\t\t\t\t.|...\t\t\t\t\t.|.__\t\t\t\t\t.|.|.\t\t\t\t\t.|s|.\t\t\t\t\tc....\t\t\t\t\t.....\t\t\t\t\t_..__\t\t\t\t\t.....\t\t\t\t\t.....\t\t\t\t\t.cc..\t\t\t\t\t...._\t\t\t\t\t_....\t\t\t\t\tg_c__\t\t\t\t\t",itemMap:"\t\t\t\t\t\tp....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t",width:5},{wallMap:"\t\t\t\t\t_____\t\t\t\t\t.....\t\t\t\t\t.....\t\t\t\t\t.....\t\t\t\t\t.Tcc.\t\t\t\t\t.....\t\t\t\t\t....S\t\t\t\t\t.....\t\t\t\t\t...S.\t\t\t\t\t.....\t\t\t\t\t..S..\t\t\t\t\t.....\t\t\t\t\t.S...\t\t\t\t\t.....\t\t\t\t\tS..cc\t\t\t\t\t.....\t\t\t\t\tsscc.\t\t\t\t\tgR___\t\t\t\t\t",itemMap:"\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\tp....\t\t\t\t\t\t.....\t\t\t\t\t\t.....\t\t\t\t\t\t",width:5},{wallMap:"\t\t\t\t\t.........___\t\t\t\t\tccccccc__r_.\t\t\t\t\t........|.|.\t\t\t\t\t........|.|.\t\t\t\t\t.cc...._R_I.\t\t\t\t\t..........|.\t\t\t\t\ts____.____I.\t\t\t\t\t_________..c\t\t\t\t\t_g__R_t_r__.\t\t\t\t\t",itemMap:"\t\t\t\t\t............\t\t\t\t\t............\t\t\t\t\t............\t\t\t\t\t............\t\t\t\t\t.........p..\t\t\t\t\t............\t\t\t\t\t.........w..\t\t\t\t\t.....f......\t\t\t\t\t",width:12},{wallMap:"\t\t\t\t\t......R___\t\t\t\t\tT_r...|...\t\t\t\t\t......|...\t\t\t\t\t.c_._c__g_\t\t\t\t\t.._s_____.\t\t\t\t\t..........\t\t\t\t\ts________.\t\t\t\t\t_R________\t\t\t\t\t",itemMap:"\t\t\t\t\t.........p\t\t\t\t\t..........\t\t\t\t\t..........\t\t\t\t\t..........\t\t\t\t\t..........\t\t\t\t\t..........\t\t\t\t\t.w........\t\t\t\t\tp.........\t\t\t\t\t.........f\t\t\t\t\t",width:10},{wallMap:"\t\t\t\t\t._____.\t\t\t\t\t.grR_I.\t\t\t\t\t.......\t\t\t\t\t....ccc\t\t\t\t\t_...___\t\t\t\t\tt___rt.\t\t\t\t\t.......\t\t\t\t\t",itemMap:"\t\t\t\t\t...w...\t\t\t\t\t....p..\t\t\t\t\t.....m.\t\t\t\t\t.......\t\t\t\t\t.......\t\t\t\t\t.......\t\t\t\t\t",width:7},{wallMap:"\t\t\t\t\t___________\t\t\t\t\t...........\t\t\t\t\t...........\t\t\t\t\t...........\t\t\t\t\t...........\t\t\t\t\t__...._____\t\t\t\t\t.R____.|...\t\t\t\t\t....IttI...\t\t\t\t\t.........__\t\t\t\t\t........cr.\t\t\t\t\tc........|.\t\t\t\t\t.........|.\t\t\t\t\t______T__Ig\t\t\t\t",itemMap:"\t\t\t\t\t...........\t\t\t\t\t...........\t\t\t\t\t...........\t\t\t\t\t...........\t\t\t\t\t...........\t\t\t\t\t.......m..b\t\t\t\t\t..p........\t\t\t\t\t........f..\t\t\t\t\t...........\t\t\t\t\t...........\t\t\t\t\t...........\t\t\t\t\t...........\t\t\t\t\t...........\t\t\t\t\t...........\t\t\t\t\t.f..f...f..\t\t\t\t\t",width:11},{wallMap:"\t\t\t\t\t..........\t\t\t\t\t..........\t\t\t\t\t.c........\t\t\t\t\t.|...cc...\t\t\t\t\t.|..sI..s.\t\t\t\t\t.|........\t\t\t\t\t.Is____s_.\t\t\t\t\t...I_R..Is\t\t\t\t\tct.|.___..\t\t\t\t\t...|......\t\t\t\t\tgcc._.__.c\t\t\t\t\t..I_I_II_I\t\t\t\t\t",itemMap:"\t\t\t\t\t..........\t\t\t\t\t..m....m..\t\t\t\t\t..........\t\t\t\t\t..........\t\t\t\t\t..........\t\t\t\t\t..........\t\t\t\t\t.....p....\t\t\t\t\t....p.....\t\t\t\t\t.....m.m..\t\t\t\t\t..........\t\t\t\t\t......m...\t\t\t\t\t..........\t\t\t\t\t",width:10},{wallMap:"\t\t\t\t\t.........\t\t\t\t\t.........\t\t\t\t\t.|.|.|.|.\t\t\t\t\t.|.|.|.|.\t\t\t\t\t.|.|.|.|.\t\t\t\t\t.|.|.|.|.\t\t\t\t\t.|.|.|.|.\t\t\t\t\tsIsIsIsIs\t\t\t\t\t",itemMap:"\t\t\t\t\t........p\t\t\t\t\t......p..\t\t\t\t\t....p....\t\t\t\t\t..p......\t\t\t\t\tp........\t\t\t\t\t",width:9}],b=function(t){var i,e;return t.targetTouches&&t.targetTouches[0]?(i=t.targetTouches[0].pageX,e=t.targetTouches[0].pageY):(i=t.pageX||t.clientX+document.body.scrollLeft,e=t.pageY||t.clientY+document.body.scrollTop),{x:i,y:e}};this.setupEvents=function(){var s;t?(window.DeviceOrientationEvent?window.addEventListener("deviceorientation",function(t){90==window.orientation?i.LR=t.beta*n:-90==window.orientation?i.LR=-t.beta*n:i.LR=t.gamma*n,i.LR>20&&(i.LR=20),i.LR<-20&&(i.LR=-20)},!1):alert("Not supported on your device or browser.  Sorry."),$("#myCanvas").addEventListener("touchstart",function(t){s=b(t),p.click(s.x*(e.width/e.viewportwidth)/d,s.y*(e.height/e.viewportheight)/d+v)},!1)):($("#myCanvas").addEventListener("mousedown",function(t){g=!0,w=b(t),f=i.LR,t.stopPropagation()},!1),$("#myCanvas").addEventListener("mouseup",function(t){g=!1,t.stopPropagation()},!1),$("#myCanvas").addEventListener("mousemove",function(t){if(g){var e=b(t);i.LR=f+.2*(e.x-w.x)*n,i.LR>20&&(i.LR=20,w=b(t),f=i.LR),i.LR<-20&&(i.LR=-20,w=b(t),f=i.LR)}t.stopPropagation()},!1),$("#restart").style.display="block",$("#restart").addEventListener("click",function(t){m=!0}))},this.setupEvents();var R=Class.extend({init:function(t,i,e,s){this.momentum={x:0,y:0},this.itemIndex=s,this.level=e,this.nearWall="",this.aboveWall="",this.x=t,this.y=i,this.tilt=.8,this.friction=1,this.active=!0,this.blockedLeft=!1,this.blockedRight=!1,this.isStatic=!1,this.isSolid=!0},process:function(t){if(this.active){if(!this.isStatic){this.blockedRight=!1,this.blockedLeft=!1,this.newWall=!1,this.momentum.x=this.momentum.x*(1-3*t*this.friction),this.momentum.x+=t*e.LR*this.tilt;var i=Math.floor(this.x+.5),s=Math.floor(this.y+.5);i=i<0?0:i>=this.level.width?this.level.width-1:i,s=s<0?0:s,this.mapX==i&&this.mapY==s||(this.newWall=!0),this.mapX=i,this.mapY=s,this.nearWall=".",this.level.wallMap[i+s*this.level.width]&&(this.nearWall=this.level.wallMap[i+s*this.level.width]),this.aboveWall=".",this.level.wallMap[i+(s-1)*this.level.width]&&(this.aboveWall=this.level.wallMap[i+(s-1)*this.level.width]),".|".indexOf(this.nearWall)>-1&&(this.momentum.y+=40*t),"Ss".indexOf(this.nearWall)>-1&&this.momentum.y>5&&(this.momentum.y=1.2*-this.momentum.y-2,this.momentum.y<-20&&(this.momentum.y=-20)),-1!=="_gIsTtRr".indexOf(this.nearWall)&&(this.y>=s&&this.momentum.y>=0?(this.y=s,this.momentum.y>10&&this.dropped(i,s),this.momentum.y=0):this.momentum.y+=40*t),-1!=="Sc".indexOf(this.nearWall)&&(this.y>=s&&this.momentum.y>=0?(this.y=s,this.momentum.y=0):this.momentum.y+=40*t),-1!=="_gIsTtRr".indexOf(this.aboveWall)&&this.momentum.y<0&&this.y<s&&(this.momentum.y=0),-1!=="I|R".indexOf(this.nearWall)&&(this.x<i&&this.momentum.x>0?this.blockedRight=!0:this.x>i&&this.momentum.x<0&&(this.blockedLeft=!0),this.x>=i-.5&&this.x<i?this.x=i-.51:this.x<i+.5&&this.x>i&&(this.x=i+.5)),("t"==this.nearWall&&this.newWall&&this.momentum.x>0||"T"==this.nearWall&&this.newWall&&this.momentum.x<0)&&function(t,i,e){t.wallMap=t.wallMap.replace(/[tTrR]/g,function(t){return e[t]})}(this.level,0,{t:"T",T:"t",r:"R",R:"r"}),this.x<0&&(this.blockedLeft=!0),this.x>this.level.width-1&&(this.blockedRight=!0)}for(var h=0;h<this.level.items.length;h++)h!=this.itemIndex&&this.level.items[h].active&&this.interact(this.level.items[h]);this.isStatic||(this.blockedLeft&&this.momentum.x<0&&(this.momentum.x=0),this.blockedRight&&this.momentum.x>0&&(this.momentum.x=0),this.momentum.y>20&&(this.momentum.y=20),this.momentum.x>50&&(this.momentum.x=50),this.momentum.x<-50&&(this.momentum.x=-50),this.x<-1&&(this.x=this.level.width),this.x>this.level.width+1&&(this.x=-1),this.x+=this.momentum.x*t,this.y+=this.momentum.y*t)}},draw:function(){},dropped:function(t,i,e){e instanceof T&&(e.dying=!0)},interact:function(t){this.avoid(t)},avoid:function(t){this.isSolid&&t.isSolid&&s(this.x,this.y,t.x,t.y)<.95&&(t.y>this.y&&this.momentum.y>0&&(this.momentum.y>10&&this.dropped(this.mapX,this.mapY,t),this.momentum.y=0),(this.x>t.x&&this.momentum.x<0||this.x<t.x&&this.momentum.x>0)&&this.pushAgainst(t))},pushAgainst:function(t){this.y>=t.y-.5?(this.momentum.x<0&&(this.blockedLeft=!0),this.momentum.x>0&&(this.blockedRight=!0),t.momentum.x+=this.momentum.x,this.momentum.x=0):this.momentum.y-=40*u}}),P=function(t,i,e,s,h,a){l.beginPath(),l.moveTo(t*d,i*d);for(var n=0;n<e.length-1;n+=2)l.lineTo((t+e[n])*d,(i+e[n+1])*d);L(s,h,a)},L=function(t,i,e){i&&(l.fillStyle=i,l.fill()),t&&(l.lineWidth=e?e*d:d/10,l.strokeStyle=t,l.stroke())},S=function(t,i,e,s,h,a){l.beginPath();for(var n=0;n<e.length;n+=1)l.arc((e[n][0]+t)*d,(e[n][1]+i)*d,e[n][2]*d,e[n][3]*Math.PI*2,e[n][4]*Math.PI*2);L(s,h,a)},T=R.extend({init:function(t,i,e){this.deathAnim=1,this.dying=!1,this._super(t,i,e)},process:function(t){this.dying?this.deathAnim<=.1?m=!0:this.deathAnim-=t:this._super(t),"g"==this.nearWall&&(this.active=!1),this.y>this.level.height&&(this.dying=!0)},draw:function(){this.active&&(l.fillStyle="blue",l.save(),l.translate((this.x+.5)*d,(this.y+.5)*d),l.save(),l.rotate(-1*i.LR*Math.PI/180),l.beginPath(),l.arc(0,0,d/2,(.5-.6*this.deathAnim)*Math.PI,(.5+.6*this.deathAnim)*Math.PI,!1),l.fillStyle="rgba(1,1,255,0.7);",l.fill(),l.translate(0,M*M*.1*d),this.momentum.y>0&&l.translate(0,-this.momentum.y*d*.05),this.momentum.x>0?l.scale(-.5,.2):l.scale(.5,.2),P(-.25,0,[.2,-.5,.6,.3,.6,-.3,.2,.5,0,0],!1,"#FF6600"),l.restore(),l.beginPath(),l.arc(0,0,d/2,-1,1.3*Math.PI,!1),l.strokeStyle="#bbf",l.stroke(),this.dying&&(P(0,.5,[.2,-.2,-.3,-.3,.25,-.4,0,-.65]),l.stroke()),l.restore())},dropped:function(t,i){this.dying=!0}}),k=R.extend({init:function(t,i,e){this._super(t,i,e)},process:function(t){this._super(t)},draw:function(){this.active&&(l.save(),l.translate((this.x+.5)*d,(this.y+.5)*d),l.save(),l.rotate(this.x*Math.PI),l.beginPath(),l.fillStyle="#444",l.arc(0,0,.5*d,0*Math.PI,2*Math.PI,!1),l.fill(),l.beginPath(),l.fillStyle="#f00",l.fillRect(-d/4,.6*-d,d/2,.2*d),l.fill(),P(0,-.5,[.1,-.3],"#fff"),l.restore(),l.restore())},dropped:function(t,i,e){var s=!1;this._super(t,i,e),"g"!=this.level.wallMap[t+i*this.level.width]||e||(s=!0),this.level.wallMap=this.level.wallMap.replaceAt(t+i*this.level.width,"."),this.active=!1,this.level.items.push(new A(this.x,this.y,this.level,s)),e&&e.dropped()}}),C=R.extend({init:function(t,i,e){this._super(t,i,e)},draw:function(){this.active&&(l.save(),l.translate((this.x+.5)*d,(this.y+.5)*d),l.save(),l.rotate(this.x*Math.PI),l.beginPath(),l.fillStyle="#d00",l.arc(0,0,.5*d,0*Math.PI,2*Math.PI,!1),l.fill(),l.beginPath(),l.fillStyle="#333",l.arc(.1*-d,.3*-d,.05*d,0*Math.PI,2*Math.PI,!1),l.arc(.1*d,.3*-d,.05*d,0*Math.PI,2*Math.PI,!1),l.arc(0,.2*-d,.05*d,0*Math.PI,2*Math.PI,!1),l.fill(),l.restore(),l.beginPath(),l.fillStyle="rgba(255,255,255,0.5)",l.arc(.2*-d,.2*-d,.2*d,0*Math.PI,2*Math.PI,!1),l.fill(),l.restore())},pushAgainst:function(t){t instanceof T&&(t.blockedLeft&&this.momentum.x<0||t.blockedRight&&this.momentum.x>0)&&(t.dying=!0),this._super(t)}}),W=R.extend({init:function(t,i,e){this._super(t,i,e),this.tilt=0},draw:function(){this.active&&(P(this.x,this.y+1,[.1,0,.5,-.5,.9,0,1,0],"#CD6839"),l.save(),l.translate((this.x+.5)*d,(this.y+.5)*d),l.rotate(-1*i.LR*Math.PI/180),P(-.5,-.25,[.5,.25,1,0],"#CD6839"),l.beginPath(),l.arc(0,.2*d,.3*d,0*Math.PI,2*Math.PI,!1),l.arc(0,-.25*d,.2*d,0*Math.PI,2*Math.PI,!1),l.fillStyle="#CD6839",l.fill(),l.beginPath(),l.fillStyle="#FF7D40",l.arc(0,-.25*d,.15*d,0*Math.PI,2*Math.PI,!1),l.fill(),S(0,.2,[[0,0,.2,0,2]],"#FF7D40"),S(0,-.3,[[-.05,0,.02,0,1],[.05,0,.02,0,1]],!1,"#000"),S(0,-.2,[[0,0,.05,0,1]],"#000",!1,.025),l.restore())},pushAgainst:function(t){t instanceof T&&(t.blockedLeft&&this.momentum.x<0||t.blockedRight&&this.momentum.x>0)&&(t.dying=!0),this._super(t)}}),D=R.extend({init:function(t,i,e){this._super(t,i,e),this.isStatic=!0,this.isSolid=!1},draw:function(){this.active&&(l.save(),l.translate((this.x+.5)*d,(this.y+.5)*d),l.scale(1,.3),l.rotate(x*Math.PI*2),P(-.5,0,[1,0],"#ff0",!1,.3),P(0,-.5,[0,1],"#ff0",!1,.3),l.restore())},interact:function(t){var i=s(this.x,this.y,t.x,t.y);!t.isStatic&&t.x-this.x<2&&t.x-this.x>-2&&i<5&&t.y<this.y&&(t.momentum.y-=u*(5-i+40))}}),A=R.extend({init:function(t,i,e,s){this._super(t,i,e),this.isStatic=!0,this.anim=1,this.isLethal=s,this.isSolid=!1},process:function(t){this.anim-=t,this.anim<=0&&(this.active=!1,this.isLethal&&(m=!0))},draw:function(){this.active&&(this.anim>.95&&(l.fillStyle="#fff",l.fillRect(0,0,e.width*d,this.level.height*d)),S(this.x,this.y+1,[[0,0,this.anim,0,1]],!1,"rgba(255,255,255,0.5)"),S(this.x,this.y+2*this.anim-1,[[-.3,-.2,this.anim/4,0,1]],!1,"rgba(100,100,100,0.8)"),S(this.x,this.y+2*this.anim-1,[[.3,-.3,this.anim/2,0,1]],!1,"rgba(100,100,100,0.5)"))},interact:function(t){}}),O=function(i){d=e.width/i.width,this.levelData=i,this.width=i.width,this.wallMap=i.wallMap.replace(/\s|\n/g,"");var h=i.itemMap.replace(/\s|\n/g,"");this.startTime=(new Date).getTime(),this.runTime=0,this.height=Math.max(Math.floor(this.wallMap.length/this.width)+1,e.height/d-1),this.items=[],v=null;var a,n,_,o=this;t||(e.LR=0,g=!1);for(var m=0;m<h.length;m++)a=m%i.width,n=Math.floor(m/i.width),"p"==h[m]&&this.items.push(new T(a,n,this,m)),"b"==h[m]&&this.items.push(new k(a,n,this,m)),"w"==h[m]&&this.items.push(new C(a,n,this,m)),"f"==h[m]&&this.items.push(new D(a,n,this,m)),"m"==h[m]&&this.items.push(new W(a,n,this,m));this.processLevel=function(t){var i=0,s=0;this.runTime=(new Date).getTime()-this.startTime;for(var h=0;h<this.items.length;h++)this.items[h].process(t),this.items[h]instanceof T&&this.items[h].active&&(i++,s+=this.items[h].y+1);0==i&&(r=!0),null==v?v=s/i-e.height/d/2:v+=(s/i-e.height/d/2-v)*t*10,v<0&&(v=0),v>this.height-e.height/d&&(v=this.height-e.height/d)},this.drawLevel=function(){l.lineWidth=d/10,l.save(),l.translate(0,-v*d),x=(new Date).getTime()%1e3/1e3,M=(M=(new Date).getTime()%4e3/2e3)>1?M=1-(M-1):M,y=(y=(new Date).getTime()%2e3/1e3)>1?y=1-(y-1):y;for(var t=0;t<o.wallMap.length;t++)a=t%i.width,n=Math.floor(t/i.width),_=o.wallMap[t],l.fillStyle="white","_IsgtTrR".indexOf(_)>-1&&l.fillRect(a*d,n*d+d,d,d/10),"I"!=_&&"|"!=_||l.fillRect(a*d+.45*d,n*d,d/10,d),"g"==_&&P(a+.5,n,[-.5,.5,-.5,1,.5,1,.5,.5,0,0],"","rgb("+Math.floor(255*y)+",255,"+Math.floor(255*y)+")"),"Ss".indexOf(_)>-1&&(P(a+.5,n+.5,[-.45,0,.45,0,0,0,-.3,.1,.3,.2,-.3,.3,.3,.4,-.3,.5]),l.strokeStyle="#f33",l.stroke()),"Sc".indexOf(_)>-1&&(l.beginPath(),l.fillStyle="rgba(255,255,255,0.7)",l.arc((a+.2)*d,(n+1)*d,.2*d,0*Math.PI,2*Math.PI,!1),l.arc((a+.8)*d,(n+1)*d,.2*d,0*Math.PI,2*Math.PI,!1),l.arc((a+.5)*d,(n+.9)*d,.3*d,0*Math.PI,2*Math.PI,!1),l.fill()),"R"==_&&P(a+.5,n,[0,1],"rgba(255,0,0,1)"),"r"==_&&P(a+.5,n,[-.5,.5],"rgba(255,0,0,0.5)"),"t"==_&&P(a+.5,n+1,[-.25,-.5,-.35,-.45],"rgba(255,0,0,1)"),"T"==_&&P(a+.5,n+1,[.25,-.5,.15,-.55],"rgba(255,0,0,1)");for(t=0;t<this.items.length;t++)this.items[t].draw();if(l.restore(),this.runTime<2e3||c==I.length-1){l.font=Math.floor(e.width/10)+"px ‘Lucida Sans Unicode’, ‘Lucida Grande’, sans-serif";var s=1;this.runTime>1e3&&c<I.length-1&&(s=1-this.runTime%1e3/1e3),l.fillStyle="rgba(255,100,0,"+s+")";var h=.5==(p=(r=c)>11-((m=I.length)-13)/2?(m-1-r)/2:13-r)?String.fromCharCode(189):Math.floor(p)+(p%1==.5?String.fromCharCode(189):"");c<I.length-1?l.fillText("Floor "+h,.3325*e.width,e.height*(.2+.2*s)):(l.fillText("Ground Floor ",.2*e.width,.1*e.height),l.fillText("All fishes saved",.17*e.width,.8*e.height),l.fillText("Game complete! ",.15*e.width,.9*e.height))}var r,m,p},this.click=function(t,i){e.touchX=t,e.touchY=i;for(var h=0;h<this.items.length;h++)obj=this.items[h],obj instanceof T&&s(t,i,obj.x+.5,obj.y+.5)<1&&(obj.dying=!0)}};window.setInterval(function(){var t;for(r&&c++,(r||m)&&(p=new O(I[c]),r=!1,m=!1),o=(new Date).getTime()-_,_=(new Date).getTime(),u=.01,t=0;t<o-10;t+=10)p.processLevel(.01);u=(o-t)/1e3,p.processLevel((o-t)/1e3),i.setupCanvas(),i.drawBackground(),p.drawLevel(),i.finishCanvas()},1e3/30),this.setupCanvas=function(){l.save(),l.globalCompositeOperation="source-over",l.fillStyle="#000",l.clearRect(0,0,a,h),t||(l.translate(a/2,h/2),l.rotate(1*i.LR*Math.PI/180),l.scale(.9,.9),l.translate(-i.width/2,-h/2),l.fillStyle="#000",l.fillRect(0,0,i.width,i.height),l.globalCompositeOperation="source-atop"),l.lineCap="round"},this.finishCanvas=function(){l.globalCompositeOperation="source-over",t||(l.strokeStyle="#888",l.lineWidth=d/5,l.strokeRect(-d/10,-d/10,i.width+d/5,i.height+d/5)),l.restore()},this.drawBackground=function(){l.save(),l.translate(i.width/2,0),l.rotate(-1*i.LR*Math.PI/180),l.translate(-i.width/2,-i.height/4);for(var t=0;t<255;t+=20)l.fillStyle="rgb("+1*(255-t)+","+(255-t)+",0)",l.fillRect(-i.width,t/256*i.height,3*i.width,22/256*i.height);l.restore()}}</script>