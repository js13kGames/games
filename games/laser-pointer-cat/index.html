<!doctype html><html><head><meta name=viewport content="width=device-width"><title>Laser Pointer Cat - js13kGames 2025</title><style>body{margin:0;overflow:hidden}</style><script src=/2025/webxr/playcanvas.js></script></head><body><canvas id=application></canvas><div class=message style=position:absolute;top:0;color:#fff></div></body></html><script>(()=>{const t=pc;function e(e,i,n,o,s,a,c,l,r="Arial"){const d=new t.CanvasFont(e,{color:c,fontName:r,fontSize:l,width:s,height:a});d.createTextures(i);const h=new t.Entity("ButtonText");return h.setLocalPosition(n,o,0),h.addComponent("element",{pivot:[.5,.5],anchor:[.5,.5,.5,.5],fontSize:l,text:i,type:t.ELEMENTTYPE_TEXT}),h.element.font=d,h}class i{constructor(e){this.isActive=!1,this.entity=new t.Entity("PointerLight"),this.entity.addComponent("light",{type:"omni",color:new t.Color(1,0,0),intensity:20,range:.25,castShadows:!1,falloffMode:t.LIGHTFALLOFF_INVERSESQUARED}),this.lightComponent=this.entity.light,this.sphereEntity=new t.Entity("PointerLightSphere"),this.sphereEntity.addComponent("model",{type:"sphere"}),this.sphereEntity.setLocalScale(.1,.1,.1);const i=new t.StandardMaterial;i.emissive=t.Color.RED,i.useLighting=!1,i.update(),this.sphereEntity.model.material=i,this.entity.addChild(this.sphereEntity),e.root.addChild(this.entity),this.setVisible(!1)}setPosition(t){this.entity.setLocalPosition(t)}setActive(t){this.isActive!==t&&(this.isActive=t,this.setVisible(t))}getActive(){return this.isActive}setVisible(t){this.entity.enabled=t}destroy(){this.entity&&this.entity.parent&&this.entity.parent.removeChild(this.entity),this.entity.destroy()}}function n(e,i,n){const o=n.getMin(),s=n.getMax();let a=(o.x-e.x)/i.x,c=(s.x-e.x)/i.x;a>c&&([a,c]=[c,a]);let l=(o.y-e.y)/i.y,r=(s.y-e.y)/i.y;if(l>r&&([l,r]=[r,l]),a>r||l>c)return null;l>a&&(a=l),r<c&&(c=r);let d=(o.z-e.z)/i.z,h=(s.z-e.z)/i.z;return d>h&&([d,h]=[h,d]),a>h||d>c?null:(d>a&&(a=d),a>=0?(new t.Vec3).copy(e).add((new t.Vec3).copy(i).mulScalar(a)):null)}function o(t,e,i){let n,o=1/0,s=-1;for(let a=0;a<i.length;a++){const c=i[a].render.meshInstances[0];if(c.aabb.intersectsRay(t)){const t=c.aabb.center.distance(e.getPosition());t<o&&(n=c,o=t,s=o)}}return{meshHit:n,distance:s}}class s extends t.Script{constructor(){super(...arguments),this.state="SLEEP",this.stateTimer=0,this.stateTimeout=0,this.moveSpeed=1.2,this.movementDirection=new t.Vec3,this.velocity=new t.Vec3,this.acceleration=new t.Vec3(0,-9.8,0),this.jumpSpeed=6,this.isJumping=!1,this.potentialTargets=[],this.targetEntity=null,this.wanderTarget=new t.Vec3,this.wanderTimer=0,this.WANDER_DISTANCE=1,this.WANDER_TARGET_TIMEOUT=1.5,this.WANDER_CHECK_INTERVAL=2,this.DISTRACTED_DURATION=1,this.POUNCE_TELEGRAPH_DURATION=1,this.CHASE_RADIUS=2,this.POUNCE_RADIUS=6}initialize(){this.changeState("SLEEP"),this.floorY=this.entity.getPosition().y,this.app.on("cat:changeState",this.changeState.bind(this)),this.app.on("cat:setPotentialTargets",this.setPotentialTargets.bind(this)),this.app.on("cat:findNewTarget",this.findNewTarget.bind(this))}update(t){switch(this.stateTimer+=t,this.state){case"SLEEP":this.updateSleep(t);break;case"IDLE":this.updateIdle(t);break;case"WANDER":this.updateWander(t);break;case"CHASE_TARGET":this.updateChaseTarget(t);break;case"POUNCE_TARGET":this.updatePounceTarget(t);break;case"DISTRACTED":this.updateDistracted(t);break;case"JUMPING":this.updateJumping(t)}this.updatePhysics(t)}setPotentialTargets(t){this.potentialTargets=t}targetActive(){return this.targetEntity&&this.targetEntity.enabled}changeState(t){this.onStateExit(this.state),this.state=t,this.stateTimer=0,this.onStateEnter(t)}onStateEnter(t){const e=this.entity.findByName("TailRoot");switch(t){case"IDLE":e.setLocalEulerAngles(40,0,0),this.stateTimeout=0;break;case"WANDER":e.setLocalEulerAngles(40,0,0),this.wanderTarget=this.entity.getPosition().clone(),this.stateTimeout=this.WANDER_CHECK_INTERVAL;break;case"CHASE_TARGET":this.targetActive()&&(e.setLocalEulerAngles(0,0,0),this.faceTarget(this.targetEntity),this.stateTimeout=.2);break;case"POUNCE_TARGET":this.targetActive()&&(this.faceTarget(this.targetEntity),e&&e.setLocalEulerAngles(-60,0,0),this.stateTimeout=this.POUNCE_TELEGRAPH_DURATION);break;case"DISTRACTED":this.stateTimeout=this.DISTRACTED_DURATION;const t=this.entity.getPosition();this.wanderTarget.set(t.x,this.floorY,t.z),this.findNewTarget()}}onStateExit(t){switch(t){case"CHASE_TARGET":case"POUNCE_TARGET":case"DISTRACTED":break;case"WANDER":this.wanderTarget.set(0,this.entity.getPosition().y,0)}}updateSleep(e){this.velocity=new t.Vec3}updateIdle(t){this.changeState("WANDER")}updateWander(t){const e=this.entity.getPosition();if(this.stateTimer>=this.stateTimeout&&(this.findNewTarget(),this.stateTimer=0),this.wanderTimer+=t,this.wanderTimer>=this.WANDER_TARGET_TIMEOUT){if(Math.random()>.5&&this.WANDER_DISTANCE>0){const t=2*Math.random()*Math.PI,i=Math.random()*this.WANDER_DISTANCE;this.wanderTarget.x=e.x+Math.cos(t)*i,this.wanderTarget.z=e.z+Math.sin(t)*i,this.wanderTarget.y=e.y}else this.wanderTarget.set(0,0,0);this.wanderTimer=0}if(this.wanderTarget)if(this.movementDirection.x=this.wanderTarget.x-e.x,this.movementDirection.z=this.wanderTarget.z-e.z,this.movementDirection.y=0,this.movementDirection.length()<.1)this.wanderTarget.set(0,0,0),this.movementDirection.set(0,0,0);else{this.movementDirection.normalize();const i=this.movementDirection.clone().mulScalar(this.moveSpeed*t),n=e.clone().add(i);n.y=e.y,this.entity.setPosition(n);const o=n.clone().add(this.movementDirection);o.y=e.y,this.entity.lookAt(o)}else this.movementDirection.set(0,0,0)}updateChaseTarget(t){if(!this.targetActive())return void this.changeState("IDLE");if(this.stateTimer<this.stateTimeout)return void this.faceTarget(this.targetEntity);const e=this.targetEntity.getPosition(),i=this.entity.getPosition();this.movementDirection.x=e.x-i.x,this.movementDirection.y=0,this.movementDirection.z=e.z-i.z,this.movementDirection.normalize();const n=this.movementDirection.clone().mulScalar(this.moveSpeed*t),o=i.clone().add(n);this.entity.setPosition(o);const s=o.clone().add(this.movementDirection);s.y=i.y,this.entity.lookAt(s),Math.sqrt(Math.pow(e.x-i.x,2)+Math.pow(e.z-i.z,2))}updatePounceTarget(t){this.targetActive()||this.isJumping?this.stateTimer<this.POUNCE_TELEGRAPH_DURATION?this.faceTarget(this.targetEntity):this.stateTimer>=this.POUNCE_TELEGRAPH_DURATION&&!this.isJumping&&this.initiateJump():this.changeState("IDLE")}updateDistracted(t){this.stateTimer>=this.stateTimeout&&this.changeState("WANDER")}updateJumping(t){const e=this.entity.getPosition().clone().add(this.velocity.clone().mulScalar(t));e.y<=this.floorY&&(e.y=this.floorY,this.entity.setPosition(e),this.velocity.set(0,0,0),this.isJumping=!1,this.changeState("DISTRACTED"))}updatePhysics(e){this.velocity.add(this.acceleration.clone().mulScalar(e));const i=this.entity.getPosition();i.add(this.velocity.clone().mulScalar(e)),i.y<=this.floorY&&(i.y=this.floorY,this.velocity.set(0,0,0),this.isJumping=!1),this.entity.setPosition(i);const n=this.entity.getPosition();n.x=t.math.clamp(n.x,-4,4),n.z=t.math.clamp(n.z,-4,4),this.entity.setPosition(n)}findNewTarget(){if("SLEEP"===this.state)return;const t=this.entity.getPosition();let e=null,i=1/0;for(const n of this.potentialTargets){if(!n.enabled)continue;const o=n.getPosition(),s=Math.sqrt(Math.pow(o.x-t.x,2)+Math.pow(o.z-t.z,2));s<i&&(i=s,e=n)}e&&(this.targetEntity=e,i<=this.CHASE_RADIUS?"CHASE_TARGET"!==this.state&&"JUMPING"!==this.state&&this.changeState("CHASE_TARGET"):i<=this.POUNCE_RADIUS?"POUNCE_TARGET"!==this.state&&"JUMPING"!==this.state&&this.changeState("POUNCE_TARGET"):this.changeState("IDLE"))}faceTarget(e){const i=e.getPosition(),n=this.entity.getPosition(),o=new t.Vec3(i.x,n.y,i.z);this.entity.lookAt(o)}initiateJump(){if(!this.targetActive())return;this.isJumping=!0;const t=this.entity.getPosition(),e=this.targetEntity.getPosition(),i=e.x-t.x,n=e.z-t.z,o=Math.sqrt(i*i+n*n),s=Math.PI/4,a=Math.abs(this.acceleration.y),c=Math.sqrt(a*o/Math.sin(2*s));if(c<=this.jumpSpeed){const t=c*Math.cos(s),e=c*Math.sin(s);o>0?(this.velocity.x=i/o*t,this.velocity.z=n/o*t):(this.velocity.x=0,this.velocity.z=0),this.velocity.y=e}else{const t=.25,e=this.jumpSpeed,s=a,c=o,l=e*e*e*e-s*(s*c*c+2*t*e*e);if(l>=0){const t=Math.sqrt(l),a=(e*e+t)/(s*c),r=(e*e-t)/(s*c),d=Math.atan(a),h=Math.atan(r),m=Math.max(d,h),E=e*Math.cos(m),y=e*Math.sin(m);o>0?(this.velocity.x=i/o*E,this.velocity.z=n/o*E):(this.velocity.x=0,this.velocity.z=0),this.velocity.y=y}else{const t=Math.PI/3,e=this.jumpSpeed*Math.cos(t),s=this.jumpSpeed*Math.sin(t);o>0?(this.velocity.x=i/o*e,this.velocity.z=n/o*e):(this.velocity.x=0,this.velocity.z=0),this.velocity.y=s}}this.changeState("JUMPING")}}const a="252c04d63412fd78d21a.glb";class c{constructor(e,i,n,o){const s=o.instantiateRenderEntity();s.setPosition(e),s.setLocalEulerAngles(i),s.setLocalScale(n);const a=new t.StandardMaterial;a.diffuse=new t.Color(.988,.855,.565),a.update();const c=s.findComponents("render");for(const t of c)for(const e of t.meshInstances)e.material=a;this.entity=s}}const l=()=>{const e=new t.Entity("Cloud"),i=t.math.random(1,3),n=Math.floor(t.math.random(2,4)),o=Math.floor(t.math.random(3,6)),s=new t.StandardMaterial;s.diffuse=new t.Color(1,1,1),s.update();for(let a=0;a<n;a++){const n=.5*a,c=1-.2*a;for(let a=0;a<o;a++){const l=a/o*Math.PI*2,r=(.5*Math.random()+.5)*(1.5*c),d=Math.cos(l)*r,h=Math.sin(l)*r,m=n+.1*Math.random(),E=i*c*(1+.3*(Math.random()-.5)),y=new t.Entity("CloudSphere");y.addComponent("model",{type:"sphere",castShadows:!1}),y.setLocalPosition(d,m,h),y.setLocalScale(E,.8*E,E),y.model.material=s,e.addChild(y)}}return e},r=(e,i,n)=>{for(let o=0;o<i;o++){const s=l(),a=o/i*Math.PI*2,c=1+2*Math.random(),r=new t.Vec3(n.x+Math.cos(a)*c,n.y+1*Math.random(),n.z+Math.sin(a)*c);s.setPosition(r),e.root.addChild(s)}},d=document.getElementById("application");window.focus();const h=function(t){let e=document.querySelector(".message");e||(e=document.createElement("div"),e.classList.add("message"),document.body.append(e)),e.textContent=t},m=new t.Application(d,{mouse:new t.Mouse(d),touch:new t.TouchDevice(d),keyboard:new t.Keyboard(window)});m.elementInput=new t.ElementInput(d),m.setCanvasFillMode(t.FILLMODE_FILL_WINDOW),m.setCanvasResolution(t.RESOLUTION_AUTO);const E=()=>m.resizeCanvas();window.addEventListener("resize",E),m.on("destroy",()=>{window.removeEventListener("resize",E)}),m.graphicsDevice.maxPixelRatio=window.devicePixelRatio,m.start();const y=new t.Entity;m.root.addChild(y);const u=new t.Entity;u.addComponent("camera",{clearColor:new t.Color(.173,.243,.314),farClip:1e4}),y.addChild(u);const p=new t.Entity;p.addComponent("light",{type:"directional"}),p.rotate(-45,135,0),m.root.addChild(p),m.scene.ambientLight=t.Color.GRAY;const g=new t.Color(.337,.58,.867),T=function(e,i,n,o){const s=new t.Texture(e.graphicsDevice,{width:4,height:4,format:t.PIXELFORMAT_R8_G8_B8,addressU:t.ADDRESS_CLAMP_TO_EDGE,addressV:t.ADDRESS_CLAMP_TO_EDGE}),a=n,c=n,l=o,r=o,d=s.lock();let h=0;const m=new t.Color,E=new t.Color,y=new t.Color;for(let t=0;t<4;t++)for(let e=0;e<4;e++){const i=t/3,n=e/3;m.lerp(a,c,i),E.lerp(r,l,i),y.lerp(m,E,n),d[h++]=255*y.r,d[h++]=255*y.g,d[h++]=255*y.b}return s.unlock(),s}(m,0,g,g);m.scene.skybox=T;for(let e=-10;e<10;e++)for(let i=-10;i<10;i++)Math.random()<.04&&r(m,5,new t.Vec3(3*e+t.math.random(-3,3),5,3*i+t.math.random(-3,3)));const w=[],C=[],A=new t.Vec3(90,0,0),f=new Image;f.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAAXNSR0IArs4c6QAAABpJREFUCJlj9juf9/83H0MD828+hgadKHMGAEYyBmBrYooFAAAAAElFTkSuQmCC",f.onload=()=>{const e=function(){const e=new t.Entity;return e.addComponent("render",{type:"box",material:new t.StandardMaterial}),e.setLocalScale(9,1,9),e.translate(0,-1.5,0),m.root.addChild(e),w.push(e),e}();e.name="Floor";const i=e.render.material,n=new t.Texture(m.graphicsDevice,{width:f.width,height:f.height,format:t.PIXELFORMAT_R8_G8_B8_A8,magFilter:t.FILTER_LINEAR,minFilter:t.FILTER_LINEAR});n.setSource(f),n.minFilter=t.FILTER_NEAREST,n.magFilter=t.FILTER_NEAREST,i.diffuse=new t.Color(.3,.81,.43),i.diffuseMap=n,i.diffuseMapTiling=new t.Vec2(8,8)};const P=new t.Entity("TitleScreen");P.setLocalScale(.01,.01,.01),P.setPosition(0,0,-2.5),P.addComponent("screen",{referenceResolution:new t.Vec2(1280,720),screenSpace:!1}),m.root.addChild(P);const S=e(m,"Laser Pointer Cat",0,48,200,100,new t.Color,36);P.addChild(S);const L=new class{constructor(i,n={}){const{position:o=new t.Vec3(0,0,0),text:s="Button",width:a=354,height:c=100,fontSize:l=32,textColor:r=t.Color.BLACK,backgroundColor:d=t.Color.WHITE,hoverTint:h=new t.Color(0,.5019607843137255,1,1),pressedTint:m=new t.Color(.5019607843137255,1,.5019607843137255,1),inactiveTint:E=new t.Color(1,1,1,.5019607843137255),clickCallback:y=()=>{}}=n;this.entity=new t.Entity("Button"),this.entity.setLocalPosition(o);const u=new t.Entity;u.setLocalPosition(o),u.addComponent("button",{active:!0,transitionMode:0,hoverTint:h,pressedTint:m,inactiveTint:E,fadeDuration:0}),u.addComponent("element",{anchor:[.5,.5,.5,.5],width:a,height:c,pivot:[.5,.5],type:t.ELEMENTTYPE_IMAGE,useInput:!0,color:d}),this.entity.addChild(u);const p=e(i,s,o.x,o.y,a,c,r,l);this.entity.addChild(p),u.button.on("click",()=>{u.element.color=m,y()})}}(m,{text:"Start",position:new t.Vec3(0,-24,0),width:80,height:40,fontSize:24,textColor:new t.Color,backgroundColor:t.Color.WHITE,hoverTint:new t.Color(0,.5,1,1),pressedTint:new t.Color(.5,1,.5,1),inactiveTint:new t.Color(1,1,1,.5),clickCallback:()=>{0===R&&(R=1,setTimeout(()=>{S.enabled=!1,L.entity.enabled=!1,m.fire("cat:changeState","IDLE")},800))}});P.addChild(L.entity);let R=0;const v=[],D={url:a,filename:a},M=new t.Asset(a,"container",D,null,null);M.once("load",function(e){const i=new t.Vec3(0,-1,0),n=new t.Vec3,o=new t.Vec3(1,1,1),s=new c(i,n,o,e.resource),a=.232,l=.276,r=Math.floor(14.354166666666666),d=(8.268-r*l)/r,h=Math.floor(8.224/.532),E=(8.224-h*a)/h;let y=-4.134;for(let e=0;e<h+1;e++){const e=new t.Vec3(y,-1,-4.25),i=new t.Vec3(0,-90,0),n=s.entity.clone();n.setPosition(e),n.setEulerAngles(i),m.root.addChild(n),w.push(n),y+=a+E}let u=-4.134;for(let e=0;e<r+1;e++){const e=new t.Vec3(4.25,-1,u),i=new t.Vec3(0,180,0),n=s.entity.clone();n.setPosition(e),n.setEulerAngles(i),m.root.addChild(n),w.push(n),u+=l+d}let p=-4.134;for(let e=0;e<h+1;e++){const e=new t.Vec3(p,-1,4.25),i=new t.Vec3(0,90,0),n=s.entity.clone();n.setPosition(e),n.setEulerAngles(i),m.root.addChild(n),w.push(n),p+=a+E}let g=-4.134;for(let e=0;e<r+1;e++){const e=new t.Vec3(-4.25,-1,g),i=new t.Vec3(0,0,0),n=s.entity.clone();n.setPosition(e),n.setEulerAngles(i),m.root.addChild(n),w.push(n),g+=l+d}}),m.assets.add(M),m.assets.load(M);const x="box",I="cylinder",_=new t.Entity;_.addComponent("script"),_.translate(0,.168,0),_.script.create(s);const N=new t.Entity("Body");N.addComponent("model",{type:x}),N.setLocalScale(.2,.18,.4),_.addChild(N);const b=new t.Entity("Leg");b.addComponent("model",{type:x}),b.setLocalScale(.27,.5,.11),b.setLocalPosition(.3,-.7,.4),N.addChild(b);const z=b.clone();z.setLocalPosition(.3,-.7,-.4),N.addChild(z);const V=b.clone();V.setLocalPosition(-.3,-.7,.4),N.addChild(V);const O=b.clone();O.setLocalPosition(-.3,-.7,-.4),N.addChild(O);const U=new t.Entity;U.addComponent("model",{type:x}),U.setLocalScale(.16,.15,.17),U.setLocalPosition(0,.05,-.28),_.addChild(U);const k=new t.Entity("Ear");k.addComponent("model",{type:"cone"}),k.setLocalScale(.3,.45,.3),k.setLocalPosition(.4,.65,.3),U.addChild(k);const G=k.clone();G.setLocalPosition(-.4,.65,.3),U.addChild(G),k.setLocalEulerAngles(0,0,-20),G.setLocalEulerAngles(0,0,20);const H=new t.Entity;H.addComponent("model",{type:x}),H.setLocalScale(.8,.05,.05),H.setLocalPosition(.45,-.057,-.536),H.setLocalEulerAngles(0,0,8),U.addChild(H);const F=H.clone();F.setLocalEulerAngles(0,0,-8),F.setLocalPosition(-.45,-.057,-.536),U.addChild(F);const Y=H.clone();Y.setLocalEulerAngles(0,0,-10),Y.setLocalPosition(.45,-.212,-.536),U.addChild(Y);const W=H.clone();W.setLocalEulerAngles(0,0,10),W.setLocalPosition(-.45,-.212,-.536),U.addChild(W);const B=new t.Entity("TailRoot");B.setLocalPosition(0,.04,.192),_.addChild(B);const J=new t.Entity("Tail");J.addComponent("model",{type:x}),J.setLocalScale(.04,.04,.3),J.setLocalPosition(0,.014,.13),B.addChild(J);const K=new t.StandardMaterial;K.diffuse=new t.Color(.1,.1,.1),_.children.forEach(e=>{e instanceof t.Entity&&(e.model&&(e.model.material=K),e.children.forEach(e=>{e instanceof t.Entity&&e.model&&(e.model.material=K)}))});const X=new t.Entity("Bandana");X.addComponent("model",{type:x}),X.setLocalScale(1.1,.5,1.1),X.setLocalPosition(0,.162,0);const j=new t.StandardMaterial;j.diffuse=new t.Color(.729,.031,.031),X.model.material=j,U.addChild(X);const q=new t.Entity;q.addComponent("model",{type:I}),q.setLocalScale(.33,.13,.33),q.setLocalPosition(.26,.144,-.51),q.setLocalEulerAngles(90,0,0),U.addChild(q);const Q=q.clone();Q.setLocalPosition(-.26,.144,-.51),U.addChild(Q);const $=new t.StandardMaterial;$.diffuse=t.Color.BLACK;const Z=new t.Entity;Z.addComponent("model",{type:I}),Z.setLocalScale(.5,1,1),Z.setLocalPosition(0,-.1,0),Z.model.material=$,q.addChild(Z);const tt=Z.clone();Q.addChild(tt);const et=new t.Entity;et.addComponent("model",{type:"sphere"}),et.setLocalScale(.15,.15,.15),et.setLocalPosition(0,-.11,-.56),U.addChild(et);const it=new t.Entity;it.setLocalPosition(0,-1,0),it.rotate(0,180,0),it.addChild(_),m.root.addChild(it);let nt=!1;const ot=function(){if(m.xr.isAvailable(t.XRTYPE_VR))u.camera.startXr(t.XRTYPE_VR,t.XRSPACE_LOCAL,{callback:function(t){t&&h(`Immersive VR failed to start: ${t.message}`)}});else{if(h("Immersive VR is not available"),nt)return;nt=!0,m.on("update",e=>{const i=m.keyboard,n=y.forward,o=y.right,s=new t.Vec3;i.isPressed(t.KEY_W)&&s.add(n.clone().mulScalar(3*e)),i.isPressed(t.KEY_S)&&s.add(n.clone().mulScalar(-3*e)),i.isPressed(t.KEY_A)&&s.add(o.clone().mulScalar(-3*e)),i.isPressed(t.KEY_D)&&s.add(o.clone().mulScalar(3*e)),y.translate(s);const a=y.getPosition();if(a.x=t.math.clamp(a.x,-4,4),a.z=t.math.clamp(a.z,-4,4),y.setPosition(a),i.isPressed(t.KEY_LEFT)||i.isPressed(t.KEY_RIGHT)){let e=0;i.isPressed(t.KEY_LEFT)?e=1:i.isPressed(t.KEY_RIGHT)&&(e=-1),y.rotateLocal(0,.5*e,0)}}),m.mouse.on("mousedown",e=>{let s=new t.Vec3;const a=y;let c;u.camera.screenToWorld(e.x,e.y,10,s),0===v.length?(c=new i(m),v.push(c),m.fire("cat:setPotentialTargets",v.map(t=>t.entity))):c=v[0],c.setActive(!0);const l=new t.Ray(a.getPosition(),s.sub(a.getPosition())),r=o(l,a,w);if(r.meshHit){const t=n(l.origin,l.direction,r.meshHit.aabb);t&&(c.setPosition(t),m.fire("cat:findNewTarget"))}})}};if(m.mouse.on("mousedown",()=>{m.xr.active||ot()}),m.xr.supported){m.touch&&m.touch.on("touchend",t=>{m.xr.active?u.camera.endXr():ot(),t.event.preventDefault(),t.event.stopPropagation()}),m.keyboard.on("keydown",e=>{e.key===t.KEY_ESCAPE&&m.xr.active&&m.xr.end()}),m.xr.input.on("add",e=>{!function(e){const i=new t.Entity;i.addComponent("model",{type:"box"}),i.model.hide(),C.push(i),y.addChild(i),i.inputSource=e;const n=new t.Entity("LaserPointer");n.addComponent("model",{type:I}),n.setLocalScale(.03,.12,.03),n.setLocalRotation((new t.Quat).setFromEulerAngles(A)),i.addChild(n),e.on("remove",()=>{C.splice(C.indexOf(i),1),i.destroy()})}(e),v.push(new i(m)),m.fire("cat:setPotentialTargets",v.map(t=>t.entity))}),h("Tap on screen to enter VR");const e=1.5,s=45,a=.5,c=.25;let l=0;const r=new t.Vec2,d=new t.Vec2,E=new t.Vec3,p=new t.Vec3,g=new t.Color(1,1,1),T=new t.Vec3,f=new t.Ray;m.on("update",i=>{let h,A;for(h=0;h<C.length;h++)if(A=C[h].inputSource,A.gamepad)if(A.handedness===t.XRHAND_LEFT){if(r.set(A.gamepad.axes[2],A.gamepad.axes[3]),r.length()){r.normalize(),d.x=u.forward.x,d.y=u.forward.z,d.normalize();const n=Math.atan2(d.x,d.y)-Math.PI/2,o=r.x*Math.sin(n)-r.y*Math.cos(n);r.y=r.y*Math.sin(n)+r.x*Math.cos(n),r.x=o,r.mulScalar(e*i),y.translate(r.x,0,r.y);const s=y.getPosition();s.x=t.math.clamp(s.x,-4,4),s.z=t.math.clamp(s.z,-4,4),y.setPosition(s)}}else if(A.handedness===t.XRHAND_RIGHT){const t=-A.gamepad.axes[2];(l>0&&t<c||l<0&&t>-.25)&&(l=0),0===l&&Math.abs(t)>a&&(l=Math.sign(t),E.copy(u.getLocalPosition()),y.translateLocal(E),y.rotateLocal(0,Math.sign(t)*s,0),y.translateLocal(E.mulScalar(-1)))}for(h=0;h<C.length;h++)if(A=C[h].inputSource,E.copy(A.getOrigin()),p.copy(A.getDirection()),p.mulScalar(100).add(E),m.drawLine(E,p,g),A.grip){const t=A.getLocalPosition();C[h].model.enabled=!0,C[h].setLocalPosition(t);const e=C[h].getPosition().clone().add(A.getDirection().normalize());C[h].lookAt(e,C[h].up)}let P=null;for(let e=0;e<m.xr.input.inputSources.length;e++){const i=m.xr.input.inputSources[e];if(i.targetRayMode===t.XRTARGETRAY_POINTER){T.copy(i.getDirection()).mulScalar(10).add(i.getOrigin());const e=i.selecting?t.Color.RED:t.Color.WHITE;m.drawLine(i.getOrigin(),T,e)}if(e<v.length){const t=v[e];f.set(i.getOrigin(),i.getDirection());const s=o(f,y,w);if(s.meshHit&&(P=s.meshHit),P){const e=n(f.origin,f.direction,P.aabb);e&&(t.setPosition(e),m.fire("cat:findNewTarget"))}t.setActive(i.selecting&&null!==P)}}})}else h("WebXR is not supported")})()</script>