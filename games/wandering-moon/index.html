<script src=/2017/webxr/aframe.js></script><title>Wandering Moon</title><script>AFRAME.registerComponent("orbit",{schema:{ir:{type:"number"},or:{type:"number"}},multiple:!0,init:function(){this.orbiting=!1;let t=this.el,e=[];for(let i=0;3>i;i++)e[i]=document.createElement("a-ring"),e[i].setAttribute("radius-outer",this.data.or),e[i].setAttribute("radius-inner",this.data.ir),e[i].setAttribute("color","white"),e[i].setAttribute("opacity","0.1"),e[i].setAttribute("material","side:double"),e[i].addEventListener("mouseenter",this.mouseEnter),e[i].addEventListener("mouseleave",this.mouseExit),e[i].setAttribute("class","orbit"),t.appendChild(e[i]);if(e[0].setAttribute("rotation","0 0 0"),e[1].setAttribute("rotation","0 90 90"),e[2].setAttribute("rotation","90 90 0"),this.orbits=e,"destination"===t.getAttribute("id"))t.setAttribute("color","#26871f");else{let e=["red","brown","orange"];t.setAttribute("color",e[Math.floor(Math.random()*e.length)])}},enterOrbit:function(){this.orbiting=!0;for(let t=0;3>t;t++)this.el.removeChild(this.orbits[t])},exitOrbit:function(){this.orbiting=!1;for(let t=0;3>t;t++)this.orbits[t].setAttribute("material","side:double"),this.el.appendChild(this.orbits[t])},mouseEnter:t=>{t.target.setAttribute("opacity","0.5")},mouseExit:t=>{t.target.setAttribute("opacity","0.1")}}),AFRAME.registerComponent("moon",{init:function(){var t=Math.atan2;this.d=2*Math.PI/500,this.t=0,this.state=0,this.time=0,this.movement={},this.r="000",this.orbiting=document.querySelector("#initial").components.orbit,this.orbiting.enterOrbit(),this.oldOrbit=null,this.o=this.orbiting.el.getAttribute("position"),this.o.h=100;let e=this.o.x+this.o.h;this.el.setAttribute("position",{x:e,y:this.o.y,z:this.o.z}),this.el.setAttribute("camera",""),this.el.setAttribute("look-controls","");let i=document.createElement("a-entity");i.setAttribute("click-everywhere",""),i.setAttribute("cursor","fuse:false;downEvents:gp-down;upEvents:gp-up"),i.setAttribute("raycaster","far: 1500"),i.setAttribute("position","0 0 -1"),i.setAttribute("geometry","primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"),i.setAttribute("material","color: white; shader: flat"),this.el.appendChild(i),this.planes={"000":(t,e,i)=>{let s=this.computeLoc(e-this.o.x,i-this.o.y);t.setAttribute("position",{x:s.x+this.o.x,y:s.y+this.o.y,z:this.o.z})},"09090":(t,e,i,s)=>{let o=this.computeLoc(i-this.o.y,s-this.o.z);t.setAttribute("position",{x:this.o.x,y:o.x+this.o.y,z:o.y+this.o.z})},90900:(t,e,i,s)=>{let o=this.computeLoc(e-this.o.x,s-this.o.z);t.setAttribute("position",{x:o.x+this.o.x,y:this.o.y,z:o.y+this.o.z})}},this.el.querySelector("a-entity[cursor]").addEventListener("click",(e=>{if(console.log("hey"),"orbit"===e.detail.intersectedEl.getAttribute("class")&&0===this.state&&!e.detail.intersectedEl.parentEl.components.orbit.orbiting){let i=e.detail.intersection,s=this.el.getAttribute("position"),o=i.distance,r={};r.t=o/10,r.x=(i.point.x-s.x)/r.t,r.y=(i.point.y-s.y)/r.t,r.z=(i.point.z-s.z)/r.t,r.dest=i.point,this.movement=r;let n=e.detail.intersectedEl.getAttribute("rotation");switch(this.r=""+n.x+n.y+n.z,this.oldOrbit=this.orbiting,this.orbiting=e.detail.intersectedEl.parentEl.components.orbit,this.o=e.detail.intersectedEl.parentEl.getAttribute("position"),this.orbiting.enterOrbit(),this.r){case"000":this.o.h=this.dist(i.point.x,this.o.x,i.point.y,this.o.y),this.angle=t(i.point.y-this.o.y,i.point.x-this.o.x);break;case"09090":this.o.h=this.dist(i.point.y,this.o.y,i.point.z,this.o.z),this.angle=t(i.point.y-this.o.y,i.point.z-this.o.z);break;case"90900":this.o.h=this.dist(i.point.z,this.o.z,i.point.x,this.o.x),this.angle=t(i.point.x-this.o.x,i.point.z-this.o.z)}this.state=1}}))},tick:function(t){if(!(10>t-this.time)){let t=this.el;switch(this.state){case 0:let e=t.getAttribute("position");this.planes[this.r](t,e.x,e.y,e.z);break;case 1:let i=this.movement,s=t.getAttribute("position");if(t.setAttribute("position",{x:s.x+i.x,y:s.y+i.y,z:s.z+i.z}),this.t++,this.t>i.t&&(t.setAttribute("position",i.dest),this.t=0,this.state=0,this.oldOrbit.exitOrbit(),"destination"===this.orbiting.el.getAttribute("id"))){let e=document.createElement("a-image");e.setAttribute("src","#endtext"),e.setAttribute("width","4"),e.setAttribute("position","-0.7 0 -1"),t.appendChild(e),t.removeChild(t.querySelector("a-entity[cursor]"));let i=document.createElement("a-entity");i.setAttribute("click-everywhere",""),i.setAttribute("cursor","fuse:false;downEvents:gp-down;upEvents:gp-up"),i.setAttribute("raycaster","far: 1500"),i.setAttribute("position","0 0 -1"),i.addEventListener("mousedown",(()=>{let t=document.querySelector("a-scene"),e=t.parentElement;document.createElement("a-scene").setAttribute("galaxy",""),vr&&t.exitVR(),e.removeChild(t),document.querySelector("#intro").setAttribute("style","display:block")})),t.appendChild(i),console.log("you won")}}}},computeLoc:function(t,e){let i=Math.atan2(e,t)+this.d;return{a:i,x:this.o.h*Math.cos(i),y:this.o.h*Math.sin(i)}},dist:function(t,e,i,s){var o=Math.pow;return Math.sqrt(o(e-t,2)+o(s-i,2))}}),AFRAME.registerComponent("galaxy",{schema:{x:{type:"number",default:5},y:{type:"number",default:5},z:{type:"number",default:5}},init:function(){var t=Math.floor;let e=document.createElement("a-assets"),i=document.createElement("canvas");i.setAttribute("id","endtext"),i.setAttribute("width",4e3),i.setAttribute("height","500"),e.appendChild(i),this.el.appendChild(e);let s=i.getContext("2d");s.font="75px Courier New",s.fillStyle="white",s.fillText("Home at last!\nClick to restart.",i.width/2,i.height/2,i.width),this.planets=[];for(let e=0;e<this.data.x;e++){this.planets[e]=[];for(let i=0;i<this.data.y;i++){this.planets[e][i]=[];for(let s=0;s<this.data.z;s++){let o=document.createElement("a-sphere"),r=t(60*Math.random()+20),n=r+t(50*Math.random()+20),a=n+t(75*Math.random()+15),h=500*e+t(300*Math.random()-150),l=500*i+t(300*Math.random()-150),d=500*s+t(300*Math.random()-150);o.setAttribute("position",{x:h,y:l,z:d}),o.setAttribute("radius",r),o.setAttribute("orbit",{ir:n,or:a}),this.planets[e][i][s]=o,this.el.appendChild(o)}}}let o,r=this.planets[t(Math.random()*this.data.x)][t(Math.random()*this.data.y)][t(Math.random()*this.data.z)];r.setAttribute("id","initial");do{o=this.planets[t(Math.random()*this.data.x)][t(Math.random()*this.data.y)][t(Math.random()*this.data.z)]}while(o===r);o.setAttribute("id","destination");let n=document.createElement("a-entity");n.setAttribute("moon",""),this.el.appendChild(n);let a=document.createElement("a-sky");a.setAttribute("color","black"),a.setAttribute("radius","7000"),this.el.appendChild(a)}}),AFRAME.registerComponent("click-everywhere",{tick:function(){let t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[],e=!1;for(let i=0;i<t.length&&!e;i++){if(null===t[i])continue;let s=t[i].buttons;for(let t=0;t<s.length&&!e;t++)s[t].pressed&&(this.el.emit("gp-down"),this.el.emit("gp-up"),e=!0)}}})</script><style>#begin,html{font-family:Courier New,Courier,Lucida Sans Typewriter,Lucida Typewriter,monospace}#intro{width:50%;margin:0 auto}#begin{background-color:#2300a5;border:none;color:#fff;padding:15px 32px;display:inline-block;font-size:16px;margin:4px 2px;cursor:pointer;width:100%}</style><div id=intro><h1>Wandering Moon</h1>As a meteor shower pelted your planet you were flung away, landing among distant and unfamiliar orbits. Now, you must struggle to navigate this strange realm in hopes of eventually returning home.<h2>Instructions</h2>Gaze at one of the faint white orbits to highlight it. Clicking while an orbit is highlighted will launch you into that orbit.<br><br><strong>VR headsets</strong> - Press any button to click.<br><strong>Desktop</strong> - Use the mouse to click. Click and drag to rotate your view.<br><strong>Mobile without headset</strong> - Rotate phone to rotate view. Tap the screen to click.<br><br>Map size:<br><input id=small name=size type=radio value=small checked><label for=small>Small</label><input id=medium name=size type=radio value=medium><label for=medium>Medium</label><input id=large name=size type=radio value=other><label for=large>Large</label><br><br><button id=begin>Begin your journey</button></div><script>vr=!1,window.onload=()=>{document.querySelector("#begin").addEventListener("click",(()=>{let e="";document.querySelector("#small").checked?e="":document.querySelector("#medium").checked?e={x:6,y:6,z:6}:document.querySelector("#large").checked&&(e={x:7,y:7,z:7});let t=document.createElement("a-scene");t.setAttribute("galaxy",e),t.addEventListener("enter-vr",(()=>{vr=!0})),t.addEventListener("exit-vr",(()=>{vr=!1}));let r=document.querySelector("#intro"),n=r.parentElement;r.setAttribute("style","display:none;"),n.appendChild(t)}))}</script>