<!doctype html><title>Tower of Terror - js13kGames 2025</title><style>body,html{background:#000;overflow:hidden;margin:0;height:100%}#container{display:flex;align-items:center;height:100%}#svg{background:linear-gradient(to bottom,#010212 0,#020421 100%)}</style><body><svg id=svg width=100% height=100% preserveAspectRatio="xMidYMid meet"><defs><radialGradient id=portalGradient><stop offset=40% stop-color=lightblue /><stop offset=100% stop-color=blue /></radialGradient><circle id=portal cx=0 cy=0 r=18 fill="url('#portalGradient')"></circle><g id=goodluck><circle cx=0 cy=0 r=18 fill=green></circle><circle cx=0 cy=-8 r=7 fill=none stroke=white stroke-width=6></circle><circle cx=0 cy=7 r=8 fill=none stroke=white stroke-width=6></circle></g><g id=badluck><circle cx=0 cy=0 r=18 fill=red></circle><line x1=-8 y1=-15 x2=-8 y2=15 stroke=orange stroke-width=6 /><path d="M 0 -15 A 8 5 0 1 1 0 0" fill=none stroke=orange stroke-width=6 /><path d="M 0 0 A 8 5 0 1 1 0 15" fill=none stroke=orange stroke-width=6 /></g><g id=horseshoe><circle cx=0 cy=0 r=18 fill=darkgray></circle><path d="M -10 0 A 10 10 0 1 0 10 0" fill=none stroke=gray stroke-width=10 /><line x1=-10 y1=1 x2=-9 y2=-15 stroke=gray stroke-width=10></line><line x1=10 y1=1 x2=9 y2=-15 stroke=gray stroke-width=10></line></g><g id=head1><circle cx=0 cy=0 r=18 fill=#d6b45c></circle><path d="M -18 0 A 8 8 0 1 1 18 0" fill=none stroke=#381e06 stroke-width=6 /><circle cx=-8 cy=-2 r=2 fill=#4d4020></circle><circle cx=8 cy=-2 r=2 fill=#4d4020></circle><line x1=-4 y1=8 x2=4 y2=8 stroke=#965518 stroke-width=4></line></g><line id=head2hair x1=0 y1=0 x2=2 y2=-10 stroke=#381e06 stroke-width=5></line><g id=head2><circle cx=0 cy=0 r=18 fill=#d6b45c></circle><path d="M -17 0 A 8 8 0 1 1 17 0" fill=none stroke=#381e06 stroke-width=6 /><circle cx=-7 cy=-2 r=3 fill=#4d4020></circle><circle cx=7 cy=-2 r=3 fill=#4d4020></circle><line x1=0 y1=13 x2=0 y2=5 stroke=#965518 stroke-width=8></line><use href=#head3hair x=-14 y=-7></use><use href=#head3hair x=-5 y=-14></use><use href=#head3hair x=5 y=-14></use><use href=#head3hair x=14 y=-7></use></g><line id=head3hair x1=0 y1=0 x2=1 y2=-7 stroke=#381e06 stroke-width=5></line><g id=head3><circle cx=0 cy=0 r=18 fill=#d6b45c></circle><path d="M -16 0 A 8 8 0 1 1 16 0" fill=none stroke=#381e06 stroke-width=6 /><circle cx=-7 cy=-2 r=3 fill=#4d4020></circle><circle cx=7 cy=-2 r=3 fill=#4d4020></circle><line x1=0 y1=14 x2=0 y2=4 stroke=#965518 stroke-width=8></line><use href=#head2hair x=-14 y=-7></use><use href=#head2hair x=-5 y=-14></use><use href=#head2hair x=5 y=-14></use><use href=#head2hair x=14 y=-7></use></g><line id=head4hair x1=0 y1=0 x2=3 y2=-15 stroke=#381e06 stroke-width=5></line><g id=head4><circle cx=0 cy=0 r=18 fill=#d6b45c></circle><path d="M -15 0 A 8 8 0 1 1 15 0" fill=none stroke=#381e06 stroke-width=6 /><circle cx=-7 cy=-2 r=4 fill=#4d4020></circle><circle cx=7 cy=-2 r=4 fill=#4d4020></circle><line x1=0 y1=15 x2=0 y2=3 stroke=#965518 stroke-width=8></line><use href=#head4hair x=-14 y=-7></use><use href=#head4hair x=-5 y=-14></use><use href=#head4hair x=5 y=-14></use><use href=#head4hair x=14 y=-7></use></g><g id=cat><circle cx=0 cy=3 r=13 fill=#313331 stroke=black></circle><polygon points="-15,-10 -10,-18 -5,-13 0,-13 5,-13 10,-18 15,-10 0,15" fill=#313331 stroke=black /><polygon points="-8,-3 -2,-3 -6,-6" fill=red /><polygon points="-5,-3 -3,-3 -5,-4" fill=yellow /><polygon points="8,-3 2,-3 6,-6" fill=red /><polygon points="5,-3 3,-3 5,-4" fill=yellow /><polygon points="-5,0 5,0 0,5" fill=red stroke=black /></g></defs></svg><script>function svgRect(e,t,l,a,s){let o=document.createElementNS("http://www.w3.org/2000/svg","rect");return o.setAttribute("x",e),o.setAttribute("y",t),o.setAttribute("width",l),o.setAttribute("height",a),o.setAttribute("fill",s),o}function svgLine(e,t,l,a,s,o=1){let i=document.createElementNS("http://www.w3.org/2000/svg","line");return i.setAttribute("x1",e),i.setAttribute("y1",t),i.setAttribute("x2",l),i.setAttribute("y2",a),i.setAttribute("stroke",s),i.setAttribute("stroke-width",o),i}function svgCircle(e,t,l,a){let s=document.createElementNS("http://www.w3.org/2000/svg","circle");return s.setAttribute("cx",e),s.setAttribute("cy",t),s.setAttribute("r",l),s.setAttribute("fill",a),s}function svgText(e,t,l,a="black",s="Arial",o=20){let i=document.createElementNS("http://www.w3.org/2000/svg","text");return i.setAttribute("x",t),i.setAttribute("y",l),i.setAttribute("fill",a),i.setAttribute("font-family",s),i.setAttribute("font-size",o),i.textContent=e,i}function svgPath(e,t){let l=document.createElementNS("http://www.w3.org/2000/svg","path");return l.setAttribute("d",e),l.setAttribute("fill",t),l}function svgUse(e,t,l,a=1){let s=document.createElementNS("http://www.w3.org/2000/svg","use");return s.setAttributeNS("http://www.w3.org/1999/xlink","href",`#${e}`),s.setAttribute("transform",`translate(${t} ${l}) scale(${a})`),s}function svgGroup(){return document.createElementNS("http://www.w3.org/2000/svg","g")}function svgCat(e,t){return svgUse("cat",e,t)}function svgPortal(e,t){return svgUse("portal",e,t)}function svgBadLuck(e,t){return svgUse("badluck",e,t)}function svgGoodLuck(e,t){return svgUse("goodluck",e,t)}function svgHorseshoe(e,t){return svgUse("horseshoe",e,t)}function svgTower(e,t,l,a=1){let s=svgGroup(),o=svgCircle(e+80,e+100,80,"red");s.appendChild(o);let i=`M ${_t[0][0]} 0 `;i+=`L ${_t[0][1]} 0 `;for(let e=0;e<19;e++)i+=`L ${_t[e][1]} ${30*(e+1)} `,i+=`L ${_t[e+1][1]} ${30*(e+1)} `;i+=`L ${_t[19][0]} 570 `;for(let e=19;e>0;e--)i+=`L ${_t[e][0]} ${30*e} `,i+=`L ${_t[e-1][0]} ${30*e} `;i+="Z";let r=svgPath(i,"#080001"),d=svgPath(i,"none");d.setAttribute("stroke","#B50405"),d.setAttribute("stroke-width","2");let n=svgGroup();return n.appendChild(r),null!=l&&n.appendChild(svgRect(_t[l][0],30*l,_t[l][1]-_t[l][0],30,"yellow")),n.appendChild(d),n.setAttribute("transform",`translate(${e-60} ${t+19})`),s.appendChild(n),s.setAttribute("opacity",a),s}let synth,badLuckSound,goodLuckSound,portalSound,levelWonSound,levelLostSound,escapedSound,songBuffer,songNode,menu,_t=[[40,130],[40,140],[40,140],[45,135],[40,140],[45,145],[40,140],[40,140],[40,140],[45,145],[45,145],[40,150],[35,150],[30,155],[30,155],[25,155],[20,160],[15,165],[10,170],[5,175]],pl_synth_init=e=>{let t=4096,l=4095,a=new Float32Array(16384),s=3639956645,o=(e,o,i,r,d=0,n=0,v=0,c=0,h=0,u=0,p=0,g=0,m=0,f=0,w=0,y=0,b=0,L=0,C=0,_=0,k=0,A=0,S=0,x=0,T=0,z=0,$=0,G=0,M=0,E=0,O=0,Y=0,X=0,N=0)=>{let D=1/255,j=N*t,P=p*t,V=b*t,U=Math.pow(2,G-8)/e,B=M/512,W=X/512,F=Math.pow(2,Y-8)/e*t,R=0,I=0,K=T*D,H=4.6566e-10*L,q=0,Z=0,J=0,Q=1/C,ee=1/k,te=.00390625*Math.pow(1.059463094,o+12*(n-8)+v-128)*(1+8e-4*c),le=.00390625*Math.pow(1.059463094,o+12*(g-8)+m-128)*(1+8e-4*f);for(let e=C+_+k-1;e>=0;--e){let o,n=e+d,v=a[j+(n*F&l)]*W+.5,c=0,p=x,g=1;e<C?g=e*Q:e>=C+_&&(g-=(e-C-_)*ee),o=te,E&&(o*=v),h&&(o*=g*g),R+=o,c+=a[P+(R*t&l)]*u,o=le,w&&(o*=g*g),I+=o,c+=a[V+(I*t&l)]*y,L&&(s^=s<<13,s^=s>>17,s^=s<<5,c+=s*H*g),c*=g*D,S&&(O&&(p*=v),p=1.5*a[.046439909297052155*p&l],q+=p*Z,J=K*(c-Z)-q,Z+=p*J,c=[c,J,q,Z,q+J][S]),o=a[n*U*t&l]*B+.5,c*=.00238*A,i[n]+=c*(1-o),r[n]+=c*o}},i=e=>{for(let t=0;t<e.length;t++)e[t]=Array.isArray(e[t])?i(e[t]):e[t]??0;return e},r=(e,t)=>{let l=e[20]*t>>1,a=e[21]/255,s=Math.ceil(Math.log(.1)/Math.log(a));return e[13]+e[14]+e[15]+s*l},d=(e,t,l,a,s)=>{if(!s[21])return;let o=s[20]*a>>1,i=s[21]/255,r=e.length-o;for(let a=l,s=l+o;a<r;a++,s++)e[s]+=t[a]*i,t[s]+=e[a]*i};for(let e=0;e<t;e++)a[e]=Math.sin(6.283184*e/t),a[e+t]=a[e]<0?-1:1,a[e+8192]=e/t-.5,a[e+12288]=e<2048?e/1024-1:3-e/1024;return{sound:(t,l=147,a=5513)=>{t=i(t);let s=r(t,a),n=e.createBuffer(2,s,44100),v=n.getChannelData(0),c=n.getChannelData(1);return o(a,l,v,c,0,...t),d(v,c,0,a,t),n},song:t=>{let l=(t=i(t))[0],a=t[1],s=0;for(let e of a){let t=e[1].length*l*32+r(e[0],l);t>s&&(s=t)}let n=e.createBuffer(2,s,44100),v=n.getChannelData(0),c=n.getChannelData(1),h=new Float32Array(s),u=new Float32Array(s);for(let e of a){let t=e[0],a=e[1],i=0,r=s;h.fill(0),u.fill(0);for(let s of a)for(let a=0;a<32;a++){let d=e[2][s-1]?.[a];d&&(r=Math.min(r,i),o(l,d,h,u,i,...t)),i+=l}d(h,u,r,l,t);for(let e=r;e<s;e++)v[e]+=h[e],c[e]+=u[e]}return n}}},audioContext=new AudioContext;function initSound(){synth=pl_synth_init(audioContext),badLuckSound=synth.sound([7,3,140,1,232,3,8,,9,1,139,3,,4611,1403,34215,256,4,1316,255,,,,1,,1,7,255]),goodLuckSound=synth.sound([7,3,140,1,232,3,8,,9,1,139,3,,4611,1403,34215,256,4,1316,255,,,,1,,1,7,255]),portalSound=synth.sound([7,3,140,1,232,3,8,,9,1,139,3,,4611,1403,34215,256,4,1316,255,,,,1,,1,7,255]),levelWonSound=synth.sound([7,3,140,1,232,3,8,,9,1,139,3,,4611,1403,34215,256,4,1316,255,,,,1,,1,7,255]),levelLostSound=synth.sound([7,3,140,1,232,3,8,,9,1,139,3,,4611,1403,34215,256,4,1316,255,,,,1,,1,7,255]),escapedSound=synth.sound([7,3,140,1,232,3,8,,9,1,139,3,,4611,1403,34215,256,4,1316,255,,,,1,,1,7,255]),songBuffer=synth.song([5513,[[[7,0,0,0,255,2,8,0,18,0,255,2,0,1e5,56363,1e5,199,2,200,254,8,24],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[[139,0,0,0,0,0,0,0,140,0,0,0,0,0,0,0,142,0,0,0,0,0,0,0,144]]],[[7,0,0,0,255,2,8,0,18,0,255,2,0,1e5,56363,1e5,199,2,200,254,8,24],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[[149]]],[[7,0,0,1,255,0,7,0,0,1,255,0,0,50,150,4800,200,2,600,254],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[[144,144,144,144,144,0,144,0,144,144,144,144,144,0,144,0,144,0,144,0,144,0,144,0,144,144,144,144,144,0,144]]]]])}function play(e,t=!1){if(e){let l=audioContext.createBufferSource();return l.buffer=e,l.loop=t,l.connect(audioContext.destination),l.start(),l}}function displayMenu(){menu=svgGroup(),menu.appendChild(svgTower(0,0)),menu.appendChild(svgText("TOWER OF TERROR",200,100,"red","Arial",60)),menu.appendChild(svgGoodLuck(300,195)),menu.appendChild(svgText("the lucky number is on your side",330,200,"red")),menu.appendChild(svgBadLuck(330,235)),menu.appendChild(svgText("the unlucky number is not",360,240,"red")),menu.appendChild(svgPortal(250,275)),menu.appendChild(svgText("the portals... you never know where you will end up",280,280,"red")),menu.appendChild(svgCat(120,315)),menu.appendChild(svgText("the black cats... your biggest fear... the horror makes you sweat and clouds your vision",150,320,"red")),menu.appendChild(svgHorseshoe(320,355)),menu.appendChild(svgText("the horseshoe is your way out",350,360,"red")),menu.appendChild(svgText("don't get stuck in the maze... and make sure your heart can take the horror of the black cats...",130,460,"red")),menu.appendChild(svgText("click to escape the tower... and the terror!",300,500,"red")),menu.appendChild(svgText("uses pl_synth (https://github.com/phoboslab/pl_synth) for audio",-150,590,"blue")),svg.setAttribute("viewBox","0 0 800 600"),svg.appendChild(menu),svg.addEventListener("click",_startGame)}function _startGame(e){svg.removeEventListener("click",_startGame),svg.removeChild(menu),menu=void 0,lives=0,startLevel(0),gameState=GSPLAYING,songNode||(songNode=play(songBuffer,!0))}function noOfLevel(){return _levels.length}function generateLevel(e){let t=_levels[e];_level={g:svgGroup(),game:svgGroup(),maze:svgGroup(),index:e,width:t.width,height:t.height,portals:[],badLucks:[],goodLucks:[],cats:[]},_level.maze.appendChild(svgRect(0,0,t.width*side,t.height*side,"#36332d")),_level.game.appendChild(_level.maze),_level.g.appendChild(_level.game);let l=_generateMaze();for(let e=0;e<t.height;e++)for(let a=0;a<t.width;a++)_level[c(a,e)]=_generateCell(a,e,_level.maze,l);_occupiedCells=[],_level.avatar=_addObject(()=>svgUse("head1",0,0),t.width,t.height),_level.avatar.head1=_level.avatar.element,_level.avatar.head2=svgUse("head2",0,0),_level.game.appendChild(_level.avatar.head2),_level.avatar.head2.style.display="none",_level.avatar.head3=svgUse("head3",0,0),_level.game.appendChild(_level.avatar.head3),_level.avatar.head3.style.display="none",_level.avatar.head4=svgUse("head4",0,0),_level.game.appendChild(_level.avatar.head4),_level.avatar.head4.style.display="none";for(let e=0;e<t.cats;e++)_level.cats.push(_addObject(svgCat,t.width,t.height));for(let e=0;e<t.portals;e++)_level.portals.push(_addObject(svgPortal,t.width,t.height));for(let e=0;e<t.badLucks;e++)_level.badLucks.push(_addObject(svgBadLuck,t.width,t.height));for(let e=0;e<t.goodLucks;e++)_level.goodLucks.push(_addObject(svgGoodLuck,t.width,t.height));_level.horseshoe=_addObject(svgHorseshoe,t.width,t.height),_level.floor=svgRect(0,0,100,50,"yellow"),_level.tower=svgTower(0,0,e,.5),_level.g.appendChild(_level.tower),_level.lives=svgGroup();for(let e=0;e<lives;e++)_level.lives.appendChild(svgUse("head1",-100,50*e));return _level.lives.setAttribute("opacity",.5),_level.g.appendChild(_level.lives),_level}function catAt(e,t){return _objectAt(e,t,_level.cats)}function portalAt(e,t){return _objectAt(e,t,_level.portals)}function goodLuckAt(e,t){return _objectAt(e,t,_level.goodLucks)}function badLuckAt(e,t){return _objectAt(e,t,_level.badLucks)}function consumeObjectAt(e,t,l,a){let s=_objectAt(e,t,l);return s&&(a(l.filter(e=>e!=s)),_level.game.removeChild(s.element)),s}function getFreeCell(){let e,t;for(freeCellFound=!1;!freeCellFound;)if(e=Math.floor(Math.random()*_level.width),t=Math.floor(Math.random()*_level.height),!_occupiedCells.find(l=>l.x==e&&l.y==t))return{x:e,y:t}}function _objectAt(e,t,l){return l.find(l=>l.cellX==e&&l.cellY==t)}let _levels=[{width:10,height:10,cats:5,portals:8,badLucks:8,goodLucks:8},{width:10,height:10,cats:5,portals:8,badLucks:8,goodLucks:8},{width:12,height:12,cats:5,portals:8,badLucks:8,goodLucks:8},{width:12,height:12,cats:5,portals:8,badLucks:8,goodLucks:8},{width:14,height:14,cats:7,portals:8,badLucks:8,goodLucks:8},{width:14,height:14,cats:7,portals:8,badLucks:8,goodLucks:8},{width:16,height:8,cats:8,portals:8,badLucks:8,goodLucks:10},{width:16,height:8,cats:8,portals:8,badLucks:8,goodLucks:10},{width:8,height:20,cats:12,portals:10,badLucks:12,goodLucks:10},{width:8,height:20,cats:12,portals:10,badLucks:12,goodLucks:10},{width:15,height:15,cats:12,portals:10,badLucks:12,goodLucks:10},{width:15,height:15,cats:12,portals:10,badLucks:12,goodLucks:10},{width:15,height:15,cats:15,portals:10,badLucks:14,goodLucks:10},{width:15,height:15,cats:15,portals:10,badLucks:14,goodLucks:10},{width:17,height:17,cats:17,portals:10,badLucks:18,goodLucks:12},{width:17,height:17,cats:17,portals:10,badLucks:18,goodLucks:12},{width:18,height:18,cats:20,portals:12,badLucks:22,goodLucks:12},{width:18,height:18,cats:20,portals:12,badLucks:22,goodLucks:12},{width:20,height:20,cats:25,portals:15,badLucks:25,goodLucks:15},{width:20,height:20,cats:25,portals:15,badLucks:25,goodLucks:15}];function _generateCell(e,t,l,a){let s={x:e,y:t};return _openingExists(e,t,e+1,t,a)||(s.r=svgLine((e+1)*side,t*side,(e+1)*side,(t+1)*side,wallColor,wallThickness),l.appendChild(s.r)),_openingExists(e,t,e,t+1,a)||(s.b=svgLine(e*side,(t+1)*side,(e+1)*side,(t+1)*side,wallColor,wallThickness),l.appendChild(s.b)),_openingExists(e,t,e-1,t,a)||(s.l=svgLine(e*side,t*side,e*side,(t+1)*side,wallColor,wallThickness),l.appendChild(s.l)),_openingExists(e,t,e,t-1,a)||(s.t=svgLine(e*side,t*side,(e+1)*side,t*side,wallColor,wallThickness),l.appendChild(s.t)),s}function _generateMaze(){const e=[],t=new Set,l=new Set;let a=Math.floor(Math.random()*_level.width),s=Math.floor(Math.random()*_level.height);for(l.add(_s2(a,s));;){const o=[];if(a>0&&!l.has(_s2(a-1,s))&&o.push([a-1,s]),a<_level.width-1&&!l.has(_s2(a+1,s))&&o.push([a+1,s]),s>0&&!l.has(_s2(a,s-1))&&o.push([a,s-1]),s<_level.height-1&&!l.has(_s2(a,s+1))&&o.push([a,s+1]),o.length>0){const[i,r]=o[Math.floor(Math.random()*o.length)];t.add(_s4(a,s,i,r)),l.add(_s2(i,r)),e.push([a,s]),a=i,s=r}else{if(!(e.length>0))break;[a,s]=e.pop()}}return t}function _openingExists(e,t,l,a,s){return s.has(_s4(e,t,l,a))||s.has(_s4(l,a,e,t))}function _addObject(e){let t=getFreeCell();_occupiedCells.push({x:t.x,y:t.y});let l=side*(t.x+.5),a=side*(t.y+.5),s=e(l,a);return _level.game.appendChild(s),{cellX:t.x,cellY:t.y,displayX:l,displayY:a,element:s}}function _s2(e,t){return`${e},${t}`}function _s4(e,t,l,a){return`${e},${t},${l},${a}`}let _level,_occupiedCells=[],left=!1,right=!1,up=!1,down=!1;document.addEventListener("keydown",e=>{"ArrowLeft"!=e.code&&"KeyA"!=e.code||(left=!0),"ArrowRight"!=e.code&&"KeyD"!=e.code||(right=!0),"ArrowUp"!=e.code&&"KeyW"!=e.code||(up=!0),"ArrowDown"!=e.code&&"KeyS"!=e.code||(down=!0)},!1),document.addEventListener("keyup",e=>{"ArrowLeft"!=e.code&&"KeyA"!=e.code||(left=!1),"ArrowRight"!=e.code&&"KeyD"!=e.code||(right=!1),"ArrowUp"!=e.code&&"KeyW"!=e.code||(up=!1),"ArrowDown"!=e.code&&"KeyS"!=e.code||(down=!1)},!1);let targetDir,popupText,w=1500,h=1500,svg=document.getElementById("svg"),zoom=0,zoomTarget=0,visibleCells=[],visibleCellsSvg=[],wallThickness=30,wallColor="#1a1815",heartAttack=0;function winnable(){let e=[],t=new Set;for(e.push([level.avatar.cellX,level.avatar.cellY]),t.add(`${level.avatar.cellX},${level.avatar.cellY}`);e.length>0;){let[l,a]=e.pop();if(l==level.horseshoe.cellX&&a==level.horseshoe.cellY||portalAt(l,a)||goodLuckAt(l,a))return!0;let s=level[c(l,a)];s.r||t.has(`${l+1},${a}`)||(t.add(`${l+1},${a}`),e.push([l+1,a])),s.b||t.has(`${l},${a+1}`)||(t.add(`${l},${a+1}`),e.push([l,a+1])),s.l||t.has(`${l-1},${a}`)||(t.add(`${l-1},${a}`),e.push([l-1,a])),s.t||t.has(`${l},${a-1}`)||(t.add(`${l},${a-1}`),e.push([l,a-1]))}return!1}function startLevel(e){level=generateLevel(e),svg.appendChild(level.g),zoom=0,zoomTarget=0,level.floor.setAttribute("transform",`translate(0 ${50*e})`)}function c(e,t){return`x${e}y${t}`}function visibleFrom(e,t){let l=new Set;for(var a=0;!level[c(e+a,t)].r;)l.add({x:e+a+1,y:t}),a++;for(a=0;!level[c(e-a,t)].l;)l.add({x:e-a-1,y:t}),a++;for(a=0;!level[c(e,t+a)].b;)l.add({x:e,y:t+a+1}),a++;for(a=0;!level[c(e,t-a)].t;)l.add({x:e,y:t-a-1}),a++;return l}function noOfVisibleOpponents(){let e=0;for(let t of level.cats)for(let l of visibleCells)t.cellX==l.x&&t.cellY==l.y&&e++;return e}function updateVisibleCells(){visibleCells=visibleFrom(level.avatar.cellX,level.avatar.cellY)}function consumeObjectAtAvatarPosition(e,t){return consumeObjectAt(level.avatar.cellX,level.avatar.cellY,e,t)}function checkCollision(){if(consumeObjectAtAvatarPosition(level.portals,e=>level.portals=e)){play(portalSound);var{x:e,y:t}=getFreeCell();level.avatar.cellX=e,level.avatar.cellY=t,left=!1,right=!1,up=!1,down=!1,winnable()||_endMaze(GSLEVELLOST)}if(consumeObjectAtAvatarPosition(level.goodLucks,e=>level.goodLucks=e)){play(goodLuckSound);for(let l=0;l<5;l++){e=Math.floor(Math.random()*(level.width-2))+1,t=Math.floor(Math.random()*(level.height-2))+1;let l=level[c(e,t)];if(l.r){level.maze.removeChild(l.r),l.r=void 0;let a=level[c(e+1,t)];level.maze.removeChild(a.l),a.l=void 0}if(l.b){level.maze.removeChild(l.b),l.b=void 0;let a=level[c(e,t+1)];level.maze.removeChild(a.t),a.t=void 0}if(l.l){level.maze.removeChild(l.l),l.l=void 0;let a=level[c(e-1,t)];level.maze.removeChild(a.r),a.r=void 0}if(l.t){level.maze.removeChild(l.t),l.t=void 0;let a=level[c(e,t-1)];level.maze.removeChild(a.b),a.b=void 0}}winnable()||_endMaze(GSLEVELLOST)}if(consumeObjectAtAvatarPosition(level.badLucks,e=>level.badLucks=e)){play(badLuckSound);for(let l=0;l<5;l++){var e=Math.floor(Math.random()*(level.width-2))+1,t=Math.floor(Math.random()*(level.height-2))+1;let l=level[c(e,t)];if(l.r)if(l.b)if(l.l){if(!l.t){l.t=svgLine(e*side,t*side,(e+1)*side,t*side,wallColor,wallThickness),level.maze.appendChild(l.t);let a=level[c(e,t-1)];a.b=svgLine(e*side,t*side,(e+1)*side,t*side,wallColor,wallThickness),level.maze.appendChild(a.b)}}else{l.l=svgLine(e*side,t*side,e*side,(t+1)*side,wallColor,wallThickness),level.maze.appendChild(l.l);let a=level[c(e-1,t)];a.r=svgLine(e*side,t*side,e*side,(t+1)*side,wallColor,wallThickness),level.maze.appendChild(a.r)}else{l.b=svgLine(e*side,(t+1)*side,(e+1)*side,(t+1)*side,wallColor,wallThickness),level.maze.appendChild(l.b);let a=level[c(e,t+1)];a.t=svgLine(e*side,(t+1)*side,(e+1)*side,(t+1)*side,wallColor,wallThickness),level.maze.appendChild(a.t)}else{l.r=svgLine((e+1)*side,t*side,(e+1)*side,(t+1)*side,wallColor,wallThickness),level.maze.appendChild(l.r);let a=level[c(e+1,t)];a.l=svgLine((e+1)*side,t*side,(e+1)*side,(t+1)*side,wallColor,wallThickness),level.maze.appendChild(a.l)}}winnable()||_endMaze(GSLEVELLOST)}level.horseshoe.cellX==level.avatar.cellX&&level.horseshoe.cellY==level.avatar.cellY&&(level.index==_levels.length-1?(play(escapedSound),_endGame()):_endMaze(GSLEVELWON))}function _endMaze(e){let t;if(e==GSLEVELWON)play(levelWonSound),lives++,t=`one maze closer to freedom... you now have ${lives} ${1==lives?"life":"lives"}`;else{if(lives<1)t="you failed...",e=GSGAMELOST;else{lives--;let e=1==lives?"you have 1 life left":`you have ${lives} lives left`;0==lives&&(e=""),t=`${heartAttack>100?"your heart collapsed from the stress":"you got stuck in the maze"}... but you get another attempt... ${e}`}play(levelLostSound)}zoomTarget=0,gameState=e,popupText=svgText(t,0,0,"white"),svg.appendChild(popupText)}function _endGame(){zoomTarget=0,gameState=GSGAMEWON,popupText=svgText("you have escaped!",0,0,"white"),svg.appendChild(popupText)}function updateView(e){if(gameState!=GSMENU){if(gameState==GSGAMEWON&&mazeOpacity>0&&(mazeOpacity-=5e-4*e,mazeOpacity<0&&(mazeOpacity=0,svg.appendChild(svgText("finally, the night's torment is over",x-150,y-100,"white")),svg.appendChild(svgText("no more mazes...",x-90,y-40,"white")),svg.appendChild(svgText("no more 13s...",x-75,y,"white")),svg.appendChild(svgText("AND NO MORE BLACK CATS!",x-145,y+60,"white"))),level.game.setAttribute("opacity",`${mazeOpacity}`)),gameState==GSPLAYING){if(!targetDir){let e=level[c(level.avatar.cellX,level.avatar.cellY)];right&&!e.r?targetDir={x:1,y:0}:down&&!e.b?targetDir={x:0,y:1}:left&&!e.l?targetDir={x:-1,y:0}:up&&!e.t&&(targetDir={x:0,y:-1})}targetDir?1==targetDir.x?(x+=.5*e,x>=side*(level.avatar.cellX+1.5)&&(x=side*(level.avatar.cellX+1.5),level.avatar.cellX++,checkCollision(),updateVisibleCells(),targetDir=void 0)):1==targetDir.y?(y+=.5*e,y>=side*(level.avatar.cellY+1.5)&&(y=side*(level.avatar.cellY+1.5),level.avatar.cellY++,checkCollision(),updateVisibleCells(),targetDir=void 0)):-1==targetDir.x?(x-=.5*e,x<=side*(level.avatar.cellX-.5)&&(x=side*(level.avatar.cellX-.5),level.avatar.cellX--,checkCollision(),updateVisibleCells(),targetDir=void 0)):-1==targetDir.y&&(y-=.5*e,y<=side*(level.avatar.cellY-.5)&&(y=side*(level.avatar.cellY-.5),level.avatar.cellY--,checkCollision(),updateVisibleCells(),targetDir=void 0)):(x=side*(level.avatar.cellX+.5),y=side*(level.avatar.cellY+.5));for(let t=0;t<level.cats.length;t++){let l=level.cats[t];if(!l.dir){let e=level[c(l.cellX,l.cellY)],t=Math.floor(4*Math.random());0!=t||e.r?1!=t||e.b?2!=t||e.l?3!=t||e.t||(l.dir={x:0,y:-1}):l.dir={x:-1,y:0}:l.dir={x:0,y:1}:l.dir={x:1,y:0}}l.dir?1==l.dir.x?(l.displayX+=.5*e,l.displayX>=side*(l.cellX+1.5)&&(l.displayX=side*(l.cellX+1.5),l.cellX++,level[c(l.cellX,l.cellY)].r&&(l.dir=void 0))):1==l.dir.y?(l.displayY+=.5*e,l.displayY>=side*(l.cellY+1.5)&&(l.displayY=side*(l.cellY+1.5),l.cellY++,level[c(l.cellX,l.cellY)].b&&(l.dir=void 0))):-1==l.dir.x?(l.displayX-=.5*e,l.displayX<=side*(l.cellX-.5)&&(l.displayX=side*(l.cellX-.5),l.cellX--,level[c(l.cellX,l.cellY)].l&&(l.dir=void 0))):-1==l.dir.y&&(l.displayY-=.5*e,l.displayY<=side*(l.cellY-.5)&&(l.displayY=side*(l.cellY-.5),l.cellY--,level[c(l.cellX,l.cellY)].t&&(l.dir=void 0))):(l.displayX=side*(l.cellX+.5),l.displayY=side*(l.cellY+.5))}}if(zoom>zoomTarget&&(zoom-=.1*e),zoom<zoomTarget&&(zoom+=.1*e),gameState==GSPLAYING){let e=noOfVisibleOpponents();0==e?zoomTarget-=5:zoomTarget+=20*e}if(zoomTarget<0&&(zoomTarget=0),zoomTarget>700&&(zoomTarget=700),level.avatar.head1.setAttribute("transform",`translate(${x} ${y}) scale(1, 1)`),level.avatar.head1.style.display=zoom<10&&gameState==GSPLAYING?"":"none",level.avatar.head2.setAttribute("transform",`translate(${x} ${y}) scale(1.2, 1.2)`),level.avatar.head2.style.display=zoom>=10&&zoom<200&&gameState==GSPLAYING?"":"none",level.avatar.head3.setAttribute("transform",`translate(${x} ${y}) scale(1.4, 1.4)`),level.avatar.head3.style.display=zoom>=200&&zoom<500&&gameState==GSPLAYING?"":"none",level.avatar.head4.setAttribute("transform",`translate(${x} ${y}) scale(1.6, 1.6)`),level.avatar.head4.style.display=zoom>500&&gameState==GSPLAYING?"":"none",""==level.avatar.head4.style.display){if(heartAttack+=.03*e,heartAttack>100)_endMaze(GSLEVELLOST);else if(Math.floor(100*Math.random())<heartAttack){let e=svgRect(0,0,w,h,"red");e.setAttribute("opacity","0.5"),svg.appendChild(e),setTimeout(()=>{svg.removeChild(e)},50)}}else heartAttack-=.2*e,heartAttack<0&&(heartAttack=0);level.tower.setAttribute("transform",`translate(${x+300} ${y-780}) scale(2.5)`),popupText&&(popupText.setAttribute("x",x-100),popupText.setAttribute("y",y-200));for(let e=0;e<level.cats.length;e++){let t=level.cats[e];t.element.setAttribute("transform",`translate(${t.displayX} ${t.displayY}) scale(2)`)}svg.setAttribute("viewBox",`${x+zoom-750} ${y+zoom-750} ${w-zoom-zoom} ${h-zoom-zoom}`),popupText&&gameState!=GSGAMEWON&&zoom<10&&!timeOutSet&&(timeOutSet=!0,setTimeout(()=>{svg.removeChild(popupText),svg.removeChild(level.g),popupText=void 0,gameState==GSGAMELOST?(gameState=GSMENU,displayMenu()):(startLevel(gameState==GSLEVELWON?level.index+1:level.index),gameState=GSPLAYING),timeOutSet=!1},1500))}}let level,timeOutSet=!1,mazeOpacity=1,side=80;const GSMENU=0,GSPLAYING=1,GSLEVELWON=2,GSLEVELLOST=3,GSGAMEWON=4,GSGAMELOST=5;let lives=0,gameState=GSMENU,waitScreen=svgGroup();waitScreen.appendChild(svgText("...please wait... preparing the tower...",250,200,"red")),svg.setAttribute("viewBox","0 0 800 600"),svg.appendChild(waitScreen);var lastTime=Date.now();let gameLoop=()=>{let e=Date.now();updateView(e-lastTime),requestAnimationFrame(gameLoop),lastTime=e};setTimeout(()=>{initSound(),svg.removeChild(waitScreen),displayMenu(),gameLoop()},100)</script>