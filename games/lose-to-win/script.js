function drawCell(e,t,a){ctx.fillStyle=cells[t+a*width].color,drawText(cells[t+a*width].height,cells[t+a*width].line,cells[t+a*width].txt,cellSize*t+cellSize/2,cellSize*(a+1)+cells[t+a*width].shift)}function drawMap(e){if(ctx.clearRect(0,0,canvas.width,canvas.height),mapImage)return void ctx.drawImage(mapImage,0,0);for(var t=0;width>t;t++)for(var a=0;height>a;a++)drawCell(e,t,a);mapImage=new Image,mapImage.src=canvas.toDataURL("image/png")}function hpToColor(e){return e.hp>.6*e.maxhp?"#228B22":e.hp>.3*e.maxhp?"#DAA520":"red"}function redrawPlayerInfo(){if(elm("player_xp").innerHTML="xp to prev level:<br>"+xpToNextLevel,elm("playerLevel").innerHTML=player.name+" level "+player.level,elm("playerImage").style.color=player.color,elm("playerImage").innerHTML=player.string,elm("player_hp").style.color=hpToColor(player),elm("player_hp").innerHTML=player.hp+"/"+player.maxhp,elm("player_armor").innerHTML="Armor: "+player.armor,elm("player_damage").innerHTML="Damage: "+Math.floor(player.damage*player.weapon.damage),-1!=player.target&&units[player.target]){elm("vs").innerHTML="VS",elm("target").style.opacity="1",elm("target").style.display="table-cell";var e=units[player.target];elm("targetLevel").innerHTML=e.name+" level "+e.level,elm("targetImage").style.color=e.color,elm("targetImage").innerHTML=e.string,elm("target_hp").style.color=hpToColor(e),elm("target_hp").innerHTML=e.hp+"/"+e.maxhp,elm("target_armor").innerHTML="Armor: "+e.armor,elm("target_damage").innerHTML="Damage: "+Math.floor(e.damage*e.weapon.damage)}else elm("target").style.opacity="0",elm("vs").innerHTML=" "}function redraw(e){ctx.clearRect(0,0,canvas.width,canvas.height),drawMap(e);for(var t in objects)objects[t]&&objects[t].draw();for(var t in units)units[t]&&units[t].draw();for(var t in player.spells)elm("spell"+t).innerHTML=player.spells[t].name+" ("+player.spells[t].timer+"/"+spells[t].timer+")";redrawPlayerInfo()}function drawText(e,t,a,i,r){ctx.font=e+"px Arial",ctx.textAlign="center";for(var s=a.split("\n"),l=0;l<s.length;l++)ctx.fillText(s[l],i,r+l*t+yoffset)}function elm(e){return document.getElementById(e)}function setStatus(e){document.getElementById("status").innerHTML=e}function DisplayedText(e,t,a,i,r){this.id=e,this.x=t,this.y=a,this.color=i,this.text=r,this.timer=10}function checkAchievements(){if("none"==elm("popupOverlay").style.display)for(var e in achievements)if(!achievements[e].have&&achievements[e].condition())return achievements[e].have=!0,void showInfo("<br><br><h2>New achievement!</h2><h3>"+achievements[e].name+"</h3>"+achievements[e].desc)}function showMenu(){var e="+----------------------+\n|         yes          |\n+----------------------+",t="+----------------------+\n|          no          |\n+----------------------+";showInfo("<br><h2>Are you sure you want to quit?</h2><pre onclick = \"elm('menu').style.display = 'block'; elm('game').style.display = 'none'\">"+e+'</pre><pre onclick = "hidePopup()">'+t+"</pre>")}function sqr(e){return e*e}function clone(e){var t;if(null==e||"object"!=typeof e)return e;if(e instanceof Date)return t=new Date,t.setTime(e.getTime()),t;if(e instanceof Array){t=[];for(var a=0,i=e.length;i>a;a++)t[a]=clone(e[a]);return t}if(e instanceof Object){t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=clone(e[r]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")}function shuffle(e){for(var t,a,i=e.length;i;t=Math.floor(Math.random()*i),a=e[--i],e[i]=e[t],e[t]=a);return e}function XPByLevel(e){return Math.floor(xpA*Math.exp(xpB*e))}function decreaseLowscore(e){var t=xpToNextLevel-=e;if(0>=t&&(e=xpToNextLevel),pushToTexts(new DisplayedText(0,player.drawx,player.drawy,"blue","-"+e+"xp")),player.level>0&&0>=xpToNextLevel){for(var a in objects)!objects[a]||objects[a].type!=objectTypes.ThorsHammer&&objects[a].type!=objectTypes.fireball||(objects[a]=void 0);player=new Player(0,player.x,player.y,player.level-1,unitTypes[0]),units[0]=player,playerLevel--,xpToNextLevel=XPByLevel(player.level),showInfo('<br><br><br><br><br><h2>Level ' + player.level + ' reached!</h2>')}(lowscore-=e)<worstLowscore&&(worstLowscore=lowscore),redrawPlayerInfo()}function firstEmptySlot(e){for(var t=0;t<e.length;t++)if(void 0==e[t])return t;return e.length}function pushToTexts(e){var t=firstEmptySlot(texts);e.id=t,texts[t]=e}function handleKeyPress(e){var t=String.fromCharCode(e.which||e.keyCode);t>="1"&&"8">=t&&player.castSpell(parseInt(t)-1)}function getMousePosition(e){var t=0,a=0;return e.layerX||0==e.layerX?(a=e.layerX-canvas.offsetLeft,t=e.layerY-canvas.offsetTop):(e.offsetX||0==e.offsetX)&&(a=e.offsetX,t=e.offsetY),navigator.userAgent.search(/Chrome/)>0&&(a=e.offsetX,t=e.offsetY),{x:Math.floor(a/cellSize),y:Math.floor(t/cellSize)}}function handleMouseMove(e){var t=getMousePosition(e);canvas.style.cursor=levelMap[t.y*width+t.x]==cell.empty?"pointer":"default";for(var a in units)if(units[a]&&units[a].x==t.x&&units[a].y==t.y)return void setStatus(units[a].name+" level "+units[a].level+" ("+units[a].hp+" hp, "+units[a].weapon.name+", "+units[a].armorType.name+")");for(var a in objects)if(objects[a]&&objects[a].x==t.x&&objects[a].y==t.y)return void setStatus(objects[a].type.desc);setStatus(" ")}function handleMouseClick(e){var t=getMousePosition(e);levelMap[t.y*width+t.x]==cell.empty&&(player.nexttargetx=t.x,player.nexttargety=t.y,player.status=statuses.move,player.target=-1)}function init(){canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d");var e="<table><tr>";for(var t in spells)e+='<td id = "spell'+t+'" style = "cursor: pointer;text-align: center; border: 1px solid; width: 100px; height: 90px" onclick = "player.castSpell('+t+')" onmouseover = "setStatus(spells['+t+'].desc)">'+spells[t].name+"</td>";e+="</tr></table>",elm("spells").innerHTML=e,playerLevel=maxPlayerLevel,spells=clone(etalonSpells),generateLevel(levelMap),redraw(cells),lowscore=currentMap=killed=0,xpToNextLevel=XPByLevel(maxPlayerLevel);for(var t=1;maxPlayerLevel>=t;t++)lowscore+=XPByLevel(t);gameCounter=totalKilled=castedSpells=0,game_timer=setInterval("game_cycle()",100)}function startWay(e,t,a,i,r){if(!(0>t||t>=width||0>a||a>=height||i.len>=r)&&(index=a*width+t,e[index]!=cell.empty)){e[index]=cell.empty,i.len++;var s=[{x:t-1,y:a},{x:t+1,y:a},{x:t,y:a-1},{x:t,y:a+1}];shuffle(s);for(var l in s)startWay(e,s[l].x,s[l].y,i,r)}}function win(){saveGame(),clearInterval(game_timer),showInfo("<br><br><br><h2>Wow! You've won!</h2>Your lowscore is<br>"+lowscore)}function lose(){saveGame(),clearInterval(game_timer),showInfo("<br><br><br><h2>You have failed.</h2>Your lowscore is<br>"+lowscore)}function randomUnit(e){return e[Math.floor(Math.random()*e.length)]}function generateLevel(e){if(0==playerLevel)return void win();mapImage=void 0;for(var t=0;width*height>t;t++)e[t]=cell.wall;var a=Math.floor(Math.random()*width),i=Math.floor(Math.random()*height);player=new Player(0,a,i,playerLevel,unitTypes[0]),levelstartx=a,levelstarty=i,startWay(e,a,i,{len:0},100+Math.floor(400*Math.random())),units=[player];for(var r=[],t=1;t<unitTypes.length;t++)unitTypes[t].level<maxPlayerLevel-playerLevel+1&&r.push(unitTypes[t]);for(var s=[a+i*width],t=Math.floor(15*Math.random());t>=0;t--){do a=Math.floor(Math.random()*width),i=Math.floor(Math.random()*height);while(e[a+i*width]==cell.wall||-1!=s.indexOf(a+i*width)||Math.abs(a-player.x)<=seeDist&&Math.abs(i-player.y)<=seeDist);var l=new Unit(units.length,a,i,maxPlayerLevel-playerLevel+1,randomUnit(r),weapons[1]);s.push(a+i*width),units.push(l)}var o=[],n=player.possibleMoves(o,!1),h=player.x+player.y*width;for(var t in n)n[t]>n[h]&&1e4!=n[t]&&-1==s.indexOf(t)&&(h=t);objects=[new GameObject(0,h%width,Math.floor(h/width),objectTypes.door,"orange","|U|")];for(var p=Math.floor(Math.random()*wallCells.length),t=0;width*height>t;t++)e[t]==cell.wall?(cells[t]=randomCell(wallCells[p]),cells[t].shift<0&&t-width>=0&&(cells[t-width]=emptyCells[0])):cells[t]=randomCell(emptyCells);notKilledFlag=0==killed?1:0,killed=0,currentMap++,texts=[]}function randomCell(e){var t=Math.random();for(var a in e)if(t<=e[a].p)return e[a];return e[0]}function game_cycle(){if(0>=lowscore)return lowscore=0,void win();gameCounter++%25==24&&player.hp>1&&(player.hp--,pushToTexts(new DisplayedText(0,player.drawx,player.drawy,"red","-1")));for(var e in units)units[e]&&(units[e].act(),gameCounter%25==24&&player.hp<player.maxhp&&0==units[e].target&&(player.hp++,pushToTexts(new DisplayedText(0,player.drawx,player.drawy,"green","+1"))));for(var e in objects)objects[e]&&objects[e].process();checkAchievements(),redraw(levelMap);for(var e in texts)texts[e]&&texts[e].process()}function startNewGame(){init(),elm("menu").style.display="none",elm("game").style.display="block"}function showAchievements(){var e="",t="";for(var a in achievements)achievements[a].have&&(t+="<b>"+achievements[a].name+"</b> - "+achievements[a].desc+"<br>");e=t.length>0?"<h2>Achievements</h2>"+t:"<br><br><br><br>",e+="<h2>Lowscore:</h2>"+worstLowscore,showInfo(e)}function showInfo(e){var t=elm("popupOverlay");t.style.width=window.innerWidth,t.style.height=window.innerHeight,t.style.display="block",elm("popup").innerHTML=e}function hidePopup(){elm("popupOverlay").style.display="none"}function showHelp(){var e="<br><br>You must reach best highscore in most games, but there is no highscore in this game. There is lowscore instead of it. And your main goal is to reach lowscore 0.<br><br> Click mouse to move your character, click enemy to attack it. Click spell to cast it (you can also use numerical keys 1 - 8). To complete the level you must enter the door.<br><br>Good luck!";showInfo(e)}function showAboutInfo(){var e="<br><br>"+gameName+" "+version+"<br><br>(c)<br>Yaroslav Zotov aka qiray,<br> Danil Mikhaylov aka Risele, <br>2015<br> for js13kgames";showInfo(e)}function drawMenuButton(e){var t="/= = = = = = = = = = = = = = = = = = = = =\\\n||                                         ||\n||%label||\n||                                         ||\n\\= = = = = = = = = = = = = = = = = = = = =/",a=43-e.length,i=a>>1,r=1&a;return t.replace("%label",Array(i+(r?1:0)).join(" ")+e+Array(i).join(" "))}function GameObject(e,t,a,i,r,s){this.id=e,this.x=t,this.y=a,this.drawx=t*cellSize,this.drawy=(a+1)*cellSize,this.type=i,this.string=s,this.color=r}function Player(e,t,a,i,r){Unit.prototype.constructor.call(this,e,t,a,i,r),playerArmor&&(this.armorType=playerArmor,this.armor=playerArmor.armor),playerWeapon&&(this.weapon=playerWeapon),this.spells=clone(spells)}function saveGame(){if("localStorage"in window&&null!==window.localStorage){localStorage.setItem("lowscore",worstLowscore);var e="";for(var t in achievements)e+=achievements[t].have+" ";e=e.substring(0,e.length-1),localStorage.setItem("achievements",e)}}function loadGame(){if("localStorage"in window&&null!==window.localStorage){var e=localStorage.getItem("lowscore");if(worstLowscore=e?e:Number.POSITIVE_INFINITY,e=localStorage.getItem("achievements")){e=e.split(" ");for(var t in e)achievements[t].have="true"==e[t]}}}function Unit(e,t,a,i,r){this.id=e,this.x=this.startx=t,this.y=this.starty=a,this.drawx=t*cellSize,this.drawy=(a+1)*cellSize,this.targetx=this.targety=this.nexttargetx=this.nexttargety=this.target=-1,this.level=i,this.maxhp=this.hp=Math.floor(r.factors.hp*xpA*100*Math.exp(.1*xpB*i)),this.damage=Math.floor(r.factors.damage*xpA*10*Math.exp(.1*xpB*i)),this.attackSpeed=this.wayIndex=0,this.speed=basicSpeed*r.factors.speed,this.xp=Math.floor(r.factors.xp*xpA*.1*Math.exp(xpB*(maxPlayerLevel-i+1))),this.way=[],this.status=statuses.stop,this.color=r.color,this.string=r.string,this.name=r.name,this.weapon=weapons[r.weapons[Math.floor(Math.random()*r.weapons.length)]],this.armorType=armors[r.armors[Math.floor(Math.random()*r.armors.length)]],this.armor=this.armorType.armor}function unitsDist(e,t){return Math.sqrt(Math.pow(e.drawx-t.drawx,2)+Math.pow(e.drawy-t.drawy,2))/cellSize}var version="v1.0",gameName="Lose to win",canvas,ctx,width=32,height=24,cellSize=20,levelMap=new Array(width*height),cells=new Array(width*height),player,game_timer,cell={wall:1,empty:0},units=[],objects=[],texts=[],mapImage=void 0,statuses={stop:0,move:1,attack:2},objectTypes={door:{id:0,fontSize:18,lineSize:20,yshift:0,desc:"This is a door. Enter it to complete the level."},healPotion:{id:1,fontSize:18,lineSize:20,yshift:0,desc:"This is a heal potion. Drink it, it's useful."},ThorsHammer:{id:2,fontSize:18,lineSize:16,yshift:-2*cellSize,desc:"The hammer of Thor"},fireball:{id:3,fontSize:18,lineSize:20,yshift:0,desc:"Fireball"},item:{id:4,fontSize:18,lineSize:20,yshift:0,desc:"Take it!"}},yoffset=-3,maxPlayerLevel=16,playerLevel=maxPlayerLevel,lowscore=0,xpToNextLevel=0,worstLowscore=Number.POSITIVE_INFINITY,basicSpeed=5,levelstartx=0,levelstarty=0,playerArmor,playerWeapon,healPotionProbability=.9,weaponProbability=.75,armorProbability=.75,currentMap=0,killed=0,totalKilled=0,castedSpells=0,notKilledFlag=0,seeDist=2,moveDist=8,attackDist=1.2,gameCounter=0,wallCells=[[{color:"black",txt:"1",p:.35,height:16,line:20,shift:0},{color:"#B22222",txt:"#",p:.75,height:18,line:20,shift:0},{color:"#007700",txt:"/|\\",p:.8,height:18,line:20,shift:0},{color:"green",txt:"W",p:.84,height:18,line:20,shift:0},{color:"green",txt:"\\|/",p:.9,height:18,line:20,shift:0},{color:"#00aa00",txt:"88\n888\n||",p:.95,height:18,line:12,shift:-cellSize},{color:"#708090",txt:"71\n3Y5\n||",p:.96,height:18,line:12,shift:-cellSize},{color:"green",txt:"^\n/|\\\n//\\\\\n#",p:1,height:18,line:14,shift:-1.5*cellSize}],[{color:"black",txt:"#|",p:.3,height:18,line:20,shift:0},{color:"black",txt:"|#|",p:.6,height:18,line:20,shift:0},{color:"#B22222",txt:"AA",p:.8,height:18,line:20,shift:0},{color:"grey",txt:"LI",p:1,height:18,line:20,shift:0}],[{color:"blue",txt:"~",p:.5,height:18,line:20,shift:0},{color:"#1020aa",txt:"w",p:.7,height:16,line:20,shift:0},{color:"blue",txt:"'",p:.95,height:18,line:20,shift:0},{color:"grey",txt:".",p:1,height:18,line:20,shift:0}],[{color:"#B8860B",txt:"..",p:.5,height:18,line:20,shift:0},{color:"#DAA520",txt:".",p:.7,height:16,line:20,shift:0},{color:"#FFD700",txt:'"',p:.9,height:18,line:20,shift:0},{color:"#DAA520",txt:",",p:1,height:18,line:20,shift:0}]],emptyCells=[{color:"black",txt:" ",p:1,height:18,line:20,shift:0}],weapons=[{id:0,name:"Wooden stick",damage:.2,speed:4},{id:1,name:"Baseball bat",damage:.5,speed:8},{id:2,name:"Wooden sword",damage:.75,speed:8},{id:3,name:"Rusty axe",damage:1,speed:8},{id:4,name:"Rusty sword",damage:1,speed:6},{id:5,name:"Iron sword",damage:1.2,speed:6},{id:6,name:"Morning star",damage:2,speed:12},{id:7,name:"Silver sword",damage:2.5,speed:6},{id:8,name:"DEATH SCYTHE",damage:4,speed:8},{id:9,name:"Emerald Sword of the Power and Glory",damage:8,speed:8}],armors=[{id:0,name:"T-shirt",armor:0},{id:1,name:"Leather jacket",armor:.1},{id:2,name:"Leather armor",armor:.15},{id:3,name:"Light armor",armor:.25},{id:4,name:"Ð¡hain armor",armor:.35},{id:5,name:"Heavy armor",armor:.5},{id:6,name:"Diamond armor",armor:.7}],unitTypes=[{name:"Player",string:"\\o/",color:"blue",factors:{hp:1,speed:1,damage:1,xp:1},weapons:[0],armors:[0],level:0},{name:"Warrior",string:"\\o/",color:"red",factors:{hp:1,speed:1,damage:1,xp:1},weapons:[2,3,4,5],armors:[2,3,4],level:0},{name:"Hunter",string:"o}",color:"#B22222",factors:{hp:.9,speed:1.2,damage:.95,xp:.9},weapons:[0,1,2],armors:[1,2],level:0},{name:"Knight",string:"\\n/",color:"red",factors:{hp:1.5,speed:.8,damage:1.5,xp:1.5},weapons:[5,6],armors:[4,5],level:.1*maxPlayerLevel},{name:"Ogre",string:"\\Oo/",color:"#B8860B",factors:{hp:2,speed:.5,damage:2,xp:2},weapons:[6],armors:[5],level:.2*maxPlayerLevel},{name:"Berserk",string:"\\v/",color:"red",factors:{hp:.5,speed:1.5,damage:1.5,xp:1.5},weapons:[5,7],armors:[3,4],level:.4*maxPlayerLevel},{name:"Death",string:"J{",color:"grey",factors:{hp:1,speed:1,damage:3,xp:2.5},weapons:[8],armors:[0],level:.6*maxPlayerLevel},{name:"Glory knight",string:"\\T/",color:"#00C957",factors:{hp:1,speed:1,damage:1,xp:1},weapons:[9],armors:[5,6],level:.8*maxPlayerLevel}],spells=[{id:0,name:"Thor's hammer",desc:"Attacks enemy with a lightning from the sky",timer:180,active:!1,object:-1,condition:function(){return player.target>0},action:function(){this.object=new GameObject(objects.length,units[player.target].x,units[player.target].y,objectTypes.ThorsHammer,"#FF8C00","|\n/\nV"),objects.push(this.object);var e=Math.floor(.5*units[player.target].maxhp);pushToTexts(new DisplayedText(0,units[player.target].drawx,units[player.target].drawy,"#FF8C00","-"+e)),redrawPlayerInfo(),(units[player.target].hp-=e)<=0&&(units[player.target].die(),player.loseTarget()),castedSpells|=1,this.active=!0},activeAction:function(){this.timer>=10&&(objects[this.object.id]=void 0,this.active=!1)}},{id:1,name:"Invisibility",desc:"Makes player invisible for a short time",timer:450,active:!1,condition:function(){return 1},action:function(){player.color="rgba(0, 0, 255, 0.5)";for(var e=1;e<units.length;e++)units[e]&&0==units[e].target&&units[e].gotoStart();castedSpells|=2,this.active=!0},activeAction:function(){this.timer>=45&&(player.color=unitTypes[0].color,this.active=!1)}},{id:2,name:"Berserc",desc:"Makes player damage bigger for a short time but decreases hitpoints",timer:300,active:!1,condition:function(){return!player.spells[3].active},action:function(){player.string="\\v/",player.damage*=3,player.hp=Math.floor(player.hp/2)+1,castedSpells|=4,this.active=!0},activeAction:function(){this.timer>=100&&(player.string=unitTypes[0].string,player.damage=Math.floor(player.damage/3),this.active=!1)}},{id:3,name:"Heaven 's shield",desc:"Makes player armor bigger for a short time but decreases damage",timer:300,active:!1,damage:0,armor:0,condition:function(){return!player.spells[2].active},action:function(){player.string="(o)",this.armor=player.armor,this.damage=player.damage,player.armor=.95,player.damage=Math.floor(player.damage/2),castedSpells|=8,this.active=!0},activeAction:function(){this.timer>=100&&(player.armor=this.armor,player.string=unitTypes[0].string,player.damage=this.damage,this.active=!1)}},{id:4,name:"Fast as a shark",desc:"Makes player faster for a short time",timer:300,speed:0,condition:function(){return 1},action:function(){this.speed=player.speed,player.speed=Math.floor(1.5*player.speed),castedSpells|=16,this.active=!0},activeAction:function(){this.timer>=100&&(player.speed=this.speed,this.active=!1)}},{id:5,name:"Fireball",desc:"Cast a fireball to damage player's target",timer:150,active:!1,object:-1,target:-1,speed:cellSize,condition:function(){return player.target>0},action:function(){this.target=player.target,this.object=new GameObject(objects.length,player.x,player.y,objectTypes.fireball,"#FF8C00","o"),objects.push(this.object),castedSpells|=32,this.active=!0},activeAction:function(){units[this.target]||(objects[this.object.id]=void 0,this.active=!1);var e=this.object.drawx-units[this.target].drawx,t=this.object.drawy-units[this.target].drawy;if(Math.abs(e)<cellSize/2&&Math.abs(t)<cellSize/2){objects[this.object.id]=void 0;var a=Math.floor(.5*player.damage);pushToTexts(new DisplayedText(0,units[this.target].drawx,units[this.target].drawy,"#FF8C00","-"+a)),(units[this.target].hp-=a)<=0&&(units[this.target].die(),player.target==this.target&&player.loseTarget()),redrawPlayerInfo(),this.active=!1}else{var i=(Math.sqrt(sqr(e)+sqr(t)),Math.atan(Math.abs(t/e)));e>0?this.object.drawx-=this.speed*Math.cos(i):this.object.drawx+=this.speed*Math.cos(i),t>0?this.object.drawy-=this.speed*Math.sin(i):this.object.drawy+=this.speed*Math.sin(i)}}},{id:6,name:"Teleport",desc:"Teleports player to start position",timer:900,condition:function(){return 1},action:function(){for(var e=1;e<units.length;e++)units[e]&&0==units[e].target&&units[e].gotoStart();player.x=levelstartx,player.y=levelstarty,player.drawx=levelstartx*cellSize,player.drawy=(levelstarty+1)*cellSize,player.status=statuses.stop,player.way=[],player.wayIndex=0,player.nexttargetx=player.nexttargety=player.target=-1,castedSpells|=64}},{id:7,name:"Main menu",desc:"Quit to main menu",timer:1,condition:function(){return 1},action:showMenu}],achievements=[{name:"First blood",have:!1,desc:"Kill 1 enemy",condition:function(){return killed>0}},{name:"Destroyer",have:!1,desc:"Kill 50 enemies",condition:function(){return totalKilled>=50}},{name:"Exterminatus",have:!1,desc:"Kill 100 enemies",condition:function(){return totalKilled>=100}},{name:"This is only the beginning",have:!1,desc:"Complete 1 level",condition:function(){return currentMap>0}},{name:"Pacifist or coward?",have:!1,desc:"Complete level without any murders",condition:function(){return notKilledFlag&&currentMap>0}},{name:"That's one small step for a man.",have:!1,desc:"Reach 15 level",condition:function(){return player.level<=15}},{name:"One giant leap for mankind.",have:!1,desc:"Reach 10 level",condition:function(){return player.level<=10}},{name:"How?",have:!1,desc:"Reach 5 level",condition:function(){return player.level<=5}},{name:"The Wizzard",have:!1,desc:"Cast all spells",condition:function(){return 127==castedSpells}},{name:"Recursively",have:!1,desc:"Have all achievements",condition:function(){var e=0;for(var t in achievements)achievements[t].have&&e++;return e==achievements.length-1?!0:!1}}],etalonSpells=clone(spells),unit=new Unit(0,0,80,5,unitTypes[0]);DisplayedText.prototype.process=function(){--this.timer>0?(ctx.fillStyle=this.color,drawText(16,18,this.text,this.x,this.y-=10)):texts[this.id]=void 0};var xpA=1,xpB=1.5;GameObject.prototype.draw=function(){ctx.fillStyle=this.color,drawText(this.type.fontSize,this.type.lineSize,this.string,this.drawx+cellSize/2,this.drawy+this.type.yshift),ctx.fillStyle="black"},GameObject.prototype.process=function(){this.drawx==player.drawx&&this.drawy==player.drawy&&this.x==player.targetx&&this.y==player.targety&&(this.type==objectTypes.door&&(decreaseLowscore(Math.floor(.1*xpA*Math.exp(xpB*player.level))),generateLevel(levelMap)),this.type==objectTypes.healPotion&&(player.hp=player.hp+Math.floor(.1*player.maxhp),pushToTexts(new DisplayedText(0,player.drawx,player.drawy,"green","+"+Math.floor(.1*player.maxhp))),player.hp>player.maxhp&&(player.hp=player.maxhp),redrawPlayerInfo(),objects[this.id]=void 0),this.type==objectTypes.item&&("weapon"==this.itemType&&player.weapon.id<this.itemObject.id&&(player.weapon=this.itemObject,playerWeapon=player.weapon,showInfo("<br><br><br><br>You've got a new weapon - <h2>"+player.weapon.name+"</h2>")),"armor"==this.itemType&&player.armorType.id<this.itemObject.id&&(player.armorType=this.itemObject,player.armor=this.itemObject.armor,playerArmor=player.armorType,showInfo("<br><br><br><br>You've got a new armor - <h2>"+player.armorType.name+"</h2>")),objects[this.id]=void 0))},Player.prototype=unit,Player.prototype.draw=function(){Unit.prototype.draw.call(this),-1!=this.targetx&&this.status!=statuses.stop&&(ctx.strokeStyle="green",this.target>0?ctx.strokeRect(units[this.target].drawx+1,units[this.target].drawy-cellSize+1,cellSize-2,cellSize-2):ctx.strokeRect(this.targetx*cellSize+1,this.targety*cellSize+1,cellSize-2,cellSize-2),ctx.strokeStyle="black"),ctx.fillStyle="black"},Player.prototype.castSpell=function(e){e<this.spells.length&&this.spells[e].timer>=spells[e].timer&&this.spells[e].condition()&&(this.spells[e].action(),this.spells[e].timer=0,spells[e].timer=Math.floor(1.1*spells[e].timer),elm("spell"+e).style.cursor="default")},Player.prototype.act=function(){Unit.prototype.act.call(this);for(var e in this.spells)this.spells[e].timer<spells[e].timer?this.spells[e].timer++:elm("spell"+e).style.cursor="pointer",this.spells[e].active&&this.spells[e].activeAction()},Unit.prototype.draw=function(){ctx.fillStyle=this.color,drawText(18,20,this.string,this.drawx+cellSize/2,this.drawy),ctx.fillStyle="black"},Unit.prototype.possibleMoves=function(e,t,a){var i=[],r=[],s=new Array(width*height);r.push({x:this.x,y:this.y});for(var l=0,o=0,n=0;width*height>n;n++)s[n]=levelMap[n]==cell.wall?1e4:-1;for(s[this.x+width*this.y]=l;!o&&r.length;){i=r,r=[],l++;for(var n in i){if(t&&o)break;var h=i[n].x,p=i[n].y,c=[{x:h-1,y:p},{x:h+1,y:p},{x:h,y:p-1},{x:h,y:p+1}];for(var y in c)if(!(c[y].x<0||c[y].x>=width||c[y].y<0||c[y].y>=height||s[c[y].x+width*c[y].y]>=0)&&(r.push(c[y]),s[c[y].x+width*c[y].y]=l,t&&c[y].x==this.targetx&&c[y].y==this.targety)){o=1;break}}}for(var n=0;width*height>n;n++)1e4!=s[n]&&s[n]>=0&&e.push(n);return a&&(a.found=o),s},Unit.prototype.generateWay=function(){if(this.way=[],this.x==this.targetx&&this.y==this.targety)return this.way.push({x:this.x,y:this.y}),this.way;var e=[],t={found:!1},a=this.possibleMoves(e,1,t);if(t.found){d=a[this.targetx+width*this.targety];var i={x:this.targetx,y:this.targety};for(this.way.push(i);i.x!=this.x||i.y!=this.y;){var r=i.x,s=i.y,e=[{x:r-1,y:s},{x:r+1,y:s},{x:r,y:s-1},{x:r,y:s+1}];shuffle(e);for(var l in e)if(!(e[l].x<0||e[l].x>=width||e[l].y<0||e[l].y>=height||a[e[l].x+width*e[l].y]<0)&&a[e[l].x+width*e[l].y]==d-1){i={x:e[l].x,y:e[l].y},this.way.push(i),d--;break}}this.way.reverse()}return this.wayIndex=1,this.way},Unit.prototype.die=function(){if(units[this.id].hp=0,units[this.id]=void 0,0==this.id?lose():(decreaseLowscore(Math.floor(this.xp/Math.exp(xpB*(maxPlayerLevel-(player.level+this.level)+1)))),killed++,totalKilled++),Math.random()>healPotionProbability)return void objects.push(new GameObject(objects.length,this.x,this.y,objectTypes.healPotion,"red","y"));if(Math.random()>weaponProbability&&this.weapon.id>player.weapon.id){var e=new GameObject(objects.length,this.x,this.y,objectTypes.item,"silver","<==I-");return e.itemType="weapon",e.itemObject=this.weapon,void objects.push(e)}if(Math.random()>armorProbability&&this.armorType.id>player.armorType.id){var e=new GameObject(objects.length,this.x,this.y,objectTypes.item,"silver",'"U"');return e.itemType="armor",e.itemObject=this.armorType,void objects.push(e)}},Unit.prototype.loseTarget=function(){this.target=this.targetx=this.targety=-1,this.status=statuses.stop},Unit.prototype.attack=function(){if(-1!=this.target){if(!units[this.target])return void this.loseTarget();if(Math.abs(this.x-units[this.target].x)+Math.abs(this.y-units[this.target].y)>1)return void(this.status=statuses.move);if(0==this.attackSpeed){this.attackSpeed=this.weapon.speed;var e=Math.floor((1-units[this.target].armor)*this.damage*this.weapon.damage);pushToTexts(new DisplayedText(0,units[this.target].drawx,units[this.target].drawy,"red","-"+e)),(units[this.target].hp-=e)<=0&&(units[this.target].die(),this.loseTarget()),redrawPlayerInfo()}this.attackSpeed--}},Unit.prototype.setTarget=function(){if(-1!=this.nexttargetx){this.attackSpeed=this.attackSpeed>0?this.attackSpeed-1:0,this.targetx=this.nexttargetx,this.targety=this.nexttargety,this.generateWay(),this.nexttargetx=this.nexttargety=-1;for(var e in units)if(units[e]&&e!=this.id&&units[e].x==this.targetx&&units[e].y==this.targety){this.target=e;break}}},Unit.prototype.move=function(){if(-1!=this.target&&units[this.target]&&unitsDist(this,units[this.target])<=attackDist&&Math.abs(this.drawx-this.x*cellSize)<=this.speed/2&&Math.abs(this.drawy-(this.y+1)*cellSize)<=this.speed/2)return this.status=statuses.attack,void(this.way=[]);if(this.wayIndex>=this.way.length)return void this.setTarget();var e=this.wayIndex<this.way.length-1?this.way[this.wayIndex].x:this.targetx,t=this.wayIndex<this.way.length-1?this.way[this.wayIndex].y:this.targety;if(Math.abs(this.drawx-e*cellSize)<=this.speed/2&&Math.abs(this.drawy-(t+1)*cellSize)<=this.speed/2){if(this.x=this.way[this.wayIndex].x,this.y=this.way[this.wayIndex].y,this.drawx=this.x*cellSize,this.drawy=(this.y+1)*cellSize,this.wayIndex++,this.setTarget(),-1!=this.target&&units[this.target]&&units[this.target].x!=this.targetx&&units[this.target].y!=this.targety)return this.nexttargetx=units[this.target].x,this.nexttargety=units[this.target].y,void this.setTarget();if(-1!=this.target&&units[this.target]&&unitsDist(this,units[this.target])<=attackDist)return this.status=statuses.attack,void(this.way=[])}if(this.wayIndex>=this.way.length)return void(this.status=-1==this.target?statuses.stop:statuses.attack);var a=1,i=1,r=1,s=1;for(var l in units)l!=this.id&&units[l]&&units[l].target==this.id&&(this.x-units[l].x>0&&(a=r=s=.5),this.x-units[l].x<0&&(i=r=s=.5),this.y-units[l].y>0&&(r=a=i=.5),this.y-units[l].y<0&&(s=a=i=.5));this.way[this.wayIndex].x-this.x==1&&(this.drawx+=this.speed*i),this.way[this.wayIndex].x-this.x==-1&&(this.drawx-=this.speed*a),this.way[this.wayIndex].y-this.y==1&&(this.drawy+=this.speed*s),this.way[this.wayIndex].y-this.y==-1&&(this.drawy-=this.speed*r)},Unit.prototype.gotoStart=function(){this.target=-1,this.nexttargetx=this.startx,this.nexttargety=this.starty,this.status=statuses.move},Unit.prototype.AI=function(){if(0!=this.id&&!player.spells[1].active){var e=unitsDist(this,player);(Math.abs(this.x-this.startx)>=moveDist||Math.abs(this.y-this.starty)>=moveDist)&&e>1?this.gotoStart():this.nexttargetx==this.startx&&this.nexttargety==this.starty&&this.status==statuses.move||!(seeDist+.95>=e||-1!=this.target)||(this.nexttargetx!=player.x||this.nexttargety!=player.y)&&(this.nexttargetx=player.x,this.nexttargety=player.y,this.status=statuses.move)}},Unit.prototype.act=function(){this.AI(),this.status==statuses.move&&this.move(),this.status==statuses.attack&&this.attack()};