<title>Castle Defender VR - js13kGames 2023</title><style>body{margin:0;padding:0;overflow:hidden;background:linear-gradient(180deg,#80ccff 45%,#74a33f 55%)}.xr-button-container{display:flex;justify-content:center}#xr-button{transition:.2s;width:90%;position:fixed;height:15vh;top:50%;text-align:center;font-size:5em;font-family:fantasy;font-weight:100;width:90%;text-shadow:0 2px 0 red,0 -6px 2px #9e9e9e}#xr-button:hover{transition:.2s;font-size:5.2em;color:#2a584f}.title-box{display:flex;justify-content:center}.title{position:fixed;width:90%;height:25vh;top:35%;left:5%;text-align:center;font-size:7em;font-family:'Brush Script MT',cursive;font-weight:700}.title .sub{color:red;font-size:.65em;font-weight:100;position:relative;display:inline-block;transform:rotate(15deg) translate(-40px,0);font-family:sans-serif;vertical-align:top}.score-container{display:flex;justify-content:center;display:none}.score-text{position:fixed;width:90%;height:25vh;top:65%;left:5%;text-align:center;font-size:4em;font-family:sans-serif;font-weight:100}.game-over{display:none}</style><div class=title-bxx><div class="title normal">CASTLE DEFENDER<i class=sub>VR</i></div><div class="title game-over">GAME OVER</div></div><div class=xr-button-container><div id=xr-button>Play Game</div></div><div class=score-container><div class=score-text>You hit <b id=score>69</b> knights. Well Done!</div></div><script>var F=WebGL2RenderingContext;var ot=[[0,0,0],[110,184,168],[42,88,79],[116,163,63],[252,255,192],[198,80,90],[68,68,68],[119,68,72],[238,156,93],[116,116,116]],nt=[" D "," 0 "," 0 "," 1 "," 8 ","A0A","A1A"," 9 ","B9B","B2B","C3C"," 4 ","C4C"," 5 ","3C3","949","787"," 5 ","727","5 5","767","666"],at=[`1  11  1

1  11  1
`,`   11
  1  1
 1    1 `,`1  11  1
1 1  1 1
1  11  1`,`    2 2
    1 1
   3 3`,` 2 2 2 2
1 1 1 1 1
 3 3 3 3`,`22 22 22
11 11 11
33 33 33`,`22 22 22
11211211
33133133
11111111
11111111`,`      22
     211
    2111
   21111`,` 2    2
 1    1 `,` 2    2
 1 33 1 `,"      2 ",`      2
      1 `,"   3  3 ",`  1  1


  1  1  `];var v=Math.PI,ht=new Float32Array([-1,1,1,.625,0,-1,0,0,-1,-1,-1,.375,.25,-1,0,0,-1,-1,1,.375,0,-1,0,0,-1,1,-1,.625,.25,0,0,-1,1,-1,-1,.375,.5,0,0,-1,-1,-1,-1,.375,.25,0,0,-1,1,1,-1,.625,.5,1,0,0,1,-1,1,.375,.75,1,0,0,1,-1,-1,.375,.5,1,0,0,1,1,1,.625,.75,0,0,1,-1,-1,1,.375,1,0,0,1,1,-1,1,.375,.75,0,0,1,1,-1,-1,.375,.5,0,-1,0,-1,-1,1,.125,.75,0,-1,0,-1,-1,-1,.125,.5,0,-1,0,-1,1,-1,.875,.5,0,1,0,1,1,1,.625,.75,0,1,0,1,1,-1,.625,.5,0,1,0,-1,1,1,.625,0,-1,0,0,-1,1,-1,.625,.25,-1,0,0,-1,-1,-1,.375,.25,-1,0,0,-1,1,-1,.625,.25,0,0,-1,1,1,-1,.625,.5,0,0,-1,1,-1,-1,.375,.5,0,0,-1,1,1,-1,.625,.5,1,0,0,1,1,1,.625,.75,1,0,0,1,-1,1,.375,.75,1,0,0,1,1,1,.625,.75,0,0,1,-1,1,1,.625,1,0,0,1,-1,-1,1,.375,1,0,0,1,1,-1,-1,.375,.5,0,-1,0,1,-1,1,.375,.75,0,-1,0,-1,-1,1,.125,.75,0,-1,0,-1,1,-1,.875,.5,0,1,0,-1,1,1,.875,.75,0,1,0,1,1,1,.625,.75,0,1,0]);var k=class{gl;program;projectionLoc;viewLoc;ambientColorLoc;lightingDirectionLoc;directionalColorLoc;positionLoc=0;texCoordLoc=1;normalLoc=2;colorLoc=3;matrixLoc=4;colorsLoc;constructor(t){this.gl=t,this.compileShader()}compileShader(){let t=`#version 300 es
    #pragma vscode_glsllint_stage: vert
    precision highp float;

    layout(location=0) in vec3 aPosition;
    layout(location=1) in vec2 aTexCoord;
    layout(location=2) in vec3 aNormal;
    layout(location=3) in float aColor;
    layout(location=4) in mat4 aModel;

    uniform mat4 uProjection;
    uniform mat4 uView;
    uniform vec3 uColors[10];

    uniform vec3 uLightingDirection;

    out vec4 vPosition;
    out vec3 vColor;
    out vec3 vNormal;
    out vec4 vLightDirection;
    out vec2 vTexCoord;
    out vec3 vScale;

    void main() {
        vColor = uColors[uint(aColor)];
        mat4 modelViewMatrix = uView * aModel;

        mat3 normalMatrix = transpose(inverse(mat3(modelViewMatrix)));
        vNormal = normalize(normalMatrix * aNormal);
        vLightDirection = uView * vec4(uLightingDirection, 1.0);
        vec4 position = modelViewMatrix * vec4(aPosition, 1.0);
        gl_Position = uProjection * position;
        vTexCoord = aTexCoord;
        vPosition =  vec4(aPosition, 1.0);
        vec3 x_axis = vec3(aModel[0][0], aModel[1][0], aModel[2][0]);
        vec3 y_axis = vec3(aModel[0][1], aModel[1][1], aModel[2][1]);
        vec3 z_axis = vec3(aModel[0][2], aModel[1][2], aModel[2][2]);
        vScale = vec3(length(x_axis),length(y_axis),length(z_axis));
    }
`,e=`#version 300 es
        #pragma vscode_glsllint_stage: frag
  precision highp float;

  uniform vec3 uAmbientColor;
  uniform vec3 uDirectionalColor;
  uniform mat4 uView;

  in vec4 vPosition;
  in vec3 vColor;
  in vec3 vNormal;
  in vec4 vLightDirection;
  in vec2 vTexCoord;
  in vec3 vScale;
  out vec4 oColor;

  float fogFactorExp2(float dist, float density) {
    const float LOG2 = -1.442695;
    float d = density * dist;
    return 1.0 - clamp(exp2(d*d*LOG2), 0.0, 1.0);
  }

  float random(vec2 co)
  {
    return fract(sin(dot(co.xy,vec2(12.9898,78.233))) * 43758.5453);
  }

  void main() {
    float dist = gl_FragCoord.z/gl_FragCoord.w;
    float fogFactor = fogFactorExp2(dist, 0.015);

    float directionalLightIntensity = max(0.0, dot(vNormal, normalize(-vLightDirection.xyz)));

    vec3 norm = normalize(vNormal);
    vec2 uvX = vPosition.yz * vScale.yz;
    vec2 uvY = vPosition.zx * vScale.zx;
    vec2 uvZ = vPosition.xy * vScale.xy;

    float fX = random(floor(uvX*5.0)/5.0) * abs(norm.x);
    float fY = random(floor(uvY*5.0)/5.0) * abs(norm.y);
    float fZ = random(floor(uvZ*5.0)/5.0) * abs(norm.z);

    float f = fX + fY + fZ;

    vec3 light = uAmbientColor + directionalLightIntensity * uDirectionalColor;
    vec3 diffuse = vColor.rgb * light * (0.7+f*0.3);

    oColor  = mix(vec4(diffuse,1.0), vec4(0.5, 0.8, 1., 1.), fogFactor);
  }
`,i=this.gl.createShader(this.gl.VERTEX_SHADER);if(this.gl.shaderSource(i,t),this.gl.compileShader(i),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS))throw`Could not compile WebGL program.

${this.gl.getShaderInfoLog(i)}`;let s=this.gl.createShader(this.gl.FRAGMENT_SHADER);if(this.gl.shaderSource(s,e),this.gl.compileShader(s),!this.gl.getShaderParameter(s,this.gl.COMPILE_STATUS))throw`Could not compile WebGL program.

${this.gl.getShaderInfoLog(s)}`;let r=this.gl.createProgram();if(this.gl.attachShader(r,i),this.gl.attachShader(r,s),this.gl.linkProgram(r),!this.gl.getProgramParameter(r,this.gl.LINK_STATUS)){let n=this.gl.getProgramInfoLog(r);throw new Error(`Could not compile WebGL program.

${n}`)}this.projectionLoc=this.gl.getUniformLocation(r,"uProjection"),this.viewLoc=this.gl.getUniformLocation(r,"uView"),this.colorsLoc=this.gl.getUniformLocation(r,"uColors"),this.ambientColorLoc=this.gl.getUniformLocation(r,"uAmbientColor"),this.lightingDirectionLoc=this.gl.getUniformLocation(r,"uLightingDirection"),this.directionalColorLoc=this.gl.getUniformLocation(r,"uDirectionalColor"),this.gl.enableVertexAttribArray(this.matrixLoc),this.program=r}};var l=class extends Array{constructor(t=0,e=0,i=0){super(3),this.set(t,e,i)}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}set(...t){for(let e=0;e<3;e++)this[e]=t[e];return this}copy(t){return this.set(...t)}add(t){for(let e=0;e<3;e++)this[e]+=typeof t=="number"?t:t[e];return this}sub(t){for(let e=0;e<3;e++)this[e]-=typeof t=="number"?t:t[e];return this}multiply(t){for(let e=0;e<3;e++)this[e]*=typeof t=="number"?t:t[e];return this}divide(t){for(let e=0;e<3;e++)this[e]/=typeof t=="number"?t:t[e];return this}invert(){return this.multiply(-1)}getLength(){return Math.hypot(...this)}normalize(){return this.divide(this.getLength()||1)}distanceTo(t){return Math.hypot(this.x-t.x,this.y-t.y,this.z-t.z)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){return this.set(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}lerp(t,e){let i=this.x,s=this.y,r=this.z;return this.set(i+e*(t.x-i),s+e*(t.y-s),r+e*(t.z-r))}applyQuaternion(t){let e=t.w*this.x+t.y*this.z-t.z*this.y,i=t.w*this.y+t.z*this.x-t.x*this.z,s=t.w*this.z+t.x*this.y-t.y*this.x,r=-t.x*this.x-t.y*this.y-t.z*this.z;return this.set(e*t.w+r*-t.x+i*-t.z-s*-t.y,i*t.w+r*-t.y+s*-t.x-e*-t.z,s*t.w+r*-t.z+e*-t.y-i*-t.x)}applyMatrix4(t){let[e,i,s,r,n,o,h,a,d,m,f,g,p,u,b,c]=t;return this.set(e*this.x+n*this.y+d*this.z+p,i*this.x+o*this.y+m*this.z+u,s*this.x+h*this.y+f*this.z+b).divide(r*this.x+a*this.y+g*this.z+c||1)}};var Y=class{gl;color;masks;depthTest;static vSS;static fSS;static fSSC0;static fSSC1;static triangle;lightDirection=new l(-1,-1,-1);stride=0;positionBuffer;shader;vertexArray;matrixBuffer;constructor(t){this.gl=t,this.color=[.3,.3,.3,1],this.gl.clearColor(0,0,0,1),this.masks=t.COLOR_BUFFER_BIT,this.depthTest=!1,this.lightDirection.normalize(),this.shader=new k(t),this.gl.useProgram(this.shader.program),this.positionBuffer=t.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,ht,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.shader.positionLoc,3,this.gl.FLOAT,!1,8*4,0),this.gl.enableVertexAttribArray(this.shader.positionLoc),this.gl.vertexAttribPointer(this.shader.texCoordLoc,2,this.gl.FLOAT,!1,8*4,12),this.gl.enableVertexAttribArray(this.shader.texCoordLoc),this.gl.vertexAttribPointer(this.shader.normalLoc,3,this.gl.FLOAT,!1,8*4,20),this.gl.enableVertexAttribArray(this.shader.normalLoc),t.uniform3fv(this.shader.colorsLoc,ot.flat().map(e=>e/255)),t.uniform3f(this.shader.ambientColorLoc,.3,.3,.3),t.uniform3f(this.shader.lightingDirectionLoc,this.lightDirection.x,this.lightDirection.y,this.lightDirection.z),t.uniform3f(this.shader.directionalColorLoc,.9,.9,.9)}depthTesting(t){t&&!this.depthTest?(this.masks=F.COLOR_BUFFER_BIT|F.DEPTH_BUFFER_BIT,this.gl.enable(F.DEPTH_TEST),this.depthTest=!0):!t&&this.depthTest&&(this.masks=F.COLOR_BUFFER_BIT,this.gl.disable(F.DEPTH_TEST),this.depthTest=!1)}clear(t=[0,0,0,1]){t!=this.color&&(this.gl.clearColor(t[0],t[1],t[2],t[3]),this.color=t),this.gl.clear(this.masks)}draw2(t,e,i,s,r){let n=i;this.gl.useProgram(this.shader.program),this.gl.uniformMatrix4fv(this.shader.viewLoc,!1,r.inverse.matrix),this.gl.uniformMatrix4fv(this.shader.projectionLoc,!1,s);let o=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(t),this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.shader.colorLoc,1,this.gl.FLOAT,!1,4,0),this.gl.vertexAttribDivisor(this.shader.colorLoc,1),this.gl.enableVertexAttribArray(this.shader.colorLoc);let h=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,h),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.STATIC_DRAW);let a=this.shader.matrixLoc;this.gl.vertexAttribPointer(a+0,4,this.gl.FLOAT,!1,64,0),this.gl.vertexAttribPointer(a+1,4,this.gl.FLOAT,!1,64,16),this.gl.vertexAttribPointer(a+2,4,this.gl.FLOAT,!1,64,32),this.gl.vertexAttribPointer(a+3,4,this.gl.FLOAT,!1,64,48),this.gl.vertexAttribDivisor(a+0,1),this.gl.vertexAttribDivisor(a+1,1),this.gl.vertexAttribDivisor(a+2,1),this.gl.vertexAttribDivisor(a+3,1),this.gl.enableVertexAttribArray(a+0),this.gl.enableVertexAttribArray(a+1),this.gl.enableVertexAttribArray(a+2),this.gl.enableVertexAttribArray(a+3),this.gl.drawArraysInstanced(F.TRIANGLES,0,36,n)}};var _=class x extends Array{constructor(){super(16),this.identity()}set(...t){for(let e=0;e<16;e++)this[e]=t[e];return this}copy(t){return this.set(...t)}static Identity=new x().identity();identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}multiply(t){if(typeof t=="number")for(let e=0;e<16;e++)this[e]*=t;else{let[e,i,s,r,n,o,h,a,d,m,f,g,p,u,b,c]=this,[T,S,w,C,L,R,M,P,y,V,D,E,H,X,U,W]=t;this.set(e*T+n*S+d*w+p*C,i*T+o*S+m*w+u*C,s*T+h*S+f*w+b*C,r*T+a*S+g*w+c*C,e*L+n*R+d*M+p*P,i*L+o*R+m*M+u*P,s*L+h*R+f*M+b*P,r*L+a*R+g*M+c*P,e*y+n*V+d*D+p*E,i*y+o*V+m*D+u*E,s*y+h*V+f*D+b*E,r*y+a*V+g*D+c*E,e*H+n*X+d*U+p*W,i*H+o*X+m*U+u*W,s*H+h*X+f*U+b*W,r*H+a*X+g*U+c*W)}return this}determinant(){let[t,e,i,s,r,n,o,h,a,d,m,f,g,p,u,b]=this,c=t*n-e*r,T=t*o-i*r,S=e*o-i*n,w=a*p-d*g,C=a*u-m*g,L=d*u-m*p,R=t*L-e*C+i*w,M=r*L-n*C+o*w,P=a*S-d*T+m*c,y=g*S-p*T+u*c;return h*R-s*M+b*P-f*y}transpose(){let[t,e,i,s,r,n,o,h,a,d,m,f,g,p,u,b]=this;return this.set(t,r,a,g,e,n,d,p,i,o,m,u,s,h,f,b)}invert(){let[t,e,i,s,r,n,o,h,a,d,m,f,g,p,u,b]=this,c=t*n-e*r,T=t*o-i*r,S=t*h-s*r,w=e*o-i*n,C=e*h-s*n,L=i*h-s*o,R=a*p-d*g,M=a*u-m*g,P=a*b-f*g,y=d*u-m*p,V=d*b-f*p,D=m*b-f*u,E=this.determinant();return E?this.set(n*D-o*V+h*y,i*V-e*D-s*y,p*L-u*C+b*w,m*C-d*L-f*w,o*P-r*D-h*M,t*D-i*P+s*M,u*S-g*L-b*T,a*L-m*S+f*T,r*V-n*P+h*R,e*P-t*V-s*R,g*C-p*S+b*c,d*S-a*C-f*c,n*M-r*y-o*R,t*y-e*M+i*R,p*T-g*w-u*c,a*w-d*T+m*c).multiply(1/E):this}perspective(t,e,i,s){let r=t*(Math.PI/180),n=1/Math.tan(r/2),o=1/(i-s);return this.set(n/e,0,0,0,0,n,0,0,0,0,(s+i)*o,-1,0,0,2*s*i*o,0)}orthogonal(t,e,i,s,r,n){let o=1/(t-e),h=1/(i-s),a=1/(r-n);return this.set(-2*o,0,0,0,0,-2*h,0,0,0,0,2*a,0,(t+e)*o,(s+i)*h,(n+r)*a,1)}compose(t,e,i){let s=2*e.x*e.x,r=2*e.y*e.x,n=2*e.z*e.x,o=2*e.y*e.y,h=2*e.z*e.y,a=2*e.z*e.z,d=2*e.x*e.w,m=2*e.y*e.w,f=2*e.z*e.w;return this.set((1-(o+a))*i.x,(r+f)*i.x,(n-m)*i.x,0,(r-f)*i.y,(1-(s+a))*i.y,(h+d)*i.y,0,(n+m)*i.z,(h-d)*i.z,(1-(s+o))*i.z,0,t.x,t.y,t.z,1)}scale(t){let e=t[0],i=t[1],s=t[2];return this.set(this[0]*e,this[1]*e,this[2]*e,this[3]*e,this[4]*i,this[5]*i,this[6]*i,this[7]*i,this[8]*s,this[9]*s,this[10]*s,this[11]*s,this[12],this[13],this[14],this[15])}normal(t){let[e,i,s,r,n,o,h,a,d,m,f,g,p,u,b,c]=t,T=e*o-i*n,S=e*h-s*n,w=e*a-r*n,C=i*h-s*o,L=i*a-r*o,R=s*a-r*h,M=d*u-m*p,P=d*b-f*p,y=d*c-g*p,V=m*b-f*u,D=m*c-g*u,E=f*c-g*b,H=t.determinant();return H?this.set(o*E-h*D+a*V,s*D-i*E-r*V,u*R-b*L+c*C,0,h*y-n*E-a*P,e*E-s*y+r*P,b*w-p*R-c*S,0,n*D-o*y+a*M,i*y-e*D-r*M,p*L-u*w+c*T,0,0,0,0,1).multiply(1/H):this}normalNDC(){return this[8]+=this[12]/=2,this[9]+=this[13]/=2,this[10]+=this[14]/=2,this[11]+=this[15]/=2,this}toVector3(t){t.set(this[12],this[13],this[14])}};var O=class extends Array{_a=new l;_b=new l;_c=new l;constructor(t=0,e=0,i=0,s=1){super(4),this.set(t,e,i,s)}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}get w(){return this[3]}set w(t){this[3]=t}set(...t){for(let e=0;e<4;e++)this[e]=t[e];return this}copy(t){return this.set(...t)}identity(){return this.set(0,0,0,1)}add(t){for(let e=0;e<4;e++)this[e]+=typeof t=="number"?t:t[e];return this}sub(t){for(let e=0;e<4;e++)this[e]-=typeof t=="number"?t:t[e];return this}multiply(t){if(typeof t=="number")for(let e=0;e<4;e++)this[e]*=t;else{let[e,i,s,r]=this,[n,o,h,a]=t;this.set(e*a+r*n+i*h-s*o,i*a+r*o+s*n-e*h,s*a+r*h+e*o-i*n,r*a-e*n-i*o-s*h)}return this}divide(t){for(let e=0;e<4;e++)this[e]/=typeof t=="number"?t:t[e];return this}invert(){for(let t=0;t<4;t++)this[t]*=-1;return this}getLength(){return Math.hypot(...this)}normalize(){return this.divide(this.getLength()||1)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}fromEuler(...t){let e=Math.sin(t[0]),i=Math.cos(t[0]),s=Math.sin(t[1]),r=Math.cos(t[1]),n=Math.sin(t[2]),o=Math.cos(t[2]);return this.set(e*r*o+i*s*n,i*s*o-e*r*n,i*r*n+e*s*o,i*r*o-e*s*n)}slerp(t,e){let i=this.dot(t);i<0&&(i*=-1);let s=1-e,r=e;if(1-i>1e-6){let n=Math.acos(i),o=Math.sin(n);s=Math.sin((1-e)*n)/o,r=Math.sin(e*n)/o}return i<0&&(r*=-1),this.set(s*this.x+r*t.x,s*this.y+r*t.y,s*this.z+r*t.z,s*this.w+r*t.w)}lookAt(t,e,i){let s=this._a.copy(t).sub(e);s.getLength()===0?s.z=1:s.normalize();let r=this._b.copy(i).cross(s);if(r.getLength()===0){let c=this._c.copy(i);c.z?c.x+=1e-6:c.y?c.z+=1e-6:c.y+=1e-6,r.cross(c)}r.normalize();let n=this._c.copy(s).cross(r),[o,h,a]=r,[d,m,f]=n,[g,p,u]=s,b=o+m+u;if(b>0){let c=Math.sqrt(b+1)*2;return this.set((f-p)/c,(g-a)/c,(h-d)/c,c/4)}else if(o>m&&o>u){let c=Math.sqrt(1+o-m-u)*2;return this.set(c/4,(h+d)/c,(g+a)/c,(f-p)/c)}else if(m>u){let c=Math.sqrt(1+m-o-u)*2;return this.set((h+d)/c,c/4,(f+p)/c,(g-a)/c)}else{let c=Math.sqrt(1+u-o-m)*2;return this.set((g+a)/c,(f+p)/c,c/4,(h-d)/c)}}rotationTo(t,e){let i=new l,s=new l(1,0,0),r=new l(0,1,0),n=t.dot(e);return n<-.999999?(i.copy(s),i.cross(t),i.length<1e-6&&i.copy(r).cross(t),i.normalize(),this.setAxisAngle(i,Math.PI),this):n>.999999?(this[0]=0,this[1]=0,this[2]=0,this[3]=1,this):(i.copy(t).cross(e),this[0]=i[0],this[1]=i[1],this[2]=i[2],this[3]=1+n,this.normalize())}setAxisAngle(t,e){e=e*.5;let i=Math.sin(e);return this[0]=i*t[0],this[1]=i*t[1],this[2]=i*t[2],this[3]=Math.cos(e),this}};var A=class{name="";matrix=new _;quaternion=new O(0,0,0,1);position=new l(0,0,0);scale=new l(1,1,1);children=[];isStatic=!0;parent=null;active=!0;_absoluteTransform=new _().set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);identity=!0;get absoluteTransform(){return this.parent?this.isStatic&&!this.identity?this._absoluteTransform:(this.identity=!0,this._absoluteTransform.copy(this.parent.matrix),this._absoluteTransform.multiply(this.matrix),this._absoluteTransform):this.matrix}renderer;setRenderer(t){this.renderer=t}addNode(...t){for(let e of t)this.children.push(e),e.parent=this,e.isStatic=this.isStatic,e.setRenderer(this.renderer)}removeNode(t){this.children.splice(t,1)}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale);for(let t of this.children)t.updateMatrix()}render2(t,e){let i={m:[],c:[]};if(!this.active)return i;for(let s=0;s<this.children.length;s++){let n=this.children[s].render2(t,e);n&&(i.m.push(...n.m),i.c.push(...n.c))}return i}update(t){this.children.forEach(e=>e.update(t))}};var K=class extends A{leftHand;rightHand;constructor(t){super(),this.name="scene",this.renderer=t}updateInputSources(t,e){for(let i of t.session.inputSources){let s=t.getPose(i.gripSpace,e);if(!s)continue;let r=s.transform.position,n=s.transform.orientation,o=i.gamepad?.buttons;i.handedness=="left"?(this.leftHand.position.set(r.x,r.y,r.z),this.leftHand.quaternion.set(n.x,n.y,n.z,n.w),this.leftHand.updateMatrix(),this.leftHand.triggerPressed=o?.[0].pressed??!1):(this.rightHand.position.set(r.x,r.y,r.z),this.rightHand.quaternion.set(n.x,n.y,n.z,n.w),this.rightHand.updateMatrix(),this.rightHand.triggerPressed=o?.[0].pressed??!1)}}update(t){this.children.forEach(e=>e.update(t))}render2(t,e){let i={m:[],c:[]},s=this.leftHand.render2(t,e);i.m.push(...s.m),i.c.push(...s.c);let r=this.rightHand.render2(t,e);i.m.push(...r.m),i.c.push(...r.c);for(let a=0;a<this.children.length;a++){let m=this.children[a].render2(t,e);m&&(i.m.push(...m.m),i.c.push(...m.c))}let n=[],o=i.m.length,h=new Float32Array(o*16);for(let a=0;a<o;++a){let d=i.m[a];h.set(d,a*16)}return this.renderer.draw2(i.c,h,o,t,e),i}};var z=class extends A{colorIndex=0;constructor(t){super(),this.name="mesh",this.colorIndex=t}render2(t,e){let i={m:[],c:[]};return this.active&&(i.m=[this.absoluteTransform],i.c=[this.colorIndex],this.children?.forEach(s=>{let r=s.render2(t,e);i.m.push(...r.m),i.c.push(...r.c)})),i}};var ct=[[[0,0,0],[.01,.01,.05],[0,0,0],[6]],[[0,.03,-.12],[.02,.02,.1],[v/16,0,0],[7]],[[0,.13,-.27],[.02,.02,.1],[v/8,0,0],[7]],[[0,.03,.12],[.02,.02,.1],[v-v/16,0,0],[7]],[[0,.13,.27],[.02,.02,.1],[v-v/8,0,0],[7]],[[0,.19,-.35],[.025,.025,.025],[0,0,0],[7]],[[0,.19,.35],[.025,.025,.025],[0,0,0],[7]],[[0,.19,0],[.004,.004,.01],[0,0,0],[8]],[[0,.19,0],[0,0,0],[0,0,0],[0]],[[0,.59,0],[0,0,0],[0,0,0],[0]]],B=[[[0,5,0],[2,5,2],[0,0,0],[9]],[[0,8,0],[2.1,1.2,.6],[0,0,0],[9]],[[0,8,0],[2.11,1,.4],[0,0,0],[0]],[[0,3,0],[.6,1.2,2.1],[0,0,0],[9]],[[0,3,0],[.4,1,2.11],[0,0,0],[0]],[[0,4.5,-1],[2.2,.4,.4],[0,0,0],[6]],[[-1,7.5,0],[.4,.4,2.2],[0,0,0],[6]],[[0,11.5,0],[2.5,1.5,2.5],[0,0,0],[9]],[[0,9.75,0],[2.4,.25,.4],[0,0,0],[9]],[[0,9.75,0],[.4,.25,2.4],[0,0,0],[9]],[[2,9.75,2],[.4,.25,.4],[0,0,0],[9]],[[-2,9.75,-2],[.4,.25,.4],[0,0,0],[9]],[[2,9.75,-2],[.4,.25,.4],[0,0,0],[9]],[[-2,9.75,2],[.4,.25,.4],[0,0,0],[9]],[[2,13.5,2],[.5,.5,.5],[0,0,0],[9]],[[-2,13.5,2],[.5,.5,.5],[0,0,0],[9]],[[2,13.5,-2],[.5,.5,.5],[0,0,0],[9]],[[-2,13.5,-2],[.5,.5,.5],[0,0,0],[9]],[[2,13.5,0],[.5,.5,.5],[0,0,0],[9]],[[-2,13.5,0],[.5,.5,.5],[0,0,0],[9]],[[0,13.5,2],[.5,.5,.5],[0,0,0],[9]],[[0,13.5,-2],[.5,.5,.5],[0,0,0],[9]]],lt=[[[0,2,0],[1,1,1],[0,0,0],[9]],[[0,4,.1],[.8,.75,1],[0,0,0],[4]],[[.75,0,0],[.25,1,.5],[0,0,0],[1]],[[-.75,0,0],[.25,1,.5],[0,0,0],[1]],[[0,4,0],[1.15,.75,1],[0,0,0],[9]],[[0,5.1,.2],[1,.35,1.15],[0,0,0],[9]],[[1.25,2,1],[.25,1,.5],[-v/8,0,0],[1]],[[-1.25,2,1],[.25,1,.5],[-v/8,0,0],[1]],[[-1.25,3.25,3.25],[.25,2,.25],[v/8,0,0],[9]],[[0,5.65,.1],[.6,.2,1.25],[0,0,0],[1]],[[.5,4.25,1.1],[.1,.1,.1],[0,0,0],[0]],[[-.5,4.25,1.1],[.1,.1,.1],[0,0,0],[0]],[[0,3.75,1.1],[.2,.1,.1],[0,0,0],[5]]],mt=[[[0,2,0],[1,1,1],[0,0,0],[9]],[[0,4,.1],[.8,.75,1],[0,0,0],[4]],[[.75,0,0],[.25,1,.5],[0,0,0],[1]],[[-.75,0,0],[.25,1,.5],[0,0,0],[1]],[[0,4,0],[1.15,.75,1],[0,0,0],[9]],[[0,5.1,.2],[1,.35,1.15],[0,0,0],[9]],[[1.25,2,1],[.25,1,.5],[-v/8,0,0],[1]],[[-1.25,2,1],[.25,1,.5],[-v/8,0,0],[1]],[[-1.25,3.25,3.25],[.25,2,.25],[v/8,0,0],[9]],[[0,5.65,.1],[.6,.2,1.25],[0,0,0],[1]],[[.5,4.25,1.1],[.1,.1,.1],[0,0,0],[0]],[[-.5,4.25,1.1],[.1,.1,.1],[0,0,0],[0]],[[0,3.75,1.1],[.2,.1,.1],[0,0,0],[5]],[[.75,2,2],[1.35,2,.25],[0,0,0],[9]],[[.1,3,2.25],[.55,.9,.05],[0,0,0],[5]],[[1.4,3,2.25],[.55,.9,.05],[0,0,0],[8]],[[.1,1.1,2.25],[.55,.9,.05],[0,0,0],[8]],[[1.4,1.1,2.25],[.55,.9,.05],[0,0,0],[5]]],dt=[[[0,2,0],[1,1,1],[0,0,0],[9]],[[0,4,.1],[.8,.75,1],[0,0,0],[4]],[[.75,0,0],[.25,1,.5],[0,0,0],[5]],[[-.75,0,0],[.25,1,.5],[0,0,0],[5]],[[0,4,0],[1.15,.75,1],[0,0,0],[9]],[[0,5.1,.2],[1,.35,1.15],[0,0,0],[9]],[[1.25,2,1],[.25,1,.5],[-v/8,0,0],[5]],[[-1.25,2,1],[.25,1,.5],[-v/8,0,0],[5]],[[-1.25,3.25,3.25],[.25,2,.25],[v/8,0,0],[9]],[[0,5.65,.1],[.6,.2,1.25],[0,0,0],[5]],[[.5,4.25,1.1],[.1,.1,.1],[0,0,0],[0]],[[-.5,4.25,1.1],[.1,.1,.1],[0,0,0],[0]],[[0,3.75,1.1],[.2,.1,.1],[0,0,0],[5]],[[0,6.3,-.8],[.1,.45,1.4],[0,0,0],[5]]],j=[[[-8,0,0],[16,5,5],[0,0,0],[9]],[[-8,5,-4.5],[16,1,.25],[0,0,0],[9]],[[-.5,6.25,-4.5],[.5,.25,.25],[0,0,0],[9]],[[-2.5,6.25,-4.5],[.5,.25,.25],[0,0,0],[9]],[[-4.5,6.25,-4.5],[.5,.25,.25],[0,0,0],[9]],[[-6.5,6.25,-4.5],[.5,.25,.25],[0,0,0],[9]],[[-8.5,6.25,-4.5],[.5,.25,.25],[0,0,0],[9]],[[-10.5,6.25,-4.5],[.5,.25,.25],[0,0,0],[9]],[[-12.5,6.25,-4.5],[.5,.25,.25],[0,0,0],[9]],[[-14.5,6.25,-4.5],[.5,.25,.25],[0,0,0],[9]],[[-16.5,6.25,-4.5],[.5,.25,.25],[0,0,0],[9]],[[-18.5,6.25,-4.5],[.5,.25,.25],[0,0,0],[9]],[[-20.5,6.25,-4.5],[.5,.25,.25],[0,0,0],[9]],[[-22.5,6.25,-4.5],[.5,.25,.25],[0,0,0],[9]],[[1.5,6.25,-4.5],[.5,.25,.25],[0,0,0],[9]],[[3.5,6.25,-4.5],[.5,.25,.25],[0,0,0],[9]],[[5.5,6.25,-4.5],[.5,.25,.25],[0,0,0],[9]],[[7.5,6.25,-4.5],[.5,.25,.25],[0,0,0],[9]]],ut=[[[0,.5,0],[.5,.5,.5],[0,0,0],[7]],[[0,3,0],[2,2,2],[0,0,0],[3]],[[0,7,0],[1.5,2,1.5],[0,0,0],[3]],[[0,11,0],[1,2,1],[0,0,0],[3]]],pt=[[[0,.25,0],[.25,.25,.25],[0,0,0],[7]],[[0,1.5,0],[1,1,1],[0,0,0],[3]]];var I=class{listeners=[];on(t){this.listeners.push(t)}emit(t){this.listeners.forEach(e=>e(t))}};var Z=class{bowHandPosition;bowHandOrientation;arrowHandPosition;state;readyToDraw=!1;drawDistance=0;onFire=new I;DRAW_FORCE_MULTIPLIER=65;constructor(){this.state=0,this.bowHandPosition=new l(0,0,0),this.bowHandOrientation=new O(0,0,0,1),this.arrowHandPosition=new l(0,0,0)}tempStringCenter=new l;tempVec1=new l;tempVec2=new l;tempDir=new l;tempPV=new l;tempClosestPoint=new l;update(t,e,i,s,r){switch(this.bowHandPosition=t.position,this.bowHandOrientation=t.orientation,this.arrowHandPosition=e.position,i.absoluteTransform.toVector3(this.tempStringCenter),this.arrowHandPosition.distanceTo(this.tempStringCenter)<.05?this.readyToDraw=!0:this.readyToDraw=!1,this.state){case 0:e.isGripping&&this.readyToDraw&&(this.state=1);break;case 1:if(e.isGripping){s.absoluteTransform.toVector3(this.tempVec1),r.absoluteTransform.toVector3(this.tempVec2);let n=e.position;this.tempDir.copy(this.tempVec2).sub(this.tempVec1),this.tempPV.copy(n).sub(this.tempVec1);let o=this.tempPV.dot(this.tempDir)/(this.tempDir.getLength()*this.tempDir.getLength());o=Math.max(0,Math.min(1,o)),this.tempClosestPoint.copy(this.tempVec1).lerp(this.tempVec2,o),this.drawDistance=this.tempClosestPoint.distanceTo(this.tempVec1)}else{if(this.state=0,this.drawDistance<.1){this.drawDistance=0;return}let n=this.calculateDirection(this.bowHandOrientation),o=this.drawDistance*this.DRAW_FORCE_MULTIPLIER;this.fireArrow(this.bowHandPosition,this.bowHandOrientation,n,o),this.drawDistance=0}break}}calculateDirection(t){let e=new l(0,-1,0);return e.applyQuaternion(t),e}calculateForce(t,e){return 0}fireArrow(t,e,i,s){this.onFire.emit(new it(t,e,i,s))}};var it=class{position;orientation;direction;force;constructor(t,e,i,s){this.position=t,this.orientation=e,this.direction=i,this.force=s}},bt=new l(0,-1,0),J=class extends z{velocity;constructor(t){super(t),this.isStatic=!1,this.scale.set(.01,.01,.4),this.position.set(0,-.4+.19,0),this.velocity=new l(0,0,0)}tempVector=new l;update(t){this.tempVector.copy(this.position),this.velocity.y-=9.8*t,this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.position.z+=this.velocity.z*t,this.quaternion.lookAt(this.tempVector,this.position,bt),this.position.y<-5&&(this.active=!1),super.update(t)}},G=class extends z{constructor(t){super(t),this.isStatic=!1}tempDiffVector=new l;tempDirVector=new l;recalculate(t,e){let i=t.position,s=e.position;this.tempDiffVector.copy(s),this.tempDiffVector.sub(i),this.tempDiffVector.multiply(.5);let r=this.tempDiffVector.getLength();this.scale.set(.003,.003,r),this.position.copy(this.tempDiffVector),this.position.add(i),this.tempDirVector.copy(this.tempDiffVector).normalize(),this.quaternion.rotationTo(new l(0,0,1),this.tempDirVector)}};var N=class extends A{onTrigger=new I;_triggerPressed=!1;handedness;get triggerPressed(){return this._triggerPressed}set triggerPressed(t){t!=this._triggerPressed&&(this.onTrigger.emit(t),this._triggerPressed=t)}constructor(t){super(),this.isStatic=!1,this.handedness=t}};var $=class extends A{jump=0;tempPos=new l;orgPos;random;isHit=!1;deathTimer=1;type;constructor(t){super(),this.random=Math.random()*Math.PI,this.type=t}hit(){return this.isHit?!1:this.type==2?(this.children.splice(this.children.length-5,5),this.type=1,!1):(this.children.forEach(t=>t.colorIndex=5),this.isHit=!0,!0)}update(t){if(this.isHit){this.active=!1;return}this.orgPos||(this.orgPos=new l(this.position.x,this.position.y,this.position.z)),this.jump+=t,this.tempPos.copy(this.position),this.tempPos.y=this.orgPos.y+Math.abs(Math.sin((this.jump+this.random)*8)*.5),this.type!=3?(this.tempPos.x=this.orgPos.x+Math.sin(this.jump*1)*4,this.tempPos.z=this.orgPos.z+this.jump):this.tempPos.z=this.orgPos.z+this.jump*2,this.position.set(this.tempPos.x,this.tempPos.y,this.tempPos.z),this.children.forEach(e=>e.update(t))}};var ft={shoot:0},st=class{initialized;currentSfxIndex;audiopool;audioContext;sounds;constructor(){this.initialized=!1,this.currentSfxIndex=0,this.audiopool=[]}initAudio(){if(this.audioContext)return;this.initialized=!0,this.sounds=[new Audio("data:audio/wav;base64,UklGRu4BAABXQVZFZm10IBAAAAABAAEAuAsAALgLAAABAAgAZGF0YXcBAACAgICAgICBgICAf3+AgICAgYGAgH9/foCBgICBgH9/gYKCgYB/f4GBgH9+foCDhIF/fX2AgoKAfoCCgX58foKFg316fYOGhX97f4WEfnt+goKAfn6AgoOEhIF6eHuDjol1b3iFjIN2eX95doKRkHtvgJOEZ2qIlIN1fol+bnuYlnhxj56CZ3eNe22Flox7dYiahGiArJxrdJh+Tmmhil+Cs5hldpiJcXF6g4N2b36IeHGCiISFfXqAeXN+h4eHf3V3hpKKd219ko52b4CFcGmCmpF1aHeOkIJ8hIV3bHeNmIlxbX+PjX90dYCJhHt9iIh/fX59goaCgoOAf359goiEfXt9goWEgX5+gYGAf4CBgYGAfX6BgoGCgH1/gYB/gIGBgoF/gYKAfn9/f4GCf35/f4CCgoB+foCBgoKAfX1/gYGBf35/gYKBgX9+f4GCgoGAfn+AgoKAgH9/f4CBgH9/gIGBgYB/fn+BgYGAf39/gIGBgYCAf4AATElTVEoAAABJTkZPSUNSRAsAAAAyMDIzLTA5LTA0AABJRU5HDAAAAFRpbW15IEtva2tlAElTRlQVAAAAU291bmQgRm9yZ2UgUHJvIDExLjAAAg==")],this.audioContext=new AudioContext({sampleRate:3e3}),this.audioContext.listener.upY.value=1;let t=this.audioContext.createGain();t.gain.value=1.5,t.connect(this.audioContext.destination);for(let e=0;e<25;e++){let i=new Audio;this.audiopool.push(i),this.audioContext.createMediaElementSource(i).connect(t)}}playSound(t,e){this.audioContext&&(this.audiopool[this.currentSfxIndex].src=this.sounds[t].src,this.audiopool[this.currentSfxIndex].play(),this.currentSfxIndex=(this.currentSfxIndex+1)%25)}},rt=new st;var gt=40,ce=new l,q=class extends A{lifetime=2;velocities=[];constructor(){super()}initialize(){let t=[];for(let e=0;e<gt;e++){let i=new z(5),s=Math.random()*.1+.1;i.scale.set(s,s,s),i.position.set(Math.random()-.5,Math.random()*2,Math.random()-.5),t.push(i),this.velocities.push(new l((Math.random()-.5)*3,Math.random()*5,(Math.random()-.5)*3))}this.addNode(...t)}update(t){this.lifetime-=t,this.lifetime<=0&&(this.active=!1);for(let e=0;e<gt;e++)this.velocities[e].y-=9.8*t,this.children[e].position.x+=this.velocities[e].x*t,this.children[e].position.y+=this.velocities[e].y*t,this.children[e].position.z+=this.velocities[e].z*t}};var tt=20,et=class{xrButton;xrRefSpace;xrSession;gl;renderer;cube;scene;bow;stringPart1;stringPart2;placedArrow;arrowList=[];army=[];battlefield;particleParent;currentwave=-1;currentScore=0;accumulatedTime=tt;webglCanvas;constructor(){this.webglCanvas=document.createElement("canvas"),this.gl=this.webglCanvas.getContext("webgl2",{xrCompatible:!0,alpha:!1}),this.renderer=new Y(this.gl),this.renderer.depthTesting(!0),this.initXR()}initXR(){this.xrButton=document.getElementById("xr-button"),navigator.xr&&navigator.xr.isSessionSupported("immersive-vr").then(t=>{this.xrButton.innerText=t?"Enter VR":"VR not available",t&&this.xrButton.addEventListener("click",this.onRequestSession.bind(this))})}onRequestSession(){return navigator.xr.requestSession("immersive-vr").then(this.onSessionStarted.bind(this))}onSessionStarted(t){t.addEventListener("end",this.onSessionEnded.bind(this)),rt.initAudio(),this.xrSession=t,this.xrSession.addEventListener("end",this.onSessionEnded.bind(this)),this.xrSession.updateRenderState({baseLayer:new XRWebGLLayer(this.xrSession,this.gl)}),this.currentwave=0,this.currentScore=0,this.accumulatedTime=tt-3,this.army=[],this.prevTime=null,this.createScene(),t.updateRenderState({baseLayer:new XRWebGLLayer(t,this.gl)}),t.requestReferenceSpace("local").then(e=>{let i=new XRRigidTransform({y:-1.6});this.xrRefSpace=e.getOffsetReferenceSpace(i),t.requestAnimationFrame(this.onXRFrame.bind(this))})}createScene(){this.scene=new K(this.renderer);let t=new z(3);t.scale.set(150,.1,150),t.position.set(0,-5,0),this.scene.addNode(t),this.battlefield=new A,this.battlefield.name="battlefield",this.battlefield.position.set(0,-5,0),this.scene.addNode(this.battlefield),this.scene.leftHand=new N("left"),this.scene.leftHand.setRenderer(this.renderer);let e=this.getModel(ct);this.scene.rightHand=new N("right"),this.scene.rightHand.setRenderer(this.renderer);let i=new z(8);i.scale.set(.01,.01,.01),this.scene.rightHand.addNode(i),this.bow=new Z,this.bow.onFire.on(s=>this.spawnArrow(s)),this.stringPart1=new G(0),this.stringPart1.scale.set(.003,.003,.1),this.stringPart2=new G(0),this.stringPart2.scale.set(.003,.003,.1),this.placedArrow=new z(7),this.placedArrow.scale.set(.005,.4,.005),this.placedArrow.position.set(0,-.4+.19,0),this.scene.leftHand.addNode(...e,this.stringPart1,this.stringPart2,this.placedArrow),this.addObjectToScene(j,[8,-5.3,4]),this.addObjectToScene(j,[8,-1.3,8]),this.addObjectToScene(j,[-12,-5.35,8]).quaternion.fromEuler(0,Math.PI/4,0),this.addObjectToScene(j,[12,-5.35,23]).quaternion.fromEuler(0,-Math.PI/4,0),this.addObjectToScene(B,[-15,-2,-2]),this.addObjectToScene(B,[15,-2,-2]),this.addObjectToScene(B,[-12,-.5,4.5]),this.addObjectToScene(B,[12,-.5,4.5]),this.addObjectToScene(B,[0,3,6]),this.particleParent=new A,this.scene.addNode(this.particleParent);for(let s=0;s<100;s++){let r=s*2+Math.random()-.5,n=Math.sin(s/100*Math.PI);this.addObjectToScene(ut,[100-r,-5,-Math.random()*20-n*50]).scale.set(1,Math.random()+1,1)}for(let s=0;s<25;s++){let r=s*2+Math.random()-.5,n=-Math.random()*50,o=Math.random()*.5+.1;this.addObjectToScene(pt,[25-r,-4.5,n]).scale.set(o,o,o)}}onSessionEnded(t){this.xrSession=void 0}prevTime=null;onXRFrame(t,e){let i=e.session;if(this.prevTime===null){this.prevTime=t,i.requestAnimationFrame(this.onXRFrame.bind(this));return}let s=(t-this.prevTime)/1e3;this.prevTime=t,i.requestAnimationFrame(this.onXRFrame.bind(this));let r=e.getViewerPose(this.xrRefSpace);if(this.checkKnightHits(),this.knightFrameUpdate(s),this.deleteInactiveArrows(),this.deleteInactiveKnights(),this.deleteInactiveParticles(),this.scene.update(s),r){let n=i.renderState.baseLayer;this.gl.bindFramebuffer(F.FRAMEBUFFER,n.framebuffer),this.gl.clear(F.COLOR_BUFFER_BIT|F.DEPTH_BUFFER_BIT),this.renderer.clear([.5,.8,1,1]),this.scene.updateInputSources(e,this.xrRefSpace),this.bow.update({orientation:this.scene.leftHand.quaternion,position:this.scene.leftHand.position,isGripping:this.scene.leftHand.triggerPressed},{orientation:this.scene.rightHand.quaternion,position:this.scene.rightHand.position,isGripping:this.scene.rightHand.triggerPressed},this.scene.leftHand.children[7],this.scene.leftHand.children[8],this.scene.leftHand.children[9]),this.stringPart1.recalculate(this.scene.leftHand.children[5],this.scene.leftHand.children[7]),this.stringPart2.recalculate(this.scene.leftHand.children[6],this.scene.leftHand.children[7]),this.bow.state==1?(this.placedArrow.position.set(0,-.4+.19+this.bow.drawDistance,0),this.placedArrow.active=!0):this.bow.state==0&&(this.placedArrow.active=!1),this.scene.leftHand.children[7].position.set(0,.19+this.bow.drawDistance,0),this.scene.updateMatrix();for(let o of r.views){let h=n.getViewport(o);this.gl.viewport(h.x,h.y,h.width,h.height),this.scene.render2(o.projectionMatrix,o.transform)}}this.checkKnightsReachedCastle()}checkKnightsReachedCastle(){if(this.knightReachedCastle()){this.xrSession.end().then(()=>{let t=document.querySelector(".title.normal");t.style.display="none";let e=document.querySelector(".game-over");e.style.display="block";let i=document.querySelector(".score-container");i.style.display="block",document.getElementById("score").innerText=`${this.currentScore}`,this.xrSession=void 0});return}}deleteInactiveArrows(){this.arrowList.forEach(t=>{t.active||this.arrowList.splice(this.arrowList.indexOf(t),1)})}deleteInactiveKnights(){this.army.forEach(t=>{t.active||this.army.splice(this.army.indexOf(t),1)})}deleteInactiveParticles(){this.particleParent?.children.forEach(t=>{t.active||this.particleParent?.children.splice(this.particleParent?.children.indexOf(t),1)})}tempVec=new l;checkKnightHits(){this.army.forEach(t=>{this.tempVec.copy(t.position),this.tempVec.y+=2,this.tempVec.z+=1,this.arrowList.filter(e=>e.active).forEach(e=>{if(e.position.distanceTo(this.tempVec)<1.5){if(e.active=!1,this.arrowList.splice(this.arrowList.indexOf(e),1),t.hit()){this.currentScore++;let i=new q;i.position.copy(t.position),this.particleParent.addNode(i),i.initialize()}return}})})}getModel(t){return t.map(e=>{let i=new z(e[3][0]);return i.scale.set(...e[1]),i.position.set(...e[0]),i.quaternion.fromEuler(...e[2]),i})}spawnArrow(t){rt.playSound(ft.shoot);let e=new J(7);this.arrowList.push(e),this.scene.addNode(e),e.position.copy(t.position),e.quaternion.copy(t.orientation),e.velocity.copy(t.direction).multiply(t.force),e.isStatic=!1}spawnKnight(t,e,i){let s=new $(i);switch(s.isStatic=!1,s.setRenderer(this.renderer),i){case 1:s.addNode(...this.getModel(lt));break;case 2:s.addNode(...this.getModel(mt));break;case 3:s.addNode(...this.getModel(dt));break}s.position.set(8-t*2,.25-5,-40-e*2),s.scale.set(.4,.4,.4),this.army.push(s),this.battlefield.addNode(s)}knightReachedCastle(){return this.army.some(t=>t.position.z>-1)}addObjectToScene(t,e){let i=new A;return i.setRenderer(this.renderer),i.addNode(...this.getModel(t)),i.position.set(...e),this.scene.addNode(i),i}knightFrameUpdate(t){if(this.accumulatedTime+=t,this.accumulatedTime>=tt){let e=nt[this.currentwave];for(let i=0;i<e.length;i++){let s=parseInt(e[i],16);if(isNaN(s))continue;let r=at[s].split(`
`).map(o=>[...o].map(h=>parseInt(h,16)));i==0&&(r=r.map(o=>o.reverse()));let n=i==0?-8:i==2?9:0;for(let o=0;o<r.length;o++)for(let h=0;h<r[o].length;h++)if(!isNaN(r[o][h])){let a=r[o][h];this.spawnKnight(h-n,o,a)}}this.currentwave++,this.accumulatedTime-=tt}}};new et;
</script>