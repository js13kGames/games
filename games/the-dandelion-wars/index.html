<title>The Dandelion Wars - js13kGames 2024</title><style>body{margin:0;background:#000;font-family:Courier}canvas{display:block}.b{border:5px solid #ccc}.u{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);margin-right:-33%;font-size:1.3em;color:#fff;background:rgba(0,0,0,.6);max-width:50%;padding:1em;box-sizing:border-box;overflow:auto;text-align:center}.c{display:block;margin:0 auto;font-size:1em;padding:1em 2em;margin-top:1em;border:1px solid #fff;background:rgba(0,0,0,.5);color:#aaa;font-weight:700;font-family:Courier}#p{display:none}h1{margin-top:0}</style><div id=s class="b u"><h1>The Dandelion Wars</h1><p>In a world besieged by aliens, the last defense lies in an unexpected weapon: dandelions.<p>Harness their power using remote reality and defend with weaponized seeds.<p>Beware! The aliens have hacked some dandelions with 13 seeds into deadly traps. With every breath Earth hangs in the balance. Avoid the cursed 13 & fight!</p><button id=b class=c>Engage</button></div><div id=p class="b u">Pause</div><script type=module>import*as e from"/2024/webxr/three.js";var t={34:e=>{e.exports="void main(){vec2 A=gl_FragCoord.xy/resolution.xy;vec4 B=texture2D(tP,A);vec4 C=texture2D(tV,A);gl_FragColor=vec4(B.x,B.w,C.x,C.w);}"},883:e=>{e.exports="#define A  (1.0/60.0)\nvoid main(){vec2 B=gl_FragCoord.xy/resolution.xy;vec4 C=texture2D(tP,B);vec3 D=C.xyz;float E=C.w;vec4 F=texture2D(tV,B);vec3 G=F.xyz;float H=F.w;if(H==0.){G=vec3(0.);}if(E>0.5){D+=G*A;}gl_FragColor=vec4(D,E);}"},118:e=>{e.exports="float A=1./60.;uniform float d;const float B=resolution.x;const float C=resolution.y;bool D(float E,float F){return abs(E-F)<0.01;}vec2 G(float H){float sign=sign(H);float I=abs(H);float E=floor(I/10.)/1000.;float F=sign*mod(I,10.);return vec2(E,F);}float J(float E,float F){return sign(F)*(floor(E*1000.)*10.+abs(F));}void main(){float K=100.*(d+1.);vec2 L=gl_FragCoord.xy/resolution.xy;float M=L.y*resolution.x+L.x;vec4 N=texture2D(tP,L);vec3 O=N.xyz;float P=N.w;vec4 Q=texture2D(tV,L);vec3 R=Q.xyz;float S=1.;vec2 T=G(Q.w);float U=T.y;float V=T.x;float W=4.;if(D(U,0.5078)){A=0.1/60.;W=0.5;}if(U>0.){vec3 X=vec3(0.);for(float Y=0.;Y<C;Y++){for(float Z=0.;Z<B;Z++){vec2 a=vec2(Z+0.5,Y+0.5)/resolution.xy;vec4 b=texture2D(tP,a);vec3 c=b.xyz;vec4 d=texture2D(tV,a);vec3 e=d.xyz;vec2 T=G(d.w);float f=T.y;float g=T.x;float h=a.y*resolution.x+a.x;if(M==h){continue;}if(f==0.){continue;}vec3 i=c-O;float j=length(i);if(j==0.){continue;}float k=b.w;float l=j*j;if(D(P,0.6)&&D(h,V)){S=min(1.,l/100.);}if(j<.5&&D(P,0.6)&&D(h,U)&&D(V,0.5234)){R=vec3(0);gl_FragColor=vec4(R,-U-1e5);return;}if(j<.5&&D(P,0.6)&&D(h,U)){R=vec3(0);gl_FragColor=vec4(R,-U);return;}if(D(P,0.6)&&D(k,0.6)){float m=(-0.4)/(l);X+=m*normalize(i);}else if(D(P,0.6)&&D(h,U)){float n=K*f/j;X+=n*normalize(i);}else if(D(P,0.6)&&D(k,0.1)){float o=-0.2*K*f/(l*l);}}}R+=A*X*S;if(length(R)>0.){R=normalize(R)*min(length(R),W);}}else{gl_FragColor=vec4(0);return;}gl_FragColor=vec4(R,J(V,U));}"},157:e=>{e.exports="attribute vec2 offset;attribute float random;uniform float time;varying vec2 vUv;float A=3.14159;float B(vec2 C){return fract(sin(dot(C,vec2(12.9898,78.233)))*43758.5453);}vec3 D(vec3 E){return mod(((E*34.)+1.)*E,289.);}float F(vec2 G){const vec4 H=vec4(0.211324865405187,0.366025403784439,-0.577350269189626,0.024390243902439);vec2 I=floor(G+dot(G,H.yy));vec2 J=G-I+dot(I,H.xx);vec2 K;K=(J.x>J.y)?vec2(1.,0.):vec2(0.,1.);vec4 L=J.xyxy+H.xxzz;L.xy-=K;I=mod(I,289.);vec3 C=D(D(I.y+vec3(0.,K.y,1.))+I.x+vec3(0.,K.x,1.));vec3 M=max(0.5-vec3(dot(J,J),dot(L.xy,L.xy),dot(L.zw,L.zw)),0.);M=M*M;M=M*M;vec3 E=2.*fract(C*H.www)-1.;vec3 N=abs(E)-0.5;vec3 O=floor(E+0.5);vec3 P=E-O;M*=1.79284291400159-0.85373472095314*(P*P+N*N);vec3 Q;Q.x=P.x*J.x+N.x*J.y;Q.yz=P.yz*L.xz+N.yz*L.yw;return 130.*dot(M,Q);}void main(){vUv=uv;vec3 R=position;vec2 S=offset;float T=sin(S.x/10.-A/2.)*cos(S.y/10.)*5.+5.;float U=B(offset)*3.14159*2.;mat2 V=mat2(cos(U),-sin(U),sin(U),cos(U));R.xz=V*R.xz;R.xz+=S;R.y+=T+0.5;float W=0.3;float X=1.5;float Y=F(vec2(offset.x*0.1+time*0.2,offset.y*0.1))*0.5+0.5;float Z=sin(time*X+Y*6.28)*W;float a=smoothstep(0.,0.6,position.y);R.x+=Z*a;float b=0.2;R.z-=b*pow(position.y,2.)*Z;vec4 c=modelViewMatrix*vec4(R,1.);gl_Position=projectionMatrix*c;}"},141:e=>{e.exports="varying vec4 vColor;varying vec4 vPosition;varying vec4 vVelocity;varying float vEnemy;varying vec3 vViewPosition;void main(){vec3 A=dFdx(vViewPosition);vec3 B=dFdy(vViewPosition);vec3 C=normalize(cross(A,B));float D=clamp(vPosition.z/10.,0.,0.9);float E=vColor.g*0.5+0.4*min(length(vVelocity.xz),1.5)*(1.-D);float F=vColor.r*0.5+0.4*min(length(vVelocity.xy),1.5)*(1.-D);vec3 G=vColor.rgb;vec3 H=normalize(vec3(0.,-0.4472,-0.8944));H=normalize((viewMatrix*vec4(H,0.)).xyz);vec3 I=normalize(-vViewPosition);vec3 J=vec3(0.7,0.7,0.7);vec3 K=J*G;vec3 L=vec3(1.,1.,1.);float M=0.5;float N=max(dot(C,H),0.);vec3 O=L*M*N*G;vec3 P=K+O;gl_FragColor=vec4(P,1.);}"},448:e=>{e.exports="uniform sampler2D tP;uniform sampler2D tV;uniform vec3 pC;uniform vec3 eC;attribute vec2 dtUv;varying vec4 vColor;varying vec4 vPosition;varying vec4 vVelocity;varying float vEnemy;varying vec3 vViewPosition;bool A(float B,float C,float D){return abs(B-C)<D;}vec2 E(float F){float sign=sign(F);float G=abs(F);float B=floor(G/10.)/1000.;float C=sign*mod(G,10.);return vec2(B,C);}mat3 H(vec3 I){vec3 J=vec3(0.,0.,1.);vec3 K=normalize(cross(I,J));vec3 L=cross(K,I);return mat3(-K,L,-I);}void main(){vec4 M=texture2D(tP,dtUv);vec3 N=M.xyz;vec4 O=texture2D(tV,dtUv);vec3 P=O.xyz;vec2 Q=E(O.w);if(A(Q.x,0.52343,0.01)){vColor=vec4(eC,1.);}else if(A(M.w,0.600,0.0001)){vColor=vec4(pC,1.);vEnemy=0.;}else if(A(M.w,0.601,0.0001)){vColor=vec4(eC,1.);vEnemy=1.;}else{vColor=vec4(1.,1.,0.,0.);}vVelocity=O;vec3 R=mat3(modelMatrix)*position;if(vEnemy>0.5){R*=2.;}mat3 S=H(normalize(P));R=S*R;R+=N;vec4 T=modelViewMatrix*(vec4(position,1.)+vec4(N,1.));gl_Position=projectionMatrix*viewMatrix*vec4(R,1.);vPosition=gl_Position;vViewPosition=-T.xyz;}"},751:e=>{e.exports="uniform sampler2D t;uniform sampler2D m;varying float l;varying vec3 c;varying vec2 u;varying float i;uniform float time;void main(){int A=int(floor(mod(u.x*l,128.)));vec2 B=vec2(float(A)/float(128.),i/float(1024.));float C=texture2D(m,B).r*255.;float D=floor(C/8.);float E=mod(C,8.);vec2 F;float G=64./512.;highp float H=(64./512.);float I=(u.x*H*l)/1.6;float J=(-u.y*0.11);float K=mod(I,H/1.6);float L=mod(J,G);F.x=((E*H)+K);F.y=(1.-D*G)-L;vec4 M=texture2D(t,F);if(M.a<0.2||K<0.004||K>0.99*H||L<0.01||L>0.99*G){discard;}else{gl_FragColor=M*vec4(c,1.);}}"},449:e=>{e.exports="attribute float length;attribute float instance;varying vec2 u;varying vec3 c;varying float l;varying float i;void main(){u=uv;l=length;\n#ifdef USE_INSTANCING_COLOR\nc=instanceColor;\n#endif\ni=instance;gl_Position=projectionMatrix*modelViewMatrix*instanceMatrix*vec4(position,1.);}"}},n={};function o(e){var a=n[e];return void 0===a&&(a=n[e]={exports:{}},t[e](a,a.exports,o)),a.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{o.d(t={},{AmbientLight:()=>e.AmbientLight,AudioListener:()=>e.AudioListener,BackSide:()=>e.BackSide,BoxGeometry:()=>e.BoxGeometry,Camera:()=>e.Camera,CanvasTexture:()=>e.CanvasTexture,CapsuleGeometry:()=>e.CapsuleGeometry,ClampToEdgeWrapping:()=>e.ClampToEdgeWrapping,Color:()=>e.Color,CylinderGeometry:()=>e.CylinderGeometry,DataTexture:()=>e.DataTexture,DirectionalLight:()=>e.DirectionalLight,DoubleSide:()=>e.DoubleSide,FloatType:()=>e.FloatType,Group:()=>e.Group,InstancedBufferAttribute:()=>e.InstancedBufferAttribute,InstancedBufferGeometry:()=>e.InstancedBufferGeometry,InstancedMesh:()=>e.InstancedMesh,LatheGeometry:()=>e.LatheGeometry,Matrix4:()=>e.Matrix4,Mesh:()=>e.Mesh,MeshBasicMaterial:()=>e.MeshBasicMaterial,MeshPhongMaterial:()=>e.MeshPhongMaterial,MeshStandardMaterial:()=>e.MeshStandardMaterial,NearestFilter:()=>e.NearestFilter,Object3D:()=>e.Object3D,OctahedronGeometry:()=>e.OctahedronGeometry,PerspectiveCamera:()=>e.PerspectiveCamera,PlaneGeometry:()=>e.PlaneGeometry,PositionalAudio:()=>e.PositionalAudio,Quaternion:()=>e.Quaternion,RGBAFormat:()=>e.RGBAFormat,Raycaster:()=>e.Raycaster,RedFormat:()=>e.RedFormat,Scene:()=>e.Scene,ShaderMaterial:()=>e.ShaderMaterial,SphereGeometry:()=>e.SphereGeometry,Vector2:()=>e.Vector2,Vector3:()=>e.Vector3,WebGLRenderTarget:()=>e.WebGLRenderTarget,WebGLRenderer:()=>e.WebGLRenderer});const G=t;class g{constructor(e){this.renderer=e,this.currentSession=null}startSession(){return e=this,s=function*(){if(null===this.currentSession)try{if(!navigator.xr)throw new Error("!WebXR");var e=yield navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]});yield this.renderer.xr.setSession(e),this.currentSession=e}catch(e){}else this.currentSession.end()},o=void 0,new(o=Promise)(function(n,t){function a(e){try{i(s.next(e))}catch(e){t(e)}}function r(e){try{i(s.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(a,r)}i((s=s.apply(e,[])).next())});var e,o,s}endSession(){this.currentSession&&(this.currentSession.end(),this.currentSession=null)}}var t=o(449),a=o.n(t),r=(t=o(751),o.n(t));const l={A:[[,1],[1,,1],[1,,1],[1,1,1],[1,,1]],B:[[1,1],[1,,1],[1,1],[1,,1],[1,1]],C:[[,1,1],[1],[1],[1],[,1,1]],D:[[1,1],[1,,1],[1,,1],[1,,1],[1,1]],E:[[1,1,1],[1],[1,1],[1],[1,1,1]],F:[[1,1,1],[1],[1,1],[1],[1]],G:[[,1,1],[1],[1,,1,1],[1,,,1],[,1,1]],H:[[1,,1],[1,,1],[1,1,1],[1,,1],[1,,1]],I:[[1,1,1],[,1],[,1],[,1],[1,1,1]],J:[[,,1],[,,1],[,,1],[1,,1],[,1]],K:[[1,,1],[1,,1],[1,1],[1,,1],[1,,1]],L:[[1],[1],[1],[1],[1,1,1]],M:[[1,,,1],[1,1,1,1],[1,,,1],[1,,,1],[1,,,1]],N:[[1,,,1],[1,1,,1],[1,,1,1],[1,,,1],[1,,,1]],O:[[,1],[1,,1],[1,,1],[1,,1],[,1]],P:[[1,1],[1,,1],[1,1],[1],[1]],Q:[[,1],[1,,1],[1,,1],[1,,1],[,1,,1]],R:[[1,1],[1,,1],[1,1],[1,,1],[1,,1]],S:[[,1,1],[1],[,1],[,,1],[1,1]],T:[[1,1,1],[,1],[,1],[,1],[,1]],U:[[1,,1],[1,,1],[1,,1],[1,,1],[,1]],V:[[1,,1],[1,,1],[1,,1],[1,,1],[,1]],W:[[1,,,1],[1,,,1],[1,,,1],[1,1,1,1],[,1,1]],X:[[1,,1],[1,,1],[,1],[1,,1],[1,,1]],Y:[[1,,1],[1,,1],[,1],[,1],[,1]],Z:[[1,1,1],[,,1],[,1],[1],[1,1,1]],0:[[,1],[1,,1],[1,,1],[1,,1],[,1]],"|":[[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1]],1:[[,1],[1,1],[,1],[,1],[1,1,1]],2:[[,1],[1,,1],[,,1],[,1],[1,1,1]],3:[[1,1],[,,1],[,1,1],[,,1],[1,1]],4:[[1,,1],[1,,1],[1,1,1],[,,1],[,,1]],5:[[1,1,1],[1],[1,1],[,,1],[1,1]],6:[[,1,1],[1],[1,1,1],[1,,1],[,1]],7:[[1,1,1],[,,1],[,1],[,1],[,1]],8:[[,1],[1,,1],[,1],[1,,1],[,1]],9:[[,1],[1,,1],[,1,1],[,,1],[,1]]};class y{constructor(e,t,n){this._pool=[],this._characters=e||" ABCDEFGHIJKLMNOPQRSTUVWXYZ0|123456789",this._maxCharsPerInstance=t||128,this._maxInstances=n||1024,this._texture=this.generateTexture(),this._dummies=[],this._scales=[],this._instanceCount=0,this._lengthsBuffer=new G.InstancedBufferAttribute(new Float32Array(this._maxInstances),1),this._instanceBuffer=new G.InstancedBufferAttribute(new Float32Array(this._maxInstances),1),this._maxCharsPerInstance=128,this._data=new Uint8Array(this._maxCharsPerInstance*this._maxInstances),this._messagesTexture=new G.DataTexture(this._data,this._maxCharsPerInstance,this._maxInstances,G.RedFormat),this._folCamRot=[],this._folCam=[],this._dummy=new G.Object3D,this._tempQuat=new G.Quaternion,this._tempQuat2=new G.Quaternion,this.cameraRotation=0,(e=new G.ShaderMaterial({uniforms:{t:{value:this._texture},m:{value:this._messagesTexture},time:{value:0}},vertexShader:a(),fragmentShader:r(),depthWrite:!0})).transparent=!0,e.side=G.DoubleSide,e.vertexColors=!0,(t=new G.PlaneGeometry(1,.1)).setAttribute("length",this._lengthsBuffer),t.setAttribute("instance",this._instanceBuffer),this.instancedMesh=new G.InstancedMesh(t,e,this._maxInstances),this.instancedMesh.frustumCulled=!1,this.instancedMesh.onBeforeRender=(e,t,n,a,r,i)=>{if(n.matrixWorld.decompose(this._dummy.position,this._dummy.quaternion,this._dummy.scale),0<this._folCamRot.length)for(let e=0;e<this._folCamRot.length;e++)this._dummies[this._folCamRot[e]].quaternion.copy(this._dummy.quaternion),this.updateMatrix(this._folCamRot[e]);if(0<this._folCam.length)for(let e=0;e<this._folCam.length;e++){const t=new G.Vector3(this._folCam[e].x,this._folCam[e].y,this._folCam[e].z);t.applyQuaternion(this._dummy.quaternion),this._dummies[this._folCam[e].instanceId].position.copy(this._dummy.position).add(t),this._dummies[this._folCam[e].instanceId].quaternion.copy(this._dummy.quaternion),this.updateMatrix(this._folCam[e].instanceId)}}}generateTexture(){var e=document.createElement("canvas"),t=(e.width=512,e.height=512,e.getContext("2d"));if(!t)throw new Error;t.textAlign="center";for(let e=0;e<this._characters.length;e++){const G=e%8*64+1,s=64*Math.floor(e/8)+1;var n,a=void 0,r=(a=t,this._characters[e]),i=G,o=s;if(n=l[r])for(let t=0;t<n.length;t++)for(let e=0;e<n[t].length;e++)n[t][e]&&(a.fillStyle="white",a.fillRect(i+8*e,o+8*t+5,8,8))}const s=new G.CanvasTexture(e);return s.magFilter=G.NearestFilter,s.minFilter=G.NearestFilter,s}updateMessageTexture(t,n){for(let e=0;e<n.length;e++){var a=this._characters.indexOf(n[e].toUpperCase());-1!==a&&(this._data[t*this._maxCharsPerInstance+e]=a)}this._lengthsBuffer.setX(t,n.length),this._lengthsBuffer.needsUpdate=!0;var e=this._scales[t]||1;this.setScale(t,n.length*e/10,e,1),this._messagesTexture.needsUpdate=!0,this.instancedMesh.material.uniforms.time.value=performance.now()/1e3,this.instancedMesh.material.needsUpdate=!0}addText(e,t,n,a){let r=this._instanceCount,i=this._pool.pop();return void 0!==i?r=i:this._instanceCount++,this._instanceCount>=this._maxInstances?null:(this.instancedMesh.count=this._instanceCount,this._dummies[r]=new G.Object3D,this.updateMessageTexture(r,e),this._instanceBuffer.setX(r,r),this._instanceBuffer.needsUpdate=!0,t&&this.setColor(r,t),n&&this._folCamRot.push(r),a&&this._folCam.push({instanceId:r,x:a[0],y:a[1],z:a[2]}),{setPosition:(e,t,n)=>{this.setPosition(r,e,t,n)},updateText:(e,t)=>{this.updateMessageTexture(r,e),t&&this.setColor(r,t)},remove:()=>{this.updateMessageTexture(r,""),this._pool.push(r)},setScale:e=>{this.setScale(r,e,e,e),this._scales[r]=e},instancedMesh:this.instancedMesh,instanceId:r})}setColor(e,t){this.instancedMesh.setColorAt(e,t),this.instancedMesh.instanceColor&&(this.instancedMesh.instanceColor.needsUpdate=!0)}setScale(e,t,n,a){this._dummies[e].scale.set(t,n,a),this.updateMatrix(e)}setPosition(e,t,n,a){this._dummies[e].position.set(t,n,a),this.updateMatrix(e)}setRotation(e,t){this._dummies[e].setRotationFromQuaternion(t),this.updateMatrix(e)}updateMatrix(e,t){t?this._dummies[e].matrix.copy(t):this._dummies[e].updateMatrix(),this.instancedMesh.setMatrixAt(e,this._dummies[e].matrix),this.instancedMesh.instanceMatrix.needsUpdate=!0}}function m(e,o,s,l){return new(s=s||Promise)(function(n,t){function a(e){try{i(l.next(e))}catch(e){t(e)}}function r(e){try{i(l.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(a,r)}i((l=l.apply(e,o||[])).next())})}class w{constructor(o,s,l){this._variables=[],this._currentTextureIndex=0;const c=G.FloatType,u=new G.Scene,d=new G.Camera,n=(d.position.z=1,{passThruTexture:{value:null}}),h=r("uniform sampler2D passThruTexture; void main(){vec2 uv = gl_FragCoord.xy/resolution.xy;gl_FragColor=texture2D(passThruTexture,uv);}",n),f=new G.Mesh(new G.PlaneGeometry(2,2),h);function a(e){e.defines.resolution="vec2( "+o.toFixed(1)+", "+s.toFixed(1)+" )"}function r(e,t){return t=t||{},a(t=new G.ShaderMaterial({name:"GPUComputationShader",uniforms:t,vertexShader:"void main(){gl_Position=vec4(position,1.0);}",fragmentShader:e})),t}u.add(f),this.addVariable=function(e,t,n,a){return e={name:e,initialValueTexture:n,material:r(t),dependencies:null,renderTargets:[],wrapS:null,wrapT:null,minFilter:G.NearestFilter,magFilter:G.NearestFilter,buffer:a},this._variables.push(e),e},this.setVariableDependencies=function(e,t){e.dependencies=t},this.init=function(){if(!1===l.capabilities.isWebGL2&&!1===l.extensions.has("OES_texture_float"))return"!OES_texture_float";if(0===l.capabilities.maxVertexTextures)return"!vertexShaderTex";for(let e=0;e<this._variables.length;e++){var n=this._variables[e],t=(n.renderTargets[0]=this.createRenderTarget(o,s,n.wrapS,n.wrapT,n.minFilter,n.magFilter),n.renderTargets[1]=this.createRenderTarget(o,s,n.wrapS,n.wrapT,n.minFilter,n.magFilter),this.renderTexture(n.initialValueTexture,n.renderTargets[0]),this.renderTexture(n.initialValueTexture,n.renderTargets[1]),n.material),a=t.uniforms;if(null!==n.dependencies)for(let e=0;e<n.dependencies.length;e++){var r=n.dependencies[e];if(r.name!==n.name){let t=!1;for(let e=0;e<this._variables.length;e++)if(r.name===this._variables[e].name){t=!0;break}if(!t)return"!var="+n.name+", dep="+r.name}a[r.name]={value:null},t.fragmentShader="\nuniform sampler2D "+r.name+";\n"+t.fragmentShader}}return this._currentTextureIndex=0,null},this.compute=function(n){var a=this._currentTextureIndex,r=0===this._currentTextureIndex?1:0;for(let e=0,t=this._variables.length;e<t;e++){var i=this._variables[e];if(null!==i.dependencies){const n=i.material.uniforms;for(let e=0,t=i.dependencies.length;e<t;e++){var o=i.dependencies[e];n[o.name].value=o.renderTargets[a].texture}}i.buffer&&n&&n[i.name]?this._doRenderTarget(i.material,i.renderTargets[r],i.buffer,n[i.name]):this._doRenderTarget(i.material,i.renderTargets[r])}this._currentTextureIndex=r},this.getCurrentRenderTarget=function(e){return e.renderTargets[this._currentTextureIndex]},this._addResolutionDefine=a,this.createRenderTarget=function(e,t,n,a,r,i){return e=e||o,t=t||s,n=n||G.ClampToEdgeWrapping,a=a||G.ClampToEdgeWrapping,r=r||G.NearestFilter,i=i||G.NearestFilter,new G.WebGLRenderTarget(e,t,{wrapS:n,wrapT:a,minFilter:r,magFilter:i,format:G.RGBAFormat,type:c,depthBuffer:!1})},this.createTexture=function(){var e=new Float32Array(o*s*4);return(e=new G.DataTexture(e,o,s,G.RGBAFormat,G.FloatType)).needsUpdate=!0,e},this.renderTexture=function(e,t){n.passThruTexture.value=e,this._doRenderTarget(h,t),n.passThruTexture.value=null},this._doRenderTarget=function(e,t,n,a){var r=l.getRenderTarget(),i=l.xr.enabled;l.xr.enabled=!1,f.material=e,l.setRenderTarget(t),l.render(u,d),n&&null!=a&&a.length&&this._readPixelsAsync(n).then(()=>{for(let e=0;e<a.length;e++)a[e](n)}),f.material=h,l.xr.enabled=i,l.setRenderTarget(r)},this._readPixelsAsync=function(a){return m(this,void 0,void 0,function*(){var e=l.getContext(),t=o,n=s;if(e instanceof WebGL2RenderingContext)return yield function(t,n,a,r,i,o){return m(this,void 0,void 0,function*(){var e=t.createBuffer();return t.bindBuffer(t.PIXEL_PACK_BUFFER,e),t.bufferData(t.PIXEL_PACK_BUFFER,o.byteLength,t.STREAM_READ),t.readPixels(0,0,n,a,r,i,0),t.bindBuffer(t.PIXEL_PACK_BUFFER,null),yield function(t,n,a,o){return m(this,void 0,void 0,function*(){var r,i,e=t.fenceSync(t.SYNC_GPU_COMMANDS_COMPLETE,0);t.flush(),r=t,i=e,yield new Promise((n,a)=>{!function e(){var t=r.clientWaitSync(i,0,0);t!==r.WAIT_FAILED?t!==r.TIMEOUT_EXPIRED?n():setTimeout(e,10):a()}()}),t.deleteSync(e),t.bindBuffer(n,a),t.getBufferSubData(n,0,o,void 0,void 0),t.bindBuffer(n,null)})}(t,t.PIXEL_PACK_BUFFER,e,o),t.deleteBuffer(e),o})}(e,t,n,e.RGBA,e.FLOAT,a)})}}}var t=o(118),M=o.n(t),de=(t=o(883),o.n(t)),he=(t=o(34),o.n(t)),fe=(t=o(448),o.n(t)),me=(t=o(141),o.n(t));const i=new window.AudioContext,s=Date.now(),n=[261,277,293,311,329,349,369,392,415,440].map(e=>e/4),c=[];for(let a=-1;a<3;a++)c.push(...n.map(e=>{return e=(t=>{var n=[];for(let e=0;e<4410;e++){const a=(e,t,n,a)=>Math.sin(e/t*6.28*n+a),r=(e,t)=>Math.sin(e/44100*t*6.28+Math.pow(a(e,44100,t,0),3)+.75*a(e,44100,t,.25)+.1*a(e,44100,t,.5));n[e]=e<88?e/88.2*r(e,t):Math.pow(1-(e-88.2)/4321.8,Math.pow(.5*Math.log(1e4*t/44100),2))*r(e,t)}return n})(e*Math.pow(2,a)),t=i.createBufferSource(),(n=i.createBuffer(1,e.length,44100)).getChannelData(0).set(e),t.buffer=n,t;var t,n}));let u=0;function E(t,n,a,r){setTimeout(()=>{var e=a[t][u++%a[t].length];if(!e.isPlaying){e.position.copy(n);const t=c[r];t.buffer&&e.setBuffer(t.buffer),e.play()}},50-(Date.now()-s)%50)}class ve{constructor(){this.isPlaying=!1,this.tempo=70,this.currentTime=0,this.nextNoteTime=0,this.timerID=null,this.currentChord=0,this.currentSection="A",this.sectionCounter=0,this.chords=[{root:"Am",chord:["A3","C4","E4"]},{root:"Dm",chord:["D4","F4","A4"]},{root:"F4",chord:["F3","A3","C4"]},{root:"G4",chord:["G3","B3","D4"]}],this.melodyPatternA=[{note:"E4",duration:1},{note:"A4",duration:.5},{note:"C5",duration:.5},{note:"B4",duration:1},{note:"G4",duration:1}],this.melodyPatternB=[{note:"C5",duration:.5},{note:"B4",duration:.5},{note:"A4",duration:1},{note:"F4",duration:.5},{note:"G4",duration:1.5}],this.audioContext=new window.AudioContext,this._setupEffects()}_setupEffects(){this.reverb=this.audioContext.createConvolver(),this.reverb.buffer=this._createReverbIR(2,2.5),this.filter=this.audioContext.createBiquadFilter(),this.filter.type="lowpass",this.filter.frequency.value=2e3,this.filter.Q.value=.5}_createReverbIR(e,t){var n=this.audioContext.sampleRate*e,a=(e=this.audioContext.createBuffer(2,n,this.audioContext.sampleRate)).getChannelData(0),r=e.getChannelData(1);for(let e=0;e<n;e++)a[e]=(2*Math.random()-1)*Math.pow(1-e/n,t),r[e]=(2*Math.random()-1)*Math.pow(1-e/n,t);return e}noteToFrequency(e){var t=parseInt(e.slice(-1));return e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].indexOf(e.slice(0,-1)),440*Math.pow(2,(e-9)/12+(t-4))}createOscillator(e,t,n,a,r=.5){var i=this.audioContext.createOscillator(),o=this.audioContext.createGain();i.connect(o),o.connect(this.filter),this.filter.connect(this.reverb),this.reverb.connect(this.audioContext.destination),i.type=e,i.frequency.setValueAtTime(t,n),t=e=.3*a,o.gain.setValueAtTime(0,n),o.gain.linearRampToValueAtTime(r,n+.05),o.gain.linearRampToValueAtTime(.6*r,n+.05+e),o.gain.setValueAtTime(.6*r,n+a-t),o.gain.linearRampToValueAtTime(0,n+a),i.start(n),i.stop(n+a)}playNote(e,t,n,a=.5){this.createOscillator("sine",this.noteToFrequency(e),t,n,a)}playChord(e,t,n){e.forEach(e=>{this.createOscillator("sine",this.noteToFrequency(e),t,n,.15)})}playDrum(e,t){var n=this.audioContext.createOscillator(),a=this.audioContext.createGain();if(n.connect(a),a.connect(this.audioContext.destination),"kick"===e)n.frequency.setValueAtTime(100,t),n.frequency.exponentialRampToValueAtTime(.01,t+.5),a.gain.setValueAtTime(.7,t),a.gain.exponentialRampToValueAtTime(.01,t+.5);else if("snare"===e){n.frequency.setValueAtTime(100,t),a.gain.setValueAtTime(.2,t),a.gain.exponentialRampToValueAtTime(.01,t+.2);const e=this.audioContext.createBufferSource(),r=this.audioContext.createGain(),i=this.audioContext.createBiquadFilter();e.buffer=this._noiseBuffer(),i.type="highpass",i.frequency.value=1e3,e.connect(i),i.connect(r),r.connect(this.audioContext.destination),r.gain.setValueAtTime(.06,t),r.gain.exponentialRampToValueAtTime(.01,t+.2),e.start(t)}n.start(t),n.stop(t+.5)}_noiseBuffer(){var t=2*this.audioContext.sampleRate,e=this.audioContext.createBuffer(1,t,this.audioContext.sampleRate),n=e.getChannelData(0);for(let e=0;e<t;e++)n[e]=2*Math.random()-1;return e}scheduleNote(){for(var e=60/this.tempo;this.nextNoteTime<this.audioContext.currentTime+.1;){var t=this.currentTime%4,n=(0==t&&(this.currentChord=(this.currentChord+1)%this.chords.length,this.sectionCounter++,this.sectionCounter%8==0)&&(this.currentSection="A"===this.currentSection?"B":"A"),this.playChord(this.chords[this.currentChord].chord,this.nextNoteTime,2*e),(n="A"===this.currentSection?this.melodyPatternA:this.melodyPatternB)[Math.floor(t)%n.length]);this.playNote(n.note,this.nextNoteTime,n.duration*e,.3),0==t?this.playDrum("kick",this.nextNoteTime):2==t&&this.playDrum("snare",this.nextNoteTime),this.currentTime+=.5,this.nextNoteTime+=.5*e}this.timerID=window.setTimeout(()=>this.scheduleNote(),25)}start(){this.isPlaying||(this.isPlaying=!0,this.currentTime=0,this.nextNoteTime=this.audioContext.currentTime,this.currentChord=0,this.currentSection="A",this.sectionCounter=0,this.scheduleNote())}stop(){this.isPlaying=!1,null!==this.timerID&&clearTimeout(this.timerID)}}function pe(e,o,s,l){return new(s=s||Promise)(function(n,t){function a(e){try{i(l.next(e))}catch(e){t(e)}}function r(e){try{i(l.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(a,r)}i((l=l.apply(e,o||[])).next())})}t=o(157);var xe=o.n(t);const d=[];let L;const v=4096;let z;const U=Array(64).fill(null);let O,W,N,H,ge,q,Q=(U[0]=new G.Mesh(new G.BoxGeometry(.1,.1,.1),new G.MeshBasicMaterial),U[0].position.set(0,1.5,0),U[1]=new G.Mesh(new G.BoxGeometry(.1,.1,.1),new G.MeshBasicMaterial),U[1].position.set(0,1.5,1),0),j=!1,ye=0;const K=[],k=new G.Vector3,J=new G.Vector3,we=new G.Quaternion,X=new G.Object3D,Me=new Float32Array(4*v),Ce=new Float32Array(4*v),De=new Float32Array(4*v),Y={};let Z=!1;const p={p:0,e:0};let $,ee,Te,te,ne=0,ae=0,re=0,x=0,ie=10,oe=0,se=0,_e=null,le=null,ce=null;const Pe=new Uint8Array(32),be={player:new G.Color(16777215),enemy:new G.Color(16711680)};let ue=[];pe(void 0,void 0,void 0,function*(){const C=new G.Scene,D=(C.background=new G.Color(5263440),new G.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.01,200)),h=(D.position.set(0,4,10),D.lookAt(0,0,0),navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(e){var t=new window.AudioContext;(ee=t.createAnalyser()).fftSize=32,ee.smoothingTimeConstant=.8,ee.minDecibels=-100,ee.maxDecibels=-5,(Te=t.createMediaStreamSource(e)).connect(ee)}).catch(function(e){}),C.add(D),function(){var e=new G.PlaneGeometry(50,50,20,20),t=new G.MeshBasicMaterial({color:3833156,wireframe:!1,map:function(){var t=new Uint8Array(65536);for(let e=0;e<16384;e++){const n=4*e,a=.5*Math.random()+.5;t[n]=34*a,t[1+n]=139*a,t[2+n]=34*a,t[3+n]=255}const n=new G.DataTexture(t,128,128,G.RGBAFormat);return n.needsUpdate=!0,n}()}),n=(t.map&&(t.map.magFilter=G.NearestFilter),(e=new G.Mesh(e,t)).rotation.x=-Math.PI/2,e.geometry.attributes.position.array);for(let e=0;e<n.length;e+=3)n[e+2]=Math.sin(n[e]/10-Math.PI/2)*Math.cos(n[e+1]/10)*5+5;return e.updateMatrixWorld(!0),e.geometry.attributes.position.needsUpdate=!0,e.geometry.computeVertexNormals(),e}());C.add(h);var e=function(){var e=new G.PlaneGeometry(.2,1),t=new G.ShaderMaterial({vertexShader:xe(),fragmentShader:"\nvarying vec2 vUv;\nvoid main() { \n    vec3 gc = mix(vec3(0.1, 0.6, 0.1), vec3(0.8, 1.0, 0.2), vUv.y);\n    gl_FragColor = vec4(gc, 1.0);\n}\n    ",side:G.DoubleSide,uniforms:{time:{value:0}}}),n=((t=new G.InstancedMesh(e,t,1e4)).frustumCulled=!1,new Float32Array(2e4)),a=new Float32Array(1e4);for(let e=0;e<1e4;e++)n[2*e]=50*(Math.random()-.5),n[2*e+1]=50*(Math.random()-.5),a[e]=Math.random();return t.geometry.setAttribute("offset",new G.InstancedBufferAttribute(n,2)),t.geometry.setAttribute("random",new G.InstancedBufferAttribute(a,1)),{grassInstances:t,grassGeometry:e}}(),t=(te=e.grassInstances,C.add(te),(e=new G.MeshBasicMaterial({side:G.BackSide,depthWrite:!1})).onBeforeCompile=e=>{e.uniforms.time={value:0},e.vertexShader="varying vec2 vUv;\nvarying vec3 vWorldPosition;\n"+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","#include <begin_vertex>\n      vUv = uv;\n      vec4 worldPosition=modelMatrix*vec4(position,1.0);\n      vWorldPosition=worldPosition.xyz;\n      "),e.fragmentShader="uniform float time;\nvarying vec2 vUv;\nvarying vec3 vWorldPosition;\n"+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <logdepthbuf_fragment>","#include <logdepthbuf_fragment>\n      vec3 a=vec3(0.039,0.141,0.447);\n      vec3 b=vec3(0.0,0.467,0.745);\n      vec3 c=vec3(0.529,0.807,0.922);\n      float h=normalize(vWorldPosition).y;\n      if (h>0.0){diffuseColor.rgb=mix(b,a,smoothstep(0.0,1.0,h));}else{\n        diffuseColor.rgb=mix(c,b,smoothstep(-1.0,0.0,h));}\n      ")},new G.SphereGeometry(100,32,32)),t=new G.Mesh(t,e);C.add(t),(e=new G.DirectionalLight(16777215,3)).position.set(0,1,2),C.add(e),t=new G.AmbientLight(16777215,1),C.add(t),(O=new G.WebGLRenderer({antialias:!0,powerPreference:"high-performance"})).xr.enabled=!0;const o=new g(O),s=(O.setPixelRatio(window.devicePixelRatio),O.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(O.domElement),()=>{var e=window.innerWidth,t=window.innerHeight;O.setSize(e,t),D.aspect=e/t,D.updateProjectionMatrix()});function f(){var e=[];return e.push(new G.Vector2(0,0)),e.push(new G.Vector2(.03,0)),e.push(new G.Vector2(.05,.14)),e.push(new G.Vector2(0,.14)),new G.LatheGeometry(e,4)}function T(r,i=0,o=2,s=!1){let l=1-ue.filter(e=>13===e.userData.seeds).length;for(let e=0;e<r;e++){const r=function(e){var t=new G.Group,n=new G.CylinderGeometry(.05,.05,.4,3),a=new G.MeshPhongMaterial({color:65280,transparent:!0,flatShading:!0});let r;if(t.userData.stemMaterial=a,(n=new G.Mesh(n,a)).position.y=-.25,t.add(n),(a=[]).push(new G.Vector2(0,0)),a.push(new G.Vector2(.1,.05)),a.push(new G.Vector2(0,.1)),n=new G.LatheGeometry(a,6),a=new G.MeshPhongMaterial({color:16776960,flatShading:!0,transparent:!0}),t.userData.flowerMaterial=a,(n=new G.Mesh(n,a)).position.y=-.05,t.add(n),a=f(),n=new G.MeshPhongMaterial({color:16777215,side:G.DoubleSide,flatShading:!0}),e)r=e;else for(;13===(r=Math.ceil(30*Math.random())););t.userData.seeds=r;const i=new G.InstancedMesh(a,n,r),o=(t.add(i),function(t=200){var n=[],a=Math.PI*(3-Math.sqrt(5));for(let e=0;e<t+1;e++){var r=1-e/t*2,i=Math.sqrt(1-r*r),o=a*e,s=Math.cos(o)*i,o=Math.sin(o)*i;e<t&&n.push(new G.Vector3(.2*s,.2*r,.2*o))}if(n.length!==t)throw new Error("Fibonacci sphere generation failed");return n}(r)),s=new G.Object3D;return i.userData.orig=[],o.forEach((e,t)=>{s.position.copy(e),e=e.clone().normalize(),e=(new G.Quaternion).setFromUnitVectors(new G.Vector3(0,1,0),e),i.userData.orig.push({position:s.position.clone(),quaternion:e}),s.setRotationFromQuaternion(e),s.updateMatrix(),i.setMatrixAt(t,s.matrix)}),i.instanceMatrix.needsUpdate=!0,t.userData.instancedSeeds=i,e=new G.CapsuleGeometry(.5,.6,16,16),a=new G.MeshBasicMaterial({color:16776960,visible:!1,transparent:!0,opacity:.5}),(n=new G.Mesh(e,a)).position.y=-.25,t.add(n),t}(0<l?13:0);let t,n,e,a=(l=Math.max(0,l-1),0);do{const C=2*Math.random()*Math.PI;if(e=Math.sqrt(Math.random()*(o*o-i*i)+i*i),t=e*Math.cos(C),n=e*Math.sin(C),100<++a)break}while(ue.some(e=>e.position.distanceTo(new G.Vector3(t,0,n))<.5));r.position.set(t,0,n),r.position.setY((c=t,u=n,d=void 0,(d=new G.Raycaster).set(new G.Vector3(c,10,u),new G.Vector3(0,-1,0)),(0<(c=d.intersectObject(h)).length?c[0].point.y:0)-.5)),r.userData.growth=0,r.userData.origHeight=r.position.y,s?r.position.y+=1:ue.push(r),C.add(r)}var c,u,d}window.addEventListener("resize",function(){s()}),e=(W=new w(64,64,O)).createTexture(),t=W.createTexture();var n=W.createTexture(),a=e.image.data,r=t.image.data;for(let e=0,t=a.length;e<t;e+=4)e<256?(U[e/4],a[e+0]=0,a[e+1]=0,a[e+2]=0,a[e+3]=.1,r[e+3]=1):(a[e+0]=0,a[e+1]=0,a[e+2]=0,a[e+3]=99,r[e+0]=0,r[e+1]=0,r[e+2]=0,r[e+3]=0);(N=W.addVariable("tV",M(),t,Ce)).material.uniforms.d={value:3},H=W.addVariable("tP",de(),e,De),ge=W.addVariable("tA",he(),n,Me),W.setVariableDependencies(N,[H,N]),W.setVariableDependencies(H,[H,N]),W.setVariableDependencies(ge,[H,N]),W.init(),T(13,0,2),T(100,2,25,!0);{(t=f()).rotateX(-Math.PI/2),(e=new G.InstancedBufferGeometry).index=t.index,e.attributes.position=t.attributes.position,e.attributes.uv=t.attributes.uv,e.attributes.normal=t.attributes.normal,e.instanceCount=v;let n=new Float32Array(8192),a=0;for(let t=0;t<64;t++)for(let e=0;e<64;e++)n[a++]=e/63,n[a++]=t/63;e.setAttribute("dtUv",new G.InstancedBufferAttribute(n,2)),z={tP:{value:null},tV:{value:null},eC:{value:be.enemy},pC:{value:be.player}},t=new G.ShaderMaterial({uniforms:z,vertexShader:fe(),fragmentShader:me(),side:G.DoubleSide}),(e=new G.InstancedMesh(e,t,v)).frustumCulled=!1,C.add(e)}q=new y,C.add(q.instancedMesh);const _=q.addText("|".repeat(ie),new G.Color(255)),P=(null!=_&&_.setPosition(0,-100,0),null!=_&&_.setScale(.2),q.addText("0",new G.Color(16777215))),b=(null!=P&&P.setPosition(0,-100,0),null!=P&&P.setScale(.3),null!=P&&P.updateText("0"),q.addText("",new G.Color(16777215),!0,[0,0,-1])),i=new G.AudioListener,l=(D.add(i),e=>((e=new G.PositionalAudio(e)).setRefDistance(2),e.setVolume(.4),C.add(e),e)),S={p:[1,2,3,4].map(()=>l(i)),e:[1,2,3,4].map(()=>l(i))},c=(C.add(q.instancedMesh),yield null==(n=navigator.xr)?void 0:n.isSessionSupported("immersive-vr")),u=c?"Engage remote reality":"Remote reality is required";function A(e,t){Y[e]||(Y[e]=[]),Y[e].push(t)}function F(e,t){Y[e]&&-1<(t=Y[e].indexOf(t))&&Y[e].splice(t,1)}function R(t){C.remove(t),ue=ue.filter(e=>e!==t),le=null}function B(e,t,n=0){t.add(X),e&&(X.position.set(0,n,0),X.rotation.set(0,Math.PI/2,0),X.updateMatrixWorld(!0),X.getWorldQuaternion(we),X.getWorldPosition(k),e.setPosition(k.x,k.y,k.z),q.setRotation(e.instanceId,we)),X.removeFromParent()}function V(e){e.userData.text.updateText("|".repeat(Math.max(e.userData.lives,0)))}function I(e,t){return e=Math.floor(1e3*e),Math.sign(t)*(10*e+Math.abs(t))}A("tA",t=>{var n,a,r,i=t;if(!Z){p.e=0;for(let e=p.p=0;e<i.length;e+=4)if(i[e+3]<=-1e5){const C=Math.floor(64*(-i[e+3]-1e5-.5)),n=U[C];n&&n.userData.lives&&(n.userData.lives+=1,n.userData.text.updateText("|".repeat(n.userData.lives)),n.userData.canLaunch=!0,E("e",n.position,S,15))}else i[e+3]<0?(n=Math.floor(64*(-i[e+3]-.5)),a=U[n],r=i[e+1]<.6005?"p":"e",0===n?(--ie,null!=_&&_.updateText("|".repeat(Math.max(ie,0)))):a&&(E(r,a.position,S,10),--a.userData.lives,x+=10*(ne+1),null!=P&&P.updateText(""+x),a.userData.text.updateText("|".repeat(Math.max(a.userData.lives,0))),a.userData.lives<=0)&&(ae++,U[n]=null,C.remove(a))):0<i[e+3]&&(i[e+1]<.6005&&.5995<i[e+1]?p.p++:.6005<i[e+1]&&i[e+1]<.6015&&p.e++);let e;4===ne?e="You defeated the aliens!":ie<=0&&(e="Connection lost."),e&&(e+=` Wave ${ne} Score `+x,j=!1,O.xr.isPresenting&&(o.endSession(),s()),document.getElementById("p").innerHTML=e,L=Date.now(),t=j?"none":"block",document.getElementById("p").style.display=t)}}),O.setAnimationLoop(function(t){se++;var c=t-ye;if(ye=t,ue.forEach((e,t)=>{var n=.001*performance.now();e.rotation.y=.05*Math.sin(t/10*n+t/3)}),le&&(le.userData.removeIn?(le.userData.removeIn-=c,"controller"===(null==(u=le.parent)?void 0:u.userData.type)&&(le.getWorldPosition(k),le.removeFromParent(),le.position.copy(k),C.add(le)),le.position.y-=.01*(1e3-le.userData.removeIn)*(c/1e3),le.userData.removeIn<=0&&R(le)):le.userData.removeIn=1e3),te.material.uniforms.time.value=performance.now()/1e3,ee&&ee.getByteFrequencyData(Pe),O.xr.isPresenting&&(O.xr.getCamera().getWorldPosition(k),U[0]&&U[0].position.copy(k),U[1]&&U[1].position.copy(k),k.y=0,2.5<k.length())){const C=O.xr.getReferenceSpace();if(C){const G=new XRRigidTransform(k,void 0),t=C.getOffsetReferenceSpace(G);O.xr.setReferenceSpace(t)}}if(ce&&0<ce.userData.seeds)_e=function(){let r=null;if(ce){let e=D;(e=O.xr.isPresenting?O.xr.getCamera():e).getWorldPosition(k),ce.getWorldPosition(J);const t=(new G.Vector3).subVectors(J,k).normalize(),i=new G.Raycaster(J,t);let n=1e3,a=0;if(U.forEach((e,t)=>{t<2||0===(null==e?void 0:e.userData.lives)||e&&((t=i.ray.distanceToPoint(e.position))<n&&(n=t,r=e),t>a&&(a=t),e.userData.distance=t)}),U.forEach((e,t)=>{t<2||0===(null==e?void 0:e.userData.lives)||e&&(e.userData.currentTarget=!1,t=(e.userData.distance-n)/(a-n),e.material.color.setRGB(1-t,t,0))}),r&&(r.userData.currentTarget=!0,r.userData.text.updateText("Target")),null!==r)return r}return null}();else for(let e=2;e<U.length;e++){const G=U[e];G&&(G.material.color.setRGB(1,0,0),G.userData.currentTarget=!1)}if(ee&&ce){const C=Pe.slice(4,32),t=Math.max(...C)/255;oe=.9*oe+.1*t;var n=ce,a=4*oe,u=O.xr.isPresenting?O.xr.getCamera():D,r=.001*performance.now(),i=n.userData.instancedSeeds,o=i.userData.orig,s=n.userData.instancedSeeds.count,l=new G.Object3D,e=(n.getWorldPosition(k),u=(new G.Vector3).subVectors(k,u.position).normalize(),new G.Quaternion),d=(n.getWorldQuaternion(e),n=(new G.Matrix4).makeRotationFromQuaternion(e).invert(),u.applyMatrix4(n).normalize());for(let e=0;e<s;e++){const t=o[e].position,D=o[e].quaternion,u=a*(Math.PI/4)+.2*Math.sin(2*r+.1*e)*(.2+.8*a),c=(new G.Vector3).crossVectors(new G.Vector3(0,1,0),d).normalize(),n=(l.position.copy(t),l.quaternion.copy(D),l.rotateOnAxis(c,u),new G.Vector3(0,1-Math.cos(u),0).multiplyScalar(.05));if(l.position.add(n),0==a){const t=.001*Math.sin(3*r+.2*e);l.rotateOnAxis(new G.Vector3(1,0,0),t),l.rotateOnAxis(new G.Vector3(0,0,1),t)}l.updateMatrix(),i.setMatrixAt(e,l.matrix)}if(i.instanceMatrix.needsUpdate=!0,.3<oe&&_e){var h=ce,f=_e,m=new G.Object3D,v=new G.Vector3,p=new G.Matrix4,x=[];for(let e=0;e<h.userData.seeds;e++){(m.parent=h).userData.instancedSeeds.getMatrixAt(e,p),p.decompose(m.position,m.quaternion,m.scale),m.getWorldPosition(v);var g={pos:v.clone(),rot:v,start:13===h.userData.seeds?U[1]:U[0],target:f,owner:"p"},y=new G.Vector3(v.x,v.y,v.z);y.normalize(),y.applyQuaternion(m.quaternion),g.rot=y,x.push(g)}13===x.length&&null!=b&&b.updateText("Hacked"),K.push(...x),h.userData.seeds=0,V(f),oe=0}}if(j){0===Q&&null!=b&&b.setScale(.5),(Q+=c)<5e3?null!=b&&b.updateText("Pick up dandelion with trigger"):Q<1e4?null!=b&&b.updateText("Blow it to launch"):Q<15e3&&(null!=b&&b.setScale(1),null!=b)&&b.updateText("");for(let e=2;e<U.length;e++){const G=U[e];G&&!G.userData.currentTarget&&V(G)}if(se%10==0&&U.forEach(e=>{if(e&&e.userData.canLaunch&&0<e.userData.lives){var t=e;if(-1!==U.indexOf(t)){for(let e=0;e<t.userData.lives;e++){var n=t.position.clone(),a=(k.set(Math.random()-.5,Math.random()-.5,Math.random()-.5),k.multiplyScalar(.1),n.add(k),new G.Vector3(Math.random(),Math.random(),Math.random()));K.push({pos:n,rot:a,start:t,target:U[0],owner:"e"})}t.userData.canLaunch=!1,t.userData.lives=0,t.userData.text.updateText("")}}}),O.xr.isPresenting)for(let e=0;e<2;e++){var w=O.xr.getController(e);"left"===w.userData.handedness&&(B(_,w,.03),B(P,w,-.04)),X.removeFromParent()}for(let e=0;e<ue.length;e++){var M=ue[e];M.userData.growth<1&&(M.userData.growth=Math.min(1,M.userData.growth+.001*M.userData.seeds),M.position.y=M.userData.origHeight+M.userData.growth)}if(ue.length<13&&T(1,0,2),function(){var e,t,n,a=U.filter(e=>e&&"enemy"===e.userData.type&&!1!==e.userData.canLaunch);if(20===ae&&(ne++,$=Date.now(),ae=0,null!=b)&&b.updateText("Wave "+ne),$&&1e4<Date.now()-$)($=null)!=b&&b.updateText("");else if($)return;(!re||Date.now()-re>3e3-800*ne)&&(a.length<20&&([e=0]=[ne],e=Math.floor(Math.random()*(e+1)),t=new G.OctahedronGeometry(.2*(e+1),e),n=new G.MeshPhongMaterial({color:16711680,flatShading:!0}),t=new G.Mesh(t,n),n=Math.random()*Math.PI*2,t.position.set(25*Math.cos(n),-5,25*Math.sin(n)),null!=(n=q.addText("",new G.Color(16711680),!0))&&n.setPosition(t.position.x,t.position.y+1,t.position.z),null!=n&&n.setScale(5-+e),t.userData.text=n,t.userData.type="enemy",t.userData.lives=4*(e+1),t.userData.rising=!0,null!=n&&n.updateText("|".repeat(t.userData.lives)),C.add(t),n=(e=U.map((e,t)=>e||t<=1?null:t).filter(e=>null!==e))[Math.floor(Math.random()*e.length)])&&(U[n]=t),re=Date.now()),a.forEach((e,t)=>{e.userData.text.setPosition(e.position.x,e.position.y+1,e.position.z),e.position.y<10&&e.userData.rising?e.position.y+=.01*(10.5-e.position.y)*(ne+1):e.userData.rising=!1;var n=new G.Vector3(0,1.5,0),a=(U[0]&&n.copy(U[0].position),(new G.Vector3).subVectors(n,e.position).normalize());e.position.add(a.multiplyScalar(.01*(ne+1))),e.position.distanceTo(n)<.3&&(U[U.indexOf(e)]=null,e.userData.text.remove(),C.remove(e),--ie,E("e",e.position,S,2),null!=_)&&_.updateText("|".repeat(ie))})}(),se%10==0&&!Z){const C=W.createTexture(),G=W.createTexture();let l=0;const D=[],u=t=>{C.image.data.set(t);var n=C.image.data;for(let e=0;e<U.length;e++)if(null!==U[e]){const G=4*e;n[G]=U[e].position.x,n[1+G]=U[e].position.y,n[2+G]=U[e].position.z,n[3+G]=.1}for(let e=0;e<D.length;e++){const G=D[e],t=K[e];"p"===t.owner?(n[G]=t.pos.x,n[G+1]=t.pos.y,n[G+2]=t.pos.z,n[G+3]=.6):(n[G]=t.pos.x,n[G+1]=t.pos.y,n[G+2]=t.pos.z,n[G+3]=.601)}F("tP",u),C.needsUpdate=!0,t=W.getCurrentRenderTarget(H),W.renderTexture(C,t),G.needsUpdate=!0,t=W.getCurrentRenderTarget(N),W.renderTexture(G,t),Z=!1,0<D.length&&(D.length=0,K.length=0),ce&&!ce.userData.seeds&&ce.userData.instancedSeeds.count&&(ce.userData.instancedSeeds.count=0)},c=e=>{Z=!0,G.image.data.set(e);var t=G.image.data,n=U.filter((e,t)=>null!==e&&1<t&&0<e.userData.lives);n.sort((e,t)=>e.position.length()-t.position.length()),e=n[0];var a,r=U.indexOf(e);for(let e=0;e<t.length;e+=4){const G=K[l];if(G&&l<K.length+1){const u=(U.indexOf(G.target)+.5)/64+.5,c=I((U.indexOf(G.start)+.5)/64+.5,u);0===t[e+3]&&(t[e]=G.rot.x,t[e+1]=G.rot.y,t[e+2]=G.rot.z,t[e+3]=c,l++,D.push(e))}var i=(a=t[e+3])%10,[i,o]=[Math.floor(a/10)/1e3,i],s=Math.floor(64*(o-.5));if(0<o&&(!U[s]||0===(null==(a=U[s])?void 0:a.userData.lives))&&256<e){const G=I(i,(r+.5)/64+.5);t[e+3]=G}}Math.floor(K.length),F("tV",c),A("tP",u)};(0<K.length||se%10==0)&&A("tV",c)}L=L||Date.now(),W.compute(Y);const t=W.getCurrentRenderTarget(H).texture,D=W.getCurrentRenderTarget(N).texture;z.tP.value=t,z.tV.value=D}O.render(C,D)}),(t=document.getElementById("b"))&&(t.innerHTML=u,c||window.location.search.includes("force"))&&(t.style.cursor="pointer",t.style.color="#fff",t.addEventListener("click",function(){var a;return pe(this,void 0,void 0,function*(){if(c){yield o.startSession(),O.xr.setFoveation(0);for(let r=0;r<2;r++){const n=O.xr.getController(r);n.addEventListener("connected",e=>{n.userData.handedness=e.data.handedness}),C.add(n),n.userData.type="controller";var e=new G.BoxGeometry(.025,.025,.2),t=new G.MeshStandardMaterial({color:be.player}),e=new G.Mesh(e,t);n.add(e),d.push(n),n.addEventListener("selectstart",()=>{var e,t=r,n=d[n=t],a=new G.Matrix4;n.updateMatrixWorld(),a.identity().extractRotation(n.matrixWorld),(e=new G.Raycaster).near=.01,e.far=.3,e.camera=D,e.ray.origin.setFromMatrixPosition(n.matrixWorld),e.ray.direction.set(0,0,-1).applyMatrix4(a),0<(n=e.intersectObjects(ue)).length&&(a=n[0].object,e=t,le&&R(le),a.parent)&&(void 0!==e&&(d[e].add(a.parent),a.parent.position.set(0,.2,-.1)),ce=a.parent)}),n.addEventListener("selectend",()=>{ce&&(le=ce,ce=null)})}}(new ve).start(),null!=(a=document.getElementById("s"))&&a.remove(),j=!0,window.scene=C})}))})})()</script>