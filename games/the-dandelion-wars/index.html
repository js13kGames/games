<title>TDW</title><style>body{margin:0;background:#000;font-family:Courier}canvas{display:block}.b{border:5px solid #ccc}.u{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);margin-right:-33%;font-size:1.3em;color:#fff;background:rgba(0,0,0,.6);max-width:50%;padding:1em;box-sizing:border-box;overflow:auto;text-align:center}.c{display:block;margin:0 auto;font-size:1em;padding:1em 2em;margin-top:1em;border:1px solid #fff;background:rgba(0,0,0,.5);color:#aaa;font-weight:700;font-family:Courier}#p{display:none}h1{margin-top:0}</style><div id=s class="b u"><h1>The Dandelion Wars</h1><p>In a world besieged by aliens, the last defense lies in an unexpected weapon: dandelions.<p>Harness their power using remote reality and defend with weaponized seeds.<p>Beware! The aliens have hacked some dandelions with 13 seeds into deadly traps. With every breath Earth hangs in the balance. Avoid the cursed 13 & fight!</p><button id=b class=c>Engage</button></div><div id=p class="b u">Pause</div><script type=module>import*as e from"/2024/webxr/three.module.js";var t={34:e=>{e.exports="void main(){vec2 A=gl_FragCoord.xy/resolution.xy;vec4 B=texture2D(tP,A);vec4 C=texture2D(tV,A);gl_FragColor=vec4(B.x,B.w,C.x,C.w);}"},883:e=>{e.exports="#define A  (1.0/60.0)\nvoid main(){vec2 B=gl_FragCoord.xy/resolution.xy;vec4 C=texture2D(tP,B);vec3 D=C.xyz;float E=C.w;vec4 F=texture2D(tV,B);vec3 G=F.xyz;float H=F.w;if(H==0.){G=vec3(0.);}if(E>0.5){D+=G*A;}gl_FragColor=vec4(D,E);}"},118:e=>{e.exports="float A=1./60.;uniform float d;const float B=resolution.x;const float C=resolution.y;bool D(float E,float F){return abs(E-F)<0.01;}vec2 G(float H){float sign=sign(H);float I=abs(H);float E=floor(I/10.)/1000.;float F=sign*mod(I,10.);return vec2(E,F);}float J(float E,float F){return sign(F)*(floor(E*1000.)*10.+abs(F));}void main(){float K=100.*(d+1.);vec2 L=gl_FragCoord.xy/resolution.xy;float M=L.y*resolution.x+L.x;vec4 N=texture2D(tP,L);vec3 O=N.xyz;float P=N.w;vec4 Q=texture2D(tV,L);vec3 R=Q.xyz;float S=1.;vec2 T=G(Q.w);float U=T.y;float V=T.x;float W=4.;if(D(U,0.5078)){A=0.1/60.;W=0.5;}if(U>0.){vec3 X=vec3(0.);for(float Y=0.;Y<C;Y++){for(float Z=0.;Z<B;Z++){vec2 a=vec2(Z+0.5,Y+0.5)/resolution.xy;vec4 b=texture2D(tP,a);vec3 c=b.xyz;vec4 d=texture2D(tV,a);vec3 e=d.xyz;vec2 T=G(d.w);float f=T.y;float g=T.x;float h=a.y*resolution.x+a.x;if(M==h){continue;}if(f==0.){continue;}vec3 i=c-O;float j=length(i);if(j==0.){continue;}float k=b.w;float l=j*j;if(D(P,0.6)&&D(h,V)){S=min(1.,l/100.);}if(j<.5&&D(P,0.6)&&D(h,U)&&D(V,0.5234)){R=vec3(0);gl_FragColor=vec4(R,-U-1e5);return;}if(j<.5&&D(P,0.6)&&D(h,U)){R=vec3(0);gl_FragColor=vec4(R,-U);return;}if(D(P,0.6)&&D(k,0.6)){float m=(-0.4)/(l);X+=m*normalize(i);}else if(D(P,0.6)&&D(h,U)){float n=K*f/j;X+=n*normalize(i);}else if(D(P,0.6)&&D(k,0.1)){float o=-0.2*K*f/(l*l);}}}R+=A*X*S;if(length(R)>0.){R=normalize(R)*min(length(R),W);}}else{gl_FragColor=vec4(0);return;}gl_FragColor=vec4(R,J(V,U));}"},157:e=>{e.exports="attribute vec2 offset;attribute float random;uniform float time;varying vec2 vUv;float A=3.14159;float B(vec2 C){return fract(sin(dot(C,vec2(12.9898,78.233)))*43758.5453);}vec3 D(vec3 E){return mod(((E*34.)+1.)*E,289.);}float F(vec2 G){const vec4 H=vec4(0.211324865405187,0.366025403784439,-0.577350269189626,0.024390243902439);vec2 I=floor(G+dot(G,H.yy));vec2 J=G-I+dot(I,H.xx);vec2 K;K=(J.x>J.y)?vec2(1.,0.):vec2(0.,1.);vec4 L=J.xyxy+H.xxzz;L.xy-=K;I=mod(I,289.);vec3 C=D(D(I.y+vec3(0.,K.y,1.))+I.x+vec3(0.,K.x,1.));vec3 M=max(0.5-vec3(dot(J,J),dot(L.xy,L.xy),dot(L.zw,L.zw)),0.);M=M*M;M=M*M;vec3 E=2.*fract(C*H.www)-1.;vec3 N=abs(E)-0.5;vec3 O=floor(E+0.5);vec3 P=E-O;M*=1.79284291400159-0.85373472095314*(P*P+N*N);vec3 Q;Q.x=P.x*J.x+N.x*J.y;Q.yz=P.yz*L.xz+N.yz*L.yw;return 130.*dot(M,Q);}void main(){vUv=uv;vec3 R=position;vec2 S=offset;float T=sin(S.x/10.-A/2.)*cos(S.y/10.)*5.+5.;float U=B(offset)*3.14159*2.;mat2 V=mat2(cos(U),-sin(U),sin(U),cos(U));R.xz=V*R.xz;R.xz+=S;R.y+=T+0.5;float W=0.3;float X=1.5;float Y=F(vec2(offset.x*0.1+time*0.2,offset.y*0.1))*0.5+0.5;float Z=sin(time*X+Y*6.28)*W;float a=smoothstep(0.,0.6,position.y);R.x+=Z*a;float b=0.2;R.z-=b*pow(position.y,2.)*Z;vec4 c=modelViewMatrix*vec4(R,1.);gl_Position=projectionMatrix*c;}"},141:e=>{e.exports="varying vec4 vColor;varying vec4 vPosition;varying vec4 vVelocity;varying float vEnemy;varying vec3 vViewPosition;void main(){vec3 A=dFdx(vViewPosition);vec3 B=dFdy(vViewPosition);vec3 C=normalize(cross(A,B));float D=clamp(vPosition.z/10.,0.,0.9);float E=vColor.g*0.5+0.4*min(length(vVelocity.xz),1.5)*(1.-D);float F=vColor.r*0.5+0.4*min(length(vVelocity.xy),1.5)*(1.-D);vec3 G=vColor.rgb;vec3 H=normalize(vec3(0.,-0.4472,-0.8944));H=normalize((viewMatrix*vec4(H,0.)).xyz);vec3 I=normalize(-vViewPosition);vec3 J=vec3(0.7,0.7,0.7);vec3 K=J*G;vec3 L=vec3(1.,1.,1.);float M=0.5;float N=max(dot(C,H),0.);vec3 O=L*M*N*G;vec3 P=K+O;gl_FragColor=vec4(P,1.);}"},448:e=>{e.exports="uniform sampler2D tP;uniform sampler2D tV;uniform vec3 pC;uniform vec3 eC;attribute vec2 dtUv;varying vec4 vColor;varying vec4 vPosition;varying vec4 vVelocity;varying float vEnemy;varying vec3 vViewPosition;bool A(float B,float C,float D){return abs(B-C)<D;}vec2 E(float F){float sign=sign(F);float G=abs(F);float B=floor(G/10.)/1000.;float C=sign*mod(G,10.);return vec2(B,C);}mat3 H(vec3 I){vec3 J=vec3(0.,0.,1.);vec3 K=normalize(cross(I,J));vec3 L=cross(K,I);return mat3(-K,L,-I);}void main(){vec4 M=texture2D(tP,dtUv);vec3 N=M.xyz;vec4 O=texture2D(tV,dtUv);vec3 P=O.xyz;vec2 Q=E(O.w);if(A(Q.x,0.52343,0.01)){vColor=vec4(eC,1.);}else if(A(M.w,0.600,0.0001)){vColor=vec4(pC,1.);vEnemy=0.;}else if(A(M.w,0.601,0.0001)){vColor=vec4(eC,1.);vEnemy=1.;}else{vColor=vec4(1.,1.,0.,0.);}vVelocity=O;vec3 R=mat3(modelMatrix)*position;if(vEnemy>0.5){R*=2.;}mat3 S=H(normalize(P));R=S*R;R+=N;vec4 T=modelViewMatrix*(vec4(position,1.)+vec4(N,1.));gl_Position=projectionMatrix*viewMatrix*vec4(R,1.);vPosition=gl_Position;vViewPosition=-T.xyz;}"},751:e=>{e.exports="uniform sampler2D t;uniform sampler2D m;varying float l;varying vec3 c;varying vec2 u;varying float i;uniform float time;void main(){int A=int(floor(mod(u.x*l,128.)));vec2 B=vec2(float(A)/float(128.),i/float(1024.));float C=texture2D(m,B).r*255.;float D=floor(C/8.);float E=mod(C,8.);vec2 F;float G=64./512.;highp float H=(64./512.);float I=(u.x*H*l)/1.6;float J=(-u.y*0.11);float K=mod(I,H/1.6);float L=mod(J,G);F.x=((E*H)+K);F.y=(1.-D*G)-L;vec4 M=texture2D(t,F);if(M.a<0.2||K<0.004||K>0.99*H||L<0.01||L>0.99*G){discard;}else{gl_FragColor=M*vec4(c,1.);}}"},449:e=>{e.exports="attribute float length;attribute float instance;varying vec2 u;varying vec3 c;varying float l;varying float i;void main(){u=uv;l=length;\n#ifdef USE_INSTANCING_COLOR\nc=instanceColor;\n#endif\ni=instance;gl_Position=projectionMatrix*modelViewMatrix*instanceMatrix*vec4(position,1.);}"}},n={};function o(e){var r=n[e];if(void 0!==r)return r.exports;var a=n[e]={exports:{}};return t[e](a,a.exports,o),a.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{const t=(e=>{var t={};return o.d(t,e),t})({AmbientLight:()=>e.AmbientLight,AudioListener:()=>e.AudioListener,BackSide:()=>e.BackSide,BoxGeometry:()=>e.BoxGeometry,Camera:()=>e.Camera,CanvasTexture:()=>e.CanvasTexture,CapsuleGeometry:()=>e.CapsuleGeometry,ClampToEdgeWrapping:()=>e.ClampToEdgeWrapping,Color:()=>e.Color,CylinderGeometry:()=>e.CylinderGeometry,DataTexture:()=>e.DataTexture,DirectionalLight:()=>e.DirectionalLight,DoubleSide:()=>e.DoubleSide,FloatType:()=>e.FloatType,Group:()=>e.Group,InstancedBufferAttribute:()=>e.InstancedBufferAttribute,InstancedBufferGeometry:()=>e.InstancedBufferGeometry,InstancedMesh:()=>e.InstancedMesh,LatheGeometry:()=>e.LatheGeometry,Matrix4:()=>e.Matrix4,Mesh:()=>e.Mesh,MeshBasicMaterial:()=>e.MeshBasicMaterial,MeshPhongMaterial:()=>e.MeshPhongMaterial,MeshStandardMaterial:()=>e.MeshStandardMaterial,NearestFilter:()=>e.NearestFilter,Object3D:()=>e.Object3D,OctahedronGeometry:()=>e.OctahedronGeometry,PerspectiveCamera:()=>e.PerspectiveCamera,PlaneGeometry:()=>e.PlaneGeometry,PositionalAudio:()=>e.PositionalAudio,Quaternion:()=>e.Quaternion,RGBAFormat:()=>e.RGBAFormat,Raycaster:()=>e.Raycaster,RedFormat:()=>e.RedFormat,Scene:()=>e.Scene,ShaderMaterial:()=>e.ShaderMaterial,SphereGeometry:()=>e.SphereGeometry,Vector2:()=>e.Vector2,Vector3:()=>e.Vector3,WebGLRenderTarget:()=>e.WebGLRenderTarget,WebGLRenderer:()=>e.WebGLRenderer});class n{constructor(e){this.renderer=e,this.currentSession=null}startSession(){return function(e,t,n,o){return new(n||(n=Promise))((function(r,a){function i(e){try{l(o.next(e))}catch(e){a(e)}}function s(e){try{l(o.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}l((o=o.apply(e,t||[])).next())}))}(this,void 0,void 0,(function*(){if(null===this.currentSession){const e={optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]};try{if(!navigator.xr)throw new Error("!WebXR");const t=yield navigator.xr.requestSession("immersive-vr",e);yield this.renderer.xr.setSession(t),this.currentSession=t}catch(e){}}else this.currentSession.end()}))}endSession(){this.currentSession&&(this.currentSession.end(),this.currentSession=null)}}var r=o(449),a=o.n(r),i=o(751),s=o.n(i);const l={A:[[,1],[1,,1],[1,,1],[1,1,1],[1,,1]],B:[[1,1],[1,,1],[1,1],[1,,1],[1,1]],C:[[,1,1],[1],[1],[1],[,1,1]],D:[[1,1],[1,,1],[1,,1],[1,,1],[1,1]],E:[[1,1,1],[1],[1,1],[1],[1,1,1]],F:[[1,1,1],[1],[1,1],[1],[1]],G:[[,1,1],[1],[1,,1,1],[1,,,1],[,1,1]],H:[[1,,1],[1,,1],[1,1,1],[1,,1],[1,,1]],I:[[1,1,1],[,1],[,1],[,1],[1,1,1]],J:[[,,1],[,,1],[,,1],[1,,1],[,1]],K:[[1,,1],[1,,1],[1,1],[1,,1],[1,,1]],L:[[1],[1],[1],[1],[1,1,1]],M:[[1,,,1],[1,1,1,1],[1,,,1],[1,,,1],[1,,,1]],N:[[1,,,1],[1,1,,1],[1,,1,1],[1,,,1],[1,,,1]],O:[[,1],[1,,1],[1,,1],[1,,1],[,1]],P:[[1,1],[1,,1],[1,1],[1],[1]],Q:[[,1],[1,,1],[1,,1],[1,,1],[,1,,1]],R:[[1,1],[1,,1],[1,1],[1,,1],[1,,1]],S:[[,1,1],[1],[,1],[,,1],[1,1]],T:[[1,1,1],[,1],[,1],[,1],[,1]],U:[[1,,1],[1,,1],[1,,1],[1,,1],[,1]],V:[[1,,1],[1,,1],[1,,1],[1,,1],[,1]],W:[[1,,,1],[1,,,1],[1,,,1],[1,1,1,1],[,1,1]],X:[[1,,1],[1,,1],[,1],[1,,1],[1,,1]],Y:[[1,,1],[1,,1],[,1],[,1],[,1]],Z:[[1,1,1],[,,1],[,1],[1],[1,1,1]],0:[[,1],[1,,1],[1,,1],[1,,1],[,1]],"|":[[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1]],1:[[,1],[1,1],[,1],[,1],[1,1,1]],2:[[,1],[1,,1],[,,1],[,1],[1,1,1]],3:[[1,1],[,,1],[,1,1],[,,1],[1,1]],4:[[1,,1],[1,,1],[1,1,1],[,,1],[,,1]],5:[[1,1,1],[1],[1,1],[,,1],[1,1]],6:[[,1,1],[1],[1,1,1],[1,,1],[,1]],7:[[1,1,1],[,,1],[,1],[,1],[,1]],8:[[,1],[1,,1],[,1],[1,,1],[,1]],9:[[,1],[1,,1],[,1,1],[,,1],[,1]]};class c{constructor(e,n,o){this._pool=[],this._characters=e||" ABCDEFGHIJKLMNOPQRSTUVWXYZ0|123456789",this._maxCharsPerInstance=n||128,this._maxInstances=o||1024,this._texture=this.generateTexture(),this._dummies=[],this._scales=[],this._instanceCount=0,this._lengthsBuffer=new t.InstancedBufferAttribute(new Float32Array(this._maxInstances),1),this._instanceBuffer=new t.InstancedBufferAttribute(new Float32Array(this._maxInstances),1),this._maxCharsPerInstance=128,this._data=new Uint8Array(this._maxCharsPerInstance*this._maxInstances),this._messagesTexture=new t.DataTexture(this._data,this._maxCharsPerInstance,this._maxInstances,t.RedFormat),this._folCamRot=[],this._folCam=[],this._dummy=new t.Object3D,this._tempQuat=new t.Quaternion,this._tempQuat2=new t.Quaternion,this.cameraRotation=0;const r=new t.ShaderMaterial({uniforms:{t:{value:this._texture},m:{value:this._messagesTexture},time:{value:0}},vertexShader:a(),fragmentShader:s(),depthWrite:!0});r.transparent=!0,r.side=t.DoubleSide,r.vertexColors=!0;const i=new t.PlaneGeometry(1,.1);i.setAttribute("length",this._lengthsBuffer),i.setAttribute("instance",this._instanceBuffer),this.instancedMesh=new t.InstancedMesh(i,r,this._maxInstances),this.instancedMesh.frustumCulled=!1,this.instancedMesh.onBeforeRender=(e,n,o,r,a,i)=>{if(o.matrixWorld.decompose(this._dummy.position,this._dummy.quaternion,this._dummy.scale),this._folCamRot.length>0)for(let e=0;e<this._folCamRot.length;e++)this._dummies[this._folCamRot[e]].quaternion.copy(this._dummy.quaternion),this.updateMatrix(this._folCamRot[e]);if(this._folCam.length>0)for(let e=0;e<this._folCam.length;e++){const n=new t.Vector3(this._folCam[e].x,this._folCam[e].y,this._folCam[e].z);n.applyQuaternion(this._dummy.quaternion),this._dummies[this._folCam[e].instanceId].position.copy(this._dummy.position).add(n),this._dummies[this._folCam[e].instanceId].quaternion.copy(this._dummy.quaternion),this.updateMatrix(this._folCam[e].instanceId)}}}generateTexture(){const e=document.createElement("canvas");e.width=512,e.height=512;const n=e.getContext("2d");if(!n)throw new Error;function o(e,t,n,o){const r=l[t];if(r)for(let t=0;t<r.length;t++)for(let a=0;a<r[t].length;a++)r[t][a]&&(e.fillStyle="white",e.fillRect(n+8*a,o+8*t+5,8,8))}n.textAlign="center";for(let e=0;e<this._characters.length;e++){const t=e%8*64+1,r=64*Math.floor(e/8)+1;o(n,this._characters[e],t,r)}const r=new t.CanvasTexture(e);return r.magFilter=t.NearestFilter,r.minFilter=t.NearestFilter,r}updateMessageTexture(e,t){for(let n=0;n<t.length;n++){const o=this._characters.indexOf(t[n].toUpperCase());-1!==o&&(this._data[e*this._maxCharsPerInstance+n]=o)}this._lengthsBuffer.setX(e,t.length),this._lengthsBuffer.needsUpdate=!0;const n=this._scales[e]||1;this.setScale(e,t.length*n/10/1,n,1),this._messagesTexture.needsUpdate=!0,this.instancedMesh.material.uniforms.time.value=performance.now()/1e3,this.instancedMesh.material.needsUpdate=!0}addText(e,n,o,r){let a=this._instanceCount;const i=this._pool.pop();return void 0!==i?a=i:this._instanceCount++,this._instanceCount>=this._maxInstances?null:(this.instancedMesh.count=this._instanceCount,this._dummies[a]=new t.Object3D,this.updateMessageTexture(a,e),this._instanceBuffer.setX(a,a),this._instanceBuffer.needsUpdate=!0,n&&this.setColor(a,n),o&&this._folCamRot.push(a),r&&this._folCam.push({instanceId:a,x:r[0],y:r[1],z:r[2]}),{setPosition:(e,t,n)=>{this.setPosition(a,e,t,n)},updateText:(e,t)=>{this.updateMessageTexture(a,e),t&&this.setColor(a,t)},remove:()=>{this.updateMessageTexture(a,""),this._pool.push(a)},setScale:e=>{this.setScale(a,e,e,e),this._scales[a]=e},instancedMesh:this.instancedMesh,instanceId:a})}setColor(e,t){this.instancedMesh.setColorAt(e,t),this.instancedMesh.instanceColor&&(this.instancedMesh.instanceColor.needsUpdate=!0)}setScale(e,t,n,o){this._dummies[e].scale.set(t,n,o),this.updateMatrix(e)}setPosition(e,t,n,o){this._dummies[e].position.set(t,n,o),this.updateMatrix(e)}setRotation(e,t){this._dummies[e].setRotationFromQuaternion(t),this.updateMatrix(e)}updateMatrix(e,t){t?this._dummies[e].matrix.copy(t):this._dummies[e].updateMatrix(),this.instancedMesh.setMatrixAt(e,this._dummies[e].matrix),this.instancedMesh.instanceMatrix.needsUpdate=!0}}var u=function(e,t,n,o){return new(n||(n=Promise))((function(r,a){function i(e){try{l(o.next(e))}catch(e){a(e)}}function s(e){try{l(o.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}l((o=o.apply(e,t||[])).next())}))};class d{constructor(e,n,o){this._variables=[],this._currentTextureIndex=0;const r=t.FloatType,a=new t.Scene,i=new t.Camera;i.position.z=1;const s={passThruTexture:{value:null}},l=h("uniform sampler2D passThruTexture; void main(){vec2 uv = gl_FragCoord.xy/resolution.xy;gl_FragColor=texture2D(passThruTexture,uv);}",s),c=new t.Mesh(new t.PlaneGeometry(2,2),l);function d(t){t.defines.resolution="vec2( "+e.toFixed(1)+", "+n.toFixed(1)+" )"}function h(e,n){n=n||{};const o=new t.ShaderMaterial({name:"GPUComputationShader",uniforms:n,vertexShader:"void main(){gl_Position=vec4(position,1.0);}",fragmentShader:e});return d(o),o}a.add(c),this.addVariable=function(e,n,o,r){const a={name:e,initialValueTexture:o,material:h(n),dependencies:null,renderTargets:[],wrapS:null,wrapT:null,minFilter:t.NearestFilter,magFilter:t.NearestFilter,buffer:r};return this._variables.push(a),a},this.setVariableDependencies=function(e,t){e.dependencies=t},this.init=function(){if(!1===o.capabilities.isWebGL2&&!1===o.extensions.has("OES_texture_float"))return"!OES_texture_float";if(0===o.capabilities.maxVertexTextures)return"!vertexShaderTex";for(let t=0;t<this._variables.length;t++){const o=this._variables[t];o.renderTargets[0]=this.createRenderTarget(e,n,o.wrapS,o.wrapT,o.minFilter,o.magFilter),o.renderTargets[1]=this.createRenderTarget(e,n,o.wrapS,o.wrapT,o.minFilter,o.magFilter),this.renderTexture(o.initialValueTexture,o.renderTargets[0]),this.renderTexture(o.initialValueTexture,o.renderTargets[1]);const r=o.material,a=r.uniforms;if(null!==o.dependencies)for(let e=0;e<o.dependencies.length;e++){const t=o.dependencies[e];if(t.name!==o.name){let e=!1;for(let n=0;n<this._variables.length;n++)if(t.name===this._variables[n].name){e=!0;break}if(!e)return"!var="+o.name+", dep="+t.name}a[t.name]={value:null},r.fragmentShader="\nuniform sampler2D "+t.name+";\n"+r.fragmentShader}}return this._currentTextureIndex=0,null},this.compute=function(e){const t=this._currentTextureIndex,n=0===this._currentTextureIndex?1:0;for(let o=0,r=this._variables.length;o<r;o++){const r=this._variables[o];if(null!==r.dependencies){const e=r.material.uniforms;for(let n=0,o=r.dependencies.length;n<o;n++){const o=r.dependencies[n];e[o.name].value=o.renderTargets[t].texture}}r.buffer&&e&&e[r.name]?this._doRenderTarget(r.material,r.renderTargets[n],r.buffer,e[r.name]):this._doRenderTarget(r.material,r.renderTargets[n])}this._currentTextureIndex=n},this.getCurrentRenderTarget=function(e){return e.renderTargets[this._currentTextureIndex]},this._addResolutionDefine=d,this.createRenderTarget=function(o,a,i,s,l,c){return o=o||e,a=a||n,i=i||t.ClampToEdgeWrapping,s=s||t.ClampToEdgeWrapping,l=l||t.NearestFilter,c=c||t.NearestFilter,new t.WebGLRenderTarget(o,a,{wrapS:i,wrapT:s,minFilter:l,magFilter:c,format:t.RGBAFormat,type:r,depthBuffer:!1})},this.createTexture=function(){const o=new Float32Array(e*n*4),r=new t.DataTexture(o,e,n,t.RGBAFormat,t.FloatType);return r.needsUpdate=!0,r},this.renderTexture=function(e,t){s.passThruTexture.value=e,this._doRenderTarget(l,t),s.passThruTexture.value=null},this._doRenderTarget=function(e,t,n,r){const s=o.getRenderTarget(),u=o.xr.enabled;o.xr.enabled=!1,c.material=e,o.setRenderTarget(t),o.render(a,i),n&&(null==r?void 0:r.length)&&this._readPixelsAsync(n).then((()=>{for(let e=0;e<r.length;e++)r[e](n)})),c.material=l,o.xr.enabled=u,o.setRenderTarget(s)},this._readPixelsAsync=function(t){return u(this,void 0,void 0,(function*(){const r=o.getContext(),a=e,i=n;if(!(r instanceof WebGL2RenderingContext))return;const s=yield function(e,t,n,o,r,a,i,s){return u(this,void 0,void 0,(function*(){const t=e.createBuffer();return e.bindBuffer(e.PIXEL_PACK_BUFFER,t),e.bufferData(e.PIXEL_PACK_BUFFER,s.byteLength,e.STREAM_READ),e.readPixels(0,0,o,r,a,i,0),e.bindBuffer(e.PIXEL_PACK_BUFFER,null),yield function(e,t,n,o,r,a,i){return u(this,void 0,void 0,(function*(){const o=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0);e.flush(),yield function(e,t,n,o){return new Promise(((n,o)=>{!function r(){const a=e.clientWaitSync(t,0,0);a!==e.WAIT_FAILED?a!==e.TIMEOUT_EXPIRED?n():setTimeout(r,10):o()}()}))}(e,o),e.deleteSync(o),e.bindBuffer(t,n),e.getBufferSubData(t,0,r,undefined,undefined),e.bindBuffer(t,null)}))}(e,e.PIXEL_PACK_BUFFER,t,0,s),e.deleteBuffer(t),s}))}(r,0,0,a,i,r.RGBA,r.FLOAT,t);return s}))}}}var h=o(118),f=o.n(h),m=o(883),v=o.n(m),p=o(34),x=o.n(p),g=o(448),y=o.n(g),w=o(141),M=o.n(w);const C=(e,t)=>{const n=[];for(let o=0;o<44100*t;o++){const r=(e,t,n,o)=>Math.sin(e/t*6.28*n+o),a=(e,t)=>Math.sin(e/44100*t*6.28+Math.pow(r(e,44100,t,0),3)+.75*r(e,44100,t,.25)+.1*r(e,44100,t,.5));n[o]=o<88?o/88.2*a(o,e):Math.pow(1-(o-88.2)/(44100*(t-.002)),Math.pow(.5*Math.log(1e4*e/44100),2))*a(o,e)}return n},D=new window.AudioContext,T=Date.now(),_=e=>{const t=D.createBufferSource(),n=D.createBuffer(1,e.length,44100);return n.getChannelData(0).set(e),t.buffer=n,t},P=[261,277,293,311,329,349,369,392,415,440].map((e=>e/4)),b=[];for(let e=-1;e<3;e++)b.push(...P.map((t=>_(C(t*Math.pow(2,e),.1)))));let S=0;function A(e,t,n,o){setTimeout((()=>{const r=n[e][S++%n[e].length];if(!r.isPlaying){r.position.copy(t);const e=b[o];e.buffer&&r.setBuffer(e.buffer),r.play()}}),50-(Date.now()-T)%50)}class F{constructor(){this.isPlaying=!1,this.tempo=70,this.currentTime=0,this.nextNoteTime=0,this.timerID=null,this.currentChord=0,this.currentSection="A",this.sectionCounter=0,this.chords=[{root:"Am",chord:["A3","C4","E4"]},{root:"Dm",chord:["D4","F4","A4"]},{root:"F4",chord:["F3","A3","C4"]},{root:"G4",chord:["G3","B3","D4"]}],this.melodyPatternA=[{note:"E4",duration:1},{note:"A4",duration:.5},{note:"C5",duration:.5},{note:"B4",duration:1},{note:"G4",duration:1}],this.melodyPatternB=[{note:"C5",duration:.5},{note:"B4",duration:.5},{note:"A4",duration:1},{note:"F4",duration:.5},{note:"G4",duration:1.5}],this.audioContext=new window.AudioContext,this._setupEffects()}_setupEffects(){this.reverb=this.audioContext.createConvolver(),this.reverb.buffer=this._createReverbIR(2,2.5),this.filter=this.audioContext.createBiquadFilter(),this.filter.type="lowpass",this.filter.frequency.value=2e3,this.filter.Q.value=.5}_createReverbIR(e,t){const n=this.audioContext.sampleRate*e,o=this.audioContext.createBuffer(2,n,this.audioContext.sampleRate),r=o.getChannelData(0),a=o.getChannelData(1);for(let e=0;e<n;e++)r[e]=(2*Math.random()-1)*Math.pow(1-e/n,t),a[e]=(2*Math.random()-1)*Math.pow(1-e/n,t);return o}noteToFrequency(e){const t=parseInt(e.slice(-1)),n=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].indexOf(e.slice(0,-1));return 440*Math.pow(2,(n-9)/12+(t-4))}createOscillator(e,t,n,o,r=.5){const a=this.audioContext.createOscillator(),i=this.audioContext.createGain();a.connect(i),i.connect(this.filter),this.filter.connect(this.reverb),this.reverb.connect(this.audioContext.destination),a.type=e,a.frequency.setValueAtTime(t,n);const s=.3*o,l=.3*o;i.gain.setValueAtTime(0,n),i.gain.linearRampToValueAtTime(r,n+.05),i.gain.linearRampToValueAtTime(.6*r,n+.05+s),i.gain.setValueAtTime(.6*r,n+o-l),i.gain.linearRampToValueAtTime(0,n+o),a.start(n),a.stop(n+o)}playNote(e,t,n,o=.5){this.createOscillator("sine",this.noteToFrequency(e),t,n,o)}playChord(e,t,n){e.forEach((e=>{this.createOscillator("sine",this.noteToFrequency(e),t,n,.15)}))}playDrum(e,t){const n=this.audioContext.createOscillator(),o=this.audioContext.createGain();if(n.connect(o),o.connect(this.audioContext.destination),"kick"===e)n.frequency.setValueAtTime(100,t),n.frequency.exponentialRampToValueAtTime(.01,t+.5),o.gain.setValueAtTime(.7,t),o.gain.exponentialRampToValueAtTime(.01,t+.5);else if("snare"===e){n.frequency.setValueAtTime(100,t),o.gain.setValueAtTime(.2,t),o.gain.exponentialRampToValueAtTime(.01,t+.2);const e=this.audioContext.createBufferSource(),r=this.audioContext.createGain(),a=this.audioContext.createBiquadFilter();e.buffer=this._noiseBuffer(),a.type="highpass",a.frequency.value=1e3,e.connect(a),a.connect(r),r.connect(this.audioContext.destination),r.gain.setValueAtTime(.06,t),r.gain.exponentialRampToValueAtTime(.01,t+.2),e.start(t)}n.start(t),n.stop(t+.5)}_noiseBuffer(){const e=2*this.audioContext.sampleRate,t=this.audioContext.createBuffer(1,e,this.audioContext.sampleRate),n=t.getChannelData(0);for(let t=0;t<e;t++)n[t]=2*Math.random()-1;return t}scheduleNote(){const e=60/this.tempo;for(;this.nextNoteTime<this.audioContext.currentTime+.1;){const t=this.currentTime%4;0===t&&(this.currentChord=(this.currentChord+1)%this.chords.length,this.sectionCounter++,this.sectionCounter%8==0&&(this.currentSection="A"===this.currentSection?"B":"A")),this.playChord(this.chords[this.currentChord].chord,this.nextNoteTime,2*e);const n="A"===this.currentSection?this.melodyPatternA:this.melodyPatternB,o=n[Math.floor(t)%n.length];this.playNote(o.note,this.nextNoteTime,o.duration*e,.3),0===t?this.playDrum("kick",this.nextNoteTime):2===t&&this.playDrum("snare",this.nextNoteTime),this.currentTime+=.5,this.nextNoteTime+=.5*e}this.timerID=window.setTimeout((()=>this.scheduleNote()),25)}start(){this.isPlaying||(this.isPlaying=!0,this.currentTime=0,this.nextNoteTime=this.audioContext.currentTime,this.currentChord=0,this.currentSection="A",this.sectionCounter=0,this.scheduleNote())}stop(){this.isPlaying=!1,null!==this.timerID&&clearTimeout(this.timerID)}}var R=o(157),B=o.n(R),V=function(e,t,n,o){return new(n||(n=Promise))((function(r,a){function i(e){try{l(o.next(e))}catch(e){a(e)}}function s(e){try{l(o.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}l((o=o.apply(e,t||[])).next())}))};const I=[];let G;const E=64,L=E*E;let z;const U=Array(E).fill(null);let O,W,N,H,q,Q;U[0]=new t.Mesh(new t.BoxGeometry(.1,.1,.1),new t.MeshBasicMaterial),U[0].position.set(0,1.5,0),U[1]=new t.Mesh(new t.BoxGeometry(.1,.1,.1),new t.MeshBasicMaterial),U[1].position.set(0,1.5,1);let j=0,K=!1,k=0;const J=[],X=new t.Vector3,Y=new t.Vector3,Z=new t.Quaternion,$=new t.Object3D,ee=new Float32Array(4*L),te=new Float32Array(4*L),ne=new Float32Array(4*L),oe={};let re=!1;const ae={p:0,e:0};let ie,se,le,ce,ue=0,de=0,he=0,fe=0,me=10,ve=0,pe=0,xe=null,ge=null,ye=null;const we=new Uint8Array(32),Me={player:new t.Color(16777215),enemy:new t.Color(16711680)};let Ce=[];function De(){W=new d(E,E,O);const e=W.createTexture(),t=W.createTexture(),n=W.createTexture();!function(e,t){const n=e.image.data,o=t.image.data;for(let e=0,t=n.length;e<t;e+=4)e<256?(U[e/4],n[e+0]=0,n[e+1]=0,n[e+2]=0,n[e+3]=.1,o[e+3]=1):(n[e+0]=0,n[e+1]=0,n[e+2]=0,n[e+3]=99,o[e+0]=0,o[e+1]=0,o[e+2]=0,o[e+3]=0)}(e,t),N=W.addVariable("tV",f(),t,te),N.material.uniforms.d={value:3},H=W.addVariable("tP",v(),e,ne),q=W.addVariable("tA",x(),n,ee),W.setVariableDependencies(N,[H,N]),W.setVariableDependencies(H,[H,N]),W.setVariableDependencies(q,[H,N]),W.init()}V(void 0,void 0,void 0,(function*(){var e;const o=new t.Scene;o.background=new t.Color(5263440);const r=new t.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.01,200);r.position.set(0,4,10),r.lookAt(0,0,0),navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(e){const t=new window.AudioContext;se=t.createAnalyser(),se.fftSize=32,se.smoothingTimeConstant=.8,se.minDecibels=-100,se.maxDecibels=-5,le=t.createMediaStreamSource(e),le.connect(se)})).catch((function(e){})),o.add(r);const a=function(e,n,o,r){const a=new t.PlaneGeometry(50,50,20,20),i=new t.MeshBasicMaterial({color:3833156,wireframe:!1,map:s()});i.map&&(i.map.magFilter=t.NearestFilter);const l=new t.Mesh(a,i);l.rotation.x=-Math.PI/2;const c=l.geometry.attributes.position.array;for(let e=0;e<c.length;e+=3)c[e+2]=Math.sin(c[e]/10-Math.PI/2)*Math.cos(c[e+1]/10)*5+5;return l.updateMatrixWorld(!0),l.geometry.attributes.position.needsUpdate=!0,l.geometry.computeVertexNormals(),l}();o.add(a);const i=function(e,n){const o=new t.PlaneGeometry(.2,1),r=new t.ShaderMaterial({vertexShader:B(),fragmentShader:"\nvarying vec2 vUv;\nvoid main() { \n    vec3 gc = mix(vec3(0.1, 0.6, 0.1), vec3(0.8, 1.0, 0.2), vUv.y);\n    gl_FragColor = vec4(gc, 1.0);\n}\n    ",side:t.DoubleSide,uniforms:{time:{value:0}}}),a=new t.InstancedMesh(o,r,e);a.frustumCulled=!1;const i=new Float32Array(2*e),s=new Float32Array(e);for(let t=0;t<e;t++)i[2*t]=50*(Math.random()-.5),i[2*t+1]=50*(Math.random()-.5),s[t]=Math.random();return a.geometry.setAttribute("offset",new t.InstancedBufferAttribute(i,2)),a.geometry.setAttribute("random",new t.InstancedBufferAttribute(s,1)),{grassInstances:a,grassGeometry:o}}(1e4);function s(){const e=new Uint8Array(65536);for(let t=0;t<16384;t++){const n=4*t,o=.5*Math.random()+.5;e[n]=34*o,e[n+1]=139*o,e[n+2]=34*o,e[n+3]=255}const n=new t.DataTexture(e,128,128,t.RGBAFormat);return n.needsUpdate=!0,n}ce=i.grassInstances,o.add(ce);const l=new t.MeshBasicMaterial({side:t.BackSide,depthWrite:!1});l.onBeforeCompile=e=>{e.uniforms.time={value:0},e.vertexShader="varying vec2 vUv;\nvarying vec3 vWorldPosition;\n"+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","#include <begin_vertex>\n      vUv = uv;\n      vec4 worldPosition=modelMatrix*vec4(position,1.0);\n      vWorldPosition=worldPosition.xyz;\n      "),e.fragmentShader="uniform float time;\nvarying vec2 vUv;\nvarying vec3 vWorldPosition;\n"+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <logdepthbuf_fragment>","#include <logdepthbuf_fragment>\n      vec3 a=vec3(0.039,0.141,0.447);\n      vec3 b=vec3(0.0,0.467,0.745);\n      vec3 c=vec3(0.529,0.807,0.922);\n      float h=normalize(vWorldPosition).y;\n      if (h>0.0){diffuseColor.rgb=mix(b,a,smoothstep(0.0,1.0,h));}else{\n        diffuseColor.rgb=mix(c,b,smoothstep(-1.0,0.0,h));}\n      ")};const u=new t.SphereGeometry(100,32,32),d=new t.Mesh(u,l);o.add(d);const h=new t.DirectionalLight(16777215,3);h.position.set(0,1,2),o.add(h);const f=new t.AmbientLight(16777215,1);o.add(f),O=new t.WebGLRenderer({antialias:!0,powerPreference:"high-performance"}),O.xr.enabled=!0;const m=new n(O);O.setPixelRatio(window.devicePixelRatio),O.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(O.domElement);const v=()=>{const e=window.innerWidth,t=window.innerHeight;O.setSize(e,t),r.aspect=e/t,r.updateProjectionMatrix()};function p(){const e=[];return e.push(new t.Vector2(0,0)),e.push(new t.Vector2(.03,0)),e.push(new t.Vector2(.05,.14)),e.push(new t.Vector2(0,.14)),new t.LatheGeometry(e,4)}function x(e=0){const n=new t.Group,o=new t.CylinderGeometry(.05,.05,.4,3),r=new t.MeshPhongMaterial({color:65280,transparent:!0,flatShading:!0});n.userData.stemMaterial=r;const a=new t.Mesh(o,r);a.position.y=-.25,n.add(a);const i=[];i.push(new t.Vector2(0,0)),i.push(new t.Vector2(.1,.05)),i.push(new t.Vector2(0,.1));const s=new t.LatheGeometry(i,6),l=new t.MeshPhongMaterial({color:16776960,flatShading:!0,transparent:!0});n.userData.flowerMaterial=l;const c=new t.Mesh(s,l);c.position.y=-.05,n.add(c);const u=p(),d=new t.MeshPhongMaterial({color:16777215,side:t.DoubleSide,flatShading:!0});let h;if(e)h=e;else for(;13===(h=Math.ceil(30*Math.random())););n.userData.seeds=h;const f=new t.InstancedMesh(u,d,h);n.add(f);const m=function(e=200,n=.5){const o=[],r=Math.PI*(3-Math.sqrt(5));for(let a=0;a<e+1;a++){const i=1-a/e*2,s=Math.sqrt(1-i*i),l=r*a,c=Math.cos(l)*s,u=Math.sin(l)*s;a<e&&o.push(new t.Vector3(c*n,i*n,u*n))}if(o.length!==e)throw new Error("Fibonacci sphere generation failed");return o}(h,.2),v=new t.Object3D;f.userData.orig=[],m.forEach(((e,n)=>{v.position.copy(e);const o=e.clone().normalize(),r=(new t.Quaternion).setFromUnitVectors(new t.Vector3(0,1,0),o);f.userData.orig.push({position:v.position.clone(),quaternion:r}),v.setRotationFromQuaternion(r),v.updateMatrix(),f.setMatrixAt(n,v.matrix)})),f.instanceMatrix.needsUpdate=!0,n.userData.instancedSeeds=f;const x=new t.CapsuleGeometry(.5,.6,16,16),g=new t.MeshBasicMaterial({color:16776960,visible:!1,transparent:!0,opacity:.5}),y=new t.Mesh(x,g);return y.position.y=-.25,n.add(y),n}function g(e,n=0,r=2,a=!1){let i=1-Ce.filter((e=>13===e.userData.seeds)).length;for(let s=0;s<e;s++){const e=x(i>0?13:0);let s,l,c;i=Math.max(0,i-1);let u=0;do{const e=2*Math.random()*Math.PI;if(c=Math.sqrt(Math.random()*(r*r-n*n)+n*n),s=c*Math.cos(e),l=c*Math.sin(e),u++,u>100)break}while(Ce.some((e=>e.position.distanceTo(new t.Vector3(s,0,l))<.5)));e.position.set(s,0,l),e.position.setY(w(s,l)-.5),e.userData.growth=0,e.userData.origHeight=e.position.y,a?e.position.y+=1:Ce.push(e),o.add(e)}}function w(e,n){const o=new t.Raycaster;o.set(new t.Vector3(e,10,n),new t.Vector3(0,-1,0));const r=o.intersectObject(a);return r.length>0?r[0].point.y:0}window.addEventListener("resize",(function(){v()})),De(),g(13,0,2),g(100,2,25,!0),function(){const e=p();e.rotateX(-Math.PI/2);const n=new t.InstancedBufferGeometry;n.index=e.index,n.attributes.position=e.attributes.position,n.attributes.uv=e.attributes.uv,n.attributes.normal=e.attributes.normal,n.instanceCount=L;const r=new Float32Array(2*L);let a=0;for(let e=0;e<E;e++)for(let t=0;t<E;t++)r[a++]=t/63,r[a++]=e/63;n.setAttribute("dtUv",new t.InstancedBufferAttribute(r,2)),z={tP:{value:null},tV:{value:null},eC:{value:Me.enemy},pC:{value:Me.player}};const i=new t.ShaderMaterial({uniforms:z,vertexShader:y(),fragmentShader:M(),side:t.DoubleSide}),s=new t.InstancedMesh(n,i,L);s.frustumCulled=!1,o.add(s)}(),Q=new c,o.add(Q.instancedMesh);const C=Q.addText("|".repeat(me),new t.Color(255));null==C||C.setPosition(0,-100,0),null==C||C.setScale(.2);const D=Q.addText("0",new t.Color(16777215));null==D||D.setPosition(0,-100,0),null==D||D.setScale(.3),null==D||D.updateText("0");const T=Q.addText("",new t.Color(16777215),!0,[0,0,-1]),_=new t.AudioListener;r.add(_);const P=e=>{const n=new t.PositionalAudio(e);return n.setRefDistance(2),n.setVolume(.4),o.add(n),n},b={p:[1,2,3,4].map((()=>P(_))),e:[1,2,3,4].map((()=>P(_)))};o.add(Q.instancedMesh);const S=yield null===(e=navigator.xr)||void 0===e?void 0:e.isSessionSupported("immersive-vr"),R=S?"Engage remote reality":"Remote reality is required";function q(e,t){oe[e]||(oe[e]=[]),oe[e].push(t)}function ee(e,t){if(!oe[e])return;const n=oe[e].indexOf(t);n>-1&&oe[e].splice(n,1)}function te(e){o.remove(e),Ce=Ce.filter((t=>t!==e)),ge=null}function ne(e,t,n=0){t.add($),e&&($.position.set(0,n,0),$.rotation.set(0,Math.PI/2,0),$.updateMatrixWorld(!0),$.getWorldQuaternion(Z),$.getWorldPosition(X),e.setPosition(X.x,X.y,X.z),Q.setRotation(e.instanceId,Z)),$.removeFromParent()}function Te(e){const n=function(e){const n=I[e],o=new t.Matrix4;n.updateMatrixWorld(),o.identity().extractRotation(n.matrixWorld);const a=new t.Raycaster;return a.near=.01,a.far=.3,a.camera=r,a.ray.origin.setFromMatrixPosition(n.matrixWorld),a.ray.direction.set(0,0,-1).applyMatrix4(o),a.intersectObjects(Ce)}(e);var o,a;n.length>0&&(o=n[0].object,a=e,ge&&te(ge),o.parent&&(void 0!==a&&(I[a].add(o.parent),o.parent.position.set(0,.2,-.1)),ye=o.parent))}q("tA",(e=>{!function(e){if(re)return;ae.e=0,ae.p=0;for(let t=0;t<e.length;t+=4)if(e[t+3]<=-1e5){const n=Math.floor((-e[t+3]-1e5-.5)*E),o=U[n];o&&o.userData.lives&&(o.userData.lives+=1,o.userData.text.updateText("|".repeat(o.userData.lives)),o.userData.canLaunch=!0,A("e",o.position,b,15))}else if(e[t+3]<0){const n=Math.floor((-e[t+3]-.5)*E),r=U[n],a=e[t+1]<.6005?"p":"e";0===n?(me-=1,null==C||C.updateText("|".repeat(Math.max(me,0)))):r&&(A(a,r.position,b,10),r.userData.lives-=1,fe+=10*(ue+1),null==D||D.updateText(`${fe}`),r.userData.text.updateText("|".repeat(Math.max(r.userData.lives,0))),r.userData.lives<=0&&(de++,U[n]=null,o.remove(r)))}else e[t+3]>0&&(e[t+1]<.6005&&e[t+1]>.5995?ae.p++:e[t+1]>.6005&&e[t+1]<.6015&&ae.e++);let t;4===ue?t="You defeated the aliens!":me<=0&&(t="Connection lost."),t&&(t+=` Wave ${ue} Score ${fe}`,K=!1,O.xr.isPresenting&&(m.endSession(),v()),document.getElementById("p").innerHTML=t,function(){G=Date.now();const e=K?"none":"block";document.getElementById("p").style.display=e}())}(e)})),O.setAnimationLoop((function(e){var n;pe++;const a=e-k;if(k=e,Ce.forEach(((e,t)=>{const n=.001*performance.now();e.rotation.y=.05*Math.sin(n*(t/10)+t/3)})),ge&&(ge.userData.removeIn?(ge.userData.removeIn-=a,"controller"===(null===(n=ge.parent)||void 0===n?void 0:n.userData.type)&&(ge.getWorldPosition(X),ge.removeFromParent(),ge.position.copy(X),o.add(ge)),ge.position.y-=.01*(1e3-ge.userData.removeIn)*(a/1e3),ge.userData.removeIn<=0&&te(ge)):ge.userData.removeIn=1e3),ce.material.uniforms.time.value=performance.now()/1e3,se&&se.getByteFrequencyData(we),O.xr.isPresenting&&(O.xr.getCamera().getWorldPosition(X),U[0]&&U[0].position.copy(X),U[1]&&U[1].position.copy(X),X.y=0,X.length()>2.5)){const e=O.xr.getReferenceSpace();if(e){const t=new XRRigidTransform(X,void 0),n=e.getOffsetReferenceSpace(t);O.xr.setReferenceSpace(n)}}if(ye&&ye.userData.seeds>0)xe=function(){let e=null;if(ye){let n=r;O.xr.isPresenting?(n=O.xr.getCamera(),n.getWorldPosition(X)):n.getWorldPosition(X),ye.getWorldPosition(Y);const o=(new t.Vector3).subVectors(Y,X).normalize(),a=new t.Raycaster(Y,o);let i=1e3,s=0;if(U.forEach(((t,n)=>{if(n<2||0===(null==t?void 0:t.userData.lives))return;if(!t)return;const o=a.ray.distanceToPoint(t.position);o<i&&(i=o,e=t),o>s&&(s=o),t.userData.distance=o})),U.forEach(((e,t)=>{if(t<2||0===(null==e?void 0:e.userData.lives))return;if(!e)return;e.userData.currentTarget=!1;const n=(e.userData.distance-i)/(s-i);e.material.color.setRGB(1-n,n,0)})),e&&(e.userData.currentTarget=!0,e.userData.text.updateText("Target")),null!==e)return e}return null}();else for(let e=2;e<U.length;e++){const t=U[e];t&&(t.material.color.setRGB(1,0,0),t.userData.currentTarget=!1)}if(se&&ye){const e=we.slice(4,32),n=Math.max(...e)/255;ve=.9*ve+.1*n,function(e,n){const o=O.xr.isPresenting?O.xr.getCamera():r,a=.001*performance.now(),i=e.userData.instancedSeeds,s=i.userData.orig,l=e.userData.instancedSeeds.count,c=new t.Object3D;e.getWorldPosition(X);const u=(new t.Vector3).subVectors(X,o.position).normalize(),d=new t.Quaternion;e.getWorldQuaternion(d);const h=(new t.Matrix4).makeRotationFromQuaternion(d).invert(),f=u.applyMatrix4(h).normalize();for(let e=0;e<l;e++){const o=s[e].position,r=s[e].quaternion,l=n*(Math.PI/4)+.2*Math.sin(2*a+.1*e)*(.2+.8*n),u=(new t.Vector3).crossVectors(new t.Vector3(0,1,0),f).normalize();c.position.copy(o),c.quaternion.copy(r),c.rotateOnAxis(u,l);const d=new t.Vector3(0,1-Math.cos(l),0).multiplyScalar(.05);if(c.position.add(d),0===n){const n=.001*Math.sin(3*a+.2*e);c.rotateOnAxis(new t.Vector3(1,0,0),n),c.rotateOnAxis(new t.Vector3(0,0,1),n)}c.updateMatrix(),i.setMatrixAt(e,c.matrix)}i.instanceMatrix.needsUpdate=!0}(ye,4*ve),ve>.3&&xe&&(function(e,n){const o=new t.Object3D,r=new t.Vector3,a=new t.Matrix4,i=[];for(let s=0;s<e.userData.seeds;s++){o.parent=e,e.userData.instancedSeeds.getMatrixAt(s,a),a.decompose(o.position,o.quaternion,o.scale),o.getWorldPosition(r);const l={pos:r.clone(),rot:r,start:13===e.userData.seeds?U[1]:U[0],target:n,owner:"p"},c=new t.Vector3(r.x,r.y,r.z);c.normalize(),c.applyQuaternion(o.quaternion),l.rot=c,i.push(l)}13===i.length&&(null==T||T.updateText("Hacked")),J.push(...i),e.userData.seeds=0,Pe(n)}(ye,xe),ve=0)}if(K){0===j&&(null==T||T.setScale(.5)),j+=a,j<5e3?null==T||T.updateText("Pick up dandelion with trigger"):j<1e4?null==T||T.updateText("Blow it to launch"):j<15e3&&(null==T||T.setScale(1),null==T||T.updateText(""));for(let e=2;e<U.length;e++){const t=U[e];t&&!t.userData.currentTarget&&Pe(t)}pe%10==0&&U.forEach((e=>{e&&e.userData.canLaunch&&e.userData.lives>0&&function(e){if(-1!==U.indexOf(e)){for(let n=0;n<e.userData.lives;n++){const n=e.position.clone();X.set(Math.random()-.5,Math.random()-.5,Math.random()-.5),X.multiplyScalar(.1),n.add(X);const o=new t.Vector3(Math.random(),Math.random(),Math.random()),r="e";J.push({pos:n,rot:o,start:e,target:U[0],owner:r})}e.userData.canLaunch=!1,e.userData.lives=0,e.userData.text.updateText("")}}(e)})),function(){if(O.xr.isPresenting)for(let e=0;e<2;e++){const t=O.xr.getController(e);"left"===t.userData.handedness&&(ne(C,t,.03),ne(D,t,-.04)),$.removeFromParent()}}(),function(){for(let e=0;e<Ce.length;e++){const t=Ce[e];t.userData.growth<1&&(t.userData.growth=Math.min(1,t.userData.growth+.001*t.userData.seeds),t.position.y=t.userData.origHeight+t.userData.growth)}Ce.length<13&&g(1,0,2)}(),function(){const e=U.filter((e=>e&&"enemy"===e.userData.type&&!1!==e.userData.canLaunch));if(20===de&&(ue++,ie=Date.now(),de=0,null==T||T.updateText(`Wave ${ue}`)),ie&&Date.now()-ie>1e4)ie=null,null==T||T.updateText("");else if(ie)return;(!he||Date.now()-he>3e3-800*ue)&&(e.length<20&&function(e=0){e=Math.floor(Math.random()*(e+1));const n=new t.OctahedronGeometry(.2*(e+1),e),r=new t.MeshPhongMaterial({color:16711680,flatShading:!0}),a=new t.Mesh(n,r),i=Math.random()*Math.PI*2;a.position.set(25*Math.cos(i),-5,25*Math.sin(i));const s=Q.addText("",new t.Color(16711680),!0);null==s||s.setPosition(a.position.x,a.position.y+1,a.position.z),null==s||s.setScale(5-1*e),a.userData.text=s,a.userData.type="enemy",a.userData.lives=4*(e+1),a.userData.rising=!0,null==s||s.updateText("|".repeat(a.userData.lives)),o.add(a);const l=U.map(((e,t)=>e||t<=1?null:t)).filter((e=>null!==e)),c=l[Math.floor(Math.random()*l.length)];c&&(U[c]=a)}(ue),he=Date.now()),e.forEach(((e,n)=>{e.userData.text.setPosition(e.position.x,e.position.y+1,e.position.z),e.position.y<10&&e.userData.rising?e.position.y+=.01*(10.5-e.position.y)*(ue+1):e.userData.rising=!1;const r=new t.Vector3(0,1.5,0);U[0]&&r.copy(U[0].position);const a=(new t.Vector3).subVectors(r,e.position).normalize();e.position.add(a.multiplyScalar(.01*(ue+1))),e.position.distanceTo(r)<.3&&(U[U.indexOf(e)]=null,e.userData.text.remove(),o.remove(e),me-=1,A("e",e.position,b,2),null==C||C.updateText("|".repeat(me)))}))}(),pe%10==0&&function(){if(re)return;const e=W.createTexture(),t=W.createTexture();let n=0;const o=[],r=n=>{e.image.data.set(n);const a=e.image.data;for(let e=0;e<U.length;e++){if(null===U[e])continue;const t=4*e;a[t]=U[e].position.x,a[t+1]=U[e].position.y,a[t+2]=U[e].position.z,a[t+3]=.1}for(let e=0;e<o.length;e++){const t=o[e],n=J[e];"p"===n.owner?(a[t]=n.pos.x,a[t+1]=n.pos.y,a[t+2]=n.pos.z,a[t+3]=.6):(a[t]=n.pos.x,a[t+1]=n.pos.y,a[t+2]=n.pos.z,a[t+3]=.601)}ee("tP",r),e.needsUpdate=!0;const i=W.getCurrentRenderTarget(H);W.renderTexture(e,i),t.needsUpdate=!0;const s=W.getCurrentRenderTarget(N);W.renderTexture(t,s),re=!1,o.length>0&&(o.length=0,J.length=0),ye&&!ye.userData.seeds&&ye.userData.instancedSeeds.count&&(ye.userData.instancedSeeds.count=0)},a=e=>{var i;re=!0,t.image.data.set(e);const s=t.image.data,l=U.filter(((e,t)=>null!==e&&t>1&&e.userData.lives>0));l.sort(((e,t)=>e.position.length()-t.position.length()));const c=l[0],u=U.indexOf(c);for(let e=0;e<s.length;e+=4){const t=J[n];if(t&&n<J.length+1){const r=(U.indexOf(t.target)+.5)/E+.5,a=be((U.indexOf(t.start)+.5)/E+.5,r);0===s[e+3]&&(s[e]=t.rot.x,s[e+1]=t.rot.y,s[e+2]=t.rot.z,s[e+3]=a,n++,o.push(e))}const[r,a]=Se(s[e+3]),l=Math.floor((a-.5)*E);if(a>0&&(!U[l]||0===(null===(i=U[l])||void 0===i?void 0:i.userData.lives))&&e>256){const t=be(r,(u+.5)/E+.5);s[e+3]=t}}Math.floor(J.length),ee("tV",a),q("tP",r)};(J.length>0||pe%10==0)&&q("tV",a)}(),G=G||Date.now(),W.compute(oe);const e=W.getCurrentRenderTarget(H).texture,n=W.getCurrentRenderTarget(N).texture;z.tP.value=e,z.tV.value=n}O.render(o,r)}));const _e=document.getElementById("b");function Pe(e){e.userData.text.updateText("|".repeat(Math.max(e.userData.lives,0)))}function be(e,t){const n=Math.floor(1e3*e);return Math.sign(t)*(10*n+Math.abs(t))}function Se(e){const t=e%10;return[Math.floor(e/10)/1e3,t]}_e&&(_e.innerHTML=R,(S||window.location.search.includes("force"))&&(_e.style.cursor="pointer",_e.style.color="#fff",_e.addEventListener("click",(function(){var e;return V(this,void 0,void 0,(function*(){S&&(yield m.startSession(),O.xr.setFoveation(0),function(){for(let e=0;e<2;e++){const n=O.xr.getController(e);n.addEventListener("connected",(e=>{n.userData.handedness=e.data.handedness})),o.add(n),n.userData.type="controller";const r=new t.BoxGeometry(.025,.025,.2),a=new t.MeshStandardMaterial({color:Me.player}),i=new t.Mesh(r,a);n.add(i),I.push(n),n.addEventListener("selectstart",(()=>Te(e))),n.addEventListener("selectend",(()=>{ye&&(ge=ye,ye=null)}))}}()),(new F).start(),null===(e=document.getElementById("s"))||void 0===e||e.remove(),K=!0,window.scene=o}))}))))}))})()</script>