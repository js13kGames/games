function generateMineData(){for(var e=[],t=0;t<instructions.length;t++)e.push({id:"instructions"+t,coords:instructions[t][0],words:[{size:16,distance:0,color:instructions[t][2]||"#465462",text:instructions[t][1]}]});e.push({id:"l0",coords:xy(start,150),words:[{size:24,distance:70,text:"entry to\nan abandoned\nspace station",pbatch:"ss"},{size:24,distance:70,text:"entry to\nan abandoned\nspace station\n[+][ ]",pbatch:"ss",triggers:{checkpoint:1,showArea:"spacestation",hideArea:"outside"}},{size:36,distance:10,text:"inside the\nspace station"}]});for(var i=[{id:"l5",area:"end",hidden:1,words:[{size:14,distance:300,text:"a cylindrical airlock"},{size:28,distance:100,text:"escape shuttle entrance\n[ ][ ]",pbatch:"end"},{size:28,distance:100,text:"escape shuttle entrance\n[+][ ]",pbatch:"end",triggers:{win:1}},{size:72,distance:30,text:"blasting away\nto safety"}]},{id:"l4",area:"spacestation",wirable:1,words:[{size:14,distance:300,text:"$cover"},{size:20,distance:100,requirePower:1,requireWires:["l3"],text:"shuttle\nsystem control",triggers:{wire:1,showArea:"end"}},{size:28,distance:30,text:"shuttle\npowered up"}]},{id:"l3",area:"spacestation",wirable:1,words:[{size:14,distance:300,text:"$cover"},{size:20,distance:100,requirePower:1,text:"propulsion\nsystem control",triggers:{lifeSupportOn:1,wire:1}},{size:28,distance:30,text:"propulsion system\npowered up",triggers:{wire:1}}]},{id:"l2",area:"spacestation",wirable:1,words:[{size:14,distance:300,text:"$cover"},{size:20,distance:100,requirePower:1,text:"life support\nsystem control",triggers:{lifeSupportOn:1,wire:1}},{size:28,distance:30,text:"life support\npowered up",triggers:{wire:1}}]}],r=["switch","explosion"],t=0,n=start+xstep;xmax>n;n+=xstep){var a=xy(n,randInt(centerLane[0],centerLane[1]));if(t%2==0){var o=i.pop();o?(o.coords=a,e.push(o)):0}else{var s={id:t,coords:a,area:"spacestation"},c=choice(r);r.forEach(function(t){c==t&&e.push(templates[t](s))})}t+=1}for(var d=["source","oxygen","checkpoint"],t=0,n=start+3*xstep/2;xmax>n;n+=xstep){var c=0===t?"source":choice(d),p=choice([upperEdge,lowerEdge]),s={id:t,coords:xy(n,randInt(p[0],p[1])),area:"spacestation"};d.forEach(function(t){c==t&&e.push(templates[t](s))}),t+=1}return e.forEach(function(e){"spacestation"===e.area&&(e.hidden=1)}),e.forEach(function(e){if(e.words.forEach(function(e){for(var t in randomWords)e.text=e.text.replace("$"+t,choice(randomWords[t]))}),!e.noTerminal){var t=e.words[e.words.length-1],i={distance:-1,text:t.text},r=["color","size","glitchLevel"];r.forEach(function(e){t[e]&&(i[e]=t[e])}),t.triggers&&"wire"in t.triggers&&(i.triggers={wire:t.triggers.wire}),e.words.push(i)}}),e}function vivify(e,t){if(e.code){if(!(e.code in games))return t.emit("bad_code");e.game=games[e.code],"mine_index"in e&&(e.mine=e.game.getMine(e.mine_index)),"name"in e&&(e.player=e.game.getPlayer(e.name)),"name2"in e&&(e.player2=e.game.getPlayer(e.name2))}return e.coords&&(e.coords.x=parseFloat(e.coords.x),e.coords.y=parseFloat(e.coords.y)),e}var templates={};templates.explosion=function(e){return{id:"explosion"+e.id,coords:e.coords,area:e.area,lvl0border:1,noTerminal:1,words:[{size:14,glitchLevel:choice([0,1]),distance:200,text:"$cover"},{size:12,glitchLevel:2,distance:50,text:"$explosion1",triggers:{death:1}},{size:36,glitchLevel:4,distance:49,text:"$explosion2",trigger:{death:1,spawn:{template:"debris",count:5,distance:50,delay:150,pause:0,params:{id:"g1"+Math.random()}}}}]}},templates.debris=function(e){return{id:"debris"+e.id,coords:e.coords,words:[{size:8,glitchLevel:2,distance:30,text:"debris",triggers:{death:1}}]}},templates["switch"]=function(e){return{id:"switch"+e.id,coords:e.coords,area:e.area,wirable:1,words:[{size:10,distance:75,text:"$cover"},{size:12,distance:30,text:"power router node",triggers:{wire:1}}]}},templates.source=function(e){return{id:"source"+e.id,coords:e.coords,area:e.area,wirable:1,words:[{size:10,distance:100,text:"$cover",triggers:{setPower:1}},{size:12,distance:50,text:"$power",glitchLevel:choice([0,1,2]),triggers:{wire:1}}]}},templates.checkpoint=function(e){return{id:"checkpoint"+e.id,coords:e.coords,area:e.area,words:[{size:10,distance:50,text:"checkpoint\n[ ][ ]",pbatch:"cp",triggers:{checkpoint:1}},{size:10,distance:50,text:"checkpoint\n[+][ ]",pbatch:"cp",triggers:{checkpoint:1}},{size:10,distance:0,text:"checkpoint\n[+][+]"}]}},templates.oxygen=function(e){return{id:"oxygen"+e.id,coords:e.coords,area:e.area,words:[{size:12,distance:50,text:"oxygen supply",triggers:{spawn:{template:"oxy",count:4,distance:50,delay:100,pause:0,params:{id:e.id}},hide:1}}]}},templates.oxy=function(e){return{id:"oxy"+e.id,coords:e.coords,words:[{size:8,distance:30,text:"oxygen",triggers:{oxygen:.2,hide:1}}]}};var randomWords={cover:["control\npanel","tangled\nwires","system\ncircuitry","exposed\nmotherboard","cluttered\nconsole","messy\ncrawlspace","prominent\nmainframe"],power:["solar\narray","nuclear\ngenerator","fusion\nreactor","em drive","thermal\nrecycler"],explosion1:["a shining speck\nof light","a blinking\nlight","mysterious\nticking noise","pressurized\nnoxious gas","a tempting\nbutton","don't touch this."],explosion2:["explosion","power surge","localized\ndetonation","sudden blast"]},instructions=[[xy(200,180),"how to play:"],[xy(350,250),"1.\nmove with arrow keys"],[xy(280,380),"2.\nmeet your teammates\nto create wires"],[xy(600,500),"3.\nplace both ends of the wire\n on two systems\nto connect them together"],[xy(800,350),"find & power up the shuttle\nso you can escape home!","#466253"],[xy(1100,480),"do not run\nout of oxygen.","#504247"]],centerLane=[150,450],upperEdge=[50,150],lowerEdge=[450,550],xstep=400,xmax=5e3,start=720;Game.prototype.addPlayer=function(e,t){var i=xy(40,randInt(40,440)),r=new Player({name:e,game:this,coords:i,checkpoint:i});return r.socket=t,this.players.push(r),this.emit("player_joined",{name:r.name,data:r.data()}),r},Game.prototype.populate=function(){var e=this,t=generateMineData();t.forEach(function(t){t.game=e,e.addMine(new Mine(t));e.mines[e.mines.length-1]})},Game.prototype.addMine=function(e){return e.index=this.mines.length,e.game=this,this.mines.push(e),this},Game.prototype.getArea=function(e){return this.mines.filter(function(t){return t.area===e})},Game.prototype.emit=function(e,t,i){return i=i||{},t.game||(t.game=this.serialize()),this.eachPlayer(function(i){i.socket.emit(e,t)}),this},Game.prototype.start=function(){var e=this;e.stage=game_stages.gameplay,setTimeout(function(){e.tick()},Settings.tickTimeout)},Game.prototype.tick=function(){var e=this;e.stage===game_stages.gameplay&&(e.drainOxygen&&e.eachPlayer(function(e){e.drainOxygen(Settings.oxygenDrain)}),e.emit("tick",{}),setTimeout(function(){e.tick()},Settings.tickTimeout))},Game.prototype.win=function(){this.stage=game_stages.ending,this.emit("game-over",{reason:"You have escaped!"})},Game.prototype.lose=function(){var e=this;e.stage=game_stages.ending,setTimeout(function(){e.emit("game-over",{reason:"Someone ran out of oxygen."})},2e3)};var getGame=_.propFinder(games,"code"),games={};module.exports=function(e){setupSocket(e),e.bind("disconnect",function(){}),e.bind("error",function(){}),e.bind("new_game",function(t){var i=vivify(t,e),r=new Game;games[r.code]=r,r.populate(),r.addPlayer(i.name,e),r.start()}),e.bind("join_game",function(t){var i=vivify(t,e);i.game&&i.game.addPlayer(i.name,e)}),e.bind("mine_level_up",function(t){var i=vivify(t,e);if(i.mine&&i.game){if(!i.mine.canPlayerTrigger(i.player))return;i.mine.trigger(i.player),i.mine.levelUp(i.player),i.mine.emitUpdate()}}),e.bind("mine_level_down",function(t){var i=vivify(t,e);if(i.mine&&i.game){if(!i.mine.canPlayerTrigger(i.player))return;i.mine.levelDown(i.player),i.mine.emitUpdate()}}),e.bind("player-update-coords",function(t){var i=vivify(t,e);i.player.coords=i.coords,i.game.emit("player-update-coords",{code:i.game.code,name:i.player.name,coords:i.coords})}),e.bind("player-meet",function(t){var i=vivify(t,e),r=i.player,n=i.player2;r.hasWireTo(n)||(r.addWireTo(n),n.addWireTo(r))}),e.bind("player-snap",function(t){var i=vivify(t,e),r=i.player,n=i.player2;r.removeWire(n),n.removeWire(r)});var t=["player-move-start","player-move-stop"];t.forEach(function(t){e.bind(t,function(e){games[e.code].emit(t,e)})})},Mine.prototype.increment=function(){this.stage+=1},Mine.prototype.emitUpdate=function(){this.game.emit("update_mine",{mine_index:this.index,mine:this.data()})},Mine.prototype.trigger=function(e){e._lastTriggeredMine=this.id;var t=this.getWord().triggers||{};for(var i in t)i in Triggers&&Triggers[i](e,this,t[i])},Mine.prototype.addWireTo=function(e){if(!this.hasWireTo(e)){this.wires.push(e.id),this.game.emit("wire-add",{wire_id:getWireId(this.id,e.id)}),this.emitUpdate();var t=this;setTimeout(function(){t.propagatePower()},200)}},Mine.prototype.powerUp=function(){this.powered||(this.powered=.5),this.game.emit("mine-powerup",{mine_index:this.index,powered:this.powered})},Mine.prototype.propagatePower=function(){var e=this;0!==e.powered&&(e.powerUp(),e.wires.forEach(function(t){var i=e.game.getMineById(t);i.powered||(i.powerUp(),setTimeout(function(){i.propagatePower()},200))}))},Player.prototype.emitUpdate=function(){this.game.emit("player-update",{name:this.name,player:this.data()})},Player.prototype.setCheckpoint=function(e){this.checkpoint=e,this.socket.emit("checkpoint",{coords:e})},Player.prototype.addWireTo=function(e){this.hasWireTo(e)||(this.wires.push(e.name),this.game.emit("wire-add",{wire_id:getWireId(this.name,e.name)}),this.emitUpdate())},Player.prototype.removeWire=function(e){this.hasWireTo(e)&&(this.wires.splice(this.wires.indexOf(e.name),1),this.game.emit("wire-remove",{player1:this.name,player2:e.name}))},Player.prototype.drainOxygen=function(e){this.oxygen=clamp(this.oxygen-e,0,1),this.emitUpdate(),this.oxygen<=0&&this.reallyDie()},Player.prototype.die=function(){this.coords=this.checkpoint,this.glitchLevel+=Settings.glitchPerDeath,this.game.emit("die",{name:this.name,player:this.data()})},Player.prototype.reallyDie=function(){this.game.lose()};var Triggers={};Triggers.death=function(e,t){e.die()},Triggers.checkpoint=function(e,t){e.setCheckpoint(t.coords)},Triggers.oxygen=function(e,t,i){e.drainOxygen(-i)},Triggers.hide=function(e,t){t.hidden||(t.hidden=1,t.game.emit("update_mine",{mine_index:t.index,mine:t.data()}))};var displayTriggers=["showArea","hideArea"];displayTriggers.forEach(function(e){Triggers[e]=function(t,i,r){i.game.getArea(r).forEach(function(t){t.hidden="hideArea"===e,i.game.emit("update_mine",{mine_index:t.index,mine:t.data()})})}}),Triggers.spawn=function(e,t,i){for(var r=range(0,2*Math.PI,2*Math.PI/i.count),n=0;n<r.length;n++){i.params.coords=V.add(t.coords,V.rth(i.distance,r[n]));var a=new Mine(templates[i.template](i.params));a.area=a.area||t.area,t.game.addMine(a).emit("update_mine",{"new":1,delay:i.delay+n*i.pause,mine_index:a.index,mine:a.data()})}},Triggers.wire=function(e,t,i){e.forEachWire(function(i){var r=i.getCloseMine();r&&r.wirable&&(r.hasWireTo(t)||t.hasWireTo(r)||(t.addWireTo(r),r.addWireTo(t),e.removeWire(i),i.removeWire(e)))})},Triggers.win=function(e,t){e.game.win()},Triggers.lifeSupportOn=function(e,t){e.game.drainOxygen=0,e.game.eachPlayer(function(e){e.drainOxygen(-(1-e.oxygen))})},Triggers.setPower=function(e,t,i){var r=0===t.powered;t.powered=i,r&&t.propagatePower()};
