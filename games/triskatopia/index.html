<!doctype html><meta content="width=device-width" name=viewport><title>Triskatopia - js13kGames 2024</title><style>body{margin:0;font-family:'Courier New',monospace}.text{background-color:#fff;color:#000;font-size:7vw;font-weight:700;margin:0 auto;padding:10px;width:50%;text-align:center;position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);mix-blend-mode:screen}.button{border:none;padding:8px 32px;text-align:center;font-size:25px;transition-duration:.4s;cursor:pointer;background-color:#fff;color:#000;border:2px solid #111118;font-family:inherit;text-align:center;z-index:1;position:absolute;top:85%;left:50%;transform:translate(-50%,-50%)}.button:hover{background-color:#9595cb;color:#741290}.popUpClass{visibility:hidden;border:2px solid #111118;background-color:#fff;padding:10px;width:50%;height:60%;position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);z-index:2}.buttonClose{padding:8px 32px;text-align:center;font-size:25px;cursor:pointer;background-color:#fff;color:#000;border:2px solid #111118;font-family:inherit;text-align:center;z-index:1}.buttonClose:hover{background-color:#9595cb;color:#741290}</style><div class=text id=title>Triskatopia</div><button class=button id=introButton style=left:33%>Intro</button> <button class=button id=start style=font-size:40px>Start</button> <button class=button id=aboutButton style=left:66%>About</button><div class=popUpClass id=introID><h3>Instructions</h3><p>1. Select Enter VR if available.<p>2. Control altitude of balloon with ‚è´ ‚è¨ buttons.<p>3. Control tilt of balloon with ‚Ü©Ô∏è ‚Ü™Ô∏è, must be over 3m to tilt.<p>4. Align helper with target.<p>5. Ensure balloon is high enough to clear obstacles; mountains, buildings, trees.<p>6. Reset position and rotation with üè† button<p>7. Hit Launch Button, must be over 3m to launch.</p><br><br><br><button class=buttonClose id=close1>Close ‚ùå</button></div><div class=popUpClass id=aboutID><h3>About</h3><p>Triskatopia created by Shauna Lynch.</p><br><p>September 2024 for js13k competition.</p><br><p>License details here; <a href=https://www.lynchbyte.com/17_Trisk/license_Trisk.html rel=noopener target=_blank>MIT and CC BY-SA 4.0</a></p><br><p>For further information; <a href=https://www.lynchbyte.com/index.html rel=noopener target=_blank>lynchbyte</a></p><br><br><br><button class=buttonClose id=close2>Close ‚ùå</button></div><script type=module>import*as THREE from"/2024/webxr/three.js";let altVar,tiltVar,levelsVar,hudsPlane;const hudVarsArr=[];function addXR_UI(){var e=new THREE.PlaneGeometry(.01,.01),t=new THREE.PlaneGeometry(1.5,2.2),n=new THREE.MeshStandardMaterial({color:"grey",side:THREE.DoubleSide}),o=new THREE.MeshStandardMaterial({color:16777215,side:THREE.DoubleSide,transparent:!0,opacity:.5}),a=new THREE.Mesh(e,n),r=(a.name="UI_UIplane",(e=new THREE.Mesh(e,n)).position.set(-1.5,.1,0),a.add(e),(n=createText("üè†",.4,"Courier New",!0)).position.set(0,0,0),n.name="home",e.add(n),clickable_3D.push(n),(n=createText("‚è´",.4,"Courier New",!0)).position.set(0,.5,0),n.name="altUp",e.add(n),clickable_3D.push(n),(n=createText("‚è¨",.4,"Courier New",!0)).position.set(0,-.5,0),n.name="altDown",e.add(n),clickable_3D.push(n),(n=createText("‚Ü™Ô∏è",.4,"Courier New",!0)).position.set(0,1,0),n.rotation.set(0,0,-Math.PI/2),n.name="tiltUp",e.add(n),clickable_3D.push(n),(n=createText("‚Ü©Ô∏è",.4,"Courier New",!0)).position.set(0,-1,0),n.rotation.set(0,0,-Math.PI/2),n.name="tiltDown",e.add(n),clickable_3D.push(n),n=new THREE.CircleGeometry(.3,32,0,6.28),new THREE.MeshStandardMaterial({color:"orange"}));(n=new THREE.Mesh(n,r)).position.set(-.8,0,0),n.name="Launch",e.add(n),clickable_3D.push(n),(r=createText("Launch",.15,"Courier New",!1)).position.set(-.8,0,.01),e.add(r),(hudsPlane=new THREE.Mesh(t,o)).position.set(1.5,0,0),a.add(hudsPlane),(n=createText("Altitude (m)",.2,"Courier New",!1)).position.set(0,.9,.01),hudsPlane.add(n),(altVar=createText(""+balloonStats.Altitude,.2,"Courier New",!1)).position.set(0,.6,.01),altVar.name="altVar",hudsPlane.add(altVar),(e=createText("Tilt (deg)",.2,"Courier New",!1)).position.set(0,.15,.01),hudsPlane.add(e),(tiltVar=createText(""+THREE.MathUtils.radToDeg(balloonStats.Tilt),.2,"Courier New",!1)).position.set(0,-.15,.01),tiltVar.name="tiltVar",hudsPlane.add(tiltVar),(r=createText("Level",.2,"Courier New",!1)).position.set(0,-.6,.01),hudsPlane.add(r),(levelsVar=createText(""+balloonStats.Level,.2,"Courier New",!0)).position.set(0,-.9,.01),levelsVar.name="levelsVar",hudsPlane.add(levelsVar),hudVarsArr.push(altVar,tiltVar,levelsVar),(t=createText("Exit",.2,"Courier New",!1)).position.set(2.75,0,.01),t.name="exitVR",a.add(t),clickable_3D.push(t),a.position.set(0,0,-3.5),vehicle.add(a)}let newAngle;function upDateHuds(){0!=renderer.xr.isPresenting&&(newAngle=THREE.MathUtils.radToDeg(balloonStats.Tilt).toFixed(1),switcheroo(altVar,balloonStats.Altitude.toFixed(0),altVar.position,"altVar"),switcheroo(tiltVar,newAngle,tiltVar.position,"tiltVar"),switcheroo(levelsVar,balloonStats.Level,levelsVar.position,"levelsVar"))}function switcheroo(e,t,n,o){removeOb(o,hudsPlane),(e=createText(""+t,.2,"Courier New",!1)).position.set(n.x,n.y,n.z),e.name=o,hudsPlane.add(e)}function addBalloon(){var e=new THREE.Mesh(new THREE.SphereGeometry(.005,32,16),new THREE.MeshStandardMaterial);vehicle.add(e),e.visible=!1;const t=new THREE.Group,n=new THREE.Group,o=new THREE.MeshStandardMaterial({color:new THREE.Color(16711782),side:THREE.DoubleSide,flatShading:!0}),a=new THREE.SphereGeometry(2.5,16,32,0,6.283185,0,.5*Math.PI),r=new THREE.SphereGeometry(2.5,16,32,0,6.283185,.1*Math.PI,.4*Math.PI),i=new THREE.Mesh(a,o);t.add(i),(e=new THREE.Mesh(r,o)).rotation.set(Math.PI/180*180,0,0),e.scale.set(1,1.15,1),t.add(e),vehicle.add(t);var e=new THREE.RingGeometry(1,.9,32,1,0,THREE.MathUtils.degToRad(330)),s=new THREE.MeshBasicMaterial({color:new THREE.Color(6697728),side:THREE.DoubleSide}),l=new THREE.Mesh(e,s);l.position.set(0,-1,0),l.rotation.set(THREE.MathUtils.degToRad(90),0,THREE.MathUtils.degToRad(-75));for(let e=0;e<8;e++){const t=l.clone(),o=(t.position.set(0,-.1*e,0),1+-.05*(e+1));t.scale.set(o,o,o),n.add(t)}vehicle.add(n),t.translateY(3.5),n.translateY(-.5),vehicle.traverse(function(e){e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),dummyOb.add(vehicle)}function addBalloonOther(){const e=[new THREE.Vector2(0,0),new THREE.Vector2(1,0),new THREE.Vector2(1.5,1),new THREE.Vector2(.1,1),new THREE.Vector2(.1,2),new THREE.Vector2(2,2),new THREE.Vector2(6.81,9.8),new THREE.Vector2(7.69,11.8),new THREE.Vector2(7.99,13.8),new THREE.Vector2(7.79,15.8),new THREE.Vector2(7.04,17.8),new THREE.Vector2(5.51,19.8),new THREE.Vector2(1.77,21.8),new THREE.Vector2(0,21.8)],t=new THREE.LatheGeometry(e),n=new THREE.MeshStandardMaterial({side:THREE.DoubleSide,flatShading:!0}),o=new THREE.Matrix4,a=new THREE.InstancedMesh(t,n,15);for(let e=0;e<15;e++){randomizeMatrix_bo(o,e),a.setMatrixAt(e,o);const t=(new THREE.Color).setHSL(Math.random(),1,.6);a.setColorAt(e,t)}scene.add(a),theOthers.push(a);var r=a.clone();r.scale.set(-1,1,1),r.rotation.set(0,1.57,0),a.position.set(0,10,0),scene.add(r),theOthers.push(r)}const position=new THREE.Vector3,quaternion=new THREE.Quaternion,scale=new THREE.Vector3;let scaleFactor=10*(Math.random()+.1);const randomizeMatrix_bo=function(e,t){position.x=t%2==0?80*Math.random()-40+45:-1*(80*Math.random()-40)-45,position.y=20*Math.random()+15,position.z=80*Math.random()-40,t=remap(scaleFactor=10*(Math.random()+.1),1,10,3,5)/20,scale.x=scale.y=scale.z=t,e.compose(position,quaternion,scale)};function sleep(t){return new Promise(e=>setTimeout(e,t))}function createText(e,t,n,o=!1){var a=document.createElement("canvas"),r=((i=a.getContext("2d",{})).font="normal 100px "+n,i.measureText(e).width),i=(a.width=r,a.height=100,a.border="10px solid blue",i.font=0==o?"normal 100px "+n:"normal 75px "+n,i.textAlign="center",i.textBaseline="middle",i.fillText(e,r/2,50),(o=new THREE.Texture(a)).needsUpdate=!0,n=new THREE.MeshStandardMaterial({side:THREE.DoubleSide,map:o,transparent:!0}),new THREE.PlaneGeometry(t*r/100,t));return new THREE.Mesh(i,n)}function removeOb(e,t){e=sgobn(e),t.remove(e,!0)}function sgobn(e){return scene.getObjectByName(e)}function gradientMateriail(e,t){return new THREE.ShaderMaterial({side:THREE.DoubleSide,uniforms:{color1:{value:new THREE.Color(e)},color2:{value:new THREE.Color(t)}},vertexShader:"\nvarying vec2 vUv;\n\nvoid main() {\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);\n}\n",fragmentShader:"\nuniform vec3 color1;\nuniform vec3 color2;\n\nvarying vec2 vUv;\n\nvoid main() {\n  \n  gl_FragColor = vec4(mix(color1, color2, vUv.y), 1.0);\n}\n"})}function addSkySphere(){var e=new THREE.SphereGeometry(80,32,16,0,2*Math.PI,0,.5*Math.PI),t=gradientMateriail("peachpuff","blue");(e=new THREE.Mesh(e,t)).position.set(0,-4,0),e.name="Sky",scene.add(e)}const extrudeSettings={steps:4,depth:.1,bevelEnabled:!0,bevelThickness:.05,bevelSize:.02,bevelOffset:0,bevelSegments:4};function addArrow(){var e=(new THREE.Shape).moveTo(-2,16).lineTo(-8,14).lineTo(0,26).lineTo(8,14).lineTo(2,16).lineTo(2,0).lineTo(-2,0).lineTo(-2,16);return(e=new THREE.ExtrudeGeometry(e,extrudeSettings)).center(),e}function addCross(){var e=(new THREE.Shape).moveTo(0,.2).lineTo(.2,.2).lineTo(.2,0).lineTo(.2+.1,0).lineTo(.2+.1,.2).lineTo(.5,.2).lineTo(.5,.2+.1).lineTo(.2+.1,.2+.1).lineTo(.2+.1,.5).lineTo(.2,.5).lineTo(.2,.2+.1).lineTo(0,.2+.1);return(e=new THREE.ExtrudeGeometry(e,extrudeSettings)).center(),e.rotateZ(Math.PI/4),e}function addCactus(){var e=(new THREE.Shape).moveTo(.18,.76).lineTo(.16,.72).lineTo(.09,.67).lineTo(.12,1.2).lineTo(.13,1.2).lineTo(.09,1.29).lineTo(0,1.33).lineTo(-.09,1.29).lineTo(-.13,1.2).lineTo(-.12,1.2).lineTo(-.1,.77).lineTo(-.16,.82).lineTo(-.18,.86).lineTo(-.17,1.1).lineTo(-.2,1.17).lineTo(-.27,1.2).lineTo(-.34,1.17).lineTo(-.37,1.1).lineTo(-.34,.83).lineTo(-.28,.74).lineTo(-.09,.62).lineTo(-.06,0).lineTo(.06,0).lineTo(.08,.53).lineTo(.29,.65).lineTo(.34,.73).lineTo(.35,.98).lineTo(.33,1.04).lineTo(.26,1.07).lineTo(.19,1.04).lineTo(.17,.98);return(e=new THREE.ExtrudeGeometry(e,extrudeSettings)).center(),e.scale(4,4,4),e}function addCheck(){var e=(new THREE.Shape).moveTo(30,40).lineTo(0,0).lineTo(-15,15).lineTo(-10,20).lineTo(0,10).lineTo(25,45);return(e=new THREE.ExtrudeGeometry(e,extrudeSettings)).center(),e}function addCloud(){var e=(new THREE.Shape).moveTo(.88,-.15).lineTo(.99,-.07).lineTo(1.01,.03).lineTo(.97,.14).lineTo(.86,.21).lineTo(.75,.19).lineTo(.68,.3).lineTo(.56,.37).lineTo(.35,.37).lineTo(.28,.29).lineTo(.23,.23).lineTo(.12,.27).lineTo(.03,.2).lineTo(-.05,.1).lineTo(-.05,-.02).lineTo(0,-.09).lineTo(.12,-.2).lineTo(.25,-.17).lineTo(.28,-.24).lineTo(.37,-.28).lineTo(.44,-.27).lineTo(.49,-.24).lineTo(.58,-.3).lineTo(.7,-.28).lineTo(.81,-.27);return(e=new THREE.ExtrudeGeometry(e,extrudeSettings)).center(),e}function addJason(){var e=(new THREE.Shape).moveTo(16.16,60.89).lineTo(9.48,64.64).lineTo(4.92,65.49).lineTo(3.93,61).lineTo(0,60.78).lineTo(0,41.02).lineTo(9.34,43.3).lineTo(-.03,37.19).lineTo(4.99,35.7).lineTo(5.59,37.4).lineTo(8.49,39.02).lineTo(10.65,38.92).lineTo(12.66,38.6).lineTo(13.72,36.94).lineTo(13.44,34.93).lineTo(11.71,32.42).lineTo(9.94,31.29).lineTo(8.49,31.32).lineTo(7.08,31.71).lineTo(5.84,33.41).lineTo(5.06,35.21).lineTo(0,36.96).lineTo(0,21.78).lineTo(1.48,21.85).lineTo(2.16,21.69).lineTo(2.33,20.93).lineTo(1.63,20.2).lineTo(0,19.72).lineTo(0,0).lineTo(3.81,.54).lineTo(10.53,3.88).lineTo(15.89,9.5).lineTo(21.22,18.48).lineTo(23.98,28.1).lineTo(25.45,35.74).lineTo(25.54,37.58).lineTo(23.21,37.03).lineTo(23.21,43.85).lineTo(25.35,44.39).lineTo(23.12,50.75).lineTo(19.94,57.18);return(e=new THREE.ExtrudeGeometry(e,extrudeSettings)).scale(.008,.008,.008),e}function remap(e,t,n,o,a){return(e-t)/(n-t)*(a-o)+o}function clamp(e,t,n){return Math.max(t,Math.min(n,e))}const randomizeMatrix_OG=function(){const t=new THREE.Vector3,n=new THREE.Quaternion,o=new THREE.Vector3;return function(e){t.x=40*Math.random()-20,t.y=40*Math.random()-20,t.z=40*Math.random()-20,n.random(),o.x=o.y=o.z=+Math.random(),e.compose(t,n,o)}}();function addLicense(){var e=new THREE.Group,t=new THREE.PlaneGeometry(1.7,1),n=new THREE.MeshBasicMaterial({color:14596231,side:THREE.DoubleSide}),t=new THREE.Mesh(t,n);e.add(t),n=addJason(),t=new THREE.MeshStandardMaterial({color:new THREE.Color(13421747),flatShading:!0}),(t=(n=new THREE.Mesh(n,t)).clone()).scale.set(-1,1,1),n.add(t),n.position.set(-.5,-.4,0),e.add(n),(t=createText("Triskatopia",.1,"Courier New",!1)).position.set(0,.4,.01),e.add(t),(n=createText("Balloon Driver License",.1,"Courier New",!1)).position.set(0,.26,.01),e.add(n),(t=createText("Number: 123456",.1,"Courier New",!1)).position.set(.22,0,.01),e.add(t),(n=createText("Date: Friday",.1,"Courier New",!1)).position.set(.22,-.2,.01),e.add(n),(t=createText("XXth 2024",.1,"Courier New",!1)).position.set(.22,-.32,.01),e.add(t),e.position.set(-.25,0,0),e.visible=!1,e.name="license",sgobn("UI_UIplane").add(e)}function addParticles(){var t=new Float32Array(900),n=new Float32Array(900),e=new THREE.BufferGeometry;for(let e=0;e<900;e++)t[e]=100*(Math.random()-.5),n[e]=Math.random();e.setAttribute("position",new THREE.BufferAttribute(t,3)),e.setAttribute("color",new THREE.BufferAttribute(n,3));var o=new THREE.PointsMaterial;o.size=1,o.sizeAttenuation=!0,o.color=new THREE.Color("#ff88cc"),o.transparent=!0,o.alphaMap=particleTexture,o.blending=THREE.AdditiveBlending,o.vertexColors=!0,(e=new THREE.Points(e,o)).position.set(0,50,0),e.name="star",scene.add(e)}let t,n,q;const A=new AudioContext,gainNode=A.createGain(),sound=(gainNode.gain.value=.2,(e,n=96e3,o,a,r,i)=>{for(t=(e,t)=>(t-e)/t,r=(a=A.createBuffer(1,n,48e3)).getChannelData(0),o=n;o--;)r[o]=e(o);(i=A.createBufferSource()).buffer=a,i.connect(gainNode),gainNode.connect(A.destination),i.start()}),soundEnterVR=e=>{var n;return 16e3<e?null:(n=Math.pow(t(e,16e3),2.1),(e<2285.714285714286?e+10*Math.sin(-e/900)&16:13&e)?n:-n)},soundAltUp=e=>{var n;return 5e4<e?null:(n=t(e,5e4),Math.sin(.03*-e*Math.sin(.09*e+Math.sin(e/200))+Math.sin(e/100))/n/(5e4<e?e/8e3:5))},soundAltDown=e=>{var n;return 3e4<e?null:(n=t(e,3e4),Math.sin(.001*e*Math.sin(.009*e+Math.sin(e/200))+Math.sin(e/100))*n*n)},soundTilt=e=>{var n;return 2e4<e?null:(n=t(e,2e4),e*=.04,Math.sin(.03*-e*Math.sin(.09*e+Math.sin(e/200))+Math.sin(e/100))*n)},soundHome=e=>{if(5e4<e)return null;e=6*Math.pow(e,1.2-Math.sin(2*e/1e5));var n=Math.sin(e/30+Math.sin(e/1500));return Math.pow(n,9)*t(e,5e4)},soundNextLevel=e=>{var n;return 11e4<e?null:(n=t(e,11e4),Math.sin(.001*e*Math.sin(.009*e+Math.sin(e/200))+Math.sin(e/100))*n*n)},soundError=e=>5e4<e?null:(200&Math.pow(e,.9)?1:-1)*Math.pow(t(e,5e4),3),soundLaunch=e=>{var n;return 2e4<e?null:(n=t(e,2e4),33&Math.pow(5e5*e,.3)?n:-n)},soundWin=e=>{var n,o=[0,4,7,12,void 0,7,12];return 35e3<e?null:void 0===(n=o[o.length*e/35e3|0])?0:(n=.8*Math.pow(2,n/12),o=t(e*o.length%35e3,35e3),e*n&64?o:-o)},soundLoose=e=>{if(6e4<e)return null;e=7*Math.pow(e,1.2-Math.sin(e/1e5));var n=Math.sin(e/30+Math.sin(e/1500));return Math.pow(n,9)*t(e,6e4)};function addTarget(){var e=new THREE.Group,t=new THREE.RingGeometry(1.8,2.2,32),n=new THREE.MeshBasicMaterial({color:new THREE.Color(6697728),side:THREE.DoubleSide});(t=new THREE.Mesh(t,n)).rotation.set(Math.PI/180*90,0,0),e.add(t),t=addCross(),(t=new THREE.Mesh(t,n)).scale.set(5,5,.01),t.rotateX(Math.PI/2),e.add(t),n=addArrow(),t=new THREE.MeshStandardMaterial({color:"orange"}),(n=new THREE.Mesh(n,t)).scale.set(.1,.1,1),n.rotateZ(Math.PI),n.position.set(0,3,0),arrowArr.push(n),e.add(n),e.name="Target",e.position.set(targetOb.position.x,targetOb.position.y,targetOb.position.z),e.scale.set(1.5,1.5,1.5),worldGroup.add(e),targetOb.box.setFromObject(e),targetOb.box.translate(new THREE.Vector3(0,-5,0)),new THREE.Box3Helper(targetOb.box,"green")}const count=500;function addFireworks(){const e=new THREE.BoxGeometry(.5,.5,.5),t=(blurTexture.minFilter=THREE.NearestFilter,blurTexture.magFilter=THREE.LinearFilter,new THREE.MeshStandardMaterial({side:THREE.DoubleSide,map:blurTexture})),n=new THREE.Matrix4,o=new THREE.InstancedMesh(e,t,500);for(let e=0;e<500;e++)randomizeMatrix_OG(n),o.setMatrixAt(e,n);o.position.copy(targetOb.position),o.name="Fireworks",scene.add(o);var a=new THREE.AnimationMixer(o),r=(mixerArr.push(a),new THREE.VectorKeyframeTrack(".scale",[0,1,2,3,4,5,6],[.2,.2,.2,1,1,1,.1,.1,.1,5,5,5,.2,.2,.2,8,8,8,.2,.2,.2])),r=new THREE.AnimationClip("Action",2,[r]);(a=a.clipAction(r)).setLoop(0,2),a.play(),sleep(5e3).then(()=>{targetOb.winTime=!0,sound(soundWin)}),sleep(15e3).then(()=>{targetOb.winTime=!1,scene.remove(o),o.dispose(),e.dispose(),t.dispose()})}function addClouds(){var t,n=new THREE.Group,o=addCloud(),a=(o.rotateY(Math.PI/2),new THREE.MeshStandardMaterial({color:"lavender",flatShading:!0,transparent:!0,opacity:.35,roughness:.5,metalness:.4}));for(let e=0;e<12;e++)(t=new THREE.Mesh(o,a)).rotation.set(0,.5*e,0),t.translateX(50),t.translateY(Math.max(12,60*Math.random())),t.scale.set(5,5,Math.max(6,15*Math.random())),n.add(t);worldGroup.add(n)}function addMountain(){var e=new THREE.IcosahedronGeometry(6,0),t=new THREE.MeshPhysicalMaterial({roughness:0,transmission:.7,thickness:.5}),n=new THREE.MeshStandardMaterial({vertexColors:!0,flatShading:!0,transparent:!0,opacity:.1,alphaTest:!1});(t=new THREE.Mesh(e,t)).receiveShadow=!0,t.position.set(0,0,-15),t.rotateX(-Math.PI/2),(e=new THREE.Mesh(e,n)).castShadow=!0,t.add(e),t.name="Rock",(n=t.clone()).translateX(-6),n.translateZ(-2),n.rotateY(Math.PI/2),n.name="Rock2",(e=t.clone()).translateX(8),e.translateZ(-1.5),e.rotateY(-Math.PI/2),e.name="Rock3",worldGroup.add(t,n,e),clashBoxMountain.setFromObject(t),clashBoxMountain.expandByScalar(-1.2),clashBoxMountain.translate(new THREE.Vector3(0,1,0)),new THREE.Box3Helper(clashBoxMountain,"red")}function addBuildings(){var e=new THREE.CylinderGeometry(5,5,20,5),t=new THREE.MeshStandardMaterial({color:"indigo",flatShading:!0,transparent:!0,opacity:.5,alphaTest:!1});(e=new THREE.Mesh(e,t)).receiveShadow=!0,e.position.set(0,0,-15),e.name="Building",worldGroup.add(e),clashBoxMountain.setFromObject(e)}function addCactusMountain(){var e=addCactus(),t=new THREE.MeshStandardMaterial({color:"lightgreen",flatShading:!0,transparent:!0,opacity:.5,alphaTest:!1});(e=new THREE.Mesh(e,t)).receiveShadow=!0,e.position.set(0,5,-15),e.scale.set(3,3,3),e.name="Cactus",worldGroup.add(e),clashBoxMountain.setFromObject(e)}function addTerrain(e){let t,n;"One"==e?(t=new THREE.Color(52326),n=new THREE.Color(1769394)):"Two"==e?(t=new THREE.Color(2097152),n=new THREE.Color(3145728)):"Three"==e&&(t=new THREE.Color(13808780),n=new THREE.Color(16768685));const o=new THREE.PlaneGeometry(world.width,world.width,15,15);o.rotateX(-Math.PI/2);var a=o.attributes.position.array,r=new Float32Array(a.length),i=new THREE.Vector3,s=new THREE.Color;for(let e=0;e<a.length;e+=3){i.fromArray(a,e),i.x+=10*Math.random()-5,i.z+=10*Math.random()-5;const o=i.distanceTo(worldGroup.position)/5-world.flatZone;i.y=Math.random()*Math.max(0,.75*o),i.toArray(a,e),s.fromArray(r,e),1.5<i.y?(s.r=t.r,s.g=t.g,s.b=t.b):(s.r=n.r,s.g=n.g,s.b=n.b),s.toArray(r,e)}o.setAttribute("color",new THREE.BufferAttribute(r,3)),o.computeVertexNormals(),e=new THREE.MeshStandardMaterial({vertexColors:!0,flatShading:!0}),(e=new THREE.Mesh(o,e)).name="Ground",e.position.set(0,world.moveDown,0),e.receiveShadow=!0,worldGroup.add(e)}function addTrees(t){let e,n,o;"One"==t&&(e=new THREE.ConeGeometry(.5,2,8),n=new THREE.MeshStandardMaterial({color:"seagreen",flatShading:!0}),o=2e3),"Two"==t&&(e=new THREE.CylinderGeometry(2.5,2.5,10,5),n=new THREE.MeshStandardMaterial({color:"indigo",flatShading:!0}),o=700),"Three"==t&&(e=addCactus(),n=new THREE.MeshStandardMaterial({color:"seagreen",flatShading:!0}),o=100);var a=new THREE.Mesh(e,n),r=new THREE.Matrix4,i=new THREE.InstancedMesh(a.geometry,a.material,o);i.castShadow=!0;for(let e=0;e<o;e++)randomizeMatrix(r),i.setMatrixAt(e,r),"Three"==t&&i.rotateY(Math.random()*THREE.MathUtils.degToRad(10*e));i.name="Trees",worldGroup.add(i)}const randomizeMatrix=function(){const t=new THREE.Vector3,n=new THREE.Quaternion,o=new THREE.Vector3;return function(e){t.x=Math.sin(360*Math.random())*world.width/2,t.y=4*Math.random()-2+1,t.z=Math.cos(360*Math.random())*world.width/2,Math.sqrt(Math.abs(t.x*t.x+Math.abs(t.z*t.z)))<5*world.flatZone&&(t.x=10*t.x+3,t.z=10*t.z+3),n.y=Math.random(),o.x=o.y=o.z=Math.random(),e.compose(t,n,o)}}(),increment=2,tiltIncrDeg=2,tiltIncr=THREE.MathUtils.degToRad(2);function clickedOn(e){if(0!=e.length&&1!=balloonStats.isMoving&&1!=balloonStats.isLaunched)switch(e[0].object.name){case"enterVR":startSession("immersive-vr"),removeOb("enterVR",scene),sleep(5).then(()=>{sound(soundEnterVR)});break;case"exitVR":shutdownXR(renderer.xr.getSession());break;case"home":1==renderer.xr.isPresenting&&(sound(soundHome),balloonStats.startingSpot.y=balloonStats.Altitude,balloonStats.Altitude=0,balloonStats.Tilt=0,balloonStats.isMoving=!0,balloonStats.isMmovingInY=!0,balloonStats.isMmovingRot=!0,balloonStats.isGoingHome=!0,balloonStats.timeRequired=3,updateCarrotSpace(),clock.start());break;case"altUp":1==renderer.xr.isPresenting&&(dummyOb.position.y>world.height-2?sound(soundError):(sound(soundAltUp),balloonStats.startingSpot.y=balloonStats.Altitude,balloonStats.Altitude+=2,balloonStats.isMoving=!0,balloonStats.isMmovingInY=!0,balloonStats.timeRequired=1.5,updateCarrotSpace(),clock.start()));break;case"altDown":1==renderer.xr.isPresenting&&(dummyOb.position.y<.9?sound(soundError):(sound(soundAltDown),balloonStats.startingSpot.y=balloonStats.Altitude,balloonStats.Altitude-=2,balloonStats.isMoving=!0,balloonStats.isMmovingInY=!0,balloonStats.timeRequired=1.5,updateCarrotSpace(),clock.start()));break;case"tiltUp":1==renderer.xr.isPresenting&&(dummyOb.position.y<2.9?sound(soundError):(sound(soundTilt),balloonStats.startingTilt.x=balloonStats.Tilt,balloonStats.Tilt+=tiltIncr,balloonStats.isMoving=!0,balloonStats.isMmovingRot=!0,balloonStats.timeRequired=3,updateCarrotSpace(),clock.start()));break;case"tiltDown":1==renderer.xr.isPresenting&&(dummyOb.position.y<2.9?sound(soundError):(sound(soundTilt),balloonStats.startingTilt.x=balloonStats.Tilt,balloonStats.Tilt-=tiltIncr,balloonStats.isMoving=!0,balloonStats.isMmovingRot=!0,balloonStats.timeRequired=3,updateCarrotSpace(),clock.start()));break;case"Launch":1==renderer.xr.isPresenting&&(sound(soundLaunch),balloonStats.isMoving=!0,balloonStats.timeRequired=5,balloonStats.isLaunched=!0)}}async function shutdownXR(e){e&&await e.end()}function updateCarrotSpace(){carrot.rotation.set(balloonStats.Tilt,0,0),carrot.position.set(0,balloonStats.Altitude,0),carrotBox.setFromObject(carrot),carrotBox.expandByVector(new THREE.Vector3(5,.05,5)),new THREE.Box3Helper(carrotBox,16776960)}function winnerTime(){sound(soundWin),targetOb.winTime=!0,balloonStats.isMoving=!1,balloonStats.isLaunched=!1,sgobn("Target").visible=!1,addFireworks(),targetOb.winTime=!0,sleep(7500).then(()=>{removeOb("Fireworks",scene)}),sleep(8e3).then(()=>{1==balloonStats.Level?(l1tol2(),targetOb.winTime=!1,reset()):2==balloonStats.Level?(l2tol3(),targetOb.winTime=!1,reset()):3==balloonStats.Level&&(sgobn("license").visible=!0)})}function looserTime(){sound(soundLoose),balloonStats.isMoving=!1,balloonStats.isLaunched=!1;var e=addCross(),t=new THREE.MeshStandardMaterial({color:"red",flatShading:!0});(e=new THREE.Mesh(e,t)).scale.set(2.5,2.5,.01),e.position.set(0,0,-2),e.name="Crosx",camera.add(e),sleep(3e3).then(()=>{removeOb("Crosx",camera),reset()})}function reset(){dummyOb.rotation.set(0,0,0),dummyOb.position.set(0,0,0),moveIt({x:0,y:0,z:0,w:1},new THREE.Quaternion),balloonStats.startingSpot=new THREE.Vector3(0,0,0),balloonStats.startingTilt=new THREE.Euler(0,0,0,"XYZ"),balloonStats.Altitude=0,balloonStats.Tilt=0,upDateHuds(),sgobn("Target").visible=!0}function l1tol2(){sound(soundNextLevel);var e=sgobn("Sky"),t=gradientMateriail("lightslategrey","black");e.material=t,world.flatZone=10,removeOb("Ground",worldGroup),addTerrain("Two"),removeOb("Trees",worldGroup),addTrees("Two"),removeOb("Rock",worldGroup),removeOb("Rock2",worldGroup),removeOb("Rock3",worldGroup),addBuildings(),addParticles(),sgobn("Light").intensity=.25,balloonStats.Level=2,upDateHuds()}function l2tol3(){sound(soundNextLevel);var e=sgobn("Sky"),t=gradientMateriail("lightcyan","lightskyblue");e.material=t,world.flatZone=5,removeOb("Ground",worldGroup),addTerrain("Three"),removeOb("Trees",worldGroup),addTrees("Three"),removeOb("Building",worldGroup),addCactusMountain(),removeOb("star",scene),balloonStats.Level=3,upDateHuds()}function XRSuppQry(){navigator.xr&&navigator.xr.isSessionSupported("immersive-vr").then(e=>{e&&addVROKButton(),e||addNoVRButton()})}async function startSession(e){try{onSessionStarted(await navigator.xr.requestSession(e,{}))}catch(e){alert("Failed to start Web XR session.",e)}}async function onSessionStarted(e){renderer.xr.setReferenceSpaceType("local"),await renderer.xr.setSession(e)}function addVROKButton(){var e=createText("Enter VR",3,"Courier New",!1);e.position.set(targetOb.position.x,targetOb.position.y+10,targetOb.position.z),e.name="enterVR",scene.add(e),clickable_2D.push(e)}function addNoVRButton(){var e=createText("VR Not Found :(",2.5,"Courier New",!1);e.position.set(targetOb.position.x,targetOb.position.y+11,targetOb.position.z),scene.add(e)}function introClicked(){document.getElementById("introID").style.visibility="visible"}function aboutClicked(){document.getElementById("aboutID").style.visibility="visible"}function closeClicked(){document.getElementById("introID").style.visibility="hidden",document.getElementById("aboutID").style.visibility="hidden"}function removeElemFn(){document.getElementById("title").remove(),document.getElementById("start").remove(),document.getElementById("introButton").remove(),document.getElementById("aboutButton").remove(),document.getElementById("introID").remove(),document.getElementById("aboutID").remove(),camera.position.set(-7,4,10),camera.lookAt(new THREE.Vector3(-2,3,-5))}document.getElementById("start").addEventListener("click",removeElemFn),document.getElementById("introButton").addEventListener("click",introClicked),document.getElementById("aboutButton").addEventListener("click",aboutClicked),document.getElementById("close1").addEventListener("click",closeClicked),document.getElementById("close2").addEventListener("click",closeClicked);const testArr=[],clickable_2D=[],clickable_3D=[],vehicle=new THREE.Group,clock=new THREE.Clock,textureLoader=new THREE.TextureLoader,particleTexture=textureLoader.load("1.png",function(e){},void 0,function(e){}),blurTexture=textureLoader.load("blurPic.png",function(e){},void 0,function(e){});let baseReferenceSpace;const balloonStats={Altitude:0,Tilt:0,Level:1,isMoving:!1,isMmovingInY:!1,isMmovingRot:!1,isGoingHome:!1,isLaunched:!1,timeRequired:null,startingSpot:new THREE.Vector3(0,0,0),startingTilt:new THREE.Euler(0,0,0,"XYZ")},world={width:150,height:75,flatZone:5,moveDown:-1.5},worldGroup=new THREE.Group,targetOb={position:new THREE.Vector3(0,.5,-40),winTime:!1,box:new THREE.Box3},arrowArr=[],clashBoxMountain=new THREE.Box3,mixerArr=[],theOthers=[],sizes={width:window.innerWidth,height:window.innerHeight,pixelRatio:Math.min(window.devicePixelRatio,2)},scene=new THREE.Scene,camera=(scene.background=new THREE.Color(3342387),new THREE.PerspectiveCamera(50,sizes.width/sizes.height,.1,1e3)),light=(camera.position.set(0,0,10),camera.lookAt(new THREE.Vector3(20,4,0)),scene.add(camera),new THREE.HemisphereLight(16773360,394758,2)),dirLight=(light.position.set(1,1,1),scene.add(light),new THREE.DirectionalLight(16777215,1)),renderer=(dirLight.position.set(15,25,15),dirLight.castShadow=!0,dirLight.shadow.mapSize.width=1024,dirLight.shadow.mapSize.height=1024,dirLight.shadow.camera.near=.5,dirLight.shadow.camera.far=1e3,dirLight.shadow.camera.left=-250,dirLight.shadow.camera.right=250,dirLight.shadow.camera.top=250,dirLight.shadow.camera.bottom=-250,dirLight.name="Light",scene.add(dirLight),new THREE.WebGLRenderer({antialias:!0})),ctr1=(renderer.setSize(sizes.width,sizes.height),renderer.setPixelRatio(sizes.pixelRatio),renderer.xr.enabled=!0,renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap,document.body.appendChild(renderer.domElement),renderer.xr.getController(0)),ctr2=renderer.xr.getController(1),carrotGeo=(XRSuppQry(),new THREE.ConeGeometry(.005,.025,8)),carrotMatl=new THREE.MeshStandardMaterial({color:"orange"}),carrot=new THREE.Mesh(carrotGeo,carrotMatl),carrotBox=(carrot.rotation.set(0,0,0),carrot.visible=!1,carrot.name="Carrot",scene.add(carrot),new THREE.Box3),dummyOb=new THREE.Object3D;scene.add(dummyOb),addSkySphere(),addTerrain("One"),addTrees("One"),addClouds(),addMountain(),scene.add(worldGroup),addBalloon(),addBalloonOther(),addTarget();let line2,curve2,INTERSECTED,intersects,alpha=0,destinationSpot=new THREE.Vector3,lerper=new THREE.Object3D,ogQuat=new THREE.Quaternion,destinationQuat=new THREE.Quaternion,slerper=new THREE.Object3D,offsetPosition=new THREE.Vector3,offsetRotation=new THREE.Quaternion,blnFrq=.005,blnHt=2e-4,p=new THREE.Vector3;function moveIt(e,t){e=new XRRigidTransform(e,t),t=baseReferenceSpace.getOffsetReferenceSpace(e),renderer.xr.setReferenceSpace(t)}function addCalcCurve(){line2&&scene.remove(line2);const e=[new THREE.Vector3(0,0,0),new THREE.Vector3(0,-2.66,-13.39),new THREE.Vector3(0,-10.25,-24.75),new THREE.Vector3(0,-21.61,-32.34),new THREE.Vector3(0,-35,-35),new THREE.Vector3(0,-80,-35)],t=[];e.forEach(e=>{e=new THREE.Vector3(e.x,e.y,e.z).applyMatrix4(dummyOb.matrixWorld),t.push(new THREE.Vector3(e.x,e.y,e.z))}),(curve2=new THREE.CatmullRomCurve3(t)).closed=!1;var n=curve2.getPoints(7);(line2=new THREE.Line((new THREE.BufferGeometry).setFromPoints(n),new THREE.LineBasicMaterial({color:16764159}))).name="line",scene.add(line2)}function yhryd(e){balloonStats.timeRequired=null,balloonStats.isMoving=!1,balloonStats.isMmovingInY=!1,balloonStats.isMmovingRot=!1,balloonStats.isGoingHome=!1,alpha=0,upDateHuds(balloonStats),addCalcCurve()}function animate(){renderer.setAnimationLoop(render)}function render(){const t=clock.getElapsedTime();arrowArr[0].rotation.y+=.01,2==theOthers.length&&(theOthers[0].rotation.y+=1e-4,theOthers[0].position.y+=Math.sin(t*blnFrq)*blnHt,theOthers[1].rotation.y-=2e-4,theOthers[1].position.y-=Math.sin(t*blnFrq)*blnHt),1==renderer.xr.isPresenting&&(cleanIntersected(),intersectObjects(ctr1),intersectObjects(ctr2),1==balloonStats.isMoving)&&(alpha+=t/balloonStats.timeRequired*.1,1==balloonStats.isMmovingInY&&(destinationSpot.copy(carrot.position),lerper.position.lerp(destinationSpot,alpha),offsetPosition={x:-lerper.position.x,y:-lerper.position.y,z:-lerper.position.z,w:1},dummyOb.position.set(-offsetPosition.x,-offsetPosition.y,-offsetPosition.z,-offsetPosition.w),1<alpha)&&yhryd("pos"),1==balloonStats.isMmovingRot&&(ogQuat.setFromEuler(balloonStats.startingTilt),destinationQuat.setFromEuler(carrot.rotation),slerper.quaternion.slerpQuaternions(ogQuat,destinationQuat,alpha),dummyOb.quaternion.set(-slerper.quaternion.x,-slerper.quaternion.y,-slerper.quaternion.z,-slerper.quaternion.w),1<alpha)&&yhryd("rot"),1==balloonStats.isLaunched&&1<dummyOb.position.y&&(p=curve2.getPoint(.1*alpha),dummyOb.position.set(p.x,p.y-.1,p.z),offsetPosition={x:-p.x,y:-p.y-.1,z:-p.z,w:1},1==clashBoxMountain.containsPoint(dummyOb.position))&&(balloonStats.isLaunched=!1,looserTime(),alpha=0,scene.remove(line2)),1==balloonStats.isLaunched&&dummyOb.position.y<1&&(balloonStats.isLaunched=!1,(1==targetOb.box.containsPoint(dummyOb.position)?winnerTime:looserTime)(),alpha=0,scene.remove(line2)),moveIt(offsetPosition,offsetRotation)),1==targetOb.winTime&&mixerArr.forEach(e=>e.update(.005*t)),renderer.render(scene,camera)}function resizeMe(){sizes.width=window.innerWidth,sizes.height=window.innerHeight,sizes.pixelRatio=Math.min(window.devicePixelRatio,2),camera.aspect=sizes.width/sizes.height,camera.updateProjectionMatrix(),renderer.setSize(sizes.width,sizes.height),renderer.setPixelRatio(sizes.pixelRatio)}animate(),window.addEventListener("resize",resizeMe),document.addEventListener("pointermove",mouseHover),document.addEventListener("click",mouseDown);const mouse=new THREE.Vector2,raycaster2D=new THREE.Raycaster;function mouseHover(e){0<(intersects=getPointerInts(e)).length?INTERSECTED!=intersects[0].object&&(INTERSECTED&&INTERSECTED.material.emissive.setHex(INTERSECTED.currentHex),(INTERSECTED=intersects[0].object).currentHex=INTERSECTED.material.emissive.getHex(),INTERSECTED.material.emissive.setHex(16711680)):(INTERSECTED&&INTERSECTED.material.emissive.setHex(INTERSECTED.currentHex),INTERSECTED=null)}function mouseDown(e){clickedOn(intersects=getPointerInts(e))}function getPointerInts(e){return mouse.x=e.clientX/sizes.width*2-1,mouse.y=-e.clientY/sizes.height*2+1,raycaster2D.setFromCamera(mouse,camera),raycaster2D.intersectObjects(clickable_2D)}const geometryLine=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,-1)]),line=new THREE.Line(geometryLine),raycasterXR=(line.name="line",line.scale.z=5,renderer.xr.addEventListener("sessionstart",()=>{scene.add(ctr1),scene.add(ctr2),ctr1.add(line.clone()),ctr2.add(line.clone()),addXR_UI(),addLicense(),baseReferenceSpace=renderer.xr.getReferenceSpace(),document.removeEventListener("pointermove",mouseHover),document.removeEventListener("click",mouseDown),window.removeEventListener("resize",resizeMe)}),renderer.xr.addEventListener("sessionend",()=>{document.addEventListener("pointermove",mouseHover),document.addEventListener("click",mouseDown),window.addEventListener("resize",resizeMe)}),new THREE.Raycaster),intersectedXR=[],geometryKnot=new THREE.TorusKnotGeometry(.05,.01,100,16),materialKnot=new THREE.MeshStandardMaterial,torusKnot=new THREE.Mesh(geometryKnot,materialKnot);function onSelectStart(e){var t=e.target,n=getIntersections(t);if(clickedOn(n),0<n.length){const e=n[0].object;e.material.emissive.b=1,t.userData.selected=e}t.userData.targetRayMode=e.data.targetRayMode}function onSelectEnd(e){void 0!==(e=e.target).userData.selected&&(e.userData.selected.material.emissive.b=0,e.userData.selected=void 0)}function getIntersections(e){return e.updateMatrixWorld(),raycasterXR.setFromXRController(e),raycasterXR.intersectObjects(clickable_3D)}function intersectObjects(e){if("screen"!==e.userData.targetRayMode&&void 0===e.userData.selected){var t=getIntersections(e);if(0<t.length){const e=t[0],n=e.object;n.material.emissive.r=1,intersectedXR.push(n),line.scale.z=e.distance}else line.scale.z=5}}function cleanIntersected(){for(;intersectedXR.length;)intersectedXR.pop().material.emissive.r=0}scene.add(torusKnot),ctr1.addEventListener("selectstart",onSelectStart),ctr1.addEventListener("selectend",onSelectEnd),ctr1.addEventListener("connected",e=>{var t=renderer.xr.getControllerGrip(0);t.add(torusKnot),scene.add(t)}),ctr1.addEventListener("disconnected",()=>{}),ctr2&&(ctr2.addEventListener("selectstart",onSelectStart),ctr2.addEventListener("selectend",onSelectEnd),ctr2.addEventListener("connected",()=>{var e=renderer.xr.getControllerGrip(1);e.add(torusKnot),scene.add(e)}),ctr2.addEventListener("disconnected",()=>{}))</script>