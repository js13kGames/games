<!doctype html><title>Taxi Drift - js13kGames 2015</title><meta name=viewport content="width=device-width,maximum-scale=1.01"><style>*{margin:0;padding:0}body,html{height:100%}body{background-color:#000;width:100%}#table{display:table;width:100%;height:100%}#cell{display:table-cell;vertical-align:middle}#canvascontainer{margin:auto;outline:1px solid white}#canvascontainer canvas{width:100%;height:100%;display:block}#ad-container{width:320px;height:50px;position:absolute;bottom:0;left:50%;margin-left:-160px}</style><div id=table><div id=cell><div id=canvascontainer><canvas></canvas></div></div></div><script>var _=window,raf=_.requestAnimationFrame||_.webkitRequestAnimationFrame||_.mozRequestAnimationFrame||function(t){setTimeout(t,1e3/60)},M=Math,abs=M.abs,to=setTimeout;function rd(t,i){return void 0===i&&(i=t,t=0),M.random()*(i-t)+t}function rp(t){return t[~~rd(t.length)]}function normalizeAngle(t){for(;t<-Math.PI;)t+=2*Math.PI;for(;t>Math.PI;)t-=2*Math.PI;return t}function xt(t,i){var s={};for(var e in t)s[e]=t[e];for(var e in i)s[e]=i[e];return s}var p=CanvasRenderingContext2D.prototype;for(var i in p.fr=p.fillRect,p.sv=p.save,p.rs=p.restore,p.tr=p.translate,p.lt=p.lineTo,p.mt=p.moveTo,p.sc=p.scale,p.bp=p.beginPath,p.clg=p.createLinearGradient,p.rt=p.rotate,p.ft=p.fillText,p.$l=function(t){this.globalAlpha=t},p.fs=function(t){this.fillStyle=t},p.di=function(t,i,s){this.drawImage.apply(this,arguments)},p)_[i]=function(t){return function(){c[t].apply(c,arguments)}}(i);function shape(t,i){var s=t[0].x,e=t[0].y;c.sv(),c.tr(s,e),c.fs(i),c.bp(),c.moveTo(0,0);for(var h=1;h<t.length;h++)c.lineTo(t[h].x-s,t[h].y-e);c.closePath(),c.fill(),c.rs()}function $c(t,i,s,e){var h=document.createElement("canvas");h.width=t,h.height=i;var r=h.getContext("2d");if(s(h,r,t,i),"$h"===e){var n=r.createPattern(h,"repeat");return n.width=t,n.height=i,n}return h}function $R(){}function $m(t,i,s){return M.max(i,M.min(s,t))}function $V(t){for(var i,s,e=t.length;e;i=~~(M.random()*e),s=t[--e],t[e]=t[i],t[i]=s);return t}function dist(t,i,s,e){return Math.sqrt((t-s)*(t-s)+(i-e)*(i-e))}function createCycle(t){for(var i,s,e,h,r,n=[],o=0;o<t.length;o++)i=t[o],s=t[(o+1)%t.length],e=t[(o-1+t.length)%t.length],h=Math.atan2(e.y-i.y,e.x-i.x),r=Math.atan2(s.y-i.y,s.x-i.x),n.push({x:i.x+40*Math.cos(h),y:i.y+40*Math.sin(h)}),n.push({x:i.x+40*Math.cos(r),y:i.y+40*Math.sin(r)});for(o=0;o<n.length;o++)n[o].next=n[(o+1)%n.length];return n[0]}function newCar($o,noLights){return $c(52,24,(function(c,r){with(r)fs("rgba(0,0,0,1)"),fr(0,0,c.width,c.height),tr((c.width-50)/2,(c.height-22)/2),fs($o),fr(0,0,50,22),fs("#000"),fr(10,3,5,16),fr(30,3,10,16),fr(15,1,7,1),fr(23,1,7,1),fr(15,20,7,1),fr(23,20,7,1),noLights||(fs("#ff0"),fr(48,0,2,3),fr(48,19,2,3),fs("#f00"),fr(0,0,2,3),fr(0,19,2,3))}))}var P={w:700,h:700,v:130};function $E(){with(window.rotation=!0,this.can=document.querySelector("canvas"),this.can)width=P.w,height=P.h;this.ctx=window.c=this.can.getContext("2d"),this.start(),this.resize(),addEventListener("resize",this.resize,!1),addEventListener("keydown",this.$s.bind(this),!1),addEventListener("keyup",this.$y.bind(this),!1),this.$K=Date.now(),raf((function(){G.$a(),raf(arguments.callee)})),this.elapsedList=[],this.$z=0,this.$S=Date.now()}function $u(){$_=this,this.score=0,this.$aHs=[],this.cars=[],this.buildings=[],this.clients=[],this.clientSpots=[],this.textures=[],this.trails=[],this.down={},this.t=0;for(var t=8e3,i=900,s=50,e=200,h=50,r=function(t,i,s,e,h){},n=function(t,i,s,e,h){var r=new Texture(grass,t,i,s,e);$_.textures.push(r),h.visible=!1,h.collides=!1;for(var n=0;n<10;n++){var o=new Tree(r.x+~~rd(0,r.w),r.y+~~rd(0,r.h));$_.buildings.push(o)}},o=function(t,i,e,h,r){var n=new Texture(parking,t,i,e,h);$_.textures.push(n),r.visible=!1,r.collides=!1,$_.textures.push(new Texture(road,n.x-s,n.y+100,s,100)),$_.textures.push(new Texture(road,n.x+n.w,n.y+100,s,100)),$_.textures.push(new Texture(road,n.x-s,n.y+n.h-200,s,100)),$_.textures.push(new Texture(road,n.x+n.w,n.y+n.h-200,s,100));var o=[];for(t=n.x+25;t<n.x+n.w-25;t+=s)for(i=n.y+s;i<n.y+n.h;i+=parking.height)o.push({x:t,y:i}),o.push({x:t,y:i+200});for(var a=0;a<10;a++){var l=~~rd(o.length),c=o[l];o.splice(l,1),parking.width;var f=new Enemy;f.x=c.x,f.y=c.y,f.rotation=rp([M.PI/2,-M.PI/2]),$_.addCar(f)}},a=function(t,i,e,h){var a=new Texture(sidewalk,t-s,i-s,e+100,h+100);$_.textures.push(a);var l=new Building(t,i,e,h);$_.buildings.push(l),rp([n,n,r,r,r,o])(t,i,e,h,l)},l=0;l<=10;l++)for(var c=0;c<=10;c++)$_.textures.push(new Texture(xwalkv,c*i-100-h,l*i-100,h,e)),$_.textures.push(new Texture(xwalkv,c*i+100,l*i-100,h,e)),$_.textures.push(new Texture(xwalkh,c*i-100,l*i-100-h,e,h)),$_.textures.push(new Texture(xwalkh,c*i-100,l*i+100,e,h)),$_.textures.push(new Texture(hline,c*i+100+h,l*i-hline.height/2,600,hline.height)),$_.textures.push(new Texture(vline,c*i-vline.width/2,l*i+100+h,vline.width,600));var f=!1;for(l=0;l<10;l++)for(c=0;c<10;c++){f=!f&&c<9&&Math.random()<.5;var d=c*i+s+100;t=600,f&&(t=2*t+e+100,c++),a(d,l*i+s+100,t,600)}[[-150,-150,13e3,-2e3],[-150,9150,13e3,2e3],[-150,-2100,-2e3,15e3],[9150,-2100,2e3,15e3]].forEach((function(t){var i=new Building(t[0],t[1],t[2],t[3]);i.visible=!1,$_.buildings.push(i),$_.textures.push(new Texture($N,t[0],t[1],t[2],t[3]))})),this.textures.push(new Texture(sidewalk,-150,-150,9300,s)),this.textures.push(new Texture(sidewalk,-150,9100,9300,s)),this.textures.push(new Texture(sidewalk,-150,-150,s,9300)),this.textures.push(new Texture(sidewalk,9100,-150,s,9300)),this.player=this.addCar(new Player),this.player.x=4500,this.player.y=4500,this.camX=this.player.x-P.w/2,this.$d=this.player.y-P.h/2,this.camRotation=0;for(var $=0;$<this.buildings.length-4;$++){var p=this.buildings[$];if(p.visible&&p.collides||!p.visible&&!p.collides){var u=p.getCycle();if(u){var y=this.addCar(new Enemy);y.x=u.x,y.y=u.y,y.follow(u)}this.clientSpots=this.clientSpots.concat(p.getCorners(25))}}this.nextClientSpawn=0,this.timeleft=180}function $q(){this.$l=0,$e.$f(this,"$l",0,1,.5)}function $O(t){$q.call(this)}function $L(t){$q.call(this)}function Car(){this.l=50,this.w=30,this.x=0,this.y=0,this.rotation=0,this.speed=0,this.rotationSpeed=M.PI,this.rotationDir=0,this.vectors=[],this.accelerates=!1,this.brakes=!1,this.maxSpeed=500,this.drifts=!0,this.t=0,this.maxAcceleration=400,this.maxDeceleration=1e5,this.maxDeceleration=400,this.speedVector={},this.moveAngle=0,this.moveAngleSpeed=1.5*M.PI,this.radius=10,this.carType=rp([car.white,car.blue,car.red,car.green,car.purple,car.gray])}function Player(){Car.call(this),this.carType=car.yellow,this.client=null,this.hud=new HUD,this.lastGoodPosition=null,this.nextGoodPosition=null,this.nextGoodPositionTimer=0,this.cash=0,this.lives=3,this.dropoffs=0}function Enemy(){Car.call(this),this.path=null,this.maxSpeed=100,this.distanceLeft=0,this.drifts=!1}function Client(){this.x=this.y=0,this.done=!1,this.type=rp([clientRed,clientBlue,clientBlack,clientYellow])}function HUD(){this.msgT=0}function Building(t,i,s,e){this.x=t,this.y=i,this.w=s,this.h=e,this.w<0&&(this.x+=this.w,this.w=-this.w),this.h<0&&(this.y+=this.h,this.h=-this.h),this.visible=!0,this.collides=!0}function Texture(t,i,s,e,h){this.t=t,this.x=i,this.y=s,this.w=e,this.h=h,this.w<0&&(this.x+=this.w,this.w=-this.w),this.h<0&&(this.y+=this.h,this.h=-this.h)}$E.prototype={start:function(){this.$t=new $u,this.$p=new $O},restart:function(){this.$t=new $u,this.$p=null},gameOver:function(){this.$p=new $L},$a:function(){sv(),sc(this.$D,this.$D);var t=Date.now(),i=(t-this.$K)/1e3;if(this.$K=t,this.$t.$a(i),this.$p&&this.$p.$a(i),$e.$a(i),this.$z++,200===this.$z){var s=Date.now()-this.$S;this.$z/(s/1e3)<30&&this.$P(.6)}rs()},$U:function(){this.$t=new $u},resize:function(){to((function(){var t,i,s=innerWidth,e=innerHeight,h=s/e,r=P.w/P.h,n=(abs(h-r),document.getElementById("canvascontainer").style);h<=r?i=(t=s)/r:t=(i=e)*r,n.width=t+"px",n.height=i+"px"}),100)},$s:function(t){if(32!=t.keyCode&&40!=t.keyCode&&38!=t.keyCode||t.preventDefault(),82==t.keyCode&&(window.rotation=!window.rotation),this.$p)return this.$p.$s(t.keyCode);this.$t.$s(t.keyCode)},$y:function(t){this.$p||this.$t.$y(t.keyCode)},$P:function(t){this.can.width=P.w*t,this.can.height=P.h*t,this.$D=t}},$u.prototype={$a:function(t){for(var i in this.t+=t,this.nextClientSpawn-=t,this.nextClientSpawn<=0&&(this.re$aAClients(),this.nextClientSpawn=5),fs(road),fr(0,0,P.w,P.h),this.cars)this.cars[i].$a(t);this.player.$i,this.camX=$_.player.x-P.w/2+100*M.cos($_.player.moveAngle),this.$d=$_.player.y-P.h/2+100*M.sin($_.player.moveAngle),this.$QTime>0&&(this.camX+=rd(-10,10),this.$d+=rd(-10,10));var s=-this.player.rotation-M.PI/2-this.camRotation;s=normalizeAngle(s);var e=M.max(abs(s)/M.PI,.01)*M.PI*2;for(var i in s=$m(s,-e*t,e*t),this.camRotation+=s,this.$QTime-=t,sv(),window.rotation&&(tr(P.w/2,P.h/2),rotate(this.camRotation),tr(-P.w/2,-P.h/2)),tr(-~~this.camX,-~~this.$d),fs(road),fr(~~this.camX,~~this.$d,P.w,P.h),this.textures)this.textures[i].$j();for(var i in this.clients)this.clients[i].$a(t);for(i=this.cars.length-1;i>=0;i--)this.cars[i].$j();for(i=this.$aHs.length-1;i>=0;i--)this.$aHs[i].$j();for(var i in this.buildings)this.buildings[i].$j();this.player.$j2(),rs(),G.$p||(this.player.hud.$a(t),this.player.client||(this.timeleft-=t,this.timeleft<=0&&G.gameOver())),this.player.x<-this.roadSize/2&&this.player.explode()},$y:function(t){this.down[t]=0,this.$M()},$s:function(t){this.down[t]=!0,this.$M()},$M:function(){this.player.rotationDir=0,this.player.accelerates=!1,this.player.brakes=!1,this.down[37]&&(this.player.rotationDir=-1),this.down[39]&&(this.player.rotationDir=1),this.down[38]&&(this.player.accelerates=!0),this.down[40]&&(this.player.brakes=!0),this.down[32]&&G.start()},add$w:function(t){this.$aHs.push(t)},$A:function(t){var i=this.$aHs.indexOf(t);i>=0&&this.$aHs.splice(i,1)},addBuilding:function(t){return this.buildings.push(t),t},addCar:function(t){return this.cars.push(t),t},$TCar:function(t){var i=this.cars.indexOf(t);i>=0&&this.cars.splice(i,1)},addClient:function(t){return this.clients.push(t),t},$TClient:function(t){var i=this.clients.indexOf(t);i>=0&&this.clients.splice(i,1)},getRandomDestination:function(){return rp(this.clientSpots)},re$aAClients:function(){for(var t=M.max(P.w,P.h),i=2*M.max(P.w,P.h),s=this.clients.length-1;s>=0;s--)(h=dist((r=this.clients[s]).x,r.y,this.camX+P.w/2,this.$d+P.h/2))>i&&this.clients.splice(s,1);var e=[];for(s=0;s<this.clientSpots.length;s++){var h;(h=dist((o=this.clientSpots[s]).x,o.y,this.camX+P.w/2,this.$d+P.h/2))<i&&h>t&&e.push(o)}for(;e.length>0&&this.clients.length<10;){var r,n=~~rd(e.length),o=e[n];e.splice(n,1),(r=this.addClient(new Client)).x=o.x,r.y=o.y}},findClosestClientSpot:function(t,i){for(var s,e,h,r,n=0;n<this.clientSpots.length;n++)h=dist((s=this.clientSpots[n]).x,s.y,t,i),(!r||h<e)&&(r=s,e=h);return r},$Q:function(){this.$QTime=.5}},$q.prototype={$a:function(t){$l(this.$l),fs("rgba(0,0,0,.7)"),fr(0,0,P.w,P.h)}},$O.prototype=xt($q.prototype,{$a:function(t){$q.prototype.$a.call(this,t);var i="taxi drift",s=$k(i);$g(c,i,"white",(P.w-s)/2,150,1,1),s=$k(i="find customers and drive them to their destination",.25),$g(c,i,"white",(P.w-s)/2,230,.25,1),s=$k(i="press enter to start",.5),$g(c,i,"white",(P.w-s)/2,400,.5,1),s=$k(i="press r to toggle rotation",.5),$g(c,i,"white",(P.w-s)/2,450,.5,1),$l(1)},$s:function(t){13===t&&(G.$p=null)}}),$L.prototype=xt($q.prototype,{$a:function(t){$q.prototype.$a.call(this,t);var i=$k(s="game over");$g(c,s,"white",(P.w-i)/2,200,1,1);var s="you served "+$_.player.dropoffs+" customers";i=$k(s,.5),$g(c,s,"white",(P.w-i)/2,350,.5,1),s="and collected $"+$_.player.cash,i=$k(s,.5),$g(c,s,"white",(P.w-i)/2,400,.5,1),i=$k(s="press enter to try again",.5),$g(c,s,"white",(P.w-i)/2,540,.5,1),$l(1)},$s:function(t){13===t&&G.restart()}}),Car.prototype={$a:function(t){if(this.t+=t,!this.$i){this.rotation,Math.PI;var i=$m(1-this.speed/this.maxSpeed,.5,1),s=normalizeAngle(this.rotation-this.moveAngle),e=$m(s,-this.moveAngleSpeed*i*t,this.moveAngleSpeed*i*t);this.moveAngle+=this.drifts?e:s;var h=$m(3*this.speed/this.maxSpeed,-1,1);this.rotation+=this.rotationSpeed*t*this.rotationDir*h,this.x+=this.speed*M.cos(this.moveAngle)*t,this.y+=this.speed*M.sin(this.moveAngle)*t;var r=0,n=!1;this.accelerates?(r=this.maxSpeed,this.speed<0&&(n=!0)):this.brakes&&(r=-this.maxSpeed/2,this.speed>0&&(n=!0));var o=r-this.speed,a=n?2*this.maxAcceleration:this.maxAcceleration;o=$m(o,-t*a,t*a),this.speed+=o;var l=abs(normalizeAngle(this.rotation-this.moveAngle))/M.PI;this.speed=$m(this.speed-l*t*this.maxDeceleration*2,-this.maxSpeed,this.maxSpeed)}},$j:function(){sv(),tr(this.x,this.y),rt(this.rotation);var t=this.$i?brokenCar:this.carType;di(t,-t.width/2,-t.height/2),rs()},explode:function(){this.$i=!0;for(var t=0;t<40;t++){var i=new $w(5,rp(["#ff0","#f00","#ff8400","#000"]));i.x=this.x+rd(-5,5),i.y=this.y+rd(-5,5),$_.add$w(i);var s=rd(2*M.PI),e=rd(20,100),h=rd(.5,1);$e.$f(i,"x",i.x,i.x+M.cos(s)*e,h),$e.$f(i,"y",i.y,i.y+M.sin(s)*e,h),$e.$f(i,"a",1,0,h),$e.$f(i,"s",i.s,i.s*rd(5,10),h,0,$r,(function(){$_.$A(i)}))}},collidesWith:function(t){return dist(t.x,t.y,this.x,this.y)<this.radius+t.radius}},Player.prototype=xt(Car.prototype,{$a:function(t){if(this.x,this.y,this.rotation,this.noControlTimer-=t,this.noControlTimer>=0&&(this.accelerates=!1,this.rotationDir=0),Car.prototype.$a.call(this,t),!this.$i){if(this.nextGoodPositionTimer-=t,this.nextGoodPositionTimer<=0&&(this.lastGoodPosition=this.nextGoodPosition,this.nextGoodPosition={x:this.x,y:this.y},this.nextGoodPositionTimer=.1),this.accelerates&&this.speed<400||this.brakes&&this.speed>-200||abs(this.speed)>20&&abs(normalizeAngle(this.rotation-this.moveAngle))>Math.PI/8){var i=-this.l/2,s=new $w(5,"#fff");s.x=this.x+M.cos(this.rotation)*i+rd(-5,5),s.y=this.y+M.sin(this.rotation)*i+rd(-5,5),$_.add$w(s);var e=rd(.3,.6);this.rotation,M.PI,rd(-M.PI/32,M.PI/32),$e.$f(s,"a",1,0,e),$e.$f(s,"s",s.s,s.s*rd(5,10),e,0,$r,(function(){$_.$A(this)}))}var h=this;$_.buildings.forEach((function(t){!h.$i&&t.collides&&t.$F(h.x,h.y)&&h.explode()})),$_.cars.forEach((function(t){h.$i||t===h||t.$i||!t.collidesWith(h)||h.collided(t)})),this.client&&(this.clientTimeLeft=M.max(0,this.clientTimeLeft-t),dist(this.x,this.y,this.clientSettings.destination.x,this.clientSettings.destination.y)<this.clientSettings.radius?0===this.speed&&this.drop():0==this.clientTimeLeft&&this.speed<100&&this.drop())}},$j2:function(){if(this.clientSettings&&!this.$i){var t=this.t%1*this.clientSettings.radius;$l(.3),c.fillStyle="#0f0",c.lineWidth=4,c.strokeStyle="#0f0",c.beginPath(),c.arc(this.clientSettings.destination.x,this.clientSettings.destination.y,t,0,2*M.PI,!0),c.fill(),c.stroke(),$l(1);var i=dist(this.x,this.y,this.clientSettings.destination.x,this.clientSettings.destination.y),s=M.atan2(this.clientSettings.destination.y-this.y,this.clientSettings.destination.x-this.x),e=200*$m(i/1e4,0,1)+100;i>300&&(sv(),tr(this.x+M.cos(s)*e,this.y+M.sin(s)*e),c.rotate(s),di(arrow,-arrow.width/2,-arrow.height/2),rs())}},pickup:function(t){this.client||(this.client=t,this.clientSettings=t.getDestinationSettings(),this.clientTimeLeft=this.clientSettings.time,$_.$TClient(t))},drop:function(){this.client.done=!0,this.client.x=this.x+40*M.cos(this.rotation+M.PI/2),this.client.y=this.y+40*M.sin(this.rotation+M.PI/2),this.client.findSidewalk(),$_.addClient(this.client);var t=dist(this.x,this.y,this.clientSettings.destination.x,this.clientSettings.destination.y)<=this.clientSettings.radius?this.clientSettings.price:0;t>0?(this.hud.message("reward: $"+t),this.cash+=t):this.hud.message("too slow"),this.client=null,this.clientSettings=null,this.dropoffs++},collided:function(t){this.explode(),t.explode(),$_.$TCar(t),window.collider=t},explode:function(){Car.prototype.explode.call(this),this.lives--,this.lives>0?setTimeout(this.re$aA.bind(this),2e3):setTimeout(G.gameOver.bind(G),2e3),$_.$Q()},re$aA:function(){this.hud.message("cars left: "+this.lives),this.client=null,this.clientTimeLeft=0,this.clientSettings=null,this.$i=!1,this.x=this.lastGoodPosition.x,this.y=this.lastGoodPosition.y,this.speed=0}}),Enemy.prototype=xt(Car.prototype,{$a:function(t){this.accelerates=!!this.path;var i=M.atan2($_.player.y-this.y,$_.player.x-this.x),s=dist($_.player.x,$_.player.y,this.x,this.y);if(abs(normalizeAngle(i-this.rotation))<M.PI/4&&s<300&&(this.accelerates=!1),this.path){var e=normalizeAngle(M.atan2(this.path.y-this.y,this.path.x-this.x)-this.rotation);e=$m(e,-this.rotationSpeed*t,this.rotationSpeed*t),this.rotation+=e,dist(this.x,this.y,this.path.x,this.path.y)<t*this.speed&&(this.x=this.path.x,this.y=this.path.y,this.follow(this.path.next))}Car.prototype.$a.call(this,t)},follow:function(t){this.path=t}}),Client.prototype={$a:function(t){if((s=dist(this.x,this.y,$_.player.x,$_.player.y))<200&&!$_.player.$i&&$_.player.speed<100&&!this.done&&!$_.player.client)if(this.target=null,s<30&&$_.player.speed<50)$_.player.pickup(this);else{var i=Math.min(50*t,s);this.x+=M.cos(this.angle)*i,this.y+=M.sin(this.angle)*i}else this.target||this.findSidewalk();if(this.target){var s=dist(this.x,this.y,this.target.x,this.target.y);(i=Math.min(50*t,s))>0&&(this.angle=M.atan2(this.target.y-this.y,this.target.x-this.x),this.x+=M.cos(this.angle)*i,this.y+=M.sin(this.angle)*i)}else this.angle=M.atan2($_.player.y-this.y,$_.player.x-this.x);var e=this;$_.cars.forEach((function(t){dist(e.x,e.y,t.x,t.y)<20&&abs(t.speed)>20&&e.die()})),this.$j()},$j:function(){sv(),tr(this.x,this.y),rt(this.angle),di(this.type,-this.type.width/2,-this.type.height/2),rs()},getDestinationSettings:function(){var t=$_.getRandomDestination(),i=abs(this.x-t.x)+abs(this.y-t.y),s=~~rd(1,4),e=~~(s/3*.01*i);return{destination:t,exigence:s,time:(1-s/4)*(i/$_.player.maxSpeed*4),price:M.max(5,e),radius:200}},die:function(){$_.$TClient(this);for(var t=0;t<40;t++){var i=new $w(4,"#950000",1),s=rd(2*M.PI),e=rd(5,25),h=rd(.05,.2);i.x=this.x,i.y=this.y,$_.add$w(i),$e.$f(i,"a",1,0,1,3,$r,i.$T.bind(i)),$e.$f(i,"x",i.x,i.x+M.cos(s)*e,h),$e.$f(i,"y",i.y,i.y+M.sin(s)*e,h)}$_.player.hud.message("don't kill customers!")},findSidewalk:function(){var t=$_.findClosestClientSpot(this.x,this.y);this.target={x:t.x+rd(-15,15),y:t.y+rd(-15,15)}}},HUD.prototype={$a:function(t){var i;this.msgT-=t,i=$_.player.$i?"wasted":this.msgT>0?this.msg:$_.player.client?"customer time left: "+M.ceil(M.max(0,$_.player.clientTimeLeft)):"find a customer";var s=$k(i,.5),e=(P.w-s)/2,h=P.h/2+200;$g(c,i,"white",e,h,.5,1),i="cash: $"+$_.player.cash,s=$k(i,.5),$g(c,i,"white",P.w-s-20,20,.5,1),$g(c,"cars: "+$_.player.lives,"white",20,20,.5,1),$_.player.client||(i="time: "+~~$_.timeleft,s=$k(i,.5),$g(c,i,"white",(P.w-s)/2,20,.5,1))},message:function(t){this.msgT=2,this.msg=t.toLowerCase()}},Building.prototype={$j:function(){if(this.visible&&!(this.x>$_.camX+P.w+P.v||this.y>$_.$d+P.h+P.v||this.x+this.w<$_.camX-P.v||this.y+this.h<$_.$d-P.v)){var t={x:this.x,y:this.y},i={x:this.x+this.w,y:this.y},s={x:this.x+this.w,y:this.y+this.h},e={x:this.x,y:this.y+this.h},h=this.pointUpperPosition(this.x,this.y),r=this.pointUpperPosition(this.x+this.w,this.y),n=this.pointUpperPosition(this.x+this.w,this.y+this.h),o=this.pointUpperPosition(this.x,this.y+this.h),a=h.x,l=h.y,c=n.x-h.x,f=n.y-h.y;if(sv(),tr(a,l),fs(roofb),fr(0,0,c,f),fs(roof),fr(20,20,c-40,f-40),rs(),fs("#00f"),h.x>t.x){shape([t,h,o,e],side1);for(var d=this.h/50,$=.3,p=this.h/d,u=$/2;u<1;u+=$)for(l=this.y+p/2;l<this.y+this.h;l+=p){var y=this.pointUpperPosition(this.x,l-12.5,u),x=this.pointUpperPosition(this.x,l-12.5,u+$/2),w=this.pointUpperPosition(this.x,l+12.5,u);shape([y,x,this.pointUpperPosition(this.x,l+12.5,u+$/2),w],"black")}}if(r.x<i.x)for(shape([r,i,s,n],side1),d=this.h/50,$=.3,p=this.h/d,u=$/2;u<1;u+=$)for(l=this.y+p/2;l<this.y+this.h;l+=p)y=this.pointUpperPosition(this.x+this.w,l-12.5,u),x=this.pointUpperPosition(this.x+this.w,l-12.5,u+$/2),w=this.pointUpperPosition(this.x+this.w,l+12.5,u),shape([y,x,this.pointUpperPosition(this.x+this.w,l+12.5,u+$/2),w],"black");if(h.y>t.y){shape([t,h,r,i],side2),d=this.w/50,$=.3;var g=this.w/d;for(u=$/2;u<1;u+=$)for(a=this.x+g/2;a<this.x+this.w;a+=g)y=this.pointUpperPosition(a-12.5,this.y,u),x=this.pointUpperPosition(a-12.5,this.y,u+$/2),w=this.pointUpperPosition(a+12.5,this.y,u),shape([y,x,this.pointUpperPosition(a+12.5,this.y,u+$/2),w],"black")}if(o.y<e.y)for(shape([e,o,n,s],side2),d=this.w/50,$=.3,g=this.w/d,u=$/2;u<1;u+=$)for(a=this.x+g/2;a<this.x+this.w;a+=g)y=this.pointUpperPosition(a-12.5,this.y+this.h,u),x=this.pointUpperPosition(a-12.5,this.y+this.h,u+$/2),w=this.pointUpperPosition(a+12.5,this.y+this.h,u),shape([y,x,this.pointUpperPosition(a+12.5,this.y+this.h,u+$/2),w],"black")}},pointUpperPosition:function(t,i,s){isNaN(s)&&(s=1);var e=t-($_.camX+P.w/2),h=i-($_.$d+P.h/2);return{x:t+e/P.h*200*s,y:i+h/P.h*200*s}},$F:function(t,i){return t>=this.x-10&&i>=this.y-10&&t<=this.x+this.w+10&&i<=this.y+this.h+10},getCycle:function(){for(var t=createCycle(this.getCorners(100)),i=rd(8),s=0;s<i;s++)t=t.next;return t},getCorners:function(t){return[{x:this.x-t,y:this.y-t},{x:this.x+this.w+t,y:this.y-t},{x:this.x+this.w+t,y:this.y+this.h+t},{x:this.x-t,y:this.y+this.h+t}]}},Texture.prototype={$j:function(){this.x>$_.camX+P.w+P.v||this.y>$_.$d+P.h+P.v||this.x+this.w<$_.camX-P.v||this.y+this.h<$_.$d-P.v||(sv(),tr(this.x,this.y),fs(this.t),fr(0,0,this.w,this.h),rs())}};var $I={a:[[1,1,1],[1,,1],[1,1,1],[1,,1],[1,,1]],b:[[1,1,1],[1,,1],[1,1],[1,,1],[1,1,1]],c:[[1,1,1],[1,,],[1,,],[1,,],[1,1,1]],d:[[1,1,0],[1,,1],[1,,1],[1,,1],[1,1,1]],e:[[1,1,1],[1,,],[1,1],[1,,],[1,1,1]],f:[[1,1,1],[1,,],[1,1],[1,,],[1,,]],g:[[1,1,1],[1,,],[1,,],[1,,1],[1,1,1]],h:[[1,,1],[1,,1],[1,1,1],[1,,1],[1,,1]],i:[[1,1,1],[,1],[,1],[,1],[1,1,1]],j:[[,,1],[,,1],[,,1],[1,,1],[1,1,1]],k:[[1,,1],[1,,1],[1,1],[1,,1],[1,,1]],l:[[1,,0],[1,,],[1,,],[1,,],[1,1,1]],m:[[1,,1],[1,1,1],[1,,1],[1,,1],[1,,1]],n:[[1,1,1],[1,,1],[1,,1],[1,,1],[1,,1]],o:[[1,1,1],[1,,1],[1,,1],[1,,1],[1,1,1]],p:[[1,1,1],[1,,1],[1,1,1],[1,,],[1,,]],r:[[1,1,1],[1,,1],[1,1],[1,,1],[1,,1]],s:[[1,1,1],[1,,],[1,1,1],[,,1],[1,1,1]],$:[[,,1,,0],[1,1,1,1,1],[1,,1,,],[1,1,1,1,1],[,,1,,1],[1,1,1,1,1],[,,1,,]],t:[[1,1,1],[,1],[,1],[,1],[,1]],u:[[1,,1],[1,,1],[1,,1],[1,,1],[1,1,1]],v:[[1,,1],[1,,1],[1,,1],[1,,1],[,1]],w:[[1,,,,1],[1,,,,1],[1,,1,,1],[1,,1,,1],[,1,,1]],x:[[1,,1],[1,,1],[,1],[1,,1],[1,,1]],y:[[1,,1],[1,,1],[1,1,1],[,1],[,1]],"'":[[1]],".":[[0],[0],[0],[0],[1]]," ":[[,0],[,],[,],[,],[,]],"-":[[,0],[,],[1,1],[,],[,]],":":[[0],[1],[],[1],[]],"?":[[1,1,1],[,,1],[,1,1],[,,],[,1]],"!":[[,1],[,1],[,1],[,,],[,1]],1:[[1,1,0],[,1],[,1],[,1],[1,1,1]],2:[[1,1,1],[,,1],[1,1,1],[1,,],[1,1,1]],3:[[1,1,1],[,,1],[,1,1],[,,1],[1,1,1]],4:[[1,,0],[1,,],[1,,1],[1,1,1],[,,1]],5:[[1,1,1],[1,,],[1,1],[,,1],[1,1]],6:[[1,1,1],[1,,],[1,1,1],[1,,1],[1,1,1]],7:[[1,1,1],[,,1],[,1],[,1],[,1]],8:[[1,1,1],[1,,1],[1,1,1],[1,,1],[1,1,1]],9:[[1,1,1],[1,,1],[1,1,1],[,,1],[1,1,1]],0:[[1,1,1],[1,,1],[1,,1],[1,,1],[1,1,1]]},$x={},$H=function(t){for(var i in $x[t]={},$I){var s=$I[i];$x[t][i]=$c(10*s[0].length+10,10*s.length,(function(i,e){e.fs(t);for(var h=0;h<s.length;h++)for(var r=0;r<s[h].length;r++)s[h][r]&&e.fr(10*r,10*h,10,10)}))}};$H("white"),$H("black");var $g=function(t,i,s,e,h,r,n){r=r||1,n&&$g(t,i,"black",e,h+5,r,!1),t.sv(),t.tr(e,h),t.sc(r,r),e=0;for(var o=0;o<i.length;o++){var a=i.charAt(o),l=$x[s][a];l&&(t.di(l,e,0),e+=l.width)}t.rs()},$k=function(t,i){for(var s=0,e=t.length;e--;){var h=$x.white[t.charAt(e)];s+=h?h.width:0}return s*(i||1)},s=4,car={white:newCar("#fff"),broken:newCar("#1b1b1b",!0),yellow:newCar("#ff0"),blue:newCar("#00f"),red:newCar("#f00"),green:newCar("#0f0"),purple:newCar("#f0f"),gray:newCar("#6c6c6c")},client=function(t){return $c(20,30,(function(i,s){s.fs(t),s.fr((i.width-14)/2,(i.height-18)/2,14,18),s.bp(),s.arc(i.width/2,i.height/2-10,4,0,2*M.PI,!0),s.arc(i.width/2,i.height/2+10,4,0,2*M.PI,!0),s.fill(),s.fs("#e99a79"),s.bp(),s.arc(i.width/2,i.height/2,6,0,2*M.PI,!0),s.fill(),s.fs("#000"),s.fr(i.width/2+2,i.height/2-3,2,2),s.fr(i.width/2+2,i.height/2+3,2,-2)}))},clientRed=client("#900"),clientBlack=client("#000"),clientBlue=client("#00f"),clientYellow=client("#880"),arrow=$c(40,40,(function(c,r){with(r)tr(c.width/2,c.height/2),rotate(Math.PI/2),tr(-c.width/2,-c.height/2),tr(0,c.height),sc(1,-1),fs("#fff"),bp(),mt(20,40),lt(40,20),lt(30,20),lt(30,0),lt(10,0),lt(10,20),lt(0,20),fill()})),brokenCar=$c(50,22,(function(c,r){with(r)fs("#1b1b1b"),fr(0,0,50,22),fs("#000"),fr(10,3,5,16),fr(30,3,10,16),fr(15,1,7,1),fr(23,1,7,1),fr(15,20,7,1),fr(23,20,7,1)})),grass=$c(200,200,(function(t,i){for(var s=0;s<t.width;s+=4)for(var e=0;e<t.height;e+=4)i.fs("rgb(0,"+(128+~~rd(-50,50))+", 0)"),i.fr(s,e,4,4)}),"$h"),sidewalk=$c(100,100,(function(t,i){for(var e=0;e<t.width;e+=s)for(var h=0;h<t.height;h+=s){var r=(e<8||h<8||e>=t.width-8||h>=t.height-8||e>=t.width/2-8&&e<=t.width/2+8||h>=t.height/2-8&&h<=t.height/2+8?80:100)+~~rd(-10,10);i.fs("rgb("+r+", "+r+", "+r+")"),i.fr(e,h,s,s)}}),"$h"),road=$c(200,200,(function(t,i){for(var e=0;e<t.width;e+=s)for(var h=0;h<t.height;h+=s){var r=40+~~rd(-10,10);i.fs("rgb("+r+", "+r+", "+r+")"),i.fr(e,h,s,s)}}),"$h"),$N=$c(100,100,(function(t,i){for(var e=0;e<t.width;e+=s)for(var h=0;h<t.height;h+=s)i.fs("rgb(0, "+~~(168+~~rd(-10,10))+", 255)"),i.fr(e,h,s,s)}),"$h"),xwalkh=$c(25,50,(function(t,i){for(var e=~~(t.width/4);e<.75*t.width;e+=s)for(var h=0;h<t.height;h+=s){var r=255-~~rd(10,50);i.fs("rgb("+r+", "+r+", "+r+")"),i.fr(e,h,s,s)}}),"$h"),xwalkv=$c(50,25,(function(t,i){for(var e=0;e<t.width;e+=s)for(var h=~~(t.height/4);h<.75*t.height;h+=s){var r=255-~~rd(10,50);i.fs("rgb("+r+", "+r+", "+r+")"),i.fr(e,h,s,s)}}),"$h");roof=$c(100,100,(function(t,i){for(var e=0;e<t.width;e+=s)for(var h=0;h<t.height;h+=s){var r=100+~~rd(-10,10);i.fs("rgb("+r+", "+r+", "+r+")"),i.fr(e,h,s,s)}}),"$h"),roofb=$c(100,100,(function(t,i){for(var e=0;e<t.width;e+=s)for(var h=0;h<t.height;h+=s){var r=50+~~rd(-10,10);i.fs("rgb("+r+", "+r+", "+r+")"),i.fr(e,h,s,s)}}),"$h"),side1=$c(100,100,(function(t,i){for(var e=0;e<t.width;e+=s)for(var h=0;h<t.height;h+=s){var r=128+~~rd(-5,5);i.fs("rgb("+r+", "+r+", "+r+")"),i.fr(e,h,s,s)}}),"$h"),side2=$c(100,100,(function(t,i){for(var e=0;e<t.width;e+=s)for(var h=0;h<t.height;h+=s){var r=153+~~rd(-5,5);i.fs("rgb("+r+", "+r+", "+r+")"),i.fr(e,h,s,s)}}),"$h"),hline=$c(100,4,(function(t,i){for(var e=.25*t.width;e<.75*t.width;e+=s)for(var h=0;h<t.height;h+=s){var r=255-~~rd(10,50);i.fs("rgb("+r+", "+r+", "+r+")"),i.fr(e,h,s,s)}}),"$h"),vline=$c(4,100,(function(t,i){for(var e=.25*t.height;e<.75*t.height;e+=s)for(var h=0;h<t.height;h+=s){var r=255-~~rd(10,50);i.fs("rgb("+r+", "+r+", "+r+")"),i.fr(h,e,s,s)}}),"$h"),tree=$c(200,200,(function(t,i){for(var e=0;e<t.width;e+=s)for(var h=0;h<t.height;h+=s)if(dist(t.width/2,t.height/2,e,h)<.4*t.width&&Math.random()<.8){var r=50+~~rd(-25,25);i.fs("rgb(0, "+r+", 0)"),i.fr(e,h,s,s)}})),tree2=$c(150,150,(function(t,i){for(var e=0;e<t.width;e+=s)for(var h=0;h<t.height;h+=s)if(dist(t.width/2,t.height/2,e,h)<.4*t.width&&Math.random()<.8){var r=50+~~rd(-25,25);i.fs("rgb(0, "+r+", 0)"),i.fr(e,h,s,s)}})),parking=$c(100,300,(function(t,i){i.fs(road),i.fillRect(0,0,t.width,t.height);for(var e=0;e<t.width;e+=s)for(var h=0;h<t.height;h+=s)if(h<s||h>=t.height-s||(e<s||e>=t.width-s||e>=t.width/2-s&&e<=t.width/2+s)&&(h<.3*t.height||h>=.7*t.height)){var r=255-~~rd(10,50);i.fs("rgb("+r+", "+r+", "+r+")"),i.fr(e,h,s,s)}}),"$h"),addEventListener("load",(function(){G=new $E}));var $fs=[];function $r(t,i,s,e){return t/e*s+i}function easeOutBack(t,i,s,e,h){return null==h&&(h=1.70158),s*((t=t/e-1)*t*((h+1)*t+h)+1)+i}function easeOutBounce(t,i,s,e){return(t/=e)<1/2.75?s*(7.5625*t*t)+i:t<2/2.75?s*(7.5625*(t-=1.5/2.75)*t+.75)+i:t<2.5/2.75?s*(7.5625*(t-=2.25/2.75)*t+.9375)+i:s*(7.5625*(t-=2.625/2.75)*t+.984375)+i}var $e={$f:function(t,i,s,e,h,r,n,o){$fs.push({o:t,p:i,a:s,b:e,d:h,l:r||0,f:n||$r,e:o||$R,t:0})},$a:function(t){for(var i,s=$fs.length-1;s>=0;s--)(i=$fs[s]).l>0?(i.l-=t,i.o[i.p]=i.a):(i.t=M.min(i.d,i.t+t),i.o[i.p]=i.f(i.t,i.a,i.b-i.a,i.d),i.t==i.d&&(i.e.call(i.o),$fs.splice(s,1)))}};function $w(t,i,s){this.s=t,this.c=i,this.a=s}function Tree(t,i){this.x=t,this.y=i,this.collides=!0}$w.prototype={$j:function(t){$l(this.a),fs(this.c),fr(this.x-this.s/2,this.y-this.s/2,this.s,this.s),$l(1)},$T:function(){$_.$A(this)}},Tree.prototype=xt(Building.prototype,{$j:function(){if(!(this.x>$_.camX+P.w+200||this.y>$_.$d+P.h+200||this.x<$_.camX-200||this.y<$_.$d-200)){var t=this.pointUpperPosition(this.x,this.y,.2),i=this.pointUpperPosition(this.x,this.y,.4);c.strokeStyle="#5a3900",c.lineWidth=15,bp(),mt(this.x,this.y),lt(i.x,i.y),stroke(),di(tree,t.x-tree.width/2,t.y-tree.height/2),di(tree2,i.x-tree2.width/2,i.y-tree2.height/2)}},$F:function(t,i){return abs(t-this.x)<15&&abs(i-this.y)<15},getCycle:function(){return null},getCorners:function(t){return[]}})</script>