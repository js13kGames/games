<!DOCTYPE HTML>
<meta charset="utf-8">

<html>
<head>
<title> Wizard Tower </title>
<style>	html, body {background-color:black}</style>
</head>
<body style="padding:0;margin:0;">
<script>!function(){function t(t){this.o=t,this.uPl=[],this.fPl=[]}function e(t){return Math.floor(t)}function n(t,e){var i,n,r=[];for(n=0;e>n;n++)for(r.push([]),i=0;t>i;i++)r[n].push(0);return r}function o(t){for(var e=[],i=0,n=t.length;n>i;i++){e.push([]);for(var r=0,o=t[0].length;o>r;r++)e[i][r]=t[i][r]}return e}function a(t,i,n){var r=Math.random()*(i-t)+t;return n?e(r):r}function s(t,i,n){var r=l()*(i-t)+t;return n?e(r):r}function l(){var t=Math.sin(U++)*(1e4+H);return t-e(t)}function h(t,e,i){var n=i||0;return e.x<t.x+t.w-t.w*n&&e.y<t.y+t.h-t.h*n&&e.x+e.w>t.x+t.w*n&&e.y+e.h>t.y+t.w*n?!0:!1}function c(t,e){return e.x>t.x&&e.x<t.x+t.w&&e.y>t.y&&e.y<t.y+t.h?!0:void 0}function f(t,e){return Math.sqrt(void 0!==t.gx?(e.gx-t.gx)*(e.gx-t.gx)+(e.gy-t.gy)*(e.gy-t.gy):(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y))}function u(t,e,i,n){for(var r=[],o=Math.abs(i-t),a=i>t?1:-1,s=Math.abs(n-e),l=n>e?1:-1,h=(o>s?o:-s)/2,c=!1;!c;){r.push({x:t,y:e}),t===i&&e===n&&(c=!0);var f=h;f>-o&&(h-=s,t+=a),s>f&&(h+=o,e+=l)}return r}function g(t,i,n,r){function o(t,e,i){return 0>i&&(i+=1),i>1&&(i-=1),1/6>i?t+6*(e-t)*i:.5>i?e:2/3>i?t+(e-t)*(2/3-i)*6:t}var a,s,l,h="rgb";if(0==i)a=s=l=n;else{var c=.5>n?n*(1+i):n+i-n*i,f=2*n-c;a=e(255*o(f,c,t+1/3)),s=e(255*o(f,c,t)),l=e(255*o(f,c,t-1/3))}return r&&(h+="a"),h+="("+a+","+s+","+l,r&&(h+=","+r),h+=")"}function p(t,e,i,n,r,o){for(var a=e.split(" "),s="",l=0;l<a.length;l++){var h=s+a[l]+" ",c=t.measureText(h),f=c.width;f>r&&l>0?(t.fillText(s,i,n),s=a[l]+" ",n+=o):s=h}t.fillText(s,i,n)}function d(t,e){for(var i=0,n=t.length;n>i;i++){var r=t[i];if(void 0!==r){var o=z[r.sfx];for(var a in r)"time"!==a&&"sfx"!==a&&(o[a]=r[a]);void 0!==e?v(e*i,o):v(r.time,o)}}}function v(t,e){function i(t,e){var i=this;i.type=t,i.frequency=e,i.gain=Q.createGain(),i.oscillator=Q.createOscillator(),i.oscillator.frequency.value=e,i.oscillator.type=t,i.play=function(t,e,n,r){i.d=t,i.V=r||1,i.D=n||1,i.oscillator.connect(i.gain),i.gain.gain.value=r,i.gain.connect(t),i.oscillator.start(Q.currentTime+e),i.oscillator.stop(Q.currentTime+n)},i.stop=function(t){var t=t||0;i.oscillator.stop(t)}}function n(t,e,i,n,r){t.linearRampToValueAtTime(e,Q.currentTime+n),t.linearRampToValueAtTime(i,Q.currentTime+n+r)}function r(e){var i=e.frequency.value;e.frequency.linearRampToValueAtTime(i,Q.currentTime+t),e.frequency.linearRampToValueAtTime(i+u,Q.currentTime+t+o+s+l)}if(0!==ye){var t=t+e[0]||0,o=e[1]||0,a=e[2]||1,s=e[3]||0,l=e[4]||0,h=(e[5]||0,e[6]||0),c=e[7]||0,f=e[8]||220,u=e[9]||0,g=e[10]||"sine",p=e[11]||1,d=e[12]||2e4,v=e[13]||0,y=e[14]||0,b=e[15]||0,x=Q.createOscillator(),m=Q.createBiquadFilter(),w=Q.createBiquadFilter();m.connect(w),m.type="lowpass",m.frequency.value=d,n(m.frequency,d,d+v,t,o+s+l),w.connect(Q.destination),w.type="highpass",w.frequency.value=y,n(w.frequency,y,y+b,t,o+s+l),osc=new i(g,f),osc.play(m,t,t+o+s+l,1),h>0&&(x=new i("sawtooth",h),x.play(osc.oscillator.frequency,t,t+o+s+l,c)),o>0?(osc.gain.gain=0,n(osc.gain.gain,0,p,t,o)):osc.gain.gain=p,s>0?(n(osc.gain.gain,p,a,t+o,s),n(osc.gain.gain,a,0,t+o+s,l)):l>0&&n(osc.gain.gain,p,0,t+o,l),0!==u&&r(osc.oscillator)}}function y(t){for(var e=t,i=[];e.pr;)i.push(e),e=e.pr;return i.reverse()}function b(){return new w(function(t){return t.f})}function x(t,e){var i=this;i.oP=e||{},i.Nds=[],i.Gr=[];for(var n=0,r=t.length;r>n;n++){for(var o=[],a=0,s=t[0].length;s>a;a++){var l=new m(a,n,t[n][a]);o.push(l),i.Nds.push(l)}i.Gr.push(o)}i.init()}function m(t,e,i){this.x=t,this.y=e,this.w=i}function w(t){this.content=[],this.sF=t}function T(t){var e=[],n=t.touches;0===n.length&&(n=t.changedTouches);for(i in n)void 0!==n[i].identifier&&e.push({x:n[i].pageX-oe,y:n[i].pageY-ae,id:n[i].identifier});return e}function P(){this.eA=[],this.aNms=[],this.toRemove=[]}function S(t,e,i,n,r,o){var a=this;a.tX=t,a.x=e,a.y=i,a.colour=o||"rgb(30,30,30)",a.A=1,a.textAlign=r||"left",a.font=.75*ue+"px 'avenirnext-bold','droid sans'",a.lineWidth=n,a.strokeStyle="white",a.visible=!0,a.w=0,a.lh=0}function k(){}function G(t){var e=this;e.gM=t,e.visible=!1,e.A=1,e.type="",e.x=0,e.y=0,e.Tg=null,e.FIRING=!1}function M(t,e,i,n,r,o){void 0===r&&(r=4);t.save(),t.translate(i,n),o&&(t.translate(ue,0),t.scale(-1,1),i*=-1);for(var a in e){var s=e[a];switch(s[0]){case"b":t.beginPath();break;case"c":t.closePath();break;case"m":t.moveTo(s[1]*r,s[2]*r);break;case"l":t.lineTo(s[1]*r,s[2]*r);break;case"a":t.arc(s[1]*r,s[2]*r,s[3]*r,s[4],s[5],s[6]);break;case"at":t.arcTo(s[1]*r,s[2]*r,s[3]*r,s[4]*r,s[5]*r);break;case"q":t.quadraticCurveTo(s[1]*r,s[2]*r,s[3]*r,s[4]*r);break;case"bt":t.bezierCurveTo(s[1]*r,s[2]*r,s[3]*r,s[4]*r,s[5]*r,s[6]*r)}}t.restore()}function E(){}function A(t,e){var i,n,a,s=o(t);for(r=[],i=0;e>i;i++){r=[];for(a in s[0]){r.push([]);for(n in s)r[a].push(s[n][s[0].length-a-1])}s=o(r)}return s}function R(t,e){function i(t){("P"===n.pS||"R"===n.pS&&!n.Pl.moving)&&(n.Pl.nextDir=t,n.READY=!0,n.steps++)}var n=this;n.Cn=t,n.pS=e,n.score=0;var r={};r.score=new S("SCORE: ",.25*ue,.5*ue,ue/40),r.highScore=new S("HIGH SCORE: "+$,22.5*ue,.5*ue,ue/40,"right"),r.charges=new S("CHARGES: ",.25*ue,14.5*ue,ue/40),r.gO=new S("GAME OVER!",11.5*ue,n.Cn.height/2,ue/40,"center","rgb(60,60,60)"),r.gO.font=2*ue+"px 'avenirnext-bold','droid sans'",r.gO.visible=!1,r.gO.A=0,r.cG=new S("Congratulations!",11.5*ue,6.5*ue,ue/40,"center","rgb(60,60,60)"),r.cG.font=2*ue+"px 'avenirnext-bolditalic','droid sans'",r.cG.visible=!1,r.cG2=new S("You've beat you're high score!",11.5*ue,8.5*ue,ue/40,"center","rgb(60,60,60)"),r.cG2.font=ue+"px 'avenirnext-bold','droid sans'",r.cG2.w=16*ue,r.cG2.lh=ue,r.cG2.visible=!1,n.tX=r,n.init(1),n.steps=0,n.READY="P"===e,bTs=[];var o=t.width,a=t.height;n.exit={x:o-.75*ue,y:0,w:.75*ue,h:.75*ue,down:function(){N()}},bTs.push(n.exit),n.bTs=[],n.bTs.push({x:0,y:0,w:.2*o,h:a,down:function(){i("W")},held:function(){i("W")}}),n.bTs.push({x:.2*o,y:0,w:.6*o,h:.2*o,down:function(){i("N")},held:function(){i("N")}}),n.bTs.push({x:.2*o,y:a-.2*o,w:.6*o,h:.2*o,down:function(){i("S")},held:function(){i("S")}}),n.bTs.push({x:o-.2*o,y:0,w:.2*o,h:a,down:function(){i("E")},held:function(){i("E")}}),n.bTs.push({x:.2*o,y:.2*o,w:.6*o,h:a-.4*o,down:function(){n.fireWp("laser")}});for(var s in n.bTs)bTs.push(n.bTs[s])}function D(t){function e(){90===orientation&&location.reload()}this.Cn=t,1===ye&&d([{sfx:"Sn",8:220},{sfx:"Sn",8:440},{sfx:"Sn",8:392},{sfx:"Sn",8:349.23},{sfx:"Sn",8:311.13,3:2}],.9),this.tW=fe.nX(),this.tW.init(null,5.5,3.5,"tW",13),this.clouds=[],this.backClouds=[];this.pacman=fe.nX(),this.pacman.init(null,2,6,"pacman",5.5);for(var i=0,n=16;n>i;i++){var r=a(1,9,!0),o=13+r;i>8&&(r=a(5,13,!0),o=11+r);var s=fe.nX();s.init(null,i%8*6-10,6-r,"cloud",o),r=a(5,10),ce.aV(s,"x",s.x,s.x+ue,function(t){return t*t*(3-2*t)},1e3*r,void 0,"pingpong"),8>i?this.clouds.push(s):this.backClouds.push(s)}this.oriented=le&&90!==orientation?!1:!0,this.oriented||addEventListener("orientationchange",e,!1);var l=t.width,h=t.height;bTs=[],bTs.push({x:l/10,y:h/2.5,w:l/5,h:l/5,down:function(){X(300,"in",function(){V("P")})}}),bTs.push({x:l/10*7,y:h/2.5,w:l/5,h:l/5,down:function(){X(300,"in",function(){V("R")})}}),bTs.push({x:0,y:h-l/8,w:l/8,h:l/8,time:0,down:function(){this.time=(new Date).getTime(),H>1&&(H-=1),localStorage.SEED=H},held:function(){(new Date).getTime()>this.time+200&&(H>11?H-=10:H=1),localStorage.SEED=H}}),bTs.push({x:l/8,y:h-l/8,w:l/8,h:l/8,time:0,down:function(){this.time=(new Date).getTime(),H+=1,localStorage.SEED=H},held:function(){(new Date).getTime()>this.time+200&&(H+=10),localStorage.SEED=H}}),bTs.push({x:l/8*7,y:h-l/8,w:l/8,h:l/8,down:W}),X(300,"out")}function C(t){se.fillStyle=t}function I(t){se.strokeStyle=t}function O(){te.height=window.innerHeight,te.width=window.innerWidth}function W(){ye=0===ye?1:0,localStorage.MUTE=ye}function V(t){Pe=new R(te,t),me=xe,Te=null}function N(){me=be,Pe=null}function X(t,e,i,n){var r=1,o=0,a=n||this;"in"===e&&(r=0,o=1),ce.aV(a,"A",r,o,function(t){return t*t*(3-2*t)},t,function(){i&&i()})}function q(){switch(requestAnimationFrame(q),we.update(),ce.pAnm(),me){case be:null===Te&&(Te=new D(te)),Te.update();break;case xe:Pe.update()}L()}function L(){switch(C("black"),se.fillRect(0,0,te.width,te.height),me){case be:Te.render(se);break;case xe:Pe.render(se)}le&&I("black"),this.A>0&&(se.save(),se.globalAlpha=this.A,C("black"),se.fillRect(0,0,te.width,te.height),se.restore())}t.prototype.nX=function(){return this.fPl.length>0?this.fPl.splice(0,1)[0]:this.nO()},t.prototype.nO=function(){var t=new this.o;return this.uPl.push(t),t},t.prototype.free=function(t){this.uPl.splice(this.uPl.indexOf(t),1),this.fPl.push(t)};var H=localStorage.SEED;H=void 0===H?1:parseInt(H);var U=1,z={Sn:[0,.15,.4,.55,.4,,87.5,100,350,,"sine",.5,15e3,,20],lv:[,.2,.3,.5,.4,,7,50,110,350,"square",.5,6e3,-5e3,200],death:[,.04,.7,.3,.2,100,10,100,350,-100,"sine",.5,15e3,,20],lights:[,.04,.1,.4,.2,100,50,50,200,,"sine",.3,200,,20,500],powerUp:[,,.4,.5,.1,100,12,80,300,500,"sine",.7,200,1e3,20],sS:[,.01,.5,.25,.1,100,40,40,540,-350,"square",.3,6e3,-6e3,20],step:[0,,,,.05,100,,,100,,"square",.05,3e3,,20]},_={search:function(t,e,i,n){t.Cd(),n=n||{};var r=n.H||_.Hs.mH,o=n.cl||!0,a=b(),s=e;for(e.h=r(e,i),a.push(e);a.size()>0;){var l=a.pop();if(l===i)return y(l);l.Cl=!0;for(var h=t.nBs(l),c=0,f=h.length;f>c;++c){var u=h[c];if(!u.Cl&&!u.isWall()){var g=l.g+u.gC(l),p=u.v;(!p||g<u.g)&&(u.v=!0,u.pr=l,u.h=u.h||r(u,i,t.oP.Pt),u.g=g,u.f=u.g+u.h,t.mD(u),o&&(u.h<s.h||u.h===s.h&&u.g<s.g)&&(s=u),p?a.rE(u):a.push(u))}}}return o?y(s):[]},Hs:{mH:function(t,e,i){function n(t,e){var i=Math.abs(e.x-t.x),n=Math.abs(e.y-t.y);return i+n}var r=n(t,e);for(var o in i){var a=n(t,i[o])+n(i[o].to,e);r>a&&(r=a)}return r}},cln:function(t){t.f=0,t.g=0,t.h=0,t.v=!1,t.Cl=!1,t.pr=null}};x.prototype.init=function(){this.dirtyNodes=[];for(var t=0;t<this.Nds.length;t++)_.cln(this.Nds[t])},x.prototype.Cd=function(){for(var t=0;t<this.dirtyNodes.length;t++)_.cln(this.dirtyNodes[t]);this.dirtyNodes=[]},x.prototype.mD=function(t){this.dirtyNodes.push(t)},x.prototype.nBs=function(t){var e=[],i=t.x,n=t.y,r=this.Gr;r[n]&&r[n][i-1]&&e.push(r[n][i-1]),r[n]&&r[n][i+1]&&e.push(r[n][i+1]),r[n-1]&&r[n-1][i]&&e.push(r[n-1][i]),r[n+1]&&r[n+1][i]&&e.push(r[n+1][i]);for(var o=0,a=this.oP.Pt.length;a>o;o++){var s=this.oP.Pt[o];i===s.x&&n===s.y&&e.push(r[s.to.y][s.to.x])}return e},m.prototype.gC=function(){return this.w},m.prototype.isWall=function(){return 0===this.w},w.prototype={push:function(t){this.content.push(t),this.Sd(this.content.length-1)},pop:function(){var t=this.content[0],e=this.content.pop();return this.content.length>0&&(this.content[0]=e,this.bU(0)),t},remove:function(t){var e=this.content.indexOf(t),i=this.content.pop();e!==this.content.length-1&&(this.content[e]=i,this.sF(i)<this.sF(t)?this.Sd(e):this.bU(e))},size:function(){return this.content.length},rE:function(t){this.Sd(this.content.indexOf(t))},Sd:function(t){for(var e=this.content[t];t>0;){var i=(t+1>>1)-1,n=this.content[i];if(!(this.sF(e)<this.sF(n)))break;this.content[i]=e,this.content[t]=n,t=i}},bU:function(t){for(var e=this.content.length,i=this.content[t],n=this.sF(i);;){var r,o=t+1<<1,a=o-1,s=null;if(e>a){var l=this.content[a];r=this.sF(l),n>r&&(s=a)}if(e>o){var h=this.content[o],c=this.sF(h);(null===s?n:r)>c&&(s=o)}if(null===s)break;this.content[t]=this.content[s],this.content[s]=i,t=s}}};var F=function(){this.keys={},this.touch={};addEventListener("mousedown",this.tDown.bind(this),!1),addEventListener("mouseup",this.tUp.bind(this),!1),addEventListener("mousemove",this.tMove.bind(this),!1),addEventListener("touchstart",this.tDown.bind(this),!1),addEventListener("touchend",this.tUp.bind(this),!1),addEventListener("touchmove",this.tMove.bind(this),!1)};F.prototype.rG=function(t,e,i,n,r){"touch"===t&&(window.bTs=[],this.touches=[],this.touch={touched:!1,x:null,y:null,down:i,up:n,held:r})},F.prototype.update=function(){if(this.touches.length>0)for(var t in this.touches){var e=this.touches[t];if(bTs.length>0&&e)for(var t in bTs){var i=bTs[t];i&&i.held&&c(i,e)&&i.held()}}},F.prototype.tDown=function(t){var e=[];if(le?(t.preventDefault(),e=T(t)):e.push({x:t.clientX-oe,y:t.clientY-ae,id:0}),e.length>0)for(var i in e){var n=e[i],r=!0;for(var o in this.touches)this.touches[o].id===n.id&&(r=!1);if(r&&(this.touches.push(n),bTs.length>0))for(var i in bTs){var a=bTs[i];a&&a.down&&c(a,n)&&a.down()}}},F.prototype.tUp=function(t){if(le)if(1===this.touches.length)this.touches=[];else{var e=T(t);this.touches=e}else this.touches=[]},F.prototype.tMove=function(t){t.preventDefault()},P.prototype.pAnm=function(){for(var t=0,e=this.eA.length;e>t;t++){var i=this.eA[t];if(void 0!==i&&void 0!==i.ease&&null!==i.ease)if(0===i.ease.length)this.eA.splice(this.eA.indexOf(i));else for(var n=0,r=i.ease.length;r>n;n++)i.ease[n]&&i.ease[n].aNm()}if(this.toRemove.length>0){for(var t in this.toRemove)this.removeEasing(this.toRemove[t]);this.toRemove=[]}},P.prototype.aV=function(t,e,i,n,r,o,a,s,l){var h=this.eA.indexOf(t);-1!==h&&this.eA.splice(h,1),this.eA.push(t),this.animate({Tg:t,V:e,D:r,dr:o||1e3,type:s||"once",tm:l,cLb:a,step:function(r){t[e]=i-(i-n)*r}})},P.prototype.animate=function(t){function i(){var i=(new Date).getTime()-r,o=i/(t.dr||1e3),a=t.D;switch(t.type){case"once":o>1&&(o=1),t.step(a(o)),1===o&&n(t.Tg,this);break;case"loop":t.step(a(o%1)),option.tm&&o>t.tm&&n(t.Tg,this);break;case"pingpong":t.step(o>1?e(o)%2===0?a(o%1):1-a(o%1):a(o)),t.tm&&o>2*t.tm&&n(t.Tg,this)}}function n(e,i){e.cLb=t.cLb,e.toRemove=i,o.toRemove.push(e)}var r=(new Date).getTime();t.Tg.ease&&null!==t.Tg.ease?(-1!==t.Tg.ease.indexOf({type:t.V,aNm:i})&&t.Tg.ease.splice(t.Tg.ease.indexOf({type:t.V,aNm:i}),1),t.Tg.ease.push({type:t.V,aNm:i})):t.Tg.ease=[{type:t.V,aNm:i}];var o=this},P.prototype.removeEasing=function(t){t.ease.splice(t.ease.indexOf(t.toRemove),1),t.toRemove=void 0,0===t.ease.length&&this.eA.splice(this.eA.indexOf(t),1),void 0!==t.cLb&&(t.cLb(t),t.cLb=void 0)},P.prototype.movePiece=function(t,e,i,n,r,o){var a=0,r=r||function(t){return t*t*(3-2*t)};i!==t.y&&(a++,this.aV(t,"y",t.y,i,r,n,function(){a--,s()})),e!==t.x&&(a++,this.aV(t,"x",t.x,e,r,n,function(){a--,s()}));var s=function(){o&&0===a&&o(t)}},S.prototype.render=function(t){var e=this;e.visible&&(t.save(),e.A<1&&(t.globalAlpha=e.A),t.font=e.font,t.textAlign=e.textAlign,C(e.colour),t.lineWidth=e.lineWidth,I(e.strokeStyle),0===e.w?(t.fillText(e.tX,e.x,e.y),!le&&e.lineWidth>0&&t.strokeText(e.tX,e.x,e.y)):p(t,e.tX,e.x,e.y,e.w,e.lh),t.restore())},k.prototype.init=function(t,e,i,n,r){var o=this;o.gM=t,o.type=n,o.dead=!1,o.x=e*ue||0,o.y=i*ue||0,o.w=r*ue||ue,o.h=r*ue||ue,o.yOff=0,o.A=1,o.visible=!0,o.H=.33,o.S=.03,o.L=.2,o.colour,o.A=1,o.moving=!1,o.gx=e,o.gy=i,o.vx=0,o.vy=0,o.speed=pe,o.dir="",o.nextDir="",o.lastDir="E",o.portal="",o.zIndex=3*o.gy+2,o.gM&&o.gM.sprites.push(o)},k.prototype.render=function(t){var e=this;if(t.save(),e.visible)switch(e.A<1&&(t.globalAlpha=e.A),B[e.type](t,e.x,e.y,e.w,e),e.portal){case"left":B[e.type](t,e.x-23*ue,e.y,e.w,e);break;case"right":B[e.type](t,e.x+23*ue,e.y,e.w,e)}t.restore()},k.prototype.update=function(){this.gx=e(this.x/ue),this.gy=e(this.y/ue)},k.prototype.Colour=function(){return g(this.H,this.S,this.L,1)},k.prototype.fadeIn=function(){this.fading=!0;var t=this;ce.aV(this,"H",.33,.67,function(t){return Math.pow(Math.sin(t*Math.PI/2),2)},400),ce.aV(this,"S",.03,.2,function(t){return Math.pow(Math.sin(t*Math.PI/2),2)},400),ce.aV(this,"L",.2,.7,function(t){return Math.pow(Math.sin(t*Math.PI/2),2)},400,function(){t.fading=!1}),this.lit=!0},k.prototype.fadeOut=function(){this.fading=!0;var t=this;ce.aV(this,"H",.67,.33,function(t){return Math.pow(Math.sin(t*Math.PI/2),2)},400),ce.aV(this,"S",.2,.03,function(t){return Math.pow(Math.sin(t*Math.PI/2),2)},400),ce.aV(this,"L",.7,.2,function(t){return Math.pow(Math.sin(t*Math.PI/2),2)},400,function(){t.fading=!1}),this.lit=!1};var Y={N:{x:0,y:-1},E:{x:1,y:0},S:{x:0,y:1},W:{x:-1,y:0}};k.prototype.AI=function(){var t=this;if(!t.moving&&(void 0===t.path||0===t.path.length)){var i=t.gM.Pl;switch(t.aiType){case"follow":t.path=t.gM.bestPath(t,i);break;case"cutOff":var n=o(t.gM.map);n[i.gy][i.gx]=0,t.path=""!==i.dir&&f(t,t.gM.Pl)>4&&void 0!==n[i.gy+Y[i.dir].y]&&void 0!==n[i.gy+Y[i.dir].y][i.gx+Y[i.dir].x]?t.gM.bestPath(t,{gx:i.gx+Y[i.dir].x,gy:i.gy+Y[i.dir].y},n):t.gM.bestPath(t,i);break;case"patrol":f(t,t.gM.Pl)<5?t.path=t.gM.bestPath(t,i):(void 0===t.patrolNumber&&(t.patrolNumber=a(0,3,!0)),t.path=t.gM.bestPath(t,t.gM.eLocs[t.patrolNumber]),void 0!==t.path&&t.path.length<1&&(t.patrolNumber=(t.patrolNumber+a(0,3,!0))%t.gM.eLocs.length),t.path=t.gM.bestPath(t,t.gM.eLocs[t.patrolNumber]));break;case"dumb":f(t,t.gM.Pl)<4?t.path=t.gM.bestPath(t,i):((void 0===t.Tg||void 0!==t.path&&0===t.path.length)&&(t.Tg=t.gM.floorCells[e(Math.random()*t.gM.floorCells.length-1)]),t.path=t.gM.bestPath(t,t.Tg),void 0!==t.path&&t.path.length<1&&(t.Tg=t.gM.floorCells[e(Math.random()*t.gM.floorCells.length-1)],t.path=t.gM.bestPath(t,t.Tg)))}}if(void 0!==t.path){var r=t.path[0];r&&(r.y<t.gy&&(t.nextDir="N"),r.x>t.gx&&(t.nextDir="E"),r.y>t.gy&&(t.nextDir="S"),r.x<t.gx&&(t.nextDir="W"),1!==Math.abs(t.gx-r.x)&&(0===t.gx&&(t.nextDir="W"),22===t.gx&&(t.nextDir="E")),t.path=void 0,t.GrMove())}},k.prototype.GrMove=function(t){function e(){f||("Pl"===i.type?(i.gM.Gr[l][s].Pl=null,i.gM.Gr[i.gy][i.gx].Pl=i,i.zIndex=3*i.gy+2):(i.gM.Gr[l][s].actors.splice(i.gM.Gr[l][s].actors.indexOf(i)),i.zIndex=3*i.gy+2)),f=!0}var i=this,n=function(t){return t},r=i.speed;if(i.moving||""===i.dir&&""===i.nextDir)("S"===i.dir&&"N"===i.nextDir||"N"===i.dir&&"S"===i.nextDir||"E"===i.dir&&"W"===i.nextDir||"W"===i.dir&&"E"===i.nextDir)&&(i.dir=i.nextDir);else{i.moving=!0,""===i.dir?(i.dir=i.nextDir,i.nextDir=""):i.dir!==i.nextDir&&""!==i.nextDir&&i.gM.checkSpace(i.gx+Y[i.nextDir].x,i.gy+Y[i.nextDir].y)&&(i.dir=i.nextDir);var o=Y[i.dir].x,a=Y[i.dir].y;if(i.gM.checkSpace(i.gx+o,i.gy+a)){i.lastDir=i.dir;var s=i.gx,l=i.gy,h=i.gx+o,c=i.gy+a;i.gx=i.gx+o,i.gy=i.gy+a,i.gx>22?(i.gx=0,i.portal="left"):i.gx<0?(i.gx=22,i.portal="right"):i.portal="","Pl"===i.type&&ce.aV(i,"yOff",0,ue/8,function(t){return Math.sin(t*Math.PI)},pe),ce.movePiece(i,h*ue,c*ue,r,n,function(){if(i.moving=!1,e(),i.x=i.gx*ue,i.y=i.gy*ue,"Pl"===i.type){var n=i.gM.Gr[i.gy][i.gx].ground;!i.gM.lVc&&n&&(n.lit||(v(0,z.lights),i.gM.score+=10,n.fadeIn(),n.lit=!0,i.gM.litTiles.push(n)),n.litTime="P"===i.gM.pS?(new Date).getTime():i.gM.steps),i.gM.lVc&&11===i.gM.Pl.gx&&6===i.gM.Pl.gy&&(i.gM.nXl=!0)}t&&t()}),(o>0||a>0)&&i.gx===h&&e();var f=!1}else i.dir="",i.moving=!1}},G.prototype.render=function(t){if(t.save(),t.lineWidth=4,this.A<1&&(t.globalAlpha=this.A),this.visible)switch(this.type){case"laser":this.Tg&&B[this.type](t,this.x,this.y,this.Tg.x*ue+ue/2,this.Tg.y*ue+ue/4);break;case"proxy":B[this.type](t,this.x,this.y,this.radius*ue)}t.restore()};var Z={tW:[["b"],["m",.2,1],["l",.25,.3],["bt",.25,.24,.7,.24,.75,.3],["l",.8,1]],brick:[["b"],["m",.1,.25],["bt",.3,.11,.8,.11,.9,.2],["bt",1,.3,1,.8,.9,.9],["bt",.8,.8,.1,.8,.1,.95],["bt",0,.8,0,.2,.1,.25]],crown:[["b"],["m",.15,.28],["l",.16,.1],["q",.16,.07,.24,.05],["l",.24,.1],["q",.29,.08,.34,.073],["l",.34,.03],["q",.39,.01,.45,.015],["l",.45,.055],["q",.5,.05,.55,.055],["l",.55,.015],["q",.61,.01,.66,.03],["l",.66,.073],["q",.71,.08,.76,.1],["l",.76,.05],["q",.84,.07,.84,.1],["l",.85,.28],["bt",.85,.39,.15,.39,.15,.28]],ellipse:[["b"],["m",.17,.285],["bt",.17,.19,.83,.19,.83,.285],["bt",.83,.37,.17,.37,.17,.285]],cloud:[["b"],["m",.3,1],["bt",0,.3,1,.3,.7,1]],ghost:[["b"],["m",.05,1],["l",.05,.25],["bt",.05,-.3,.95,-.3,.95,.25],["l",.95,1],["l",.833,.85],["l",.667,1.1],["l",.5,.9],["l",.333,1.1],["l",.167,.85]],eye2:[["b"],["m",.1,.5],["bt",.1,.4,.45,.4,.45,.52],["bt",.45,.6,.1,.65,.1,.5]],eye3:[["b"],["m",.1,.48],["bt",.1,.4,.4,.38,.45,.53],["bt",.43,.63,.1,.65,.1,.48]],eye4:[["b"],["m",.1,.45],["bt",.15,.4,.45,.4,.45,.6],["bt",.3,.6,.1,.6,.1,.45]],eye5:[["b"],["m",.1,.4],["l",.4,.5],["bt",.4,.66,.1,.68,.1,.4]],hatW:[["b"],["m",0,.45],["l",.4,.4],["l",.9,.1],["l",.85,.6],["l",1,.9],["q",.7,1,.3,.7],["l",.45,.55],["l",.1,.6]],hatE:[["b"],["m",1,.45],["l",.6,.4],["l",.1,.1],["l",.15,.6],["l",0,.9],["q",.55,.95,1,.45]],hatD:[["b"],["m",0,.6],["l",.25,.5],["l",.5,.1],["l",.75,.5],["l",1,.6],["l",.9,.7],["l",.65,.55],["l",.72,.75],["q",.3,.8,0,.6]],hatU:[["b"],["m",0,.6],["l",.25,.45],["l",.5,.1],["l",.75,.45],["l",1,.6],["q",.5,1,0,.6]],cloakS:[["b"],["m",0,1],["bt",-.1,.9,0,.6,0,.5],["bt",.1,.4,.9,.5,1,.4],["bt",1,.6,.85,.8,1.1,1],["bt",.85,1.1,.1,1.1,0,1]],cloakD:[["b"],["m",-.1,1],["bt",.1,.9,.15,.2,0,.4],["bt",.1,.4,.35,.45,.45,.55],["l",.45,1.1],["bt",.45,1.15,0,1,0,1],["c"]],cloakU:[["b"],["m",-.1,1],["bt",.1,.9,.15,.2,0,.4],["bt",.1,.4,.35,.45,.5,.55],["bt",.65,.5,.9,.4,1,.4],["bt",.85,.2,.9,.9,1.1,1],["q",.5,1.2,-.1,1]],staff:[["b"],["m",.1,.7],["l",.6,.4],["bt",.6,.3,.9,.1,1,.2],["bt",1,.3,.3,.6,.2,.8],["q",-.12,.85,.1,.7]],staffShadow:[["b"],["m",.6,.4],["q",1.05,.18,.75,.275]],pacman:[["b"],["m",.5,.5],["l",.8,.4],["bt",.8,.1,.2,.1,.2,.5],["bt",.2,.9,.8,.9,.8,.6],["c"]],arrow:[["b"],["m",0,.75],["l",.8,.55],["l",.8,.45],["l",0,.25],["c"]],speaker:[["b"],["m",0,.7],["l",0,.3],["l",.3,.3],["l",.7,0],["q",1.1,.5,.7,1],["l",.3,.7],["c"]]},B={Pl:function(t,i,n,r,o){function a(e){t.save(),C("brown"),M(t,Z.staff,i,n-ue/4,1.5*r,e),t.fill(),I("rgba(0,0,0,0.5)"),t.lineWidth=ue/30,M(t,Z.staffShadow,i,n-ue/4,1.5*r,e),t.stroke(),t.restore()}switch(n-=o.yOff+ue/4,C("black"),t.beginPath(),t.arc(i+ue/2,n+.45*ue-e(ue/4),.95*r/2,0,2*Math.PI),t.fill(),B.eye(t,i,n,r,o),t.save(),C("blue"),I("gold"),t.lineWidth=ue/10,o.lastDir){case"E":M(t,Z.cloakS,i,n,.9*r,!0);break;case"W":a(!0),M(t,Z.cloakS,i+ue/20,n,.9*r);break;case"N":a(!0),M(t,Z.cloakU,i+ue/20,n,.9*r);break;case"S":M(t,Z.cloakD,i+ue/20,n,.9*r),t.fill(),t.stroke(),M(t,Z.cloakD,i-ue/20,n,.9*r,!0)}t.fill(),t.stroke(),("E"===o.lastDir||"S"===o.lastDir)&&a(),C("yellow");var s;switch(o.lastDir){case"E":M(t,Z.hatE,i-ue/4,n-.85*ue,1.5*r),t.fill(),s=t.createRadialGradient(i+.1*ue,n-.4*ue,0,i+.1*ue,n-.4*ue,r),M(t,Z.hatE,i-ue/4,n-.85*ue,1.5*r);break;case"W":M(t,Z.hatW,i-ue/4,n-.85*ue,1.5*r),t.fill(),s=t.createRadialGradient(i+.9*ue,n-.4*ue,0,i+.9*ue,n-.4*ue,r),M(t,Z.hatW,i-ue/4,n-.85*ue,1.5*r);break;case"N":M(t,Z.hatU,i-.28*ue,n-.85*ue,1.6*r),t.fill(),s=t.createRadialGradient(i+.5*ue,n-.38*ue,0,i+.5*ue,n-.38*ue,r),M(t,Z.hatU,i-.28*ue,n-.85*ue,1.6*r);break;case"S":M(t,Z.hatD,i-.28*ue,n-.95*ue,1.6*r),t.fill(),s=t.createRadialGradient(i+.5*ue,n-.4*ue,0,i+.5*ue,n-.4*ue,r),M(t,Z.hatD,i-.28*ue,n-.95*ue,1.6*r)}s.addColorStop(0,"rgba(0,0,0,0)"),s.addColorStop(.5,"rgba(0,0,0,0.4)"),s.addColorStop(1,"rgba(0,0,0,0)"),C(s),t.fill(),t.restore()},ghost:function(t,e,i,n,r){i-=r.yOff+ue/9,C(r.colour),M(t,Z.ghost,e,i,n),t.fill(),M(t,Z.ghost,e,i,n);var o=t.createRadialGradient(e+n/2,i,n/2,e+n/2,i+n,n/2);o.addColorStop(0,"rgba(0,0,0,0)"),o.addColorStop(1,"rgba(0,0,0,0.2)"),C(o),t.fill(),B.eye(t,e,i,n,r)},eye:function(t,e,i,n,r){var o="eye";switch(r.aiType){case"dumb":case void 0:o+=2;break;case"patrol":o+=3;break;case"follow":o+=4;break;case"cutOff":o+=5}switch(r.lastDir){case"N":break;case"E":C("white"),M(t,Z[o],e+ue/2,i-ue/4,n),t.fill(),C("black"),t.beginPath(),t.arc(e+4.8*ue/6,i+.25*ue,ue/15,0,2*Math.PI),t.fill();break;case"S":C("white"),M(t,Z[o],e,i-ue/4,n),t.fill(),M(t,Z[o],e,i-ue/4,n,!0),t.fill(),C("black"),t.beginPath(),t.arc(e+4.3*ue/6,i+.26*ue,ue/15,0,2*Math.PI),t.arc(e+1.7*ue/6,i+.26*ue,ue/15,0,2*Math.PI),t.fill();break;case"W":C("white"),M(t,Z[o],e-ue/2,i-ue/4,n,!0),t.fill(),C("black"),t.beginPath(),t.arc(e+1.2*ue/6,i+.25*ue,ue/15,0,2*Math.PI),t.fill()}},energy:function(t,i,n,r,o){r+=o.yOff;var a=t.createRadialGradient(i+ue/2,n+ue/2-e(ue/8),0,i+ue/2,n+ue/2-e(ue/8),.25*r);a.addColorStop(0,"rgba(255,255,255,1)"),a.addColorStop(1,"rgba(64,200,200,0)"),C(a),t.beginPath(),t.arc(i+ue/2,n+ue/2-e(ue/8),.3*r,0,2*Math.PI),t.fill()},laser:function(t,e,i,n,r){t.lineWidth=ue/3,I("rgba(64,200,200,0.5)"),t.beginPath(),t.moveTo(e,i),t.lineTo(n,r),t.stroke(),t.lineWidth=ue/6,I("turquoise"),t.stroke()},proxy:function(t,e,i,n){t.lineWidth=ue/6;var r=t.createRadialGradient(e+ue/2,i+ue/4,ue/3,e+ue/2,i+ue/4,ue);r.addColorStop(0,"rgba(255,255,255,0)"),r.addColorStop(1,"rgba(64,200,200,1)"),C(r),I("turquoise"),t.beginPath(),t.arc(e+ue/2,i+ue/4,n,0,2*Math.PI),t.stroke(),t.fill()},wall:function(t,i,n,r){if(C(he),t.fillRect(i,n-e(ue/2),r,r+e(ue/2)),le)C("rgba(0,0,0,0.2)");else{var o=t.createLinearGradient(i,n,i,n+r);o.addColorStop(0,"rgba(0,0,0,0.2)"),o.addColorStop(1,"rgba(0,0,0,0.6)"),C(o)}t.fillRect(i,n,r,r)},wall2:function(t,i,n,r){C(he),t.fillRect(i,n-e(ue/2),r,r)},stairs:function(t,e,i,n){C(he),t.fillRect(e,i-n/6,n,n+n/6),C("rgba(0,0,0,0.2)"),t.fillRect(e,i+n/6,n,n/6),t.fillRect(e,i+3*(n/6),n,n/6),t.fillRect(e,i+5*(n/6),n,n/6)},floor:function(t,e,i,n,r){if(C(r.Colour()),t.fillRect(e,i,n,n),!le){var o=t.createRadialGradient(e+n/2,i+n/2,0,e+n/2,i+n/2,n/1.1);o.addColorStop(1,"rgba(0,0,0,0.2)"),o.addColorStop(0,"rgba(0,0,0,0)"),C(o),t.fillRect(e,i,n,n)}},tW:function(t,e,i,n){I("rgba(0,0,0,0.7)"),C("darkslategray"),M(t,Z.crown,e,i,n),t.fill(),t.stroke(),t.save(),t.globalAlpha=.2,C("black"),M(t,Z.ellipse,e,i,n),t.fill(),t.restore(),C("darkslategray"),M(t,Z.tW,e,i,n),t.fill(),t.stroke()},cloud:function(t,e,i,n){M(t,Z.cloud,e,i,n);var r=t.createRadialGradient(e+n/2,i+.8*n,0,e+n/2,i+.8*n,n/4);r.addColorStop(0,"rgba(170,170,170,1)"),r.addColorStop(.7,"rgba(180,180,180,0.7)"),r.addColorStop(1,"rgba(255,255,255,0.0)"),C(r),t.fill()},pacman:function(t,e,i,n){C("yellow"),t.lineWidth=.1*ue,I("steelblue"),M(t,Z.pacman,e,i,n),t.fill(),t.stroke()}},K=[[[0,0,0],[0,1,0],[0,0,0]],[[0,1,0],[0,1,0],[0,0,0]],[[0,0,0],[1,1,1],[0,0,0]],[[0,1,0],[0,1,1],[0,0,0]],[[0,1,0],[1,1,1],[0,0,0]],[[0,1,0],[1,1,1],[0,1,0]],[[1,0,0],[1,1,1],[0,0,0]],[[0,0,0],[1,1,1],[1,0,0]],[[0,0,0],[0,1,1],[1,1,0]],[[0,0,0],[1,1,0],[0,1,1]]],J=[K[0],K[1],A(K[1],1),A(K[1],2),A(K[1],3),K[2],A(K[2],1),K[3],A(K[3],1),A(K[3],2),A(K[3],3),K[4],A(K[4],1),A(K[4],2),A(K[4],3),K[6],A(K[6],1),A(K[6],2),A(K[6],3),K[7],A(K[7],1),A(K[7],2),A(K[7],3),K[8],A(K[8],1),A(K[8],2),A(K[8],3),K[9],A(K[9],1),A(K[9],2),A(K[9],3),K[5]],j={"0000":0,1000:1,"0001":2,"0010":3,"0100":4,"0101":5,1010:6,1100:7,1001:8,"0011":9,"0110":10,1101:11,1011:12,"0111":13,1110:14,1111:31};E.prototype.makeMap=function(){function t(t,e){m+=void 0!==Gr[e]&&void 0!==Gr[e][t]&&Gr[e][t]===x?1:0}for(Gr=n(6,6),this.copyNumber=2,this.done=!1,map=n(21,13),Gr[5][3]=1;!this.done;){for(var e=J[s(5,31,!0)],i={score:0},r=-2,o=Gr[0].length;o>r;r++)for(var a=0;4>a;a++)for(var l=A(e,a),h=0,c=Gr[0].length;c>h;h++){for(var f=!0,u=0,g=0,p=l.length;p>g;g++)if(void 0!==Gr[h+g])for(var d=0,v=l[0].length;v>d;d++)1===l[g][d]&&(0!==Gr[h+g][r+d]?f=!1:u+=g+h);f&&u>i.score&&(i={score:u,x:r,y:h,r:a})}if(i.score>0){for(var l=A(e,i.r),g=0;3>g;g++)if(void 0!==Gr[g+i.y])for(var d=0;3>d;d++)void 0!==Gr[g+i.y][d+i.x]&&1===l[g][d]&&(Gr[g+i.y][d+i.x]=this.copyNumber);this.copyNumber++}else this.done=!0}Gr.splice(0,1);for(var g=Gr.length-1;g>=0;g--){Gr.push([]);for(var y=0,b=Gr[g].length;b>y;y++)Gr[Gr.length-1].push(10*Gr[g][y]),1===Gr[g][y]&&(Gr[Gr.length-1][y]=1)}Gr=A(Gr,1);for(var g=0,p=Gr.length;p>g;g++)for(var d=0,v=Gr[0].length;v>d;d++){var x=Gr[g][d];if(x>0){var m="";t(d,g-1),t(d+1,g),t(d,g+1),t(d-1,g);for(var e=J[j[m]],h=0,c=3;c>h;h++)for(var r=0,o=3;o>r;r++)map[2*g+h][2*d+r]=1===e[h][r]?0:1}}for(var y=0,b=map.length;b>y;y++)map[y].unshift(0),map[y].push(0);for(var w=[],y=0,b=map[0].length;b>y;y++)w.push(0);map.unshift(w),map.push(w);for(var T=[],y=2,b=map.length-2;b>y;y++)0!==map[y][1]&&T.push(y);var P=T[s(0,T.length-1,!0)];map[P][0]=1,map[P][map[0].length-1]=1;for(var S=[],k=[],g=0;4>g;g++)for(var d=0;4>d;d++)1===map[g][d]&&S.push({x:d,y:g}),1===map[map.length-1-g][d]&&k.push({x:d,y:map.length-1-g});var G=(s(0,k.length-1,!0),S[s(0,S.length-1,!0)]),M=k[s(0,k.length-1,!0)];return{Pt:[{x:0,y:P,to:{x:map[0].length-1,y:P}},{x:map[0].length-1,y:P,to:{x:0,y:P}}],eLocs:[{x:G.x,y:G.y,gx:G.x,gy:G.y},{x:M.x,y:M.y,gx:M.x,gy:M.y}],map:map}},R.prototype.init=function(t){var e=this;if(he=g(a(0,1),.9,.4,1),t&&(U=t),e.PAUSED=!0,e.lVc=!1,e.nXl=!1,e.GAME_OVER=!1,e.steps=0,e.finishPath=[],e.sprites=[],e.energyPellets=[],e.charges=0,e.heap=new w(function(t){return t.zIndex}),e.PAUSED=!0,X(2e3,"out",function(){e.PAUSED=!1}),e.mapMaker=new E,e.Map=e.mapMaker.makeMap(19,13),e.map=e.Map.map,e.Pt=e.Map.Pt,e.eLocs=e.Map.eLocs,e.litTiles=[],e.WAIT=1,e.MOVE=2,e.state=1,e.buildGrid(e.map)){e.centreTile=e.Gr[6][11].walls,e.Pl=fe.nX(),e.Pl.init(e,11,7,"Pl"),e.Pl.nextDir="E",e.lastEnemy=(new Date).getTime(),e.enemyPeriod=1e4,e.ghostTypes=[{colour:"pink",type:"dumb"},{colour:"blue",type:"patrol"},{colour:"green",type:"follow"},{colour:"orange",type:"cutOff"}],e.ghosts=[],e.addEnemy();for(var i=0,n=e.eLocs.length;n>i;i++){var r=e.eLocs[i],o=fe.nX();o.init(e,r.x,r.y,"energy"),o.zIndex=3*r.y+1,ce.aV(o,"yOff",0,ue/10,function(t){return t*t*(3-2*t)},400,void 0,"pingpong"),e.energyPellets.push(o),e.sprites.push(o)}for(var i=0,n=e.eLocs.length;n>i;i++){var r=e.eLocs[i],o=fe.nX();o.init(e,e.Gr[0].length-1-r.x,r.y,"energy"),o.zIndex=3*r.y+1,e.eLocs.push({x:e.Gr[0].length-1-r.x,y:r.y,gx:e.Gr[0].length-1-r.x,gy:r.y}),ce.aV(o,"yOff",0,ue/10,function(t){return t*t*(3-2*t)},400,void 0,"pingpong"),e.sprites.push(o),e.energyPellets.push(o)}}},R.prototype.fireWp=function(t){var e=this;e.weapon=new G;var i=e.weapon,n=e.Pl;e.sprites.push(i);var r=[];if(e.charges>0&&!i.FIRING){switch(i.FIRING=!0,v(0,z.sS),i.visible=!0,i.type=t,i.zIndex=n.zIndex,t){case"laser":var o={x:0,y:0,w:0,h:0};switch(n.lastDir){case"N":o.x=n.x,o.w=ue;for(var a=1,s=n.gy+1;s>a;a++){if(1!==e.map[n.gy-a][n.gx]){o.y=n.y-o.h,i.Tg={x:n.gx,y:n.gy-a};break}o.h+=ue}break;case"E":o.x=n.x,o.y=n.y,o.h=ue;for(var a=1,s=e.map[0].length-n.gx;s>a;a++){if(1!==e.map[n.gy][n.gx+a]){i.Tg={x:n.gx+a,y:n.gy};break}o.w+=ue}break;case"S":o.x=n.x,o.y=n.y,o.w=ue;for(var a=1,s=e.map.length-n.gy;s>a;a++){if(1!==e.map[n.gy+a][n.gx]){i.zIndex=3*(n.gy+a)-2,i.Tg={x:n.gx,y:n.gy+a};break}o.h+=ue}break;case"W":o.y=n.y,o.h=ue;for(var a=1,s=n.gx+1;s>a;a++){if(1!==e.map[n.gy][n.gx-a]){o.x=n.x-o.w,i.Tg={x:n.gx-a,y:n.gy};break}o.w+=ue}}i.x=n.x+ue/2,i.y=n.y+ue/4;for(var a in e.ghosts)e.ghosts[a]&&h(o,e.ghosts[a])&&r.push(e.ghosts[a]);X(300,"out",function(){i.visible=!1,i.FIRING=!1},i);break;case"proxy":for(var a in e.ghosts)f({x:n.x,y:n.y},e.ghosts[a])<2.5*ue&&r.push(e.ghosts[a]);i.x=n.x,i.y=n.y,i.zIndex=n.zIndex,ce.aV(i,"radius",.1,2.5,function(t){return t*t*(3-2*t)},300,function(){}),X(300,"out",function(){i.visible=!1,i.FIRING=!1},i)}for(var a in r){e.score+=100;var l=r[a];l.dead=!0,e.removeEnemy(l)}e.charges-=1}},R.prototype.addEnemy=function(){var t=this;if(t.ghostTypes.length>0){var e=t.ghostTypes.splice(0,1)[0],i=e.type,n=g(a(0,1),.8,.55,.85),e=fe.nX();e.init(t,11,5,"ghost"),e.path=t.bestPath(e,t.Pl),e.aiType=i,e.colour=n,e.A=0;var r=t;e.speed=1.3*pe,X(700,"in",function(){r.ghosts.push(e)},e),ce.aV(e,"yOff",0,ue/8,function(t){return t*t*(3-2*t)},400,void 0,"pingpong")}},R.prototype.removeEnemy=function(t){var e=this;for(var i in e.ghosts){var n=e.ghosts[i];t.aiType===n.aiType&&(e.lVc||e.ghostTypes.push({type:t.aiType,colour:t.colour}),X(700,"out",function(){var e=t.gM.Gr[t.gy][t.gx].actors;e.splice(e.indexOf(t),1),t.visible=!1},t),e.ghosts.splice(e.ghosts.indexOf(t),1))}},R.prototype.buildGrid=function(){var t=this;t.Gr=[],t.floorCells=[];for(var e=0,i=t.map.length;i>e;e++){t.Gr.push([]);for(var n=0,r=t.map[0].length;r>n;n++){var o={stairs:null,ground:null,Pl:null,actors:[],walls:null};if(0===t.map[e][n]){if(6===e&&11===n){var a=fe.nX();a.init(t,n,e,"stairs"),a.gx=n,a.gy=e,a.zIndex=3*e,a.visible=!1,t.stairs=a}var s=fe.nX();s.init(t,n,e,"wall"),"R"===t.pS&&(s.A=0),void 0!==t.map[e+1]&&0===t.map[e+1][n]&&(s.type="wall2"),s.zIndex=3*e,o.walls=s}if(1===t.map[e][n]){var l=fe.nX();l.init(t,n,e,"floor"),"R"===t.pS&&(l.A=0),l.lit=!1,l.litTime=null,l.gx=n,l.gy=e,o.ground=l,t.floorCells.push(l),l.zIndex=3*e}t.Gr[e].push(o)}}return t.floorTileCount=t.floorCells.length,!0},R.prototype.update=function(){function t(){if(e.lVc){e.finishPath=e.bestPath(e.Pl,e.centreTile);
for(var t=e.litTiles.length-1;t>=0;t--){var i=e.litTiles[t];i.light=!1}if(e.finishPath.length>0)for(var t=0,n=e.finishPath.length;n>t;t++){var r=e.finishPath[t],i=e.Gr[r.y][r.x].ground;i&&(i.light=!0,e.litTiles.push(i))}for(var t=e.litTiles.length-1;t>=0;t--){var i=e.litTiles[t];i.light&&!i.lit?i.fadeIn():!i.light&&i.lit?i.fadeOut():i.light&&i.lit?i.fading||(i.H=.67,i.S=.2,i.L=.7,i.lit=!0):i.light||i.lit||i.fading||(i.H=.33,i.S=.03,i.L=.2,i.lit=!1)}}}var e=this;if(!e.lVc&&e.litTiles.length===e.floorTileCount&&!e.lVc){v(0,z.lv),e.score+=1e4,e.stairs.visible=!0,e.sprites.push(e.stairs);for(var i=e.ghosts.length-1;i>=0;i--)e.removeEnemy(e.ghosts[i]);setTimeout(function(){for(var t in e.litTiles){var i=e.litTiles[t];i.H=.67,i.S=.7,i.L=.2}e.litTiles=[]},500),e.lVc=!0,e.centreTile.visible=!1,e.Gr[e.centreTile.gy][e.centreTile.gx].walls=null,e.map[e.centreTile.gy][e.centreTile.gx]=1}if(e.lVc&&e.nXl&&(e.lVc=!1,e.nXl=!1,e.PAUSED=!0,setTimeout(function(){X("2000","in",function(){for(var t in e.sprites)fe.free(e.sprites[t]);e.init()})},500)),!e.PAUSED){if("R"===e.pS)for(var i in e.ghosts){var n=e.ghosts[i],r=n.vis?"in":"out";(1===n.A&&"out"===r||0===n.A&&"in"===r)&&X(200,r,void 0,n)}e.tX.score.tX="SCORE: "+e.score,e.tX.charges.tX="CHARGES: "+e.charges;for(var i in e.ghosts){var o=e.ghosts[i];o&&h(e.Pl,o,ge)&&(e.charges>0?e.fireWp("proxy"):e.gO())}var a=[];for(var i in e.energyPellets){var s=e.energyPellets[i];f({x:s.x,y:s.y},e.Pl)<ue&&(v(0,z.powerUp),e.charges+=1,a.push(s),s.visible=!1)}for(var i in a)e.energyPellets.splice(e.energyPellets.indexOf(a[i]),1);if(e.READY){"R"===e.pS&&(e.READY=!1),!e.lVc&&(e.ghostTypes.length>0&&"P"===e.pS&&(new Date).getTime()>e.lastEnemy+e.enemyPeriod||"R"===e.pS&&e.steps%40===39)&&(e.lastEnemy=(new Date).getTime(),e.addEnemy()),e.Pl.GrMove(t);for(var i in e.ghosts)e.ghosts[i].AI();for(var i=e.sprites.length-1;i>=0;i--)e.sprites[i].visible||e.sprites.splice(i,1)}}},R.prototype.gO=function(){var t=this;v(0,z.death),t.GAME_OVER=!0,ce.eA=[],t.ghosts=[],t.score>localStorage.WIZARD_TOWER_HIGH_SCORE?(localStorage.WIZARD_TOWER_HIGH_SCORE=t.score,$=t.score,t.tX.highScore.tX="HIGH SCORE: "+$,t.tX.cG.A=0,t.tX.cG.visible=!0,X(1e3,"in",null,t.tX.cG),t.tX.cG2.A=0,t.tX.cG2.visible=!0,X(1e3,"in",null,t.tX.cG2)):(t.tX.gO.visible=!0,X(1e3,"in",null,t.tX.gO)),t.PAUSED=!0,setTimeout(function(){X("2000","in",N)},2e3)},R.prototype.checkSpace=function(t,e){return void 0===this.Gr[e][t]?!0:void 0!==this.Gr[e]&&void 0!==this.Gr[e][t]&&null===this.Gr[e][t].walls?!0:void 0},R.prototype.bestPath=function(t,e,i){var n=i||this.map;if(void 0!==t&&void 0!==e){var r={diagonal:!1,Pt:this.Pt},o=new x(n,r),a=o.Gr[t.gy][t.gx],s=o.Gr[e.gy][e.gx],l=_.search(o,a,s,r);return l}},R.prototype.isVisible=function(t){for(var i=e(t.x/ue),n=e(t.y/ue),r=u(i,n,this.Pl.gx,this.Pl.gy),o=1,a=r.length;a>o;o++)if(0===this.map[r[o].y][r[o].x])return"ghost"===t.type&&(t.vis=!1),!1;return"ghost"===t.type?t.vis=!0:t.A<1-(o-2)/10&&(t.A=1-(o-2)/10),t.seen=!0,!0},R.prototype.render=function(t){t.save(),t.translate(de,ve),t.beginPath(),t.rect(0,-ue,23*ue,16*ue),t.clip();for(n in this.sprites){var i=this.sprites[n];"R"===this.pS?(this.isVisible(i),i.seen&&this.heap.push(i)):this.heap.push(i)}for(var n=0,r=this.heap.size();r>n;n++)this.heap.pop().render(t);for(var n in this.tX)this.tX[n].render(t);if(t.restore(),!this.GAME_OVER){t.save();for(var n=0,r=this.bTs.length;r>n;n++){var o=this.bTs[n];C("rgba(255,255,255,0.1)"),t.lineWidth=4,I("rgba(255,255,255,0.2)"),t.strokeRect(o.x,o.y,o.w,o.h),t.fillRect(o.x,o.y,o.w,o.h)}t.restore()}t.fontWeight="bold",t.font=e(.75*ue)+"px 'arial black','avenirnext-bold','droid sans'",C("darkslategray"),t.fillText("x",this.exit.x,this.exit.y+.6*ue)},D.prototype.update=function(){},D.prototype.render=function(t){t.save();var e=t.createLinearGradient(0,0,0,1.1*this.Cn.height);if(e.addColorStop(1,"black"),e.addColorStop(0,"midnightblue"),C(e),t.fillRect(0,0,this.Cn.width,this.Cn.height),this.oriented){t.font=2.4*ue+"px 'arial black','avenirnext-bold','droid sans'",C("red");var i="WIZARD  TOWER!",n=this.Cn.width/2-t.measureText(i).width/2;t.fillText(i,n,this.Cn.height/4),t.lineWidth=.1*ue,I("orange"),t.strokeText(i,n,this.Cn.height/4);for(var r in this.backClouds)this.backClouds[r].render(t);I("steelblue"),C("yellow"),t.font=4*ue+"px 'arial black','avenirnext-bold','droid sans'",t.fillText("@",17.5*ue,10*ue),t.strokeText("@",17.5*ue,10*ue),this.pacman.render(t),this.tW.render(t);for(var r in this.clouds)this.clouds[r].render(t);C("rgba(200,0,0,1)"),t.font=ue+"px 'arial black','avenirnext-bold','droid sans'",t.textAlign="middle",t.fillText("A Rogue/Pac-like",7.3*ue,13*ue),t.font=.75*ue+"px 'arial black','avenirnext-bold','droid sans'",t.fillText("JS13K 2015, KeithK",7.8*ue,14*ue),C("black"),t.font=.75*ue+"px 'arial black','avenirnext-bold','droid sans'",t.fillText("Seed: "+H,1.5*ue,13.5*ue),C("black"),I(M(t,Z.arrow,3.5*ue,13.5*ue,2*ue)),t.fill(),t.stroke(),M(t,Z.arrow,1.5*ue,13.5*ue,2*ue,!0),t.fill(),t.stroke(),I("slategray"),I("cyan"),M(t,Z.speaker,21.5*ue,13.5*ue,2*ue),t.stroke()}else{t.font=ue+"px futura",C("red"),t.textAlign="center";var i="Please rotate your device",n=this.Cn.width/2;p(t,i,n,this.Cn.height/4,.8*this.Cn.width,ue)}I("rgba(255,255,255,0.6)"),t.restore()},window.AudioContext=window.AudioContext||window.webkitAudioContext;var Q=new AudioContext;void 0===localStorage.WIZARD_TOWER_HIGH_SCORE&&(localStorage.WIZARD_TOWER_HIGH_SCORE=0);var $=localStorage.WIZARD_TOWER_HIGH_SCORE,te=document.createElement("canvas"),ee=window.innerHeight,ie=window.innerWidth,ne=ee/480,re=ie/720;scl=re>ne?ne:re,te.height=480*scl,te.width=720*scl;var oe=(ie-te.width)/2,ae=(ee-te.height)/2;te.style.margin=ae+"px "+oe+"px",document.body.appendChild(te);var se=te.getContext("2d");addEventListener("orientationchange",O,!1);var le=!1;"undefined"!=typeof orientation&&(le=!0,window.top.scrollTo(0,1));var he,ce=new P,fe=new t(k),ue=e(Math.ceil(te.height/16)),ge=.2,pe=250,de=(te.width-23*ue)/2,ve=e(.75*(te.height-15*ue)),ye=localStorage.MUTE;ye=void 0===ye?1:parseInt(ye);var be=0,xe=1,me=0,we=new F;we.rG("touch",0,function(){},function(){},function(){});var Te=null,Pe=null;q()}();</script>
</body>
</html>