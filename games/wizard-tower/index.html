<!doctype html><title>Wizard Tower</title><style>body,html{background-color:#000}</style><body style=padding:0;margin:0><script>!function(){function t(t){this.o=t,this.uPl=[],this.fPl=[]}function e(t){return Math.floor(t)}function n(t,e){var i,n,r=[];for(n=0;e>n;n++)for(r.push([]),i=0;t>i;i++)r[n].push(0);return r}function o(t){for(var e=[],i=0,n=t.length;n>i;i++){e.push([]);for(var r=0,o=t[0].length;o>r;r++)e[i][r]=t[i][r]}return e}function a(t,i,n){var r=Math.random()*(i-t)+t;return n?e(r):r}function s(t,i,n){var r=function(){var t=Math.sin(W++)*(1e4+O);return t-e(t)}()*(i-t)+t;return n?e(r):r}function l(t,e,i){var n=i||0;return e.x<t.x+t.w-t.w*n&&e.y<t.y+t.h-t.h*n&&e.x+e.w>t.x+t.w*n&&e.y+e.h>t.y+t.w*n}function h(t,e){return e.x>t.x&&e.x<t.x+t.w&&e.y>t.y&&e.y<t.y+t.h||void 0}function c(t,e){return Math.sqrt(void 0!==t.gx?(e.gx-t.gx)*(e.gx-t.gx)+(e.gy-t.gy)*(e.gy-t.gy):(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y))}function f(t,i,n,r){function o(t,e,i){return 0>i&&(i+=1),i>1&&(i-=1),1/6>i?t+6*(e-t)*i:.5>i?e:2/3>i?t+(e-t)*(2/3-i)*6:t}var a,s,l,h="rgb";if(0==i)a=s=l=n;else{var c=.5>n?n*(1+i):n+i-n*i,f=2*n-c;a=e(255*o(f,c,t+1/3)),s=e(255*o(f,c,t)),l=e(255*o(f,c,t-1/3))}return r&&(h+="a"),h+="("+a+","+s+","+l,r&&(h+=","+r),h+")"}function u(t,e,i,n,r,o){for(var a=e.split(" "),s="",l=0;l<a.length;l++){var h=s+a[l]+" ";t.measureText(h).width>r&&l>0?(t.fillText(s,i,n),s=a[l]+" ",n+=o):s=h}t.fillText(s,i,n)}function g(t,e){function i(t,e){var i=this;i.type=t,i.frequency=e,i.gain=F.createGain(),i.oscillator=F.createOscillator(),i.oscillator.frequency.value=e,i.oscillator.type=t,i.play=function(t,e,n,r){i.d=t,i.V=r||1,i.D=n||1,i.oscillator.connect(i.gain),i.gain.gain.value=r,i.gain.connect(t),i.oscillator.start(F.currentTime+e),i.oscillator.stop(F.currentTime+n)},i.stop=function(t){t=t||0;i.oscillator.stop(t)}}function n(t,e,i,n,r){t.linearRampToValueAtTime(e,F.currentTime+n),t.linearRampToValueAtTime(i,F.currentTime+n+r)}if(0!==ct){t=t+e[0]||0;var r=e[1]||0,o=e[2]||1,a=e[3]||0,s=e[4]||0,l=(e[5],e[6]||0),h=e[7]||0,c=e[8]||220,f=e[9]||0,u=e[10]||"sine",g=e[11]||1,p=e[12]||2e4,d=e[13]||0,v=e[14]||0,y=e[15]||0,b=(F.createOscillator(),F.createBiquadFilter()),x=F.createBiquadFilter();b.connect(x),b.type="lowpass",b.frequency.value=p,n(b.frequency,p,p+d,t,r+a+s),x.connect(F.destination),x.type="highpass",x.frequency.value=v,n(x.frequency,v,v+y,t,r+a+s),osc=new i(u,c),osc.play(b,t,t+r+a+s,1),l>0&&new i("sawtooth",l).play(osc.oscillator.frequency,t,t+r+a+s,h),r>0?(osc.gain.gain=0,n(osc.gain.gain,0,g,t,r)):osc.gain.gain=g,a>0?(n(osc.gain.gain,g,o,t+r,a),n(osc.gain.gain,o,0,t+r+a,s)):s>0&&n(osc.gain.gain,g,0,t+r,s),0!==f&&function(e){var i=e.frequency.value;e.frequency.linearRampToValueAtTime(i,F.currentTime+t),e.frequency.linearRampToValueAtTime(i+f,F.currentTime+t+r+a+s)}(osc.oscillator)}}function p(t){for(var e=t,i=[];e.pr;)i.push(e),e=e.pr;return i.reverse()}function d(t,e){var i=this;i.oP=e||{},i.Nds=[],i.Gr=[];for(var n=0,r=t.length;r>n;n++){for(var o=[],a=0,s=t[0].length;s>a;a++){var l=new v(a,n,t[n][a]);o.push(l),i.Nds.push(l)}i.Gr.push(o)}i.init()}function v(t,e,i){this.x=t,this.y=e,this.w=i}function y(t){this.content=[],this.sF=t}function b(t){var e=[],n=t.touches;for(i in 0===n.length&&(n=t.changedTouches),n)void 0!==n[i].identifier&&e.push({x:n[i].pageX-Q,y:n[i].pageY-$,id:n[i].identifier});return e}function x(){this.eA=[],this.aNms=[],this.toRemove=[]}function m(t,e,i,n,r,o){var a=this;a.tX=t,a.x=e,a.y=i,a.colour=o||"rgb(30,30,30)",a.A=1,a.textAlign=r||"left",a.font=.75*ot+"px 'avenirnext-bold','droid sans'",a.lineWidth=n,a.strokeStyle="white",a.visible=!0,a.w=0,a.lh=0}function w(){}function T(t){var e=this;e.gM=t,e.visible=!1,e.A=1,e.type="",e.x=0,e.y=0,e.Tg=null,e.FIRING=!1}function P(t,e,i,n,r,o){for(var a in void 0===r&&(r=4),t.save(),t.translate(i,n),o&&(t.translate(ot,0),t.scale(-1,1),i*=-1),e){var s=e[a];switch(s[0]){case"b":t.beginPath();break;case"c":t.closePath();break;case"m":t.moveTo(s[1]*r,s[2]*r);break;case"l":t.lineTo(s[1]*r,s[2]*r);break;case"a":t.arc(s[1]*r,s[2]*r,s[3]*r,s[4],s[5],s[6]);break;case"at":t.arcTo(s[1]*r,s[2]*r,s[3]*r,s[4]*r,s[5]*r);break;case"q":t.quadraticCurveTo(s[1]*r,s[2]*r,s[3]*r,s[4]*r);break;case"bt":t.bezierCurveTo(s[1]*r,s[2]*r,s[3]*r,s[4]*r,s[5]*r,s[6]*r)}}t.restore()}function S(){}function k(t,e){var i,n,a,s=o(t);for(r=[],i=0;e>i;i++){for(a in r=[],s[0])for(n in r.push([]),s)r[a].push(s[n][s[0].length-a-1]);s=o(r)}return s}function G(t,e){function i(t){("P"===n.pS||"R"===n.pS&&!n.Pl.moving)&&(n.Pl.nextDir=t,n.READY=!0,n.steps++)}var n=this;n.Cn=t,n.pS=e,n.score=0;var r={};r.score=new m("SCORE: ",.25*ot,.5*ot,ot/40),r.highScore=new m("HIGH SCORE: "+Y,22.5*ot,.5*ot,ot/40,"right"),r.charges=new m("CHARGES: ",.25*ot,14.5*ot,ot/40),r.gO=new m("GAME OVER!",11.5*ot,n.Cn.height/2,ot/40,"center","rgb(60,60,60)"),r.gO.font=2*ot+"px 'avenirnext-bold','droid sans'",r.gO.visible=!1,r.gO.A=0,r.cG=new m("Congratulations!",11.5*ot,6.5*ot,ot/40,"center","rgb(60,60,60)"),r.cG.font=2*ot+"px 'avenirnext-bolditalic','droid sans'",r.cG.visible=!1,r.cG2=new m("You've beat you're high score!",11.5*ot,8.5*ot,ot/40,"center","rgb(60,60,60)"),r.cG2.font=ot+"px 'avenirnext-bold','droid sans'",r.cG2.w=16*ot,r.cG2.lh=ot,r.cG2.visible=!1,n.tX=r,n.init(1),n.steps=0,n.READY="P"===e,bTs=[];var o=t.width,a=t.height;for(var s in n.exit={x:o-.75*ot,y:0,w:.75*ot,h:.75*ot,down:function(){C()}},bTs.push(n.exit),n.bTs=[],n.bTs.push({x:0,y:0,w:.2*o,h:a,down:function(){i("W")},held:function(){i("W")}}),n.bTs.push({x:.2*o,y:0,w:.6*o,h:.2*o,down:function(){i("N")},held:function(){i("N")}}),n.bTs.push({x:.2*o,y:a-.2*o,w:.6*o,h:.2*o,down:function(){i("S")},held:function(){i("S")}}),n.bTs.push({x:o-.2*o,y:0,w:.2*o,h:a,down:function(){i("E")},held:function(){i("E")}}),n.bTs.push({x:.2*o,y:.2*o,w:.6*o,h:a-.4*o,down:function(){n.fireWp("laser")}}),n.bTs)bTs.push(n.bTs[s])}function M(t){this.Cn=t,1===ct&&function(t,e){for(var i=0,n=t.length;n>i;i++){var r=t[i];if(void 0!==r){var o=V[r.sfx];for(var a in r)"time"!==a&&"sfx"!==a&&(o[a]=r[a]);g(void 0!==e?e*i:r.time,o)}}}([{sfx:"Sn",8:220},{sfx:"Sn",8:440},{sfx:"Sn",8:392},{sfx:"Sn",8:349.23},{sfx:"Sn",8:311.13,3:2}],.9),this.tW=rt.nX(),this.tW.init(null,5.5,3.5,"tW",13),this.clouds=[],this.backClouds=[],this.pacman=rt.nX(),this.pacman.init(null,2,6,"pacman",5.5);for(var e=0;16>e;e++){var i=a(1,9,!0),n=13+i;e>8&&(n=11+(i=a(5,13,!0)));var r=rt.nX();r.init(null,e%8*6-10,6-i,"cloud",n),i=a(5,10),nt.aV(r,"x",r.x,r.x+ot,(function(t){return t*t*(3-2*t)}),1e3*i,void 0,"pingpong"),8>e?this.clouds.push(r):this.backClouds.push(r)}this.oriented=!et||90===orientation,this.oriented||addEventListener("orientationchange",(function(){90===orientation&&location.reload()}),!1);var o=t.width,s=t.height;bTs=[],bTs.push({x:o/10,y:s/2.5,w:o/5,h:o/5,down:function(){I(300,"in",(function(){D("P")}))}}),bTs.push({x:o/10*7,y:s/2.5,w:o/5,h:o/5,down:function(){I(300,"in",(function(){D("R")}))}}),bTs.push({x:0,y:s-o/8,w:o/8,h:o/8,time:0,down:function(){this.time=(new Date).getTime(),O>1&&(O-=1),localStorage.SEED=O},held:function(){(new Date).getTime()>this.time+200&&(O>11?O-=10:O=1),localStorage.SEED=O}}),bTs.push({x:o/8,y:s-o/8,w:o/8,h:o/8,time:0,down:function(){this.time=(new Date).getTime(),O+=1,localStorage.SEED=O},held:function(){(new Date).getTime()>this.time+200&&(O+=10),localStorage.SEED=O}}),bTs.push({x:o/8*7,y:s-o/8,w:o/8,h:o/8,down:R}),I(300,"out")}function E(t){tt.fillStyle=t}function A(t){tt.strokeStyle=t}function R(){ct=0===ct?1:0,localStorage.MUTE=ct}function D(t){vt=new G(Z,t),gt=ut,dt=null}function C(){gt=ft,vt=null}function I(t,e,i,n){var r=1,o=0,a=n||this;"in"===e&&(r=0,o=1),nt.aV(a,"A",r,o,(function(t){return t*t*(3-2*t)}),t,(function(){i&&i()}))}t.prototype.nX=function(){return this.fPl.length>0?this.fPl.splice(0,1)[0]:this.nO()},t.prototype.nO=function(){var t=new this.o;return this.uPl.push(t),t},t.prototype.free=function(t){this.uPl.splice(this.uPl.indexOf(t),1),this.fPl.push(t)};var O=localStorage.SEED;O=void 0===O?1:parseInt(O);var W=1,V={Sn:[0,.15,.4,.55,.4,,87.5,100,350,,"sine",.5,15e3,,20],lv:[,.2,.3,.5,.4,,7,50,110,350,"square",.5,6e3,-5e3,200],death:[,.04,.7,.3,.2,100,10,100,350,-100,"sine",.5,15e3,,20],lights:[,.04,.1,.4,.2,100,50,50,200,,"sine",.3,200,,20,500],powerUp:[,,.4,.5,.1,100,12,80,300,500,"sine",.7,200,1e3,20],sS:[,.01,.5,.25,.1,100,40,40,540,-350,"square",.3,6e3,-6e3,20],step:[0,,,,.05,100,,,100,,"square",.05,3e3,,20]},N={search:function(t,e,i,n){t.Cd();var r=(n=n||{}).H||N.Hs.mH,o=n.cl||!0,a=new y((function(t){return t.f})),s=e;for(e.h=r(e,i),a.push(e);a.size()>0;){var l=a.pop();if(l===i)return p(l);l.Cl=!0;for(var h=t.nBs(l),c=0,f=h.length;f>c;++c){var u=h[c];if(!u.Cl&&!u.isWall()){var g=l.g+u.gC(l),d=u.v;(!d||g<u.g)&&(u.v=!0,u.pr=l,u.h=u.h||r(u,i,t.oP.Pt),u.g=g,u.f=u.g+u.h,t.mD(u),o&&(u.h<s.h||u.h===s.h&&u.g<s.g)&&(s=u),d?a.rE(u):a.push(u))}}}return o?p(s):[]},Hs:{mH:function(t,e,i){function n(t,e){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}var r=n(t,e);for(var o in i){var a=n(t,i[o])+n(i[o].to,e);r>a&&(r=a)}return r}},cln:function(t){t.f=0,t.g=0,t.h=0,t.v=!1,t.Cl=!1,t.pr=null}};d.prototype.init=function(){this.dirtyNodes=[];for(var t=0;t<this.Nds.length;t++)N.cln(this.Nds[t])},d.prototype.Cd=function(){for(var t=0;t<this.dirtyNodes.length;t++)N.cln(this.dirtyNodes[t]);this.dirtyNodes=[]},d.prototype.mD=function(t){this.dirtyNodes.push(t)},d.prototype.nBs=function(t){var e=[],i=t.x,n=t.y,r=this.Gr;r[n]&&r[n][i-1]&&e.push(r[n][i-1]),r[n]&&r[n][i+1]&&e.push(r[n][i+1]),r[n-1]&&r[n-1][i]&&e.push(r[n-1][i]),r[n+1]&&r[n+1][i]&&e.push(r[n+1][i]);for(var o=0,a=this.oP.Pt.length;a>o;o++){var s=this.oP.Pt[o];i===s.x&&n===s.y&&e.push(r[s.to.y][s.to.x])}return e},v.prototype.gC=function(){return this.w},v.prototype.isWall=function(){return 0===this.w},y.prototype={push:function(t){this.content.push(t),this.Sd(this.content.length-1)},pop:function(){var t=this.content[0],e=this.content.pop();return this.content.length>0&&(this.content[0]=e,this.bU(0)),t},remove:function(t){var e=this.content.indexOf(t),i=this.content.pop();e!==this.content.length-1&&(this.content[e]=i,this.sF(i)<this.sF(t)?this.Sd(e):this.bU(e))},size:function(){return this.content.length},rE:function(t){this.Sd(this.content.indexOf(t))},Sd:function(t){for(var e=this.content[t];t>0;){var i=(t+1>>1)-1,n=this.content[i];if(!(this.sF(e)<this.sF(n)))break;this.content[i]=e,this.content[t]=n,t=i}},bU:function(t){for(var e=this.content.length,i=this.content[t],n=this.sF(i);;){var r,o=t+1<<1,a=o-1,s=null;if(e>a){var l=this.content[a];n>(r=this.sF(l))&&(s=a)}if(e>o){var h=this.content[o];(null===s?n:r)>this.sF(h)&&(s=o)}if(null===s)break;this.content[t]=this.content[s],this.content[s]=i,t=s}}};var X=function(){this.keys={},this.touch={},addEventListener("mousedown",this.tDown.bind(this),!1),addEventListener("mouseup",this.tUp.bind(this),!1),addEventListener("mousemove",this.tMove.bind(this),!1),addEventListener("touchstart",this.tDown.bind(this),!1),addEventListener("touchend",this.tUp.bind(this),!1),addEventListener("touchmove",this.tMove.bind(this),!1)};X.prototype.rG=function(t,e,i,n,r){"touch"===t&&(window.bTs=[],this.touches=[],this.touch={touched:!1,x:null,y:null,down:i,up:n,held:r})},X.prototype.update=function(){if(this.touches.length>0)for(var t in this.touches){var e=this.touches[t];if(bTs.length>0&&e)for(var t in bTs){var i=bTs[t];i&&i.held&&h(i,e)&&i.held()}}},X.prototype.tDown=function(t){var e=[];if(et?(t.preventDefault(),e=b(t)):e.push({x:t.clientX-Q,y:t.clientY-$,id:0}),e.length>0)for(var i in e){var n=e[i],r=!0;for(var o in this.touches)this.touches[o].id===n.id&&(r=!1);if(r&&(this.touches.push(n),bTs.length>0))for(var i in bTs){var a=bTs[i];a&&a.down&&h(a,n)&&a.down()}}},X.prototype.tUp=function(t){if(et)if(1===this.touches.length)this.touches=[];else{var e=b(t);this.touches=e}else this.touches=[]},X.prototype.tMove=function(t){t.preventDefault()},x.prototype.pAnm=function(){for(var t=0,e=this.eA.length;e>t;t++){var i=this.eA[t];if(void 0!==i&&void 0!==i.ease&&null!==i.ease)if(0===i.ease.length)this.eA.splice(this.eA.indexOf(i));else for(var n=0,r=i.ease.length;r>n;n++)i.ease[n]&&i.ease[n].aNm()}if(this.toRemove.length>0){for(var t in this.toRemove)this.removeEasing(this.toRemove[t]);this.toRemove=[]}},x.prototype.aV=function(t,e,i,n,r,o,a,s,l){var h=this.eA.indexOf(t);-1!==h&&this.eA.splice(h,1),this.eA.push(t),this.animate({Tg:t,V:e,D:r,dr:o||1e3,type:s||"once",tm:l,cLb:a,step:function(r){t[e]=i-(i-n)*r}})},x.prototype.animate=function(t){function i(){var i=((new Date).getTime()-r)/(t.dr||1e3),o=t.D;switch(t.type){case"once":i>1&&(i=1),t.step(o(i)),1===i&&n(t.Tg,this);break;case"loop":t.step(o(i%1)),option.tm&&i>t.tm&&n(t.Tg,this);break;case"pingpong":t.step(i>1?e(i)%2==0?o(i%1):1-o(i%1):o(i)),t.tm&&i>2*t.tm&&n(t.Tg,this)}}function n(e,i){e.cLb=t.cLb,e.toRemove=i,o.toRemove.push(e)}var r=(new Date).getTime();t.Tg.ease&&null!==t.Tg.ease?(-1!==t.Tg.ease.indexOf({type:t.V,aNm:i})&&t.Tg.ease.splice(t.Tg.ease.indexOf({type:t.V,aNm:i}),1),t.Tg.ease.push({type:t.V,aNm:i})):t.Tg.ease=[{type:t.V,aNm:i}];var o=this},x.prototype.removeEasing=function(t){t.ease.splice(t.ease.indexOf(t.toRemove),1),t.toRemove=void 0,0===t.ease.length&&this.eA.splice(this.eA.indexOf(t),1),void 0!==t.cLb&&(t.cLb(t),t.cLb=void 0)},x.prototype.movePiece=function(t,e,i,n,r,o){var a=0;r=r||function(t){return t*t*(3-2*t)};i!==t.y&&(a++,this.aV(t,"y",t.y,i,r,n,(function(){a--,s()}))),e!==t.x&&(a++,this.aV(t,"x",t.x,e,r,n,(function(){a--,s()})));var s=function(){o&&0===a&&o(t)}},m.prototype.render=function(t){var e=this;e.visible&&(t.save(),e.A<1&&(t.globalAlpha=e.A),t.font=e.font,t.textAlign=e.textAlign,E(e.colour),t.lineWidth=e.lineWidth,A(e.strokeStyle),0===e.w?(t.fillText(e.tX,e.x,e.y),!et&&e.lineWidth>0&&t.strokeText(e.tX,e.x,e.y)):u(t,e.tX,e.x,e.y,e.w,e.lh),t.restore())},w.prototype.init=function(t,e,i,n,r){var o=this;o.gM=t,o.type=n,o.dead=!1,o.x=e*ot||0,o.y=i*ot||0,o.w=r*ot||ot,o.h=r*ot||ot,o.yOff=0,o.A=1,o.visible=!0,o.H=.33,o.S=.03,o.L=.2,o.colour,o.A=1,o.moving=!1,o.gx=e,o.gy=i,o.vx=0,o.vy=0,o.speed=st,o.dir="",o.nextDir="",o.lastDir="E",o.portal="",o.zIndex=3*o.gy+2,o.gM&&o.gM.sprites.push(o)},w.prototype.render=function(t){var e=this;if(t.save(),e.visible)switch(e.A<1&&(t.globalAlpha=e.A),H[e.type](t,e.x,e.y,e.w,e),e.portal){case"left":H[e.type](t,e.x-23*ot,e.y,e.w,e);break;case"right":H[e.type](t,e.x+23*ot,e.y,e.w,e)}t.restore()},w.prototype.update=function(){this.gx=e(this.x/ot),this.gy=e(this.y/ot)},w.prototype.Colour=function(){return f(this.H,this.S,this.L,1)},w.prototype.fadeIn=function(){this.fading=!0;var t=this;nt.aV(this,"H",.33,.67,(function(t){return Math.pow(Math.sin(t*Math.PI/2),2)}),400),nt.aV(this,"S",.03,.2,(function(t){return Math.pow(Math.sin(t*Math.PI/2),2)}),400),nt.aV(this,"L",.2,.7,(function(t){return Math.pow(Math.sin(t*Math.PI/2),2)}),400,(function(){t.fading=!1})),this.lit=!0},w.prototype.fadeOut=function(){this.fading=!0;var t=this;nt.aV(this,"H",.67,.33,(function(t){return Math.pow(Math.sin(t*Math.PI/2),2)}),400),nt.aV(this,"S",.2,.03,(function(t){return Math.pow(Math.sin(t*Math.PI/2),2)}),400),nt.aV(this,"L",.7,.2,(function(t){return Math.pow(Math.sin(t*Math.PI/2),2)}),400,(function(){t.fading=!1})),this.lit=!1};var q={N:{x:0,y:-1},E:{x:1,y:0},S:{x:0,y:1},W:{x:-1,y:0}};w.prototype.AI=function(){var t=this;if(!t.moving&&(void 0===t.path||0===t.path.length)){var i=t.gM.Pl;switch(t.aiType){case"follow":t.path=t.gM.bestPath(t,i);break;case"cutOff":var n=o(t.gM.map);n[i.gy][i.gx]=0,t.path=""!==i.dir&&c(t,t.gM.Pl)>4&&void 0!==n[i.gy+q[i.dir].y]&&void 0!==n[i.gy+q[i.dir].y][i.gx+q[i.dir].x]?t.gM.bestPath(t,{gx:i.gx+q[i.dir].x,gy:i.gy+q[i.dir].y},n):t.gM.bestPath(t,i);break;case"patrol":c(t,t.gM.Pl)<5?t.path=t.gM.bestPath(t,i):(void 0===t.patrolNumber&&(t.patrolNumber=a(0,3,!0)),t.path=t.gM.bestPath(t,t.gM.eLocs[t.patrolNumber]),void 0!==t.path&&t.path.length<1&&(t.patrolNumber=(t.patrolNumber+a(0,3,!0))%t.gM.eLocs.length),t.path=t.gM.bestPath(t,t.gM.eLocs[t.patrolNumber]));break;case"dumb":c(t,t.gM.Pl)<4?t.path=t.gM.bestPath(t,i):((void 0===t.Tg||void 0!==t.path&&0===t.path.length)&&(t.Tg=t.gM.floorCells[e(Math.random()*t.gM.floorCells.length-1)]),t.path=t.gM.bestPath(t,t.Tg),void 0!==t.path&&t.path.length<1&&(t.Tg=t.gM.floorCells[e(Math.random()*t.gM.floorCells.length-1)],t.path=t.gM.bestPath(t,t.Tg)))}}if(void 0!==t.path){var r=t.path[0];r&&(r.y<t.gy&&(t.nextDir="N"),r.x>t.gx&&(t.nextDir="E"),r.y>t.gy&&(t.nextDir="S"),r.x<t.gx&&(t.nextDir="W"),1!==Math.abs(t.gx-r.x)&&(0===t.gx&&(t.nextDir="W"),22===t.gx&&(t.nextDir="E")),t.path=void 0,t.GrMove())}},w.prototype.GrMove=function(t){function e(){c||("Pl"===i.type?(i.gM.Gr[s][a].Pl=null,i.gM.Gr[i.gy][i.gx].Pl=i,i.zIndex=3*i.gy+2):(i.gM.Gr[s][a].actors.splice(i.gM.Gr[s][a].actors.indexOf(i)),i.zIndex=3*i.gy+2)),c=!0}var i=this,n=i.speed;if(i.moving||""===i.dir&&""===i.nextDir)("S"===i.dir&&"N"===i.nextDir||"N"===i.dir&&"S"===i.nextDir||"E"===i.dir&&"W"===i.nextDir||"W"===i.dir&&"E"===i.nextDir)&&(i.dir=i.nextDir);else{i.moving=!0,""===i.dir?(i.dir=i.nextDir,i.nextDir=""):i.dir!==i.nextDir&&""!==i.nextDir&&i.gM.checkSpace(i.gx+q[i.nextDir].x,i.gy+q[i.nextDir].y)&&(i.dir=i.nextDir);var r=q[i.dir].x,o=q[i.dir].y;if(i.gM.checkSpace(i.gx+r,i.gy+o)){i.lastDir=i.dir;var a=i.gx,s=i.gy,l=i.gx+r,h=i.gy+o;i.gx=i.gx+r,i.gy=i.gy+o,i.gx>22?(i.gx=0,i.portal="left"):i.gx<0?(i.gx=22,i.portal="right"):i.portal="","Pl"===i.type&&nt.aV(i,"yOff",0,ot/8,(function(t){return Math.sin(t*Math.PI)}),st),nt.movePiece(i,l*ot,h*ot,n,(function(t){return t}),(function(){if(i.moving=!1,e(),i.x=i.gx*ot,i.y=i.gy*ot,"Pl"===i.type){var n=i.gM.Gr[i.gy][i.gx].ground;!i.gM.lVc&&n&&(n.lit||(g(0,V.lights),i.gM.score+=10,n.fadeIn(),n.lit=!0,i.gM.litTiles.push(n)),n.litTime="P"===i.gM.pS?(new Date).getTime():i.gM.steps),i.gM.lVc&&11===i.gM.Pl.gx&&6===i.gM.Pl.gy&&(i.gM.nXl=!0)}t&&t()})),(r>0||o>0)&&i.gx===l&&e();var c=!1}else i.dir="",i.moving=!1}},T.prototype.render=function(t){if(t.save(),t.lineWidth=4,this.A<1&&(t.globalAlpha=this.A),this.visible)switch(this.type){case"laser":this.Tg&&H[this.type](t,this.x,this.y,this.Tg.x*ot+ot/2,this.Tg.y*ot+ot/4);break;case"proxy":H[this.type](t,this.x,this.y,this.radius*ot)}t.restore()};var L={tW:[["b"],["m",.2,1],["l",.25,.3],["bt",.25,.24,.7,.24,.75,.3],["l",.8,1]],brick:[["b"],["m",.1,.25],["bt",.3,.11,.8,.11,.9,.2],["bt",1,.3,1,.8,.9,.9],["bt",.8,.8,.1,.8,.1,.95],["bt",0,.8,0,.2,.1,.25]],crown:[["b"],["m",.15,.28],["l",.16,.1],["q",.16,.07,.24,.05],["l",.24,.1],["q",.29,.08,.34,.073],["l",.34,.03],["q",.39,.01,.45,.015],["l",.45,.055],["q",.5,.05,.55,.055],["l",.55,.015],["q",.61,.01,.66,.03],["l",.66,.073],["q",.71,.08,.76,.1],["l",.76,.05],["q",.84,.07,.84,.1],["l",.85,.28],["bt",.85,.39,.15,.39,.15,.28]],ellipse:[["b"],["m",.17,.285],["bt",.17,.19,.83,.19,.83,.285],["bt",.83,.37,.17,.37,.17,.285]],cloud:[["b"],["m",.3,1],["bt",0,.3,1,.3,.7,1]],ghost:[["b"],["m",.05,1],["l",.05,.25],["bt",.05,-.3,.95,-.3,.95,.25],["l",.95,1],["l",.833,.85],["l",.667,1.1],["l",.5,.9],["l",.333,1.1],["l",.167,.85]],eye2:[["b"],["m",.1,.5],["bt",.1,.4,.45,.4,.45,.52],["bt",.45,.6,.1,.65,.1,.5]],eye3:[["b"],["m",.1,.48],["bt",.1,.4,.4,.38,.45,.53],["bt",.43,.63,.1,.65,.1,.48]],eye4:[["b"],["m",.1,.45],["bt",.15,.4,.45,.4,.45,.6],["bt",.3,.6,.1,.6,.1,.45]],eye5:[["b"],["m",.1,.4],["l",.4,.5],["bt",.4,.66,.1,.68,.1,.4]],hatW:[["b"],["m",0,.45],["l",.4,.4],["l",.9,.1],["l",.85,.6],["l",1,.9],["q",.7,1,.3,.7],["l",.45,.55],["l",.1,.6]],hatE:[["b"],["m",1,.45],["l",.6,.4],["l",.1,.1],["l",.15,.6],["l",0,.9],["q",.55,.95,1,.45]],hatD:[["b"],["m",0,.6],["l",.25,.5],["l",.5,.1],["l",.75,.5],["l",1,.6],["l",.9,.7],["l",.65,.55],["l",.72,.75],["q",.3,.8,0,.6]],hatU:[["b"],["m",0,.6],["l",.25,.45],["l",.5,.1],["l",.75,.45],["l",1,.6],["q",.5,1,0,.6]],cloakS:[["b"],["m",0,1],["bt",-.1,.9,0,.6,0,.5],["bt",.1,.4,.9,.5,1,.4],["bt",1,.6,.85,.8,1.1,1],["bt",.85,1.1,.1,1.1,0,1]],cloakD:[["b"],["m",-.1,1],["bt",.1,.9,.15,.2,0,.4],["bt",.1,.4,.35,.45,.45,.55],["l",.45,1.1],["bt",.45,1.15,0,1,0,1],["c"]],cloakU:[["b"],["m",-.1,1],["bt",.1,.9,.15,.2,0,.4],["bt",.1,.4,.35,.45,.5,.55],["bt",.65,.5,.9,.4,1,.4],["bt",.85,.2,.9,.9,1.1,1],["q",.5,1.2,-.1,1]],staff:[["b"],["m",.1,.7],["l",.6,.4],["bt",.6,.3,.9,.1,1,.2],["bt",1,.3,.3,.6,.2,.8],["q",-.12,.85,.1,.7]],staffShadow:[["b"],["m",.6,.4],["q",1.05,.18,.75,.275]],pacman:[["b"],["m",.5,.5],["l",.8,.4],["bt",.8,.1,.2,.1,.2,.5],["bt",.2,.9,.8,.9,.8,.6],["c"]],arrow:[["b"],["m",0,.75],["l",.8,.55],["l",.8,.45],["l",0,.25],["c"]],speaker:[["b"],["m",0,.7],["l",0,.3],["l",.3,.3],["l",.7,0],["q",1.1,.5,.7,1],["l",.3,.7],["c"]]},H={Pl:function(t,i,n,r,o){function a(e){t.save(),E("brown"),P(t,L.staff,i,n-ot/4,1.5*r,e),t.fill(),A("rgba(0,0,0,0.5)"),t.lineWidth=ot/30,P(t,L.staffShadow,i,n-ot/4,1.5*r,e),t.stroke(),t.restore()}switch(n-=o.yOff+ot/4,E("black"),t.beginPath(),t.arc(i+ot/2,n+.45*ot-e(ot/4),.95*r/2,0,2*Math.PI),t.fill(),H.eye(t,i,n,r,o),t.save(),E("blue"),A("gold"),t.lineWidth=ot/10,o.lastDir){case"E":P(t,L.cloakS,i,n,.9*r,!0);break;case"W":a(!0),P(t,L.cloakS,i+ot/20,n,.9*r);break;case"N":a(!0),P(t,L.cloakU,i+ot/20,n,.9*r);break;case"S":P(t,L.cloakD,i+ot/20,n,.9*r),t.fill(),t.stroke(),P(t,L.cloakD,i-ot/20,n,.9*r,!0)}var s;switch(t.fill(),t.stroke(),("E"===o.lastDir||"S"===o.lastDir)&&a(),E("yellow"),o.lastDir){case"E":P(t,L.hatE,i-ot/4,n-.85*ot,1.5*r),t.fill(),s=t.createRadialGradient(i+.1*ot,n-.4*ot,0,i+.1*ot,n-.4*ot,r),P(t,L.hatE,i-ot/4,n-.85*ot,1.5*r);break;case"W":P(t,L.hatW,i-ot/4,n-.85*ot,1.5*r),t.fill(),s=t.createRadialGradient(i+.9*ot,n-.4*ot,0,i+.9*ot,n-.4*ot,r),P(t,L.hatW,i-ot/4,n-.85*ot,1.5*r);break;case"N":P(t,L.hatU,i-.28*ot,n-.85*ot,1.6*r),t.fill(),s=t.createRadialGradient(i+.5*ot,n-.38*ot,0,i+.5*ot,n-.38*ot,r),P(t,L.hatU,i-.28*ot,n-.85*ot,1.6*r);break;case"S":P(t,L.hatD,i-.28*ot,n-.95*ot,1.6*r),t.fill(),s=t.createRadialGradient(i+.5*ot,n-.4*ot,0,i+.5*ot,n-.4*ot,r),P(t,L.hatD,i-.28*ot,n-.95*ot,1.6*r)}s.addColorStop(0,"rgba(0,0,0,0)"),s.addColorStop(.5,"rgba(0,0,0,0.4)"),s.addColorStop(1,"rgba(0,0,0,0)"),E(s),t.fill(),t.restore()},ghost:function(t,e,i,n,r){i-=r.yOff+ot/9,E(r.colour),P(t,L.ghost,e,i,n),t.fill(),P(t,L.ghost,e,i,n);var o=t.createRadialGradient(e+n/2,i,n/2,e+n/2,i+n,n/2);o.addColorStop(0,"rgba(0,0,0,0)"),o.addColorStop(1,"rgba(0,0,0,0.2)"),E(o),t.fill(),H.eye(t,e,i,n,r)},eye:function(t,e,i,n,r){var o="eye";switch(r.aiType){case"dumb":case void 0:o+=2;break;case"patrol":o+=3;break;case"follow":o+=4;break;case"cutOff":o+=5}switch(r.lastDir){case"N":break;case"E":E("white"),P(t,L[o],e+ot/2,i-ot/4,n),t.fill(),E("black"),t.beginPath(),t.arc(e+4.8*ot/6,i+.25*ot,ot/15,0,2*Math.PI),t.fill();break;case"S":E("white"),P(t,L[o],e,i-ot/4,n),t.fill(),P(t,L[o],e,i-ot/4,n,!0),t.fill(),E("black"),t.beginPath(),t.arc(e+4.3*ot/6,i+.26*ot,ot/15,0,2*Math.PI),t.arc(e+1.7*ot/6,i+.26*ot,ot/15,0,2*Math.PI),t.fill();break;case"W":E("white"),P(t,L[o],e-ot/2,i-ot/4,n,!0),t.fill(),E("black"),t.beginPath(),t.arc(e+1.2*ot/6,i+.25*ot,ot/15,0,2*Math.PI),t.fill()}},energy:function(t,i,n,r,o){r+=o.yOff;var a=t.createRadialGradient(i+ot/2,n+ot/2-e(ot/8),0,i+ot/2,n+ot/2-e(ot/8),.25*r);a.addColorStop(0,"rgba(255,255,255,1)"),a.addColorStop(1,"rgba(64,200,200,0)"),E(a),t.beginPath(),t.arc(i+ot/2,n+ot/2-e(ot/8),.3*r,0,2*Math.PI),t.fill()},laser:function(t,e,i,n,r){t.lineWidth=ot/3,A("rgba(64,200,200,0.5)"),t.beginPath(),t.moveTo(e,i),t.lineTo(n,r),t.stroke(),t.lineWidth=ot/6,A("turquoise"),t.stroke()},proxy:function(t,e,i,n){t.lineWidth=ot/6;var r=t.createRadialGradient(e+ot/2,i+ot/4,ot/3,e+ot/2,i+ot/4,ot);r.addColorStop(0,"rgba(255,255,255,0)"),r.addColorStop(1,"rgba(64,200,200,1)"),E(r),A("turquoise"),t.beginPath(),t.arc(e+ot/2,i+ot/4,n,0,2*Math.PI),t.stroke(),t.fill()},wall:function(t,i,n,r){if(E(it),t.fillRect(i,n-e(ot/2),r,r+e(ot/2)),et)E("rgba(0,0,0,0.2)");else{var o=t.createLinearGradient(i,n,i,n+r);o.addColorStop(0,"rgba(0,0,0,0.2)"),o.addColorStop(1,"rgba(0,0,0,0.6)"),E(o)}t.fillRect(i,n,r,r)},wall2:function(t,i,n,r){E(it),t.fillRect(i,n-e(ot/2),r,r)},stairs:function(t,e,i,n){E(it),t.fillRect(e,i-n/6,n,n+n/6),E("rgba(0,0,0,0.2)"),t.fillRect(e,i+n/6,n,n/6),t.fillRect(e,i+n/6*3,n,n/6),t.fillRect(e,i+n/6*5,n,n/6)},floor:function(t,e,i,n,r){if(E(r.Colour()),t.fillRect(e,i,n,n),!et){var o=t.createRadialGradient(e+n/2,i+n/2,0,e+n/2,i+n/2,n/1.1);o.addColorStop(1,"rgba(0,0,0,0.2)"),o.addColorStop(0,"rgba(0,0,0,0)"),E(o),t.fillRect(e,i,n,n)}},tW:function(t,e,i,n){A("rgba(0,0,0,0.7)"),E("darkslategray"),P(t,L.crown,e,i,n),t.fill(),t.stroke(),t.save(),t.globalAlpha=.2,E("black"),P(t,L.ellipse,e,i,n),t.fill(),t.restore(),E("darkslategray"),P(t,L.tW,e,i,n),t.fill(),t.stroke()},cloud:function(t,e,i,n){P(t,L.cloud,e,i,n);var r=t.createRadialGradient(e+n/2,i+.8*n,0,e+n/2,i+.8*n,n/4);r.addColorStop(0,"rgba(170,170,170,1)"),r.addColorStop(.7,"rgba(180,180,180,0.7)"),r.addColorStop(1,"rgba(255,255,255,0.0)"),E(r),t.fill()},pacman:function(t,e,i,n){E("yellow"),t.lineWidth=.1*ot,A("steelblue"),P(t,L.pacman,e,i,n),t.fill(),t.stroke()}},U=[[[0,0,0],[0,1,0],[0,0,0]],[[0,1,0],[0,1,0],[0,0,0]],[[0,0,0],[1,1,1],[0,0,0]],[[0,1,0],[0,1,1],[0,0,0]],[[0,1,0],[1,1,1],[0,0,0]],[[0,1,0],[1,1,1],[0,1,0]],[[1,0,0],[1,1,1],[0,0,0]],[[0,0,0],[1,1,1],[1,0,0]],[[0,0,0],[0,1,1],[1,1,0]],[[0,0,0],[1,1,0],[0,1,1]]],z=[U[0],U[1],k(U[1],1),k(U[1],2),k(U[1],3),U[2],k(U[2],1),U[3],k(U[3],1),k(U[3],2),k(U[3],3),U[4],k(U[4],1),k(U[4],2),k(U[4],3),U[6],k(U[6],1),k(U[6],2),k(U[6],3),U[7],k(U[7],1),k(U[7],2),k(U[7],3),U[8],k(U[8],1),k(U[8],2),k(U[8],3),U[9],k(U[9],1),k(U[9],2),k(U[9],3),U[5]],_={"0000":0,1e3:1,"0001":2,"0010":3,"0100":4,"0101":5,1010:6,1100:7,1001:8,"0011":9,"0110":10,1101:11,1011:12,"0111":13,1110:14,1111:31};S.prototype.makeMap=function(){function t(t,e){m+=void 0!==Gr[e]&&void 0!==Gr[e][t]&&Gr[e][t]===x?1:0}for(Gr=n(6,6),this.copyNumber=2,this.done=!1,map=n(21,13),Gr[5][3]=1;!this.done;){for(var e=z[s(5,31,!0)],i={score:0},r=-2,o=Gr[0].length;o>r;r++)for(var a=0;4>a;a++)for(var l=k(e,a),h=0,c=Gr[0].length;c>h;h++){for(var f=!0,u=0,g=0,p=l.length;p>g;g++)if(void 0!==Gr[h+g])for(var d=0,v=l[0].length;v>d;d++)1===l[g][d]&&(0!==Gr[h+g][r+d]?f=!1:u+=g+h);f&&u>i.score&&(i={score:u,x:r,y:h,r:a})}if(i.score>0){for(l=k(e,i.r),g=0;3>g;g++)if(void 0!==Gr[g+i.y])for(d=0;3>d;d++)void 0!==Gr[g+i.y][d+i.x]&&1===l[g][d]&&(Gr[g+i.y][d+i.x]=this.copyNumber);this.copyNumber++}else this.done=!0}Gr.splice(0,1);for(g=Gr.length-1;g>=0;g--){Gr.push([]);for(var y=0,b=Gr[g].length;b>y;y++)Gr[Gr.length-1].push(10*Gr[g][y]),1===Gr[g][y]&&(Gr[Gr.length-1][y]=1)}Gr=k(Gr,1);for(g=0,p=Gr.length;p>g;g++)for(d=0,v=Gr[0].length;v>d;d++){var x=Gr[g][d];if(x>0){var m="";t(d,g-1),t(d+1,g),t(d,g+1),t(d-1,g);for(e=z[_[m]],h=0,c=3;c>h;h++)for(r=0,o=3;o>r;r++)map[2*g+h][2*d+r]=1===e[h][r]?0:1}}for(y=0,b=map.length;b>y;y++)map[y].unshift(0),map[y].push(0);var w=[];for(y=0,b=map[0].length;b>y;y++)w.push(0);map.unshift(w),map.push(w);var T=[];for(y=2,b=map.length-2;b>y;y++)0!==map[y][1]&&T.push(y);var P=T[s(0,T.length-1,!0)];map[P][0]=1,map[P][map[0].length-1]=1;var S=[],G=[];for(g=0;4>g;g++)for(d=0;4>d;d++)1===map[g][d]&&S.push({x:d,y:g}),1===map[map.length-1-g][d]&&G.push({x:d,y:map.length-1-g});var M=(s(0,G.length-1,!0),S[s(0,S.length-1,!0)]),E=G[s(0,G.length-1,!0)];return{Pt:[{x:0,y:P,to:{x:map[0].length-1,y:P}},{x:map[0].length-1,y:P,to:{x:0,y:P}}],eLocs:[{x:M.x,y:M.y,gx:M.x,gy:M.y},{x:E.x,y:E.y,gx:E.x,gy:E.y}],map:map}},G.prototype.init=function(t){var e=this;if(it=f(a(0,1),.9,.4,1),t&&(W=t),e.PAUSED=!0,e.lVc=!1,e.nXl=!1,e.GAME_OVER=!1,e.steps=0,e.finishPath=[],e.sprites=[],e.energyPellets=[],e.charges=0,e.heap=new y((function(t){return t.zIndex})),e.PAUSED=!0,I(2e3,"out",(function(){e.PAUSED=!1})),e.mapMaker=new S,e.Map=e.mapMaker.makeMap(19,13),e.map=e.Map.map,e.Pt=e.Map.Pt,e.eLocs=e.Map.eLocs,e.litTiles=[],e.WAIT=1,e.MOVE=2,e.state=1,e.buildGrid(e.map)){e.centreTile=e.Gr[6][11].walls,e.Pl=rt.nX(),e.Pl.init(e,11,7,"Pl"),e.Pl.nextDir="E",e.lastEnemy=(new Date).getTime(),e.enemyPeriod=1e4,e.ghostTypes=[{colour:"pink",type:"dumb"},{colour:"blue",type:"patrol"},{colour:"green",type:"follow"},{colour:"orange",type:"cutOff"}],e.ghosts=[],e.addEnemy();for(var i=0,n=e.eLocs.length;n>i;i++){var r=e.eLocs[i];(o=rt.nX()).init(e,r.x,r.y,"energy"),o.zIndex=3*r.y+1,nt.aV(o,"yOff",0,ot/10,(function(t){return t*t*(3-2*t)}),400,void 0,"pingpong"),e.energyPellets.push(o),e.sprites.push(o)}for(i=0,n=e.eLocs.length;n>i;i++){var o;r=e.eLocs[i];(o=rt.nX()).init(e,e.Gr[0].length-1-r.x,r.y,"energy"),o.zIndex=3*r.y+1,e.eLocs.push({x:e.Gr[0].length-1-r.x,y:r.y,gx:e.Gr[0].length-1-r.x,gy:r.y}),nt.aV(o,"yOff",0,ot/10,(function(t){return t*t*(3-2*t)}),400,void 0,"pingpong"),e.sprites.push(o),e.energyPellets.push(o)}}},G.prototype.fireWp=function(t){var e=this;e.weapon=new T;var i=e.weapon,n=e.Pl;e.sprites.push(i);var r=[];if(e.charges>0&&!i.FIRING){switch(i.FIRING=!0,g(0,V.sS),i.visible=!0,i.type=t,i.zIndex=n.zIndex,t){case"laser":var o={x:0,y:0,w:0,h:0};switch(n.lastDir){case"N":o.x=n.x,o.w=ot;for(var a=1,s=n.gy+1;s>a;a++){if(1!==e.map[n.gy-a][n.gx]){o.y=n.y-o.h,i.Tg={x:n.gx,y:n.gy-a};break}o.h+=ot}break;case"E":o.x=n.x,o.y=n.y,o.h=ot;for(a=1,s=e.map[0].length-n.gx;s>a;a++){if(1!==e.map[n.gy][n.gx+a]){i.Tg={x:n.gx+a,y:n.gy};break}o.w+=ot}break;case"S":o.x=n.x,o.y=n.y,o.w=ot;for(a=1,s=e.map.length-n.gy;s>a;a++){if(1!==e.map[n.gy+a][n.gx]){i.zIndex=3*(n.gy+a)-2,i.Tg={x:n.gx,y:n.gy+a};break}o.h+=ot}break;case"W":o.y=n.y,o.h=ot;for(a=1,s=n.gx+1;s>a;a++){if(1!==e.map[n.gy][n.gx-a]){o.x=n.x-o.w,i.Tg={x:n.gx-a,y:n.gy};break}o.w+=ot}}for(var a in i.x=n.x+ot/2,i.y=n.y+ot/4,e.ghosts)e.ghosts[a]&&l(o,e.ghosts[a])&&r.push(e.ghosts[a]);I(300,"out",(function(){i.visible=!1,i.FIRING=!1}),i);break;case"proxy":for(var a in e.ghosts)c({x:n.x,y:n.y},e.ghosts[a])<2.5*ot&&r.push(e.ghosts[a]);i.x=n.x,i.y=n.y,i.zIndex=n.zIndex,nt.aV(i,"radius",.1,2.5,(function(t){return t*t*(3-2*t)}),300,(function(){})),I(300,"out",(function(){i.visible=!1,i.FIRING=!1}),i)}for(var a in r){e.score+=100;var h=r[a];h.dead=!0,e.removeEnemy(h)}e.charges-=1}},G.prototype.addEnemy=function(){var t=this;if(t.ghostTypes.length>0){var e,i=(e=t.ghostTypes.splice(0,1)[0]).type,n=f(a(0,1),.8,.55,.85);(e=rt.nX()).init(t,11,5,"ghost"),e.path=t.bestPath(e,t.Pl),e.aiType=i,e.colour=n,e.A=0;var r=t;e.speed=1.3*st,I(700,"in",(function(){r.ghosts.push(e)}),e),nt.aV(e,"yOff",0,ot/8,(function(t){return t*t*(3-2*t)}),400,void 0,"pingpong")}},G.prototype.removeEnemy=function(t){var e=this;for(var i in e.ghosts){var n=e.ghosts[i];t.aiType===n.aiType&&(e.lVc||e.ghostTypes.push({type:t.aiType,colour:t.colour}),I(700,"out",(function(){var e=t.gM.Gr[t.gy][t.gx].actors;e.splice(e.indexOf(t),1),t.visible=!1}),t),e.ghosts.splice(e.ghosts.indexOf(t),1))}},G.prototype.buildGrid=function(){var t=this;t.Gr=[],t.floorCells=[];for(var e=0,i=t.map.length;i>e;e++){t.Gr.push([]);for(var n=0,r=t.map[0].length;r>n;n++){var o={stairs:null,ground:null,Pl:null,actors:[],walls:null};if(0===t.map[e][n]){if(6===e&&11===n){var a=rt.nX();a.init(t,n,e,"stairs"),a.gx=n,a.gy=e,a.zIndex=3*e,a.visible=!1,t.stairs=a}var s=rt.nX();s.init(t,n,e,"wall"),"R"===t.pS&&(s.A=0),void 0!==t.map[e+1]&&0===t.map[e+1][n]&&(s.type="wall2"),s.zIndex=3*e,o.walls=s}if(1===t.map[e][n]){var l=rt.nX();l.init(t,n,e,"floor"),"R"===t.pS&&(l.A=0),l.lit=!1,l.litTime=null,l.gx=n,l.gy=e,o.ground=l,t.floorCells.push(l),l.zIndex=3*e}t.Gr[e].push(o)}}return t.floorTileCount=t.floorCells.length,!0},G.prototype.update=function(){var t=this;if(!t.lVc&&t.litTiles.length===t.floorTileCount&&!t.lVc){g(0,V.lv),t.score+=1e4,t.stairs.visible=!0,t.sprites.push(t.stairs);for(var e=t.ghosts.length-1;e>=0;e--)t.removeEnemy(t.ghosts[e]);setTimeout((function(){for(var e in t.litTiles){var i=t.litTiles[e];i.H=.67,i.S=.7,i.L=.2}t.litTiles=[]}),500),t.lVc=!0,t.centreTile.visible=!1,t.Gr[t.centreTile.gy][t.centreTile.gx].walls=null,t.map[t.centreTile.gy][t.centreTile.gx]=1}if(t.lVc&&t.nXl&&(t.lVc=!1,t.nXl=!1,t.PAUSED=!0,setTimeout((function(){I("2000","in",(function(){for(var e in t.sprites)rt.free(t.sprites[e]);t.init()}))}),500)),!t.PAUSED){if("R"===t.pS)for(var e in t.ghosts){var i=t.ghosts[e],n=i.vis?"in":"out";(1===i.A&&"out"===n||0===i.A&&"in"===n)&&I(200,n,void 0,i)}for(var e in t.tX.score.tX="SCORE: "+t.score,t.tX.charges.tX="CHARGES: "+t.charges,t.ghosts){var r=t.ghosts[e];r&&l(t.Pl,r,at)&&(t.charges>0?t.fireWp("proxy"):t.gO())}var o=[];for(var e in t.energyPellets){var a=t.energyPellets[e];c({x:a.x,y:a.y},t.Pl)<ot&&(g(0,V.powerUp),t.charges+=1,o.push(a),a.visible=!1)}for(var e in o)t.energyPellets.splice(t.energyPellets.indexOf(o[e]),1);if(t.READY){for(var e in"R"===t.pS&&(t.READY=!1),!t.lVc&&(t.ghostTypes.length>0&&"P"===t.pS&&(new Date).getTime()>t.lastEnemy+t.enemyPeriod||"R"===t.pS&&t.steps%40==39)&&(t.lastEnemy=(new Date).getTime(),t.addEnemy()),t.Pl.GrMove((function(){if(t.lVc){t.finishPath=t.bestPath(t.Pl,t.centreTile);for(var e=t.litTiles.length-1;e>=0;e--)(r=t.litTiles[e]).light=!1;if(t.finishPath.length>0){e=0;for(var i=t.finishPath.length;i>e;e++){var n=t.finishPath[e];(r=t.Gr[n.y][n.x].ground)&&(r.light=!0,t.litTiles.push(r))}}for(e=t.litTiles.length-1;e>=0;e--){var r;(r=t.litTiles[e]).light&&!r.lit?r.fadeIn():!r.light&&r.lit?r.fadeOut():r.light&&r.lit?r.fading||(r.H=.67,r.S=.2,r.L=.7,r.lit=!0):r.light||r.lit||r.fading||(r.H=.33,r.S=.03,r.L=.2,r.lit=!1)}}})),t.ghosts)t.ghosts[e].AI();for(e=t.sprites.length-1;e>=0;e--)t.sprites[e].visible||t.sprites.splice(e,1)}}},G.prototype.gO=function(){var t=this;g(0,V.death),t.GAME_OVER=!0,nt.eA=[],t.ghosts=[],t.score>localStorage.WIZARD_TOWER_HIGH_SCORE?(localStorage.WIZARD_TOWER_HIGH_SCORE=t.score,Y=t.score,t.tX.highScore.tX="HIGH SCORE: "+Y,t.tX.cG.A=0,t.tX.cG.visible=!0,I(1e3,"in",null,t.tX.cG),t.tX.cG2.A=0,t.tX.cG2.visible=!0,I(1e3,"in",null,t.tX.cG2)):(t.tX.gO.visible=!0,I(1e3,"in",null,t.tX.gO)),t.PAUSED=!0,setTimeout((function(){I("2000","in",C)}),2e3)},G.prototype.checkSpace=function(t,e){return void 0===this.Gr[e][t]||(void 0!==this.Gr[e]&&void 0!==this.Gr[e][t]&&null===this.Gr[e][t].walls||void 0)},G.prototype.bestPath=function(t,e,i){var n=i||this.map;if(void 0!==t&&void 0!==e){var r={diagonal:!1,Pt:this.Pt},o=new d(n,r),a=o.Gr[t.gy][t.gx],s=o.Gr[e.gy][e.gx];return N.search(o,a,s,r)}},G.prototype.isVisible=function(t){for(var i=function(t,e,i,n){for(var r=[],o=Math.abs(i-t),a=i>t?1:-1,s=Math.abs(n-e),l=n>e?1:-1,h=(o>s?o:-s)/2,c=!1;!c;){r.push({x:t,y:e}),t===i&&e===n&&(c=!0);var f=h;f>-o&&(h-=s,t+=a),s>f&&(h+=o,e+=l)}return r}(e(t.x/ot),e(t.y/ot),this.Pl.gx,this.Pl.gy),n=1,r=i.length;r>n;n++)if(0===this.map[i[n].y][i[n].x])return"ghost"===t.type&&(t.vis=!1),!1;return"ghost"===t.type?t.vis=!0:t.A<1-(n-2)/10&&(t.A=1-(n-2)/10),t.seen=!0,!0},G.prototype.render=function(t){for(n in t.save(),t.translate(lt,ht),t.beginPath(),t.rect(0,-ot,23*ot,16*ot),t.clip(),this.sprites){var i=this.sprites[n];"R"===this.pS?(this.isVisible(i),i.seen&&this.heap.push(i)):this.heap.push(i)}for(var n=0,r=this.heap.size();r>n;n++)this.heap.pop().render(t);for(var n in this.tX)this.tX[n].render(t);if(t.restore(),!this.GAME_OVER){t.save();for(n=0,r=this.bTs.length;r>n;n++){var o=this.bTs[n];E("rgba(255,255,255,0.1)"),t.lineWidth=4,A("rgba(255,255,255,0.2)"),t.strokeRect(o.x,o.y,o.w,o.h),t.fillRect(o.x,o.y,o.w,o.h)}t.restore()}t.fontWeight="bold",t.font=e(.75*ot)+"px 'arial black','avenirnext-bold','droid sans'",E("darkslategray"),t.fillText("x",this.exit.x,this.exit.y+.6*ot)},M.prototype.update=function(){},M.prototype.render=function(t){t.save();var e=t.createLinearGradient(0,0,0,1.1*this.Cn.height);if(e.addColorStop(1,"black"),e.addColorStop(0,"midnightblue"),E(e),t.fillRect(0,0,this.Cn.width,this.Cn.height),this.oriented){t.font=2.4*ot+"px 'arial black','avenirnext-bold','droid sans'",E("red");var i="WIZARD  TOWER!",n=this.Cn.width/2-t.measureText(i).width/2;for(var r in t.fillText(i,n,this.Cn.height/4),t.lineWidth=.1*ot,A("orange"),t.strokeText(i,n,this.Cn.height/4),this.backClouds)this.backClouds[r].render(t);for(var r in A("steelblue"),E("yellow"),t.font=4*ot+"px 'arial black','avenirnext-bold','droid sans'",t.fillText("@",17.5*ot,10*ot),t.strokeText("@",17.5*ot,10*ot),this.pacman.render(t),this.tW.render(t),this.clouds)this.clouds[r].render(t);E("rgba(200,0,0,1)"),t.font=ot+"px 'arial black','avenirnext-bold','droid sans'",t.textAlign="middle",t.fillText("A Rogue/Pac-like",7.3*ot,13*ot),t.font=.75*ot+"px 'arial black','avenirnext-bold','droid sans'",t.fillText("JS13K 2015, KeithK",7.8*ot,14*ot),E("black"),t.font=.75*ot+"px 'arial black','avenirnext-bold','droid sans'",t.fillText("Seed: "+O,1.5*ot,13.5*ot),E("black"),A(P(t,L.arrow,3.5*ot,13.5*ot,2*ot)),t.fill(),t.stroke(),P(t,L.arrow,1.5*ot,13.5*ot,2*ot,!0),t.fill(),t.stroke(),A("slategray"),A("cyan"),P(t,L.speaker,21.5*ot,13.5*ot,2*ot),t.stroke()}else{t.font=ot+"px futura",E("red"),t.textAlign="center",u(t,i="Please rotate your device",n=this.Cn.width/2,this.Cn.height/4,.8*this.Cn.width,ot)}A("rgba(255,255,255,0.6)"),t.restore()},window.AudioContext=window.AudioContext||window.webkitAudioContext;var F=new AudioContext;void 0===localStorage.WIZARD_TOWER_HIGH_SCORE&&(localStorage.WIZARD_TOWER_HIGH_SCORE=0);var Y=localStorage.WIZARD_TOWER_HIGH_SCORE,Z=document.createElement("canvas"),B=window.innerHeight,K=window.innerWidth,J=B/480,j=K/720;scl=j>J?J:j,Z.height=480*scl,Z.width=720*scl;var Q=(K-Z.width)/2,$=(B-Z.height)/2;Z.style.margin=$+"px "+Q+"px",document.body.appendChild(Z);var tt=Z.getContext("2d");addEventListener("orientationchange",(function(){Z.height=window.innerHeight,Z.width=window.innerWidth}),!1);var et=!1;"undefined"!=typeof orientation&&(et=!0,scrollTo(0,1));var it,nt=new x,rt=new t(w),ot=e(Math.ceil(Z.height/16)),at=.2,st=250,lt=(Z.width-23*ot)/2,ht=e(.75*(Z.height-15*ot)),ct=localStorage.MUTE;ct=void 0===ct?1:parseInt(ct);var ft=0,ut=1,gt=0,pt=new X;pt.rG("touch",0,(function(){}),(function(){}),(function(){}));var dt=null,vt=null;!function t(){switch(requestAnimationFrame(t),pt.update(),nt.pAnm(),gt){case ft:null===dt&&(dt=new M(Z)),dt.update();break;case ut:vt.update()}!function(){switch(E("black"),tt.fillRect(0,0,Z.width,Z.height),gt){case ft:dt.render(tt);break;case ut:vt.render(tt)}et&&A("black"),this.A>0&&(tt.save(),tt.globalAlpha=this.A,E("black"),tt.fillRect(0,0,Z.width,Z.height),tt.restore())}()}()}()</script>