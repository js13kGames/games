<!doctype html><title>Flow of Four</title><meta name=viewport content="width=device-width,user-scalable=no,minimum-scale=1,maximum-scale=1"><script src=/2020/webxr/aframe.js></script><script>const t=(t,e)=>Math.random()*(t-e)+e,e=(t,e)=>{let s;for(s of t.faces)s.color.set(e)},s=t=>(...e)=>{let s=t.getAttribute("mixin")||"";return t.setAttribute("mixin",[...new Set([...s.split(" "),...e])].join(" ")),i(t)},i=t=>(...e)=>{let i=t.getAttribute("mixin")||"";return t.setAttribute("mixin",i.split(" ").filter((t=>!e.includes(t))).join(" ")),s(t)},a=t=>{t.setAttribute("mixin","")},r=t=>new Promise((e=>setTimeout(e,1e3*t))),n=(t,e,s,i,a)=>(a-i)*(t-e)/(s-e)+i,o=(t,e=8)=>parseFloat("0."+Math.sin(9999*e*t).toString().substr(7)),l=t=>{let e,s,i=document.querySelectorAll(t),a=i.length;for(s=0;s<a;s++)e=i[s],e.parentNode?.removeChild(e),e.destroy()};AFRAME.registerGeometry("ground",{schema:{size:{default:100},resolution:{default:32}},init(t){let{size:e,resolution:s}=t,i=new THREE.PlaneGeometry(e,e,s,s),a=i.vertices,r=i.vertices.length,n=5/s,l=Math.sqrt(r);for(let t=0,e=0,s=0;t<r;t++){let i=o(t)<.35?o(t+1):0;i+=.1*o(t+2);let d=2*e/5-1,h=2*s/5-1;if(i*=d>h?d:h,i<.01&&(i=0),t<l||t>r-l-1)i=0;else{let e=t-l*Math.floor(t/l);0!==e&&e!==l-1||(i=0)}i>1&&(i=1),a[t].z=i,e+=n,e>=10&&(e=0,s+=n)}i.computeFaceNormals(),i.computeVertexNormals(),i.verticesNeedUpdate=!0,i.normalsNeedUpdate=!0,this.geometry=i}}),AFRAME.registerGeometry("kacsa",{init(){let t=new THREE.Color(1942002),s=new THREE.Color(16776960),i=new THREE.Geometry;t.convertSRGBToLinear(),s.convertSRGBToLinear();let a=new THREE.SphereGeometry(1,8,8).translate(0,1.4,0);e(a,t),i.merge(a);let r=new THREE.SphereGeometry(.75,8,8).scale(.75,.75,.75).translate(0,2.8,.33);e(r,t),i.merge(r);let n=new THREE.ConeGeometry(1,2,8).rotateX(Math.PI/1.6).scale(.42,.42,.42).translate(0,2.6,.8);e(n,s),i.merge(n);let o=new THREE.CylinderGeometry(.9,1,.1).rotateX(48).rotateY(8).rotateZ(17).scale(.2,.68,.5).translate(-1.1,1.45,-.2);e(o,t),i.merge(o);let l=new THREE.CylinderGeometry(.9,1,.1).rotateX(48).rotateY(-8).rotateZ(-17).scale(.2,.68,.5).translate(1.1,1.45,-.2);e(l,t),i.merge(l),i.scale(.15,.15,.15),i.rotateY(Math.PI),this.geometry=i}}),AFRAME.registerGeometry("oak",{schema:{knot:{default:!1}},init(s){let i=new THREE.Geometry,a=t(7,9),r=new THREE.Color(7086772),o=new THREE.Color(3161154),l=new THREE.Color(2236979);r.convertSRGBToLinear(),o.convertSRGBToLinear(),l.convertSRGBToLinear();let d=s.knot?new THREE.TorusKnotGeometry(10,1.5,67,7,8,6).scale(.2,.1,.1):new THREE.SphereGeometry(2,7,8);e(d,s.knot?r:o),d.translate(0,a,0),i.merge(d),((t,e)=>{t.vertices.forEach((t=>{t.x+=n(Math.random(),0,1,-e,e),t.y+=n(Math.random(),0,1,-e,e),t.z+=n(Math.random(),0,1,-e,e)}))})(d,.2),((t,e)=>{t.vertices.forEach((t=>t.y=Math.max(t.y,-.5)))})(d),d.computeFlatVertexNormals();let h=new THREE.CylinderGeometry(t(.1,.3),t(.2,.4),a,32);e(h,l),h.translate(0,a/2,0),i.merge(h),this.geometry=i}}),AFRAME.registerGeometry("pine",{init(){let s,i=new THREE.Geometry,a=t(4,6),r=Array.from({length:a},(()=>t(2,4))),n=new THREE.Color(39168),o=new THREE.Color(724482);for(n.convertSRGBToLinear(),o.convertSRGBToLinear(),s=0;s<a-2;s++){let t=new THREE.ConeGeometry(1.5+.5*s,r.pop(),8);e(t,n),t.translate(0,r.reduce(((t,e)=>t+e),0)-r.length,0),i.merge(t)}let l=new THREE.CylinderGeometry(.5,.5,r.pop());e(l,o),l.translate(0,0,0),i.merge(l),this.geometry=i}}),AFRAME.registerComponent("handy",{hands:{left:0,right:0},play(){let{el:t}=this;t.addEventListener("raycaster-intersected",this.rayIn.bind(this)),t.addEventListener("raycaster-intersected-cleared",this.rayOut.bind(this)),t.addEventListener("hand",this.inHand.bind(this)),t.addEventListener("stateadded",this.setMixins.bind(this)),t.addEventListener("stateremoved",this.setMixins.bind(this)),this.setMixins()},pause(){let{el:t}=this;t.removeEventListener("raycaster-intersected",this.rayIn),t.removeEventListener("raycaster-intersected-cleared",this.rayOut),t.removeEventListener("hand",this.inHand),t.removeEventListener("stateadded",this.setMixins),t.removeEventListener("stateremoved",this.setMixins)},setMixins(){let t,{el:e}=this;e.is("hold")?(e.object3D.scale.set(1,1,1),t=i(e),t("pulse"),t("fastanim")):(t=s(e),t("pulse"),e.is("intersect")&&t("fastanim"))},inHand({detail:t}){this.el[t?"addState":"removeState"]("hold")},rayIn({detail:t}){let e=t.el.components["hand-controls"];e&&(this.hands[e.data.hand]=1,this.el.addState("intersect"))},rayOut({detail:t}){let e=t.el.components["hand-controls"];e&&(this.hands[e.data.hand]=0,0===this.hands.left&&0===this.hands.right&&this.el.removeState("intersect"))}}),AFRAME.registerComponent("bouncy",{schema:{width:{default:5},velocity:{type:"vec2",default:{x:.03,y:.3}},mass:{default:.1},radius:{default:.2},restitution:{default:-.7},Cd:{default:.47},rho:{default:.122},A:{default:0},ag:{default:-9.81}},init(){let{data:t}=this;t.A=Math.PI*t.radius*t.radius/1e4},tick(t,e){let{data:s}=this,i=-.5*s.Cd*s.A*s.rho*s.velocity.x*s.velocity.x*s.velocity.x/Math.abs(s.velocity.x),a=-.5*s.Cd*s.A*s.rho*s.velocity.y*s.velocity.y*s.velocity.y/Math.abs(s.velocity.y);i=isNaN(i)?0:i,a=isNaN(a)?0:a;let r=i/s.mass,n=s.ag+a/s.mass,o=this.el.object3D.position,l=s.velocity;l.x+=.001*r,l.y+=.001*n,o.x+=l.x*e*.01,o.y+=l.y*e*.01,o.y<s.radius&&(l.y*=s.restitution,o.y=s.radius),o.x>s.width&&(l.x*=s.restitution,o.x=s.width-s.radius),o.x<-s.width&&(l.x*=s.restitution,o.x=-s.width+s.radius)}});let d={lambert:new THREE.MeshLambertMaterial({vertexColors:!0}),phong:new THREE.MeshPhongMaterial({vertexColors:!0,flatShading:!0}),toon:new THREE.MeshToonMaterial({color:"#d5ff80",vertexColors:!0})};AFRAME.registerComponent("mat",{schema:{default:"lambert"},init(){let t=d[this.data];this.el.getObject3D("mesh").material=t}}),AFRAME.registerComponent("gmat",{dependencies:["geometry"],schema:{size:{default:100},c1:{type:"color",default:"#0f0"},c2:{type:"color",default:"#000"},offset:{type:"vec2",default:{x:0,y:0}}},sv:new THREE.Vector2,init(){this.mesh=this.el.getObject3D("mesh"),this.mesh.material=this.getMaterial()},update(t){let{el:e,data:s}=this;s.c1===t.c1&&s.c2===t.c2||(e.getObject3D("mesh").material=this.getMaterial()),t.offset&&s.offset.x===t.offset.x&&s.offset.y===t.offset.y||this.mesh.material.map.offset.set(s.offset.x,s.offset.y)},getMaterial(t=!1,e=2048,s=20){let i=this.data.size/s,a=document.createElement("canvas");a.width=e,a.height=e;let r=new THREE.Texture(a);r.wrapS=THREE.RepeatWrapping,r.wrapT=THREE.RepeatWrapping,r.repeat.set(i,i);let n=new THREE.MeshLambertMaterial({map:r,wireframe:t});return this.drawTexture(a.getContext("2d"),e),r.needsUpdate=!0,n},drawTexture(t,e){let{data:s}=this;t.fillStyle=s.c1,t.fillRect(0,0,e,e);let i,a,r,n,o=new THREE.Color(s.c1),l=new THREE.Color(s.c2),d=Math.floor(e/2),h=document.createElement("canvas");h.width=d,h.height=d;let c=h.getContext("2d");c.fillStyle=o,c.fillRect(0,0,d,d),n=c.getImageData(0,0,d,d),r=n.data;let u=[];for(i=0;i<1e3;i++)a=o.clone().lerp(l,Math.random()),a.convertSRGBToLinear(),u.push({x:Math.random()*d,y:Math.random()*d,r:Math.floor(255*a.r),g:Math.floor(255*a.g),b:Math.floor(255*a.b)});for(let t=0;t<5e3;t++)for(i=0;i<1e3;i++){let t=u[i],e=4*Math.floor(t.y*d+t.x);r[e+0]=t.r,r[e+1]=t.g,r[e+2]=t.b,t.x+=Math.floor(3*Math.random())-1,t.y+=Math.floor(3*Math.random())-1,t.x>=d&&(t.x=t.x-d),t.y>=d&&(t.y=t.y-d),t.x<0&&(t.x=d+t.x),t.y<0&&(t.y=d+t.y)}c.putImageData(n,0,0),t.drawImage(h,0,0,e,e)}});const h=(t,e,s)=>Math.abs(t.x-e.x)<s&&Math.abs(t.y-e.y)<s&&Math.abs(t.z-e.z)<s;AFRAME.registerComponent("ibidem",{schema:{target:{type:"selector",default:"#stux"},posTolerance:{default:.2},rotTolerance:{default:.5}},init(){this.tick=AFRAME.utils.throttleTick(this.tick,100,this)},tick(){let{el:t,data:e}=this;h(t.object3D.position,e.target.object3D.position,e.posTolerance)&&h(t.object3D.rotation,e.target.object3D.rotation,e.rotTolerance)&&t.emit("introDone")}}),AFRAME.registerComponent("audio-listener",{init(){let t=this.el.sceneEl,e=t.audioListener||new THREE.AudioListener;t.audioListener=e,"suspended"===e.context.state?(["click","keypress"].forEach((t=>document.addEventListener(t,(()=>{e.context.resume()}),{once:!0}))),e.context.addEventListener("statechange",this.contextActive.bind(this),{once:!0})):this.contextActive()},contextActive(){let t=this.el.sceneEl;t.addEventListener("camera-set-active",this.toCam.bind(this)),t.camera&&t.dispatchEvent(new CustomEvent("camera-set-active",{detail:{cameraEl:t.camera.el}}))},toCam(t){let e=this.el.sceneEl;t.detail.cameraEl.getObject3D("camera").add(e.audioListener),e.emit("audio-listener-active",e.audioListener)},remove(){this.el.sceneEl.removeEventListener("camera-set-active",this.toCam)}}),AFRAME.registerComponent("analyser",{dependencies:["pos-audio"],schema:{fftSize:{default:512,oneOf:[32,64,128,256,512,1024,2048,4096,8192,16384,32768]},length:{type:"number",default:10},width:{type:"number",default:2},lag:{default:100}},nextFFT(){this.el.setAttribute(this.attrName,{fftSize:Math.pow(2,Math.max((Math.log2(this.data.fftSize)+1)%16,5))})},init(){this.el.addEventListener("pos-audio-active",this.setup.bind(this)),this.data.lag&&(this.tick=AFRAME.utils.throttleTick(this.tick,100,this))},setup({detail:t}){this.analyser=t.context.createAnalyser(),t.getOutput().connect(this.analyser),this.lineObj=new THREE.Line(new THREE.BufferGeometry,new THREE.LineBasicMaterial({color:"#ff0"})),this.el.setObject3D("line",this.lineObj),this.update({}),this.audio=t},update(t){!this.analyser||this.data.fftSize===t.fftSize&&this.data.length===t.length||(this.analyser.fftSize=this.data.fftSize,this.bufferLength=this.analyser.frequencyBinCount,this.sliceLength=this.data.length/this.bufferLength,this.tddata=new Float32Array(this.bufferLength),this.lineObj.geometry.setAttribute("position",new THREE.BufferAttribute(new Float32Array(3*this.bufferLength),3))),this.halfWidth=this.data.width/2},tick(t){if(!this.audio)return;if(this.data.lag){let e=Math.round(t/100);if(e===this.lastTime)return;this.lastTime=e}let{exe:e}=this.el.object3D.parent.userData,s=void 0!==e?e.value:0;0===s?this.tddata.fill(0):this.analyser.getFloatTimeDomainData(this.tddata),this.audio.gain.gain.setValueAtTime(s,0);let i,a=this.lineObj.geometry.attributes.position,r=a.array,n=0;for(i=0;i<this.bufferLength;i++)r[n++]=Math.random()/16-.04,r[n++]=this.tddata[i]*this.halfWidth,r[n++]=-this.sliceLength*i*s;a.needsUpdate=!0}}),AFRAME.registerComponent("oscillator",{dependencies:["pos-audio"],multiple:!0,schema:{frequency:{type:"number",default:440},detune:{type:"number",default:0},type:{default:"sine"},playSound:{default:!1}},init(){let t=this.el;t.addEventListener("pos-audio-active",this.setup.bind(this)),t.addEventListener("stateadded",(({detail:t})=>{"exe"===t&&this.start()})),t.addEventListener("stateremoved",(({detail:t})=>{"exe"===t&&this.stop()}))},setup({detail:t}){this.audio=t},start(){this.audio&&(this.oscillator=this.audio.context.createOscillator(),this.oscillator.frequency.setValueAtTime(this.data.frequency,0),this.oscillator.detune.setValueAtTime(this.data.detune,0),this.audio.setNodeSource(this.oscillator),this.oscillator.start())},stop(){this.oscillator?.stop(),this.oscillator?.disconnect()}}),AFRAME.registerComponent("pos-audio",{init(){this.el.sceneEl.addEventListener("audio-listener-active",this.setup.bind(this))},setup({detail:t}){const e=new THREE.PositionalAudio(t);this.el.posAudio=e,this.el.emit("pos-audio-active",e)}}),AFRAME.registerComponent("water",{schema:{size:{type:"vec2",default:{x:100,y:30}}},init(){const t=new THREE.MeshPhongMaterial({color:2263295,shininess:100});t.onBeforeCompile=t=>{t.uniforms.time={value:0},t.vertexShader="\n          uniform float time;\n      "+t.vertexShader,t.vertexShader=t.vertexShader.replace("#include <begin_vertex>","\n          vec3 transformed = vec3(position);\n          float freq = 3.0;\n          float amp = 0.1;\n          float angle = (time + position.x)*freq;\n          transformed.z += sin(angle)*amp;\n      "),this.matShader=t};const e=new THREE.Mesh(new THREE.PlaneBufferGeometry(this.data.size.x,this.data.size.y,1,1),t);e.rotation.x=-90*Math.PI/180,this.el.setObject3D("mesh",e)}}),AFRAME.registerComponent("stars",{schema:{distance:{default:80},color:{type:"color",default:"#daa520"},size:{default:2.2},count:{default:200}},init(){let t,e,s=this.data,i=new THREE.Geometry;for(var a=0;a<s.count;a++)t=THREE.Math.randFloatSpread(360),e=THREE.Math.randFloatSpread(360),i.vertices.push(new THREE.Vector3(s.distance*Math.sin(t)*Math.cos(e),Math.abs(s.distance*Math.sin(t)*Math.sin(e)),s.distance*Math.cos(t)));this.m=new THREE.PointsMaterial({fog:!1,sizeAttenuation:!1}),this.ps=new THREE.Points(i,this.m),this.ps.boundingSphere=120,this.el.setObject3D("stars",this.ps)},update(){this.color=new THREE.Color(this.data.color),this.m.setValues({color:this.color,size:this.data.size})}}),AFRAME.registerComponent("obstacle-stop",{dependencies:["raycaster"],schema:{target:{type:"selector"},obstacle:{type:"selector",default:"[data-obstacle]"},dirY:{default:2}},zm:()=>new THREE.Vector3,o:null,d:null,update(){this.data.target||(this.data.target=this.el.parentEl)},play(){this.wasd=this.data.target.components["wasd-controls"],this.om=this.wasd.getMovementVector,this.el.addEventListener("raycaster-intersection",this.stopMove.bind(this)),this.el.addEventListener("raycaster-intersection-cleared",this.startMove.bind(this))},pause(){this.wasd=void 0,this.el.removeEventListener("raycaster-intersection",this.stopMove),this.el.removeEventListener("raycaster-intersection-cleared",this.startMove)},stopMove(){this.wasd.getMovementVector=this.zm},startMove(){this.wasd.getMovementVector=this.om},tick(){if(!this.wasd)return;let t=this.wasd.velocity;0===t.x&&0===t.z||(this.o=t.clone(),this.o.normalize().divideScalar(4),this.d=this.o.clone(),this.d.divideScalar(2),this.d.y=this.data.dirY,this.el.setAttribute("raycaster",{origin:this.o,direction:this.d}))}}),AFRAME.registerComponent("wasd-ext",{dependencies:["wasd-controls"],schema:{turn:{default:.001},avatar:{type:"selector",default:"#avatar"},playerCam:{type:"selector",default:".camera"},enabled:{default:!0}},t:0,turn:0,camUp:!1,doRot:!0,play(){window.addEventListener("keydown",this.onKeyDown.bind(this)),window.addEventListener("keyup",this.onKeyUp.bind(this)),this.el.sceneEl.addEventListener("enter-vr",this.toVR.bind(this)),this.el.sceneEl.addEventListener("exit-vr",this.exVR.bind(this))},pause(){clearTimeout(this.t),window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp),this.el.sceneEl.removeEventListener("enter-vr",this.toVR),this.el.sceneEl.removeEventListener("exit-vr",this.exVR)},toVR(){this.data.playerCam.object3D.children[0].el.emit("enter-vr",null,!1)},exVR(){this.data.playerCam.object3D.children[0].el.emit("exit-vr",null,!1)},cam(t){this.data.playerCam.object3D.el.emit(t?"u":"d"),this.t=setTimeout((()=>{this.data.avatar.setAttribute("visible",t),this.el.children[0]?.setAttribute("raycaster","showLine",t)}),200)},onKeyDown({key:t}){if(this.data.enabled)if(["q","e"].includes(t))this.turn="q"===t?1:-1;else if(["Q","E"].includes(t)&&this.dorot){let e=Math.PI/5;"E"===t&&(e*=-1),this.el.object3D.rotation.y+=e,this.dorot=!1}else"c"===t&&(this.camUp=!this.camUp,this.cam(this.camUp))},onKeyUp({key:t}){["q","e","Q","E"].includes(t)&&(this.turn=0,["Q","E"].includes(t)&&(this.dorot=!0))},tick(t,e){this.data.enabled&&(this.el.object3D.rotation.y+=this.data.turn*this.turn*e)},update({enabled:t}){let{el:e,data:s}=this;s.enabled!==t&&e.components["wasd-controls"]&&(e.setAttribute("wasd-controls","enabled",t),t||(this.turn=0))}}),AFRAME.registerComponent("wasd-vr",{dependencies:["raycaster"],schema:{action:{default:"move"},run:{default:2},target:{type:"selector"},zombody:{type:"selector"},hand:{type:"string"}},intersections:[],uuids:[],update(t){let{data:e}=this;e.zombody!==t.zombody&&e.zombody?(this.rmWasd(),e.target&&e.target.setAttribute("wasd-ext","enabled",!1),e.zombody.hasLoaded?this.addWasd(e.zombody):e.zombody.addEventListener("loaded",this.addWasd.bind(this,e.zombody))):e.target&&(t.target&&this.rmControls(),e.target.setAttribute("wasd-ext","enabled",!0),e.target.hasLoaded?this.addControls():e.target.addEventListener("loaded",this.addControls.bind(this)))},play(){let{el:t,data:e}=this;e.target&&!e.zombody&&(t.addEventListener("raycaster-intersection",this.rayIn.bind(this)),t.addEventListener("raycaster-intersection-cleared",this.rayOut.bind(this)),t.addEventListener("stateadded",this.newState.bind(this)),t.addEventListener("stateremoved",this.delState.bind(this)),t.addEventListener("controllerconnected",this.ctrlConn.bind(this)),t.addEventListener("controllerdisconnected",this.ctrlDisconn.bind(this)))},pause(){let{el:t}=this;t.removeEventListener("raycaster-intersection",this.rayIn),t.removeEventListener("raycaster-intersection-cleared",this.rayOut),t.removeEventListener("stateadded",this.newState),t.removeEventListener("stateremoved",this.delState),t.removeEventListener("controllerconnected",this.ctrlConn),t.removeEventListener("controllerdisconnected",this.ctrlDisconn)},rayIn(){this.intersections=this.el.components.raycaster.intersections},rayOut(){this.intersections=[]},newState({detail:t}){switch(t){case"connected":this.data.target?.hasLoaded&&this.addControls();break;case"hold":let t,e,s;for(t of this.intersections)s=t.object.parent,"Group"!==s.type&&(s=s.parent),e=s.el.object3D,this.uuids.push(e.uuid),this.el.object3D.attach(e),e.children[0].el.emit("hand",!0);break;case"exe":let i;for(i of this.el.object3D.children)this.uuids.includes(i.uuid)&&i.el.addState("exe")}},delState({detail:t}){switch(t){case"run":"turn"===this.data.action&&this.ext&&(this.ext.turn=0);break;case"connected":this.rmControls();break;case"hold":let t=this.uuids.length;for(;t--;){let e=this.el.object3D.children.find((e=>e.uuid===this.uuids[t]));e&&(this.uuids.splice(t,1),this.el.sceneEl.object3D.attach(e),e.children[0].el.emit("hand",!1))}break;case"exe":let e;for(e of this.el.object3D.children)this.uuids.includes(e.uuid)&&e.el.removeState("exe")}},ctrlConn(){this.el.addState("connected")},ctrlDisconn(){this.el.removeState("connected")},move(t,e){if(!this.wasd)return;let s={};e<0?s.KeyW=1:e>0&&(s.KeyS=1),t<0?s.KeyA=1:t>0&&(s.KeyD=1),this.wasd.data.acceleration=Math.max(Math.abs(e),Math.abs(t))*(this.acceleration*(this.el.is("run")?this.data.run:1)),this.wasd.keys=s},turn(t){this.ext&&(0===t?(this.ext.turn=0,window.dispatchEvent(new KeyboardEvent("keyup",{key:"Q"}))):this.el.is("run")?this.ext.turn=-t:window.dispatchEvent(new KeyboardEvent("keydown",{key:t<0?"Q":"E"})))},addWasd(t){t&&(this.ext=t.components["wasd-ext"],this.wasd=t.components["wasd-controls"],this.wasd&&(this.acceleration=this.wasd.data.acceleration))},rmWasd(){this.wasd&&this.acceleration&&(this.wasd.data.acceleration=this.acceleration),this.wasd=void 0,this.ext=void 0},addControls(){let{el:t,data:e}=this;this.addWasd(e.target),t.addEventListener("buttonchanged",this.btnChg.bind(this)),t.addEventListener("axismove",this.axMv.bind(this)),t.setAttribute("raycaster",{enabled:!0})},rmControls(){let{el:t}=this;this.rmWasd(),t.removeEventListener("buttonchanged",this.btnChg),t.removeEventListener("axismove",this.axMv),t.setAttribute("raycaster",{enabled:!1})},btnChg({detail:t}){let e,{el:s}=this,i=t.state.pressed?"addState":"removeState";try{e=this.mapping().buttons[t.id]}catch{e=["thumbstick","trigger","grip"][t.id]}switch(e){case"thumbstick":s[i]("run");break;case"grip":s[i]("hold");break;case"trigger":s[i]("exe"),s.object3D.userData.exe=t.state}},axMv({detail:{axis:t}}){try{let[e,s]=Object.values(this.mapping().axes)[0];this[this.data.action](t[e],t[s])}catch{this[this.data.action](t[0],t[1])}},mapping(){let{id:t,hand:e}=this.el.components["tracked-controls"].data;return this.el.components[t+"-controls"].mapping[e]}});const c=t=>{for(var e,s,i,a=0,r=0;r<t.length;++r){var n=t[r];if(n.isInterleavedBufferAttribute)return null;if(void 0===e&&(e=n.array.constructor),e!==n.array.constructor)return null;if(void 0===s&&(s=n.itemSize),s!==n.itemSize)return null;if(void 0===i&&(i=n.normalized),i!==n.normalized)return null;a+=n.array.length}var o=new e(a),l=0;for(r=0;r<t.length;++r)o.set(t[r].array,l),l+=t[r].array.length;return new THREE.BufferAttribute(o,s,i)},u=(t,e=0)=>{for(var s=null!==t[0].index,i=new Set(Object.keys(t[0].attributes)),a=new Set(Object.keys(t[0].morphAttributes)),r={},n={},o=t[0].morphTargetsRelative,l=new THREE.BufferGeometry,d=0,h=0;h<t.length;++h){var u=t[h],m=0;if(s!==(null!==u.index))return null;for(var v in u.attributes){if(!i.has(v))return null;void 0===r[v]&&(r[v]=[]),r[v].push(u.attributes[v]),m++}if(m!==i.size)return null;if(o!==u.morphTargetsRelative)return null;for(var v in u.morphAttributes){if(!a.has(v))return null;void 0===n[v]&&(n[v]=[]),n[v].push(u.morphAttributes[v])}if(l.userData.mergedUserData=l.userData.mergedUserData||[],l.userData.mergedUserData.push(u.userData),e){var y;if(s)y=u.index.count;else{if(void 0===u.attributes.position)return null;y=u.attributes.position.count}l.addGroup(d,y,h),d+=y}}if(s){var p=0,f=[];for(h=0;h<t.length;++h){for(var b=t[h].index,E=0;E<b.count;++E)f.push(b.getX(E)+p);p+=t[h].attributes.position.count}l.setIndex(f)}for(var v in r){var g=c(r[v]);if(!g)return null;l.setAttribute(v,g)}for(var v in n){var w=n[v][0].length;if(0===w)break;for(l.morphAttributes=l.morphAttributes||{},l.morphAttributes[v]=[],h=0;h<w;++h){var A=[];for(E=0;E<n[v].length;++E)A.push(n[v][E][h]);var x=c(A);if(!x)return null;l.morphAttributes[v].push(x)}}return l};AFRAME.registerSystem("forest",{schema:{trees:{default:20},width:{default:100},gap:{default:10}},r:88343,init(){this.el.addEventListener("secretforest",this.deploy.bind(this),{once:!0})},deploy(){let t,e,s,i,a,{el:r,data:n}=this;const l=()=>{let s=++this.r;return t=30*o(s+1)+o(s+2)*this.data.width/3,e=o(s+3)*Math.PI*2,[Math.cos(e)*t,0,Math.sin(e)*t]};for(i of["knot","oak","pine"])if(s=r.components["pool__"+i],s.availableEls.length>0){let t=[],e=s.requestEntity().getObject3D("mesh"),i=e.geometry;for(a=0;a<n.trees;a++)t.push(i.clone().translate(...l()));let o=u(t),d=new THREE.Mesh(o,e.material),h=document.createElement("a-entity");h.setObject3D("mesh",d),h.setAttribute("class","forest"),r.appendChild(h),s.returnEntity(void 0)}}}),AFRAME.registerSystem("zoo",{kacsas:[],kacsa(){let e=this.el.components.pool__kacsa;if(e&&e.availableEls.length>0){let e=this.el.components.pool__kacsa.requestEntity();return e.play(),e.object3D.position.set(t(-5,5),t(-3,6),t(-8,-2)),this.kacsas.push(e),e}},retk(){for(;this.kacsas.length>0;)this.el.components.pool__kacsa.returnEntity(this.kacsas.pop())}}),AFRAME.registerSystem("story",{schema:{l:{type:"selector",default:"#l"},r:{type:"selector",default:"#r"},stars:{type:"selector",default:".stars"},ground:{type:"selector",default:".ground"},title:{type:"selector",default:".title"},msg:{type:"selector",default:".msg"},tux:{type:"selector",default:"#tux"},stux:{type:"selector",default:"#stux"},box:{type:"selector",default:".box"},player:{type:"selector",default:"#player"}},novrListener(){this.data.player.object3D.position.y=1.6,this.noNovr(),this.el.addState("novr"),this.el.dispatchEvent(new CustomEvent("enter-vr"))},noNovr(){clearTimeout(this.t),window.removeEventListener("novr",this.novrListener.bind(this)),document.querySelector(".novr").remove()},novr(){window.addEventListener("novr",this.novrListener.bind(this)),this.t=setTimeout(this.noNovr.bind(this),8e3)},hasControllers(){return this.data.l.is("connected")&&this.data.r.is("connected")||this.el.is("novr")},s:1,next(){window.addEventListener("keydown",(t=>{if("n"===t.key)try{this["s"+ ++this.s]()}catch{this.s=0}}))},init(){let{el:t,data:e}=this;this.novr(),this.next(),t.addEventListener("loaded",(()=>{this.zoo=t.systems.zoo,this.pAM=s(e.player),this.pDM=i(e.player),this.elAM=s(t),this.elDM=i(t),this.stAM=s(e.stars),this.stDM=i(e.stars),this.grAM=s(e.ground),this.grDM=i(e.ground),t.addEventListener("enter-vr",this.s1.bind(this),{once:!0}),t.addEventListener("exit-vr",location.reload)}))},async s1(){this.elDM("elstart")("eldark"),this.data.ground.setAttribute("visible",!0),this.data.stars.setAttribute("visible",!0),await r(5),this.hasControllers()||(this.data.msg.setAttribute("visible","true"),await r(2),await this.s1_checkControllers(),this.data.msg.setAttribute("visible","false")),this.s2()},async s1_checkControllers(){return new Promise((t=>{let{l:e,r:s}=this.data;e.addEventListener("stateadded",this.s1_chkCtrls.bind(this,t)),e.addEventListener("stateremoved",this.s1_chkCtrls.bind(this,t)),s.addEventListener("stateadded",this.s1_chkCtrls.bind(this,t)),s.addEventListener("stateremoved",this.s1_chkCtrls.bind(this,t))}))},s1_chkCtrls(t){if(this.hasControllers()){let{l:e,r:s}=this.data;return e.removeEventListener("stateadded",this.s1_checkControllers),e.removeEventListener("stateremoved",this.s1_checkControllers),s.removeEventListener("stateadded",this.s1_checkControllers),s.removeEventListener("stateremoved",this.s1_checkControllers),t()}},async s2(){let{player:t,l:e,r:i,tux:a,stux:n}=this.data;e.setAttribute("wasd-vr","zombody",a),i.setAttribute("wasd-vr","zombody",a),this.data.title.setAttribute("visible","true"),this.elAM("fogin"),await r(2),s(this.data.title)("rotmov"),this.grDM("grdark")("grsea","grstream"),await r(1),t.object3D.rotateY(0),this.el.is("novr")||t.object3D.position.set(0,-.5,2.5),this.elAM("fogout"),await r(3),a.setAttribute("visible",!0),n.setAttribute("visible",!0),this.data.title.setAttribute("visible","false"),this.t=setTimeout((()=>{this.data.msg.setAttribute("text","value","Use the controller, try to grab and match!"),this.data.msg.setAttribute("visible","true"),this.t=setTimeout((()=>{this.data.msg.setAttribute("visible","false")}),5e3)}),5e3),this.el.addEventListener("introDone",this.s3.bind(this),{once:!0})},async s3(){clearTimeout(this.t),this.data.msg.setAttribute("visible","false");let t,{player:e,tux:s,stux:i,l:a,r:n}=this.data;for(e.object3D.rotateY(0),l("#stux"),l("#tux"),a.setAttribute("wasd-vr","zombody",null),n.setAttribute("wasd-vr","zombody",null),a.setAttribute("wasd-vr","target","#player"),n.setAttribute("wasd-vr","target","#player"),this.el.is("novr")||e.object3D.position.set(0,0,-1),this.grDM("grstream")("grstreamgo"),this.elDM("eldark")("elsunny"),t=0;t<9;t++)this.zoo.kacsa()?.object3D.rotateY(135),await r(.5);await r(2),this.grAM("para"),await r(2),this.s4()},async s4(){this.zoo.retk(),this.data.ground.setAttribute("rotation","-90  0  0"),this.data.ground.setAttribute("position","0  0  0"),this.data.stars.setAttribute("visible",!1),this.grDM("para","grsea","grstreamgo")("grgreen"),l(".intro"),this.elAM("fogout"),await r(5),this.grAM("para"),await r(2),this.s5()},async s5(){let{ground:t}=this.data;t.setAttribute("rotation",{x:-90,y:0,z:0}),t.setAttribute("position",{x:0,y:0,z:0});let e,s=document.querySelectorAll(".w"),i=s.length;for(e=0;e<i;e++)s[e].setAttribute("visible","true");this.data.player.object3D.position.set(-30,1.6,-30),a(this.el),a(t),this.grAM("grweed"),this.elAM("ellila","fogfar"),this.el.systems.forest.el.dispatchEvent(new CustomEvent("secretforest")),this.elAM("fogout"),t.setAttribute("visible","true")}})</script><style>body,html{width:100vw;height:100vh;padding:0;margin:0}body{background:linear-gradient(#24a3b5,#40320a)}.a-enter-vr-button{min-width:116px;min-height:68px}.novr{position:absolute;bottom:15px;left:15px;font-size:32px;font-weight:700;opacity:.5}</style><body><a-scene renderer="alpha: false; colorManagement: true; antialias: false; logarithmicDepthBuffer: false; physicallyCorrectLights: true: precision: low" pool__kacsa="mixin: kacsa; size: 10" pool__oak="mixin: oak; size: 2" pool__knot="mixin: knot; size: 2" pool__pine="mixin: pine; size: 2" audio-listener shadow="type: pcfsoft" fog="type: 'exponential'" mixin=elstart><a-assets><a-mixin id=pulse animation="property: scale; to: 1.2 1.2 1.2; dur: 404; loop: true; dir: alternate"></a-mixin><a-mixin id=fastanim animation="dur: 150"></a-mixin><a-mixin id=fogin animation__n="property: fog.near; from: 5; to: 0; dur: 1500; loop: 0; easing: linear" animation="property: fog.far; from: 25; to: 0; dur: 1500; loop: 0; easing: linear"></a-mixin><a-mixin id=fogout animation__n="property: fog.near; from: 5; to: 0; dur: 1500; dir: reverse; loop: 0; easing: linear" animation="property: fog.far; from: 25; to: 0; dur: 1500; dir: reverse; loop: 0; easing: linear"></a-mixin><a-mixin id=kacsa geometry="primitive: kacsa" mat=lambert animation="property: scale; to: 2 2 2; dur: 850; loop: true; dir: alternate; easing: easeOutElastic" rotation="0 180 0" shadow bouncy handy></a-mixin><a-mixin id=rotmov animation__m="property: position; to: -1 0 0; dur: 1500; loop: 0" animation="property: rotation; to: 90; dur: 1500; loop: 0"></a-mixin><a-mixin id=oak geometry="primitive: oak" mat=phong></a-mixin><a-mixin id=knot geometry="primitive: oak;knot: true" mat=phong></a-mixin><a-mixin id=pine geometry="primitive: pine" mat=toon></a-mixin><a-mixin id=fogmid fog="near: 5; far: 25;"></a-mixin><a-mixin id=fogfar fog="near: 20; far: 40;"></a-mixin><a-mixin id=elstart background="color: #1c1c1b"></a-mixin><a-mixin id=eldark background="color: #000" fog="color: #000"></a-mixin><a-mixin id=elsunny background="color: #24a3b5" fog="color: #24a3b5"></a-mixin><a-mixin id=ellila background="color: #303c42" fog="color: #303c42"></a-mixin><a-mixin id=grstream animation="property: gmat.offset; to: 0 -100; dur: 500000; loop: true"></a-mixin><a-mixin id=grstreamgo animation="property: gmat.offset; to: 0 100; dur: 100000; loop: true" animation__m="property: position; from: 0 0 -30; to: 0 0 30; dur: 3000; loop: true; easing: linear"></a-mixin><a-mixin id=para animation="property: rotation; to: -145 0 0; dur: 2000; loop: 0; easing: easeInQuint" animation__p="property: position; to: 0 -8 20; dur: 2000; loop: 0; easing: easeInQuint"></a-mixin><a-mixin id=grdark gmat="c1: #060a03; c2: #0e0d00"></a-mixin><a-mixin id=grsea gmat="c1: #13f; c2: #000"></a-mixin><a-mixin id=grweed gmat="c1: #499d45; c2: #000"></a-mixin><a-mixin id=grgreen gmat="c1: #836a14; c2: #060"></a-mixin></a-assets><a-entity class=stars visible=false material="fog: false" stars></a-entity><a-entity class=ground visible=false geometry="primitive: ground" shadow="cast: false" rotation="-90 0 0" mixin=grdark></a-entity><a-entity class=w visible=false water="size: 100 80" position="0 0 -90"></a-entity><a-entity class=w visible=false water="size: 100 80" position="0 0 90"></a-entity><a-entity class=w visible=false water="size: 80 100" position="-90 0 0"></a-entity><a-entity class=w visible=false water="size: 80 100" position="90 0 0"></a-entity><a-entity id=ambient light="type: ambient; color: #404; intensity: 0.3"></a-entity><a-entity id=hemi light="type: hemisphere; color: #303c42; groundColor: #39FF14; intensity: 0.5"></a-entity><a-entity light="type: directional; castShadow: true; intensity: 1.4; shadowCameraVisible: false;" position="-5 3 1.5"></a-entity><a-entity id=sun geometry="primitive: sphere; radius: 2.5; segmentsWidth: 16; segmentsHeight: 2" material="fog: false; shader: flat; color: #fff888" light="type: directional; color: #ffffff; intensity: 0.5; castShadow: true; target: #t;" position="0 50 30"></a-entity><a-entity id=t position="0 -5 -50"></a-entity><a-entity id=player wasd-ext><a-entity raycaster="far: 2; objects: [data-obstacle]" obstacle-stop></a-entity><a-entity class=camera look-controls camera="far: 200" position="0 1.6 0" animation="property: position; to: 0 9 9; startEvents: u; dur: 300" animation__p="property: position; to: 0 1.6 0; startEvents: d; dur: 300"><a-entity class=intro position="0 0.01 -0.08" text__s="font: roboto; align: center; color: #000; letter-spacing: 0; width: 0.65; value: Enter VR" text="font: roboto; align: center; color: #B0B8B4; letter-spacing: -1; width: 0.66; value: Enter VR" animation="property: visible; from: true; to: false; startEvents: enter-vr; resumeEvents: exit-vr" animation__t="property: text.opacity; from: 0; to: 1; dur: 1200; dir: alternate; loop: true; easing: easeInOutBack" animation__s="property: text__s.opacity; from: 0; to: 1; dur: 1200; dir: alternate; loop: true; easing: easeInOutBack"></a-entity><a-entity class=msg visible=false text="font: roboto; color: #ff9933; align: center; value: Waiting for Controllers; align: center" scale="2 2 1" position="0 0.1 -1.3"></a-entity></a-entity><a-entity id=l hand-controls="hand: left; color: #0cca71" raycaster="far: 0.15; direction: 1 0 0; objects: [handy]; showLine: true" wasd-vr="hand: left; target: #player; action: move"></a-entity><a-entity id=r hand-controls="hand: right; color: #0cca71" raycaster="far: 0.15; direction: -1 0 0; objects: [handy]; showLine: true;" wasd-vr="hand: right; target: #player; action: turn"></a-entity><a-box id=avatar visible=false color=lime width=0.5 height=1.8 depth=0.3 position="0 0.9 0" shadow></a-box></a-entity><a-entity id=stux visible=false geometry="primitive: kacsa" material="shader: flat; color: #404;" position="0 1.2 -3"></a-entity><a-entity id=tux visible=false wasd-ext geometry="primitive: kacsa" mat=lambert position="0 0.25 -2" rotation="0 180 0" shadow="receive: false" mixin=pulse handy ibidem><a-entity raycaster="far: 1; objects: [data-obstacle]" obstacle-stop="dirY: 0.5"></a-entity></a-entity><a-entity class="title intro" visible=false text="font: roboto; negate: false; color: #fff; letter-spacing: 9.21; align: center; value: Flow of Four" scale="40 40 1" position="0 5 -25"></a-entity><a-box class=intro visible=false data-obstacle position="0 1 -6.5" width=8 height=2></a-box><a-box class=intro visible=false data-obstacle position="0 1 4.5" rotation="0 180 0" width=8 height=2></a-box><a-box class=intro visible=false data-obstacle position="-4.5 1 -1" rotation="0 90 0" width=12 height=2></a-box><a-box class=intro visible=false data-obstacle position="4.5 1 -1" rotation="0 -90 0" width=12 height=2></a-box></a-scene><button class=novr autofocus onclick='window.dispatchEvent(new CustomEvent("novr"))'>NoVR</button>