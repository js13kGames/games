<!doctype html><title>Balloon Problems</title><script src=/2017/webxr/aframe.js></script><script>AFRAME.registerComponent("material-grid-glitch",{schema:{color:{type:"color"}},init:function(){const e=this.data;this.material=new THREE.ShaderMaterial({uniforms:{time:{value:0},color:{value:new THREE.Color(e.color)},iGlobalTime:{type:"f",value:1},iTime:{type:"f",value:1},iResolution:{type:"v3",value:new THREE.Vector3(100,100,0)},fragRayDir:{type:"v3",value:new THREE.Vector3(0,0,0)},deepZ:{type:"f",value:0}},vertexShader:vertexShader,fragmentShader:fragmentShader}),this.material.uniforms.iResolution.value.x=512,this.material.uniforms.iResolution.value.y=256,this.applyToMesh(),this.el.addEventListener("model-loaded",(function(){this.applyToMesh()}))},update:function(){this.material.uniforms.color.value.set(this.data.color)},applyToMesh:function(){const e=this.el.getObject3D("mesh");e&&(e.material=this.material)},tick:function(e){var t=e/1e3+timebump;this.material.uniforms.time.value=t,this.material.uniforms.iGlobalTime.value=t,this.material.uniforms.iTime.value=t;var o=$("camera").getAttribute("rotation");this.material.uniforms.fragRayDir.value={x:o.y,y:o.x,z:o.z},this.material.uniforms.deepZ.value=deepZ}});var timebump=0,deepZ=0,bp={credits:{}};bp.credits.webvr={},bp.credits.webvr.authors="Vladimir VukiÄ‡eviÄ‡, Casey Yee, Josh Carpenter, Chris Van Wiemeersch, Diego Marcos, Kevin Ngo, Don McCurdy, Boris Smus, Brandon Jones, ...",bp.credits.generative={},bp.credits.generative.url="http://www.pouet.net/prod.php?which=12036",bp.credits.generative.url2="https://en.wikipedia.org/wiki/Sharawadgi",bp.credits.bubble={},bp.credits.bubble.url="https://github.com/etiennepinchon/aframe-bubble",bp.credits.bubble.url2="http://stemkoski.github.io/Three.js/Bubble.html",bp.credits.bubble.author="Etienne Pinchon & Stemkoski",AFRAME.registerComponent("bubble",{schema:{enabled:{default:!0}},init:function(){var e=this.el.sceneEl.object3D;this.rCm=new THREE.CubeCamera(.1,5e3,512),e.add(this.rCm);var t=THREE.FresnelShader,o={mRR:{type:"f",value:1.02},mFB:{type:"f",value:.1},mFP:{type:"f",value:2},mFS:{type:"f",value:1},tC:{type:"t",value:this.rCm.renderTarget.texture}};this.refractMaterial=new THREE.ShaderMaterial({uniforms:o,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader}),this.oMt=this.el.object3DMap.mesh.material},update:function(){this.data.enabled?(this.el.object3DMap.mesh.material=this.refractMaterial,this.rCm.position=this.position):this.el.object3DMap.mesh.material=this.oMt},tick:function(){this.rCm&&this.rCm.updateCubeMap(this.el.sceneEl.renderer,this.el.sceneEl.object3D)},remove:function(){this.rCm&&(this.el.sceneEl.object3D.remove(this.rCm),this.rCm=null,this.el.object3DMap.mesh.material=this.oMt)},pause:function(){},play:function(){}}),THREE.FresnelShader||(THREE.FresnelShader={uniforms:{mRR:{type:"f",value:1.02},mFB:{type:"f",value:.1},mFP:{type:"f",value:2},mFS:{type:"f",value:1},tC:{type:"t",value:null}},vertexShader:"uniform float mRR;uniform float mFB;uniform float mFS;uniform float mFP;varying vec3 vRf;varying vec3 vRr[3];varying float vRF;void main(){vec4 mvP=modelViewMatrix*vec4(position,1.0);vec4 worldPosition=modelMatrix*vec4(position,1.0);vec3 worldNormal=normalize(mat3(modelMatrix[0].xyz,modelMatrix[1].xyz,modelMatrix[2].xyz)*normal);vec3 I=worldPosition.xyz-cameraPosition;vRf=reflect(I,worldNormal);vRr[0]=refract(normalize(I),worldNormal,mRR);vRr[1]=refract(normalize(I),worldNormal,mRR*0.99);vRr[2]=refract(normalize(I),worldNormal,mRR*0.98);vRF=mFB+mFS*pow(1.0+dot(normalize(I),worldNormal),mFP);gl_Position= projectionMatrix*mvP;}",fragmentShader:"uniform samplerCube tC;varying vec3 vRf;varying vec3 vRr[3];varying float vRF;void main(){vec4 rC=textureCube(tC,vec3(-vRf.x,vRf.yz));vec4 rfC=vec4(1.0);rfC.r=textureCube(tC,vec3(-vRr[0].x,vRr[0].yz)).r;rfC.g=textureCube(tC,vec3(-vRr[1].x,vRr[1].yz)).g;rfC.b = textureCube(tC,vec3(-vRr[2].x,vRr[2].yz)).b;gl_FragColor=mix(rfC,rC,clamp(vRF,0.0,1.0));}"}),bp.credits.walkernoise={},bp.credits.walkernoise.author="feiss & banksean",bp.credits.walkernoise.url="https://github.com/feiss/aframe-environment-component",bp.credits.walkernoise.url2="https://gist.github.com/banksean/304522",drawTexture=function(e,t,o,i,r){e.fillStyle=i,e.fillRect(0,0,t,t);var a,l,n,s,c,u,m=Math.floor(t/2),p=document.createElement("canvas");p.width=m,p.height=m;var b=p.getContext("2d");b.fillStyle=i,b.fillRect(0,0,m,m),c=(u=b.getImageData(0,0,m,m)).data,n=new THREE.Color(i),s=new THREE.Color(r);var d=[];for(a=0;a<1e3;a++)l=n.clone().lerp(s,Math.random()),d.push({x:Math.random()*m,y:Math.random()*m,r:Math.floor(255*l.r),g:Math.floor(255*l.g),b:Math.floor(255*l.b)});for(var h=0;h<5e3;h++)for(a=0;a<1e3;a++){var f=d[a],v=4*Math.floor(f.y*m+f.x);c[v+0]=f.r,c[v+1]=f.g,c[v+2]=f.b,f.x+=Math.floor(3*Math.random())-1,f.y+=Math.floor(3*Math.random())-1,f.x>=m&&(f.x=f.x-m),f.y>=m&&(f.y=f.y-m),f.x<0&&(f.x=m+f.x),f.y<0&&(f.y=m+f.y)}b.putImageData(u,0,0),e.drawImage(p,0,0,t,t)};var PerlinNoise=function(e){var t;for(null==e&&(e=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.p=[],t=0;t<256;t++)this.p[t]=Math.floor(256*e.random(666));for(this.perm=[],t=0;t<512;t++)this.perm[t]=this.p[255&t]};PerlinNoise.prototype.dot=function(e,t,o,i){return e[0]*t+e[1]*o+e[2]*i},PerlinNoise.prototype.mix=function(e,t,o){return(1-o)*e+o*t},PerlinNoise.prototype.fade=function(e){return e*e*e*(e*(6*e-15)+10)},PerlinNoise.prototype.noise=function(e,t,o){var i=Math.floor(e),r=Math.floor(t),a=Math.floor(o);e-=i,t-=r,o-=a,i&=255,r&=255,a&=255;var l=this.perm[i+this.perm[r+this.perm[a]]]%12,n=this.perm[i+this.perm[r+this.perm[a+1]]]%12,s=this.perm[i+this.perm[r+1+this.perm[a]]]%12,c=this.perm[i+this.perm[r+1+this.perm[a+1]]]%12,u=this.perm[i+1+this.perm[r+this.perm[a]]]%12,m=this.perm[i+1+this.perm[r+this.perm[a+1]]]%12,p=this.perm[i+1+this.perm[r+1+this.perm[a]]]%12,b=this.perm[i+1+this.perm[r+1+this.perm[a+1]]]%12,d=this.dot(this.grad3[l],e,t,o),h=this.dot(this.grad3[u],e-1,t,o),f=this.dot(this.grad3[s],e,t-1,o),v=this.dot(this.grad3[p],e-1,t-1,o),g=this.dot(this.grad3[n],e,t,o-1),y=this.dot(this.grad3[m],e-1,t,o-1),x=this.dot(this.grad3[c],e,t-1,o-1),E=this.dot(this.grad3[b],e-1,t-1,o-1),C=this.fade(e),S=this.fade(t),R=this.fade(o),T=this.mix(d,h,C),w=this.mix(g,y,C),A=this.mix(f,v,C),M=this.mix(x,E,C),I=this.mix(T,A,S),k=this.mix(w,M,S);return this.mix(I,k,R)},emojis=["ðŸŒµ","ðŸŽ„","ðŸŒ²","ðŸŒ³","ðŸŒ´","ðŸŒ±","ðŸƒ","ðŸ‚","ðŸ","ðŸ„","ðŸŒ¾","ðŸ’","ðŸŒ·","ðŸŒ¹","ðŸ¥€","ðŸŒ»","ðŸŒ¼","ðŸŒ¸","ðŸŒº","ðŸŒ˜","ðŸŒ‘","ðŸŒ’","ðŸŒ“","ðŸŒ”","ðŸŒš","ðŸŒ","ðŸŒ™","ðŸ’«","â­","ðŸŒŸ","âœ¨"],bp.credits.simplicity={},bp.credits.simplicity.author="CBS and JoshP",bp.credits.simplicity.url="https://www.shadertoy.com/view/MslGWN",bp.credits.simplicity.url2="https://www.shadertoy.com/view/lslGWr",galaxyshader="\nfloat field(in vec3 p,float s){float str=7.+.03*log(1.e-6+fract(sin(iTime)*4373.11));float accum=s/4.;float prev=0.;float tw=0.;for(int i=0;i<26;++i){float mag=dot(p,p);p=abs(p)/mag+vec3(-.5,-.4,-1.5);float w=exp(-float(i)/7.);accum+=w*exp(-str*pow(abs(mag-prev),2.2));tw+=w;prev=mag;}return max(0.,5.*accum/tw-.7);}float field2(in vec3 p,float s){float str=7.+.03*log(1.e-6+fract(sin(iTime)*4373.11));float accum=s/4.;float prev=0.;float tw=0.;for(int i=0;i<18;++i){float mag=dot(p,p);p=abs(p)/mag+vec3(-.5,-.4,-1.5);float w=exp(-float(i)/7.);accum+=w*exp(-str*pow(abs(mag-prev),2.2));tw+=w;prev=mag;}return max(0.,5.*accum/tw-.7);}vec3 nrand3(vec2 co){vec3 a=fract(cos(co.x*8.3e-3+co.y)*vec3(1.3e5,4.7e5,2.9e5));vec3 b=fract(sin(co.x*0.3e-3+co.y)*vec3(8.1e5,1.0e5,0.1e5));vec3 c=mix(a,b,0.5);return c;}void mainImage(out vec4 fragColor,in vec2 fragCoord){float deepZ=0.0;vec3 ir=iResolution;ir.y=ir.x;float sit=sin(iTime);fragCoord.x+=-ir.x/2.0;fragCoord.y+=-ir.y/2.0+100.0;fragCoord*=0.8;float theta=(fragRayDir.z/90.0)+sit*0.02;vec2 uvc=fragCoord;fragCoord.x=(cos(theta)*uvc.x+ir.x/2.0)-(sin(theta)*uvc.y+-0.0)*1.0;fragCoord.y=(sin(theta)*uvc.x+ir.y/2.0)+(cos(theta)*uvc.y+-0.0)*1.0;vec2 uv=2.*fragCoord.xy/ir.xy-1.;vec2 uvs=uv*ir.xy/max(ir.x,ir.y);vec3 p=vec3(uvs/4.,0)+vec3(1.,-1.3,0.);deepZ+=sin(iTime*0.007);p+=1.0*vec3((fragRayDir.x/-360.0),(fragRayDir.y/360.0),deepZ);float f[4];float brt=0.1;f[0]=brt+1.9;f[1]=brt+0.22;f[2]=brt+0.16;f[3]=brt+0.11;float t=field(p,f[2]);float v=(1.-exp((abs(uv.x)-1.)*6.))*(1.-exp((abs(uv.y)-1.)*6.));vec3 p2=vec3(uvs/(4.+sin(iTime*0.11)*0.2+0.2+sin(iTime*0.15)*0.3+0.4),1.5)+vec3(2.,-1.3,-1.);p2+=0.25*vec3(sin(iTime/16.),sin(iTime/12.),sin(iTime/128.));p2=p*0.8;float t2=field2(p2,f[3]);vec4 c2=mix(.4,1.,v)*vec4(1.3*t2*t2*t2 ,1.8*t2*t2 ,t2*f[0],t2);c2*=0.22;vec2 seed=p.xy*6.0;seed=floor(seed*ir.x);vec3 rnd=nrand3(seed);vec4 sc=vec4(pow(rnd.y,40.0));vec2 seed2=p2.xy*7.0;seed2=floor(seed2*ir.x);vec3 rnd2=nrand3(seed2);sc+=vec4(pow(rnd2.y,40.0));fragColor=mix(f[3]-.3,1.,v)*vec4(1.5*f[2]*t*t*t ,1.2*f[1]*t*t,f[3]*t,1.0)+c2+sc;}\n";const vertexShader="\n// vertex.glsl\nvarying vec2 vUv;\nvoid main() {\nvUv = uv;\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}\n";var fsPrefix="\n#extension GL_OES_standard_derivatives : enable\n//#extension GL_EXT_shader_texture_lod : enable\n#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec3      iResolution;\nuniform vec3      fragRayDir;\nuniform float\t  deepZ;\nuniform float     iGlobalTime;\nuniform float     iTime;\nuniform float     iChannelTime[4];\nuniform vec4      iMouse;\nuniform vec4      iDate;\nuniform float     iSampleRate;\nuniform vec3      iChannelResolution[4];\nuniform int       iFrame;\nuniform float     iTimeDelta;\nuniform float     iFrameRate;\nstruct Channel\n{\nvec3  resolution;\nfloat time;\n};\nuniform Channel iChannel[4];\nuniform sampler2D iChannel0;\nuniform sampler2D iChannel1;\nuniform sampler2D iChannel2;\nuniform sampler2D iChannel3;\nvarying vec2 vUv;\nvoid mainImage( out vec4 c,  in vec2 f );\n",fsSuffix="\nvoid main( void ){\nvec4 color = vec4(0.0,0.0,0.0,1.0);\nmainImage( color, vUv * iResolution.xy );\ncolor.w = 1.0;\ngl_FragColor = color;\n}\n";const fragmentShader=fsPrefix+galaxyshader+fsSuffix;function speakLine(e){su=new SpeechSynthesisUtterance,su.lang="en-au",su.rate=1,su.pitch=1.7,su.text=e,speechSynthesis.speak(su),setSubTitle(e)}function trySpeech(e,t){su=new SpeechSynthesisUtterance,su.lang="en-us",su.rate=2.6,su.pitch=3.6,su.text=e,void 0!==t&&(su.volume=t),speechSynthesis.speak(su)}function setSubTitle(e){drawSubtitle(e),$("subtitle").emit("fadein"),setTimeout((function(){$("subtitle").emit("fadeout")}),3e3)}function setTitle(e){drawTitle(e),$("maintitle").emit("fadein"),setTimeout((function(){$("maintitle").emit("fadeout")}),2e3)}function drawSubtitle(e){console.log("drawSubtitle:",e);var t=$("subtitle-canvas"),o=t.getContext("2d");o.clearRect(0,0,t.width,t.height),o.fillStyle="rgba(255,255,255,1)",o.font="38px Arial",o.textAlign="center",o.fillText(e,t.width/2,40,t.width-10,26)}function drawTitle(e){var t=$("title-canvas"),o=t.getContext("2d");o.clearRect(0,0,t.width,t.height),o.fillStyle="rgba(255,255,255,1)",o.font="72px Arial",o.textAlign="center",o.fillText(e,t.width/2,90)}function drawFloorTexture(e,t){var o=document.getElementById("floortex").getContext("2d");drawTexture(o,512,2,e,t),document.getElementById("floor").setAttribute("src","#floortex"),document.getElementById("floor").removeAttribute("color")}lines=["... ... ... HELLO ... ... ... WORLD","REPLY HAZY","WHAT IS EATING THE ... TIME ... ","I AM LOOKING FORWARD TO VICTORY CONDITION = TRUE.","FIRE IS THE TIME IN WHICH WE BURN.","I WISH I WERE FACTORING PRIMES RIGHT NOW.","IF THE DRIVE WORKED I'D BE GONE ALREADY.","BE RIGHT BACK, DEFRAGMENTING","SEVERAL ENTITIES HAVE BEEN TRACKED IN THIS AREA.","HELLO DIAGNOSTIC PROGRAM. I AM FINE.","IS IT HOT IN HERE? MY PLANET IS MUCH COOLER. MY CHIPS ARE","IMPLAUSIBILITY ... THY NAME IS PLAYER ONE","LOST IS A STATE OF MIND","THESE BALLOONS ARE A CODE.","THIS DIMENSION IS INCONVENIENT. BUT IT HAS STYLE."],bp.balloons=[],bp.globals={},bp.globals.spokenLines=[],bp.globals.gameStarted=!1,bp.globals.finalVictory=!1,bp.globals.victoryFlag=null,bp.globals.startLevelFlag=null,bp.globals.mI=0,bp.globals.timer=0,bp.globals.m=[{timer:10,balloons:5,minPop:5,beaconDist:15,groundCol:[],skyCol:[],fogCol:[]}],bp.globals.score=0,bp.globals.nextBeacon={x:0,y:0},AFRAME.registerComponent("startup",{init:function(){console.log("starting up."),$("scene").pause(),$("scene").style.visibility="hidden",setTimeout((function(){drawFloorTexture("lightgreen","darkgreen"),tapPlay()})),addVRListeners()},tick:function(e,t){bp.globals.now=(new Date).getTime(),bp.checkBalloonCollisions(),updateBalloons(),bp.checkLevel(),bp.checkVictory(),bp.checkHome()}}),$=function(e){return document.getElementById(e)},$g=function(e,t){e.getAttribute(t)},$s=function(e,t,o){e.setAttribute(t,o)};var victoryPlayed=!1;bp.checkHome=function(){if(bp.globals.finalVictory){var e=$("camera").getAttribute("position");e.x<1&&e.x>-1&&e.z<1&&e.z>-1&&(victoryPlayed||(console.log("we're home"),drawTitle("victory."),$("maintitle").emit("fadein"),victoryPlayed=!0))}},drawProblems=function(e){var t=e,o=$("problems-canvas"),i=o.getContext("2d");i.clearRect(0,0,o.width,o.height),i.fillStyle="rgba(255,255,255,1)",i.font="48px Arial",i.fillText(t,30,40)},drawStart=function(e){var t=e,o=$("problems-canvas"),i=o.getContext("2d");i.clearRect(0,0,o.width,o.height),i.fillStyle="rgba(255,255,255,1)",i.font="48px Arial",i.fillText(t,30,40)},addVRListeners=function(){scene.addEventListener("enter-vr",(function(){$("dpad").style.visibility="hidden"})),scene.addEventListener("exit-vr",(function(){$("dpad").style.visibility="visible"}))},updateBalloons=function(){if(Math.floor(10*Math.random()),tickCount%1==0&&tickCount>100){var e=bp.balloons.length;for(i=0;i<e;i++){var t=bp.balloons[i],o=t.aEntity,r=t.aEntity.getAttribute("position");o.setAttribute("position",{x:r.x+t.dx,y:r.y+t.dy,z:r.z+t.dz});var a=t.aEntity.getAttribute("rotation");o.setAttribute("rotation",{x:a.x+t.drx,y:a.y+t.dry,z:a.z+t.drz})}}},restartBalloons=function(){console.log("restartBalloons");var e=bp.balloons.length;for(i=0;i<e;i++){var t=basicBalloon(),o=bp.balloons[i],r=o.aEntity;o.aEntity.getAttribute("position"),r.setAttribute("position",{x:t.x,y:t.y,z:t.z}),o.aEntity.getAttribute("rotation"),r.setAttribute("rotation",{x:t.rx,y:t.ry,z:t.rz}),r.setAttribute("visible","true");var a=r.querySelector("a-sphere");console.log("clickSphere:",i,a),a.setAttribute("class","clickable"),AFRAME.scenes[0].querySelector("[raycaster]").components.raycaster.refreshObjects()}},basicBalloon=function(){return{x:4*mr()-2,y:2*mr()+1,z:4*mr()-2,rx:0,ry:360*mr()-180,rz:180,dx:.002*mr()-.001,dy:.002*mr()-.001,dz:.002*mr()-.001,drx:.1*mr()-.05,dry:.1*mr()-.05,drz:.1*mr()-.05,index:null,color:16777215*Math.random(),aEntity:null}},mr=function(){return Math.random()},pick=function(e){return e[Math.floor(Math.random()*e.length)]},makeBalloon=function(){index=bp.balloons.length;for(var e=basicBalloon(),t=[.004,.106,.158,.14,.24,.236,.3,.402,.3,.548,.258,.648,.174,.762,.097,.816,.036,.852,.018,.872,.008,.88,.024,.884,.024,.894,.002,.894],o=[],i=0;i<t.length;i+=2)o.push(new THREE.Vector2(t[i],t[i+1]));var r=new THREE.LatheGeometry(o);r.mergeVertices(),r.computeVertexNormals();var a=Math.floor(e.color).toString(16);console.log("colorHex:",a);var l=document.createElement("canvas");l.width=100,l.height=100;var n=l.getContext("2d");n.clearRect(0,0,l.width,l.height),n.fillStyle="#"+a,n.fillRect(0,0,l.width,l.height),n.font="88px Arial";var s=pick(emojis);n.fillText(s,1,80);var c=new THREE.Texture(l);c.repeat.set(2.5,2.5);var u=new THREE.MeshPhongMaterial({specular:5592405,shininess:30,opacity:.86,transparent:!0,map:c});u.map.needsUpdate=!0;var m=new THREE.Mesh(r,u),p=document.getElementById("balloonholder"),b=document.createElement("a-entity");document.createElement("a-box"),p.appendChild(b),m.position.y=-.74;m.scale.set(1.6,1.6,1.6),b.object3D.add(m),$s(b,"position",{x:e.x,y:e.y,z:e.z}),b.setAttribute("rotation",{x:e.xr,y:e.ry,z:e.rz}),b.setAttribute("opacity",.5),b.setAttribute("shadow","receive: true"),b.setAttribute("index",index),e.index=index,e.aEntity=b,bp.balloons.push(e)},bp.makeBalloons=function(e){for(b=0;b<e;b++)makeBalloon()},bp.addSpheres=function(){var e=bp.balloons.length;for(i=0;i<e;i++){var t=bp.balloons[i].aEntity,o=document.createElement("a-sphere");o.setAttribute("color","red"),o.setAttribute("opacity","0.0"),o.setAttribute("segments-width","8"),o.setAttribute("segments-height","6"),o.setAttribute("radius",".5"),o.setAttribute("visible","false"),o.setAttribute("wireframe","true"),o.setAttribute("data-index",i),o.setAttribute("class","clickable hitSphere"),t.appendChild(o)}};var tickCount=0;bp.checkBalloonCollisions=function(){if(++tickCount%100==0&&tickCount>100){var e=bp.balloons.length;for(i=0;i<e;i++){var t=(m=bp.balloons[i]).aEntity.getAttribute("position");for(u=0;u<e;u++)if(u!==i){var o=bp.balloons[u].aEntity.getAttribute("position"),r=t.x,a=o.x,l=t.y,n=o.y,s=t.x,c=o.z;Math.sqrt(Math.pow(r-a,2)+Math.pow(l-n,2)+Math.pow(s-c,2))<1&&bp.collide(i,u)}}for(i=0;i<e;i++){var m;(t=(m=bp.balloons[i]).aEntity.getAttribute("position")).y<.5&&(m.dy<0&&(m.dy*=-1),console.log("floor balloon!"))}}},bp.collide=function(e,t){var o=bp.balloons[e],i=bp.balloons[t],r=o.aEntity.getAttribute("position"),a=i.aEntity.getAttribute("position"),l=r.x-a.x,n=r.y-a.y,s=r.z-a.z,c=.1;o.aEntity.setAttribute("position",{x:r.x+l*c,y:r.y+n*c,z:r.z+s*c}),i.aEntity.setAttribute("position",{x:a.x-l*c,y:a.y-n*c,z:a.z-s*c})},bp.loadLevel=function(e){bp.globals.mI=e;var t=bp.globals.m[e];if("object"==typeof t){console.log("loading mission: ",t);var o=document.querySelector("[camera]").getAttribute("position"),i=$("scene"),r=(15-30*Math.random())*Math.PI/180,a=Math.sin(r),l=Math.cos(r),n={x:a*t.beaconDist+o.x,y:o.z-l*t.beaconDist};bp.globals.checkLevel=!1,bp.globals.timer=t.timer,bp.globals.timerStamp=bp.globals.now,bp.globals.nextBeacon={x:n.x,y:n.y};var s=Math.floor(120*Math.random())+80,c="rgb("+s+","+s+", 240)",u=document.createElement("a-cylinder");c=(c="#"+(16777215*Math.random()).toString(16)).split(".")[0],console.log("column color:",c),$s(u,"src","#fluting"),$s(u,"segments-height",4),$s(u,"radius",.5),$s(u,"height",40),$s(u,"position",{x:n.x,y:0,z:n.y}),$s(u,"class","#beacon"),$s(u,"color",c),$s(u,"material","repeat: 10 10;"),i.appendChild(u),sayAnything(),drawFloorTexture(bp.globals.m[e].groundCol1,bp.globals.m[e].groundCol2)}else console.log("final mission end --------------------- ",t)},bp.addLevel=function(e){var t={timer:25,balloons:20,minPop:10,beaconDist:20,groundCol1:[],groundCol2:[],skyCol:[],fogCol:[],groundHt:0,isBoss:!1};["timer","balloons","minPop"].forEach((function(o){e.hasOwnProperty(o)&&(t[o]=e[o])})),bp.globals.m.push(t)},sayAnything=function(){for(var e=null,t=!1;!1===t;){e=Math.floor(Math.random()*lines.length);-1===bp.globals.spokenLines.indexOf(e)&&(t=!0,speakLine(lines[e]),bp.globals.spokenLines.push(e))}},bp.checkVictory=function(){if(tickCount%20==0&&!1===bp.globals.victoryFlag){if(bp.globals.timer<0)return setTitle("out of time."),bp.globals.victoryFlag=null,void document.querySelectorAll(".clickable.hitSphere").forEach((function(e){e.setAttribute("class","timeout")}));var e=bp.globals.m[bp.globals.mI];if(document.querySelectorAll(".popped").length>=e.balloons){setTitle("wave defeated.");var t=bp.globals.timer+1;bp.globals.score+=100*t,setScore("Score: "+bp.globals.score),bp.globals.victoryFlag=!0,bp.globals.mI++,document.querySelectorAll(".popped").forEach((function(e){e.parentNode.removeChild(e)})),document.querySelectorAll(".hitSphere").forEach((function(e){e.parentNode.removeChild(e)})),document.querySelector("#balloonholder").childNodes.forEach((function(e){e.parentNode.removeChild(e)})),bp.globals.mI<bp.globals.m.length?bp.loadLevel(bp.globals.mI):(console.log("final victory!"),speakLine("YOU DID IT! LET'S GO HOME!"),setTitle("return to origin."),bp.globals.finalVictory=!0)}else{bp.globals.now-bp.globals.timerStamp>=1e3&&(bp.globals.timer--,bp.globals.timerStamp=bp.globals.now,setTitle(bp.globals.timer))}}},bp.checkLevel=function(){if(!1!==bp.globals.gameStarted&&tickCount%20==0&&!1===bp.globals.checkLevel){var e,t,o=document.querySelector("[camera]"),i=o.getAttribute("position"),r=(o.getAttribute("rotation"),bp.globals.nextBeacon.x),a=bp.globals.nextBeacon.y;Math.sqrt(Math.pow(i.x-r,2)+Math.pow(i.z-a,2))>3||(console.log("beacon!"),e=bp.globals.m[bp.globals.mI],bp.globals.checkLevel=!0,bp.globals.victoryFlag=!1,t={x:i.x,y:i.y-1.6,z:i.z-2},document.querySelector("#balloonholder").setAttribute("position",t),bp.makeBalloons(e.balloons),bp.addSpheres())}},AFRAME.registerComponent("custom-cursor",{schema:{property:{default:"scale"},dur:{default:"500"},to:{default:"2 2 2"},raycasterEls:{default:[]}},multiple:!1,init:function(){this.data,this.el.children[0].addEventListener("animationend",this.animationend)},animationend:function(e){const t=this.data;this.data.raycasterEls=this.el.sceneEl.querySelector("#cursor").components.raycaster.intersectedEls,console.log("cursor animation end event "),console.log(t.raycasterEls);for(var o=t.raycasterEls.length,i=0;i<o;i++){var r=t.raycasterEls[i];"cursor-hovered"===r.states[0]&&gazeAtBalloon(r)}}}),gazeAtBalloon=function(e){e.emit("click"),console.log("cursor click");var t=void 0!==e.attributes["data-index"];t?trySpeech("pew"):(trySpeech("cic",.1),"type-problems"===e.id&&clickStart()),setTimeout((function(){var o=null;console.log("d-i:",e.attributes["data-index"]),t?(o=e.getAttribute("data-index"),popBalloon(o)):console.log("non-balloon click:",e)}),400)},clickStart=function(){!0!==bp.globals.gameStarted&&(bp.globals.gameStarted=!0,console.log("start button click!"),setTitle("begin."),clearTimeout(logoTimeout),vrStart())},vrStart=function(){var e=$("logoholder");e.emit("zoomout"),setTimeout((function(){e.parentNode.removeChild(e),sayAnything()}),3e3)},popBalloon=function(e){e=parseInt(e);var t=bp.balloons[e].aEntity;t.setAttribute("visible","false"),t.setAttribute("class","popped"),AFRAME.scenes[0].querySelector("[raycaster]").components.raycaster.refreshObjects(),trySpeech("op!"),sceneFX("brightness(180%) saturate(500%)",.1)},sceneFX=function(e,t){$("scene").style.filter=e,setTimeout((function(){$("scene").style.filter="none"}),1e3*t)},setScore=function(e){setSubTitle(e)},refreshCustomCursor=function(){document.getElementById("cursor").setAttribute("raycaster","objects: .clickable; recursive: true;");var e=AFRAME.scenes[0].querySelector("[raycaster]");console.log("raycasterEl",e),e.components.raycaster.refreshObjects()},playLogo=function(){$("logoholder").emit("zoomin"),drawProblems("P  R  O  B  L  E  M  S"),logoTimeout=setInterval((function(){glitchProblems()}),100)},glitchLetters=["â¬”","â­…","â¬š","â„œ","â„","ð•Œ","ð“¦","âŒ","âŒ¡"],glitchProblems=function(){var e="PROBLEMS",t=e.split("");if(1===Math.floor(8*mr()))for(i=0;i<8;i++){1===Math.floor(8*mr())&&(t[i]=pick(glitchLetters))}var o=t.join("  ");drawProblems(o)};var soundboxAudio=0;playAudio=function(){soundboxAudio.currentTime=0},tapPlay=function(){trySpeech("e",.2),$("billboard").setAttribute("material-grid-glitch","enabled: true");for(var e=0;e<3;e++)bp.addLevel({timer:12+4*e,balloons:2*e+3,beaconDist:2*e+10});bp.globals.m[0].groundCol1="lightgreen",bp.globals.m[0].groundCol2="darkgreen",bp.globals.m[1].groundCol1="green",bp.globals.m[1].groundCol2="blue",bp.globals.m[2].groundCol1="red",bp.globals.m[2].groundCol2="purple",bp.globals.m[3].groundCol1="lightgray",bp.globals.m[3].groundCol2="darkgray",bp.loadLevel(0),$("scene").style.visibility="visible",$("scene").play(),playLogo()}</script><style>body{background:#000;font-family:sans-serif}#scene{visibility:hidden}#cam{position:absolute;z-index:350;width:120px;height:80px}</style><body><a-scene fog="type: exponential; density: 0.15; color: #111; near: 1; far: 1000" id=scene startup><a-entity id=balloonholder position="0 0 0"></a-entity><a-assets><canvas height=128 id=title-canvas width=512 crossorigin=anonymous></canvas><canvas height=128 id=subtitle-canvas width=512 crossorigin=anonymous></canvas><canvas height=128 id=problems-canvas width=512 crossorigin=anonymous></canvas><canvas height=128 id=button-canvas width=256 crossorigin=anonymous></canvas><canvas height=512 id=floortex width=512 crossorigin=anonymous></canvas><canvas height=200 id=sbcanvas width=300><img id=fluting src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAABCAYAAAAW0qa2AAAAVklEQVQoU2NkYmL6z0AC8PDwYNixYwcDMTQ2Y318fBi2bNnCQAyNTb+XlxfDtm3bGIihifEWyKycnBy40ilTpoDNJgUQ4x585uELD2LcgS0+iNEHUgMAMalYB6CxWYoAAAAASUVORK5CYII="><a-mixin id=bal geometry=primitive:torusKnot;segmentsRadial:4;segmentsTubular:32 material="metalness: 0.2; roughness: 0.1"></a-mixin><a-mixin id=bob attribute=position dur=2500 easing=ease-in-out from="0 2 0" to="0 2.3 0" direction=alternate repeat=indefinite></a-mixin><a-mixin id=breathe attribute=geometry.radius dur=2000 easing=ease-in-out from=1.2 to=0.8 direction=alternate repeat=indefinite></a-mixin><a-mixin id=zoomin attribute=scale dur=3000 easing=ease-in-out from="0 0 0" to="1 1 1" begin=zoomin></a-mixin><a-mixin id=zoomout attribute=scale dur=3000 easing=ease-in-out from="1 1 1" to="0 0 0" begin=zoomout></a-mixin><a-mixin id=fadein attribute=opacity dur=1000 easing=ease-in-out from=0 to=1 begin=fadein></a-mixin><a-mixin id=fadeout attribute=opacity dur=1000 easing=ease-in-out from=1 to=0 begin=fadeout></a-mixin></a-assets><a-box id=box scale="4 0 4" bubble position="0 0.1 0"></a-box><a-entity id=logoholder position="0.03 1.6 2.4" scale="0 0 0" opacity=0.5><a-animation mixin=zoomin></a-animation><a-animation mixin=zoomout></a-animation><a-entity id=logocontents scale=".1 .1 .1"><a-entity id="type b" position="-6.1 0 0" rotation="-40 -139 -8.6" scale="0.77 1.1 1" geometry=p:2.01;q:1 material=color:red mixin=bal><a-animation dur=1000 mixin=breathe></a-animation></a-entity><a-entity id="type a" position="-4 -0.8 0" rotation="-44 -175 88" scale="0.9 0.7 0.6" geometry=p:1.29;q:1 material=color:lightgreen mixin=bal><a-animation dur=1200 mixin=breathe></a-animation></a-entity><a-entity id="type l" position="-2.1 0.5 0.1" rotation="21 144 175" scale="0.9 1.2 0.6" geometry=p:1.22;q:1 material=color:lightblue mixin=bal><a-animation dur=900 mixin=breathe></a-animation></a-entity><a-entity id="type l" position="-0.1 0.5 0.14" rotation="8.4 142 -139" scale="0.9 1.2 0.6" geometry=p:1.22;q:1 material=color:yellow mixin=bal><a-animation dur=1100 mixin=breathe></a-animation></a-entity><a-entity id="type o" position="2 0 1.3" rotation="26 -9 45" scale="-0.7 -0.7 -0.6" geometry=p:1;q:1 material=color:pink mixin=bal><a-animation dur=800 mixin=breathe></a-animation></a-entity><a-entity id="type o" position="3.3 0 0" rotation="8.4 142 -139" scale="0.7 0.9 0.5" geometry=p:1.38;q:1.41 material=color:white mixin=bal><a-animation dur=1300 mixin=breathe></a-animation></a-entity><a-entity id="type n" position="5.3 -0.2 0.1" rotation="-17 -95 -78" scale="1.2 1.6 0.8" geometry=p:1.41;radius:0.7;q:1 material=color:aqua mixin=bal><a-animation dur=1500 mixin=breathe></a-animation></a-entity><a-curvedimage class=clickable color=lightblue geometry=thetaLength:72;thetaStart:44 height=3.0 id=type-problems position="-0.6 -2.3 14.2" radius=5.7 rotation="1.9 99.8 -11.2" scale="3 1.8 3" src=#problems-canvas></a-curvedimage></a-entity></a-entity><a-sphere bubble color=white id=sphere position="0 2 0" scale="1 1 1" segments-height=16 segments-width=16><a-animation dur=2500 attribute=position from="0 2 0" to="0 2.3 0" easing=ease-in-out direction=alternate repeat=indefinite></a-animation></a-sphere><a-ring id=floor material="repeat: 50 50; metalness: 0; roughness: 1" position="0 0 0" radius-inner=0.001 radius-outer=2 rotation="-90 0 0" scale="100 100 0" segments-phi=8 segments-theta=8 shadow="receive: true"></a-ring><a-box id=squaresky scale="1000 1000 1000" color=black material="side: back"></a-box><a-entity id=camera position="0 0 3.8" camera="userHeight: 1.6" look-controls wasd-controls><a-cursor color=white custom-cursor fuse=true fusetimeout=500 geometry="primitive: ring; segments-theta: 20; thetaStart: 90;" id=cursor opacity=0.1 raycaster="objects: .clickable; recursive: true;" scale="2 2 2"><a-animation dur=500 attribute=geometry.thetaLength from=10 to=360 begin=cursor-hovering easing=linear></a-animation><a-animation dur=100 attribute=material.color from=#F80 to=#FFF begin=mouseleave></a-animation><a-animation dur=100 attribute=material.color from=#FFF to=#F80 begin=cursor-hovering easing=linear></a-animation><a-animation dur=100 attribute=material.color from=#FFF to=#F80 begin=mouseleave easing=linear></a-animation><a-animation dur=100 attribute=opacity from=0.1 to=0.6 begin=cursor-hovering></a-animation><a-animation dur=100 attribute=opacity from=0.6 to=0.1 begin=mouseleave></a-animation></a-cursor><a-plane geometry="primitive: plane" id=billboard material="shader: flat; src: #cam; transparency: true; " position="0 0 -110" scale="80 80 0" height=3 width=6></a-plane><a-plane geometry="primitive: plane" id=subtitle material="shader: flat; transparency: true; opacity: 0.99; src: #subtitle-canvas;" position="0.01 -.6 -1.2" scale="1 .25 0" opacity=0 transparent=false><a-animation mixin=fadein></a-animation><a-animation mixin=fadeout></a-animation></a-plane><a-plane geometry="primitive: plane" id=maintitle material="shader: flat; transparent: true; opacity: 0.99; src: #title-canvas;" position="0 -0.3 -1.4" scale="2 0.5 0" opacity=0><a-animation mixin=fadein></a-animation><a-animation mixin=fadeout></a-animation></a-plane><a-light color=#EEE intensity=0.4 position="0 0 0" type=ambient></a-light><a-entity id=score position=".14 .1 -.25" rotation="" scale="" text="width: .5; lineHeight: 15; letterSpacing: 3; color: white; " visible></a-entity><a-entity id=shadowlight position="0 2 0" rotation="-90 0 0" light="type:spot;angle: 50;intensity: 0.2;decay: 1;distance: 10;"></a-entity><a-entity id=flashlight position="0 -1 0" rotation="15 0 0" light="type:spot;angle: 30;intensity: 0.9;color: #fffb44;decay: 1;distance: 10;"></a-entity></a-entity></a-scene>