<title>Shpere - js13kGames 2012</title><style>body,html{background-color:#000}div#large_container{position:relative;margin:auto;display:inline-block}canvas#canvas13k{position:relative;left:0;top:0;border:1px solid #555}div#menu{position:absolute;width:100%;height:100%;left:0;top:0;z-index:10;background-color:rgba(0,0,0,.7);-webkit-transition:all .3s ease-out;-moz-transition:all .3s ease-out;-o-transition:all .3s ease-out;-ms-transition:all .3s ease-out}img#menuGraphic{width:100%}img#twetGraphic{position:absolute;border:10px solid #646464;border-radius:10px;bottom:0;left:0}img#kittyGraphic{position:absolute;border:10px solid #646464;border-radius:10px;bottom:0;right:0}</style><div id=large_container><div id=menu><a href="http://twitter.com/intent/tweet?text=durrrrrrrr&via=mrlasertron" id=twetAnchor target=_blank><img src=tweet.svg id=twetGraphic> </a><a href=http://slouchcou.ch id=kittyAnchor target=_blank><img src=kitty.svg id=kittyGraphic> </a><img src=instructions.svg id=menuGraphic></div><canvas id=canvas13k width=800 height=600></canvas></div><script>function t(t){var e=[];starBoxSize=cvs.width;for(var s=0;s<t;s++)e.push(new h("white",d(-starBoxSize,starBoxSize),d(-starBoxSize,starBoxSize),d(-starBoxSize,starBoxSize)));return e}function e(t,e,s){return x=t*Math.sin(s)*Math.cos(e),y=t*Math.sin(s)*Math.sin(e),z=t*Math.cos(s),{x:y,y:-z,z:-x}}function s(t,e,s){return t={x:t,y:e,z:s},(e={x:0,y:0,z:0}).x=t.x*(-3*r)/(t.z+-3*r+-3*r),e.y=t.y*(-3*r)/(t.z+-3*r+-3*r),e.z=t.z,e}function i(t,e,s,i){return{x:t,y:e*Math.cos(i)-s*Math.sin(i),z:e*Math.sin(i)+s*Math.cos(i)}}function h(t,e,i,h){this.pos={x:e,y:i,z:h},this.vel={x:0,y:0,z:.1},this.color=t,this.radius=1,this.update=function(){this.pos.x+=this.vel.x*tm.delta(),this.pos.y+=this.vel.y*tm.delta(),this.pos.z+=this.vel.z*tm.delta(),this.pos.z>starBoxSize&&(this.pos.z=-starBoxSize)},this.draw=function(){var t=s(this.pos.x,this.pos.y,this.pos.z);ctx.arc(t.x,t.y,this.radius,0,2*Math.PI,!1),ctx.fillStyle=this.color}}function a(t){t.preventDefault(),isMouseDown=!0,currentMouseCoords=c(t),balls[0].isCaught&&!menuState&&balls[0].pitch()}function o(t){t.preventDefault(),isMouseDown=!1,menuState||(sphereVelocity.x=-(currentMouseCoords.x-lastMouseCoords.x)/mouseSensitivity,sphereVelocity.y=-(currentMouseCoords.y-lastMouseCoords.y)/mouseSensitivity)}function n(t){t.preventDefault(),lastMouseCoords=currentMouseCoords,currentMouseCoords=c(t),isMouseDown&&!menuState&&(delta.theta+=-(currentMouseCoords.x-lastMouseCoords.x)/mouseSensitivity)}function l(t){1==menuState&&t.target==menuGraphic&&(menuState=!1,mobile?menu.style.visibility="hidden":menu.style.left=-cvs.width-100)}function c(t){var e=t.x,s=t.y;return t.x||0==t.x?(e=t.x,s=t.y,e-=cvs.offsetLeft,s-=cvs.offsetTop):t.layerX||0==t.layerX?(e=t.layerX,s=t.layerY):t.offsetX||0==t.offsetX?(e=t.offsetX,s=t.offsetY):t.pageX||0==t.pageX?(e=t.pageX,s=t.pageY,t.changedTouches||(s-=cvs.offsetTop,e-=cvs.offsetLeft)):s=e=0,{x:e,y:s}}function d(t,e){return Math.random()*(t<e?e-t:t-e)+(t<e?t:e)}var u;cvs=document.createElement("canvas"),cvs_viewport=document.getElementById("canvas13k"),ctx_viewport=cvs_viewport.getContext("2d"),ctx=cvs.getContext("2d"),mobile=!1,-1!=navigator.userAgent.indexOf("iPhone")||-1!=navigator.userAgent.indexOf("iPod")||-1!=navigator.userAgent.indexOf("iPad")?(cvs.height=window.innerHeight-20,cvs.width=window.innerWidth-20,mobile=!0):(cvs.height=window.innerHeight-20,cvs.width=window.innerWidth-20),cvs_viewport.height=cvs.height,cvs_viewport.width=cvs.width,menu=document.getElementById("menu"),menuGraphic=document.getElementById("menuGraphic"),u=cvs.height>cvs.width?cvs.width:cvs.height,menuGraphic.height=u,menuGraphic.width=u,menu.addEventListener("click",l,!1),menu.addEventListener("touchend",l,!1),window.addEventListener("mousedown",a,!1),window.addEventListener("mousemove",n,!1),window.addEventListener("mouseup",o,!1),window.addEventListener("touchstart",a,!1),window.addEventListener("touchmove",n,!1),window.addEventListener("touchend",o,!1),isMouseDown=!1,mouseSensitivity=100,currentMouseCoords={x:0,y:0},sphereVelocity={x:0,y:0},sphereDecel=10,r=cvs.height<=cvs.width?cvs.height/2:cvs.width/2,r-=10,delta={theta:0,phi:0},sphere_tau=-Math.PI/6,starBoxSize=0,score=0,playingState=!(menuState=!0),sphereShaker=new function(){this.magnitude=0,this.last_magnitude=0,this.vel=0,this.accel=0,this.k=150,this.c=10,this.m=1,this.update=function(){var t=tm.delta()/1e3;this.last_magnitude=this.magnitude,this.accel=(-this.k*this.magnitude+-this.c*this.vel)/this.m,this.vel=this.vel+this.accel*t,this.magnitude=this.magnitude+this.vel*t,Math.abs(this.vel)<=1e-4&&0<Math.abs(this.magnitude)&&(this.vel=0,this.magnitude=0,this.accel=0)},this.shake=function(t){this.vel+=t}},(twitterHandler=new function(){this.image=document.getElementById("twetGraphic"),this.kitty=document.getElementById("kittyGraphic"),this.anchor=document.getElementById("twetAnchor"),this.url=document.location.href,this.via="mrlasertron",this.hashtags="gamedev,js13k,html5",this.image.height=r/3,this.image.width=r/3,this.kitty.height=r/3,this.kitty.width=r/3,this.text=[],this.text.push("what%20a%20terrible%20night%20for%20a%20html5%20game%20curse!"),this.text.push("what%20is%20a%20man%20but%20a%20miserable%20pile%20of%20html5%20games.."),this.text.push("frankly%20i%20find%20the%20idea%20of%20a%20brain%20html5%20game%20in%203D%20offensive!"),this.text.push("%3A%3Aloads%20power%20loader%3A%3A%20Where%20do%20you%20want%20it%3F%20%3A%3Achuckles%3A%3A%20Bay%2013kjs."),this.text.push("Check%20out%20my%20entry%20in%20the%20js13k%20game%20compo,%20sPhere"),this.setText=function(){var t=this.text[Math.floor(d(0,this.text.length-1))];this.anchor.href="https://twitter.com/intent/tweet?text="+t+"&via="+this.via+"&url="+this.url+"&hashtags="+this.hashtags}}).setText(),tm={current:Date.now(),last:null,step:function(){this.last=this.current,this.current=Date.now()},delta:function(){return this.current-this.last}},sphere=function(){for(var t=[],e=0;e<30;e++){t.push([]);for(var s=0;s<30;s++)t[e].push({theta:12*e/360*Math.PI*2,phi:6*s/360*Math.PI*2})}return t}(),paddle=new function(t,s,h){this.vertex=h,this.frontColor="rgba(20,160,80,0.9)",this.rearColor="rgba(20,160,80,0.4)",this.deg=.5084,isInFront=!0,this.update=function(){var t=i((t=e(r,this.vertex.theta+delta.theta,this.vertex.phi)).x,t.y,t.z,sphere_tau);this.isInFront=0<t.z},this.draw=function(){ctx.beginPath(),this.vertex,i((t=e(r,this.vertex.theta+delta.theta,this.vertex.phi)).x,t.y,t.z,sphere_tau);var t=i((t=e(r,this.vertex.theta-this.deg/2+delta.theta,this.vertex.phi-this.deg/2)).x,t.y,t.z,sphere_tau),s=i((s=e(r,this.vertex.theta+this.deg/2+delta.theta,this.vertex.phi-this.deg/2)).x,s.y,s.z,sphere_tau),h=i((h=e(r,this.vertex.theta+this.deg/2+delta.theta,this.vertex.phi+this.deg/2)).x,h.y,h.z,sphere_tau),a=i((a=e(r,this.vertex.theta-this.deg/2+delta.theta,this.vertex.phi+this.deg/2)).x,a.y,a.z,sphere_tau);ctx.moveTo(Math.round(t.x),Math.round(t.y)),ctx.lineTo(Math.round(s.x),Math.round(s.y)),ctx.lineTo(Math.round(h.x),Math.round(h.y)),ctx.lineTo(Math.round(a.x),Math.round(a.y)),ctx.fillStyle=this.isInFront?this.frontColor:this.rearColor,ctx.fill()}}(0,0,sphere[15][15]),stars=mobile?t(200):t(500),(balls=[new function t(h,a,o,n,l,c,u){this.trueRadius=25,deleteMe=!1,this.color=h,this.pos={x:a,y:o,z:n},this.vel={x:l,y:c,z:u},this.tolerance=10,this.insideSphere=!0,this.hasBounced=!1,this.bounceTimerCounter=0,this.isCaught=!1,this.update=function(){this.vel.y=0,this.pos.y=0;var t,s,i,h,a,o,n=Math.sqrt(this.pos.x*this.pos.x+this.pos.y*this.pos.y+this.pos.z*this.pos.z);this.isCaught?(s=e(r-20,paddle.vertex.theta+delta.theta,paddle.vertex.phi),this.pos.x=s.x,this.pos.y=s.y,this.pos.z=s.z):n>r+r/2?1==balls.length?(this.isCaught=!0,menuState=!0,this.vel.x=0,this.vel.y=0,this.vel.z=0):this.kill():n<r+this.tolerance&&n>r-this.tolerance&&(s=this.pos.x,i=this.pos.y,h=this.pos.z,a=Math.sqrt(s*s+i*i+h*h),o=Math.sqrt(h*h+s*s),h=0<=-h?Math.asin(s/o):Math.PI-Math.asin(s/o),(o={rho:a,theta:h=0==o?0:h,phi:Math.acos(-i/a)}).theta=o.theta%(2*Math.PI),o.theta=Math.acos(Math.cos(o.theta)),h=(paddle.vertex.theta+delta.theta)%(2*Math.PI),h=Math.acos(Math.cos(h)),i=e(r,paddle.vertex.theta+delta.theta,Math.PI/2),o.theta<0&&(o.theta+=2*Math.PI),!this.hasBounced&&o.theta<(h+paddle.deg/2)%(2*Math.PI)&&o.theta>(h-paddle.deg/2)%(2*Math.PI)&&0<=i.x*this.pos.x&&(this.hasBounced=!0,a=e(r,paddle.vertex.theta+delta.theta,paddle.vertex.phi),o=Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z),a.x=a.x/o,a.y=0,a.z=a.z/o,this.vel=(h=a,i=this.vel,s=Math.sqrt(h.x*h.x+h.y*h.y+h.z*h.z),{x:(t=-2*(h.x*i.x/s+h.y*i.y/s+h.z*i.z/s))*h.x/s+i.x,y:t*h.y/s+i.y,z:t*h.z/s+i.z}),this.vel.x*=1.05,this.vel.z*=1.05,score+=13,sphereShaker.shake(300),score%39==0)&&this.multiball(2,a,o),n>r)&&(this.insideSphere=!1),this.pos.x+=this.vel.x*tm.delta(),this.pos.z+=this.vel.z*tm.delta(),this.hasBounced&&(this.bounceTimerCounter++,10<this.bounceTimerCounter)&&(this.bounceTimerCounter=0,this.hasBounced=!1)},this.draw=function(){var t=i(this.pos.x,this.pos.y,this.pos.z,sphere_tau),e=s(this.trueRadius,this.trueRadius,3*t.z).x;ctx.beginPath(),ctx.arc(t.x,t.y,e,0,2*Math.PI,!1),ctx.fillStyle=this.color,ctx.closePath(),ctx.fill(),ctx.strokeStyle="black",ctx.stroke(),this.insideSphere},this.kill=function(){this.deleteMe=!0},this.explode=function(){this.deleteMe=!0},this.checkCollision=function(){},this.pitch=function(){this.hasBounced=!0,this.isCaught=!1,score=0;var t=r/2e3,e=Math.sqrt(this.pos.x*this.pos.x+this.pos.y*this.pos.y+this.pos.z*this.pos.z);this.vel.x=-this.pos.x/e*t,this.vel.y=-this.pos.y/e*t,this.vel.z=-this.pos.z/e*t},this.multiball=function(e,s,i){for(var h=0;h<e;h++){var a="rgb("+Math.floor(d(120,190))+","+Math.floor(d(120,190))+","+Math.floor(d(120,190))+")",r=Math.sqrt(this.vel.x*this.vel.x+this.vel.z*this.vel.z);balls.push(new t(a,s.x*i,s.y*i,s.z*i,-s.x*(r+d(-.03,.03)),0,-s.z*(r+d(-.03,.03)))),(a=balls[balls.length-1]).pos.x+=a.vel.x*tm.delta(),a.pos.z+=a.vel.z*tm.delta(),a.hasBounced=!0}}}("green",0,0,0,0,0,0)])[0].isCaught=!0,function t(){ctx.clearRect(0,0,cvs.width,cvs.height),ctx_viewport.clearRect(0,0,cvs.width,cvs.height),o=cvs.width,cvs.width=1,cvs_viewport.width=1,cvs.width=o,cvs_viewport.width=o,tm.step(),paddle.update();for(var s=0;s<stars.length;s++)stars[s].update();for(var h=0;h<balls.length;h++)balls[h].update();for(isMouseDown||(delta.theta+=sphereVelocity.x),sphereVelocity.x=.95*sphereVelocity.x,Math.abs(sphereVelocity.x)<.005&&(sphereVelocity.x=0),sphereShaker.update(),s=balls.length-1;0<=s;s--)1==balls[s].deleteMe&&(1==balls.length?balls[s].isCaught:(delete balls[s],balls.splice(s,1)));menuState&&(delta.theta+=1e-4*tm.delta(),mobile?menu.style.visibility="visible":menu.style.left=0),ctx.save(),ctx.translate(cvs.width/2,cvs.height/2);for(var a=0;a<stars.length;a++)ctx.beginPath(),stars[a].draw(),ctx.fill();paddle.isInFront||paddle.draw();for(var o,n=0;n<balls.length;n++)balls[n].draw();ctx.lineWidth=2.5;for(var l=mobile?2:1,c=0;c<sphere.length;c+=l){ctx.beginPath();var d=i((d=e(r+sphereShaker.magnitude,sphere[c][0].theta+delta.theta,sphere[c][0].phi)).x,d.y,d.z,sphere_tau);ctx.moveTo(Math.round(d.x),Math.round(d.y));for(var u=1;u<sphere[c].length;u+=l){var x=i((x=e(r+sphereShaker.magnitude,sphere[c][u].theta+delta.theta,sphere[c][u].phi)).x,x.y,x.z,sphere_tau);ctx.lineTo(Math.round(x.x),Math.round(x.y)),15==u&&(ctx.strokeStyle=0<x.z?"rgba(255,255,255,0.8)":"rgba(190,190,190,0.6)")}ctx.stroke()}paddle.isInFront&&paddle.draw(),ctx.font="50px Impact,Charcoal,sans-serif",ctx.textBaseline="top",ctx.fillStyle="rgba(100,100,100,0.9)",ctx.fillText(score,5*-cvs.width/11,5*-cvs.height/11+60),ctx.fillStyle="rgba(200,200,200,0.9)",ctx.fillText(score,5*-cvs.width/11-3,5*-cvs.height/11+57),ctx_viewport.drawImage(cvs,0,0),window.requestAnimationFrame(function(){t()})}()</script>