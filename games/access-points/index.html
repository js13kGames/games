<script src=/2018/webxr/aframe.js></script><script>function entierAleatoire(t,e){return Math.floor(Math.random()*(e-t+1))+t}function createObject(t,e,o,i=null,r=null,n=null,l=null,a=null){return object=document.createElement(t),object.setAttribute("width",e),object.setAttribute("height",o),object.setAttribute("depth",i),object.setAttribute("position",r),object.setAttribute("rotation",n),object.setAttribute("color",l),object.setAttribute("opacity",null!=a?a:1),object}function createAnimation(t,e,o,i,r,n,l){return animation=document.createElement("a-animation"),animation.setAttribute("attribute",t),animation.setAttribute("to",e),animation.setAttribute("easing",o),animation.setAttribute("delay",i),animation.setAttribute("direction",r),animation.setAttribute("dur",n),animation.setAttribute("repeat",l),animation}function initGround(){AFRAME.registerComponent("ground",{init:function(){this.el.appendChild(createObject("a-plane",45,45,null,offset/2+" -0.04 "+offset/2,"-90 0 0","darkgreen")),this.el.appendChild(createObject("a-plane",25,25,null,offset/2+" -0.02 "+offset/2,"-90 0 0","dimgrey")),this.el.appendChild(createObject("a-plane",20.5,20.5,null,offset/2+" -0.01 "+offset/2,"-90 0 0","white")),this.el.appendChild(createObject("a-plane",25.5,25.5,null,offset/2+" -0.03 "+offset/2,"-90 0 0","white"))}})}function initQuartier(){AFRAME.registerComponent("quartier",{init:function(){for(position of(house_positions=[{x:3,y:2,z:-7,color:"lightsteelblue",width:8,depth:5,rotation:-90,door:2},{x:16,y:2,z:-7,color:"azure",width:8,depth:5,rotation:-90,door:2},{x:27,y:2,z:3,color:"brown",width:5,depth:8,rotation:0,door:-2},{x:27,y:2,z:16,color:"blue",width:5,depth:8,rotation:0,door:-2},{x:16,y:2,z:27,color:"yellow",width:8,depth:5,rotation:90,door:-2},{x:3,y:2,z:27,color:"purple",width:8,depth:5,rotation:90,door:-2}],house_positions))home=createObject("a-box",position.width,6,position.depth,position.x+" "+position.y+" "+position.z,null,position.color),home.appendChild(createObject("a-box",position.width+2,.5,position.depth+1,"0.5 -2 0",null,"black")),this.el.appendChild(home),width=position.width-.02,depth=position.depth-1,pos="0 3 0",height=position.depth-2,0!==position.rotation&&(width=position.depth-.02,depth=position.width-1,pos="0 3 0",height=position.width-2),home.appendChild(createObject("a-box",width,height,depth,pos,"-45 "+position.rotation+" 0","black")),home.appendChild(createObject("a-box",2,3.3,2,"-2 -0.5 "+position.door,"0 "+(position.rotation+90)+" 0","black")),home.appendChild(createObject("a-box",position.width-3,2,position.depth-3,"-1.7 0.8 1","0 "+(position.rotation+90)+" 0","black",.4))}})}function initCarrelage(){AFRAME.registerComponent("carrelage",{init:function(){for(size=20,centered=size/2,i=0;i<size;i++)for(j=0;j<size;j++)box=document.createElement("a-box"),x=offset/2+i-centered+.5,y=offset/2+j-centered+.5,position=x+" -10 "+y,animation=createAnimation("position",x+" 0 "+y,"ease",1*(i-10)*(j-10)*2*3,"normal",2e3,0),box.setAttribute("color",(i+j)%2?"darkgray":"gray"),box.setAttribute("position",position),box.setAttribute("height","0.1"),this.el.appendChild(box),box.appendChild(animation)}})}function initView(){AFRAME.registerComponent("view",{init:function(){for(cables=[{color:"yellow",position_x:-.075},{color:"blue",position_x:-.025},{color:"green",position_x:.025},{color:"brown",position_x:.075}],pins=[{position_x:-.075},{position_x:-.025},{position_x:.025},{position_x:.075}],cable=createObject("a-box",.25,.5,.3,"0 -0.6 0",null,"black",0),cable.setAttribute("id","cable"),this.el.appendChild(cable),text=createObject("a-plane",.25,"auto",null,"-0.35 0.6 0.15",null,"black"),text.setAttribute("id","error"),text.setAttribute("text",default_error+level+"\nLives: ooo"),this.el.appendChild(text),text=createObject("a-plane",.35,"auto",null,"0.35 0.6 0.15",null,"black"),text.setAttribute("id","score"),text.setAttribute("text",default_score+best_score+"\nScore: "+nb_active+"/"+level*box_per_level),this.el.appendChild(text),i=0;i<4;i++)cable.appendChild(createObject("a-box",.03,.8,.1,cables[i].position_x+" -0.32 0",null,cables[i].color)),cable.appendChild(createObject("a-box",.03,.1,.2,pins[i].position_x+" 0.12 -0.05",null,"black"));plug=createObject("a-box",.25,.2,.15,"0 0.1 0.05",null,"white",.9),cable.appendChild(plug),text2=createObject("a-plane",.2,"auto",null,"0 0 0.15",null,"black"),text2.setAttribute("text","align:center; font: "+font+"; width: 1.5; value: RJ45"),plug.appendChild(text2)}})}function click(){cable=document.getElementById("cable"),cable.setAttribute("position","0 -0.3 0"),setTimeout((function(){cable.setAttribute("position","0 -0.6 0")}),500)}function initCartons(){AFRAME.registerComponent("cartons",{schema:{type:"int",default:1},update:function(){if(0!=started){for(box={},i=0;i<level*box_per_level;i++)if(index=i,x=entierAleatoire(1,19),y=entierAleatoire(1,19),r=entierAleatoire(0,45),-1!==checker.indexOf(x+"-"+y))i--;else for(checker.push(x+"-"+y),routers.push({activated:0==i,id:x+"-"+y,x:x,y:y}),position=x+" 10 "+y,rotation="0 "+r+" 0",color="darkblue",0==i&&(color="green"),box[i]=createObject("a-cylinder",1,1.3,1,position,"0",color,.1),box[i].setAttribute("radius","0.55"),box[i].setAttribute("id",x+";"+y),box[i].setAttribute("data-index",index),box[i].setAttribute("data-id",x+";"+y),box[i].addEventListener("click",(t=>{0!=started&&(box_id=t.srcElement.dataset.id,box_index=t.srcElement.dataset.index,click(),checkBestCube(box_id,box_index))})),animation=createAnimation("position",x+" 0.5 "+y,"ease",x*y*10,"alternate",1500,.1),box[i].appendChild(animation),line=createObject("a-cylinder",.3,0,null,"0 -0.6 0","-90 0 0",color,null),line.setAttribute("radius","0.2"),box[i].appendChild(line),this.el.appendChild(box[i]),j=0;j<6;j++)torus=createObject("a-torus",1,1,null,"0 "+(j/6-.3)+" 0","90 0 0",j%2?color:"white",null),torus.setAttribute("radius-tubular",.2),torus.setAttribute("radius","0.4"),torus.setAttribute("radius-tubular","0.05"),box[i].appendChild(torus);bestCube(0)}}})}function initCursor(){AFRAME.registerComponent("cursor-listener",{init:function(){this.el.addEventListener("click",(t=>{click()}))}})}function checkBestCube(t,e){if(routers[e]&&!routers[e].activated){for(best_point of(position=t.split(";"),best_points))if(position[0]==best_point.x&&position[1]==best_point.y)return cube=document.getElementById(t),cube.setAttribute("color","green"),cube.querySelectorAll('a-torus[color="darkblue"]')[0].setAttribute("color","green"),cube.querySelectorAll('a-torus[color="darkblue"]')[0].setAttribute("color","green"),cube.querySelectorAll('a-torus[color="darkblue"]')[0].setAttribute("color","green"),old=active,addLine(best_point,cube,old,position),active=e,nb_active++,updateScore(),routers[e].activated=!0,void(nb_active==level*box_per_level?setTimeout((function(){win()}),500):bestCube(e));cube=document.getElementById(t),cube.querySelectorAll('a-torus[color="darkblue"]').length>0&&(cube.querySelectorAll('a-torus[color="darkblue"]')[0].setAttribute("color","red"),cube.querySelectorAll('a-torus[color="darkblue"]')[0].setAttribute("color","red"),cube.querySelectorAll('a-torus[color="darkblue"]')[0].setAttribute("color","red")),cube.setAttribute("color","red"),error++,checkError(),setTimeout((function(){cube.setAttribute("color","black"),cube.querySelectorAll('a-torus[color="red"]').length>0&&(cube.querySelectorAll('a-torus[color="red"]')[0].setAttribute("color","darkblue"),cube.querySelectorAll('a-torus[color="red"]')[0].setAttribute("color","darkblue"),cube.querySelectorAll('a-torus[color="red"]')[0].setAttribute("color","darkblue"))}),500)}}function checkError(){text_error=0==error?"ooo":1==error?"oo-":2==error?"o--":"---",document.getElementById("error").setAttribute("text",default_error+level+"\nLives: "+text_error),3==error&&lose()}function updateScore(){nb_active>best_score&&(best_score=nb_active),document.getElementById("score").setAttribute("text",default_score+best_score+"\nScore: "+nb_active+"/"+level*box_per_level)}function addLine(t,e,o,i){line=e.querySelector("a-cylinder"),x=(t.x+routers[o].x)/2,y=(t.y+routers[o].y)/2,tanx=t.x-routers[o].x,tany=t.y-routers[o].y,rotation=180*Math.atan2(tany,tanx)/Math.PI,position_x=routers[o].x-x,position_y=routers[o].y-y,line.setAttribute("position",position_x+" 0 "+position_y),line.setAttribute("rotation","-90 "+(90+-1*rotation)+" 0"),line.setAttribute("color","green"),line.setAttribute("height",t.distance-1)}function bestCube(t){a=routers[t];var e=null;for(b of routers)b.activated||(distance=Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2)),(null==e||e>=distance)&&(b.distance=distance,e==distance?best_points.push(b):best_points=[b],e=distance))}function win(){showMessage("Yeah, you WIN !","white","Ready for next level ?","Go to next level")}function lose(){showMessage("GAME OVER","brown","Do you want to restart ?","Restart")}function showMessage(t,e,o,i){document.getElementById("camera").setAttribute("rotation","0 -90 0"),document.getElementById("camera").setAttribute("position","-5 1.8 10"),document.getElementById("text_1").setAttribute("text","value:"+t+";color:"+e),document.getElementById("text_2").setAttribute("text","value:"+o),document.getElementById("text_3").setAttribute("text","value:"+i);var r=createAnimation("position","-2 1.8 10","ease",0,"normal",500,0);document.getElementById("play").appendChild(r)}function restart(){document.getElementById("cartons").innerHTML="",initVars(),updateScore(),checkError(),setTimeout((()=>{document.getElementById("cartons").setAttribute("cartons",(100*Math.random()).toString())}),400)}function initPlay(){AFRAME.registerComponent("play",{init:function(){box=createObject("a-box",.5,2,3,"0 -10 10",null,"dimgrey",.95),animation=createAnimation("position","-2 1.8 10","ease",1e3,"normal",2e3,0),box.setAttribute("id","play"),box.appendChild(animation),this.el.appendChild(box),pied=createObject("a-cylinder",1,1,1,"0 -1.5 -1.2","0","black",.9),pied.setAttribute("radius","0.15"),box.appendChild(pied),pied=createObject("a-cylinder",1,1,1,"0 -1.5 1.2","0","black",.9),pied.setAttribute("radius","0.15"),box.appendChild(pied),text1=createObject("a-plane",2.4,"auto","0","-0.3 0.7 0.05","0 -90 0","dimgrey",.95),text1.setAttribute("id","text_1"),text1.setAttribute("text","align:center; color : brown; font: "+font+"; width: 6; value: Access Points"),box.appendChild(text1),text2=createObject("a-plane",2.4,"auto","0","-0.3 0.15 0.05","0 -90 0","dimgrey",.95),text2.setAttribute("id","text_2"),text2.setAttribute("text","align:center; color : white; font: "+font+"; width: 2.8; value: All the city internet network is broken, you need to reconnect the nearest access points between them"),box.appendChild(text2),plug=createObject("a-box",2.5,.5,.15,"-0.3 -0.5 0.05","0 -90 0","white",.9),box.appendChild(plug),text3=createObject("a-plane",2.4,"auto",null,"0 0.05 0.10",null,"white",.9),text3.setAttribute("id","text_3"),text3.setAttribute("text","align:center; color : green; font: "+font+"; width: 6; value: Play"),plug.appendChild(text3),text3.addEventListener("click",(t=>{document.getElementById("play").setAttribute("position","0 -10 10"),document.getElementById("camera").setAttribute("wasd-controls",""),started?level=3==error?1:level+1:(level=1,started=!0),localStorage.setItem("level",level),restart()}))}})}function initVars(){checker=[],routers=[],best_points=[],active=0,score=0,error=0,nb_active=1}font="kelsonsans",offset=20,box_per_level=4,level=localStorage.getItem("level")?parseInt(localStorage.getItem("level")):1,best_score=localStorage.getItem("best_score")?parseInt(localStorage.getItem("best_score")):0,default_score="align:center; font: "+font+"; width: 1; value: Best score: ",default_error="align:center; font: "+font+"; width: 1; value: Level: ",started=!1,initVars(),initGround(),initQuartier(),initCarrelage(),initPlay(),initCursor(),initView(),initCartons()</script><body><a-scene><a-assets></a-assets><a-entity ground></a-entity><a-entity quartier></a-entity><a-entity play></a-entity><a-entity carrelage cursor-listener></a-entity><a-entity box></a-entity><a-entity id=cartons cartons=0></a-entity><a-sky color=#393939></a-sky><a-entity id=camera camera="active: true" data-aframe-default-camera look-controls position="-5 2 10" rotation="0 -90 0" wasd-controls><a-cursor color=white><a-entity view></a-entity></a-cursor></a-entity></a-scene><div class=copyright>Made by <a href=https://www.julienkermarec.com/ target=_blank>Julien KERMAREC</a> for <a href=https://js13kgames.com/ target=_blank>js13kGames Competition</a>.</div><style>.copyright{position:absolute;bottom:0;left:0;padding:10px 15px;color:#fff;background-color:#000;font:400 0.7rem/1.3 Helvetica,Arial,sans-serif}.copyright a:-webkit-any-link{cursor:pointer;text-decoration:none!important;color:#fff!important;font-weight:700}</style>