let e;function t(){e.on("start",()=>{"start"!=q&&(q="start",console.log("Game start"),j(x),ce())}),e.on("connect",()=>{console.log("Connected")}),e.on("disconnect",()=>{console.log("Connection lost!")}),e.on("updateUsers",t=>{console.log("updateUsers",t.map(e=>Object.assign({},e))),x=t.find(t=>t.id===e.id),$=t,$.forEach(e=>{e.stats=C[e.id]||Object.assign({},r),C[e.id]=e.stats}),"lobby"===q&&($.forEach((e,t)=>{const n=document.querySelector(".board .hidden .char."+e.char);n&&(document.querySelector(".map").appendChild(n),F(e,t))}),M[5].players=t,R()),I()})}function n(){e=window.io(),t()}function a(t){e.emit("join",t)}function o(t){const n=x.nextChoice;console.log("Submit choice",Object.assign({},n)),e.emit("choice",n),t()}function s(){e.emit("move")}function i(){e.emit("resetChoice")}function l(){e.emit("forceStart")}const c="Waiting for others...",r={gold:1,influence:4,relics:0,prayCount:0,sinCount:0},d="null",u="bank",m="court",f="temple",h="eden",p="hell",y="plaza",b="gold",g="influence",v="relics";let $=[],x=null,C={},q="lobby",S=0;const M=[u,m,f,h,p,y].map((e,t)=>({index:t+1,name:e,players:[]})),T={bank:[{name:"Interest Return",labels:["ðŸ’° + ðŸ’° / 5 âšœï¸"],effect:e=>(e.stats.gold+=1+Math.floor(e.stats.influence/5),`${e.name} earned ${1+Math.floor(e.stats.influence/5)} gold from interest.`),disabled:e=>!1}],court:[{name:"Tax Reform",labels:["Tax rich or all?"],options:[{name:"Tax Richest",labels:["Richest ðŸ‘¤ -20% ðŸ’°"],effect(e){const t=[...$].sort((e,t)=>e.stats.gold>t.stats.gold?1:e.stats.gold<t.stats.gold?-1:0).pop(),n=Math.ceil(.2*t.stats.gold);return t.stats.gold-=n,e.nextChoice.target=$.findIndex(e=>e===t),`Player ${t.name} was taxed ${n} ðŸ’° by player ${e.name}`}},{name:"Tax all",labels:["All players -10% ðŸ’°"],effect:e=>($.forEach(e=>{const t=Math.ceil(.1*e.stats.gold);e.stats.gold-=t}),"Each player was taxed 10% ðŸ’° by player "+e.name)}],effect(e,t){const n=t.options[e.nextChoice.option-1];return n||console.error("option not found",e.nextChoice.option,e),n.effect(e)},disabled:()=>!1},{name:"Embezzlement",labels:["-1 âšœï¸","+2 ðŸ’°",,"+1 ðŸº"],effect:e=>(e.stats.influence-=1,e.stats.gold+=2,e.stats.relics+=1,e.name+" embezzled gold and relics."),disabled:e=>e.stats.influence<1}],temple:[{name:"Offering",labels:["-1 ðŸº","+3 âšœï¸"],effect:e=>(e.stats.influence+=3,e.stats.relics-=1,e.name+" donated a relic to the temple"),disabled:e=>e.stats.relics<1},{name:"Donation",labels:["-1 ðŸ’°","+1 âšœï¸"],effect:e=>(e.stats.gold--,e.stats.influence++,e.name+" made a gold donation to the temple"),disabled:e=>e.stats.gold<1},{name:"Pray",labels:["ðŸ™"],effect:e=>(e.stats.prayCount++,e.name+" is praying at the temple"),disabled:()=>!1}],eden:[{name:"Blessing",labels:["Random Blessing"],effect:e=>e.name+" was blessed",disabled:()=>!1},{name:"Enlightenment",labels:["Get 1 âšœï¸ per Pray ðŸ™"],effect:e=>(e.stats.influence+=e.stats.prayCount,`${e.name} received enlightenment: ${e.stats.prayCount} âšœï¸`),disabled:()=>!1},{name:"Judgement",labels:["no pray = -1 âšœï¸"],effect(e){const t=$.filter(e=>0==e.stats.prayCount);return t.map(e=>e.stats.influence--),t.map(e=>e.name).join(", ")+" received judgement from not praying: -1 âšœï¸"},disabled:()=>!1}],hell:[{name:"Wrath",labels:["-2 âšœï¸ per sin"],effect:e=>($.filter(t=>t!==e).map(t=>{t.stats.influence-=2*e.stats.sinCount}),e.name+" caused non-prayers to lose âšœï¸"),disabled:()=>!1},{name:"Deluge",labels:["Players on Earth -1 ðŸ’°/ðŸº","+1 ðŸ’°/ðŸº otherwise"],effect:e=>e.name+" caused a damnation",disabled:()=>!1},{name:"Temptation",labels:["Cause player to sin"],targetPlayer:!0,effect(e){const t=$[e.nextChoice.target-1],n=Object.keys(w)[S%7];return w[n](t),`${e.name} made player ${t.name} commit the sin of ${n}`},disabled:()=>!1}]},w={lust(e){e.stats.sinCount++},gluttony(e){e.stats.sinCount++},greed(e){e.stats.sinCount++},sloth(e){e.stats.sinCount++},wrath(e){},envy(e){e.stats.sinCount++},pride(e){e.stats.sinCount++}},L={devotee(){const{stats:e}=$.find(e=>"saint"===e.char);return e.gold+e.influence+e.relics>=10},saint:()=>$.reduce((e,t)=>e+t.stats.prayCount,0)>15,baal:()=>$.reduce((e,t)=>e+t.stats.sinCount,0)>=7,marx:()=>!!$.find(e=>["saint","devotee","baal"].includes(e.char)&&e.stats.influence<=0),dissident:()=>$.find(e=>"dissident"===e.char).stats.gold>=20};function E(){$.forEach(e=>{const t=M[e.location-1],n=M[e.nextChoice.location-1];n?(t&&(t.players=t.players.filter(t=>t.name!==e.name)),n.players.push(e),e.location=M.indexOf(n)+1):t&&(t.players.push(e),e.location=M.indexOf(t)+1),j(e)}),R(),I(),s()}function j(e){e.nextChoice={location:null,action:null,option:null,target:null}}function A(e,t){x.nextChoice[t]=e}let H=1;function k(e,t,n,a){requestAnimationFrame(()=>{document.querySelector(".actions .options").innerHTML="",t.map((t,o)=>{const s=document.createElement("div");s.innerHTML=t.html,s.className="btn",t.disabled||"winner"===e?s.classList.add("disabled"):s.onmousedown=()=>{A(o+1,n),document.querySelectorAll(".btn").forEach(e=>e.classList.remove("pressed")),s.classList.add("pressed"),a&&(document.querySelector(".actions .title").innerHTML=a,qe(".actions .title"))},document.querySelector(".actions .options").appendChild(s)}),document.querySelector(".actions .title").innerHTML=e,qe(".actions .title")})}function z(e,t,n){if(document.querySelector(".actions .options").innerHTML="",document.querySelector(".actions .title").innerHTML=e.map((e,t)=>`<div class="${t>0?"message":"text"}">${e}</div>`).join(""),t){const e=document.createElement("div");e.innerHTML=n,e.className="btn text",e.onclick=()=>t(),document.querySelector(".actions .options").appendChild(e)}qe(".actions .text")}const O=4,P={};function F(e,t){const n=document.querySelector(".map ."+e.char);let a,o;$.indexOf(e)%2==0?(a=-4-4*t,o=51):(a=68+4*t,o=51),P[e.char]={x:a,y:o},n.style.transform=`translateX(calc(var(--pixel-size) * ${a})) translateY(calc(var(--pixel-size) * ${o}))`}let _=0;function R(){$.forEach((e,t)=>{_++;const n=document.querySelector(".map .char."+e.char),a=M[e.location-1],o=a.name,s=document.querySelector("."+o);let i=s.offsetLeft/H,l=s.offsetTop/H,c=a.players.indexOf(e);[m,p].includes(o)?i-=5*c:[f,y].includes(o)?c%2?i+=(1+c)/2*5:i-=c/2*5:i+=5*c;const r=()=>{const t=P[e.char].x-i,a=30*Math.abs(t),o=Math.round(Math.abs(t)/2);return n.style.transition=`transform ${a}ms linear`,n.style.transitionTimingFunction=`steps(${o})`,n.style.transform=n.style.transform.replace(/translateX\(.+\) t/,`translateX(${i*H}px) t`),a},d=()=>{const t=P[e.char].y-l,a=30*Math.abs(t),o=Math.round(Math.abs(t)/2);return n.style.transition=`transform ${a}ms linear`,n.style.transitionTimingFunction=`steps(${o})`,n.style.transform=n.style.transform.replace(/translateY\(.+\)/,`translateY(${l*H}px)`),a};n.classList.add("animated"),[f].includes(o)?setTimeout(()=>{setTimeout(()=>{n.classList.remove("animated"),P[e.char]={x:i,y:l},_--},d()+100)},r()+100):setTimeout(()=>{setTimeout(()=>{n.classList.remove("animated"),P[e.char]={x:i,y:l},_--},r()+100)},d()+100)})}function I(){document.querySelector(".stats").innerHTML=$.map(e=>`<div class="player ${e.char}${e===x?" local":""}">\n      <div class="avatar char ${e.char}"></div>\n      <div>\n        <div class="text gold">${e.stats.gold}</div>\n        <div class="text relics">${e.stats.relics}</div>\n        <div class="text influence">${e.stats.influence}</div>\n      </div>\n    </div>`).join(""),qe()}function G(){$.forEach(e=>{document.querySelector(`.player.${e.char} .gold`).innerHTML=""+e.stats.gold,document.querySelector(`.player.${e.char} .relics`).innerHTML=""+e.stats.relics,document.querySelector(`.player.${e.char} .influence`).innerHTML=""+e.stats.influence}),qe()}function N(){k("Go to",[...M].splice(0,5).map(({name:e,index:t})=>({title:e,html:`${t}._${e}`,disabled:t===x.location})),"location",c),qe(".btn")}function W(){const e=x.location,t=M[e-1].name;k("Choose an action",T[t].map((e,t)=>({title:e.name,disabled:e.disabled(x),html:`<div class="action-title">${t+1}._${e.name}</div>\n        <div class="labels">${e.labels.map(e=>`<div>${e}</div>`).join("")}</div>`})),"action"),qe(".action-title")}function X(e){k("Choose an option",e.map((e,t)=>({title:e.name,disabled:!1,html:`<div class="action-title">${t+1}._${e.name}</div>\n      <div class="labels">${e.labels.map(e=>`<div>${e}</div>`).join("")}</div>`})),"option"),qe(".action-title")}function Y(){k("Choose target player",$.filter(e=>e!==x).map((e,t)=>({title:"",disabled:!1,html:`<div class="action-title">${e.name}</div><div class="char ${e.char}"></div>`})),"target"),qe(".action-title")}function B(){const e=()=>{const e=Math.min(document.documentElement.clientHeight,document.documentElement.clientWidth-150);H=2*Math.round(e/220),document.body.style.setProperty("--pixel-size",H+"px")};window.onresize=e,e()}const D=(e,t)=>{Number.isInteger(x.nextChoice[e])?t():requestAnimationFrame(()=>D(e,t))},U=(e,t)=>{$.every(t=>Number.isInteger(t.nextChoice[e]))?(console.log("All ready",$.map(e=>e.nextChoice)),t()):requestAnimationFrame(()=>U(e,t))},J=e=>{i(),N(),D("location",e)},Z=e=>{U("location",e)},K=e=>{E(),e()},Q=e=>{W(),D("action",e)},V=e=>{const t=M[x.location-1].name,n=T[t][x.nextChoice.action-1];n.options?(X(n.options),D("option",e)):e()},ee=e=>{const t=M[x.location-1].name;T[t][x.nextChoice.action-1].targetPlayer?(Y(),D("target",e)):e()},te=e=>{U("action",e)},ne=e=>{const t=["Round Results"];$.forEach(e=>{const n=M[e.location-1].name;e.nextChoice.action>T[n].length&&(e.nextChoice.action=(e.nextChoice.action-1)%T[n].length+1);const a=T[n][e.nextChoice.action-1];if(a&&!a.disabled(e)){console.log(`Player ${e.name} performs ${a.name} in ${n}`);const o=a.effect(e,a);t.push(o)}j(e),G()}),z(t,e,"continue")},ae=e=>{},oe=e=>{const t=$.filter(e=>L[e.char]());if(t.length>0){t.map(e=>`<div class="action-title">${e.name}</div>\n      <div class="char ${e.char}"></div>`);k(`Game Over. Winner${t.length>1?"s":""}:`,t.map((e,t)=>({title:"winner",disabled:!1,html:`<div class="action-title">${e.name}</div><div class="char ${e.char}"></div>`})),"target"),qe(".action-title"),q="end"}requestAnimationFrame(()=>e())},se=e=>{_>0?requestAnimationFrame(()=>se(e)):e()};let ie;const le=e=>()=>(ie=e.name,console.log("State",ie),new Promise(e)),ce=()=>{S++,"start"===q&&le(se)().then(le(J)).then(le(o)).then(le(Z)).then(le(K)).then(le(Q)).then(le(V)).then(le(ee)).then(le(o)).then(le(te)).then(le(ne)).then(le(oe)).then(le(ce))};function re(){requestAnimationFrame(()=>{le(pe)().then(e=>{he=me,z([c],l,"Start_against_PC"),a(e)})})}const de=8,ue=13;function me(e,t){if("12345".includes(e)){const t=document.querySelectorAll(".options .btn"),n=parseInt(e);n<=t.length&&setTimeout(()=>{const e=Array.from(t)[n-1];e.onmousedown&&e.onmousedown(null)},100)}else if(13===t){const e=document.querySelector(".options .btn:only-child");e&&setTimeout(()=>{e.onmousedown?e.onmousedown(null):e.onclick&&e.onclick(null)},100)}}function fe(e,t){const n=document.querySelector("input");if(n.value.length<7&&e.match(/^[a-zA-Z0-9]$/))n.value+=e;else if(8===t)n.value=n.value.slice(0,-1);else if(13===t){document.querySelector(".submit").onclick(null)}n.oninput(null)}let he=me;function pe(e){he=fe;let t="Anon"+Math.round(100+899*Math.random());const n=document.querySelector(".modal"),a=document.querySelector("input"),o=document.querySelector(".input"),s=document.querySelector(".submit");a.value=t,a.oninput=()=>{o.innerHTML=a.value+"|",qe(".input")},a.oninput(null),s.onclick=()=>{n.classList.add("hidden"),setTimeout(()=>e(t),200)}}window.onkeydown=e=>{const{key:t,which:n}=e;he(t,n)};const ye={},be={0:31599,2:25255,3:29326,4:19401,5:31118,6:27119,7:29266,8:31407,9:31691,"*":2728,"-":448,a:31613,b:31663,c:31015,d:27502,e:31143,f:31204,g:31087,h:23533,i:29847,j:29295,k:23469,l:18727,n:27501,o:15214,p:31716,q:31590,r:27509,s:31183,t:29842,u:23407,v:23402,x:23213,y:23242,z:29351},ge={"|":31,1:31,".":1,",":3,"'":24,":":10,_:0},ve={m:1022361,w:629238},$e=(e,t)=>{Object.keys(e).forEach(n=>{const a=("000000000000000"+e[n].toString(2)).substr(-5*t).split("").map(e=>"1"===e?"<i black></i>":"<i></i>").join("");ye["_"+n]=`<div class="letter w${t}">${a}</div>`})};function xe(){$e(be,3),$e(ve,4),$e(ge,1)}function Ce(e=".text"){document.querySelectorAll(e).forEach(e=>{if(0===e.children.length){const t=e.innerHTML;e.innerHTML=t.trim().split(" ").map(e=>`<span class="word">\n        ${e.split("").map(e=>ye["_"+e.toLowerCase()]).join("")}\n      </span>`).join("")}e.classList.add("tiny-font")})}function qe(e=".text"){ye._a&&requestAnimationFrame(()=>Ce(e))}function Se(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*t),a=e[t];e[t]=e[n],e[n]=a}}window.onload=()=>{xe(),qe(),B(),n(),re()};