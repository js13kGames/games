<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Wild Catch</title><style>body,html{margin:0;height:100%;background:#000;overflow:hidden;touch-action:none}.j{position:fixed;width:112px;height:112px;border-radius:50%;background:rgba(255,255,200,.08);border:2px solid rgba(255,255,200,.3);z-index:10;display:none}.jh{position:absolute;width:36px;height:36px;border-radius:50%;background:rgba(255,255,150,.6);top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none}#L{bottom:36px;left:36px}#R{bottom:36px;right:36px}@media (pointer:coarse){.j{display:block}}</style><canvas id=C></canvas><div id=L class=j><div class=jh></div></div><div id=R class=j><div class=jh></div></div><script>function t(t,n,o){return t+(n-t)*o}function n(t,n,o){let e=n-t;return e>PI?e-=2*PI:e<-PI&&(e+=2*PI),t+e*o}function o(o,e){const c=o.hist;if(!c||0===c.length)return null;if(1===c.length)return c[0];if(c[0].t>=e)return c[0];const i=c.length;if(e>=c[i-1].t)return c[i-1];for(let r=0;i-1>r;r++){const o=c[r],i=c[r+1];if(e>=o.t&&i.t>=e){const c=(e-o.t)/(i.t-o.t||1);return{t:e,x:t(o.x,i.x,c),z:t(o.z,i.z,c),yaw:n(o.yaw,i.yaw,c)}}}return c[i-1]}function e(t){I("MMO: "+t)}function c(){if(Ot)try{Ot.close()}catch(t){}e("connecting\u2026");try{Ot=new WebSocket("wss://relay.js13kgames.com/wild-catch")}catch(n){return void e("WebSocket error: "+n.message)}Ot.onopen=t=>{try{Ot.send("cat!")}catch(t){}e("connected")},Ot.onclose=t=>{e("closed"),Ot=null,xt&&setTimeout(c,1e3)},Ot.onerror=t=>{},Ot.onmessage=t=>(t=>{if("string"!=typeof t)return;switch(t[0]){case"@":return Mt=t.slice(1),void e("my id: "+Mt);case"+":{const n=t.slice(1);return void(n&&!yt.has(n)&&yt.set(n,{x:0,z:0,yaw:0,last:performance.now(),hist:[]}))}case"-":{const n=t.slice(1);return void yt.delete(n)}}let n=t;if("@"===n[0]){const t=n.indexOf("|");t>0&&(n=n.slice(t+1))}if("p"===n[0]&&"|"===n[1]){const t=n.split("|");if(t.length>=5){const n=t[1];if(n&&n!==Mt){const o=parseFloat(t[2]),e=parseFloat(t[3]),c=parseFloat(t[4]),i=yt.get(n)||{x:0,z:0,yaw:0,last:0,hist:[]},r=performance.now();((t,n,o,e,c)=>{t.hist||(t.hist=[]),t.hist.push({t:c,x:n,z:o,yaw:e}),t.last=c;const i=c-2e3;for(;t.hist.length&&i>t.hist[0].t;)t.hist.shift();t.x=n,t.z=o,t.yaw=e})(i,isFinite(o)?o:i.x,isFinite(e)?e:i.z,isFinite(c)?c:i.yaw,r),yt.set(n,i)}}}})(t.data)}function i(t){if(xt&&Ot&&1===Ot.readyState&&Mt&&(bt+=t,bt>=.1)){bt=0;const t="p|"+Mt+"|"+ft.x.toFixed(2)+"|"+ft.z.toFixed(2)+"|"+ft.yaw.toFixed(3);try{Ot.send(t)}catch(n){}}}function r(t,n,o,e,c,i,r,s,f){function a(i,r,s,a){F(t,n,o+i*l+s*u,e+r,c+s*l-i*u,a,f)}const l=COS(i-20),u=SIN(i-20);a(.1,0,0,.25),a(-.05,0,0,.25),a(-.2,0,0,.24),a(.38,.18,0,.2),a(.38,.33,.12,.08),a(.38,.4,.16,.04),a(.38,.33,-.12,.08),a(.38,.4,-.16,.04);const v=t=>SIN(t)*s,d=v(r),m=v(r+PI),w=-.3;a(.15,w+d,.14,.09),a(.15,w+m,-.14,.09),a(-.25,w+m,.15,.09),a(-.25,w+d,-.15,.09),a(-.4,.15,.5*d,.14),a(-.55,.25,0,.12),a(-.7,.3,.6*m,.11)}function s(){const t=innerWidth,n=innerHeight,o=devicePixelRatio||1;rt.width=t*o,rt.height=n*o,rt.style.width=t+"px",rt.style.height=n+"px"}function f(t,n){const o="#version 300 es\nprecision highp float;";t=o+t,n=o+n;const e=st.createProgram(),c=st.createShader(st.VERTEX_SHADER),i=st.createShader(st.FRAGMENT_SHADER);if(st.shaderSource(c,t),st.compileShader(c),!st.getShaderParameter(c,st.COMPILE_STATUS))throw st.getShaderInfoLog(c);if(st.shaderSource(i,n),st.compileShader(i),!st.getShaderParameter(i,st.COMPILE_STATUS))throw st.getShaderInfoLog(i);if(st.attachShader(e,c),st.attachShader(e,i),st.linkProgram(e),!st.getProgramParameter(e,st.LINK_STATUS))throw st.getProgramInfoLog(e);return e}function a(t,n){const o=rt.getBoundingClientRect(),e=(t-o.left)/o.width*2-1,c=1-(n-o.top)/o.height*2;return W[0]=e,W[1]=c,W[2]=-1,W[3]=1,K[0]=e,K[1]=c,K[2]=1,K[3]=1,it(W,ct,W),it(K,ct,K),E[0]=W[0]/W[3],E[1]=W[1]/W[3],E[2]=W[2]/W[3],j[0]=K[0]/K[3],j[1]=K[1]/K[3],j[2]=K[2]/K[3],U(Q,j,E),G(Q,Q),{o:E,d:Q}}function l(t,n,o){if("VR"!==t||!n){const t=COS(ft.yaw),n=SIN(ft.yaw),o=COS(ft.pitch),e=SIN(ft.pitch);return Q[0]=-n*o,Q[1]=-e,Q[2]=-t*o,E[0]=ft.x,E[1]=ft.y,E[2]=ft.z,{o:E,d:Q}}{if(o&&o.targetRaySpace){const t=n.getPose(o.targetRaySpace,pt||wt||null);if(t){const n=t.transform.matrix;return{o:[n[12],n[13],n[14]],d:[-n[8],-n[9],-n[10]]}}}for(const o of mt.inputSources)if(o.targetRaySpace){const t=n.getPose(o.targetRaySpace,pt||wt||null);if(t){const n=t.transform.matrix;return{o:[n[12],n[13],n[14]],d:[-n[8],-n[9],-n[10]]}}}const t=n.getViewerPose(pt||wt||null);if(t){const n=t.views[0].transform.matrix;return{o:[n[12],n[13],n[14]],d:[-n[8],-n[9],-n[10]]}}}return null}function u(t,n){const o=n.targetRaySpace?t.getPose(n.targetRaySpace,pt||wt||null):null;if(o){const t=o.transform.matrix;return{o:[t[12],t[13],t[14]],d:[-t[8],-t[9],-t[10]]}}return{o:[0,0,0],d:[0,0,-1]}}function v(){const t=RANDOM()*PI*2,n=40*RANDOM();Ct.x=COS(t)*n,Ct.z=SIN(t)*n,Ct.vx=Ct.vz=0,Rt.length=0}function d(t){const n=ft.x-Ct.x,o=ft.z-Ct.z,e=n*n+o*o,c=SQRT(e)||1;let i=0,r=0;if(c>50){const t=MIN(3,c/(Ct.baseS+5)),n=ft.x+ut*t-Ct.x,o=ft.z+vt*t-Ct.z,e=HYPOT(n,o)||1;i+=n/e*10*(1+.5*Ct.caught),r+=o/e*10*(1+.5*Ct.caught)}else if(c>10){const t=n/c,e=o/c,s=SIN(.2*(ft.x+ft.z))>0?1:-1;i+=1.1*t+-e*s*3,r+=1.1*e+t*s*3}else i-=n/c*4*(1+.4*Ct.caught),r-=o/c*4*(1+.4*Ct.caught);const s=SQRT(Ct.x*Ct.x+Ct.z*Ct.z)||1;s>150&&(i+=-Ct.x/s*10,r+=-Ct.z/s*10);const f=HYPOT(Ct.vx,Ct.vz)+.1,a=Ct.vx/f,l=Ct.vz/f,u=10+.6*f;for(const v of Pt){const t=v.x-Ct.x,n=v.z-Ct.z,o=v.r+1.3,e=t*t+n*n;if(o*o>e){const o=SQRT(e)||1;i-=t/o*5*(1+.5*Ct.caught),r-=n/o*5*(1+.5*Ct.caught)}else if(u*u>e){const e=t*a+n*l;if(e>0&&u>e){const c=t-a*e,s=n-l*e,f=c*c+s*s;if(o*o>f){const t=SQRT(f)||1;i-=c/t*5*(1+.5*Ct.caught),r-=s/t*5*(1+.5*Ct.caught)}}}}if(Ct.evade-=t,9>e&&0>=Ct.evade){const t=SQRT(e)||1,c=n/t,s=o/t,f=.5>RANDOM()?1:-1;i+=-s*f*50*(1+.2*Ct.caught),r+=c*f*50*(1+.2*Ct.caught),Ct.evade=.9/SQRT(1+.9*Ct.caught)}Ct.vx+=i*t,Ct.vz+=r*t;const d=Ct.baseS+.5*Ct.caught;let m=HYPOT(Ct.vx,Ct.vz)||1;if(m>d&&(Ct.vx=Ct.vx/m*d,Ct.vz=Ct.vz/m*d,m=d),Ct.x+=Ct.vx*t,Ct.z+=Ct.vz*t,m>.1){let n=ATAN2(Ct.vx,Ct.vz)-Ct.yaw;n>PI?n-=2*PI:n<-PI&&(n+=2*PI),Ct.yaw+=n*MIN(1,10*t)}Ct.vx*=1-1.1*t,Ct.vz*=1-1.1*t;const w=120>e;St=w,w&&(Ct.drop-=t,Ct.drop>0||(((t,n)=>{const o=.4>RANDOM();(o?gt:Rt).push(o?{x:t,y:.5,z:n,r:.4}:{x:t,y:.6,z:n,r:.6}),Dt&&h(Dt.currentTime,o?870:660,window.chipMusic,o?.1:.2),gt.length>100&&gt.splice(0,gt.length-100),Rt.length>3&&Rt.splice(0,Rt.length-3)})(Ct.x,Ct.z),Ct.drop=1.9+.8*RANDOM())),Ct.anim+=m*t*3.5,1>e&&(I(`Cat caught #${++Ct.caught} @ ${(new Date).toISOString().replace("T"," ").slice(0,23)}`),Dt&&(h(Dt.currentTime,800,window.chipMusic,.5),h(Dt.currentTime+.1,1e3,window.chipMusic,.3),h(Dt.currentTime+.2,1200,window.chipMusic,.4)),10>At.length&&At.push({timeLeft:15,amount:.3}),v())}function m(t){let n=0,o=0,e=0;const c=+!!It.keys.d-+!!It.keys.a,i=+!!It.keys.w-+!!It.keys.s,r=+!!It.keys.q-+!!It.keys.e,s=It.joy.L.x,f=-It.joy.L.y,a=-It.joy.R.x;if(t)for(const l of t.inputSources){const t=l.gamepad?.axes;if(!t||4>t.length)continue;const c=t=>ABS(t)>.1?t:0,i=c(t[2]),r=c(t[3]);"left"===l.handedness?(n=i,o=-r):"right"===l.handedness?e=-i:n||o||(n=i,o=-r)}return{x:n||c||s,y:o||i||f,t:e||r||a}}function w(t,n){(t=>{for(let n=At.length-1;n>=0;n--)At[n].timeLeft-=t,At[n].timeLeft>0||At.splice(n,1)})(t);const o=3*(()=>{let t=1;for(const n of At)t+=n.amount;return t})(),e=performance.now(),c=HYPOT(n.x,n.y);_t=c,c>.1&&e-zt>500&&((()=>{if(Dt&&!window.chipMusic){const t=Dt.createGain();t.gain.value=0,t.connect(Dt.destination),window.chipMusic={g:t,eng:0,last:Dt.currentTime,b0:90,b1:190,bd:60/140,next:Dt.currentTime+.05,st:0,k:"1.....1.1.1...1.",s:"....1.......1...",bl:"0_1_2_1_0___3_2_1_0___2_3_4_3_2_1_0___1_2_3_2_1_0___4_3_2___3_4_5_4_3___2_1_0___",sc:[0,2,4,5,7,9]}}})(),zt=e),ft.yaw+=2*n.t*t;const i=COS(ft.yaw),r=SIN(ft.yaw);j[0]=-r,j[1]=0,j[2]=-i,q[0]=i,q[1]=0,q[2]=-r;const s=o*t,f=ft.x,a=ft.z;ft.x+=(q[0]*n.x+j[0]*n.y)*s,ft.z+=(q[2]*n.x+j[2]*n.y)*s,ut=(ft.x-at)/t,vt=(ft.z-lt)/t,at=ft.x,lt=ft.z,((t,n)=>{const o=ft.y-1.6,e=o+1.6,c=c=>{const i=MAX(o,MIN(e,c.y));let r=ft.x-c.x,s=ft.z-c.z;const f=HYPOT(r,i-c.y,s),a=.5+c.r;if(a>f)if(1e-4>f)ft.x=t,ft.z=n;else{const t=(a-f)/f;ft.x+=r*t,ft.z+=s*t}};for(const i of Pt)c(i);for(const i of Rt)c(i);0>ft.y-1.6&&(ft.y=1.6)})(f,a),(()=>{const t=ft.y-1.6,n=t+1.6;for(const o of gt){if(0>=o.r)continue;const e=MAX(t,MIN(n,o.y));HYPOT(o.x-ft.x,o.y-e,o.z-ft.z)<o.r+.5&&(o.r=0,10>At.length&&At.push({timeLeft:15,amount:.3}),Dt&&h(Dt.currentTime,880*POW(2,(6*RANDOM()|0)/6),window.chipMusic,.2))}})()}function p(){Dt||(Dt=new(window.AudioContext||window.webkitAudioContext)),window.windPlaying||(window.windPlaying=1,(()=>{if(!Dt)return;const t=3*Dt.sampleRate,n=Dt.createBuffer(1,t,Dt.sampleRate),o=n.getChannelData(0);let e=0;for(let d=0;t>d;d++){const t=2*RANDOM()-1;o[d]=e=(e+.01*t)/1.03}const c=Dt.createBufferSource();c.buffer=n,c.loop=1;const i=Dt.createBiquadFilter();i.type="lowpass",i.frequency.value=200,i.Q.value=1.1;const r=Dt.createDelay(.01),s=Dt.createDelay(.01),f=Dt.createGain(),a=Dt.createGain(),l=Dt.createChannelMerger(2),u=Dt.createGain();c.connect(i),i.connect(r),i.connect(s),r.connect(f),s.connect(a),f.connect(l,0,0),a.connect(l,0,1),l.connect(u),u.connect(Dt.destination);const v=Dt.currentTime;u.gain.setValueAtTime(0,v),u.gain.linearRampToValueAtTime(.2,v+4),c.start(),Dt.windSource=c,Dt.windFilter=i,Dt.windMaster=u,Dt.windLeftGain=f,Dt.windRightGain=a,Dt.windLeftDelay=r,Dt.windRightDelay=s})())}function x(t,n,o){const e=.6*SIN(.07*t+.05*n+.7*o)+.4*SIN(-.03*t+.04*n-1.2*o);return{gust:e,sway:.25*e+.07*SIN(1.7*o)}}function O(t,n,o,e){const c=Dt;if(!c||!c.windMaster)return;const i=c.currentTime,r=x(n,o,t),s=((t,n,o)=>{const e=.5,c=x(t+e,n,o).gust,i=x(t-e,n,o).gust;let r=-(x(t,n+e,o).gust-x(t,n-e,o).gust)/1,s=(c-i)/1;const f=HYPOT(r,s)||1;r/=f,s/=f;const a=.2*SIN(.05*o),l=COS(a),u=SIN(a);return{x:r*l-s*u,z:r*u+s*l,speed:f}})(n,o,t);let f=.04+.3*r.sway;f=MAX(.01,MIN(1,f)),c.windMaster.gain.setTargetAtTime(f,i,.2),c.windFilter.frequency.setTargetAtTime(200+(r.sway+.32)/.64*1200,i,.2);const a=ATAN2(SIN(ATAN2(s.x,s.z)-e),COS(ATAN2(s.x,s.z)-e)),l=SIN(a);c.windLeftGain.gain.setTargetAtTime(1-.2*l,i,.15),c.windRightGain.gain.setTargetAtTime(1+.2*l,i,.1);const u=7e-4*l;c.windLeftDelay.delayTime.setTargetAtTime(u>0?u:0,i,.05),c.windRightDelay.delayTime.setTargetAtTime(0>u?-u:0,i,.05)}function M(){if(!Dt)return;const t=Dt.currentTime,n=Dt.createOscillator(),o=Dt.createGain();n.connect(o),o.connect(Dt.destination),n.type="triangle",n.frequency.setValueAtTime(300,t),o.gain.setValueAtTime(.3,t),o.gain.exponentialRampToValueAtTime(1e-4,t+.1),n.start(t),n.stop(t+.1)}function y(t,n){if(!Dt||!window.chipMusic)return;const o=window.chipMusic,e=Dt.currentTime,c=At.length,i=MIN(1,.08*c);t>.1&&(St||c>0)?(o.eng=MIN(1,o.eng+((St?.08:.04)+.03*i)*n),o.last=e):e-o.last>(St?.6:.9)&&(o.eng=MAX(0,o.eng-(St?.15:.1)*n));const r=St?o.eng:.6*o.eng,s=1+.25*i,f=(o.b0+(o.b1-o.b0)*POW(r,.7))*s;for(o.bd=60/f,o.g.gain.setTargetAtTime((r?.05+.18*r:0)+(St?.05*i:0),e,.25);Ft&&e>=o.next;)b(o),o.next+=o.bd/2;0===o.eng&&e-o.last>5&&o.g.gain.setTargetAtTime(1e-4,e,1)}function b(t){const n=Dt.currentTime;t.st++;const o=t.st%16;t.eng>.2&&"1"===t.k[o]&&((t,n)=>{if(!window.chipMusic)return;const o=Dt.createOscillator(),e=Dt.createGain();o.type="sine",o.frequency.setValueAtTime(120,t),o.frequency.exponentialRampToValueAtTime(50,t+.18),e.gain.setValueAtTime(.001,t),e.gain.exponentialRampToValueAtTime(.2*(.4+.4*n.eng),t+.01),e.gain.exponentialRampToValueAtTime(1e-4,t+.22),o.connect(e),e.connect(n.g),o.start(t),o.stop(t+.24)})(n,t),t.eng>.35&&"1"===t.s[o]&&((t,n)=>{if(!window.chipMusic)return;const o=Dt.createBufferSource(),e=Dt.createBuffer(1,.18*Dt.sampleRate,Dt.sampleRate),c=e.getChannelData(0);for(let s=0;c.length>s;s++)c[s]=(2*RANDOM()-1)*POW(1-s/c.length,1.8);o.buffer=e;const i=Dt.createBiquadFilter();i.type="bandpass",i.frequency.value=1800;const r=Dt.createGain();r.gain.setValueAtTime(.001,t),r.gain.exponentialRampToValueAtTime(.35*(.4+.6*n.eng),t+.008),r.gain.exponentialRampToValueAtTime(1e-4,t+.18),o.connect(i),i.connect(r),r.connect(n.g),o.start(t),o.stop(t+.18)})(n,t);const e=t.bl[t.st%t.bl.length];"_"!==e&&t.eng>.3&&h(n,980*POW(2,(t.sc[+e]||0)/12),t)}function h(t,n,o,e){if(!window.chipMusic)return;const c=Dt.createOscillator(),i=Dt.createGain();c.type="triangle",c.frequency.value=n,i.gain.setValueAtTime(.001,t),i.gain.exponentialRampToValueAtTime((e||.18)*(.5+.2*o.eng),t+.02),i.gain.exponentialRampToValueAtTime(2e-4,t+.55),c.connect(i),i.connect(o.g),c.start(t),c.stop(t+.6)}function I(t){Tt.push(t),Tt.length>200&&Tt.shift()}function N(){return Ht?Yt:Wt}function A(){return Ht?new DOMMatrix([1,0,0,0,0,1,0,0,0,0,1,0,0,-.05,-1.15,1]).toFloat32Array():new DOMMatrix([1,0,0,0,0,1,0,0,0,0,1,0,0,.5,-1.15,1]).toFloat32Array()}function g(t,n,o){const e=o||N(),c=Z(t),i=((t,n)=>{const o=n[0],e=n[1],c=n[2];return[t[0]*o+t[4]*e+t[8]*c+1*t[12],t[1]*o+t[5]*e+t[9]*c+1*t[13],t[2]*o+t[6]*e+t[10]*c+1*t[14]]})(c,n.o),r=((t,n)=>{const o=n[0],e=n[1],c=n[2];return[t[0]*o+t[4]*e+t[8]*c+0*t[12],t[1]*o+t[5]*e+t[9]*c+0*t[13],t[2]*o+t[6]*e+t[10]*c+0*t[14]]})(c,n.d),s=-i[2]/r[2];if(0>=s)return null;const f=i[0]+r[0]*s,a=i[1]+r[1]*s;if(-.26>f||f>.26||-.15>a||a>.15)return null;const l=(f+.26)/.52,u=(.15-a)/.3;for(const v of e)if(!(v.u0>l||l>v.u1||v.v0>u||u>v.v1))return{id:v.id,u:l,v:u,button:v,t:s};return{id:null,u:l,v:u,button:null,t:s}}function P(t=10,n=12){const o=[];for(let e=0;t>e;e++){const c=PI*e/t,i=PI*(e+1)/t;for(let t=0;n>t;t++){const e=2*PI*t/n,r=2*PI*(t+1)/n,s=[R(c,e),R(i,e),R(i,r),R(c,e),R(i,r),R(c,r)];for(const t of s)o.push(t[0],t[1],t[2])}}return new Float32Array(o)}function R(t,n){return[SIN(t)*COS(n),COS(t),SIN(t)*SIN(n)]}function _(t,n,o){const e=43758.5453*SIN(127.1*t+311.7*n+13.13*o);return e-FLOOR(e)}function C(t,n,o){const e=43758.5453*SIN(127.1*t+311.7*n+17.17*o);return e-FLOOR(e)}function S(t,n,o){const e=FLOOR((t-o)/6),c=FLOOR((t+o)/6),i=FLOOR((n-o)/6),r=FLOOR((n+o)/6),s=[];for(let f=i;r>=f;f++)for(let i=e;c>=i;i++)if(.3>C(i,f,0)){const e=6*i+5.1*(C(i,f,1)-.5)+3,c=6*f+5.1*(C(i,f,2)-.5)+3,r=e-t,a=c-n;if(o*o>=r*r+a*a){const t=1.8+1.2*C(i,f,3);s.push({px:e,pz:c,scale:t,gx:i,gz:f})}}return s}function D(t){if(mt)return;const n=(t-dt)/1e3||0;dt=t;for(let o=Pt.length-1;o>=0;o--)Pt[o].i&&Pt.splice(o,1);Nn.length=0;const e=FLOOR((ft.x-300)/5),c=FLOOR((ft.x+300)/5),s=FLOOR((ft.z-300)/5),f=FLOOR((ft.z+300)/5);for(let o=s;f>=o;o++)for(let t=e;c>=t;t++)if(.01>_(t,o,0)){const n=5*t+3*(_(t,o,1)-.5)+2.5,e=5*o+3*(_(t,o,2)-.5)+2.5,c=n-ft.x,i=e-ft.z;if(9e4>=c*c+i*i){const c=1e3*_(t,o,-7),i=4+2*_(t,o,5),r=n,s=e,f=.45*i,a=1.2*i;Nn.push({x:r,y:f,z:s,r:a,seed:c,scale:i}),Pt.push({x:r,y:f,z:s,r:a,i:1})}}const l=m();w(n,l),d(n),i(n),Ct.caught>Vt&&(Vt=Ct.caught,Lt=5.5),y(HYPOT(l.x,l.y),n),(()=>{const t=COS(ft.yaw),n=SIN(ft.yaw),o=COS(ft.pitch),e=SIN(ft.pitch);var c,i;c=nt,U(j,i=[ft.x,ft.y,ft.z],[ft.x-n*o,ft.y-e,ft.z-t*o]),G(j,j),$(q,[0,1,0],j),G(q,q),$(Y,j,q),c.set([q[0],Y[0],j[0],0,q[1],Y[1],j[1],0,q[2],Y[2],j[2],0,-B(q,i),-B(Y,i),-B(j,i),1]),((t,n,o)=>{const e=1/TAN(60*H/2);t.set([e/o,0,0,0,0,e,0,0,0,0,1000.1/-999.9,-1,0,0,200/-999.9,0])})(ot,0,rt.width/rt.height),et=J(V(),ot,nt),ct=Z(et)})(),Dt&&O(t/1e3,ft.x,ft.z,ft.yaw),st.viewport(0,0,rt.width,rt.height),st.clearColor(0,0,0,1),st.clear(st.COLOR_BUFFER_BIT|st.DEPTH_BUFFER_BIT),st.useProgram(cn),st.bindVertexArray(rn),st.disable(st.DEPTH_TEST);const u=Z(nt);st.uniformMatrix4fv(sn,0,u),st.uniformMatrix4fv(fn,0,ct),st.activeTexture(st.TEXTURE1),st.bindTexture(st.TEXTURE_2D,en),st.uniform1i(an,1),st.uniform1f(ln,.001*t),st.drawArrays(st.TRIANGLES,0,3),st.enable(st.DEPTH_TEST),st.useProgram(un),st.bindVertexArray(pn),st.uniformMatrix4fv(vn,0,tt),st.uniformMatrix4fv(dn,0,nt),st.uniformMatrix4fv(mn,0,ot),st.drawArrays(st.TRIANGLES,0,6);for(const o of gt)o.r>0&&F(nt,ot,o.x,o.y,o.z,o.r,[.2,1,.3]);for(const o of Rt)F(nt,ot,o.x,o.y,o.z,o.r,[.8,.5,.1]);if(r(nt,ot,Ct.x,Ct.y,Ct.z,Ct.yaw,Ct.anim,.08,[.02,.02,.02]),yt&&yt.size){const t=performance.now(),e=t-120;yt.forEach((c,i)=>{if(i===Mt)return;if(t-(c.last||0)>=15e3)return;const s=o(c,e)||c;r(nt,ot,s.x,.6,s.z,(s.yaw||0)+PI,HYPOT(s.x,s.z)||3.5*n,.1,ht)})}if(Nn.length){st.useProgram(gn),st.bindVertexArray(Pn),st.uniformMatrix4fv(_n,0,nt),st.uniformMatrix4fv(Cn,0,ot);for(const t of Nn)st.uniform3f(Sn,t.x,t.y,t.z),st.uniform1f(Dn,t.scale),st.uniform1f(zn,t.seed),st.drawArrays(st.TRIANGLES,0,An.length/3)}{const n=[COS(ft.yaw),0,-SIN(ft.yaw)],o=.001*t;T(nt,ot,[ft.x,ft.z],n,o,1.1,500,1),T(nt,ot,[ft.x,ft.z],n,o,.4,300,2),T(nt,ot,[ft.x,ft.z],n,o,.15,200,3)}{st.useProgram(En),st.bindVertexArray(no);const n=ft.x,o=ft.z,e=S(n,o,55);for(const c of e){const e=c.px,i=c.pz,r=c.scale,s=HYPOT(n-e,o-i);if(4>s||s>55)continue;const f=t=>t*t*(3-2*t);let a=(s-4)/2;a=f(MIN(1,MAX(0,a)));let l=(55-s)/37;l=f(MIN(1,MAX(0,l)));let u=a*l;if(.05>u)continue;const v=0|MAX(2,MIN(14,2+12*u)),d=C(c.gx,c.gz,4),m=ATAN2(n-e,o-i),w=(new DOMMatrix).translate(e,0,i).rotate(0,m/H,0).scale(r,r,r).toFloat32Array();st.uniformMatrix4fv(Qn,0,w),st.uniformMatrix4fv(Un,0,nt),st.uniformMatrix4fv(Bn,0,ot),st.uniform1f($n,.001*t),st.uniform1i(Gn,v),st.uniform3f(Jn,e,0,i),st.uniform1f(Zn,d),st.drawArrays(st.TRIANGLES,0,6)}}const v=A(),p=Z(nt),x=new DOMMatrix(p).multiply(new DOMMatrix(v)).toFloat32Array();if(Xt=x,jt=null,null===It.look.id){const t=g(x,a(It.pointer.x,It.pointer.y),N());t&&t.button&&(jt=t.button)}z(0,0,N(),n),st.useProgram(Bt),st.bindVertexArray(on),st.activeTexture(st.TEXTURE0),st.bindTexture(st.TEXTURE_2D,Kt),st.uniform1i(tn,0),st.uniformMatrix4fv(Gt,0,x),st.uniformMatrix4fv(Jt,0,nt),st.uniformMatrix4fv(Zt,0,ot),st.disable(st.DEPTH_TEST),st.enable(st.BLEND),st.blendFunc(st.SRC_ALPHA,st.ONE_MINUS_SRC_ALPHA),st.drawArrays(st.TRIANGLES,0,6),st.disable(st.BLEND),st.enable(st.DEPTH_TEST),requestAnimationFrame(D)}function z(t,n,o,e){Lt>0&&(Lt=MAX(0,Lt-e)),((t,n,o,e)=>{const c=o||N();if(timer=(self._tm=(+self._tm||0)+e/60).toFixed(3),Qt.clearRect(0,0,Et.width,Et.height),Ht){Qt.fillStyle="rgba(40,30,20,.8)",Qt.strokeStyle="rgba(160,200,160,.3)",Qt.lineWidth=2,Qt.beginPath(),Qt.roundRect(6,6,Et.width-12,Et.height-12,16),Qt.fill(),Qt.stroke(),Qt.fillStyle="#9f9",Qt.font="24px system-ui",Qt.fillText("HUD",20,34),Qt.fillStyle="#fff",Qt.font="16px system-ui",Qt.fillText("Boosts: "+At.length,20,70),Qt.fillText("Cat Caught: "+Ct.caught,20,100),Qt.fillText("Min's: "+timer,130,100);const t=(()=>{let t=0;try{yt.forEach((n,o)=>{o!==Mt&&15e3>performance.now()-(n.last||0)&&t++})}catch(n){}return t})();Qt.fillText(`MMO: ${xt?"ON":"OFF"}  Peers: ${t}`,20,130);const n=20,o=160,e=Et.width-130,c=Et.height-180;Qt.fillStyle="rgba(0,0,0,.4)",Qt.strokeStyle="rgba(160,200,160,.3)",Qt.beginPath(),Qt.roundRect(n,o,e,c,10),Qt.fill(),Qt.stroke(),Qt.save(),Qt.beginPath(),Qt.rect(n+8,o+8,e-16,c-16),Qt.clip(),Qt.fillStyle="#eee",Qt.font="14px ui-monospace, system-ui";const i=Tt.slice(MAX(0,Tt.length-8-kt),Tt.length-kt);for(let r=0;i.length>r;r++)Qt.fillText(i[r],n+12,o+14+16*r);Qt.restore();for(const r of Yt){const t="function"==typeof r.label?r.label():r.label,n=r.u0*Et.width,o=r.v0*Et.height,e=(r.u1-r.u0)*Et.width,c=(r.v1-r.v0)*Et.height,i=jt&&jt.id===r.id;Qt.fillStyle=i?"rgba(150,190,150,.2)":"rgba(120,160,120,.1)",Qt.strokeStyle=i?"rgba(190,220,190,.9)":"rgba(160,200,160,.3)",Qt.lineWidth=1,Qt.beginPath(),Qt.roundRect(n,o,e,c,8),Qt.fill(),Qt.stroke(),Qt.fillStyle=i?"#fff":"#eef",Qt.font="18px system-ui",Qt.textBaseline="middle",Qt.fillText(t,n+10,o+.5*c)}}else{const t=c[0],n=t.u0*Et.width,o=t.v0*Et.height,e=(t.u1-t.u0)*Et.width,i=(t.v1-t.v0)*Et.height,r=jt&&"hudopen"===jt.id;Qt.fillStyle=r?"rgba(160,200,160,.3)":"rgba(120,160,120,.2)",Qt.strokeStyle=r?"rgba(190,220,190,.9)":"rgba(160,200,160,.3)",Qt.lineWidth=2,Qt.beginPath(),Qt.roundRect(n,o,e,i,10),Qt.fill(),Qt.stroke(),Qt.fillStyle=r?"#fff":"#eef",Qt.font="16px system-ui",Qt.textAlign="center",Qt.textBaseline="middle",Qt.fillText("HUD",n+e/2,o+i/2),Qt.font="20px system-ui",Qt.fillText("Min's: "+timer,320,60),Qt.textAlign="left",Qt.textBaseline="alphabetic"}if(Lt>0){Qt.save();const t=Lt>.5?1:MAX(0,Lt/.5);Qt.globalAlpha=t;const n=.5*Et.width+10,o=.4*Et.height,e=`CAT #${Ct.caught} CAUGHT`;Qt.textAlign="center",Qt.textBaseline="middle",Qt.font="bold 44px system-ui";const c=Qt.createLinearGradient(0,o-10,0,o+10);c.addColorStop(0,"#c0e0f0"),c.addColorStop(1,"#e0d0a0"),Qt.lineWidth=7,Qt.strokeStyle="rgba(0,0,0,.5)",Qt.strokeText(e,n,o),Qt.fillStyle=c,Qt.fillText(e,n,o),13>Ct.caught&&(Qt.strokeText(13-Ct.caught+" Cats to catch",n,o+60),Qt.fillText(13-Ct.caught+" Cats to catch",n,o+60)),13===Ct.caught&&(Vt=Ct.caught,Qt.strokeText("Victory! The End?",n,o+120),Qt.fillText("Victory! The End?",n,o+120)),Qt.restore()}st.bindTexture(st.TEXTURE_2D,Kt),st.pixelStorei(st.UNPACK_FLIP_Y_WEBGL,1),st.texImage2D(st.TEXTURE_2D,0,st.RGBA,st.RGBA,st.UNSIGNED_BYTE,Et)})(0,0,o,e)}function F(t,n,o,e,c,i,r){st.useProgram($t),st.bindVertexArray(xn);const s=((t,n,o,e,c,i)=>new L([e,0,0,0,0,c,0,0,0,0,i,0,t,n,o,1]))(o,e,c,i,i,i);st.uniformMatrix4fv(yn,0,s),st.uniformMatrix4fv(bn,0,t),st.uniformMatrix4fv(hn,0,n),st.uniform4f(In,r[0],r[1],r[2],1),st.drawArrays(st.TRIANGLES,0,Mn.length/3)}function T(t,n,o,e,c,i,r,s){st.useProgram(Fn),st.bindVertexArray(Wn),st.uniformMatrix4fv(Tn,0,t),st.uniformMatrix4fv(kn,0,n),st.uniform2f(Hn,o[0],o[1]),st.uniform3f(Ln,e[0],e[1],e[2]),st.uniform1f(Vn,c),st.uniform1f(Xn,i),st.uniform1i(jn,0|r),st.uniform1f(qn,s),st.activeTexture(st.TEXTURE0),st.bindTexture(st.TEXTURE_2D,en),st.uniform1i(Yn,0),st.drawArraysInstanced(st.TRIANGLE_STRIP,0,10,r*r)}function k(t,n){const e=n.session;e.requestAnimationFrame(k);const c=(t-dt)/1e3||0;if(dt=t,!n.getViewerPose(wt))return;Dt&&O(t/1e3,ft.x,ft.z,ft.yaw);for(let o=Pt.length-1;o>=0;o--)Pt[o].i&&Pt.splice(o,1);Nn.length=0;const s=FLOOR((ft.x-500)/5),f=FLOOR((ft.x+500)/5),a=FLOOR((ft.z-500)/5),v=FLOOR((ft.z+500)/5);for(let o=a;v>=o;o++)for(let t=s;f>=t;t++)if(.01>_(t,o,0)){const n=5*t+3*(_(t,o,1)-.5)+2.5,e=5*o+3*(_(t,o,2)-.5)+2.5,c=n-ft.x,i=e-ft.z;if(25e4>=c*c+i*i){const c=1e3*_(t,o,-7),i=4+2*_(t,o,5),r=n,s=e,f=.45*i,a=1.2*i;Nn.push({x:r,y:f,z:s,r:a,seed:c,scale:i}),Pt.push({x:r,y:f,z:s,r:a,i:1})}}const p=m(e);w(c,p),d(c),i(c),Ct.caught>Vt&&(Vt=Ct.caught,Lt=5.5),y(HYPOT(p.x,p.y),c);const x=.5*-ft.yaw,M=new XRRigidTransform({x:0,y:0,z:0},{x:0,y:SIN(x),z:0,w:COS(x)}),b=wt.getOffsetReferenceSpace(M);pt=b.getOffsetReferenceSpace(new XRRigidTransform({x:-ft.x,y:0,z:-ft.z}));const h=n.getViewerPose(pt);if(h){for(const t of e.inputSources||[]){const o=t.gamepad;if(!o||!o.buttons||!o.buttons.length)continue;const e=!!o.buttons[0].pressed,c=Nt.get(t)||0;if(e&&!c){const o=l("VR",n,t);if(n.getViewerPose(pt)){const t=A(),n=g(new DOMMatrix(h.transform.matrix).multiply(new DOMMatrix(t)).toFloat32Array(),o,N());n&&n.button&&n.button.onClick()}}Nt.set(t,e)}st.bindFramebuffer(st.FRAMEBUFFER,e.renderState.baseLayer.framebuffer),st.clearColor(0,0,0,1),st.clear(st.COLOR_BUFFER_BIT|st.DEPTH_BUFFER_BIT);for(const i of h.views){const s=e.renderState.baseLayer.getViewport(i);st.viewport(s.x,s.y,s.width,s.height);const f=i.transform.inverse.matrix,a=Z(f),l=J(V(),i.projectionMatrix,f),v=Z(l);st.useProgram(cn),st.bindVertexArray(rn),st.disable(st.DEPTH_TEST),st.uniformMatrix4fv(sn,0,a),st.uniformMatrix4fv(fn,0,v),st.activeTexture(st.TEXTURE1),st.bindTexture(st.TEXTURE_2D,en),st.uniform1i(an,1),st.uniform1f(ln,.001*t),st.drawArrays(st.TRIANGLES,0,3),st.enable(st.DEPTH_TEST),st.useProgram(un),st.bindVertexArray(pn),st.uniformMatrix4fv(vn,0,tt),st.uniformMatrix4fv(dn,0,i.transform.inverse.matrix),st.uniformMatrix4fv(mn,0,i.projectionMatrix),st.drawArrays(st.TRIANGLES,0,6);for(const t of gt)t.r>0&&F(i.transform.inverse.matrix,i.projectionMatrix,t.x,t.y,t.z,t.r,[.2,1,.3]);for(const t of Rt)F(i.transform.inverse.matrix,i.projectionMatrix,t.x,t.y,t.z,t.r,[.8,.5,.1]);if(r(i.transform.inverse.matrix,i.projectionMatrix,Ct.x,Ct.y,Ct.z,Ct.yaw,Ct.anim,.08,[.02,.02,.02]),yt&&yt.size){const t=performance.now(),n=t-120;yt.forEach((e,s)=>{if(s===Mt)return;if(t-(e.last||0)>=15e3)return;const f=o(e,n)||e;r(i.transform.inverse.matrix,i.projectionMatrix,f.x,.6,f.z,(f.yaw||0)+PI,HYPOT(f.x,f.z)||3.5*c,.1,ht)})}if(Nn.length){st.useProgram(gn),st.bindVertexArray(Pn),st.uniformMatrix4fv(_n,0,i.transform.inverse.matrix),st.uniformMatrix4fv(Cn,0,i.projectionMatrix);for(const t of Nn)st.uniform3f(Sn,t.x,t.y,t.z),st.uniform1f(Dn,t.scale),st.uniform1f(zn,t.seed),st.drawArrays(st.TRIANGLES,0,An.length/3)}{const n=i.transform.matrix,o=[n[12],n[14]],e=[n[0],n[1],n[2]],c=.001*t;T(i.transform.inverse.matrix,i.projectionMatrix,o,e,c,1.1,2e3,1),T(i.transform.inverse.matrix,i.projectionMatrix,o,e,c,.3,1e3,2),T(i.transform.inverse.matrix,i.projectionMatrix,o,e,c,.15,500,3)}{st.useProgram(En),st.bindVertexArray(no);const n=i.transform.matrix,o=n[12],e=n[14],c=S(o,e,120);for(const r of c){const n=r.px,c=r.pz,s=r.scale,f=HYPOT(o-n,e-c);if(4>f||f>120)continue;const a=t=>t*t*(3-2*t);let l=(f-4)/2;l=a(MIN(1,MAX(0,l)));let u=(120-f)/102;u=a(MIN(1,MAX(0,u)));let v=l*u;if(.05>v)continue;const d=0|MAX(2,MIN(16,2+12*v)),m=C(r.gx,r.gz,4),w=ATAN2(o-n,e-c),p=(new DOMMatrix).translate(n,0,c).rotate(0,w/H,0).scale(s,s,s).toFloat32Array();st.uniformMatrix4fv(Qn,0,p),st.uniformMatrix4fv(Un,0,i.transform.inverse.matrix),st.uniformMatrix4fv(Bn,0,i.projectionMatrix),st.uniform1f($n,.001*t),st.uniform1i(Gn,d),st.uniform3f(Jn,n,0,c),st.uniform1f(Zn,m),st.drawArrays(st.TRIANGLES,0,6)}}const d=A(),m=new DOMMatrix(h.transform.matrix).multiply(new DOMMatrix(d)).toFloat32Array();Xt=m,jt=null;for(const t of e.inputSources||[]){const o=g(m,u(n,t),N());if(o&&o.button){jt=o.button;break}}z(0,0,N(),c),st.useProgram(Bt),st.bindVertexArray(on),st.activeTexture(st.TEXTURE0),st.bindTexture(st.TEXTURE_2D,Kt),st.uniform1i(tn,0),st.uniformMatrix4fv(Gt,0,m),st.uniformMatrix4fv(Jt,0,i.transform.inverse.matrix),st.uniformMatrix4fv(Zt,0,i.projectionMatrix),st.disable(st.DEPTH_TEST),st.enable(st.BLEND),st.blendFunc(st.SRC_ALPHA,st.ONE_MINUS_SRC_ALPHA),st.drawArrays(st.TRIANGLES,0,6),st.disable(st.BLEND),st.enable(st.DEPTH_TEST);for(const t of e.inputSources||[]){const o=[1,1,.5],e=t.gripSpace?n.getPose(t.gripSpace,pt):null;if(e){const t=new DOMMatrix(e.transform.matrix).multiply(new DOMMatrix([.1,0,0,0,0,.1,0,0,0,0,.1,0,0,0,0,1])).rotate(90,0,0).translate(0,-.5,0).toFloat32Array();st.useProgram(oo),st.bindVertexArray(no),st.uniformMatrix4fv(eo,0,t),st.uniformMatrix4fv(co,0,i.transform.inverse.matrix),st.uniformMatrix4fv(io,0,i.projectionMatrix),st.uniform4f(ro,o[0],o[1],o[2],.95),st.disable(st.DEPTH_TEST),st.enable(st.BLEND),st.blendFunc(st.SRC_ALPHA,st.ONE_MINUS_SRC_ALPHA),st.drawArrays(st.TRIANGLES,0,6),st.disable(st.BLEND),st.enable(st.DEPTH_TEST)}const c=t.targetRaySpace?n.getPose(t.targetRaySpace,pt):null;if(c){const e=u(n,t),r=.004+.01*(t.gamepad&&t.gamepad.buttons&&t.gamepad.buttons[0]&&t.gamepad.buttons[0].value||0);let s=3;const f=g(m,e,N());f&&(s=MIN(s,f.t));const a=new DOMMatrix([r,0,0,0,0,r,0,0,0,0,-s,0,0,0,0,1]),l=new DOMMatrix(c.transform.matrix).multiply(a).toFloat32Array();st.useProgram($t),st.bindVertexArray(vo),st.uniformMatrix4fv(so,0,l),st.uniformMatrix4fv(fo,0,i.transform.inverse.matrix),st.uniformMatrix4fv(ao,0,i.projectionMatrix),st.uniform4f(lo,o[0],o[1],o[2],.8),st.disable(st.DEPTH_TEST),st.enable(st.BLEND),st.blendFunc(st.SRC_ALPHA,st.ONE_MINUS_SRC_ALPHA),st.drawArrays(st.TRIANGLES,0,6),st.disable(st.BLEND),st.enable(st.DEPTH_TEST)}}}}}Object.getOwnPropertyNames(Math).forEach(t=>window[t.toUpperCase()]=Math[t]);const H=PI/180,L=Float32Array,V=t=>new L(t||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),X=t=>new L(t||3),j=X(),q=X(),Y=X(),W=X(4),K=X(4),E=X(),Q=X(),U=(t,n,o)=>(t[0]=n[0]-o[0],t[1]=n[1]-o[1],t[2]=n[2]-o[2],t),B=(t,n)=>t[0]*n[0]+t[1]*n[1]+t[2]*n[2],$=(t,n,o)=>(t[0]=n[1]*o[2]-n[2]*o[1],t[1]=n[2]*o[0]-n[0]*o[2],t[2]=n[0]*o[1]-n[1]*o[0],t),G=(t,n)=>{var o=(t=>HYPOT(t[0],t[1],t[2]))(n);return o>0&&(t[0]=n[0]/o,t[1]=n[1]/o,t[2]=n[2]/o),t},J=(t,n,o)=>(t.set(new DOMMatrix(n).multiply(new DOMMatrix(o)).toFloat32Array()),t),Z=t=>new DOMMatrix(t).inverse().toFloat32Array(),tt=V(),nt=V(),ot=V();let et=V(),ct=V();const it=(t,n,o)=>{const e=o[0],c=o[1],i=o[2],r=o[3];return t[0]=n[0]*e+n[4]*c+n[8]*i+n[12]*r,t[1]=n[1]*e+n[5]*c+n[9]*i+n[13]*r,t[2]=n[2]*e+n[6]*c+n[10]*i+n[14]*r,t[3]=n[3]*e+n[7]*c+n[11]*i+n[15]*r,t},rt=document.getElementById("C");let st,ft={x:0,y:1.6,z:2,yaw:0,pitch:.2},at=ft.x,lt=ft.z,ut=0,vt=0,dt=0,mt=null,wt=null,pt=null;st=rt.getContext("webgl2",{xrCompatible:1});let xt=0,Ot=null,Mt=null;const yt=new Map;let bt=0;const ht=[.7,.7,.8];addEventListener("resize",s),s(),matchMedia("(pointer:coarse)");const It={keys:{},joy:{L:{x:0,y:0,id:null},R:{x:0,y:0,id:null}},look:{id:null,x:0,y:0},pointer:{x:0,y:0}},Nt=new Map;document.addEventListener("keydown",t=>{const n=t.key.toLowerCase();It.keys[n]=1,"h"!==n&&"escape"!==n&&"x"!==n||(M(),Ht=!Ht)}),document.addEventListener("keyup",t=>It.keys[t.key.toLowerCase()]=0),rt.addEventListener("pointerdown",t=>{p(),0===t.button&&null===It.look.id&&(It.look.id=t.pointerId,It.look.x=t.clientX,It.look.y=t.clientY,mt?rt.requestPointerLock():rt.setPointerCapture(t.pointerId)),It.pointer.x=t.clientX,It.pointer.y=t.clientY}),rt.addEventListener("pointermove",t=>{if(It.pointer.x=t.clientX,It.pointer.y=t.clientY,t.pointerId===It.look.id){const n=t.clientX-It.look.x,o=t.clientY-It.look.y;It.look.x=t.clientX,It.look.y=t.clientY,ft.yaw+=.002*n,ft.pitch=MAX(-PI/2+.001,MIN(PI/2-.001,ft.pitch-.002*o))}}),rt.addEventListener("pointerup",t=>{t.pointerId===It.look.id&&(It.look.id=null),It.pointer.x=t.clientX,It.pointer.y=t.clientY,((t,n)=>{const o=N(),e=a(t,n);if(!e)return;const c=g(Xt,e,o);c&&c.button&&c.button.onClick()})(t.clientX,t.clientY)}),rt.addEventListener("pointercancel",t=>{t.pointerId===It.look.id&&(It.look.id=null)}),(()=>{function t(t,n,o){const e=t.el.getBoundingClientRect(),c=e.width/2-6,i=n.clientX-(e.left+e.width/2),r=n.clientY-(e.top+e.height/2),s=MIN(HYPOT(i,r),c),f=ATAN2(r,i),a=s>3?s/c*COS(f):0,l=s>3?s/c*SIN(f):0;It.joy[t.side].x=a,It.joy[t.side].y=l,o.style.transform=`translate(calc(-50% + ${a*c}px), calc(-50% + ${l*c}px))`}function n(t,n){It.joy[t.side].x=0,It.joy[t.side].y=0,n.style.transform="translate(-50%, -50%)",t.id=null}const o=[{side:"L",el:document.getElementById("L")},{side:"R",el:document.getElementById("R")}],e=t=>document.querySelector("#"+t+" .jh");for(const c of o){const o=e(c.side);c.el.addEventListener("pointerdown",n=>{p(),c.id=n.pointerId,c.el.setPointerCapture(n.pointerId),t(c,n,o)}),c.el.addEventListener("pointermove",n=>{n.pointerId===c.id&&t(c,n,o)}),c.el.addEventListener("pointerup",t=>{t.pointerId===c.id&&n(c,o)}),c.el.addEventListener("pointercancel",t=>{t.pointerId===c.id&&n(c,o)})}})();const At=[],gt=[],Pt=[],Rt=[];let _t=0;const Ct={x:0,y:.6,z:0,vx:0,vz:0,caught:0,drop:1.2,baseS:2,anim:0,evade:0,yaw:0};let St=0;v();let Dt=null,zt=0,Ft=1;const Tt=[];let kt=0,Ht=1,Lt=0,Vt=0,Xt=V(),jt=null,qt="Enter VR";const Yt=[{id:"reset",u0:.4,v0:.05,u1:.7,v1:.15,label:"Reset",onClick(){M(),ft.x=0,ft.z=2,ft.yaw=0,ft.pitch=.2,v()}},{id:"vr",u0:.4,v0:.2,u1:.7,v1:.3,label(){return qt},onClick(){M(),(async()=>{try{if(mt)return void await mt.end();mt=await navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","hand-tracking"]}),qt="Exit VR",await st.makeXRCompatible(),mt.updateRenderState({baseLayer:new XRWebGLLayer(mt,st)}),wt=await mt.requestReferenceSpace("local-floor"),mt.addEventListener("end",()=>{Dt.close(),p(),document.exitPointerLock(),mt=null,qt="Enter VR",st.bindFramebuffer(st.FRAMEBUFFER,null),st.viewport(0,0,rt.width,rt.height),requestAnimationFrame(D)}),dt=0,mt.requestAnimationFrame(k),v()}catch(t){I("XR failed: "+t.message)}})()}},{id:"mmo",u0:.4,v0:.35,u1:.7,v1:.45,label(){return"MMO: "+(xt?"ON":"OFF")},onClick(){M(),xt=!xt,xt?c():(()=>{try{Ot&&Ot.close()}catch(t){}Ot=null,Mt=null,yt.clear(),e("disabled")})()}},{id:"music",u0:.8,v0:.35,u1:.98,v1:.45,label(){return"Music: "+(Ft?"ON":"OFF")},onClick(){M(),Ft=!Ft,I("music "+(Ft?"on":"off"))}},{id:"logdn",u0:.85,v0:.8,u1:.98,v1:.9,label:"Down",onClick(){M(),kt=MAX(0,kt-1)}},{id:"logup",u0:.85,v0:.7,u1:.98,v1:.8,label:"Up",onClick(){M(),kt=MIN(MAX(0,Tt.length-1),kt+1)}},{id:"hudx",u0:.8,v0:.04,u1:.98,v1:.2,label:"Close       X",onClick(){M(),Ht=0}}],Wt=[{id:"hudopen",u0:.4,v0:0,u1:.6,v1:.12,label:"HUD",onClick(){M(),Ht=1}}];let Kt=st.createTexture(),Et=document.createElement("canvas"),Qt=Et.getContext("2d");Et.width=640,Et.height=320,st.bindTexture(st.TEXTURE_2D,Kt),st.texParameteri(st.TEXTURE_2D,st.TEXTURE_MIN_FILTER,st.LINEAR),st.texParameteri(st.TEXTURE_2D,st.TEXTURE_MAG_FILTER,st.LINEAR),st.texParameteri(st.TEXTURE_2D,st.TEXTURE_WRAP_S,st.CLAMP_TO_EDGE),st.texParameteri(st.TEXTURE_2D,st.TEXTURE_WRAP_T,st.CLAMP_TO_EDGE);const Ut="layout(location=0)in vec3 p;layout(location=1)in vec2 uv;uniform mat4 M,V,P;out vec2 f;out vec3 W;void main(){vec4 wpos=M*vec4(p,1.);W=wpos.xyz;f=uv;gl_Position=P*V*wpos;}",Bt=f(Ut,"in vec2 f;uniform sampler2D T;out vec4 o;void main(){vec4 c=texture(T,f);if(c.a<.01)discard;o=c;}"),$t=f(Ut,"uniform vec4 col;out vec4 o;void main(){o=col;}"),Gt=st.getUniformLocation(Bt,"M"),Jt=st.getUniformLocation(Bt,"V"),Zt=st.getUniformLocation(Bt,"P"),tn=st.getUniformLocation(Bt,"T"),nn=st.createBuffer(),on=st.createVertexArray();st.bindVertexArray(on),st.bindBuffer(st.ARRAY_BUFFER,nn),st.bufferData(st.ARRAY_BUFFER,new L([-.26,.15,0,0,1,.26,.15,0,1,1,.26,-.15,0,1,0,-.26,.15,0,0,1,.26,-.15,0,1,0,-.26,-.15,0,0,0]),st.STATIC_DRAW),st.enableVertexAttribArray(0),st.vertexAttribPointer(0,3,st.FLOAT,0,20,0),st.enableVertexAttribArray(1),st.vertexAttribPointer(1,2,st.FLOAT,0,20,12);let en=st.createTexture();(()=>{function t(t,e){const c=t*n,i=e*n,r=((0|c)+n)%n,s=((0|i)+n)%n,f=(r+1)%n,a=(s+1)%n,l=c-FLOOR(c),u=i-FLOOR(i);return(o[s*n+r]*(1-l)+o[s*n+f]*l)*(1-u)+(o[a*n+r]*(1-l)+o[a*n+f]*l)*u}const n=128,o=new Float32Array(n*n);for(let c=0;o.length>c;c++)o[c]=RANDOM();const e=new Uint8Array(n*n*4);for(let c=0;n>c;c++)for(let o=0;n>o;o++){const i=(o+.5)/n,r=(c+.5)/n,s=t(i,r),f=t(i+.5/n,r+.3/n),a=MAX(0,MIN(1,.6*s+.4*f)),l=4*(c*n+o),u=255*a|0;e[l+0]=u,e[l+1]=u,e[l+2]=u,e[l+3]=255}st.bindTexture(st.TEXTURE_2D,en),st.texImage2D(st.TEXTURE_2D,0,st.RGBA,n,n,0,st.RGBA,st.UNSIGNED_BYTE,e),st.texParameteri(st.TEXTURE_2D,st.TEXTURE_MIN_FILTER,st.LINEAR),st.texParameteri(st.TEXTURE_2D,st.TEXTURE_MAG_FILTER,st.LINEAR),st.texParameteri(st.TEXTURE_2D,st.TEXTURE_WRAP_S,st.REPEAT),st.texParameteri(st.TEXTURE_2D,st.TEXTURE_WRAP_T,st.REPEAT),st.bindTexture(st.TEXTURE_2D,null)})();const cn=f("const vec2 v[3]=vec2[3](vec2(-1,-1),vec2(3,-1),vec2(-1,3));out vec2 a;void main(){a=v[gl_VertexID]*.5+.5;gl_Position=vec4(v[gl_VertexID],0,1);}","in vec2 a;out vec4 b;uniform mat4 c,d;uniform sampler2D e;uniform float f;float g(vec2 p){return texture(e,p).r;}float h(vec2 p){float s=0.,A=.5;s+=A*g(p+f*vec2(.012,.007)*.02);p*=2.;A*=.5;s+=A*g(p+f*vec2(-.008,.015)*.02);p*=2.;A*=.5;s+=A*g(p+f*vec2(.017,-.011)*.02);p*=2.;A*=.5;s+=A*g(p+f*vec2(-.011,-.018)*.02);return s;}void main(){vec3 i=(c*vec4(0,0,0,1)).xyz;vec4 j=d*vec4(a*2.-1.,1,1);vec3 k=normalize(j.xyz/j.w-i);float l=pow(max(k.y*.5+.5,0.),1.2);vec3 m=mix(vec3(.2,.28,.36),vec3(.2,.2,.4),l);vec3 n=normalize(vec3(.1,.1,-.9));float o=max(dot(k,n),0.);float p=smoothstep(.995,1.,o);m+=vec3(.8,.6,.1)*(pow(o,60.)+.4*pow(o,12.))+vec3(1)*p*.15;vec2 q;float r=(100.-i.y)/k.y;if(r>0.){vec3 C=i+k*r;q=C.xz;}else{vec3 C=i+k*1000.;q=C.xz;}vec2 s=q*.0001;float t=h(s);float u=smoothstep(.25,.25+.52,t);vec2 v=normalize(n.xz+.0001);float w=0.;for(int B=1;B<=3;++B){vec2 C=s+v*float(B)*8e-4;w+=h(C);}w/=3.;float x=1.-clamp(w*1.6,0.,1.);vec3 y=vec3(.95,.98,1.)*(.45+.55*x);y+=.25*p*clamp(dot(n,k),0.,1.);m=mix(m,y,u*.95);b=vec4(m,1.);}"),rn=st.createVertexArray(),sn=st.getUniformLocation(cn,"c"),fn=st.getUniformLocation(cn,"d"),an=st.getUniformLocation(cn,"e"),ln=st.getUniformLocation(cn,"f"),un=f(Ut,"in vec3 W;out vec4 o;float h(vec2 v){return fract(sin(dot(v,vec2(41,289)))*9e3);}void main(){vec2 q=floor(W.xz/.6);float r=h(q),r2=h(q+13.);o=vec4(mix(vec3(.08,.05,.02),vec3(.3,.2,.1),r)+step(.97,r2)*vec3(.1,.08,.04),1);}"),vn=st.getUniformLocation(un,"M"),dn=st.getUniformLocation(un,"V"),mn=st.getUniformLocation(un,"P"),wn=st.createBuffer(),pn=st.createVertexArray();st.bindVertexArray(pn),st.bindBuffer(st.ARRAY_BUFFER,wn),st.bufferData(st.ARRAY_BUFFER,new Float32Array([-1e3,0,-1e3,1e3,0,-1e3,1e3,0,1e3,-1e3,0,-1e3,1e3,0,1e3,-1e3,0,1e3]),st.STATIC_DRAW),st.enableVertexAttribArray(0),st.vertexAttribPointer(0,3,st.FLOAT,0,0,0);const xn=st.createVertexArray(),On=st.createBuffer();st.bindVertexArray(xn),st.bindBuffer(st.ARRAY_BUFFER,On);const Mn=P();st.bufferData(st.ARRAY_BUFFER,Mn,st.STATIC_DRAW),st.enableVertexAttribArray(0),st.vertexAttribPointer(0,3,st.FLOAT,0,0,0);const yn=st.getUniformLocation($t,"M"),bn=st.getUniformLocation($t,"V"),hn=st.getUniformLocation($t,"P"),In=st.getUniformLocation($t,"col"),Nn=[],An=P(6,8),gn=f("layout(location=0)in vec3 p;uniform mat4 V,P;uniform vec3 a;uniform float b,c;out vec3 d;float h(float x){return fract(sin(x)*43758.5453);}void main(){d=p*b;float n=h((d.x+d.y*1.7+d.z*2.3)*(c+1.));float o=(n-.5)*(.5*b);vec3 w=(d+normalize(d)*o)+a;gl_Position=P*V*vec4(w,1.);}","in vec3 d;out vec4 o;void main(){vec3 n=normalize(d+vec3(0.,0.,-2.5));float s=clamp(dot(n,normalize(vec3(0.,.1,-.5))),0.,1.);float q=floor(s*4.)/4.;vec3 c=mix(vec3(.15,.1,.1),vec3(.35,.3,.2),q);o=vec4(c,1.);}"),Pn=st.createVertexArray(),Rn=st.createBuffer();st.bindVertexArray(Pn),st.bindBuffer(st.ARRAY_BUFFER,Rn),st.bufferData(st.ARRAY_BUFFER,An,st.STATIC_DRAW),st.enableVertexAttribArray(0),st.vertexAttribPointer(0,3,st.FLOAT,0,0,0);const _n=st.getUniformLocation(gn,"V"),Cn=st.getUniformLocation(gn,"P"),Sn=st.getUniformLocation(gn,"a"),Dn=st.getUniformLocation(gn,"b"),zn=st.getUniformLocation(gn,"c"),Fn=f("uniform mat4 V,P;uniform vec2 c;uniform vec3 r;uniform float d,a;uniform int n;uniform float s;uniform sampler2D e;out vec3 uCol;float h12(vec2 p){return fract(sin(dot(p,vec2(127.1,311.7)))*43758.5453123);}vec2 h22(vec2 p){float x=sin(dot(p,vec2(1.,113.)));return fract(vec2(262144.*x,32768.*x));}void main(){int iid=gl_InstanceID;vec2 camCellF=floor(c/a);vec2 cellF=camCellF+vec2(float(iid % n - n/2),float(iid / n - n/2));vec2 baseCenter=(cellF+vec2(.5))*a;vec2 tileKey=floor(baseCenter/a)+vec2(s);float biome=texture(e,baseCenter*.0002).r;float H=mix(.6,.9,h12(tileKey*3.1));float t=float(gl_VertexID/2)/4.;float side=(gl_VertexID%2==0)?-1.:1.;float width=.05*(1.-t)*(.6+.6*h12(tileKey*7.7))*1.45;float gust=.6*sin(dot(baseCenter,vec2(.07,.05))+d*.7)+.4*sin(dot(baseCenter,vec2(-.03,.04))-d*1.2);float sway=.25*gust+.07*sin(d*1.7+h12(tileKey*5.3)*6.2831853);float bend=(t*t)*sway;vec2 baseXZ=baseCenter+(h22(tileKey)-.5)*(a*90.9);vec2 w=vec2(cos(.3*d),sin(.32*d));w*=inversesqrt(dot(w,w)+.001);vec2 windDir=w;vec3 bendOff=vec3(windDir.x,0.,windDir.y)*bend*H;vec3 pos=vec3(baseXZ.x,0.,baseXZ.y)+normalize(r)*(side*width)+vec3(0.,t*H,0.)+bendOff;vec3 c0=mix(vec3(.12,.10,.01),vec3(.05,.12,.02),biome);vec3 c1=mix(vec3(.45,.38,.05),vec3(.30,.70,.22),biome);uCol=mix(c0,c1,smoothstep(0.,1.,t))*(.85+.15*h12(tileKey*11.1));gl_Position=P*V*vec4(pos,1.);}","in vec3 uCol;out vec4 o;void main(){ o = vec4(uCol, 1.0); }"),Tn=st.getUniformLocation(Fn,"V"),kn=st.getUniformLocation(Fn,"P"),Hn=st.getUniformLocation(Fn,"c"),Ln=st.getUniformLocation(Fn,"r"),Vn=st.getUniformLocation(Fn,"d"),Xn=st.getUniformLocation(Fn,"a"),jn=st.getUniformLocation(Fn,"n"),qn=st.getUniformLocation(Fn,"s"),Yn=st.getUniformLocation(Fn,"e"),Wn=st.createVertexArray(),Kn=st.createBuffer();st.bindVertexArray(Wn),st.bindBuffer(st.ARRAY_BUFFER,Kn),st.bufferData(st.ARRAY_BUFFER,new L([0]),st.STATIC_DRAW),st.enableVertexAttribArray(0),st.vertexAttribPointer(0,1,st.FLOAT,0,0,0);const En=f(Ut,"in vec2 f;out vec4 o;uniform float g;uniform int h;uniform vec3 i;uniform float j;mat3 R(float a){float c=cos(a),s=sin(a);return mat3(vec3(c,s,0),vec3(-s,c,0),vec3(0,0,1));}mat3 D(vec2 d){return mat3(vec3(1,0,0),vec3(0,1,0),vec3(d,1));}float C(vec2 p,vec2 h){p-=vec2(0.,h.y);vec2 d=abs(p)-h;return min(max(d.x,d.y),0.)+length(max(d,0.));}float k(float x){return fract(sin(x)*43758.5453);}float l(vec2 p){return fract(sin(dot(p,vec2(127.1,311.7)))*43758.5453);}float E(vec2 p){float m=25.7+j*10.;mat3 n=R(-m*.01745),q=R(m*.01745);int r=3+int(j*4.),s=1;for(int a=0;a<r;a++)s*=3;float t=1.5,u=.002;p+=vec2(0,2);float v=C(p,vec2(u,t)),w=1e9;int x=0;vec2 y=vec2(.07,.05),z=vec2(-.03,.04);float A=.6*sin(dot(i.xz,y)+g*.7)+.4*sin(dot(i.xz,z)-g*1.2);float F=fract(sin(dot(i.xz,vec2(12.9898,78.233)))*43758.5453)*6.283;float G=.25*A+.07*sin(g*1.7+F);mat3 H=R(G*.5);for(int a=0;a<h;++a){int I=s;vec2 J=p;for(int j=1;j<=r;++j){float K=t/exp2(float(j));I/=3;int L=x/I;int M=L-3*(L/3);mat3 N;if(M==0)N=n*D(vec2(0,-2.*K));else if(M==1)N=H*q*D(vec2(0,-2.*K));else N=H*D(vec2(0,-4.*K));J=(N*vec3(J,1)).xy;float O=C(J,vec2(u,K));if(O>2.*K){x+=I-1;break;}w=min(w,O);if(w<.01)break;}if(w<.01||++x>s)break;}return min(w,v);}void main(){vec2 p=(f*2.-1.)*5.;p.y+=3.;if(E(p)>.038)discard;float P=clamp(f.y,0.,1.),T=k(j*37.17),U=.85+.3*l(i.xz+vec2(j));vec3 Q=vec3(.3,.4,.1),S=vec3(.5,.4,.2),b=mix(Q,S,smoothstep(0.,1.,T));vec3 c=mix(b*.4,b,smoothstep(0.,1.,P))*U;c*=.97+.06*l(i.xz+f*12.34);o=vec4(c,1);}"),Qn=st.getUniformLocation(En,"M"),Un=st.getUniformLocation(En,"V"),Bn=st.getUniformLocation(En,"P"),$n=st.getUniformLocation(En,"g"),Gn=st.getUniformLocation(En,"h"),Jn=st.getUniformLocation(En,"i"),Zn=st.getUniformLocation(En,"j"),to=st.createBuffer(),no=st.createVertexArray();st.bindVertexArray(no),st.bindBuffer(st.ARRAY_BUFFER,to),st.bufferData(st.ARRAY_BUFFER,new L([-1,2,0,0,1,1,2,0,1,1,1,0,0,1,0,-1,2,0,0,1,1,0,0,1,0,-1,0,0,0,0]),st.STATIC_DRAW),st.enableVertexAttribArray(0),st.vertexAttribPointer(0,3,st.FLOAT,0,20,0),st.enableVertexAttribArray(1),st.vertexAttribPointer(1,2,st.FLOAT,0,20,12);const oo=f(Ut,"in vec2 f;uniform vec4 col;out vec4 o;void main(){float d=distance(f,vec2(.5)),r=smoothstep(.5,.4,d)-smoothstep(.4,.3,d);o=vec4(col.rgb,col.a*r);if(o.a<.02)discard;}"),eo=st.getUniformLocation(oo,"M"),co=st.getUniformLocation(oo,"V"),io=st.getUniformLocation(oo,"P"),ro=st.getUniformLocation(oo,"col"),so=st.getUniformLocation($t,"M"),fo=st.getUniformLocation($t,"V"),ao=st.getUniformLocation($t,"P"),lo=st.getUniformLocation($t,"col"),uo=st.createBuffer(),vo=st.createVertexArray();st.bindVertexArray(vo),st.bindBuffer(st.ARRAY_BUFFER,uo),st.bufferData(st.ARRAY_BUFFER,new L([0,0,0,1,0,0,1,0,1,0,0,0,1,0,1,0,0,1]),st.STATIC_DRAW),st.enableVertexAttribArray(0),st.vertexAttribPointer(0,3,st.FLOAT,0,0,0),"xr"in navigator?navigator.xr.isSessionSupported("immersive-vr").then(t=>I(t?"VR ready: Click Enter VR":"VR error")):I("WebXR not available"),requestAnimationFrame(D),I("Catch the Black Cat 13 times"),I("Close HUD: X/H/Esc"),I("Move: WASD, Rotate: Q & E"),I("Move: left, Rotate: right");</script>