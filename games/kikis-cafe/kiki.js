"use strict";(()=>{var t=()=>{const t={children:[],offs:[],parent:a[0],free:()=>(t.children.forEach(t=>t.free()),t.children=[],t.offs.forEach(t=>t()),t.offs=[],t),orphan:()=>(null!=t.parent&&(t.parent.children=t.parent.children.filter(e=>e!==t)),t),start:()=>(a.unshift(t),t),stop:()=>(a.shift(),t)};return t.parent?(t.parent.children.push(t),t):t},e=t=>{a.length?a[0].offs.push(t):console.error(new Error("Attempted to add onDestroy listener with an empty captureStack"))},a=[],s=(...t)=>{const e=t.filter(t=>t);return t=>(e.forEach(e=>e(t)),t)},n=(t,e)=>(e.forEach(e=>e&&e(t)),t),o=(...t)=>e=>t.forEach(t=>null!=t&&e.appendChild("number"==typeof t||"string"==typeof t?document.createTextNode(String(t)):t)),r=t=>e=>a=>a.setAttribute(t,String(e)),i=t=>t.textContent="",l=t=>e=>e.classList.add(...t.split(/\s+/)),c=t=>document.createComment(t),d=t=>(...e)=>n(document.createElement(t),e),h=t=>e=>a=>{const s=t=>e(a,t);return a.addEventListener(t,s),()=>{a.removeEventListener(t,s)}},f=t=>(...e)=>a=>(a.style[t]=e.join(" "),a),m=t=>t.disabled=!0,u=t=>t?m:g,g=t=>t.disabled=!1,p=r("height"),x=(t,e=t)=>s(p(e),b(t)),v=r("src"),y=r("type"),w=t=>e=>e.value=null!=t?String(t):"",b=r("width"),M=h("click"),k=h("input"),S=h("keydown"),I=h("mousedown"),z=h("resize"),$=d("input"),R=d("a"),E=(...t)=>H(N,...t),C=d("canvas"),O=d("div"),A=d("h3"),W=d("img"),D=d("pre"),H=d("button"),N=y("button"),j=t=>{const e=()=>{document.hidden||n?o&&(cancelAnimationFrame(o),o=0):o=requestAnimationFrame(a)},a=()=>{t(),s||(o=requestAnimationFrame(a))};let s=!1,n=!0,o=0;const r={destroy(){s=!0,cancelAnimationFrame(o),document.removeEventListener("visibilitychange",e,!1)},paused:()=>n,start:()=>(n=!1,document.hidden||(o=requestAnimationFrame(a)),r),stop:()=>(n=!0,o&&(cancelAnimationFrame(o),o=0),r)};return document.addEventListener("visibilitychange",e,!1),r},L=(t,e)=>{for(;null!=t;)e(t),t=t.next},T=t=>t,F=t=>!!t,P=()=>{},q=()=>{},B=(t,e)=>t===e,J=(t,a=B)=>{const s={head:void 0,tail:void 0},n={equal:a,get:()=>t,listen:t=>{const a={f:t,next:void 0,prev:void 0};return((t,e)=>{null!=t.tail?(t.tail.next=e,e.prev=t.tail,t.tail=e):t.head=t.tail=e})(s,a),e(()=>{var t,e;(t=s).head===(e=a)&&(t.head=t.head.next),t.tail===e&&(t.tail=t.tail.prev),null!=e.prev&&(e.prev.next=e.next),null!=e.next&&(e.next.prev=e.prev)}),n},listenAndCall:e=>(e(t),n.listen(e)),set:e=>!a(t,e)&&(t=e,L(s.head,({f:t})=>t(e)),!0)};return n},V=(t,e)=>({child:(e,a)=>V(`${t}/${e}`,a),get(){const a=localStorage.getItem(t);return null==a?e():JSON.parse(a)},remove(){localStorage.removeItem(t)},set(e){localStorage.setItem(t,JSON.stringify(e))}}),K=[],U=!1,X=t=>{if(U)return t();U=!0,t(),K.forEach(({f:t,el:e})=>t(e)),K=[],U=!1},Y=(e,a)=>{const s=t().start(),n=c("");let o=a(e.get())||n;return s.stop(),e.listen(t=>{s.free().start(),X(()=>{var e,s;e=o,s=o=a(t)||n,e.parentNode&&e.parentNode.replaceChild(s,e)}),s.stop()}),o},G=(t,e)=>Y(t,t=>t?e(t):void 0),Q=(t,e)=>a=>{t.listenAndCall(t=>(e(t)||P)(a))},Z=f("align-items"),_=f("background-color"),tt=f("border"),et=f("bottom"),at=f("display"),st=f("flex"),nt=f("gap"),ot=f("height");at("none");var rt=f("justify-content"),it=f("left"),lt=f("min-width"),ct=f("overflow"),dt=f("padding"),ht=f("pointer-events"),ft=f("right"),mt=(t,e=t)=>s(ot(e),vt(t)),ut=f("top"),gt=f("transform"),pt=f("transform-origin"),xt=f("visibility"),vt=f("width");xt("hidden"),at(""),xt("");var yt,wt=(t,e)=>({x:t,y:e}),bt=wt(0,0),Mt=(t,e)=>({x:t,y:e}),kt=(t,e)=>wt(t.x/e,t.y/e),St=(t,e)=>(t.x/=e,t.y/=e,t),It=t=>(t.x=Math.floor(t.x),t.y=Math.floor(t.y),t),zt=t=>Math.sqrt($t(t)),$t=t=>{return a=t,(e=t).x*a.x+e.y*a.y;var e,a},Rt=(t,e)=>(t.x=Math.max(t.x,e.x),t.y=Math.max(t.y,e.y),t),Et=(t,e)=>(t.x=Math.min(t.x,e.x),t.y=Math.min(t.y,e.y),t),Ct=(t,e)=>(t.x+=e.x,t.y+=e.y,t),Ot=(t,e)=>(t.x*=e,t.y*=e,t),At=t=>{const e=(a=t,Math.atan2(a.y,a.x));var a;return wt(Math.cos(e),Math.sin(e))},Wt=t=>wt(Math.cos(t),Math.sin(t)),Dt=()=>{const t=J(wt(window.innerWidth,window.innerHeight));return e(z(()=>{t.set(wt(window.innerWidth,window.innerHeight))})(window)),t},Ht=(t,e,a=B)=>t.length===e.length&&t.every((t,s)=>a(t,e[s])),Nt=t=>jt(t,T),jt=(t,e)=>{const a=[];for(let s=0;s<t.length;++s){const n=e(t[s],s);null!=n&&a.push(n)}return a},Lt=(t,e)=>t.filter(t=>t!==e),Tt=(t,e)=>{const a=new Array(t);for(let s=0;s<t;++s)a[s]=e(s);return a},Ft=(t,e)=>t+Math.random()*(e-t),Pt=(t,e)=>t+Math.floor(Math.random()*(e+1-t)),qt=t=>t[Math.random()*t.length|0],Bt=(e,a=B)=>{const s=t().start(),n=J(e(),a),o={equal:a,free:()=>(s.free(),o),get:n.get,listen:t=>(n.listen(t),o),listenAndCall:t=>(n.listenAndCall(t),o),set(t){s.start();const e=n.set(t(n.get()));return s.stop(),e}};return s.stop(),o},Jt=(t,e,a=B)=>{const s=Bt(()=>e(t.get()),a);return t.listen(t=>{s.free().set(()=>e(t))}),s},Vt=t=>24*t*60*60,Kt=t=>1/t/60,Ut=Vt(28),Xt=Vt(3),Yt=Kt(10),Gt=Kt(.5),Qt=Kt(200),Zt=Math.round(Xt*Kt(10)),_t=Math.round(Ut*Kt(10)),te=Kt(10),ee=Kt(600),ae=20*Zt*60,se=20*_t*60,ne=(t,e,a,s,n,o,r,i)=>({attrs:t,blink:e,coat:a,eyes:s,name:n,pos:o,scale:r,state:i}),oe=(t,{scatter:e}={})=>({t:"walk",to:t,scatter:e}),re=(t,e)=>({hunger:t,thirst:e}),ie=["#000","#333","#666"],le=[...ie,"#fff","#ccc","#999","#f90"],ce=["#ff0","#0f0","#00f","#000"],de=10/60,he=wt(16,16),fe=kt(he,2),me=t=>Ot(ue(t),he.x),ue=t=>{const e=t.match(/^(-?\d+),(-?\d+)$/);if(null==e)throw new Error("Bad key: "+t);return wt(parseInt(e[1],10),parseInt(e[2],10))},ge=t=>`${t.x},${t.y}`,pe=t=>({t:"food",amount:t}),xe=t=>({t:"milk",amount:t}),ve=t=>({t:"water",amount:t}),ye=t=>({t:"outside",state:t}),we=(yt="fillStyle",t=>e=>e[yt]=t),be=(t,e,a,s,n,o,r,i,l)=>c=>c.drawImage(t,e,a,s,n,o,r,i,l),Me=(t=1)=>e=>{const a=(t,a,n)=>!!s[4*(e.canvas.width*t+a)+n],{data:s}=e.getImageData(0,0,e.canvas.width,e.canvas.height);for(let n=0;n<s.length;n+=4){if(0!==s[n+3])continue;const o=n/4%e.canvas.width,r=Math.floor(n/4/e.canvas.width);+(o>0&&a(r,o-1,3))+ +(o<e.canvas.width-1&&a(r,o+1,3))+ +(r>0&&a(r-1,o,3))+ +(r<e.canvas.height-1&&a(r+1,o,3))<t||e.fillRect(o,r,1,1)}},ke=({max:t=wt(-1/0,-1/0),min:e=wt(1/0,1/0)}={})=>a=>{const{width:s,height:n}=a.canvas,{data:o}=a.getImageData(0,0,s,n),r=Mt(e.x,e.y),i=Mt(t.x,t.y);for(let t=0;t<o.length;t+=4){if(0===o[t+3])continue;const e=wt(t/4%s,Math.floor(t/4/s));Et(r,e),Rt(i,e)}const l=wt(i.x-r.x+1,i.y-r.y+1);a.canvas.width=l.x,a.canvas.height=l.y;for(let t=r.y;t<=i.y;++t)for(let e=r.x;e<=i.x;++e){const n=4*(t*s+e);a.fillStyle=`rgba(${o[n]},${o[n+1]},${o[n+2]},${o[n+3]/255})`,a.fillRect(e-r.x,t-r.y,1,1)}},Se=(...t)=>e=>{const a=e.getContext("2d");null!=a&&n(a,t)},Ie=(t,e,a)=>{const s=t.get(e);if(null==s){const s=a();return t.set(e,s),s}return s},ze=(t,{fill:e="#fff",font:a="9px monospace",height:s=16,minWidth:n=3}={})=>{const o=C(x(512,s),Se(we(e),t=>{t.font=a},((t,e,a)=>s=>s.fillText(t,e,a))(t,0,Math.floor(3*s/4)),((t=200)=>e=>{const{data:a}=e.getImageData(0,0,e.canvas.width,e.canvas.height);for(let s=0;s<a.length;s+=4){if(0===a[s+3])continue;const n=s/4%e.canvas.width,o=Math.floor(s/4/e.canvas.width);a[s+3]<t?e.clearRect(n,o,1,1):e.fillRect(n,o,1,1)}})(80),ke({max:wt(n,s),min:wt(0,0)})));return C(x(o.width+2,o.height+2),Se(o.width&&o.height?be(o,0,0,o.width,o.height,1,1,o.width,o.height):()=>{},we("#000"),Me(1)))},$e=(t,e)=>C(x(512,32),Se(a=>{a.save();t.split("").forEach(t=>{const s=Ie(e,t,()=>ze(t));a.drawImage(s,0,0),a.translate(s.width-1,0)}),a.restore()},ke())),Re=(t,e=3,a="#fff")=>new Promise(s=>{s(new Map(Tt(95,t=>String.fromCharCode(32+t)).map(s=>[s,ze(s,{fill:a,font:t,minWidth:e})])))}),Ee=t=>new Promise((e,a)=>{const s=new Image;s.src=t,s.onload=()=>{e(s)},s.onerror=t=>{a(t)}}),Ce=(e,a)=>{const s=t().start();let n=a(e.get());const o=J(n.get());return n.listen(o.set),s.stop(),e.listen(t=>{s.free().start(),n=a(t).listenAndCall(o.set),s.stop()}),o};function Oe(...t){const e=J(t.map(t=>t.get()),Ht);return t.forEach((t,a)=>{t.listen(t=>e.set(e.get().map((e,s)=>a===s?t:e)))}),e}var Ae=(t,e)=>{const a=Bt(()=>t),s=Jt(a,e);return{...a,clean:Jt(a,e=>t===e),error:s,errors:Jt(s,t=>Nt([t])),validate:e}},We=(t,e)=>{const a=Bt(()=>t),s=Jt(a,a=>{const s=t===a,n=e(a);return{clean:De(a,s),error:n,errors:He(a,n)}});return{...a,clean:Ce(s,t=>t.clean),error:Jt(s,t=>t.error),errors:Ce(s,t=>t.errors),validate:e}},De=(t,e=!0)=>Jt(Oe(...t.map(t=>t.clean)),t=>e&&t.every(F)),He=(t,e)=>Jt(Oe(...t.map(t=>t.errors)),t=>Nt([e,...t.flat()])),Ne=t=>{const e=Ae(t?.name??"",q),a=Ae(t?.state??{t:"dead",reason:""},q),s=De([e,a]),n=He([]);return{model:t,attrs:t?.attrs??{hunger:0,thirst:0},blink:t?.blink??!1,coat:t?.coat??"",eyes:t?.eyes??"",name:e,pos:t?.pos??{x:0,y:0},scale:t?.scale??{x:0,y:0},state:a,clean:s,errors:n,invalid:Jt(n,t=>t.length>0)}},je=t=>({attrs:t.attrs,blink:t.blink,coat:t.coat,eyes:t.eyes,name:t.name.get(),pos:t.pos,scale:t.scale,state:t.state.get()}),Le=l("absolute"),Te=l("flex-col"),Fe=l("flex-row"),Pe=l("relative"),qe=l("w-100"),Be=(t,e)=>O(o(Y(t,t=>{return"load"===t.t?O(Z("center"),Fe,rt("center"),Le,ut("0"),it("0"),mt("100%"),o(W(v("art/icons/16.png"),x(16),mt("256px")))):"error"===t.t?(a=t.error).message?A(o(a.message)):D(o(JSON.stringify(a,null,2))):e(t.data);var a}))),Je=(t,e,a)=>{const s=Ve((n,o)=>{if(n>=t.length)return o>=e.length?[]:[{t:"add",values:e.slice(o)}];if(o>=e.length)return[{t:"delete",values:t.slice(n)}];if(a(t[n],e[o])){const a=s(n+1,o+1),r=a[0];return r&&"keep"===r.t?[{t:"keep",values:[t[n],...r.values],newValues:[e[o],...r.newValues]},...a.slice(1)]:[{t:"keep",values:[t[n]],newValues:[e[o]]},...a]}const r=s(n+1,o),i=s(n,o+1);if(Ke(r)<=Ke(i)){const e=r[0];return e&&"delete"===e.t?[{t:"delete",values:[t[n],...e.values]},...r.slice(1)]:[{t:"delete",values:[t[n]]},...r]}const l=i[0];return l&&"add"===l.t?[{t:"add",values:[e[o],...l.values]},...i.slice(1)]:[{t:"add",values:[e[o]]},...i]});return s(0,0)},Ve=t=>{const e={};return(a,s)=>((t,e,a)=>t[e]??(t[e]=a(e)))(e,`${a},${s}`,()=>t(a,s))},Ke=t=>((t,e,a=0)=>t.reduce((t,a)=>t+e(a),a))(t,({values:t})=>t.length),Ue=(e,a,s)=>{const n=t(),r=c("");let i=Xe(void 0,void 0,void 0),l=[];return((t,e)=>a=>{t.listenAndCall(t=>e(a,t))})(e,(e,s)=>{const c=((t,e)=>Je(t,e,B))(l,s);l=s;let d=e.firstChild,h=i;n.start(),c.forEach(s=>{if("add"===s.t)X(()=>{s.values.forEach(s=>{if(null==h)throw"offIter is null in mapHTML";const n=t().start(),o=a(s),r=Xe(h.p,n.stop(),h);r.p||(i=r),h.p&&(h.p.n=r),h.p=r,e.insertBefore("string"==typeof o?document.createTextNode(o):o,d)})});else if("keep"===s.t){let t=s.values.length;for(;t--;){if(null==d||null==h)throw"iter or offIter is null in mapHTML";d=d.nextSibling,h=h.n}}else{let t=s.values.length;for(;t--;){if(null==d||null==h||null==h.cap)throw"iter or offIter or offIter.cap is null in mapHTML";const t=d.nextSibling;e.removeChild(d),d=t,h.cap.free().orphan(),i===h&&(i=h.n),h.n&&(h.n.p=h.p),h.p&&(h.p.n=h.n),h=h.n}}}),n.stop(),s.length?r.parentNode&&(t=>{t.parentNode&&t.parentNode.removeChild(t)})(r):o(r)(e)})},Xe=(t,e,a)=>({p:t,cap:e,n:a}),Ye=l("inv"),Ge=l("store"),Qe=(t,e)=>C(x(16),Se(be(t.items,16*("milk"===e.t?0:"food"===e.t?1:2),0,16,16,0,0,16,16))),Ze="hsl(245, 23%, 31%)",_e="hsl(120, 70%, 60%)",ta=(t,e,a)=>Se(s=>{s.imageSmoothingEnabled=!1;const n=(t,e,a,s,n,{fill:o=t.fillStyle,stroke:r=t.strokeStyle,strokeWidth:i=t.lineWidth}={})=>{t.fillStyle=o,t.fillRect(e+i,a+i,s-2*i,n-2*i),t.strokeStyle=r,t.lineWidth=i,t.strokeRect(e+i,a+i,s-i,n-i)},o=ea(Math.floor(s.canvas.width/2)),r=ea(Math.floor(s.canvas.height/2)),i=ea(1);let l;const c={ctx:s,bg(){const{size:a}=t.size.get(),o=Ie(e.cached.bgs,`outside@${a.x},${a.y}`,()=>C(x(a.x,a.y),Se(t=>{const e=48;for(let a=0;a<e;a+=3)for(let e=a%2?-3:0;e<t.canvas.width;e+=6)n(t,e,a,7,4,{fill:qt([`hsl(12, 70%, ${qt(["41%","46%","51%","56%"])})`]),stroke:"#fff"});t.save(),t.fillStyle="#999",t.translate(Math.floor(t.canvas.width/2),e);const a=36;n(t,-18,-36,18,a,{fill:Ze,stroke:"hsl(0, 0%, 80%)"}),n(t,0,-36,18,a,{fill:Ze,stroke:"hsl(0, 0%, 90%)"}),t.restore(),t.fillStyle=_e,t.fillRect(0,e,t.canvas.width,t.canvas.height-e),t.fillStyle="rgba(0,0,0,.25)";for(let e=49;e<t.canvas.height;e+=1)for(let a=e%16-16;a<t.canvas.width;a+=16)t.fillRect(a,e,8,1);t.fillStyle="#000",t.fillRect(0,e,t.canvas.width,1)})));s.drawImage(o,0,0)},bgInside(){const{size:a}=t.size.get(),o=Ie(e.cached.bgs,`inside@${a.x},${a.y}`,()=>C(x(a.x,a.y),Se(t=>{const e=48;t.fillStyle="hsl(32, 70%, 76%)",t.fillRect(0,0,t.canvas.width,e),t.fillStyle="rgba(0,0,0,.25)";for(let a=0;a<t.canvas.width;a+=8)t.fillRect(a,0,4,e);t.fillStyle="hsl(34, 68%, 32%)",t.fillRect(0,45,t.canvas.width,3),t.save(),t.translate(Math.floor(t.canvas.width/2),e);const a=36;t.strokeStyle="hsl(34,68%,26%)",t.lineWidth=2,t.strokeRect(-18.5,-36.5,38,38),t.lineWidth=1,n(t,-18,-36,18,a,{fill:_e,stroke:"hsl(0, 0%, 80%)"}),n(t,0,-36,18,a,{fill:_e,stroke:"hsl(0, 0%, 90%)"}),t.restore(),t.fillStyle=Ze,t.fillRect(0,e,t.canvas.width,t.canvas.height-e),t.fillStyle="rgba(0,0,0,.25)";for(let e=49;e<t.canvas.height;e+=8)for(let a=0;a<t.canvas.width;a+=8)t.fillRect(a,e,6,6);t.fillStyle="#000",t.fillRect(0,e,t.canvas.width,1)})));s.drawImage(o,0,0)},bgWork(a){const{size:n}=t.size.get(),o=Math.min(Math.floor(s.canvas.width/16),Math.floor(s.canvas.height/10)),r=s.canvas.height/2+2*o,i=Ie(e.cached.bgs,`work@${n.x},${n.y}`,()=>C(x(n.x,n.y),Se(t=>{t.imageSmoothingEnabled=!1,t.fillStyle="hsl(56, 9%, 58%)",t.fillRect(0,0,t.canvas.width,r),t.fillStyle="hsl(30, 10%, 30%)",t.fillRect(0,r,t.canvas.width,t.canvas.height-r)})));s.drawImage(i,0,0),s.drawImage(e.work,a?16:0,0,16,10,s.canvas.width/2-8*o,s.canvas.height/2-5*o,16*o,10*o)},cat(t){const a=t.state.get();if("suspend"===a.t)return;const n=Ie(e.cached.cats,t,()=>((t,e)=>C(x(e.width,2*e.height),Se(a=>{a.drawImage(e,0,0),a.drawImage(e,0,16);const{data:s,width:n,height:o}=a.getImageData(0,0,a.canvas.width,a.canvas.height),r=(t,e,a,o,r,i=255)=>{const l=4*(e*n+t);return s[l]===a&&s[l+1]===o&&s[l+2]===r&&s[l+3]===i};for(let e=0;e<o;++e)for(let s=0;s<n;++s)r(s,e,0,0,0)||e>=16&&r(s,e,255,255,0)?(a.fillStyle=t.coat,a.fillRect(s,e,1,1)):r(s,e,255,255,0)&&(a.fillStyle=t.eyes,a.fillRect(s,e,1,1))},we(ie.includes(t.coat)?"#fff":"#000"),Me(2),Me(1))))(t,e.cat));s.save(),s.translate(t.pos.x,t.pos.y),s.scale(t.scale.x,t.scale.y);const o="dead"===a.t?wt(2,1):wt("eat"===a.t||"drink"===a.t?3:"sit"===a.t?1:0,t.blink?1:0);s.drawImage(n,16*o.x,16*o.y,16,16,-8,-13,16,16),s.restore()},clear(){s.clearRect(0,0,s.canvas.width,s.canvas.height)},focus(t){(l=t)?(o.set(t.pos.x),r.set(t.pos.y),i.set(5)):(o.set(Math.floor(s.canvas.width/2)),r.set(Math.floor(s.canvas.height/2)),i.set(1))},item(t,a=bt){s.drawImage(e.items,16*("milk"===t.t?0:"food"===t.t?1:2),0,16,16,a.x,a.y,16,16)},track(e){s.save(),l&&(o.set(l.pos.x),r.set(l.pos.y)),o.step(),r.step(),i.step(),s.translate(Math.floor(s.canvas.width/2),Math.floor(s.canvas.height/2));const a=i.get();s.scale(a,a);const{bounds:n}=t.size.get(),c=wt(s.canvas.width,s.canvas.height),d=kt(c,a),h=kt(d,2);s.translate(-Math.round(Math.max(n.min.x+h.x,Math.min(o.get(),n.max.x-h.x))),-Math.round(Math.min(r.get(),n.max.y-h.y))),e(),s.restore()}};a(c)}),ea=t=>{let e=t;return{get:()=>t,set(t){e=t},step(){t+=(e-t)/20}}},aa=t=>"global"===t.t?t:"focus"===t.t?sa(t):"place"===t.t?t:na(t),sa=t=>{const e=De([]),a=He([]);return{t:"focus",model:t,cat:Ne(t?.cat),clean:e,errors:a,invalid:Jt(a,t=>t.length>0)}},na=t=>{const e=De([]),a=He([]);return{t:"name",model:t,cat:Ne(t?.cat),clean:e,errors:a,invalid:Jt(a,t=>t.length>0)}},oa=t=>{const e=Ae(aa(t?.state??{t:"global"}),q),a=De([e]),s=He([]);return{t:"outside",model:t,state:e,clean:a,errors:s,invalid:Jt(s,t=>t.length>0)}},ra=(t,a,n,r,i,l,c,{scatter:d})=>O(Pe,o(C(Q(t.size,({size:{x:t,y:e}})=>s(x(t,e),Se(t=>{t.imageSmoothingEnabled=!1}))),ta(t,a,a=>{const s=j(()=>{a.track(()=>{n?a.bg():a.bgInside(),Object.entries(i.get()).forEach(([t,e])=>{a.item(e,me(t))}),r.get().sort((t,e)=>t.pos.y-e.pos.y).forEach(t=>{a.cat(t)})})}).start();e(()=>{s.destroy()}),l.listen(t=>{a.focus("focus"===t.t||"name"===t.t?t.cat:void 0)}),e(I((e,a)=>{const s=l.get();if("global"===s.t){const s=e.getBoundingClientRect(),n=It(St(wt(a.clientX-s.x,a.clientY-s.y),t.size.get().zoom)),o=r.get().find(t=>t.pos.x-6<n.x&&n.x<t.pos.x+6&&t.pos.y-12<n.y&&n.y<t.pos.y+2);null!=o&&l.set(()=>{const t=sa();return t.cat=o,t})}else if("place"===s.t){const n=e.getBoundingClientRect(),o=It(St(wt(a.clientX-n.x,a.clientY-n.y),16*t.size.get().zoom));if(null!=i.get()[`${o.x},${o.y}`])return;i.set(t=>({...t,[`${o.x},${o.y}`]:s.item})),c.inventory.set(t=>Lt(t,s.item)),l.set(()=>({t:"global"}))}})(a.ctx.canvas))})),G(l,e=>"global"===e.t?ia(o(la(),ca(o(((t,e,a)=>G(Jt(a,t=>t.length>0),()=>O(_("hsl(345, 57%, 86%)"),tt("1px solid #000"),Fe,Ue(a,a=>E(Ye,o(Qe(t,a)),M(()=>{e.set(()=>(t=>({t:"place",item:t}))(a))}))))))(a,l,c.inventory))))):"focus"===e.t?ia(o(la(o(Y(e.cat.name,t=>$e(t.trim()||"Unnamed Cat",t.trim()?a.font16:a.font16italic)),G(Jt(e.cat.state,t=>"dead"===t.t?t:void 0),t=>$e(`(Deceased: ${t.reason})`,a.font12)))),ca(o(E(o($e("Back",a.font12)),M(()=>{l.set(()=>({t:"global"}))})),Y(e.cat.state,s=>"dead"===s.t||"walk"===s.t&&s.scatter||!n?void 0:E(o($e("Catch",a.font12)),M(()=>{const a=zt((s=wt(t.size.get().size.x/2,48),n=e.cat.pos,s.x-=n.x,s.y-=n.y,s));var s,n;console.log("dist:",a,10/a),Math.random()<10/a?(c.cats.set(t=>Lt(t,e.cat)),c.catsInside.set(t=>t.concat(e.cat)),l.set(()=>({t:"global"}))):d(e.cat)}))),Y(e.cat.state,t=>"dead"!==t.t?E(o($e("Name",a.font12)),M(()=>{l.set(()=>{const t=na();return t.cat=e.cat,t})})):void 0),Y(e.cat.state,t=>"dead"===t.t?E(o($e("Clean",a.font12)),M(()=>{r.set(t=>Lt(t,e.cat)),l.set(()=>({t:"global"}))})):void 0))))):"name"===e.t?ia(o(la(o(Y(e.cat.name,t=>$e(t.trim()||"Unnamed Cat",t.trim()?a.font16:a.font16italic)),G(Jt(e.cat.state,t=>"dead"===t.t?t:void 0),t=>$e(`(Deceased: ${t.reason})`,a.font12)))),ca(o(E(o($e("Back",a.font12)),M(()=>{l.set(()=>({t:"global"}))})),((t,...e)=>$(y(t),...e))("text",st("1"),lt("0"),Q(e.cat.name,w),k((t,a)=>{e.cat.name.set(()=>t.value)}),S((t,a)=>{"Enter"===a.key&&l.set(()=>{const t=sa();return t.cat=e.cat,t})})))))):void 0))),ia=(...t)=>O(et("0"),Te,rt("space-between"),ht("none"),Le,ut("0"),qe,...t),la=(...t)=>O(Z("start"),Te,nt("4px"),ct("auto"),dt("4px"),ht("initial"),qe,...t),ca=(...t)=>O(Fe,nt("4px"),ct("auto"),dt("4px"),ht("initial"),qe,...t);((e,a)=>{const s=t().start();X(()=>{const t=a();n(e,[i,t])}),s.stop()})(document.body,()=>{const t=(t,{min:e,max:a})=>(t.x=Math.max(e.x,Math.min(t.x,a.x)),t.y=Math.max(e.y,Math.min(t.y,a.y)),t),a=t=>{const{bounds:e,size:a}=h.size.get();return wt(t.pos.x>h.size.get().size.x/2?a.x+10:-10,Pt(e.min.y,e.max.y))},n=(e,a,s)=>{let n=Ct(Ot(Wt(2*Math.random()*Math.PI),Pt(50,100)),e.pos);a?n.y=Math.max(s.min.y,n.y):n=t(n,s),i(e,n)},r=t=>{i(t,a(t),!0)},i=(t,e,a)=>{t.state.set(()=>oe(e,{scatter:a})),t.scale.x=e.x<t.pos.x?-1:1},l=()=>{const t=Ne((({min:t,max:e})=>{const a=wt(Pt(t.x,e.x),Pt(t.y,e.y));return ne(re(Pt(Vt(1),Ut),Pt(Vt(1),Xt)),!1,qt(le),qt(ce),"",a,wt(qt([-1,1]),1),{t:"stand"})})(h.size.get().bounds));t.state.set(()=>oe(t.pos));const{size:e}=h.size.get();return t.pos=wt(t.pos.x<e.x/2?-10:e.x+10,t.pos.y),t.scale.x=t.pos.x<0?1:-1,t},c=(t=1)=>{for(let e=0;e<t;++e)Math.random()<Qt&&p.cats.set(t=>t.concat(l())),p.cats.get().forEach(t=>d(t,!0,p.itemsOutside)),p.catsInside.get().forEach(t=>d(t,!1,p.itemsInside));p.time.set(e=>{const a=new Date(e);return a.setSeconds(a.getSeconds()+t),a.toISOString()});const e=m.get();"work"===e.t&&e.smash.get()>0&&e.smash.set(t=>t-1)},d=(e,s,o)=>{const r=e.state.get();if("dead"===r.t)return;const{bounds:l}=h.size.get();if(--e.attrs.hunger<=0||--e.attrs.thirst<=0)return void("suspend"===e.state.get().t?p.cats.set(t=>Lt(t,e)):e.state.set(()=>({t:"dead",reason:e.attrs.hunger<=0?"Hunger":"Thirst"})));e.blink=e.blink?Math.random()>=Gt:Math.random()<Yt;const c=(d=e.pos,ge(It(kt(d,he.x))));var d;const f=o.get()[c];if("drink"===r.t)"water"!==f?.t&&"milk"!==f?.t?e.state.set(()=>({t:"stand"})):e.attrs.thirst<Xt&&(e.attrs.thirst+=Math.max(f.amount,Zt),f.amount=Math.max(0,f.amount-Zt),f.amount<=0&&o.set(t=>Object.fromEntries(Object.entries(t).filter(([t])=>t===c))),e.attrs.thirst>Xt&&n(e,s,l));else if("eat"===r.t)"food"!==f?.t&&"milk"!==f?.t?e.state.set(()=>({t:"stand"})):e.attrs.hunger<Ut&&(e.attrs.hunger+=_t,e.attrs.hunger+=Math.max(f.amount,_t),f.amount=Math.max(0,f.amount-_t),f.amount<=0&&o.set(t=>Object.fromEntries(Object.entries(t).filter(([t])=>t===c))),e.attrs.hunger>Ut&&n(e,s,l));else if("sit"===r.t||"stand"===r.t){if(Math.random()<te)if(Math.random()>e.attrs.hunger/Ut)if("food"===f?.t||"milk"===f?.t)e.state.set(()=>({t:"eat"}));else{const t=Object.entries(o).find(([t,e])=>"food"===e.t||"milk"===e.t);i(e,null==t?a(e):Ct(me(t[0]),fe))}else if(Math.random()>e.attrs.thirst/Xt)if("water"===f?.t||"milk"===f?.t)e.state.set(()=>({t:"drink"}));else{const t=Object.entries(o).find(([t,e])=>"water"===e.t||"milk"===e.t);i(e,null==t?a(e):Ct(me(t[0]),fe))}else{let a=Ct(Ot(Wt(2*Math.random()*Math.PI),Pt(50,100)),e.pos);s?a.y=Math.max(l.min.y,a.y):a=t(a,l),i(e,a)}}else if("suspend"===r.t){if(Math.random()<ee){const{bounds:t}=h.size.get(),a=wt(Ft(t.min.x,t.max.x),Ft(t.min.y,t.max.y));e.state.set(()=>oe(a)),e.scale.x=a.x<e.pos.x?-1:1}}else if("walk"===r.t){const t=(u=r.to,g=e.pos,wt(u.x-g.x,u.y-g.y)),a=r.scatter?.5:de;if(zt(t)<a)if(e.pos=r.to,s&&(e.pos.x<l.min.x||e.pos.x>l.max.x||e.pos.y>l.max.y)){e.state.set(()=>({t:"suspend"}));const t=m.get();if("outside"===t.t){const a=t.state.get();"focus"===a.t&&a.cat===e&&t.state.set(()=>({t:"global"}))}}else e.state.set(()=>qt([{t:"sit"},{t:"stand"}]));else e.pos=Ct(Ot(At(t),a),e.pos)}var u,g},h={size:Jt(Dt(),t=>{const e=t.x<640||t.y<640?3:4,a=It(kt(t,e));return a.y-=34,{bounds:{min:wt(0,48),max:wt(a.x,a.y)},size:a,windowSize:t,zoom:e}})},f=(({data:t,gen:a})=>{const s=()=>{if(null==a)return void console.error("Tried to refresh Asink without gen function.");n.set({t:"load"});const t=o=a().then(e=>{t===o&&n.set({t:"data",data:e})},e=>{t===o&&n.set({t:"error",error:e})})},n=J(t?{t:"data",data:t}:{t:"load"});let o;return null!=t&&null==a||e(()=>{o=void 0}),null==t&&s(),{prop:n,refresh:s,set(t){o=void 0,n.set({t:"data",data:t})}}})({gen:()=>Promise.all([Ee("art/cat.png"),Ee("art/items.png"),Ee("art/work.png"),Re("9px monospace"),Re("12px monospace",4),Re("16px monospace",6),Re("italic 16px monospace",6)]).then(([t,e,a,s,n,o,r])=>({cached:{bgs:new Map,cats:new Map},cat:t,font9:s,font12:n,font16:o,font16italic:r,items:e,work:a}))}),m=Bt(()=>oa(ye({t:"global"}))),g=V("dlb-kiki.world",()=>{return t=100,e=[ne(re(Ut,Xt),!1,"#000","#ff0","Kiki",wt((h.size.get().bounds.min.x+h.size.get().bounds.max.x)/2,(h.size.get().bounds.min.y+h.size.get().bounds.max.y)/2),wt(qt([-1,1]),1),{t:"stand"})],a=[],s=[],n={},o={},r=(new Date).toISOString(),{cash:t,cats:e,catsInside:a,inventory:s,itemsInside:n,itemsOutside:o,time:r};var t,e,a,s,n,o,r}),p=(t=>{const e=Ae(t?.cash??0,q),a=We(t?.cats.map(Ne)??[],q),s=We(t?.catsInside.map(Ne)??[],q),n=Ae(t?.inventory??[],q),o=Ae(t?.itemsInside??{},q),r=Ae(t?.itemsOutside??{},q),i=Ae(t?.time??"",q),l=De([e,a,s,n,o,r,i]),c=He([]);return{model:t,cash:e,cats:a,catsInside:s,inventory:n,itemsInside:o,itemsOutside:r,time:i,clean:l,errors:c,invalid:Jt(c,t=>t.length>0)}})(g.get()),v=j(()=>{var t;c(),g.set({cash:(t=p).cash.get(),cats:t.cats.get().map(je),catsInside:t.catsInside.get().map(je),inventory:t.inventory.get(),itemsInside:t.itemsInside.get(),itemsOutside:t.itemsOutside.get(),time:t.time.get()})}).start();return p.cats.set(t=>t.filter(t=>"dead"!==t.state.get().t)),p.catsInside.set(t=>t.filter(t=>"dead"!==t.state.get().t)),e(()=>{v.destroy()}),o((y=t=>O(Te,Pe,Q(h.size,({size:{x:t,y:e},zoom:a})=>s(mt(t+"px",e+34+"px"),gt(`scale(${a})`))),pt("top left"),o(O(Z("start"),st("0 0 17px"),Fe,rt("space-between"),ct("auto"),dt("4px 4px 3px"),Pe,qe,o(Y(p.cash,e=>$e(`$${e}`,t.font9)),Y(p.time,e=>{const a=new Date(e);return $e(a.toLocaleString(void 0,{year:"2-digit",month:"numeric",day:"numeric",hour:"numeric"}),t.font9)}))),Y(m,a=>"inside"===a.t?ra(h,t,!1,p.catsInside,p.itemsInside,a.state,p,{scatter:r}):"outside"===a.t?ra(h,t,!0,p.cats,p.itemsOutside,a.state,p,{scatter:r}):"store"===a.t?((t,e,a)=>{const s=(t,s,n,r)=>O(Z("center"),Te,nt("5px"),o(E(Pe,Ge,o(t,n>1?O(Le,et("2px"),ft("2px"),o($e(`x${n}`,e.font9))):void 0),Q(a.cash,t=>u(t<s)),st("0 0 auto"),M(()=>{a.cash.get()>=s&&(a.cash.set(t=>t-s),a.inventory.set(t=>t.concat(Tt(n,()=>r()))))}),mt("48px")),$e(`$${s}`,e.font9))),n=(a,...s)=>O(Pe,o(C(x(t.size.get().size.x,72),Se(t=>{t.fillStyle="hsl(3,26%,30%)",t.fillRect(0,0,t.canvas.width,40),t.fillStyle="hsl(43,16%,42%)",t.fillRect(0,40,t.canvas.width,20),t.fillStyle="hsl(46,42%,78%)",t.fillRect(0,60,t.canvas.width,11),t.fillStyle="rgba(0,0,0,.25)",t.fillRect(0,61,t.canvas.width,5),t.fillStyle="#000",t.fillRect(0,71,t.canvas.width,1)})),O(Le,Fe,nt("8px"),it(0),ct("auto"),dt("8px"),ut(0),qe,...s),O(Le,it("4px"),ut("4px"),o($e(a,e.font9))))),r=Jt(a.time,t=>{const e=new Date(t);return e.getHours()<8||e.getHours()>22});return O(_("hsl(3, 26%, 10%)"),ct("hidden"),Pe,Q(t.size,({size:{x:t,y:e}})=>mt(t+"px",e+"px")),o(O(Te,mt("100%"),ct("auto"),o(n("Food",o(...Tt(5,t=>s(Qe(e,pe(se)),(20-t)*(t+1),t+1,()=>pe(se))))),n("Water",o(...Tt(5,t=>s(Qe(e,ve(ae)),(20-t)*(t+1),t+1,()=>ve(ae))))),n("Milk",o(...Tt(5,t=>s(Qe(e,xe(ae)),(25-t)*(t+1),t+1,()=>xe(ae))))))),G(r,()=>O(Le,Z("center"),_("rgba(0,0,0,.25)"),Te,nt("8px"),rt("center"),it(0),mt("100%"),ut(0),o($e("Store Hours:",e.font12),$e("8AM - 10PM",e.font12))))))})(h,t,p):((t,a,s,n,r)=>{const i=Jt(s.smash,t=>t>0),l=Jt(n.time,t=>{const e=new Date(t);return e.getHours()<8||e.getHours()>22});return O(Pe,o(C(Q(t.size,({size:{x:t,y:e}})=>x(t,e)),ta(t,a,t=>{const a=j(()=>{t.bgWork(i.get())}).start();e(()=>{a.destroy()})})),O(Le,et("4px"),Fe,rt("center"),qe,o(E(Q(i,u),o($e("WORK",a.font16)),M(()=>{s.smash.set(()=>10),n.cash.set(t=>t+20),r(3600)})))),G(l,()=>O(Le,Z("center"),_("rgba(0,0,0,.25)"),Te,nt("8px"),rt("center"),it(0),mt("100%"),ut(0),o($e("Office Hours:",a.font12),$e("8AM - 10PM",a.font12))))))})(h,t,a,p,c)),O(st("0 0 17px"),Fe,nt("4px"),rt("space-between"),ct("auto"),dt("4px"),qe,o(R(M(()=>{m.set(()=>oa(ye({t:"global"})))}),o($e("Outside",t.font9))),R(M(()=>{m.set(()=>(t=>{const e=Ae(aa(t?.state??{t:"global"}),q),a=De([e]),s=He([]);return{t:"inside",model:t,state:e,clean:a,errors:s,invalid:Jt(s,t=>t.length>0)}})((t=>({t:"inside",state:t}))({t:"global"})))}),o($e("Inside",t.font9))),R(M(()=>{m.set(()=>(t=>{const e=Ae(t?.smash??0,q),a=De([e]),s=He([]);return{t:"work",model:t,smash:e,clean:a,errors:s,invalid:Jt(s,t=>t.length>0)}})({t:"work",smash:0}))}),o($e("Work",t.font9))),R(M(()=>{m.set(()=>({t:"store"}))}),o($e("Store",t.font9))))))),Be(f.prop,y)));var y})})();
