<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"><title>Genghis Castle Battle - js13kGames 2023</title><style>body{margin:0;overflow:hidden;background:#000}</style></head><body><div id="stage"><canvas id="bg"></canvas><canvas id="mg"></canvas><canvas id="fg"></canvas><canvas id="offscreen"></canvas><div id="ui-left"><h2>Manage</h2><button id="upgrade"><span class="cost" id="upgrade-cost"></span>Upgrade Troops</button><button id="heal"><span class="cost" id="heal-cost"></span>Heal Troops</button><h2>Recruit (<span id="current-soldiers"></span>/15)</h2><div id="recruit-buttons"></div><h2>Action</h2><button id="start">Start Battle</button></div><div id="ui-soldier-counts"><div class="player-count"><h2>Soldiers</h2><span id="soldiers"></span></div><div class="enemy-count"><h2>Enemies</h2><span id="enemies"></span></div></div><div id="ui-right"><div class="gold-count"><span>ðŸ’°<span id="gold"></span></span></div><div class="wave-count"><h2>Wave Count</h2><span id="wave"></span></div></div><div id="ui-battle-breakdown"><h2 id="status"></h2><p>Wave:<span id="wave-number"></span></p><p>Troops Lost:<span id="troops-lost"></span></p><p>Gold Earned:<span id="gold-earned"></span></p><button id="continue"></button></div><div id="ui-game-complete"><h2>Victory!</h2><p>You have defeated the enemy horde.</p><button id="play-again">Play again?</button></div></div><style>:root{--summer-main:rgb(175, 186, 56);--summer-variant:rgb(117, 166, 54);--spring-main:var(--summer-main);--spring-variant:var(--summer-variant);--fall-main:var(--summer-main);--fall-variant:var(--summer-variant);--winter-main:#c0dde6;--winter-variant:#abc5e2}#ui-battle-breakdown,#ui-game-complete{top:50px;left:196px;width:400px;position:absolute;text-align:center;background:rgba(117,166,54,.8);border:4px solid #afba38;padding:2rem 0;visibility:hidden}#ui-game-complete{background:rgba(255,222,38,.8);border:4px solid #c7ba00}.loss{background:rgba(166,54,54,.8)!important;border:4px solid #ba4b38!important}#ui-battle-breakdown h2{margin-top:0}#stage{margin:0 auto;position:relative;overflow:hidden;background-position:80px 0,80px 0,0 0,0 0;background-size:80px 80px;background-repeat:repeat;font-family:Arial,Helvetica,sans-serif}.summer{background-color:var(--summer-main);background-image:linear-gradient(135deg,var(--summer-variant) 25%,transparent 25%),linear-gradient(225deg,var(--summer-variant) 25%,transparent 25%),linear-gradient(45deg,var(--summer-variant) 25%,transparent 25%),linear-gradient(315deg,var(--summer-variant) 25%,var(--summer-main) 25%)}.winter{background-color:var(--winter-main);background-image:linear-gradient(135deg,var(--winter-variant) 25%,transparent 25%),linear-gradient(225deg,var(--winter-variant) 25%,transparent 25%),linear-gradient(45deg,var(--winter-variant) 25%,transparent 25%),linear-gradient(315deg,var(--winter-variant) 25%,var(--winter-main) 25%)}.fall{background-color:var(--fall-main);background-image:linear-gradient(135deg,var(--fall-variant) 25%,transparent 25%),linear-gradient(225deg,var(--fall-variant) 25%,transparent 25%),linear-gradient(45deg,var(--fall-variant) 25%,transparent 25%),linear-gradient(315deg,var(--fall-variant) 25%,var(--fall-main) 25%)}.spring{background-color:var(--spring-main);background-image:linear-gradient(135deg,var(--spring-variant) 25%,transparent 25%),linear-gradient(225deg,var(--spring-variant) 25%,transparent 25%),linear-gradient(45deg,var(--spring-variant) 25%,transparent 25%),linear-gradient(315deg,var(--spring-variant) 25%,var(--spring-main) 25%)}#ui-left,#ui-right,#ui-soldier-counts,canvas{position:absolute}#offscreen{left:1000px}button{cursor:pointer}button[disabled]{color:grey!important}#ui-left{border:4px solid #576579;background:#838ba6cc;width:175px;left:20px;top:50px;margin:auto 0;text-align:center;color:#fff}#ui-soldier-counts{width:175px;left:20px;top:50px;margin:auto 0}#ui-left h2{font-size:1.2rem;margin:.5rem 0}#ui-left button{width:90%;text-align:center;margin:.5rem 0;height:2rem;background:#576579;color:#fff;border:1px solid #a7adc2;border-radius:3px}#ui-right{right:20px;top:50px}.player-count{border:4px solid #576579;background:hsla(226,51%,64%,.8);width:175px;height:110px;color:#fff;text-align:center;margin-bottom:2rem}.enemy-count{border:4px solid #796057;background:hsla(9,40%,50%,.8);width:175px;height:110px;color:#fff;text-align:center}.gold-count{border:4px solid #ffd900;background:rgba(218,165,32,.8);width:175px;height:110px;color:#fff;text-align:center;margin-bottom:2rem;font-size:2.5rem;line-height:7rem}.wave-count{border:4px solid #764134;background:#a56f39cc;width:175px;height:110px;color:#fff;text-align:center}#ui-right h2{margin:1rem 0}.enemy-count span,.player-count span,.wave-count span{font-size:3rem;line-height:1rem}button{font-size:.9rem}.cost{color:gold;font-weight:700;margin-right:.5rem}#start{background-color:rgba(166,54,54,.8)!important}</style><script>var r=class et{constructor(t=0,e=0){this.x=t,this.y=e}moveTowards(t,e){var i=t.x-this.x,s=i*i+(t=t.y-this.y)*t;0==s||0<=e&&s<=e*e||(s=Math.sqrt(s),this.x+=i/s*e,this.y+=t/s*e)}distanceFrom(t){var e=t.x-this.x,t=t.y-this.y;return Math.sqrt(e*e+t*t)}copy(){return new et(this.x,this.y)}},o=class{constructor(t=0,e=0,i=new r){this.width=t,this.height=e,this.pos=i}intersects(t){return this.pos.x<=t.pos.x+t.width&&this.pos.x+this.width>=t.pos.x&&this.pos.y<=t.pos.y+t.height&&this.pos.y+this.height>=t.pos.y}contains(t){return!1}containsPoint(t){return this.pos.x<=t.x&&t.x<=this.pos.x+this.width&&this.pos.y<=t.y&&t.y<=this.pos.y+this.height}},i=800,s=600,t=[],a="spring",n=()=>a,e=t=>{var e=window.stage;a=t,e.className="",e.classList.add(a)},L=()=>{switch(n()){case"spring":e("summer");break;case"summer":e("fall");break;case"fall":e("winter");break;case"winter":e("spring")}},{stage:h,bg:l,mg:d,fg:w,offscreen:c}=window,g={mg:(p=t=>t.getContext("2d"))(d),fg:p(w),bg:p(l),offscreen:p(c)},p=class{constructor(t){this.playingField=t}pos=new r;update(t){}},_=class extends p{constructor(t){super(t),this.playingField=t,this.pos.x=t.pos.x-30,this.pos.y=t.pos.y}draw(t){var{playingField:e,pos:{x:i,y:s}}=this,a=e.width+60;t.save(),t.lineWidth=2,t.translate(i,s),t.fillStyle="#4c6389",t.fillRect(0,-15,60,15),t.strokeRect(0,-15,60,15),t.fillRect(e.width,-15,60,15),t.strokeRect(e.width,-15,60,15),t.fillStyle="#62758e",t.fillRect(a/2-60,-20,120,20),t.strokeRect(a/2-60,-20,120,20),t.fillStyle="#838cad",t.fillRect(0,0,a,40),t.strokeRect(0,0,a,40),t.fillStyle="#b5bcd6",t.fillRect(0,0,a,10),t.strokeRect(0,0,a,10),t.restore()}},W=class extends p{constructor(t){super(t),this.playingField=t,this.pos.x=t.pos.x-30,this.pos.y=t.height+15}draw(t){var{playingField:e,pos:{x:i,y:s}}=this,e=e.width+60,i=(t.save(),t.lineWidth=2,t.translate(i,s),t.fillStyle="#c9833e",t.fillRect(0,0,e,30),t.strokeRect(0,0,e,30),t.fillStyle="#8b4736",t.fillRect(0,-15,e,15),t.strokeRect(0,-15,e,15),t.fillStyle="#933655",t.fillRect(0,-30/1.3,60,30),t.strokeRect(0,-30/1.3,60,30),t.fillRect(e-60,-30/1.3,60,30),t.strokeRect(e-60,-30/1.3,60,30),-30/1.3+30);t.fillStyle="#c13d38",t.beginPath(),t.moveTo(e,i-2),t.lineTo(e-30,-20),t.lineTo(e-60,i-2),t.closePath(),t.fill(),t.beginPath(),t.moveTo(0,i-2),t.lineTo(30,-20),t.lineTo(60,i-2),t.closePath(),t.fill(),t.beginPath(),t.fillStyle="#933655",t.fillRect(e/2-60,-50/1.5,120,50),t.strokeRect(e/2-60,-50/1.5,120,50),t.fillStyle="#c13d38",t.moveTo(e/2-60,15),t.lineTo(e/2-30,-15),t.lineTo(e/2+30,-15),t.lineTo(e/2+60,15),t.closePath(),t.fill(),t.restore()}},m=[],D=({x:t,y:e})=>({x:t,y:e,vx:0,vy:0,alpha:1,count:8,radius:1,embers:[],ended:!1,emberRadius:5}),V=e=>{var i=[],s=e.count,a=e.radius;for(let t=0;t<s;++t){var n={x:e.x,y:e.y,alpha:1,vx:a*Math.cos(2*Math.PI*t/s),vy:a*Math.sin(2*Math.PI*t/s),radius:e.emberRadius};i.push(n)}return i},z=(e,i)=>{i.embers.length||(i.embers=V(i)),i.embers.map(t=>{t.x+=t.vx,t.y+=t.vy,e.save(),e.translate(t.x,t.y),e.lineWidth=4,e.strokeStyle=`hsla(16, 88%, 54%,${i.alpha})`,e.fillStyle=`hsla(16, 88%, 54%,${i.alpha})`,e.beginPath(),e.arc(0,0,t.radius,0,2*Math.PI),e.fill(),e.stroke(),e.restore()}),i.alpha&&(i.alpha-=.03,i.alpha<0)&&(i.ended=!0)},$=(t,e=100,i=100,s=1)=>`hsla(${t}, ${e}%, ${i}%, ${s})`,u=(t,e)=>(t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t)+t)),y=(t,e)=>(t=Math.ceil(t),e=Math.floor(e),Math.random()*(e-t)+t),j=(t,e)=>.5<Math.random()?t:e,q=class{constructor(t,e,i){this.pos=t,this.vel=e,this.opacity=i,this.centerX=this.pos.x}angle=0;centerX;range=.5;fadeIn=!0;opacityIncrement=.001;color={summer:[65,59,60],winter:[194,63,56],spring:[311,36,85],fall:[30,53,67]};update(t){this.pos.x=this.centerX+Math.sin(this.angle)*this.range,this.pos.y-=this.vel.y,this.angle+=this.vel.x,this.fadeIn?this.opacity+=this.opacityIncrement:this.opacity-=this.opacityIncrement,1<this.opacity&&(this.fadeIn=!1),(this.pos.y<0||this.opacity<0)&&(this.pos.x=u(0,i),this.pos.y=u(0,s),this.fadeIn=!0,this.opacity=0)}draw(t){t.save(),t.translate(this.pos.x,this.pos.y);var[e,i,s]=this.color[n()];t.fillStyle=$(e,i,s,this.opacity),t.fillRect(0,0,3,3),t.restore()}},X=class extends o{color={spring:"#cad648",summer:"#cad648",winter:"#48b5d6",fall:"#d6c148"};draw(t){t.save(),t.strokeStyle=this.color[n()],t.lineWidth=2,t.strokeRect(this.pos.x,this.pos.y,this.width,this.height),t.setLineDash([3,3]),t.beginPath(),t.moveTo(this.pos.x+this.width/4,300),t.lineTo(this.pos.x+this.width-this.width/4,300),t.closePath(),t.stroke(),t.beginPath(),t.moveTo(this.pos.x+this.width/2,280),t.lineTo(this.pos.x+this.width/2,320),t.closePath(),t.stroke(),t.beginPath(),t.moveTo(this.pos.x-20,300),t.lineTo(this.pos.x+20,300),t.closePath(),t.stroke(),t.beginPath(),t.moveTo(this.pos.x+this.width-20,300),t.lineTo(this.pos.x+this.width+20,300),t.closePath(),t.stroke(),t.restore()}},k=class{constructor(t){this.milliseconds=t}elapsed=0;current=0;previous=0;hasPassed(){return this.current=Date.now(),this.previous&&(this.elapsed+=this.current-this.previous),this.previous=this.current,this.elapsed>=this.milliseconds&&!(this.elapsed=0)}},N=class{constructor(t,e,i){this.parentId=t,this.angle=e,this.position.x=this.origin.x=i.x,this.position.y=this.origin.y=i.y}origin=new r(0,0);position=new r(0,0);velocity=new r(8,8);width=10;height=2;finished=!1;update(){this.position.x+=Math.cos(this.angle)*this.velocity.x,this.position.y+=Math.sin(this.angle)*this.velocity.y}draw(t){t.save(),t.translate(this.position.x,this.position.y),t.rotate(this.angle),t.fillRect(0,0,this.width,this.height),t.restore()}},G=(...t)=>f(K(...t)),f=(...t)=>{let e=v.createBufferSource(),i=v.createBuffer(t.length,t[0].length,I);return t.map((t,e)=>i.getChannelData(e).set(t)),e.buffer=i,e.connect(v.destination),e.start(),e},K=(t=1,e=.05,i=220,s=0,a=0,n=.1,h=0,l=1,r=0,o=0,d=0,w=0,c=0,g=0,p=0,m=0,u=0,y=1,k=0,f=0)=>{let v=2*Math.PI,x=r*=500*v/I**2,b=(0<p?1:-1)*v/4,S=i*=(1+2*e*Math.random()-e)*v/I,P=[],T=0,A=0,C=0,R=1,M=0,B=0,E=0,H,U;for(o*=500*v/I**3,p*=v/I,d*=v/I,w*=I,c=I*c|0,U=(s=99+I*s)+(k*=I)+(a*=I)+(n*=I)+(u*=I)|0;C<U;P[C++]=E)++B%(100*m|0)||(E=h?1<h?2<h?3<h?Math.sin((T%v)**3):Math.max(Math.min(Math.tan(T),1),-1):1-(2*T/v%2+2)%2:1-4*Math.abs(Math.round(T/v)-T/v):Math.sin(T),E=(c?1-f+f*Math.sin(2*Math.PI*C/c):1)*(0<E?1:-1)*Math.abs(E)**l*t*Y*(C<s?C/s:C<s+k?1-(C-s)/k*(1-y):C<s+k+a?y:C<U-u?(U-C-u)/n*y:0),E=u?E/2+(u>C?0:(C<U-u?1:(U-C)/u)*P[C-u|0]/2):E),H=(i+=r+=o)*Math.sin(A*p-b),T+=H-H*g*(1-1e9*(Math.sin(C)+1)%2),A+=H-H*g*(1-1e9*(Math.sin(C)**2+1)%2),R&&++R>w&&(i+=d,S+=d,R=0),!c||++M%c||(i=S,r=x,R=R||1);return P},Y=.3,I=44100,v=new(window.AudioContext||webkitAudioContext),p=(i,s,a,t=125)=>{let n,h,l,r,o,d,w,c,g,p,m,u,y,k,f=0,v=[],x=[],b=[],S=0,P=0,T=1,A={},C=44100/t*60>>2;for(;T;S++)v=[T=c=u=0],a.map((t,e)=>{for(w=s[t][S]||[0,0,0],T|=!!s[t][S],k=u+(s[t][0].length-2-!c)*C,y=e==a.length-1,h=2,r=u;h<w.length+y;c=++h){for(o=w[h],g=h==w.length+y-1&&y||p!=(w[0]||0)|o|0,l=0;l<C&&c;l++>C-99&&g&&(m+=(m<1)/99))d=(1-m)*v[f++]/2||0,x[r]=(x[r]||0)-d*P+d,b[r]=(b[r++]||0)+d*P+d;o&&(m=o%1,P=w[1]||0,o|=0)&&(v=A[[p=w[f=0]||0,o]]=A[[p,o]]||((n=[...i[p]])[2]*=2**((o-12)/12),0<o?K(...n):[]))}u=k});return[x,b]},x=class F{static hit=[,,328,.02,.01,0,1,.69,-5.9,,,,,,,,.11];static shoot=[.2,,298,,,.07,2,.18,-2.9,-.1,,,.04,,,,.22,.69,.09,.05];static death=[,,466,.03,.01,.06,,1.17,-8.8,2.7,,,,.2,,,,.57,.06];static arrowHit=[.2,,670,.01,,.02,3,.73,-2.1,,506,.04,,.8,-57,,,,.02];static music=p([[,0,77,,,.7,2,.41,,,,,,,,.06],[,0,43,.01,,.3,2,,,,,,,,,.02,.01],[,0,170,.003,,.008,,.97,-35,53,,,,,,.1],[.8,0,270,,,.12,3,1.65,-2,,,,,4.5,,.02],[,0,86,,,,,.7,,,,.5,,6.7,1,.05],[,0,41,,.05,.4,2,0,,,9,.01,,,,.08,.02],[,0,2200,,,.04,3,2,,,800,.02,,4.8,,.01,.1],[.3,0,16,,,.3,3]],[[[1,-1,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33],[3,1,22,,,,,,,,,,,,,,,,,,,,,,,,,,,,24,,,,24,,,,,,,,,,,,,,,,,,,,,,,,22,,22,,22,,,,],[5,-1,21,,,,,,,,,,,,,,,,,,,,,,,,,,,,24,,,,23,,,,,,,,,,,,,,,,,,,,,,,,24,,23,,21,,,,],[,1,21,,,,,,,,,,,,,,,,,,,,,,,,,,,,24,,,,23,,,,,,,,,,,,,,,,,,,,,,,,24,,23,,21,,,,]],[[1,-1,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33],[3,1,24,,,,,,,,27,,,,,,,,,,,,,,,,27,,,,24,,,,24,,,,,,,,27,,,,,,,,,,,,,,,,24,,24,,24,,,,],[5,-1,21,,,,,,,,,,,,,,,,,,,,,,,,,,,,24,,,,23,,,,,,,,,,,,,,,,,,,,,,,,24,,23,,21,,,,],[,1,21,,,,,,,,,,,,,,,,,,,,,,,,,,,,24,,,,23,,,,,,,,,,,,,,,,,,,,,,,,24,,23,,21,,,,],[6,1,,,34,34,34,,,,,,34,34,,,,,34,,,,34,34,,,,,34,,,,34,,,,34,34,34,,,,,,34,,,,,,34,34,,,34,34,,,,,,,,,34,34],[4,1,,,,,,,24,,,,,,24,,24,,,,24,,,,24,,,,,,,,,,,,,,,,24,,,,,,24,,24,,,,24,,,,24,,,,,,,,,,]],[[1,-1,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,23,23,35,23,23,36,23,23,35,23,23,36,23,23,35,35,23,23,35,23,23,35,23,23,36,23,23,35,23,23,36,36],[5,-1,21,,,19,,,21,,,,,,,,,,21,,,19,,,17,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,],[3,1,24,,,24,,,24,,,,,,,,,,24,,,24,,,24,,,,24.75,24.5,24.26,24.01,24.01,24.01,,,,,25,,,,,,,,25,,,,,,,,25,,,,,,,,25,25,25,25],[4,-1,,,,,,,,,,,,,,,,,,,,,,,,,,,24.75,24.5,24.26,24.01,24.01,24.01,24.01,24,,24,24,,24,24,24,24,,24,24,,24,,24,24,,24,24,,24,24,24,24,,24,24,,24,24],[7,-1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,23,,21,23,,35,,23,,21,23,,35,,35,,23,,21,23,,35,,21,23,,35,,21,23,,,],[6,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,34,36,34,,33,34,34,36,31,36,34,,31,34,32,,33,36,34,,31,34,34,36,33,36,33,,31,,,]],[[1,-1,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,17,17,29,17,17,29,17,17,29,17,17,29,17,17,29,29,17,17,29,17,17,29,17,17,29,17,17,29,17,17,29,29],[4,1,24,24,,24,24,,24,24,24,24,,24,24,,24,,24,24,,24,24,,24,24,24,24,,24,24,,24,24,24,24,,24,24,,24,24,24,,,24,24,,24,,24,24,,24,24,,24,24,24,24,,24,24,,24,24],[7,-1,21,,19,21,,33,,21,,19,21,,33,,33,,21,,19,21,,33,,21,,19,21,,33,,33,,17,,17,17,29,17,17,29,17,,17,17,29,17,17,29,17,,17,17,29,17,17,29,17,,17,17,29,17,17,29],[2,1,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,,,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,,,],[6,1,,,36,,,,,,36,,36,,,,,,,,36,,,,,,36,,36,,,,,,,,36,,,,,,,,,,,,,,,,36,,,,,,36,,36,,,,,,],[3,1,,,,,25,,,,,,,,25,,,,,,,,25,,,,,,,,25,25,25,25,,,,,25,,,,,25,,,25,,,,,,,,25,,,,,,,,25,25,25,25]],[[1,-1,14,14,26,14,14,26,14,14,26,14,14,26,14,14,26,26,14,14,26,14,14,26,14,14,26,14,14,26,14,14,26,26,17,17,29,17,17,29,17,17,29,17,17,29,17,17,29,29,19,19,31,19,19,31,19,19,31,19,19,31,19,19,31,31],[4,1,24,24,,24,24,,24,24,24,24,,24,24,,24,,24,24,,24,24,,24,24,24,24,,24,24,,24,24,24,24,,24,24,,24,24,24,24,,24,24,,36,,24,24,,24,24,,24,24,24,24,,24,24,,24,24],[7,-1,14,,14,14,26,14,14,26,14,,14,14,26,14,14,26,14,,14,14,26,14,14,26,14,,14,14,26,14,14,26,17,,17,17,29,17,17,29,17,,17,17,29,17,17,29,19,,19,19,31,19,19,31,19,,19,19,31,19,19,31],[2,1,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,,,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,,,],[3,1,,,,,25,,,,,,,,25,,,,,,,,25,,,,,,,,25,25,25,25,,,,,25,,,,,,,,25,,,,,,,,25,,,,,,,,25,25,25,25],[6,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,34,,,,,,34,,34,,,,,,,,34,,,,,,34,,34,,,,,,]]],[0,1,1,2,3,4,4]);static playSound(t){G(...t)}static _music;static playMusic(){F._music=f(...F.music)}static stopMusic(){F._music&&(F._music.stop(),delete F._music)}},p=class{constructor(t,e=0){this.bounds=t,this.rank=e,this.startPos=t.pos.copy()}id=Math.random().toString();name="Soldier";cost=1;upgradeCost=2;healCost=1;goldValue=1;type=3;damaged=0;maxDamageFrames=30;meleeAttack=0;meleeAttackFrames=30;speed=.25;attack=1;maxHealth;health;attackRange=50;attackRate=new k(1e3);attackAngle=0;experience=0;experienceForEliteStatus=6;experienceForUpgradedStatus=3;startPos;target;get width(){return this.bounds.width}get height(){return this.bounds.height}get pos(){return this.bounds.pos}alive=!0;canUpgrade(){return 0===this.rank?this.experience>=this.experienceForUpgradedStatus:1===this.rank&&this.experience>=this.experienceForEliteStatus}upgrade(){1===this.rank&&(this.rank=2),0===this.rank&&(this.rank=1)}hasDamage(){return this.health<this.maxHealth}update(t,e){0!==e.length&&(this.target||(this.target=this.selectTarget(e)),this.target&&this.pos.distanceFrom(this.target.pos)>this.attackRange&&this.pos.moveTowards(this.target.pos,this.speed),this.attackRate.hasPassed()&&this.pos.distanceFrom(this.target.pos)<=this.attackRange&&this.performAttack(),this.target.health<=0&&delete this.target,this.damaged&&this.damaged--,this.meleeAttack&&this.meleeAttack--,this.alive&&this.health<=0&&(x.playSound(x.death),m.push(D(this.pos))),this.alive=0<this.health)}performAttack(){this.target&&(this.attackAngle=Math.atan2(this.target.pos.y-this.pos.y,this.target.pos.x-this.pos.x),0===this.type?(t.push(new N(this.id,this.attackAngle,this.pos)),x.playSound(x.shoot)):(this.meleeAttack=this.meleeAttackFrames,this.target.health-=this.attack,this.target.health<=0&&(this.experience+=1),this.target.damaged=this.target.maxDamageFrames,x.playSound(x.hit)))}animateMeleeAttack(t){var e;this.meleeAttack&&this.target&&(t.save(),t.fillStyle="white",e=.0349066*(this.meleeAttackFrames-2*this.meleeAttack),t.translate(this.pos.x,this.pos.y),this.target.pos.x<this.pos.x?t.rotate(this.attackAngle-e):t.rotate(this.attackAngle+e),t.lineWidth=2,t.fillStyle="gray",t.fillRect(0,0,this.attackRange-this.width,this.width/3),t.strokeRect(0,0,this.attackRange-this.width,this.width/3),t.restore())}draw(t){0<this.damaged&&(t.save(),t.beginPath(),t.arc(this.pos.x,this.pos.y,this.width,0,2*Math.PI),t.fillStyle="rgba(255, 0, 0, .4)",t.closePath(),t.fill(),t.restore())}drawHealthBar(t){var e=this.getHitBox(),i=(t.save(),e.height/6),s=(t.fillStyle="red",t.fillRect(e.pos.x,e.pos.y-2*i,e.width,i),t.fillStyle="green",e.width/this.maxHealth),s=this.health*s;t.fillRect(e.pos.x,e.pos.y-2*i,s,i),t.lineWidth=2,t.strokeRect(e.pos.x,e.pos.y-2*i,e.width,i),t.restore()}isStrongAgainst(t){switch(this.type){case 2:return 1===t.type;case 1:return 0===t.type;case 0:return 2===t.type}return!1}selectTarget(t){var e=(t=this.sortSoldiersByDistance(t)).filter(t=>this.isStrongAgainst(t));return(e.length?e:t)[0]}sortSoldiersByDistance(t){return t.sort((t,e)=>t.pos.distanceFrom(this.pos)<e.pos.distanceFrom(this.pos)?0:1)}getHitBox(){return new o(2*this.width,2*this.height,new r(this.pos.x-this.width,this.pos.y-this.height))}collides(t){return t.some(t=>t.getHitBox().intersects(this.getHitBox()))}},b={0:{main:"#305182",accent:"#4192c3",skin:"#ffdba2"},1:{main:"#378230",accent:"#5bc341",skin:"#ffdba2"},2:{main:"#823030",accent:"#c34141",skin:"#ffdba2"}},S=class extends p{name="Swordsman";type=2;cost=2;upgradeCost=2;healCost=1;goldValue=2;attack=1;speed=.5;maxHealth=4;health=this.maxHealth;attackRange=50;attackRate=new k(1e3);draw(t){var{x:e,y:i}=this.pos;this.drawHealthBar(t),this.animateMeleeAttack(t),t.save(),t.translate(e,i),t.lineWidth=2,t.beginPath(),t.arc(0,0,this.width,Math.PI,0),t.closePath(),t.fillStyle=b[this.rank].main,t.fill(),t.stroke(),t.beginPath(),t.moveTo(-this.width,-this.height/4),t.lineTo(-this.width,0),t.lineTo(this.width,0),t.lineTo(this.width,-this.height/4),t.lineTo(0,-this.height/1.5),t.closePath(),t.fillStyle=b[this.rank].accent,t.fill(),t.stroke(),t.beginPath(),t.arc(0,0,this.width,0,Math.PI),t.closePath(),t.fillStyle=b[this.rank].skin,t.fill(),t.stroke(),t.restore(),super.draw(t)}upgrade(){super.upgrade(),1===this.rank&&(this.health+=2,this.speed+=.1),2===this.rank&&(this.attack+=1)}},P=class extends p{name="Crossbowman";type=0;cost=8;upgradeCost=3;healCost=3;goldValue=4;attack=1;speed=.25;maxHealth=3;health=this.maxHealth;attackRange=250;attackRate=new k(1200);draw(t){var{x:e,y:i}=this.pos;this.drawHealthBar(t),t.save(),t.translate(e,i),t.lineWidth=2,t.beginPath(),t.arc(0,0,this.width,Math.PI,0),t.closePath(),t.fillStyle=b[this.rank].accent,t.fill(),t.stroke(),t.beginPath(),t.moveTo(-this.width,-this.height/2.5),t.lineTo(1.25*-this.width,0),t.lineTo(1.25*this.width,0),t.lineTo(this.width,-this.height/2.5),t.closePath(),t.fillStyle=b[this.rank].main,t.fill(),t.stroke(),t.beginPath(),t.arc(0,0,this.width,0,Math.PI),t.closePath(),t.fillStyle=b[this.rank].skin,t.fill(),t.stroke(),t.restore(),super.draw(t)}upgrade(){super.upgrade(),1===this.rank&&(this.health+=1,this.attack+=1),2===this.rank&&(this.attackRate=new k(1e3))}},T=class extends p{name="Knight";type=2;cost=6;upgradeCost=3;healCost=3;goldValue=3;attack=2;speed=.33;maxHealth=8;health=this.maxHealth;attackRange=50;attackRate=new k(1e3);animateMeleeAttack(t){var e;this.meleeAttack&&this.target&&(t.save(),t.fillStyle="white",e=.0349066*(this.meleeAttackFrames-2*this.meleeAttack),t.translate(this.pos.x,this.pos.y),this.target.pos.x<this.pos.x?t.rotate(this.attackAngle-e):t.rotate(this.attackAngle+e),t.lineWidth=2,t.fillStyle="black",t.moveTo(0,0),t.lineTo(this.attackRange-this.width,0),t.stroke(),t.fillStyle="gray",t.beginPath(),t.arc(this.attackRange-this.width,0,this.width/3,0,2*Math.PI),t.closePath(),t.fill(),t.stroke(),t.restore())}draw(t){var{x:e,y:i}=this.pos;this.drawHealthBar(t),this.animateMeleeAttack(t),t.save(),t.translate(e,i),t.lineWidth=2,t.beginPath(),t.arc(0,-this.height,this.width/4,Math.PI,0),t.closePath(),t.fillStyle=b[this.rank].main,t.fill(),t.stroke(),t.beginPath(),t.arc(0,0,this.width,Math.PI,0),t.closePath(),t.fillStyle=b[this.rank].accent,t.fill(),t.stroke(),t.beginPath(),t.arc(0,0,this.width,0,Math.PI),t.closePath(),t.fillStyle=b[this.rank].skin,t.fill(),t.stroke(),t.beginPath(),t.moveTo(-this.width,-this.height/4),t.lineTo(-this.width,0),t.lineTo(0,this.height/2),t.lineTo(this.width,0),t.lineTo(this.width,-this.height/4),t.lineTo(0,-this.height/1.5),t.closePath(),t.fillStyle=b[this.rank].main,t.fill(),t.stroke(),t.restore(),super.draw(t)}upgrade(){super.upgrade(),1===this.rank&&(this.speed+=.1),2===this.rank&&(this.attackRate=new k(800))}},J=class extends p{name="Pope";type=2;attack=4;speed=.25;maxHealth=100;health=this.maxHealth;attackRange=100;attackRate=new k(1e3);animateMeleeAttack(t){var e;this.meleeAttack&&this.target&&(t.save(),t.fillStyle="white",e=.0349066*(this.meleeAttackFrames-2*this.meleeAttack),t.translate(this.pos.x,this.pos.y),this.target.pos.x<this.pos.x?t.rotate(this.attackAngle-e):t.rotate(this.attackAngle+e),t.lineWidth=2,t.fillStyle="black",t.moveTo(0,0),t.lineTo(this.attackRange-this.width,0),t.stroke(),t.fillStyle="gold",t.beginPath(),t.arc(this.attackRange-this.width,0,this.width/3,0,2*Math.PI),t.closePath(),t.fill(),t.stroke(),t.restore())}draw(t){var{x:e,y:i}=this.pos;this.drawHealthBar(t),this.animateMeleeAttack(t),t.save(),t.translate(e,i),t.lineWidth=2,t.beginPath(),t.arc(0,0,this.width,0,Math.PI),t.closePath(),t.fillStyle=b[this.rank].skin,t.fill(),t.stroke(),t.beginPath(),t.moveTo(1.2*-this.width,.9*-this.height),t.lineTo(-this.width,0),t.lineTo(this.width,0),t.lineTo(1.2*this.width,.9*-this.height),t.lineTo(0,1.5*-this.height),t.closePath(),t.fillStyle="white",t.fill(),t.stroke(),t.beginPath(),t.moveTo(1.1*-this.width,.5*-this.height),t.lineTo(-this.width,0),t.lineTo(0,this.height/2),t.lineTo(this.width,0),t.lineTo(1.1*this.width,.5*-this.height),t.lineTo(0,-this.height),t.closePath(),t.fillStyle="gray",t.fill(),t.stroke(),t.beginPath(),t.arc(0,.9*-this.height,this.width/4,2*Math.PI,0),t.closePath(),t.fillStyle="gold",t.fill(),t.stroke(),t.restore(),super.draw(t)}},A={0:{main:"#794100",accent:"#c37100",skin:"#ffdba2"},1:{main:"#004391",accent:"#264044",skin:"#ffdba2"},2:{main:"#000000",accent:"#880000",skin:"#ffdba2"}},C=class extends p{name="Foot Soldier";type=2;cost=1;upgradeCost=2;healCost=1;attack=1;speed=.4;maxHealth=4;health=this.maxHealth;attackRange=50;attackRate=new k(1e3);goldValue=1;animateMeleeAttack(t){var e;this.meleeAttack&&this.target&&(t.save(),t.fillStyle="white",e=.0349066*(this.meleeAttackFrames-2*this.meleeAttack),t.translate(this.pos.x,this.pos.y),this.target.pos.x<this.pos.x?t.rotate(this.attackAngle-e):t.rotate(this.attackAngle+e),t.lineWidth=2,t.fillStyle="black",t.moveTo(0,0),t.lineTo(this.attackRange-this.width,0),t.stroke(),t.fillStyle="gray",t.beginPath(),t.arc(this.attackRange-this.width,0,this.width/3,0,2*Math.PI),t.closePath(),t.fill(),t.stroke(),t.restore())}draw(t){var{x:e,y:i}=this.pos;this.drawHealthBar(t),this.animateMeleeAttack(t),t.save(),t.translate(e,i),t.lineWidth=2,t.beginPath(),t.arc(0,-this.height,this.width/5,0,2*Math.PI),t.closePath(),t.fillStyle=A[this.rank].accent,t.fill(),t.stroke(),t.beginPath(),t.arc(0,0,this.width,Math.PI,0),t.closePath(),t.fillStyle=A[this.rank].accent,t.fill(),t.stroke(),t.fillStyle=A[this.rank].main,t.fillRect(-this.width,-this.height/2,2*this.width,this.height/2),t.strokeRect(-this.width,-this.height/2,2*this.width,this.height/2),t.beginPath(),t.arc(0,0,this.width,0,Math.PI),t.closePath(),t.fillStyle=A[this.rank].skin,t.fill(),t.stroke(),t.restore(),super.draw(t)}upgrade(){super.upgrade(),1===this.rank&&(this.speed+=.25,this.health+=1),2===this.rank&&(this.attack+=.2)}},O=class extends p{name="Horse Archer";type=0;cost=8;upgradeCost=4;healCost=2;goldValue=2;attack=1;speed=.8;maxHealth=4;health=this.maxHealth;attackRange=180;attackRate=new k(1e3);draw(t){var{x:e,y:i}=this.pos;this.drawHealthBar(t),t.save(),t.translate(e,i),t.lineWidth=2,t.beginPath(),t.ellipse(0,-this.height,this.width/3,this.height/4,0,0,2*Math.PI),t.closePath(),t.fillStyle=A[this.rank].accent,t.fill(),t.stroke(),t.beginPath(),t.arc(0,0,this.width,Math.PI,0),t.closePath(),t.fillStyle=A[this.rank].main,t.fill(),t.stroke(),t.beginPath(),t.arc(0,0,this.width,0,Math.PI),t.closePath(),t.fillStyle=A[this.rank].skin,t.fill(),t.stroke(),t.beginPath(),t.moveTo(-this.width,-this.height/2),t.lineTo(-this.width,0),t.lineTo(0,this.height/3),t.lineTo(this.width,0),t.lineTo(this.width,-this.height/2),t.lineTo(0,-this.height/4),t.closePath(),t.fillStyle=A[this.rank].accent,t.fill(),t.stroke(),t.restore(),super.draw(t)}upgrade(){super.upgrade(),1===this.rank&&(this.speed+=.1,this.attackRange+=20),2===this.rank&&(this.attack+=1)}},Q=class extends p{name="Mounted Knight";type=1;cost=4;upgradeCost=3;healCost=3;goldValue=3;attack=2;speed=.7;maxHealth=7;health=this.maxHealth;attackRange=60;attackRate=new k(1e3);draw(t){var{x:e,y:i}=this.pos;this.drawHealthBar(t),this.animateMeleeAttack(t),t.save(),t.translate(e,i),t.lineWidth=2,t.beginPath(),t.ellipse(0,-this.height,this.width/5,this.height/3,0,0,2*Math.PI),t.closePath(),t.fillStyle=A[this.rank].accent,t.fill(),t.stroke(),t.beginPath(),t.arc(0,0,this.width,Math.PI,0),t.closePath(),t.fillStyle=A[this.rank].main,t.fill(),t.stroke(),t.beginPath(),t.moveTo(1.25*-this.width,this.height/1.5),t.lineTo(-this.width,-this.height/3),t.lineTo(this.width,-this.height/3),t.lineTo(1.25*this.width,this.height/1.5),t.closePath(),t.fillStyle=A[this.rank].main,t.fill(),t.stroke(),t.fillStyle=A[this.rank].accent,t.fillRect(-this.width,-this.height/2,2*this.width,this.height/2),t.strokeRect(-this.width,-this.height/2,2*this.width,this.height/2),t.beginPath(),t.arc(0,0,this.width,0,Math.PI),t.closePath(),t.fillStyle=A[this.rank].skin,t.fill(),t.stroke(),t.restore(),super.draw(t)}upgrade(){super.upgrade(),1===this.rank&&(this.speed+=.25,this.attack),2===this.rank&&(this.health+=3)}},R=class{constructor(t,e,i){this.radius=t,this.color=e,this.pos=i}angle=0;vr;maxRotation;update(t){this.angle+=this.vr,Math.abs(this.angle)>this.maxRotation&&(this.vr=-1*this.vr)}draw(t){t.save(),t.fillStyle=this.color[n()],t.translate(this.pos.x,this.pos.y),t.rotate(this.angle),t.beginPath(),t.lineWidth=2,t.moveTo(-this.radius,0),t.lineTo(0,-this.radius),t.arc(0,0,this.radius,0,Math.PI),t.closePath(),t.fill(),t.stroke(),t.restore()}},Z=class{constructor(t,e){this.size=t,this.pos=e,this.sway=j(.05,.2);var i,t=.7*this.size,e=.9*this.size,s=this.size,a=new r(this.pos.x,this.pos.y-e/2),n=new r(this.pos.x,a.y-t/2);this.topSegment=new R(t,this.topColor,n),this.middleSegment=new R(e,this.middleColor,a),this.bottomSegment=new R(s,this.bottomColor,this.pos);for(i of[this.topSegment,this.bottomSegment,this.middleSegment])i.maxRotation=this.sway,i.vr=this.sway/50}stumpColor="#673d33";topColor={summer:"#afba38",spring:"#afba38",winter:"#d5eef1",fall:"#c0be3d"};middleColor={summer:"#75a535",spring:"#75a535",winter:"#64b5ce",fall:"#caab20"};bottomColor={summer:"#316a26",spring:"#316a26",winter:"#547fb1",fall:"#8f6e15"};topSegment;middleSegment;bottomSegment;sway;update(t){this.topSegment.update(t),this.middleSegment.update(t),this.bottomSegment.update(t)}draw(t){this.drawStump(t),this.bottomSegment.draw(t),this.middleSegment.draw(t),this.topSegment.draw(t)}drawStump(t){var e=this.size/2,i=1.1*this.size;t.save(),t.translate(this.pos.x,this.pos.y),t.fillStyle=this.stumpColor,t.beginPath(),t.moveTo(0,0),t.lineTo(.6*-e,0),t.lineTo(-e,i),t.lineTo(0,1.1*i),t.lineTo(e,i),t.lineTo(.6*e,0),t.closePath(),t.fill(),t.stroke(),t.restore()}overlaps(t){var{x:e,y:i}=this.pos;return(e=Math.sqrt(Math.pow(t.pos.x-e,2)+Math.pow(t.pos.y-i,2)))<=this.bottomSegment.radius+t.bottomSegment.radius&&e>=Math.abs(this.bottomSegment.radius-t.bottomSegment.radius)}},tt=[[92,475],[176,287],[58,244],[31,354],[159,443],[61,575],[198,14],[134,92],[117,261],[46,16],[217,236],[97,146],[221,511],[142,522],[197,579],[157,188],[0,134],[34,508],[112,348],[121,4],[205,96],[134,587],[218,413],[5,422],[63,92],[223,340],[85,402],[14,289],[221,171],[0,595],[776,159],[584,514],[742,373],[736,562],[809,492],[629,60],[710,250],[624,225],[665,308],[776,311],[633,387],[563,287],[654,148],[602,593],[770,18],[759,434],[712,190],[669,544],[639,483],[560,67],[573,141],[748,500],[806,100],[705,74],[562,379],[571,441],[665,0],[699,421],[594,8],[775,242]].map(([t,e])=>new Z(30,new r(t,e))),M=175,B=100,E=[[new S(new o(15,15,new r(300,p=250))),new S(new o(15,15,new r(500,p))),new S(new o(15,15,new r(400,p)))],[new S(new o(15,15,new r(300,M)),1),new S(new o(15,15,new r(500,M)),1),new T(new o(15,15,new r(400,B)))],[new S(new o(15,15,new r(300,p))),new S(new o(15,15,new r(500,p))),new P(new o(15,15,new r(350,M))),new P(new o(15,15,new r(450,M))),new T(new o(15,15,new r(400,B)),1)],[new S(new o(15,15,new r(300,p)),2),new S(new o(15,15,new r(500,p))),new S(new o(15,15,new r(350,p))),new S(new o(15,15,new r(450,p)),2),new P(new o(15,15,new r(350,M))),new P(new o(15,15,new r(450,M))),new T(new o(15,15,new r(400,B)),1)],[new S(new o(15,15,new r(300,p))),new S(new o(15,15,new r(500,p))),new S(new o(15,15,new r(350,p))),new S(new o(15,15,new r(450,p))),new S(new o(15,15,new r(300,M)),1),new S(new o(15,15,new r(500,M)),1),new S(new o(15,15,new r(350,M)),1),new S(new o(15,15,new r(450,M)),1),new S(new o(15,15,new r(300,B)),2),new S(new o(15,15,new r(500,B)),2),new S(new o(15,15,new r(350,B)),2),new S(new o(15,15,new r(450,B)),2)],[new S(new o(15,15,new r(300,p))),new S(new o(15,15,new r(500,p))),new S(new o(15,15,new r(350,p))),new S(new o(15,15,new r(450,p))),new T(new o(15,15,new r(400,p))),new P(new o(15,15,new r(350,B)),2),new P(new o(15,15,new r(450,B)),2),new P(new o(15,15,new r(400,B)),2)],[new T(new o(15,15,new r(300,p))),new T(new o(15,15,new r(500,p))),new S(new o(15,15,new r(300,M)),1),new S(new o(15,15,new r(500,M)),1),new S(new o(15,15,new r(350,M)),1),new S(new o(15,15,new r(450,M)),1),new S(new o(15,15,new r(400,M)),1),new P(new o(15,15,new r(300,B)),2),new P(new o(15,15,new r(500,B)),2),new P(new o(15,15,new r(400,B)),1)],[new T(new o(15,15,new r(300,p)),1),new T(new o(15,15,new r(500,p)),1),new T(new o(15,15,new r(350,p)),1),new T(new o(15,15,new r(450,p)),1),new T(new o(15,15,new r(400,p)),2),new P(new o(15,15,new r(300,M)),1),new P(new o(15,15,new r(500,M)),1),new P(new o(15,15,new r(350,M)),1),new P(new o(15,15,new r(450,M)),1),new P(new o(15,15,new r(400,M)),1),new S(new o(15,15,new r(300,B)),2),new S(new o(15,15,new r(500,B)),2),new S(new o(15,15,new r(350,B)),2),new S(new o(15,15,new r(450,B)),2),new S(new o(15,15,new r(400,B)),2)],[new P(new o(15,15,new r(300,p)),1),new S(new o(15,15,new r(500,p)),2),new S(new o(15,15,new r(350,p)),2),new S(new o(15,15,new r(450,p)),2),new S(new o(15,15,new r(400,p)),1),new P(new o(15,15,new r(300,M)),1),new T(new o(15,15,new r(500,M)),1),new T(new o(15,15,new r(350,M)),1),new T(new o(15,15,new r(450,M)),1),new T(new o(15,15,new r(400,M)),1),new T(new o(15,15,new r(300,B)),2),new S(new o(15,15,new r(500,B)),2),new S(new o(15,15,new r(350,B)),2),new S(new o(15,15,new r(450,B)),2),new P(new o(15,15,new r(400,B)),2)],[new T(new o(15,15,new r(300,p)),2),new T(new o(15,15,new r(500,p)),2),new T(new o(15,15,new r(350,p)),2),new T(new o(15,15,new r(450,p)),2),new T(new o(15,15,new r(400,p)),2),new P(new o(15,15,new r(300,M)),1),new P(new o(15,15,new r(500,M)),1),new P(new o(15,15,new r(350,M)),1),new P(new o(15,15,new r(450,M)),1),new P(new o(15,15,new r(400,M)),1),new S(new o(15,15,new r(300,B)),2),new S(new o(15,15,new r(500,B)),2),new S(new o(15,15,new r(350,B)),2),new S(new o(15,15,new r(450,B)),2),new S(new o(15,15,new r(400,B)),2)],[new T(new o(15,15,new r(300,p)),2),new T(new o(15,15,new r(500,p)),2),new T(new o(15,15,new r(350,p)),2),new T(new o(15,15,new r(450,p)),2),new T(new o(15,15,new r(400,p)),2),new P(new o(15,15,new r(300,M)),2),new P(new o(15,15,new r(500,M)),2),new P(new o(15,15,new r(350,M)),2),new P(new o(15,15,new r(450,M)),2),new P(new o(15,15,new r(400,M)),2),new S(new o(15,15,new r(300,B)),2),new S(new o(15,15,new r(500,B)),2),new S(new o(15,15,new r(350,B)),2),new S(new o(15,15,new r(450,B)),2),new S(new o(15,15,new r(400,B)),2)],[new T(new o(15,15,new r(300,p)),2),new T(new o(15,15,new r(500,p)),2),new T(new o(15,15,new r(350,p)),2),new T(new o(15,15,new r(450,p)),2),new T(new o(15,15,new r(400,p)),2),new P(new o(15,15,new r(300,M)),2),new P(new o(15,15,new r(500,M)),2),new P(new o(15,15,new r(350,M)),2),new P(new o(15,15,new r(450,M)),2),new P(new o(15,15,new r(400,M)),2),new S(new o(15,15,new r(300,B)),2),new S(new o(15,15,new r(500,B)),2),new S(new o(15,15,new r(350,B)),2),new S(new o(15,15,new r(450,B)),2),new S(new o(15,15,new r(400,B)),2),new J(new o(30,30,new r(400,B)))]],H=document.querySelector.bind(document),p=class{mouse=new r;_gold=0;get gold(){return this._gold}set gold(t){this._gold=t,H("#gold").innerText=t}_wave=0;get wave(){return this._wave}set wave(t){this._wave=t,H("#wave").innerText=t+"/"+E.length}_state=3;get state(){return this._state}set state(t){this._state=t,this.setUILayerVisibility()}_healCost=0;get healCost(){return this._healCost}set healCost(t){this._healCost=t,this.updateHealCostUi()}_upgradeCost=0;get upgradeCost(){return this._upgradeCost}set upgradeCost(t){this._upgradeCost=t,this.updateUpgradeCostUI()}maxSoldiersPerArmy=15;projectiles=t;explosions=m;soldierSize=15;playerUnits=[new C(new o),new Q(new o),new O(new o)];playerArmy=[new C(new o(this.soldierSize,this.soldierSize,new r(350,400))),new C(new o(this.soldierSize,this.soldierSize,new r(450,400))),new O(new o(this.soldierSize,this.soldierSize,new r(400,450)))];enemyUnits=[new S(new o),new T(new o),new P(new o)];enemyArmy=[];selectedUnit;placementBounds=new o;_livingSoldiers;get livingSoldiers(){return this._livingSoldiers}set livingSoldiers(t){this._livingSoldiers=t,H("#soldiers").innerText=t.length+"/"+this.playerArmy.length}_livingEnemies;get livingEnemies(){return this._livingEnemies}set livingEnemies(t){this._livingEnemies=t,H("#enemies").innerText=t.length+"/"+this.enemyArmy.length}$recruitButtons=[];calculateLivingSoldiers(){return this.playerArmy.filter(t=>t.alive)}calculateLivingEnemies(){return this.enemyArmy.filter(t=>t.alive)}startBattle(){this.wave>E.length||(x.playMusic(),delete this.selectedUnit,this.state=0,this.enemyArmy=E[this.wave-1],[...this.enemyArmy,...this.playerArmy].forEach(t=>{t.attackRate.elapsed=0,t.damaged=0,t.meleeAttack=0}))}start(){window.onmousemove=t=>{"fg"===t.target.getAttribute("id")&&(this.mouse.x=t.offsetX,this.mouse.y=t.offsetY)},this.createPlayingField(),this.createDecorations(),this.createGlitter(),this.initDom(),this.setUILayerVisibility(),this.updateRecruitButtons(),this.wave=1,this.gold=0,this.updateHealCostUi(),this.updateUpgradeCostUI(),this.livingEnemies=this.enemyArmy,this.livingSoldiers=this.playerArmy,this.placementBounds.pos.x=this.playingField.pos.x,this.placementBounds.pos.y=this.playingField.pos.y+this.playingField.height/2,this.placementBounds.width=this.playingField.width,this.placementBounds.height=this.playingField.height/2,H("#current-soldiers").innerText=this.playerArmy.length}updateHealCostUi(){H("#heal-cost").innerText=0<this.healCost?"$"+this.healCost:"",0===this.healCost||this.healCost>this.gold?H("#heal-cost").parentElement.setAttribute("disabled",""):H("#heal-cost").parentElement.removeAttribute("disabled")}updateUpgradeCostUI(){H("#upgrade-cost").innerText=0<this.upgradeCost?"$"+this.upgradeCost:"",0===this.upgradeCost||this.upgradeCost>this.gold?H("#upgrade-cost").parentElement.setAttribute("disabled",""):H("#upgrade-cost").parentElement.removeAttribute("disabled")}update(e){this.glitter.forEach(t=>t.update(e)),this.decorations.forEach(t=>t.update(e)),3===this.state&&this.selectedUnit&&this.placementBounds.containsPoint(this.mouse)&&(this.selectedUnit.bounds.pos=this.mouse.copy()),0===this.state&&(this.livingEnemies=this.calculateLivingEnemies(),this.livingSoldiers=this.calculateLivingSoldiers(),this.livingEnemies.forEach(t=>t.update(e,this.livingSoldiers)),this.livingSoldiers.forEach(t=>t.update(e,this.livingEnemies)),this.updateProjectiles(),this.livingEnemies.length<=0||this.livingSoldiers.length<=0)&&this.endBattle()}updateProjectiles(){for(let e of this.projectiles.filter(t=>!t.finished))e.update(),this.livingSoldiers.find(t=>t.id===e.parentId)?e.finished=this.checkProjectileHitsEnemyUnit(e):this.livingEnemies.find(t=>t.id===e.parentId)&&(e.finished=this.checkProjectileHitsPlayerUnit(e)),this.playingField.containsPoint(e.position)||(e.finished=!0)}checkProjectileHitsPlayerUnit(e){var t,i=this.livingSoldiers.filter(t=>t.id!==e.parentId).find(t=>t.getHitBox().containsPoint(e.position));return!!i&&((t=this.livingEnemies.find(t=>t.id===e.parentId))&&(i.damaged=i.maxDamageFrames,i.health-=t.attack,x.playSound(x.arrowHit)),!0)}checkProjectileHitsEnemyUnit(e){var t,i=this.livingEnemies.filter(t=>t.id!==e.parentId).find(t=>t.getHitBox().containsPoint(e.position));return!!i&&((t=this.livingSoldiers.find(t=>t.id===e.parentId))&&(i.damaged=i.maxDamageFrames,i.health-=t.attack,x.playSound(x.arrowHit),i.health<=0)&&(t.experience+=1),!0)}setUILayerVisibility(){switch(this.state){case 3:H("#ui-left").style.visibility="visible",H("#ui-right").style.visibility="visible",H("#ui-soldier-counts").style.visibility="hidden",H("#ui-battle-breakdown").style.visibility="hidden";break;case 0:H("#ui-left").style.visibility="hidden",H("#ui-right").style.visibility="hidden",H("#ui-soldier-counts").style.visibility="visible",H("#ui-battle-breakdown").style.visibility="hidden";break;case 1:case 2:H("#ui-left").style.visibility="hidden",H("#ui-right").style.visibility="hidden",H("#ui-soldier-counts").style.visibility="hidden",H("#ui-battle-breakdown").style.visibility="visible";break;case 5:H("#ui-game-complete").style.visibility="visible",H("#ui-left").style.visibility="hidden",H("#ui-right").style.visibility="hidden",H("#ui-soldier-counts").style.visibility="hidden",H("#ui-battle-breakdown").style.visibility="hidden"}}endingBattle=!1;endBattle(){this.endingBattle||(this.endingBattle=!0,setTimeout(()=>{x.stopMusic();var t={},e=(t.waveNumber=this.wave,t.unitsLost=this.playerArmy.length-this.livingSoldiers.length,t.goldEarned=this.enemyArmy.reduce((t,e)=>t+e.goldValue,0),t.battleWon=0<this.livingSoldiers.length,this.state=3,0<this.livingSoldiers.length);t.goldEarned=e?t.goldEarned:Math.floor(t.goldEarned/2),e&&this.wave<=E.length?(this.wave+=1,L()):this.resetSoldierHealth(),this.gold+=t.goldEarned,this.healCost=this.calculateHealCost(),this.upgradeCost=this.calculateUpgradeCost(),g.bg.clearRect(0,0,i,s),this.playingField.draw(g.bg),this.livingSoldiers=this.playerArmy.filter(t=>t.alive),H("#current-soldiers").innerText=this.playerArmy.length,this.projectiles.length=0,this.playerArmy=this.livingSoldiers,this.resetSoldierPositions(),this.setUILayerVisibility(),this.updateRecruitButtons(),this.endingBattle=!1,this.wave>E.length?this.state=5:this.showBattleBreakdown(t)},2500))}showBattleBreakdown(t){var e=t.battleWon;this.state=e?1:2,e?H("#ui-battle-breakdown").classList.remove("loss"):H("#ui-battle-breakdown").classList.add("loss"),H("#status").innerText=e?"Battle Won":"Battle Lost",H("#wave-number").innerText=t.waveNumber,H("#troops-lost").innerText=t.unitsLost,H("#gold-earned").innerText=t.goldEarned,H("#continue").innerText=e?"Continue":"Try Again"}hideBattleBreakdown(){this.state=3}resetSoldierHealth(){this.enemyArmy.forEach(t=>{t.alive=!0,t.health=t.maxHealth}),this.playerArmy.forEach(t=>{t.alive=!0,t.health=t.maxHealth})}resetSoldierPositions(){this.enemyArmy.forEach(t=>t.bounds.pos=t.startPos.copy()),this.playerArmy.forEach(t=>t.bounds.pos=t.startPos.copy())}draw(){g.mg.clearRect(0,0,i,s),g.fg.clearRect(0,0,i,s),this.glitter.forEach(t=>t.draw(g.fg));for(var[t,e]of this.explosions.entries())e.ended?this.explosions.splice(t,1):z(g.fg,e);this.decorations.forEach(t=>t.draw(g.mg)),0===this.state&&(this.projectiles.filter(t=>!t.finished).forEach(t=>t.draw(g.mg)),this.livingEnemies.forEach(t=>t.draw(g.mg))),this.livingSoldiers.forEach(t=>{0!==this.state&&(t.damaged=0,t.meleeAttack=0),t.draw(g.mg)}),this.highlightPlacementBounds(),this.highlightSelectedUnit()}highlightPlacementBounds(){var t;this.selectedUnit&&((t=g.fg).save(),this.placementValid()?t.strokeStyle="rgba(0, 255, 0, .4)":t.strokeStyle="rgba(255, 0, 0, .4)",t.lineWidth=4,t.strokeRect(this.placementBounds.pos.x,this.placementBounds.pos.y,this.placementBounds.width,this.placementBounds.height),t.restore())}highlightSelectedUnit(){var t,e,i;this.selectedUnit&&({pos:t,width:e}=this.selectedUnit,(i=g.fg).save(),i.beginPath(),i.arc(t.x,t.y,1.5*e,0,2*Math.PI),this.placementValid()?i.fillStyle="rgba(0, 255, 0, .4)":i.fillStyle="rgba(255, 0, 0, .4)",i.closePath(),i.fill(),i.restore())}placementValid(){if(this.selectedUnit){let t=this.placementBounds.containsPoint(this.mouse),e=this.selectedUnit.getHitBox(),i=this.livingSoldiers.filter(t=>t.id!==this.selectedUnit?.id).every(t=>!t.getHitBox().intersects(e));return t&&i}return!1}initDom(){H("#heal").addEventListener("click",this.handleHealClick),H("#start").addEventListener("click",this.handleStartClick),H("#upgrade").addEventListener("click",this.handleUpgradeClick),H("#continue").addEventListener("click",this.handleContinueClick),H("#play-again").addEventListener("click",()=>window.location.reload()),H("#stage").addEventListener("pointerup",this.handleDrop),H("#stage").addEventListener("pointerdown",this.handleUnitPlacement),this.createRecruitButtons()}handleContinueClick=()=>{1===this.state&&(this.state=3),2===this.state&&(this.state=3)};createRecruitButtons(){var e=H("#recruit-buttons");for(let t of this.playerUnits){var i=document.createElement("span"),s=(i.classList.add("cost"),i.innerText="$"+t.cost,document.createElement("span")),a=(s.innerText=t.name,document.createElement("button"));a.dataset.unit=t.name,a.dataset.cost=t.cost.toString(),a.addEventListener("click",()=>{this.recruit(t.name)}),a.appendChild(i),a.appendChild(s),e.appendChild(a),this.$recruitButtons.push(a)}}updateRecruitButtons(){for(var t of this.$recruitButtons)Number(t.dataset.cost)>this.gold||this.playerArmy.length>=this.maxSoldiersPerArmy?t.setAttribute("disabled",""):t.removeAttribute("disabled")}handleUpgradeClick=()=>{var t=this.calculateUpgradeCost();this.gold>=t&&(this.livingSoldiers.filter(t=>t.canUpgrade()).forEach(t=>t.upgrade()),this.gold-=t,this.upgradeCost=this.calculateUpgradeCost(),this.updateRecruitButtons())};handleHealClick=()=>{var t=this.calculateHealCost();this.gold>=t&&(this.gold-=t,this.livingSoldiers.forEach(t=>t.health=t.maxHealth),this.healCost=this.calculateHealCost(),this.updateRecruitButtons())};handleStartClick=()=>{0!==this.state&&this.startBattle()};handleUnitPlacement=t=>{if(0!==this.state){let e=new r(t.offsetX,t.offsetY);this.selectedUnit?this.handleDrop(t):this.selectedUnit=this.livingSoldiers.find(t=>t.getHitBox().containsPoint(e))}};handleDrop=t=>{var e;this.selectedUnit&&(e=this.placementValid()?this.mouse.copy():this.selectedUnit.startPos,this.selectedUnit.bounds.pos=e,this.selectedUnit.startPos=e.copy(),delete this.selectedUnit)};calculateHealCost(){return this.livingSoldiers.filter(t=>t.hasDamage()).reduce((t,e)=>e.healCost+t,0)}calculateUpgradeCost(){return this.livingSoldiers.filter(t=>t.canUpgrade()).reduce((t,e)=>e.upgradeCost+t,0)}recruit(e){var t=this.playerUnits.find(t=>t.name===e);if(this.gold>=t.cost&&this.livingSoldiers.length<this.maxSoldiersPerArmy){this.gold-=t.cost;for(var i=this.playingField.pos.x+30,s=this.playingField.pos.x+this.playingField.width-30,a=this.playingField.pos.y+this.playingField.height-60,n=this.playingField.pos.y+this.playingField.height/2,h=new r(u(i,s),u(a,n)),h=new o(this.soldierSize,this.soldierSize,h),l=new t.constructor(h);l.collides(this.livingSoldiers);)l.bounds.pos=new r(u(i,s),u(a,n));this.playerArmy.push(l),this.updateRecruitButtons(),this.healCost=this.calculateHealCost(),this.upgradeCost=this.calculateUpgradeCost(),H("#current-soldiers").innerText=this.playerArmy.length}}decorations=[];createDecorations(){this.decorations=[...tt,new _(this.playingField),new W(this.playingField)],this.decorations.sort((t,e)=>t.pos.y<e.pos.y?0:1)}playingField;createPlayingField(){var t=i/3.3;this.playingField=new X(i-2*t,550,new r(t,25)),this.playingField.draw(g.bg)}glitter=[];createGlitter(){for(let t=0;t<100;t++)this.glitter.push(new q(new r(u(0,i),u(0,s)),new r(y(.01,.05),.1),y(.05,.8)))}},U=((()=>{h.classList.add(n()),h.style.width=i+"px",h.style.height=s+"px";for(var t of[l,d,w,c])t.width=i,t.height=s})(),new p);window.addEventListener("load",()=>{let s=Date.now();U.start(),function t(){requestAnimationFrame(t);var e=Date.now(),i=e-s;s=e,U.update(i),U.draw()}()})</script></body></html>