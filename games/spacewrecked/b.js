!function(t){function e(a){if(i[a])return i[a].exports;var n=i[a]={exports:{},id:a,loaded:!1};return t[a].call(n.exports,n,n.exports,e),n.loaded=!0,n.exports}var i={};e.m=t,e.c=i,e.p="",e(0)}([function(t,e,i){i(6),i(4),i(11),i(2),i(8),i(5),i(10),i(12),i(7),i(1),i(3)},function(t,e){AFRAME.registerComponent("auto-destroy",{init:function(){var t=this.el.getObject3D("mesh");t&&(t.material.depthTest=!1);let e=this.el.components.position.data.x||0,i=this.el.components.position.data.y||0,a=this.el.components.position.data.z||0,n={y:i};new TWEEN.Tween(n).to({y:i-.25},500).easing(TWEEN.Easing.Quadratic.In).onUpdate(()=>{this.el.setAttribute("position",{x:e,y:n.y,z:a})}).onComplete(()=>{this.el.parentNode.removeChild(this.el)}).start()}})},function(t,e){AFRAME.registerComponent("billboard-texture",{schema:{index:{type:"int"},lookup:{type:"int",default:-1}},init:function(){const t=this.data;var e=document.getElementById("fragment").textContent,i=document.getElementById("vertex-billboard").textContent;this.material=new THREE.ShaderMaterial({uniforms:{time:{value:0},index:{value:this.data.index},DiffuseTexture:{value:window.t},color:{value:new THREE.Color(t.color)},spriteDimensions:{value:{x:16,y:1}},repeat:{value:{x:1,y:1}},Lookup:{value:window.pal},lookupIndex:{value:t.lookup},fogStart:{value:5},fogEnd:{value:15},alphatest:{value:.95},fogColor:{value:new THREE.Color(0,0,0)}},vertexShader:i,fragmentShader:e}),this.material.blending=THREE.MultiplyBlending,this.applyToMesh(),this.el.addEventListener("model-loaded",()=>this.applyToMesh())},update:function(){this.material.uniforms.index.value=this.data.index,this.material.uniforms.lookupIndex.value=this.data.lookup},applyToMesh:function(){const t=this.el.getObject3D("mesh");t&&(this.material.uniforms.repeat.value.x=+this.el.getAttribute("width")||1,this.material.uniforms.repeat.value.y=+this.el.getAttribute("height")||1,t.material=this.material)}})},function(t,e){AFRAME.registerComponent("canvas-text",{schema:{text:{value:"string"}},init:function(){this.update()},update:function(){var t=document.createElement("canvas"),e=t.getContext("2d");t.width=1024,t.height=1024,t.style.imageRendering="pixelated",e.font="bold 40px Arial",e.textBaseline="middle",e.textAlign="center",this.multiline(e,this.data.text,512,512);var i=new THREE.Texture(t);i.needsUpdate=!0,this.el.setAttribute("material",{src:i,transparent:!0,opacity:.8})},multiline:function(t,e,i,a){let n=1.2*t.measureText("M").width,o=e.split("\n");for(var s=0;s<o.length;++s)t.fillStyle="#be2633",t.fillText(o[s],i,a),t.strokeStyle="#000",t.strokeText(o[s],i,a),a+=n},write:function(t,e){this.data.text=t,this.update();var i={o:.8};e||(this.t=new TWEEN.Tween(i).to({o:0},250).delay(2e3).onUpdate(()=>{this.el.setAttribute("material",{opacity:i.o})}).start())}})},function(t,e){window.D={player:{t:1,s:2,h:10},mobs:[{h:[3,2],d:[1,1],i:6,m:0,c:70},{h:[4,4],d:[3,2],i:7,m:10,c:20},{h:[6,6],d:[5,4],i:9,m:30,c:10}],floors:[{t:3,b:1,s:[1],i:[2,5]}],items:[{t:1,n:"a heart",s:13,i:-1,m:0,c:70},{t:2,n:"an iron sword",d:3,s:5,i:1,m:0,c:20},{t:2,n:"a golden sword",d:6,s:5,i:23,m:6,c:10},{t:2,n:"a diamond sword",d:10,s:5,i:24,m:12,c:2},{t:3,n:"an iron shield",b:40,s:4,i:0,m:0,c:20},{t:3,n:"a golden shield",b:70,s:4,i:23,m:6,c:10},{t:3,n:"a diamond shield",b:85,s:4,i:24,m:12,c:5}],objs:[{t:8,p:1,n:"your plane's cabin",s:6},{t:8,p:2,n:"your plane's left wing",s:7},{t:8,p:3,n:"your plane's body",s:8},{t:8,p:4,n:"your plane's right wing",s:9},{t:8,p:5,n:"your plane's thruster",s:10}]}},function(t,e){AFRAME.registerComponent("gamemanager",{schema:{state:{value:"int",default:0}},init:function(){this.player=document.getElementById("player"),this.camera=document.getElementById("camera"),this.map=document.getElementById("mapgeo").components.map,this.message=document.querySelector("[canvas-text]").components["canvas-text"],this.cursor=document.querySelector("[cursor]"),this.camera.rot=0,window.GM=this},update:function(t){if(!(this.data.state>1))switch(this.data.state){case 0:this.player.components.player.move(t);break;case 1:this.cursor.setAttribute("cursor",{fuse:!1});let e=document.querySelectorAll("[mob]");e.forEach(t=>t.components.mob.move()),setTimeout(()=>{this.cursor.setAttribute("cursor",{fuse:!0}),this.data.state=0},500)}}})},function(t,e){window.rnd=(t=>~~(Math.random()*t)),window.t=new THREE.ImageUtils.loadTexture("./lost.png"),window.t.minFilter=window.t.magFilter=1003,window.pal=new THREE.ImageUtils.loadTexture("./palettes.png"),window.pal.minFilter=window.pal.magFilter=1003},function(t,e){AFRAME.registerComponent("item",{schema:{x:{value:"float"},y:{value:"float"},props:{value:"object"}},init:function(){this.pos=this.el.components.position},get:function(){let t=this;t.el.setAttribute("billboard-texture",{index:t.data.props.s,lookup:t.data.props.i});let e=t.el.components.position.data;e.t=1;let i=this.data.x,a=this.data.y,n=GM.map.getPix(i,a);return n.data[1]=0,GM.map.putPix(n,i,a),new Promise(i=>{var a=new TWEEN.Tween(e).to({y:e.y+1,t:0},350).easing(TWEEN.Easing.Quadratic.Out).onUpdate(function(){t.el.setAttribute("position",{x:e.x,y:e.y,z:e.z})}),n=new TWEEN.Tween(e).to({y:e.y-.5,t:0},350).easing(TWEEN.Easing.Quadratic.In).onUpdate(function(){t.el.setAttribute("position",{x:e.x,y:e.y,z:e.z})}).onComplete(function(){t.el.parentNode.removeChild(t.el),i(t.data.props)});a.chain(n).start()})}})},function(t,e,i){const a=i(9);window.size=128;AFRAME.registerComponent("map",{init:function(){this.mapContext=a.go(size,7);let t=document.createElement("a-entity"),e=this.mapContext.getImageData(0,0,size,size);for(let i=0;i<size;i++)for(let a=0;a<size;a++){let n=4*(i+size*a);if(0!=e.data[n]){let o=document.createElement("a-entity");o.classList.add("floor"),102==e.data[n]?o.setAttribute("mytexture","index:11;lookup:8"):170==e.data[n]?o.setAttribute("mytexture","index:12;lookup:10"):238==e.data[n]?o.setAttribute("mytexture","index:12;lookup:9"):o.setAttribute("mytexture","index:0;lookup:"+~~(5*i/(2*a)*3)%5);let s=i-size/2,r=a-size/2;o.addEventListener("click",function(){0===GM.data.state&&GM.player.components.player.move({x:s,y:r})}),o.setAttribute("position",`${s} 0 ${r}`),o.setAttribute("mixin","voxel"),t.appendChild(o)}}this.el.appendChild(t),this.el.appendChild(this.addObjs()),this.el.appendChild(this.addItems()),this.el.appendChild(this.addMobs())},getPix:function(t,e){return this.mapContext.getImageData(t,e,1,1)},putPix:function(t,e,i){return this.mapContext.putImageData(t,e,i)},randomPlace:function(t=0){let e,i,a;do e=window.rnd(size),i=window.rnd(size),a=this.getPix(e,i);while(a.data.every(t=>0==t))return{x:e,y:i,c:a}},getWeighted:function(t){let e,i=!1;do e=t[rnd(t.length)],i=rnd(100)<e.c;while(!i)return e},addItems:function(){let t=document.createElement("a-entity");for(let i=0;i<150;i++){let i,a,n,o,s=document.createElement("a-entity");do n=this.randomPlace(),o=this.getWeighted(D.items),o.map=n,e=new THREE.Vector2(0,0).distanceTo(new THREE.Vector2(n.x,n.y));while(o.m>=e)if(0==n.c.data[1]){n.c.data[1]=65,this.putPix(n.c,n.x,n.y),i=n.x-size/2,a=n.y-size/2;var e=new THREE.Vector2(0,0).distanceTo(new THREE.Vector2(i,a));s.setAttribute("billboard-texture",{index:3}),s.setAttribute("position",`${i} .25 ${a}`),s.setAttribute("mixin","spr"),s.setAttribute("item",{x:n.x,y:n.y,props:o}),s.id=`b${n.x}-${n.y}`,s.data=o,t.appendChild(s)}}return t},addMobs:function(){let t=document.createElement("a-entity");for(let e=0;e<150;e++){let e,i,a,n,o=document.createElement("a-entity"),s=this.getWeighted(D.mobs);do a=this.randomPlace(),e=a.x-size/2,i=a.y-size/2,n=new THREE.Vector2(0,0).distanceTo(new THREE.Vector2(e,i));while(s.m>=n)a.c.data[2]=136,this.putPix(a.c,a.x,a.y),o.setAttribute("billboard-texture",{index:2,lookup:s.i}),o.setAttribute("position",`${e} .25 ${i}`),o.setAttribute("mixin","spr"),o.setAttribute("mob",{x:a.x,y:a.y,health:rnd(s.h[1])+s.h[0],damage:rnd(s.d[1])+s.d[0]}),o.id=`e${a.x}-${a.y}`,t.appendChild(o)}return t},addObjs:function(){let t=document.createElement("a-entity");for(let e=0;e<5;e++){let i,a,n,o,s=document.createElement("a-entity");do n=this.randomPlace(),i=n.x-size/2,a=n.y-size/2,o=new THREE.Vector2(0,0).distanceTo(new THREE.Vector2(i,a));while(25>=o)n.c.data[1]=238,this.putPix(n.c,n.x,n.y),s.setAttribute("billboard-texture",{index:D.objs[e].s}),s.setAttribute("position",`${i} .25 ${a}`),s.setAttribute("mixin","spr"),s.setAttribute("item",{x:n.x,y:n.y,props:D.objs[e]}),s.id=`b${n.x}-${n.y}`,t.appendChild(s)}return t}})},function(t,e){var i={go:(t,e)=>{var i=[[[0,0,2,0,0],[2,1,1,1,0],[0,1,1,1,0],[0,1,0,1,2],[0,0,0,2,0]],[[0,0,2,0,0],[0,1,1,1,0],[0,1,0,1,0],[2,1,0,1,2],[0,1,1,1,0],[0,1,1,1,0],[0,0,2,0,0]],[[0,0,2,0,0],[0,1,1,1,1],[0,1,1,1,0],[2,1,1,1,2],[0,1,1,1,0],[1,1,1,1,0],[1,0,2,0,0]],[[0,1,1,1,0],[2,1,1,1,0],[0,1,0,1,0],[0,1,0,1,2],[0,1,1,1,0]],[[0,0,0,0],[2,1,1,2],[0,0,0,0]],[[0,2,0],[0,1,0],[0,1,0],[0,2,0]],[[0,0,0,0,0,0,0,0],[2,1,1,1,1,1,1,2],[0,0,0,0,0,0,0,0]],[[0,2,0],[0,1,0],[0,1,0],[0,1,0],[0,1,0],[0,1,0],[0,1,0],[0,2,0]],[[0,0,0,0,2,0],[0,0,0,1,1,0],[2,1,1,1,1,0],[0,1,1,0,1,1],[0,1,0,0,1,1],[0,0,1,1,1,2],[0,1,1,0,1,0],[0,0,0,0,2,0]],[[0,0,0,2,0,0],[0,0,0,1,0,0],[0,0,0,1,0,0],[2,1,1,1,1,2],[0,0,0,1,0,0],[0,0,0,1,0,0],[0,0,0,1,0,0],[0,0,0,2,0,0]],[[0,0,0,0,2,0,0,0,0,0,0],[0,0,0,1,1,0,0,0,0,0,0],[0,0,0,1,1,1,0,0,0,0,0],[2,1,1,1,1,0,1,1,2,0,0],[0,0,0,1,1,0,0,0,1,0,0],[0,0,1,1,0,0,0,1,1,1,0],[0,0,1,1,0,0,0,1,1,1,0],[0,0,1,1,0,0,1,1,1,1,0],[0,1,1,1,1,1,1,1,1,1,2],[0,1,0,1,0,1,1,1,1,1,0],[0,1,1,1,0,0,0,1,1,1,0],[0,0,1,1,0,0,0,0,1,0,0],[0,0,2,0,0,0,0,0,2,0,0]],[[0,0,0,0,0,0,2,0,0,0,0],[0,0,0,1,1,0,1,0,0,0,0],[0,0,1,1,1,1,1,1,0,0,0],[0,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,0],[0,1,1,1,1,1,1,1,1,1,0],[2,1,1,1,1,1,1,1,1,1,2],[0,1,1,1,1,1,1,1,1,1,0],[0,1,1,1,1,1,1,1,1,1,2],[0,1,1,1,1,1,1,1,1,1,0],[1,1,1,1,0,0,1,1,1,1,0],[1,1,1,1,0,0,1,1,1,0,0],[0,0,2,0,0,0,0,1,1,0,0]]];let a=i.length;for(let t=0;t<a;t++){let e=i[t].slice();for(let t=0;t<e.length;t++)e[t]=e[t].slice().reverse();i.push(e);let a=i[t].slice();a=a.reverse(),i.push(a);let n=e.slice();n=n.reverse(),i.push(n)}for(let t=0;t<i.length;t++){i[t].size={w:i[t][0].length,h:i[t].length},i[t].exits=[];for(let e=0;e<i[t].size.h;e++)for(let a=0;a<i[t].size.w;a++)2===i[t][e][a]&&i[t].exits.push({x:a,y:e})}var n=document.createElement("canvas");n.width=t,n.height=t,n.style.width="1024px",n.style.height="1024px",n.style.imageRendering="pixelated",document.body.appendChild(n);var o=n.getContext("2d");o.fillStyle="rgba(0, 0, 0, 0)",o.fillRect(0,0,t,t);let s=!0;var r=(t,e)=>{let a,n,r,d=[],l=!1,u=25;do{a=i[rnd(i.length)];for(var c=0;c<a.exits.length;c++){n=t.x-a.exits[c].x,r=t.y-a.exits[c].y;if(l=o.getImageData(n,r,a.size.w,a.size.h).data.every(t=>0===t))break}u--}while(u>0&&!l)return l||(a=[[1]],a.exits=[{}],n=t.x,r=t.y,c=0),o.fillStyle=s?"#600":"#400",s||o.fillRect(n+a.exits[c].x||0,r+a.exits[c].y||0,1,1),1===e&&(o.fillStyle="#E00"),2===e&&(o.fillStyle="#A00"),s=!1,a.forEach((t,e)=>{t.forEach((t,i)=>{1===t&&o.fillRect(n+i,r+e,1,1),2===t&&d.push({x:n+i,y:r+e})})}),d};let d=e,l=[{x:t/2,y:t/2}];for(let t=0;t<d;t++){let e,i=[];l.forEach((a,n)=>{t==d-1&&n==l.length-~~(l.length/3)&&(e=1),t==d-1&&n==~~(l.length/3)&&(e=2);let o=r(a,e);i=i.concat(o),e=0}),l=i}return o}};t.exports=i},function(t,e){AFRAME.registerComponent("mob",{schema:{x:{value:"float"},y:{value:"float"},health:{value:"int"},damage:{value:"int"}},init:function(){this.pos=this.el.components.position},move:function(){if(!(this.data.health<=0)){let i,a,n,o=this,s=GM.player.components.position.data;var t=new THREE.Vector3(s.x,s.z,0),e=new THREE.Vector3(this.pos.data.x,this.pos.data.z,0);if(t.distanceTo(e)<1.9){i=t.x-e.x,a=t.y-e.y;let n={x:o.pos.data.x,z:o.pos.data.z};new TWEEN.Tween(n).to({x:o.pos.data.x+i,z:o.pos.data.z+a},500).yoyo(!0).repeat(1).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){o.el.setAttribute("position",`${n.x} .25 ${n.z}`)}).onComplete(()=>{GM.player.components.player.hit(this.data.damage)}).start()}else{do i=rnd(3)-1,a=rnd(3)-1,n=GM.map.getPix(o.data.x+i,o.data.y+a);while(0==n.data[0])let t=GM.map.getPix(o.data.x,o.data.y);t.data[2]=0,GM.map.putPix(t,o.data.x,o.data.y),n.data[2]=136,o.data.x+=i,o.data.y+=a,GM.map.putPix(n,o.data.x,o.data.y);let e={x:o.pos.data.x,z:o.pos.data.z};new TWEEN.Tween(e).to({x:o.pos.data.x+i,z:o.pos.data.z+a},400+rnd(400)).delay(rnd(250)).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){o.el.setAttribute("position",`${e.x} .25 ${e.z}`),o.el.id=`e${e.x+size/2}-${e.z+size/2}`}).start()}}},hit:function(t){this.data.health-=t;let e=document.createElement("a-entity");if(e.setAttribute("billboard-texture",{index:14,lookup:12}),e.setAttribute("mixin","spr"),e.setAttribute("auto-destroy",""),this.el.appendChild(e),this.data.health<=0){this.el.id="";let t=GM.map.getPix(this.data.x,this.data.y);t.data[2]=0,GM.map.putPix(t,this.data.x,this.data.y),setTimeout(()=>{this.el.setAttribute("auto-destroy","")},500)}}})},function(t,e){AFRAME.registerComponent("mytexture",{schema:{color:{type:"color"},index:{type:"int"},lookup:{type:"int",default:0}},init:function(){const t=this.data;var e=document.getElementById("fragment").textContent,i=document.getElementById("vertex").textContent;this.material=new THREE.ShaderMaterial({uniforms:{time:{value:0},index:{value:this.data.index},DiffuseTexture:{value:window.t},Lookup:{value:window.pal},color:{value:new THREE.Color(t.color)},spriteDimensions:{value:{x:16,y:1}},repeat:{value:{x:1,y:1}},fogStart:{value:5},fogEnd:{value:15},lookupIndex:{value:t.lookup},fogColor:{value:new THREE.Color(0,0,0)},tint:{value:new THREE.Color(255,255,255)},tintAmount:{value:0}},vertexShader:i,fragmentShader:e}),this.applyToMesh(),this.el.addEventListener("model-loaded",()=>this.applyToMesh())},update:function(){this.material.uniforms.index.value=this.data.index,this.material.uniforms.lookupIndex.value=this.data.lookup},applyToMesh:function(){const t=this.el.getObject3D("mesh");t&&(this.material.uniforms.repeat.value.x=+this.el.getAttribute("width")||1,this.material.uniforms.repeat.value.y=+this.el.getAttribute("height")||1,t.material=this.material)}})},function(t,e){AFRAME.registerComponent("player",{schema:{health:{value:"int",default:25}},init:function(){this.foundPieces=0,this.attack=1,this.defense=0,this.sprite=document.querySelector("#player-sprite")},move:function(t){var e=this;if(0==GM.data.state){var i=e.el.components.position.data,a=new THREE.Vector3(t.x,t.y,0),n=new THREE.Vector3(i.x,i.z,0);if(i.r=GM.camera.rot,!(a.distanceTo(n)>1.9||a.distanceTo(n)<.2)){var o=GM.map.getPix(t.x+size/2,t.y+size/2);if(o.data[2]>0){let e=document.querySelector(`#e${t.x+size/2}-${t.y+size/2}`).components.mob,i={x:0,z:0};new TWEEN.Tween(i).to({x:a.x-n.x,z:a.y-n.y},500).yoyo(!0).repeat(1).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(()=>{this.sprite.setAttribute("position",`${i.x} 0 ${i.z}`)}).onComplete(()=>{e.hit(this.attack+rnd(2)),setTimeout(()=>{GM.data.state>2||(GM.data.state=1,GM.update())},1e3)}).start()}else o.data[1]>0&&document.querySelector(`#b${t.x+size/2}-${t.y+size/2}`).components.item.get().then(t=>{let i=`Found ${t.n}`;switch(t.t){case 1:e.data.health=Math.min(e.data.health+=5,25),i+=`
Health = ${e.data.health}/25`;break;case 2:t.d>this.attack&&(this.attack=t.d);break;case 3:this.defense=Math.max(this.defense,t.b);break;case 8:if(!(++this.foundPieces<5))return GM.data.state=3,void GM.message.write(`You found all pieces
and escaped the planet!`,1);i+=`
Only ${5-this.foundPieces} pieces left`}GM.message.write(i)}),new TWEEN.Tween(i).to({x:t.x,z:t.y},1e3).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){e.el.setAttribute("position",`${i.x} .25 ${i.z}`)}).onComplete(()=>{GM.data.state>2||(GM.data.state=1,GM.update())}).start()}}},hit:function(t){let e=t*(rnd(100)<this.defense?0:1),i=document.createElement("a-entity");i.setAttribute("billboard-texture",{index:14,lookup:e>0?5:1}),i.setAttribute("mixin","spr"),i.setAttribute("auto-destroy",""),this.el.appendChild(i),e>0&&(this.data.health-=e,this.data.health<=0?(this.sprite.setAttribute("billboard-texture",{index:15}),GM.data.state=3,GM.message.write(`Game Over`,1)):GM.message.write(`Ouch!
Health = ${this.data.health}/25`))}})}]);