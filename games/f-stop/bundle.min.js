const vert =`#version 300 es
precision highp float;precision highp int;in vec3 position;void main(){gl_Position=vec4(position,1.0);}`;
const copy = `#version 300 es
precision highp float;precision highp int;precision highp sampler2D;out vec4 fragColor;uniform sampler2D tex;void main(){fragColor=texelFetch(tex,ivec2(gl_FragCoord.xy),0);}`;
const frag_input = `#version 300 es
precision highp float;precision highp int;precision highp sampler2D;precision highp sampler3D;out vec4 fragColor;uniform sampler2D tPreviousTexture;uniform sampler3D uVx;uniform mat4 uCam;uniform vec2 ur;uniform float uSC;uniform float uFC;uniform float uAS;uniform float uFD;uniform float uPSC;uniform bool uCIM;
#define uSun vec3(0.42850027330247764,0.2862474085446186,-0.8570005466049553)
#define LEN 0.5773502691896257
#define PI 3.14159265358979323
#define TWO_PI 6.28318530717958648
#define E 2.71828182845904524
#define INF 1000000.0
#define T_R vec3(5.804542996261093E-6,1.3562911419845635E-5,3.0265902468824876E-5)
#define K vec3(0.686, 0.678, 0.666)
#define MI vec3(1.8399918514433978E14,2.7798023919660528E14,4.0790479543861094E14)
#define UP vec3(0.0,1.0,0.0)
#define gbm vec3(0.0)
#define gbmx vec3(25.0,0.3,25.0)
#define gX 250.0
#define gY 3.0
#define gZ 250.0
#define CS 0.1
vec3 ro,rd;vec3 hN,hC;float bN;float rn;uvec2 seed;float rand(){rn+=(bN+(mod(uFC,32.0)*0.61803399));return fract(rn);}float rng(){seed+=uvec2(1);uvec2 q=1103515245U*((seed >> 1U) ^ (seed.yx));uint n=1103515245U*((q.x) ^ (q.y >> 3U));return float(n)*(1.0/float(0xffffffffU));}vec3 RCWD(vec3 nl){float z=(rng()*2.0)-1.0;float phi=rng()*TWO_PI;float r=sqrt(1.0-(z*z));return normalize(nl+vec3(r*cos(phi),r*sin(phi),z));}vec3 RDSL(vec3 rd,float rg){float z=(rng()*2.0)-1.0;float phi=rng()*TWO_PI;float r=sqrt(1.0-(z*z));vec3 c=normalize(rd+vec3(r*cos(phi),r*sin(phi),z));return normalize(mix(rd,c,rg*rg));}float RP(float c){return 0.05968310365946075*(1.0+(c*c));}float hgPhase(float c,float g){float g2=g*g;float inv=1.0/pow(max(0.0,1.0-(2.0*g*c)+g2),1.5);return 0.07957747154594767*((1.0-g2)*inv);}vec3 totalMie(){float c=(0.2*1.0)*10E-18;return 0.434*c*MI;}float SI(float z){z=clamp(z,-1.0,1.0);return 1000.0*max(0.0,1.0-pow(E,-((1.6110731556870734-acos(z))/1.5)));}vec3 GSC(vec3 rayDir){vec3 vd=normalize(rayDir);vec3 rx=T_R*3.0;vec3 mieAtX=totalMie()*0.03;float cvsa=dot(vd,uSun);float csua=dot(UP,uSun);float sunE=SI(csua);float za=acos(max(0.0, dot(UP, vd)));float inv=1.0/(cos(za)+0.15*pow(93.885-((za*180.0)/PI),-1.253));float rol=8400.0*inv;float mol=1250.0*inv;vec3 Fex=exp(-((rx*rol)+(mieAtX*mol)));vec3 brt=rx*RP((cvsa*0.5)+0.5);vec3 bmt=mieAtX*hgPhase(cvsa,0.76);vec3 Lin=pow(sunE*((brt+bmt)/(rx+mieAtX))*(1.0-Fex),vec3(1.5));Lin*=mix(vec3(1.0),pow(sunE*((brt+bmt)/(rx+mieAtX))*Fex,vec3(0.5)),clamp(pow(1.0-csua,5.0),0.0,1.0));vec3 L0=vec3(0.1)*Fex;float sundisk=smoothstep(0.9998,0.9998+0.00002,cvsa);L0+=(sunE*19000.0*Fex)*sundisk;vec3 tc=((Lin+ L0)*0.04)+vec3(0.0,0.0003,0.00075);float sf=1.0-clamp(1.0-exp((uSun.y/450000.0)),0.0,1.0);vec3 retC=pow(tc,vec3(1.0/(1.2+(1.2*sf))));return retC;}float BI(vec3 minCorner,vec3 maxCorner,vec3 ro,vec3 rd,out vec3 normal){vec3 invDir=1.0/rd;vec3 near=(minCorner-ro)*invDir;vec3 far=(maxCorner-ro)*invDir;vec3 tmin=min(near,far);vec3 tmax=max(near,far);float t0=max(max(tmin.x,tmin.y),tmin.z);float t1=min(min(tmax.x,tmax.y),tmax.z);if(t0>t1)return INF;if(t0>0.0){normal = -sign(rd)*step(tmin.yzx,tmin)*step(tmin.zxy,tmin);return t0;}if(t1>0.0){normal = -sign(rd)*step(tmax,tmax.yzx)*step(tmax,tmax.zxy);return t1;}return INF;}float TF(float x){return (x<0.5)?sqrt(2.0*x) - 1.0 : 1.0 - sqrt(2.0 - (2.0 * x));}float hashF(vec2 p){p=50.0*fract(p*0.3183099+vec2(0.71,0.113));return -1.0+2.0*fract(p.x*p.y*(p.x + p.y));}float bnf(vec2 uv,float scale){vec2 i=floor(uv*scale);vec2 f=fract(uv*scale);float a=hashF(i+vec2(0.0,0.0));float b=hashF(i+vec2(1.0,0.0));float c=hashF(i+vec2(0.0,1.0));float d=hashF(i+vec2(1.0,1.0));vec2 u=f*f*(3.0-2.0*f);return mix(a,b,u.x)+(c-a)*u.y*(1.0-u.x)+(d-b)*u.x*u.y;}float TG(vec3 cc){vec3 normal;float d;float t=INF;float stepX=rd.x>0.0?1.0 : -1.0;float stepY=rd.y>0.0?1.0 : -1.0;float stepZ=rd.z>0.0?1.0 : -1.0;float tMaxX=((stepX>0.0?cc.x+1.0 : cc.x)*CS+gbm.x-ro.x)/rd.x;float tMaxY=((stepY>0.0?cc.y+1.0 : cc.y)*CS+gbm.y-ro.y)/rd.y;float tMaxZ=((stepZ>0.0?cc.z+1.0 : cc.z)*CS+gbm.z-ro.z)/rd.z;float dX=abs(CS/rd.x);float dY=abs(CS/rd.y);float dZ=abs(CS/rd.z);while(cc.x>=0.0&&cc.x<gX&&cc.y>=0.0&&cc.y<gY&&cc.z>=0.0&&cc.z<gZ){ivec3 vc=ivec3(cc.x,cc.y,cc.z);vec4 occ=texelFetch(uVx,vc,0);if(occ.a>0.0){vec3 mbb=vec3(gbm.x+float(vc.x)*CS,gbm.y+float(vc.y)*CS,gbm.z+float(vc.z)*CS);vec3 mxbb=vec3(mbb.x+CS,mbb.y+CS,mbb.z+CS);d=BI(mbb,mxbb,ro,rd,normal);if(d<t){t=d;hN=normal;hC=occ.rgb;}}if(t<INF){return t;}if(tMaxX<tMaxY){if(tMaxX<tMaxZ){cc.x+=stepX;tMaxX+=dX;}else{cc.z+=stepZ;tMaxZ+=dZ;}}else{if(tMaxY<tMaxZ){cc.y+=stepY;tMaxY+=dY;}else{cc.z+=stepZ;tMaxZ+=dZ;}}}float tExit=min(min(tMaxX,tMaxY),tMaxZ);float ey=(ro.y+rd.y*tExit);ey=min(max(ey,gbm.y),gbmx.y);float rv=round(ey*100.0)/100.0;if(rv==0.0){d=BI(vec3(0.0,-0.2,0.0),vec3(25.0,0.0,25.0),ro,rd,normal);if(d<t){t=d;hN=normal;hC=vec3(0.95,0.94,0.85);}return t;}else{return INF;}}vec3 RT(){vec3 sro,srd,cro,crd;cro=ro;crd=rd;vec3 randVec=vec3(rng()*2.0-1.0,rng()*2.0-1.0,rng()*2.0-1.0);randVec=normalize(randVec);vec3 isc=GSC(rd);sro=ro*vec3(0.02);srd=normalize(vec3(rd.x,abs(rd.y),rd.z));vec3 skyPos=sro+srd;vec3 ac=vec3(0);vec3 mask=vec3(1);vec3 n,nl,x;vec3 fX=vec3(0);float weight;float t=INF;int diff=0;int skyHit=0;int sampleLight=0;int bis=1;vec3 normal;float hit,hd;hit=BI(gbm,gbmx,ro,rd,normal);if(hit<INF){hN=normal;n=normalize(hN);nl=dot(n,rd)<0.0?n : -n;x=ro+rd*hit;vec3 cc;for(int bounces=0;bounces<3;bounces++){if(bounces==0){cc=x-0.0001*n;cc=vec3(floor((cc.x-gbm.x)/CS),floor((cc.y-gbm.y)/CS),floor((cc.z-gbm.z)/CS));}else{cc=vec3(floor((ro.x-gbm.x)/CS),floor((ro.y-gbm.y)/CS),floor((ro.z-gbm.z)/CS));}t=TG(cc);if(t==INF){vec3 skyColor=GSC(rd);if(bounces==0){skyHit=1;fX=skyPos;isc=skyColor;ac+=skyColor;break;}else if(diff==0&&bis==1){fX=skyPos;isc=mask*skyColor;ac+=isc;}else if(sampleLight==1){ac+=mask*skyColor;}else if(diff>0){weight=dot(rd,uSun)<0.99 ? 1.0 : 0.0;ac+=mask*skyColor*weight;}break;}if(sampleLight==1){break;}n=normalize(hN);nl = dot(n, rd) < 0.0 ? n : -n;x=ro+rd*t;if(bounces==0){fX=x;}diff++;mask *= hC;bis=0;if(diff==1&&rand()<0.5){mask *= 2.0;rd=RCWD(nl);ro=x+nl*0.01;continue;}rd=RDSL(uSun,0.1);ro=x+nl*0.01;weight=max(0.0,dot(rd,nl))*0.05;mask *= diff == 1 ? 2.0 : 1.0;mask *= weight;sampleLight=1;}}else{vec3 skyColor=GSC(rd);skyHit=1;fX=skyPos;isc=skyColor;ac+=skyColor;}if(skyHit==1){hd=distance(sro,skyPos);ac=mask*mix(ac,isc,clamp(exp2(-hd*0.004),0.0,1.0));}else{hd=distance(cro,fX);ac=mix(isc,ac,clamp(exp2(-log(hd*0.00003)),0.0,1.0));}return max(vec3(0),ac);}
void main(){vec3 camR=vec3(uCam[0][0],uCam[0][1],uCam[0][2]);vec3 camU=vec3(uCam[1][0],uCam[1][1],uCam[1][2]);vec3 camF=vec3(-uCam[2][0],-uCam[2][1],-uCam[2][2]);vec3 camP=vec3(uCam[3][0],uCam[3][1],uCam[3][2]);seed=uvec2(uFC,uFC+1.0)*uvec2(gl_FragCoord);rn=0.0;bN=bnf(gl_FragCoord.xy/ur.xy,384.0);vec4 cp=vec4(0);vec2 po=vec2(TF(rng()),TF(rng()));vec2 pixelPos=((gl_FragCoord.xy+po)/ur)*2.0-1.0;vec3 rayDir=normalize(pixelPos.x*camR*LEN+pixelPos.y*camU*LEN+camF);vec3 focalPoint=uFD*rayDir;float randomAngle=rng()*TWO_PI;float randomRadius=rng()*uAS;vec3 rap=(cos(randomAngle)*camR+sin(randomAngle)*camU)*sqrt(randomRadius);vec3 finalRayDir=normalize(focalPoint-rap);ro=camP+rap;rd=finalRayDir;cp+=vec4(vec3(RT()),0.0);seed*=uvec2(3);vec4 pp=texelFetch(tPreviousTexture,ivec2(gl_FragCoord.xy),0);if(uFC==1.0){pp.rgb*=(1.0/uPSC)*0.5;cp.rgb*=0.5;}else if (uCIM){pp.rgb*=0.5;cp.rgb*=0.5;}if(cp.rgb==vec3(0.0)){cp.rgb=pp.rgb;pp.rgb*=0.5;cp.rgb*=0.5;}fragColor=vec4(pp.rgb+cp.rgb,1.01);}`;
const frag_output = `#version 300 es
precision highp float;precision highp int;precision highp sampler2D;precision highp sampler3D;out vec4 fragColor;uniform sampler2D tex;uniform float uSC;uniform float uOV;uniform vec2 ur;vec3 saturate(vec3 a){return clamp(a,0.0,1.0);}vec3 RTM(vec3 color){color *= 1.0;return saturate(color/(vec3(1.0)+color));}void main(){vec4 m25[25];vec2 xy=gl_FragCoord.xy;m25[0]=texelFetch(tex,ivec2(xy+vec2(-2,2)),0);m25[1]=texelFetch(tex,ivec2(xy+vec2(-1,2)),0);m25[2]=texelFetch(tex,ivec2(xy+vec2(0,2)),0);m25[3]=texelFetch(tex,ivec2(xy+vec2(1,2)),0);m25[4]=texelFetch(tex,ivec2(xy+vec2(2,2)),0);m25[5]=texelFetch(tex,ivec2(xy+vec2(-2,1)),0);m25[6]=texelFetch(tex,ivec2(xy+vec2(-1,1)),0);m25[7]=texelFetch(tex,ivec2(xy+vec2(0,1)),0);m25[8]=texelFetch(tex,ivec2(xy+vec2(1,1)),0);m25[9]=texelFetch(tex,ivec2(xy+vec2(2,1)),0);m25[10]=texelFetch(tex,ivec2(xy+vec2(-2,0)),0);m25[11]=texelFetch(tex,ivec2(xy+vec2(-1,0)),0);m25[12]=texelFetch(tex,ivec2(xy+vec2(0,0)),0);m25[13]=texelFetch(tex,ivec2(xy+vec2(1,0)),0);m25[14]=texelFetch(tex,ivec2(xy+vec2(2,0)),0);m25[15]=texelFetch(tex,ivec2(xy+vec2(-2,-1)),0);m25[16]=texelFetch(tex,ivec2(xy+vec2(-1,-1)),0);m25[17]=texelFetch(tex,ivec2(xy+vec2(0,-1)),0);m25[18]=texelFetch(tex,ivec2(xy+vec2(1,-1)),0);m25[19]=texelFetch(tex,ivec2(xy+vec2(2,-1)),0);m25[20]=texelFetch(tex,ivec2(xy+vec2(-2,-2)),0);m25[21]=texelFetch(tex,ivec2(xy+vec2(-1,-2)),0);m25[22]=texelFetch(tex,ivec2(xy+vec2(0,-2)),0);m25[23]=texelFetch(tex,ivec2(xy+vec2(1,-2)),0);m25[24]=texelFetch(tex,ivec2(xy+vec2(2,-2)),0);vec4 cp=m25[12];vec3 fpc;vec3 epc;float th=1.0;int c=1;fpc=m25[12].rgb;if(m25[11].a<th){fpc+=m25[11].rgb;c++;if(m25[10].a<th){fpc+=m25[10].rgb;c++;}if(m25[5].a<th){fpc+=m25[5].rgb;c++;}}if(m25[13].a<th){fpc+=m25[13].rgb;c++;if(m25[14].a<th){fpc+=m25[14].rgb;c++;}if(m25[19].a<th){fpc+=m25[19].rgb;c++;}}if(m25[7].a<th){fpc+=m25[7].rgb;c++;if(m25[2].a<th){fpc += m25[2].rgb;c++;}if(m25[3].a<th){fpc+=m25[3].rgb;c++;}}if(m25[17].a<th){fpc+=m25[17].rgb;c++;
		if (m25[22].a < th){
			fpc += m25[22].rgb;
			c++;
		}
		if (m25[21].a < th)
		{
			fpc += m25[21].rgb;
			c++;
		}
	}
	if (m25[6].a < th)
	{
		fpc += m25[6].rgb;
		c++;
		if (m25[0].a < th)
		{
			fpc += m25[0].rgb;
			c++;
		}
		if (m25[1].a < th)
		{
			fpc += m25[1].rgb;
			c++;
		}
	}
	if (m25[8].a < th)
	{
		fpc += m25[8].rgb;
		c++;
		if (m25[4].a < th)
		{
			fpc += m25[4].rgb;
			c++;
		}
		if (m25[9].a < th)
		{
			fpc += m25[9].rgb;
			c++;
		}
	}
	if (m25[16].a < th)
	{
		fpc += m25[16].rgb;
		c++;
		if (m25[15].a < th)
		{
			fpc += m25[15].rgb;
			c++;
		}
		if (m25[20].a < th)
		{
			fpc += m25[20].rgb;
			c++;
		}
	}
	if (m25[18].a < th)
	{
		fpc += m25[18].rgb;
		c++;
		if (m25[23].a < th)
		{
			fpc += m25[23].rgb;
			c++;
		}
		if (m25[24].a < th)
		{
			fpc += m25[24].rgb;
			c++;
		}
	}
	fpc *= (1.0 / float(c));
	vec4 m9[9];
	m9[0] = m25[6];
	m9[1] = m25[7];
	m9[2] = m25[8];
	m9[3] = m25[11];
	m9[4] = m25[12];
	m9[5] = m25[13];
	m9[6] = m25[16];
	m9[7] = m25[17];
	m9[8] = m25[18];
	if (cp.a > 1.0)
	{
		cp = m9[4];
		c = 1;
		epc = m9[4].rgb;
		if (m9[3].a > 1.0)
		{
			epc += m9[3].rgb;
			c++;
		}
		if (m9[5].a > 1.0)
		{
			epc += m9[5].rgb;
			c++;
		}
		if (m9[1].a > 1.0)
		{
			epc += m9[1].rgb;
			c++;
		}
		if (m9[7].a > 1.0)
		{
			epc += m9[7].rgb;
			c++;
		}
		if (m9[0].a > 1.0)
		{
			epc += m9[0].rgb;
			c++;
		}
		if (m9[2].a > 1.0)
		{
			epc += m9[2].rgb;
			c++;
		}
		if (m9[6].a > 1.0)
		{
			epc += m9[6].rgb;
			c++;
		}
		if (m9[8].a > 1.0)
		{
			epc += m9[8].rgb;
			c++;
		}
		epc /= float(c);
	}
	if (uSC > 1.0) {
    			if (cp.a > 1.0) {
    					fpc = mix(epc, cp.rgb, clamp(uSC * 0.05, 0.0, 1.0));
    			}
	}
	else if (cp.a > 1.0) {
			   fpc = mix(fpc, cp.rgb, 0.5);
	}
	fpc *= uOV;
	fpc = RTM(fpc);
  fpc.r=pow(fpc.r,0.9);
  fpc.g=pow(fpc.g,0.95);
  fpc.b=pow(fpc.b,1.1);
  fragColor=vec4(sqrt(fpc),1.0);
}
`;
var S_W,S_H,context,container,stats,controls,rts,cps,pps,rtu,cpu,ppu,commonVert,rtfs,cfs,ppfs,rtg,rtm,rtq,cpg,cpm,cpq,ppg,ppm,ppq,rtrt,cprt,qc,wc,renderer,clock,elapsedTime,oldYaw,oldPitch,plc,cdv,crv,cuv,cc,yaw,pitch,canvas,cie,PI_2=Math.PI/2,camHeight=1,aperture=0,focus=1,pixelRatio=1,keyLPressedOnce=!1,wbr=!1,sampleCounter=0,frc=1,cim=!1,crm=!1,isPaused=!0,needsColorSwitch=!1,disableSwitching=!1,atep=!0;const buffers=new WeakMap;var _id$1=0,programIdCount=0;let properties=new WeakMap,_textureId=0;const mat4array=new Float32Array(16),RePathPart=/(\w+)(\])?(\[|\.)?/g;class O3D{constructor(){this.parent=null,this.children=[];var e=new V3;const t=new Euler,r=new Quat;var a=new V3(1,1,1);t._onChange(function(){r.setFromEuler(t)}),Object.defineProperties(this,{position:{value:e},rotation:{value:t},quat:{value:r},scale:{value:a}}),this.matrix=new Matrix4,this.matrixWorld=new Matrix4}add(e){(e.parent=this).children.push(e)}uMW(){this.matrix.compose(this.position,this.quat,this.scale),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix);var r=this.children;for(let e=0,t=r.length;e<t;e++)r[e].uMW()}}const updateUniforms=()=>{cim||(sampleCounter+=1,frc+=1,crm=!1),cim&&(frc+=1,crm||(rtu.uPSC.value=sampleCounter,frc=1,crm=!0),sampleCounter=1),rtu.uCIM.value=cim,rtu.uSC.value=sampleCounter,rtu.uFC.value=frc,rtu.uAS.value=aperture,rtu.uFD.value=focus,cc.uMW(),wc.uMW(),rtu.uCam.value.copy(wc.matrixWorld),ppu.uSC.value=sampleCounter,ppu.uOV.value=1/sampleCounter},moveCamera=(e,t)=>{0<t?cc.position.add(e.multiplyScalar(.082)):cc.position.sub(e.multiplyScalar(.082)),cim=!0,cc.position.x=Math.max(.5,Math.min(24.5,cc.position.x)),cc.position.y=camHeight,cc.position.z=Math.max(.5,Math.min(24.5,cc.position.z)),disableSwitching||0<cc.position.x&&cc.position.x<2&&0<cc.position.z&&cc.position.z<2&&(disableSwitching=needsColorSwitch=!0)},updateInput=()=>{isPaused||(keyPressed("KeyW")&&!keyPressed("KeyS")&&moveCamera(cdv,1),keyPressed("KeyS")&&!keyPressed("KeyW")&&moveCamera(cdv,-1),keyPressed("KeyA")&&!keyPressed("KeyD")&&moveCamera(crv,-1),keyPressed("KeyD")&&!keyPressed("KeyA")&&moveCamera(crv,1),keyPressed("KeyL")&&!keyLPressedOnce&&(camHeight=3<++camHeight?1:camHeight,keyLPressedOnce=!0),keyPressed("ArrowRight")&&(cim=!0,.1<(aperture+=.001))&&(aperture=0),keyPressed("ArrowLeft")&&(cim=!0,(aperture-=.001)<0)&&(aperture=0),keyPressed("ArrowUp")&&(cim=!0,24<(focus+=.5))&&(focus=1),keyPressed("ArrowDown")&&(cim=!0,(focus-=.5)<1)&&(focus=1))};var Controls=function(e){e.rotation.set(0,0,0);var t,r,a,i=new O3D,n=(i.add(e),new O3D),s=(n.add(i),0),o=0;document.addEventListener("mousemove",function(e){isPaused||(s=e.movementX||e.mozMovementX||0,o=e.movementY||e.mozMovementY||0,n.rotation.y-=.0012*s,i.rotation.x-=.001*o,i.rotation.x=Math.max(-PI_2,Math.min(PI_2,i.rotation.x)))},!1),this.getObject=function(){return n},this.getYawObject=function(){return n},this.getPitchObject=function(){return i},this.getDir=(t=i.matrixWorld.elements,function(e){return e.set(t[8],t[9],t[10]).negate(),e}),this.gUV=(r=i.matrixWorld.elements,function(e){return e.set(r[4],r[5],r[6]),e}),this.gRV=(a=i.matrixWorld.elements,function(e){return e.set(a[0],a[1],a[2]),e})};const KeySt={KeyA:!1,KeyD:!1,KeyL:!1,KeyP:!1,KeyS:!1,KeyW:!1,ArrowLeft:!1,ArrowUp:!1,ArrowRight:!1,ArrowDown:!1},onKeyDown=e=>{e.preventDefault(),KeySt[e.code]=!0},onKeyUp=e=>{e.preventDefault(),KeySt[e.code]=!1,keyLPressedOnce=!1},keyPressed=e=>KeySt[e];function setValueV1f(e,t){var r=this.cache;r[0]!==t&&(e.uniform1f(this.addr,t),r[0]=t)}function setValueV2f(e,t){var r=this.cache;r[0]===t.x&&r[1]===t.y||(e.uniform2f(this.addr,t.x,t.y),r[0]=t.x,r[1]=t.y)}function setValueV3f(e,t){var r=this.cache;r[0]===t.x&&r[1]===t.y&&r[2]===t.z||(e.uniform3f(this.addr,t.x,t.y,t.z),r[0]=t.x,r[1]=t.y,r[2]=t.z)}function setValueMatrix4(e,t){this.cache;t=t.elements;mat4array.set(t),e.uniformMatrix4fv(this.addr,!1,mat4array)}function setValueV1i(e,t){var r=this.cache;r[0]!==t&&(e.uniform1i(this.addr,t),r[0]=t)}function setValueT1(e,t,r){var a=this.cache,i=r.atu();a[0]!==i&&(e.uniform1i(this.addr,i),a[0]=i),r.setTexture2D(t,i)}function setValueT3D1(e,t,r){var a=this.cache,i=r.atu();a[0]!==i&&(e.uniform1i(this.addr,i),a[0]=i),r.setTexture3D(t,i)}const gSS=e=>{switch(e){case 5126:return setValueV1f;case 35664:return setValueV2f;case 35665:return setValueV3f;case 35676:return setValueMatrix4;case 35670:return setValueV1i;case 35678:return setValueT1;case 35679:return setValueT3D1}},addUniform=(e,t)=>{e.seq.push(t),e.map[t.id]=t},parseUniform=(e,t,r)=>{var a=e.name,a=(RePathPart.lastIndex=0,RePathPart.exec(a));addUniform(r,new SU(a[1],e,t))};class SU{constructor(e,t,r){this.id=e,this.addr=r,this.cache=[],this.type=t.type,this.setValue=gSS(t.type)}}class UM{constructor(t,r){this.seq=[],this.map={};var a=t.getProgramParameter(r,t.ACTIVE_UNIFORMS);for(let e=0;e<a;e++){var i=t.getActiveUniform(r,e),n=t.getUniformLocation(r,i.name);parseUniform(i,n,this)}}setValue(e,t,r,a){t=this.map[t];void 0!==t&&t.setValue(e,r,a)}static upload(r,a,i,n){for(let e=0,t=a.length;e!==t;e++){var s=a[e],o=i[s.id];!1!==o.needsUpdate&&s.setValue(r,o.value,n)}}static seqWithValue(r,a){var i=[];for(let e=0,t=r.length;e!==t;e++){var n=r[e];n.id in a&&i.push(n)}return i}}function TM(n,s){let t=0,o=null,c={};function u(e,t,r){void 0===r&&(r=null===o?n.TEXTURE0+31:o);let a=c[r];void 0===a&&(a={type:void 0,texture:void 0},c[r]=a),a.type===e&&a.texture===t||(o!==r&&(n.activeTexture(r),o=r),n.bindTexture(e,t),a.type=e,a.texture=t)}this.atu=function(){var e=t;return t+=1,e},this.rtxu=function(){t=0},this.setTexture2D=function(e,t){u(n.TEXTURE_2D,s.get(e).__webglTexture,n.TEXTURE0+t)},this.setTexture3D=function(e,t){var r,a,i=s.get(e);0<e.version&&i.__version!==e.version&&(i=i,e=e,t=t,a=n.TEXTURE_3D,i.__webglTexture=n.createTexture(),u(a,i.__webglTexture,n.TEXTURE0+t),void 0===(r=n.TEXTURE0+t)&&(r=n.TEXTURE0+31),o!==r&&(n.activeTexture(r),o=r),t=e.image,n.texParameteri(a,n.TEXTURE_WRAP_S,33071),n.texParameteri(a,n.TEXTURE_WRAP_T,33071),n.texParameteri(a,n.TEXTURE_MAG_FILTER,9728),n.texParameteri(a,n.TEXTURE_MIN_FILTER,9728),function(){n.texStorage3D.apply(n,arguments)}(n.TEXTURE_3D,1,34836,t.width,t.height,t.depth),function(){n.texSubImage3D.apply(n,arguments)}(n.TEXTURE_3D,0,0,0,0,t.width,t.height,t.depth,6408,5126,t.data),i.__version=e.version)},this.setupRenderTarget=function(e){var t=e.texture,r=s.get(e),a=s.get(t),i=(void 0===a.__webglTexture&&(a.__webglTexture=n.createTexture()),a.__version=t.version,r.__webglFramebuffer=n.createFramebuffer(),n.TEXTURE_2D);u(i,a.__webglTexture),n.texParameteri(i,n.TEXTURE_WRAP_S,33071),n.texParameteri(i,n.TEXTURE_WRAP_T,33071),n.texParameteri(i,n.TEXTURE_MAG_FILTER,9728),n.texParameteri(i,n.TEXTURE_MIN_FILTER,9728),function(){n.texImage2D.apply(n,arguments)}(n.TEXTURE_2D,0,34836,e.width,e.height,0,6408,5126,null),n.bindFramebuffer(n.FRAMEBUFFER,r.__webglFramebuffer),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,i,s.get(t).__webglTexture,0),n.bindFramebuffer(n.FRAMEBUFFER,null),n.bindTexture(c[o].type,null)}}class Texture{constructor(e,t,r,a,i,n,s,o){this.isTexture=!0,Object.defineProperty(this,"id",{value:_textureId++}),this.source={data:e,dataReady:!0},this.wrapS=r,this.wrapT=a,this.magFilter=i,this.minFilter=n,this.format=s,this.internalFormat=null,this.type=o,this.version=0}get image(){return this.source.data}set image(e=null){this.source.data=e}set needsUpdate(e){!0===e&&this.version++}}Texture.DEFAULT_IMAGE=null;class SQ extends O3D{constructor(e,t){super(),this.isQuad=!0,this.geometry=e,this.mat=t}}class SeededRandom{constructor(e){this.seed=e}random(){var e=1e4*Math.sin(this.seed++);return e-Math.floor(e)}}class RenderTarget{constructor(e,t){this.width=e,this.height=t,this.viewport={x:0,y:0,z:e,w:t},this.textures=[new Texture({width:e,height:t},null,null,null,1003,1003,1023,1015)]}get texture(){return this.textures[0]}setSize(e,t){this.width=e,this.height=t,this.viewport={x:0,y:0,z:e,w:t}}}class Renderer{constructor(e){var{canvas:e,context:t}=e;this.canvas=e,this.context=t,this.crl=[],this.domElement=e,this.currentProgram=null,this._width=e.width,this._height=e.height,this._pixelRatio=1,this._gl=t,this.properties=new PM,this.textures=new TM(this._gl,this.properties),this.attr=new AttrMgr(this._gl),this.programCache=new PMgr(this)}getContext(){return this._gl}sPR(e){this._pixelRatio=e,this.setSize(this._width,this._height)}setSize(e,t){this._width=e,this._height=t,this.canvas.width=Math.floor(e*this._pixelRatio),this.canvas.height=Math.floor(t*this._pixelRatio),this.canvas.style.width=e+"px",this.canvas.style.height=t+"px",this._gl.viewport(0,0,e,t)}rbd(e,t,r,a,i){this.setProgram(e,t,r,a,i),this._gl.bindVertexArray(this._gl.createVertexArray()),this.attr.update(r.index,this._gl.ELEMENT_ARRAY_BUFFER);e=this.attr.get(r.attr.position);this._gl.enableVertexAttribArray(0),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,e.buffer),this._gl.vertexAttribPointer(0,3,5126,!1,12,0),this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,this.attr.get(r.index).buffer),this._gl.drawElements(4,6,5123,0)}render(e,t){this.proj(e,t),this.rObj(this.crl,e,t),this.crl=[]}proj(e,r){if(e.isQuad){var t=e.geometry.attr;for(const i in t)this.attr.update(t[i],this._gl.ARRAY_BUFFER);this.crl.push({object:e,geometry:e.geometry,mat:e.mat})}var a=e.children;for(let e=0,t=a.length;e<t;e++)this.proj(a[e],r)}rObj(r,a,i){for(let e=0,t=r.length;e<t;e++){var n=r[e];this.rbd(i,a,n.geometry,n.mat,n.object)}}gUL(e){var t;return null===e.uniformsList&&(t=e.currentProgram.getUniforms(),e.uniformsList=UM.seqWithValue(t.seq,e.uniforms)),e.uniformsList}getProgram(e,t,r){var a=this.properties.get(e),t=this.programCache.getParameters(e,t,r),r=this.programCache.getProgramCacheKey(t),i=new Map,t=((a.programs=i).get(r),this.programCache.acqu(t,r));return i.set(r,t),a.uniforms=e.uniforms,a.currentProgram=t,a.uniformsList=null,t}useProgram(e){return this.currentProgram!==e&&(this._gl.useProgram(e),this.currentProgram=e,!0)}setProgram(e,t,r,a,i){this.textures.rtxu();var n=this.properties.get(a);let s=!1,o=(a.version!==n.__version&&(s=!0,n.__version=a.version),n.currentProgram);s&&(o=this.getProgram(a,t,i));a=n.uniforms;return this.useProgram(o.program),UM.upload(this._gl,this.gUL(n),a,this.textures),o}sRT(e){let t=null;e&&(this.textures.setupRenderTarget(e),t=this.properties.get(e).__webglFramebuffer),this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,t)}}class PM{get(e){let t=properties.get(e);return void 0===t&&(t={},properties.set(e,t)),t}update(e,t,r){properties.get(e)[t]=r}}class ShaderCache{constructor(){this.shaderCache=new Map}getFragID(e){return this._getSS(e.frag).id}_getSS(e){var t=this.shaderCache;let r=t.get(e);return void 0===r&&(r=new SS(e),t.set(e,r)),r}}class SS{constructor(e){this.id=_id$1++}}function WebGLShader(e,t,r){t=e.createShader(t);return e.shaderSource(t,r),e.compileShader(t),t}function WebGLProgram(e,t,r){const a=e.getContext(),i=a.createProgram(),n=WebGLShader(a,a.VERTEX_SHADER,r.vert),s=WebGLShader(a,a.FRAGMENT_SHADER,r.frag);a.attachShader(i,n),a.attachShader(i,s),a.linkProgram(i);let o;return this.getUniforms=function(){return void 0===o&&(a.deleteShader(n),a.deleteShader(s),o=new UM(a,i)),o},this.id=programIdCount++,this.cacheKey=t,this.program=i,this.vert=n,this.frag=s,this}function PMgr(t){const i=new ShaderCache,n=[];return{getParameters:function(e,t,r){var a=i.getFragID(e);return{vert:e.vert,frag:e.frag,cfid:a}},getProgramCacheKey:function(e){return[e.cfid]},acqu:function(e,r){let a;for(let e=0,t=n.length;e<t;e++){var i=n[e];if(i.cacheKey===r){a=i;break}}return void 0===a&&(a=new WebGLProgram(t,r,e),n.push(a)),a},programs:n}}class BA{constructor(e,t){this.array=e,this.itemSize=t,this.usage=35044}}class AttrMgr{constructor(e){this.gl=e}createBuffer(e,t){var r=e.array,a=e.usage,i=r.byteLength,n=this.gl.createBuffer();return this.gl.bindBuffer(t,n),this.gl.bufferData(t,r,a),{buffer:n,type:r instanceof Float32Array?this.gl.FLOAT:this.gl.UNSIGNED_SHORT,bytesPerElement:r.BYTES_PER_ELEMENT,version:e.version,size:i}}get(e){return buffers.get(e)}update(e,t){void 0===buffers.get(e)&&buffers.set(e,this.createBuffer(e,t))}}class Euler{constructor(){this._x=0,this._y=0,this._z=0,this._order="XYZ"}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}set order(e){this._order=e,this._onChangeCallback()}set(e,t,r,a=this._order){return this._x=e,this._y=t,this._z=r,this._order=a,this._onChangeCallback(),this}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}}class Matrix4{constructor(e,t,r,a,i,n,s,o,c,u,h,l,d,m,g,p){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}copy(e){var t=this.elements,e=e.elements;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this}multiplyMatrices(e,t){var e=e.elements,t=t.elements,r=this.elements,a=e[0],i=e[4],n=e[8],s=e[12],o=e[1],c=e[5],u=e[9],h=e[13],l=e[2],d=e[6],m=e[10],g=e[14],p=e[3],f=e[7],y=e[11],e=e[15],x=t[0],v=t[4],T=t[8],w=t[12],_=t[1],b=t[5],S=t[9],E=t[13],R=t[2],P=t[6],C=t[10],M=t[14],U=t[3],F=t[7],D=t[11],t=t[15];return r[0]=a*x+i*_+n*R+s*U,r[4]=a*v+i*b+n*P+s*F,r[8]=a*T+i*S+n*C+s*D,r[12]=a*w+i*E+n*M+s*t,r[1]=o*x+c*_+u*R+h*U,r[5]=o*v+c*b+u*P+h*F,r[9]=o*T+c*S+u*C+h*D,r[13]=o*w+c*E+u*M+h*t,r[2]=l*x+d*_+m*R+g*U,r[6]=l*v+d*b+m*P+g*F,r[10]=l*T+d*S+m*C+g*D,r[14]=l*w+d*E+m*M+g*t,r[3]=p*x+f*_+y*R+e*U,r[7]=p*v+f*b+y*P+e*F,r[11]=p*T+f*S+y*C+e*D,r[15]=p*w+f*E+y*M+e*t,this}compose(e,t,r){var a=this.elements,i=t._x,n=t._y,s=t._z,t=t._w,o=i+i,c=n+n,u=s+s,h=i*o,l=i*c,i=i*u,d=n*c,n=n*u,s=s*u,o=t*o,c=t*c,t=t*u,u=r.x,m=r.y,r=r.z;return a[0]=(1-(d+s))*u,a[1]=(l+t)*u,a[2]=(i-c)*u,a[3]=0,a[4]=(l-t)*m,a[5]=(1-(h+s))*m,a[6]=(n+o)*m,a[7]=0,a[8]=(i+c)*r,a[9]=(n-o)*r,a[10]=(1-(h+d))*r,a[11]=0,a[12]=e.x,a[13]=e.y,a[14]=e.z,a[15]=1,this}}class Quat{constructor(e=0,t=0,r=0,a=1){this._x=e,this._y=t,this._z=r,this._w=a}get x(){return this._x}get y(){return this._y}get z(){return this._z}get w(){return this._w}set(e,t,r,a){return this._x=e,this._y=t,this._z=r,this._w=a,this}setFromEuler(e){var t=e._x,r=e._y,e=e._z,a=Math.cos,i=Math.sin,n=a(t/2),s=a(r/2),a=a(e/2),t=i(t/2),r=i(r/2),i=i(e/2);return this._x=t*s*a+n*r*i,this._y=n*r*a-t*s*i,this._z=n*s*i+t*r*a,this._w=n*s*a-t*r*i,this}}class V3{constructor(e=0,t=0,r=0){this.x=e,this.y=t,this.z=r}set(e,t,r){return this.x=e,this.y=t,this.z=r,this}clone(){return new this.constructor(this.x,this.y,this.z)}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}divideScalar(e){return this.multiplyScalar(1/e)}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}normalize(){return this.divideScalar(this.length()||1)}}class PG{constructor(){this.index=new BA(new Uint16Array([0,2,1,2,3,1]),1),this.attr={position:new BA(new Float32Array([-1,1,0,1,1,0,-1,-1,0,1,-1,0]),3)}}}class D3D extends Texture{constructor(e,t,r,a){super(null),this.image={data:e,width:t,height:r,depth:a},this.magFilter=1003,this.minFilter=1003,this.wrapR=1001}}const getSizes=(e,t)=>{e=Math.min(e,t);return{small:Math.floor(.5*e),medium:Math.floor(.75*e),large:Math.floor(.99*e)}},checkScreenSize=()=>window.innerWidth<700?(document.getElementById("content").style.display="none",!(document.getElementById("mobileWarning").style.display="flex")):(document.getElementById("content").style.display="block",document.getElementById("mobileWarning").style.display="none",!0),checkWebGL2=()=>!(!document.createElement("canvas").getContext("webgl2")&&(document.getElementById("content").style.display="none",document.getElementById("webglWarning").style.display="flex")),startGame=()=>{var e=document.getElementById("dropdown").value.split("x")[0];document.getElementById("content").remove(),(canvas=document.createElement("canvas")).id="container",canvas.width=e,canvas.height=e,canvas.style.backgroundColor="black",canvas.style.position="absolute",canvas.style.top="50%",canvas.style.left="50%",canvas.style.transform="translate(-50%, -50%)",document.body.appendChild(canvas),S_W=parseInt(canvas.width),S_H=parseInt(canvas.height),init()},textureWidth=(window.onload=()=>{if(checkScreenSize()&&checkWebGL2()){var e,t,r=getSizes(window.innerWidth,window.innerHeight),a=document.getElementById("dropdown");a.innerHTML="";for([e,t]of Object.entries(r)){var i=document.createElement("option");i.value=t,i.textContent=`${e.charAt(0).toUpperCase()+e.slice(1)}: ${t}x`+t,a.appendChild(i)}}},window.startGame=startGame,cdv=new V3,crv=new V3,cuv=new V3,250),textureHeight=3,textureDepth=250,loadTexture=()=>{var a,i=new Float32Array(textureWidth*textureHeight*textureDepth*4),n=new SeededRandom(1),s=[{o:1},{o:0},{o:0},{o:0}],o=[{r:255,g:105,b:180},{r:255,g:90,b:147},{r:255,g:172,b:190}];for(let r=0;r<textureDepth;r++)for(let t=0;t<textureHeight;t++)for(let e=0;e<textureWidth;e++)0!==s[Math.floor(4*n.random())].o&&(a=o[Math.floor(3*n.random())],setVoxel(i,[e,t,r],[a.r/255,a.g/255,a.b/255]));var e=new D3D(i,textureWidth,textureHeight,textureDepth);return e.format=1023,e.type=1015,e.minFilter=1003,e.magFilter=1003,e.needsUpdate=!0,e},setVoxel=(e,t,r)=>{t=4*(t[2]*textureDepth*textureHeight+t[1]*textureWidth+t[0]);e[t]=r[0],e[1+t]=r[1],e[2+t]=r[2],e[3+t]=1},onWindowResize=e=>{wbr=!0,renderer.sPR(pixelRatio),renderer.setSize(S_W,S_H),rtu.ur.value.x=context.drawingBufferWidth,rtu.ur.value.y=context.drawingBufferHeight,ppu.ur.value.x=context.drawingBufferWidth,ppu.ur.value.y=context.drawingBufferHeight,rtrt.setSize(context.drawingBufferWidth,context.drawingBufferHeight),cprt.setSize(context.drawingBufferWidth,context.drawingBufferHeight)},init=()=>{window.addEventListener("resize",onWindowResize,!1),document.body.addEventListener("click",function(e){atep&&(this.requestPointerLock=this.requestPointerLock||this.mozRequestPointerLock,this.requestPointerLock())},!1),plc=function(e){isPaused=document.pointerLockElement===document.body||document.mozPointerLockElement===document.body?(document.addEventListener("keydown",onKeyDown,!1),document.addEventListener("keyup",onKeyUp,!1),!1):(document.removeEventListener("keydown",onKeyDown,!1),document.removeEventListener("keyup",onKeyUp,!1),!0)},document.addEventListener("pointerlockchange",plc,!1),document.addEventListener("mozpointerlockchange",plc,!1),igc()},igc=()=>{renderer=new Renderer({canvas:canvas,context:canvas.getContext("webgl2")}),(context=renderer.getContext()).getExtension("EXT_color_buffer_float"),cie=document.getElementById("cameraInfo"),rts=new O3D,cps=new O3D,pps=new O3D,qc=new O3D,cps.add(qc),pps.add(qc),wc=new O3D,rts.add(wc),controls=new Controls(wc),cc=controls.getObject(),yaw=controls.getYawObject(),pitch=controls.getPitchObject(),rts.add(cc),rtrt=new RenderTarget(context.drawingBufferWidth,context.drawingBufferHeight),cprt=new RenderTarget(context.drawingBufferWidth,context.drawingBufferHeight),cc.position.set(4,camHeight,13),focus=1,aperture=0,rtg=new PG,rtu={tPreviousTexture:{value:cprt.texture},uCam:{type:"m4",value:new Matrix4},ur:{type:"v2",value:{x:0,y:0}},uSC:{type:"f",value:0},uPSC:{type:"f",value:1},uFC:{type:"f",value:1},uAS:{type:"f",value:aperture},uFD:{type:"f",value:focus},uCIM:{type:"b1",value:!1}};var e=loadTexture();rtu.uVx={value:e},commonVert=vert,rtfs=frag_input,rtm={version:0,uniforms:rtu,vert:commonVert,frag:rtfs},rtq=new SQ(rtg,rtm),rts.add(rtq),wc.add(rtq),cpg=new PG,cpu={tex:{value:rtrt.texture}},setTimeout(function(){cfs=copy,cpm={version:0,uniforms:cpu,vert:commonVert,frag:cfs},cpq=new SQ(cpg,cpm),cps.add(cpq)},1e3),ppg=new PG,ppu={tex:{value:rtrt.texture},uSC:{type:"f",value:0},uOV:{type:"f",value:0},ur:{type:"v2",value:{x:0,y:0}}},setTimeout(function(){ppfs=frag_output,ppm={version:0,uniforms:ppu,vert:commonVert,frag:ppfs},ppq=new SQ(ppg,ppm),pps.add(ppq)},1e3),onWindowResize(),gameLoop()},gameLoop=()=>{cim=!1,wbr=wbr&&!(cim=!0),oldYaw==yaw.rotation.y&&oldPitch==pitch.rotation.x||(cim=!0),oldYaw=yaw.rotation.y,oldPitch=pitch.rotation.x,controls.getDir(cdv),cdv.normalize(),controls.gUV(cuv),cuv.normalize(),controls.gRV(crv),crv.normalize(),updateInput(),updateUniforms(),cie.innerHTML=0==aperture?"Depth of Field: OFF":"Aperture: "+aperture.toFixed(3)+"<br><br> Focus: "+focus,renderer.sRT(rtrt),renderer.render(rts,wc),renderer.sRT(cprt),renderer.render(cps,qc),renderer.sRT(null),renderer.render(pps,qc),requestAnimationFrame(gameLoop)};
