<!doctype html><html style=height:100%><meta content="width=device-width" name=viewport><title>Digicrush - js13kGames 2020</title><body style=height:100%;margin:auto;max-width:800px;background:#222><br><br><canvas height=400 id=wgl style="border:1px solid #626262;background:#111" width=800></canvas><canvas height=16384 id=tex style=display:none width=256></canvas><div style=color:#fff;font-size:16pt><p>The system in cyber space is being attacked. Stop the attack by crushing the digits in the incoming stream. Duplicate digits can be eliminated.<p>Press 1-6 to pick the digit to eliminate.<p>Consecutive digits can be fused into bombs:<div style=margin-left:2rem>3-digit bomb, 4-digit bomb, and the 404 super-bomb.</div><p><p></div><script>console,console.assert;const K={len:t=>Math.sqrt(t[0]*t[0]+t[1]*t[1]),unit:t=>{var e=K.len(t);return 1e-6<e?[t[0]/e,t[1]/e]:[0,0]},normal:t=>{var e=K.len(t);return 1e-6<e?[-t[1]/e,t[0]/e]:[0,0]},rad:t=>Math.atan2(t[1],t[0]),from_rad:t=>[Math.cos(t),Math.sin(t)],add:(t,e)=>[t[0]+e[0],t[1]+e[1]],sub:(t,e)=>[t[0]-e[0],t[1]-e[1]],scale:(t,e)=>[t[0]*e,t[1]*e],dot:(t,e)=>t[0]*e[0]+t[1]*e[1],rad_to_deg:t=>180*t/Math.PI,deg_to_rad:t=>t*Math.PI/180,unit_deg:t=>t%360},a={len:t=>Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),unit:t=>{var e=a.len(t);return 1e-6<e?[t[0]/e,t[1]/e,t[2]/e]:[0,0,0]},normal:t=>{var e=a.len(t);return 1e-6<e?[-t[1]/e,t[0]/e,t[2]/e]:[0,0,0]},add:(t,e)=>[t[0]+e[0],t[1]+e[1],t[2]+e[2]],sub:(t,e)=>[t[0]-e[0],t[1]-e[1],t[2]-e[2]],scale:(t,e)=>[t[0]*e,t[1]*e,t[2]*e],dot:(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2],cross:(t,e)=>[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]],addTo:(t,e)=>(t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t),setTo:(t,e)=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t),subFrom:(t,e)=>(t[0]-=e[0],t[1]-=e[1],t[2]-=e[2],t),scaleTo:(t,e)=>(t[0]*=e,t[1]*=e,t[2]*=e,t)},V=(t,e)=>{var s=t[0],i=t[1],a=t[2],r=t[3],o=t[4],h=t[5],n=t[6],_=t[7],l=t[8],c=t[9],f=t[10],p=t[11],u=t[12],d=t[13],g=t[14],m=e[0],v=e[1],E=e[2],T=e[3],A=e[4],S=e[5],O=e[6],y=e[7],I=e[8],w=e[9],B=e[10],F=e[11],x=e[12],P=e[13],b=e[14];return[m*s+v*o+E*l+T*u,m*i+v*h+E*c+T*d,m*a+v*n+E*f+T*g,m*r+v*_+E*p+T*(t=t[15]),A*s+S*o+O*l+y*u,A*i+S*h+O*c+y*d,A*a+S*n+O*f+y*g,A*r+S*_+O*p+y*t,I*s+w*o+B*l+F*u,I*i+w*h+B*c+F*d,I*a+w*n+B*f+F*g,I*r+w*_+B*p+F*t,x*s+P*o+b*l+(e=e[15])*u,x*i+P*h+b*c+e*d,x*a+P*n+b*f+e*g,x*r+P*_+b*p+e*t]},s=Math.sin,i=Math.cos,q={scale:(t,e,s,i)=>V(t,q.scale_mat(e,s,i)),translate:(t,e,s,i)=>V(t,q.trans_mat(e,s,i)),rotatex:(t,e)=>V(t,q.rot_x_mat(e)),rotatey:(t,e)=>V(t,q.rot_y_mat(e)),rotatez:(t,e)=>V(t,q.rot_z_mat(e)),project_mat:(t,e,s)=>[2/t,0,0,0,0,-2/e,0,0,0,0,2/s,0,-1,1,0,1],orthographic_mat:(t,e,s,i,a,r)=>[2/(e-t),0,0,0,0,2/(i-s),0,0,0,0,2/(a-r),0,(t+e)/(t-e),(s+i)/(s-i),(a+r)/(a-r),1],perspective_mat:(t,e,s,i)=>[(t=Math.tan(.5*Math.PI-.5*t))/e,0,0,0,0,t,0,0,0,0,(s+i)/(s-i),-1,0,0,s*i/(s-i)*2,0],lookat_mat:(t,e,s)=>{e=a.unit(a.sub(t,e)),s=a.unit(a.cross(s,e));var i=a.unit(a.cross(e,s));return[s[0],s[1],s[2],0,i[0],i[1],i[2],0,e[0],e[1],e[2],0,t[0],t[1],t[2],1]},identity_mat:()=>[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],scale_mat:(t,e,s)=>[t,0,0,0,0,e,0,0,0,0,s,0,0,0,0,1],scale_set:(t,e)=>(t[0]=e[0],t[5]=e[1],t[10]=e[2],t),scale_set1:(t,e)=>(t[0]=e,t[5]=e,t[10]=e,t),trans_mat:(t,e,s)=>[1,0,0,0,0,1,0,0,0,0,1,0,t,e,s,1],trans_set:(t,e)=>(t[12]=e[0],t[13]=e[1],t[14]=e[2],t),rot_x_mat:t=>[1,0,0,0,0,i(t),s(t),0,0,-s(t),i(t),0,0,0,0,1],rot_x_set:(t,e)=>(t[5]=i(e),t[6]=s(e),t[9]=-s(e),t[10]=i(e),t),rot_y_mat:t=>[i(t),0,-s(t),0,0,1,0,0,s(t),0,i(t),0,0,0,0,1],rot_y_set:(t,e)=>(t[0]=i(e),t[2]=-s(e),t[8]=s(e),t[10]=i(e),t),rot_z_mat:t=>[i(t),s(t),0,0,-s(t),i(t),0,0,0,0,1,0,0,0,0,1],rot_z_set:(t,e)=>(t[0]=i(e),t[1]=s(e),t[4]=-s(e),t[5]=i(e),t),v4_multiply_m4:(s,i)=>{var a=[0,0,0,0];for(let e=0;e<4;++e)for(let t=0;t<4;++t)a[e]+=s[t]*i[4*t+e];return a}},n={},e=[],r=[];n.gen_rot_mats=()=>{for(let t=0;t<=360;t++)e.push(q.rot_x_mat(K.deg_to_rad(t))),r.push(q.rot_y_mat(K.deg_to_rad(t)))},n.xrot=t=>e[Math.floor(K.unit_deg(t)+360)%360],n.yrot=t=>r[Math.floor(K.unit_deg(t)+360)%360],n.gen_facing_view_mats=t=>{o=_(t)};let o=[],h=(n.gen_view_projection_mats=(t,e)=>{h=_(t,e)},[]);function _(k,D){var e,s,i,a,r,o,h,n,_,l,c,f,p,u,d,g,m,v,E,T,A,S,O,U,y,I,w,B,F,x,P,b,R,M,L,C,W=[],G=[0,0,0],H=[0,1,0];for(let t=0;t<=360;t++){var N=q.rot_y_mat(K.deg_to_rad(t)),X=(N=[(N=q.translate(N,k[0],k[1],k[2]))[12],N[13],N[14]],e=(N=q.lookat_mat(N,G,H))[0],I=N[1],s=N[2],i=N[3],o=N[6],h=N[7],_=N[9],c=N[11],p=N[14],y=(n=N[8])*(F=N[13]),w=(a=N[4])*F,B=(f=N[12])*(r=N[5]),x=n*r,P=e*F,b=f*I,M=n*I,L=e*r,C=a*I,[(r=1/(e*(X=(R=(l=N[10])*(N=N[15]))*r+(g=p*h)*_+(m=o*c)*F-((u=p*c)*r+(d=o*N)*_+(v=l*h)*F))+a*(Y=u*I+(E=s*N)*_+(S=l*i)*F-(R*I+(T=p*i)*_+(A=s*c)*F))+n*(F=d*I+T*r+(O=s*h)*F-(g*I+E*r+(U=o*i)*F))+f*(I=v*I+A*r+U*_-(m*I+S*r+O*_))))*X,r*Y,r*F,r*I,r*(u*a+d*n+v*f-(R*a+g*n+m*f)),r*(R*e+T*n+A*f-(u*e+E*n+S*f)),r*(g*e+E*a+U*f-(d*e+T*a+O*f)),r*(m*e+S*a+O*n-(v*e+A*a+U*n)),r*(y*h+B*c+(F=a*_)*N-((I=f*_)*h+w*c+x*N)),r*(I*i+P*c+M*N-(y*i+b*c+(R=e*_)*N)),r*(w*i+b*h+L*N-(B*i+P*h+C*N)),r*(x*i+R*h+C*c-(F*i+M*h+L*c)),r*(w*l+x*p+I*o-(F*p+y*o+B*l)),r*(R*p+y*s+b*l-(P*l+M*p+I*s)),r*(P*o+C*p+B*s-(L*p+w*s+b*o)),r*(L*l+F*s+M*o-(R*o+C*l+x*s))]),Y=D?V(D,X):X;W[t]=Y}return W}n.facing_view=t=>o[Math.floor(K.unit_deg(t)+360)%360],n.view_projection=t=>h[Math.floor(K.unit_deg(t)+360)%360];let l=(t,e)=>{let s=e||1;for(;s<t;)s*=2;return s},c=(t,e)=>Math.floor(Math.random()*(e-t+1))+t,f=function(){const e={};return e.chars="1234567890ABCDEFGHIJKLMNOPQRSTUVWXYZ@$* -!.......;.........;....".split(""),e.charIndex=e.chars.reduce((t,e,s)=>(t[e]=s,t),{}),e.digitBegin=0,e.digitLimit=5,e.digit0Limit=9,e.alphaBegin=10,e.F_ZERO=9,e.F_ROCK=36,e.F_CASH=37,e.F_WILDCARD=38,e.F_BLANK=39,e.numIndex=t=>0==t?e.F_ZERO:t-1,e.alphaIndex=t=>e.alphaBegin+(t.charCodeAt(0)-65),e.textIndices=t=>t.split("").map(t=>e.charIndex[t]),e.T_FLAG=0,e.T_ROCK=1,e.T_WILDCARD=2,e.T_BOMB3=3,e.T_BOMB4=4,e.T_FORT_O=5,e.T_FORT_I=6,e.T_FORT_I2=7,e.T_WCHAR=8,e.T_CHAR=9,e.T_404=10,e.SCALE=.25,e.BEGIN_X=6.5,e.LOSING_X=-3,e.PLAYING_ANGLE=-15,e.SPACE_BETWEEN=.6,e.WAVE_STRENGTH=.4,e.LIGHT_DIRECTION=a.unit([-2.5,.5,3]),e.POWER_ELEVATION=.5,e.BOMB3_RANGE=2,e.BOMB4_RANGE=4,e.FORT_O_X=-2.05,e.FORT_I_X=-2,e.FORT_O_SCALE=.125,e.FORT_I_SCALE=.1,e.CASH_X=-3.5,e.CASH_SCALE=.5,e.SCORE_X=4,e.SCORE_Y=3.4,e.SCORE_Z=-2.5,e.SCORE_W=.3,e.GOAL_X=2.5,e.LEVEL_X=1,e.LABEL_X=.5,e.POPUP_X=0,e.POPUP_Y=0,e.POPUP_Z=2.6,e.POPUP_W=.075,e.POPUP_N=14,e.makeFg=t=>{switch(t){case e.T_FLAG:return[0,0,1,1];case e.T_ROCK:return[1,1,.5,1];case e.T_BOMB3:case e.T_BOMB4:case e.T_404:return[1,1,1,1];case e.T_WCHAR:return[0,1,0,1];case e.T_CHAR:return[1,1,1,1];default:return[0,0,0,1]}},e.makeBg=t=>{switch(t){case e.T_FLAG:return[.5,1,0,1];case e.T_ROCK:return[.3961,.3255,.3255,1];case e.T_WILDCARD:return[.5,1,0,1];case e.T_BOMB3:return[.8,.8,.8,1];case e.T_BOMB4:case e.T_404:return[.9,.9,.9,1];case e.T_FORT_O:return[.8157,.8196,.8235,1];case e.T_FORT_I:return[.1765,.9765,.9765,1];case e.T_FORT_I2:return[1,1,1,1];case e.T_WCHAR:return[.9765,.6588,.2471,1];case e.T_CHAR:return[0,0,0,1];default:return[.5,1,0,1]}},e}(),p=function(){let i,a,t={},r=256,o=256;return t.setup=(t,e,s)=>{(i=document.getElementById(t)).width=l(i.width),i.height=l(i.height),r=e||256,o=s||256,(a=i.getContext("2d")).fillStyle="#333333",a.textAlign="center",a.textBaseline="middle",a.font="192px monospace"},t.drawGrid=()=>{for(let t=o;t<i.height;t+=o)a.beginPath(),a.moveTo(0,t),a.lineTo(r,t),a.stroke()},t.drawAt=(t,e)=>{e=o*(e-1)+192/1.4+2;var s=r/2*.98;a.fillText(t,s,e)},t.textureCanvas=()=>i,t.lineWidth=()=>r,t.lineHeight=()=>o,t}(),u=function(){const a={uploadToBuffer:(t,e,s,i)=>{var a=t.createBuffer();return s=s||t.ARRAY_BUFFER,i=i||t.STATIC_DRAW,t.bindBuffer(s,a),t.bufferData(s,e,i),a},assignBufferToAttr:(t,e,s,i,a,r,o,h)=>{t.bindBuffer(t.ARRAY_BUFFER,e),t.enableVertexAttribArray(s),t.vertexAttribPointer(s,i,a||t.FLOAT,r||!1,o||0,h||0)},assignDataToAttr:(t,e,s)=>{t.disableVertexAttribArray(e),t[i[s.length]](e,s)}};let i=[null,"vertexAttrib1fv","vertexAttrib2fv","vertexAttrib3fv","vertexAttrib4fv"];return a.loadShader=(t,e,s)=>(s=t.createShader(s),t.shaderSource(s,e),t.compileShader(s),s),a.createProgram=(t,e,s)=>{var i=t.createProgram();return t.attachShader(i,a.loadShader(t,e,t.VERTEX_SHADER)),t.attachShader(i,a.loadShader(t,s,t.FRAGMENT_SHADER)),t.linkProgram(i),i},a.getAttrMap=(s,i)=>{var t=s.getProgramParameter(i,s.ACTIVE_ATTRIBUTES);return[...Array(t).keys()].map(t=>s.getActiveAttrib(i,t)).map(t=>t.name).reduce((t,e)=>(t[e]=s.getAttribLocation(i,e),t),{})},a.getUniformMap=(i,a)=>{var t=i.getProgramParameter(a,i.ACTIVE_UNIFORMS);return[...Array(t).keys()].map(t=>i.getActiveUniform(a,t)).map(t=>t.name).reduce((t,e)=>{return t["[0]"===(s=e).substr(-3)?s.substr(0,s.length-3):s]=i.getUniformLocation(a,e),t;var s},{})},a}(),d=function(){let e,a,r,o,t={},l=0,h={},c={};return t.setupShader=t=>{e=u.createProgram(t,"attribute vec3 a_position;attribute vec2 a_texcoord;attribute vec3 a_normal;uniform mat4 u_projection;uniform mat4 u_facing_view;uniform float u_wave_strength;uniform float u_wave_period;uniform int u_model_type;uniform vec3 u_model_pos;uniform float u_model_scale;uniform mat4 u_model_rot;varying vec3 v_pos;varying vec2 v_texcoord;varying vec3 v_normal;varying float v_slope;float PI_2=2.0*3.141592653589;float fixed_portion=0.85;float param_portion=0.15;float strength=fixed_portion+((1.0-u_wave_strength)*param_portion);void main(){float x=a_position.x;float y=a_position.y;float x2=x-0.001;float y2;if(u_model_type==8){float amplitude=1.0-strength;float waveLen=2.0*strength;y+=((amplitude*((x+strength)/waveLen))*sin(PI_2*(x-u_wave_period)));y2=a_position.y+((amplitude*((x2+strength)/waveLen))*sin(PI_2*(x2-u_wave_period)));}else{y2=y;}vec4 position=vec4(a_position.x,y,a_position.z,1);mat4 model=mat4(u_model_scale);(model[3]).xyzw=vec4(u_model_pos,1.0);model=model*u_model_rot;mat4 matrix=(u_projection*u_facing_view)*model;gl_Position=matrix*position;v_pos=position.xyz;v_normal=mat3(matrix)*a_normal;v_texcoord=a_texcoord;v_slope=y-y2;}","precision mediump float;uniform sampler2D u_sampler;uniform int u_model_type_f;uniform float u_item_index;uniform float u_item_count;uniform vec4 u_foreground;uniform vec4 u_background;uniform vec3 u_light_direction;varying vec3 v_pos;varying vec2 v_texcoord;varying vec3 v_normal;varying float v_slope;float BLOCK_R=1.1;float FORT_O_R=1.35;float FORT_I_R=1.08;float BOMB_R1=1.0;float BOMB_R2=0.85;float BOMB_R3=0.85;vec2 ut1=vec2(-1.0,0.0);vec2 ut2=vec2(-0.1,1.0);vec2 ut3=vec2(-0.1,-1.0);vec2 lt1=vec2(1.0,0.0);vec2 lt2=vec2(0.1,1.0);vec2 lt3=vec2(0.1,-1.0);vec2 rtl=vec2(-0.1,-1.0);vec2 rbr=vec2(0.1,1.0);bool inTriangle(vec3 pt,vec2 t1,vec2 t2,vec2 t3){float A=(1.0/2.0)*((((-t2.y*t3.x)+(t1.y*(-t2.x+t3.x)))+(t1.x*(t2.y-t3.y)))+(t2.x*t3.y));float sign=A<0.0?-1.0:1.0;float s=((((t1.y*t3.x)-(t1.x*t3.y))+((t3.y-t1.y)*pt.x))+((t1.x-t3.x)*pt.y))*sign;float t=((((t1.x*t2.y)-(t1.y*t2.x))+((t1.y-t2.y)*pt.x))+((t2.x-t1.x)*pt.y))*sign;return ((s>0.0)&&(t>0.0))&&((s+t)<((2.0*A)*sign));}bool inRect(vec3 pt,vec2 rtl,vec2 rbr){return (((pt.x>=rtl.x)&&(pt.x<=rbr.x))&&(pt.y>=rtl.y))&&(pt.y<=rbr.y);}vec4 colorByShape(){vec4 color=u_background;float distance=sqrt(dot(v_pos,v_pos));if(u_model_type_f==0){if(!((inTriangle(v_pos,ut1,ut2,ut3)||inTriangle(v_pos,lt1,lt2,lt3))||inRect(v_pos,rtl,rbr)))color=vec4(0.0,0.0,0.0,0.0);}else if(u_model_type_f==1){if(distance>BLOCK_R)color=vec4(0.0,0.0,0.0,0.0);}else if(u_model_type_f==3){if((distance>BOMB_R1)||(distance<BOMB_R2))color=vec4(0.0,0.0,0.0,0.0);}else if((u_model_type_f==4)||(u_model_type_f==10)){if((distance>BOMB_R1)||(distance<BOMB_R3))color=vec4(0.0,0.0,0.0,0.0);}else if(u_model_type_f==5){if(distance>FORT_O_R)color=vec4(0.0,0.0,0.0,0.0);}else if((u_model_type_f==6)||(u_model_type_f==7)){if(distance>FORT_I_R)color=vec4(0.0,0.0,0.0,0.0);}return color;}void main(){float item_height=1.0/u_item_count;float item_y_offset=((u_item_count-u_item_index)-1.0)*item_height;float texcoord_y=item_y_offset+(v_texcoord.y*item_height);vec2 item_texcoord=vec2(v_texcoord.x,texcoord_y);vec4 tcolor=texture2D(u_sampler,item_texcoord);vec4 color;vec3 normal=normalize(v_normal);float light=dot(normal,u_light_direction);if(tcolor.a==0.0){color=colorByShape();}else{color=u_foreground;if(v_slope>0.0){color=mix(color,vec4(0.0,0.0,0.0,1.0),v_slope*300.0);}else if(v_slope<0.0){color=mix(color,vec4(1.0),abs(v_slope)*300.0);}}gl_FragColor=color;if(u_model_type_f==7){}else{gl_FragColor.rgb*=light;}}"),h=u.getAttrMap(t,e),c=u.getUniformMap(t,e)},t.useShader=t=>{t.useProgram(e)},t.setupModel=(t,e,s)=>{var[e,s,i]=function(e,s){var i=[],a=[],r=[],o=(s+s)/e,h=1/e,n=s;for(let t=0;t<=e;t++){var _=o*t-s,l=0+h*t;i.push(_,n,0,_,-n,0),a.push(l,1,l,0),r.push(0,0,-1,0,0,-1)}for(let t=e;0<=t;t--){var c=o*t-s,f=0+h*t;i.push(c,n,0,c,-n,0),a.push(f,1,f,0),r.push(0,0,1,0,0,1)}return[new Float32Array(i),new Float32Array(a),new Float32Array(r)]}(e,s);l=e.length/3,a=u.uploadToBuffer(t,e),r=u.uploadToBuffer(t,s),o=u.uploadToBuffer(t,i),u.assignBufferToAttr(t,a,h.a_position,3,t.FLOAT,!1,0,0),u.assignBufferToAttr(t,r,h.a_texcoord,2,t.FLOAT,!1,0,0),u.assignBufferToAttr(t,o,h.a_normal,3,t.FLOAT,!1,0,0)},t.setupUniforms=(t,e,s,i)=>{t.uniform1f(c.u_wave_strength,e),t.uniform3fv(c.u_light_direction,s),t.uniformMatrix4fv(c.u_projection,!1,i)},t.setupTexture=(t,e,s,i)=>{t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,1);var a=t.createTexture();t.activeTexture(e),t.bindTexture(t.TEXTURE_2D,a),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),e=t.RGBA,t.texImage2D(t.TEXTURE_2D,0,e,t.RGBA,t.UNSIGNED_BYTE,s),t.uniform1f(c.u_item_count,i)},t.draw=(t,e,s,i,a,r,o,h,n,_)=>{t.uniform1i(c.u_sampler,0),t.uniform1f(c.u_item_index,e),t.uniform1i(c.u_model_type,s),t.uniform1i(c.u_model_type_f,s),t.uniform3fv(c.u_model_pos,i),t.uniform1f(c.u_model_scale,a),t.uniformMatrix4fv(c.u_model_rot,!1,r),t.uniform4fv(c.u_foreground,o),t.uniform4fv(c.u_background,h),t.uniform1f(c.u_wave_period,_),t.uniformMatrix4fv(c.u_facing_view,!1,n),t.drawArrays(t.TRIANGLE_STRIP,0,l)},t}(),g=function(){const s={};let i;return s.setup=()=>{s.gl=i=document.getElementById("wgl").getContext("webgl"),d.setupShader(i),d.useShader(i),d.setupModel(i,p.lineWidth()/4,1),p.setup("tex"),f.chars.forEach((t,e)=>p.drawAt(t,e+1)),d.setupTexture(i,i.TEXTURE0,p.textureCanvas(),f.chars.length);var t=K.deg_to_rad(60),e=i.canvas.clientWidth/i.canvas.clientHeight,t=q.perspective_mat(t,e,1,20);d.setupUniforms(i,f.WAVE_STRENGTH,f.LIGHT_DIRECTION,t),e=[0,0,4],n.gen_rot_mats(),n.gen_facing_view_mats(e),n.gen_view_projection_mats(e,t)},s.cameraAngle=0,s.facingView=()=>n.facing_view(Math.floor(s.cameraAngle)),s.start=()=>{i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.enable(i.CULL_FACE),i.enable(i.DEPTH_TEST),i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA)},s.gl=i,s}(),t=function(){const i={};let e={},s={},a=t=>{if(e[t.keyCode])return s[t.keyCode]=performance.now(),_(t)},r=t=>(delete s[t.keyCode],_(t));i.startup=t=>{t.addEventListener("keydown",a,!1),t.addEventListener("keyup",r,!1)},i.shutdown=()=>{window.removeEventListener("keydown",a),window.removeEventListener("keyup",r)},i.isOn=t=>{var e=s[t];return e&&delete s[t],e};const t=[49,50,51,52,53,54],o=[85,73,79,74,75,76],h=[85,73,79,74,75,76],n=[t,o,h];function _(t){return t&&(t.stopPropagation&&t.stopPropagation(),null!=t.cancelBubble&&(t.cancelBubble=!0),t.preventDefault&&t.preventDefault(),t.returnValue=!1),!1}return i.K_SPACE=32,i.K_PAUSE=80,[].concat(t,o,h,[i.K_PAUSE,i.K_SPACE]).forEach(t=>e[t]=!0),i.digitHit=s=>{n.forEach(t=>{t.forEach((t,e)=>{i.isOn(t)&&s(e)})})},i}();class m{constructor(){this.nodes=[],this.alive=!0}addChild(t){return this.nodes.push(t),t}onUpdate(e,s,t){0<this.nodes.length&&(this.nodes.forEach(t=>t.onUpdate(e,s,this)),this.nodes.reduce((t,e)=>t||!e.alive,!1))&&(this.nodes=this.nodes.filter(t=>t.alive))}onDraw(){0<this.nodes.length&&this.nodes.forEach(t=>t.onDraw())}}class b extends m{constructor(){super(),this.frameId=null,this.prevTime=0}start(){t.startup(window),this.prevTime=performance.now(),this._animate(this.prevTime)}stop(){t.shutdown(window),this.frameId&&cancelAnimationFrame(this.frameId),this.frameId=null}get running(){return null!=this.frameId}_animate(t){this.frameId=requestAnimationFrame(t=>this._animate(t));var e=t-this.prevTime;this.prevTime=t,0<e&&(this.onUpdate(t,e,null),this.onDraw())}onUpdate(t,e,s){super.onUpdate(t,e,s)}onDraw(){super.onDraw()}}let v=class{constructor(t,e,s,i){this._start=0,this._time=0,this._rangeMS=t,this._isDone=!0,this._ctx=e,this._onStart=s,this._onStep=i}start(t,e){this._start=this._time=t||performance.now(),this._rangeMS=e||this._rangeMS,this._isDone=!1,this._onStart&&this._onStart(this._ctx,this)}step(t){return this.done||(this._time=t,this._onStep&&this._onStep(this._ctx,this)),this.done}doneNow(){this._isDone=!0}get done(){return 1<=this.pos}get pos(){return this._elapse/this._rangeMS}get rpos(){return(this._rangeMS-this._elapse)/this._rangeMS}get _elapse(){return this._isDone?this._rangeMS:Math.min(this._time-this._start,this._rangeMS)}get ctx(){return this._ctx}},E=class{constructor(t){this._timelines=t||[],this._stage=0}add(t){return this._timelines.push(t),this}start(t){this._stage=0,this.timeline.start(t)}step(t){return this.done||this.timeline.step(t)&&(this._stage++,this.done||this.timeline.start(t)),this.done}stageDoneNow(){this.done||this.timeline.doneNow()}doneNow(){this._timelines.forEach(t=>t.doneNow())}get timeline(){return this._timelines[this._stage]}get ctx(){return this.timeline.ctx}get pos(){return this.timeline.pos}get rpos(){return this.timeline.rpos}get stage(){return this._stage}get done(){return this._stage>=this._timelines.length}},T=t=>t*t,A=t=>t*(2-t),S=function(){const t={S_INIT_WAIT:0,S_LEVEL_WAIT:1,S_PLAYING:2,S_PAUSED:3,S_WON_PENDING:4,S_WON:5,S_WON_WAIT:6,S_LOST:7,S_LOST_WAIT:8};return t.gstate=t.S_INIT_WAIT,t.level=1,t.nextLevel=1,t.hitGoal=0,t.hitCount=0,t.speed=-.01,t.inSeq=0,t.inSeqCh=0,t.inSeqProbability=.2,t.scoreDisplay=0,t.score=0,t.calcSpeed=()=>{t.speed=-(.01+Math.log(t.level)/200)},t.calcGoal=()=>{t.hitGoal=Math.floor(Math.min(60+10*Math.log(t.level),99))},t}(),O=[0,0,0];class y{constructor(t,e){this.type=t,this.pos=e,this.offset=[0,0,0],this.ch=f.F_BLANK,this.scale=f.SCALE,this.xrot=0,this.yrot=0,this.rotMatrix=null,this.velocity=[0,0,0],this.force=[0,0,0],this.xrotSpeed=0,this.wavePeriod=50*Math.random(),this.rflag=null,this.fuseTarget=null,this.toPowerType=0,this.elevated=!1,this.bg=f.makeBg(this.type),this.fg=f.makeFg(this.type),this.timeline=new v(500),this.animateDir=1,this.fstate=1}clone(){var t=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return t.pos=[...this.pos],t.offset=[...this.offset],t.velocity=[...this.velocity],t.force=[...this.force],t.bg=[...this.bg],t.fg=[...this.fg],t.timeline=new v(500),t}setNext(t){this.rflag=t}isActive(){return 1==this.fstate}isHit(){return 4==this.fstate}isBombed(){return 7==this.fstate}isDead(){return 8==this.fstate}isInLine(){return 1==this.fstate||4==this.fstate||6==this.fstate||7==this.fstate}toHit(){this.timeline.start(performance.now(),250),this.xrotSpeed=8,this.fstate=4}toFlying(){this.timeline.start(performance.now(),700),this.velocity[1]=.05,this.velocity[2]=-.05,this.xrotSpeed=24,this.fstate=5}toFlyingRnd(){return this.timeline.start(performance.now(),1e3),this.velocity[0]=c(-50,50)/100*.2,this.velocity[1]=c(-50,50)/100*.2,this.velocity[2]=c(-50,50)/100*.2,this.xrotSpeed=c(0,6),this.scale=f.SCALE/2,this.bg[0]=c(0,255)/255,this.bg[1]=c(0,255)/255,this.bg[2]=c(0,255)/255,this.ch=f.F_BLANK,this.fstate=5,this}toBombed(){this.timeline.start(performance.now(),300),this.fstate=7}toFuse(t,e,s,i){this.timeline.start(performance.now(),200),this.fuseTarget=t,this.toPowerType=e,null!=s&&(this.ch=s),this.elevated=i,this.fstate=6}toDead(){this.fstate=8,S.score++}morphBomb(t){this.fstate=1,this.type=t,this.ch>f.digit0Limit&&(this.ch=c(0,f.digitLimit)),this.offset[0]=0,this.offset[1]=this.elevated?.1:0,this.offset[2]=0,this.bg=f.makeBg(this.type),this.fg=f.makeFg(this.type)}match(t){return this.isActive()&&(this.ch==t||this.type==f.T_WILDCARD)}onUpdate(t,e,s){switch(this.type){case f.T_BOMB3:break;case f.T_BOMB4:case f.T_404:this.bg[0]=(Math.cos(t/100)+1)/2,this.bg[1]=(Math.sin(t/100)+1)/2,this.bg[2]=(Math.sin(t/100)+1)/2}switch(this.fstate){case 1:case 2:this._updatePhysics(e);break;case 3:break;case 4:this.timeline.step(t)?this.toFlying():this.xrotSpeed=8+Math.floor(6*T(this.timeline.pos)),this._updatePhysics(e);break;case 5:this.timeline.step(t)?this.toDead():(this.scale-=(i=this.timeline.pos)*i*i*.015,this._updatePhysics(e));break;case 6:if(this.timeline.step(t)){if(!(0<this.toPowerType)){this.toDead();break}this.morphBomb(this.toPowerType)}else a.setTo(this.offset,this.fuseTarget.pos),a.subFrom(this.offset,this.pos),a.scaleTo(this.offset,this.timeline.pos);this._updatePhysics(e);break;case 7:this.timeline.step(t)?this.toDead():this._updatePhysics(e)}var i}onDraw(){var t;this.isDead()||this.isBombed()||(t=this.rotMatrix||n.xrot(this.xrot),a.setTo(O,this.pos),a.addTo(O,this.offset),d.draw(g.gl,this.ch,this.type,O,this.scale,t,this.fg,this.bg,g.facingView(),this.wavePeriod))}_updatePhysics(t){this._adjustToNeighbors(),a.addTo(this.pos,this.velocity),a.addTo(this.velocity,this.force),this.wavePeriod+=.001*t,this.xrot+=this.xrotSpeed}_adjustToNeighbors(){var t;this.isInLine()&&(this.rflag?(t=this.rflag.pos[0]-this.pos[0])<f.SPACE_BETWEEN-.01?(this.velocity[0]=S.speed,this.pos[0]=this.rflag.pos[0]-f.SPACE_BETWEEN+.01):t>f.SPACE_BETWEEN+.01?this.velocity[0]=.1:this.velocity[0]=S.speed:this.velocity[0]=S.speed)}}let I,L,C,w=(t,e,s,i)=>((t=new y(t,e)).fstate=2,t.scale=s,t.rotMatrix=i,t.ch=f.F_BLANK,t),B=(t,e,s,i,a)=>((a=new y(a?f.T_WCHAR:f.T_CHAR,e)).ch=f.charIndex[t],a.fstate=2,a.scale=s,a.rotMatrix=i,a);I=(t=1,e=.05,s=220,i=0,a=0,r=.1,o=0,h=1,n=0,_=0,l=0,c=0,f=0,p=0,u=0,d=0,g=0,m=1,v=0,E=0)=>{let T,A,S=2*Math.PI,O=n*=500*S/C**2,y=(0<u?1:-1)*S/4,I=s*=(1+2*e*Math.random()-e)*S/C,w=[],B=0,F=0,x=0,P=1,b=0,R=0,M=0;for(_*=500*S/C**3,u*=S/C,l*=S/C,c*=C,f=C*f|0,A=(i=99+C*i)+(v*=C)+(a*=C)+(r*=C)+(g*=C)|0;x<A;w[x++]=M)++R%(100*d|0)||(M=o?1<o?2<o?3<o?Math.sin((B%S)**3):Math.max(Math.min(Math.tan(B),1),-1):1-(2*B/S%2+2)%2:1-4*Math.abs(Math.round(B/S)-B/S):Math.sin(B),M=(f?1-E+E*Math.sin(2*Math.PI*x/f):1)*(0<M?1:-1)*Math.abs(M)**h*t*.3*(x<i?x/i:x<i+v?1-(x-i)/v*(1-m):x<i+v+a?m:x<A-g?(A-x-g)/r*m:0),M=g?M/2+(g>x?0:(x<A-g?1:(A-x)/g)*w[x-g|0]/2):M),T=(s+=n+=_)*Math.sin(F*u-y),B+=T-T*p*(1-1e9*(Math.sin(x)+1)%2),F+=T-T*p*(1-1e9*(Math.sin(x)**2+1)%2),P&&++P>c&&(s+=l,I+=l,P=0),!f||++b%f||(s=I,n=O,P=P||1);return(t=L.createBuffer(1,A,C)).getChannelData(0).set(w),(s=L.createBufferSource()).buffer=t,s.connect(L.destination),s.start(),s},L=new(window.AudioContext||webkitAudioContext),C=44100;var F=I;let R=()=>F(1,.05,13,.1,.22,.62,1,.47,.5,0,24,0,.02,0,0,.1,.11,.62,.04,0),M=()=>F(1,.05,245,.24,.22,.71,0,1.31,0,0,-29,.03,.03,0,0,0,0,.66,.09,0),N=()=>F(1,.05,727,.28,.12,.61,1,.57,-3.6,-4.8,-291,.07,.13,0,0,0,.17,.97,.05,0),x=()=>F(1,.05,501,0,.01,1.91,4,2.41,.1,.8,0,0,0,.6,0,.4,0,.77,.09,0),P=()=>F(1,.05,418,0,.02,.2,4,1.15,-8.5,0,0,0,0,.7,0,.1,0,1,0,0);class k extends m{constructor(){super(),this.flags=[],this.activeFlags=[],this.matchedFlg=[],this.matchedSeq=[],this.matchedBomb=[],this.matchedB4=[],this.fortO=[],this.fortI=[],this.cash=[],this.score=[],this.goal=[],this.label=[],this.level=[],this.popup=[],this.fortIX=0,this.scoreDelay=new v(200),this.wonStages=this._setupWonStages(),this.lostStages=this._setupLostStages(),this.fortAttackStages=[this._setupFortAttackStages(300,800,1700,!0),this._setupFortAttackStages(500,400,1700,!0)],this.fortAttackType=0,this.fortAttacking=!1,this.popupLen=0,this.lastHitType=0,this._initScore(),this._initPopup(),this._makeFortItems(),this._makeCash(),this._startGame()}onUpdate(t,e,s){this._handleInput(),S.gstate!=S.S_PAUSED&&((this._checkHitFlags()||this._checkBombedFlags())&&this._pullback(),this._checkDeadFlags(),this._fixNextPtr(),this._updateByGameState(t,e),super.onUpdate(t,e,s))}onDraw(){super.onDraw(),this.flags.forEach(t=>t.onDraw()),this.fortO.forEach(t=>t.onDraw()),this.fortI.forEach(t=>t.onDraw()),this.cash.forEach(t=>t.onDraw());var t=g.cameraAngle;g.cameraAngle=0,this.popup.forEach(t=>t.onDraw()),this.score.forEach(t=>t.onDraw()),this.goal.forEach(t=>t.onDraw()),this.level.forEach(t=>t.onDraw()),this.label.forEach(t=>t.onDraw()),g.cameraAngle=t}_startGame(){S.gstate=S.S_INIT_WAIT,S.level=1,this._setPopup("SPACE TO START",-.2,0,-.5)}_startLevel(){S.gstate!=S.S_PLAYING&&(S.gstate=S.S_PLAYING,this._showPopup(!1),this._showItems(this.cash,!0),this._showItems(this.fortO,!0),this._showItems(this.fortI,!0),this._resetOffset(this.cash),this._resetOffset(this.fortO),this._resetOffset(this.fortI),this.fortAttacking=!1,this.fortAttackStages.forEach(t=>t.doneNow()),this.scoreDelay.doneNow(),this.wonStages.doneNow(),this.lostStages.doneNow(),this.scoreDelay.start(),S.calcSpeed(),S.calcGoal(),S.hitCount=0,g.cameraAngle=f.PLAYING_ANGLE,this._spawnFlag())}_handleInput(){if(t.isOn(t.K_SPACE))switch(S.gstate){case S.S_LOST_WAIT:S.nextLevel=1,S.score=0,S.scoreDisplay=0,this._showItems(this.cash,!0),this._showItems(this.fortO,!0),this._showItems(this.fortI,!0),this._resetOffset(this.cash),this._resetOffset(this.fortO),this._resetOffset(this.fortI);case S.S_INIT_WAIT:case S.S_WON_WAIT:S.level=S.nextLevel,this._setPopup("LEVEL "+S.level,-.2,0,0),S.gstate=S.S_LEVEL_WAIT;break;case S.S_LEVEL_WAIT:this._startLevel()}t.isOn(t.K_PAUSE)&&(S.gstate==S.S_PLAYING?S.gstate=S.S_PAUSED:S.gstate==S.S_PAUSED&&(S.gstate=S.S_PLAYING)),S.gstate==S.S_PLAYING&&t.digitHit(t=>this._processMatching(t))}_firstFlag(){for(let t=0;t<this.flags.length;t++)if(this.flags[t].isInLine())return this.flags[t];return null}_lastFlag(){for(let t=this.flags.length-1;0<=t;t--)if(this.flags[t].isInLine())return this.flags[t];return null}_filterActive(){return this.activeFlags.length=0,this.flags.forEach(t=>{t.isActive()&&this.activeFlags.push(t)}),this.activeFlags}_matchFlags(s,i){let a=0;this.matchedFlg.length=0,this.matchedSeq.length=0,this.matchedBomb.length=0,s.forEach((t,e)=>{t.match(i)?(this.lastHitType=t.type,t.type==f.T_BOMB3?(this.matchedBomb.push(s.slice(Math.max(0,e-f.BOMB3_RANGE),Math.min(s.length,e+f.BOMB3_RANGE+1))),P()):t.type==f.T_BOMB4?(this.matchedBomb.push(s.slice(Math.max(0,e-f.BOMB4_RANGE),Math.min(s.length,e+f.BOMB4_RANGE+1))),F(1,.05,333,.01,0,.9,4,1.9,0,0,0,0,0,.5,0,.6,0,1,0,0)):t.type==f.T_404?(F(1,.05,941,.8,0,.8,4,.74,-222,0,0,0,0,.8,0,1,0,1,0,0),this._startFortAttack(0)):(a++,this.matchedFlg.push(t),this.matchedSeq.push(a))):a=0})}_determinePowerType(t,e){return 3==t?f.T_BOMB3:4==t?f.T_BOMB4:5<=t?f.T_404:0}_processMatching(t){this._matchFlags(this._filterActive(),t);for(let t=0;t<this.matchedBomb.length;t++)this.matchedBomb[t].forEach(t=>this._startBombed(t));for(let i=this.matchedSeq.length-1;0<=i;i--){var a=this.matchedSeq[i],r=this._determinePowerType(a,t);if(r){let t=i-a+1,e=this.matchedFlg[t],s=t;for(r==f.T_404?(this.matchedFlg[s++].toFuse(e,r,3,!0),this.matchedFlg[s++].toFuse(e,r,f.F_ZERO,!0),this.matchedFlg[s++].toFuse(e,r,3,!0),N()):r==f.T_BOMB4?(this.matchedFlg[s++].toFuse(e,r),M()):r==f.T_BOMB3&&(this.matchedFlg[s++].toFuse(e,r),R());s<=i;s++)this.matchedFlg[s].toFuse(e,0);S.hitCount+=s-t,i=t}}1<this.matchedFlg.reduce((t,e)=>e.isActive()?t+1:t,0)&&(this.matchedFlg.forEach(t=>{t.isActive()&&(t.toHit(),S.hitCount++)}),F(1,.05,539,0,.04,.29,1,1.92,0,0,567,.02,.02,0,0,0,.04,1,0,0))}_updateByGameState(e,s){switch(S.gstate){case S.S_INIT_WAIT:case S.S_LEVEL_WAIT:this._updateScore(e),this._rotateFortO(e),this.cash.forEach(t=>t.onUpdate(e,s,this)),this.popup.forEach(t=>t.onUpdate(e,s,this));break;case S.S_PLAYING:this._checkSpawn(),this._rotateFortO(e),this._pulseFortI(e),this._checkFortAttack(e),this._updateScore(e),this.flags.forEach(t=>t.onUpdate(e,s,this)),this.fortO.forEach(t=>t.onUpdate(e,s,this)),this.fortI.forEach(t=>t.onUpdate(e,s,this)),this.cash.forEach(t=>t.onUpdate(e,s,this)),this.popup.forEach(t=>t.onUpdate(e,s,this)),this._checkWinning(),this._checkLosing();break;case S.S_PAUSED:this.popup.forEach(t=>t.onUpdate(e,s,this));break;case S.S_WON_PENDING:this._hasPendingAnimation()||(S.gstate=S.S_WON,this.wonStages.start()),this._rotateFortO(e),this._checkFortAttack(e),this.flags.forEach(t=>t.onUpdate(e,s,this)),this.fortO.forEach(t=>t.onUpdate(e,s,this)),this.fortI.forEach(t=>t.onUpdate(e,s,this)),this.cash.forEach(t=>t.onUpdate(e,s,this)),this.popup.forEach(t=>t.onUpdate(e,s,this));break;case S.S_WON:this.wonStages.step(e)&&(S.gstate=S.S_WON_WAIT,g.cameraAngle=0,this.flags.length=0,this._setPopup("YOU WON!",-.2,0,0),S.nextLevel=S.level+1),this._rotateFortO(e),this._checkFortAttack(e),this.flags.forEach(t=>t.onUpdate(e,s,this)),this.fortO.forEach(t=>t.onUpdate(e,s,this)),this.fortI.forEach(t=>t.onUpdate(e,s,this)),this.cash.forEach(t=>t.onUpdate(e,s,this)),this.popup.forEach(t=>t.onUpdate(e,s,this));break;case S.S_WON_WAIT:this._rotateFortO(e),this._pulseFortI(e),this._updateScore(e),this.fortO.forEach(t=>t.onUpdate(e,s,this)),this.fortI.forEach(t=>t.onUpdate(e,s,this)),this.cash.forEach(t=>t.onUpdate(e,s,this)),this.popup.forEach(t=>t.onUpdate(e,s,this));break;case S.S_LOST:this.lostStages.step(e)&&(S.gstate=S.S_LOST_WAIT,g.cameraAngle=0,this._setPopup("GAME OVER",-.5,0,0),this._showItems(this.cash,!1),this._showItems(this.fortO,!1),this._showItems(this.fortI,!1),this.flags.length=0),this._rotateFortO(e);break;case S.S_LOST_WAIT:this.popup.forEach(t=>t.onUpdate(e,s,this))}}_setupWonStages(){var t=new v(500,this,null,(t,e)=>{g.cameraAngle-=1.5}),e=new v(3e3,this,(t,e)=>{this.lastHitType!=f.T_404?t._startFortAttack(1):e.doneNow()},(t,e)=>{});return new E([t,e])}_checkWinning(){S.gstate==S.S_PLAYING&&S.hitCount>=S.hitGoal&&(S.gstate=S.S_WON_PENDING)}_hasPendingAnimation(){return!1|this.fortAttacking}_setupLostStages(){var t=new v(1500,this,()=>{F(1,.05,925,.04,.3,.6,1,.3,0,6.27,-184,.09,.17,0,0,0,0,1,0,0)},(t,e)=>{g.cameraAngle-=3}),e=new v(400,this,()=>{},(t,e)=>{--g.cameraAngle,t._collapseFort(e.pos)}),s=new v(2e3,this,()=>{x()},(t,e)=>{t._blowupFort(e.pos)});return new E([t,e,s])}_checkLosing(){var t=this._firstFlag();t&&t.pos[0]<f.LOSING_X&&(S.gstate=S.S_LOST,this.lostStages.start())}_checkSpawn(){var t=this._lastFlag();(!t||t.pos[0]<f.BEGIN_X)&&this._spawnFlag()}_spawnFlag(){this.flags.push((t=>{let e,s=[f.BEGIN_X,0,0];if(t&&s[0]-t.pos[0]<f.SPACE_BETWEEN&&(s[0]=t.pos[0]+f.SPACE_BETWEEN),0<S.inSeq)return(t=new y(f.T_FLAG,s)).ch=S.inSeqCh,S.inSeq--,t;if(Math.random()<S.inSeqProbability){const t=c(1,100),e=5-Math.floor(Math.log(t));S.inSeq=Math.min(2,e),S.inSeqCh=c(0,f.digitLimit)}return(t=Math.random())<.8?(e=new y(f.T_FLAG,s)).ch=c(0,f.digitLimit):.8<=t&&t<.9?(e=new y(f.T_ROCK,s)).ch=f.F_ROCK:.9<=t&&t<.96?((e=new y(f.T_BOMB3,s)).ch=c(0,f.digitLimit),e.morphBomb(f.T_BOMB3)):.96<=t&&t<.99?((e=new y(f.T_BOMB4,s)).ch=c(0,f.digitLimit),e.morphBomb(f.T_BOMB3)):((e=new y(f.T_404,s)).ch=c(0,f.digitLimit),e.morphBomb(f.T_BOMB4)),e})(this._lastFlag()))}_checkHitFlags(){var t=this.flags.reduce((t,e)=>t||e.isHit(),!1),e=this.hadHit&&!t;return this.hadHit=t,e}_checkBombedFlags(){var t=this.flags.reduce((t,e)=>t||e.isBombed(),!1),e=this.hadBombed&&!t;return this.hadBombed=t,e}_checkDeadFlags(){var t=this.flags.reduce((t,e)=>t||e.isDead(),!1);return t&&(this.flags=this.flags.filter(t=>!t.isDead())),t}_pullback(){var t=this._lastFlag();t&&(t.pos[0]+=f.SPACE_BETWEEN)}_fixNextPtr(){for(let t=0;t<this.flags.length;t++){var e=this.flags[t];if(e.setNext(null),e.isInLine())for(t+=1;t<this.flags.length;t++)if(this.flags[t].isInLine()){e.setNext(this.flags[t]),t--;break}}}_makeFortItems(){let e=n.yrot(90),s=16,i=2;for(let t=0;t<s;t++){var a=2*Math.PI*t/s,r=i*Math.cos(a),a=i*Math.sin(a);this.fortO.push(w(f.T_FORT_O,[f.FORT_O_X,r,a],f.FORT_O_SCALE,e))}s=8,i=1.1;for(let t=0;t<s;t++){var o=2*Math.PI*t/s,h=i*Math.cos(o),o=i*Math.sin(o);this.fortI.push(w(f.T_FORT_I,[f.FORT_I_X,h,o],f.FORT_I_SCALE,e))}}_rotateFortO(t){var e=t/3e5;for(let t=0;t<16;t++){var s=2*Math.PI*(t/16-e),i=2*Math.cos(s),s=2*Math.sin(s);this.fortO[t].pos[1]=i,this.fortO[t].pos[2]=s}}_pulseFortI(t){let e=t/3600;this.fortI.forEach(t=>t.offset[0]=Math.sin(2*Math.PI*e)/16)}_expandFort(t,i,a,r){let o=t.length;t.forEach((t,e)=>{e=2*Math.PI*e/o;var s=i*Math.cos(e);e=i*Math.sin(e),t.offset[1]=a*s,t.offset[2]=a*e,t.scale=r})}_collapseFort(t){this._expandFort(this.fortO,2*T(t),-1,f.FORT_O_SCALE*(1-t)),this._expandFort(this.fortI,1.1*T(t),-1,f.FORT_I_SCALE*(1-t))}_blowupFort(t){this._expandFort(this.fortO,7*A(t),1,f.FORT_O_SCALE*(.25+t)),this._expandFort(this.fortI,4.5*A(t),1,f.FORT_I_SCALE*(.25+t))}_setupFortAttackStages(t,e,s,i){const a=f.BEGIN_X-f.FORT_I_X;return t=new v(t,this,(t,e)=>{t.fortI.forEach(t=>t.offset[0]=.2),t.fortI.forEach(t=>t.type=f.T_FORT_I2),t.fortI.forEach(t=>t.bg=f.makeBg(t.type))}),e=new v(e,this,null,(e,t)=>{let s=t.pos*a;e.fortI.forEach(t=>t.offset[0]=s);for(let t=0;t<e.flags.length;t++){var i=e.flags[t];if(i.isActive()){if(i.pos[0]+1.5>s)break;e._startBombed(i),P()}}}),s=new v(s,this,(t,e)=>{i&&x()},(t,e)=>{let s=e.rpos*a;t.fortI.forEach(t=>t.offset[0]=s)}),new E([t,e,s])}_startFortAttack(t){this.fortAttacking||(this.fortAttacking=!0,this.fortAttackType=t,this.fortAttackStages[this.fortAttackType].start(),this.lastHitType=f.T_404)}_checkFortAttack(t){this.fortAttacking&&this.fortAttackStages[this.fortAttackType].step(t)&&(this.fortAttacking=!1,this.flags.forEach(t=>{t.isActive()&&this._startBombed(t)}),this._resetOffset(this.fortI),this.fortI.forEach(t=>t.type=f.T_FORT_I),this.fortI.forEach(t=>t.bg=f.makeBg(t.type)))}_startBombed(t){t.toBombed(),S.hitCount++;let e=c(3,5);for(;0<e--;)this.flags.push(t.clone().toFlyingRnd())}_makeCash(){var t=n.yrot(90);this.cash.push(B("$",[f.CASH_X,0,0],f.CASH_SCALE,t,!0))}_initScore(){this.score=[...Array(7).keys()].map((t,e)=>B("0",[f.SCORE_X+e*(1.4*f.SCORE_W),f.SCORE_Y,f.SCORE_Z],f.SCORE_W)),this.score.forEach(t=>t.bg=[0,0,0,0]),this.score.forEach(t=>t.fg=[.25,1,.25,1]),this.goal=[...Array(2).keys()].map((t,e)=>B("0",[f.GOAL_X+e*(1.4*f.SCORE_W),f.SCORE_Y,f.SCORE_Z],f.SCORE_W)),this.goal.forEach(t=>t.bg=[0,0,0,0]),this.goal.forEach(t=>t.fg=[.25,1,.25,1]),this.level=[...Array(2).keys()].map((t,e)=>B("0",[f.LEVEL_X+e*(1.4*f.SCORE_W),f.SCORE_Y,f.SCORE_Z],f.SCORE_W)),this.level.forEach(t=>t.bg=[0,0,0,0]),this.level.forEach(t=>t.fg=[.25,1,.25,1]),this.label=[...Array(1).keys()].map((t,e)=>B("L",[f.LABEL_X+e*(1.4*f.SCORE_W),f.SCORE_Y,f.SCORE_Z],f.SCORE_W)),this.label.forEach(t=>t.bg=[0,0,0,0]),this.label.forEach(t=>t.fg=[.25,1,.25,1])}_updateScore(t){this.scoreDelay.step(t)?this.scoreDelay.start(t):(S.scoreDisplay<S.score&&(S.scoreDisplay+=1),this._updateNumber(this.score,S.scoreDisplay)),this._updateNumber(this.goal,Math.max(S.hitGoal-S.hitCount,0)),this._updateNumber(this.level,S.level)}_updateNumber(t,e){t.forEach(t=>t.ch=f.numIndex(0));let s=t.length-1;for(;0<e;){var i=e%10;t[s].ch=f.numIndex(i),e=Math.floor(e/10),0<s&&s--}}_initPopup(){this.popup=[...Array(f.POPUP_N).keys()].map((t,e)=>B(" ",[f.POPUP_X+e*(2.2*f.POPUP_W),f.POPUP_Y,f.POPUP_Z],f.POPUP_W,null,!0))}_setPopup(t,e,s,i){t=t.substring(0,this.popup.length),this.popupLen=t.length,t.split("").map((t,e)=>this.popup[e].ch=f.charIndex[t]),this._setOffset(this.popup,e,s,i),this._showPopup(!0)}_showPopup(t){const s=t?this.popupLen:0;this.popup.forEach((t,e)=>{e<s?(t.bg=[1,1,1,1],t.fg=[.5,0,0,1]):(t.bg=[0,0,0,0],t.fg=[0,0,0,0])})}_showItems(t,e){t.forEach(t=>{e?(t.bg=f.makeBg(t.type),t.fg=f.makeFg(t.type)):t.bg=t.fg=[0,0,0,0]})}_setOffset(t,e,s,i){t.forEach(t=>(t.offset[0]=e,t.offset[1]=s,t.offset[2]=i))}_resetOffset(t){this._setOffset(t,0,0,0)}}window.addEventListener("load",function(t){g.setup();var e=new b,s=new k;e.addChild(s),e.start(),g.start()})</script>